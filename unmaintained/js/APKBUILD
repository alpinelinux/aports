# Contributor: Natanael Copa <ncopa@alpinelinux.org>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=js
pkgver=1.8.5
_ver=${pkgver//./}-1.0.0
pkgrel=0
pkgdesc="JavaScript interpreter and libraries"
url="http://www.mozilla.org/js/"
arch="all"
license="GPLv2+ or LGPLv2+ or MPLv1.1"
depends="nspr libstdc++"
depends_dev="nspr-dev"
makedepends="$depends_dev libedit-dev zip ncurses-dev python perl autoconf2.13"
install=""
subpackages="$pkgname-dev"
source="http://archive.mozilla.org/pub/js/js$_ver.tar.gz
	js185-destdir.patch
	isfinite.patch
	js-1.8.5-64bit-big-endian.patch
	js-1.8.5-secondary-jit.patch
	js-1.8.5-537701.patch
	js185-arm-nosoftfp.patch
	js185-libedit.patch
	0001-Make-js-config.h-multiarch-compatible.patch
	aarch64.patch
	ppc64le.patch
	js-1.8.5-array-recursion.patch
	js-1.8.5-c++11.patch"

_builddir="$srcdir"/js-1.8.5/js/src
options="!check"

build() {                                                                   
#Optimisation disabled to resolve compilation error related to "#pragma GCC"
        cd "$_builddir"

	# create pkg-config file
	cat > libjs.pc << EOF
prefix=/usr
exec_prefix=/usr
libdir=/usr/lib
includedir=/usr/include

Name: libjs
Description: JS library
Requires: nspr >= 4.7
Version: $pkgver
Libs: -L\${libdir} -ljs
Cflags: -DXP_UNIX=1 -DJS_THREADSAFE=1 -I\${includedir}/js
EOF

	autoconf-2.13
	CXXFLAGS=$(echo $CXXFLAGS | sed -e 's/-Os //')
	CPPFLAGS=$(echo $CPPFLAGS | sed -e 's/-Os //')
	CPPFLAGS="$CPPFLAGS $(pkg-config --cflags libedit)" \
	./configure \
		--build=$CBUILD \
		--prefix=/usr \
		--with-system-nspr \
		--enable-threadsafe \
		--enable-readline \
		--disable-optimize \
		|| return 1
	make
}

package() {
	cd "$_builddir"
	mkdir -p "$pkgdir"/usr/lib/pkgconfig/
	make install DESTDIR="$pkgdir" || return 1
	install -Dm 0644 libjs.pc "$pkgdir"/usr/lib/pkgconfig/
	# compat symlinks
	ln -s libmozjs185.so.1.0 "$pkgdir"/usr/lib/libmozjs.so.1
	ln -s libmozjs185.so.1.0 "$pkgdir"/usr/lib/libjs.so.1
	ln -s libmozjs185.so "$pkgdir"/usr/lib/libmozjs.so
	ln -s libmozjs185.so "$pkgdir"/usr/lib/libjs.so

}
sha512sums="2af7122a7c7007fd7b6668776fe1222515a810b3e43bbf0f76b8f94e1ef406ffd3fb5ccec393021b00274c05b38a77235bc8d6886994c56762fcaf0aa7cf6718  js185-1.0.0.tar.gz
1c096bce6049d43f8726746bedf8c54cb15b00ceeb43d48f1bbfddad66711b97dbdb3100799875815e9efbf83850b4809b50cd9446774a800f68f50ab5a095e2  0001-Make-js-config.h-multiarch-compatible.patch
8e2e3e799f9d9c6330c28cff1b8eae686b154f91a990cf86deebccecfef6e642374076d88fa68977fd3e1d25c48c2d51aa8dd2239073191b62e89ebe694c9902  aarch64.patch
29a79d9b007fc46b0415f73d9723d8dd4115647e67ca65ceb6b8767a17c644161b5439e4e559fe3e26da377f06f0761a5873fa700901cb1c94b3d3e04f62acdd  isfinite.patch
70b14380bde85577185a3616126a11d62307366399ec78958ceffdc5e2fadb9836db5199ebbe9b756599bb243eea7fdffb4695a6ebaa1c3d49a07b5b14135578  js-1.8.5-537701.patch
4efeb0486b36de03787c941c84f31e6a89f9a65dc25cbe044ed1b5b733e0b2bee84da8019b4672c84826424d544c64d57caad0e2fd220e9078f52727d6e9b4f2  js-1.8.5-64bit-big-endian.patch
b919903ab33e8320a0c6b88a232f98eaac5c8c297c8c3c102c25b5e903d798391b6f2da0d1faa520f1d785933c3d4d8ebed32fda15545dd90e2cc110cde84d0f  js-1.8.5-array-recursion.patch
898c305ab9d1140be0710553badb6bb1037217e849711d0e593fc585ff2c1197a31881da4ccd3d3c700a3338c163ac2a33ddb0453d6d99fdf1cb6d129793666a  js-1.8.5-c++11.patch
e5aebce551e82480204ff93cc506b4cc6bfeef6f34d2238c65b10a6d73a6a56e94d4ccd69a5e46a235a4ec5074252fd63c5d7b558eaad655c7e1582f25c5c8c9  js-1.8.5-secondary-jit.patch
38bc1d4402a7065ac0eceae41c019cd437412080b982f6c5629bc505c3720bd7a92e278217a8827006be65fc6c188ea9774cead6599d5ff53fc9425f9b648db9  js185-arm-nosoftfp.patch
7818436db07a71f15958c61b7aadfc41a5b41151cc00206f8ace63ae5aeefd52d63515a9f99a865383e11f3adc7e85dc94ba7736189afe2fb8f25fbfe3eb5dc5  js185-destdir.patch
907e6e80b956d7ac23037ad807d3661b5469622808dbc5d8fc53714dd71f9c9e152dfefdb927bc9aa56d0f12cbf3f9fd26edabedd6a4321cf13aae449ee4a032  js185-libedit.patch
bc9043e35a9f36aa15208aeddecc2bacba792d2c669935fda7b3ae14bb9aa408e8f51e37dfa4d481506c7bb692025f8be15b650ee751a38b9d09eb6116b92757  ppc64le.patch"