# Contributor: Markus M. May <triplem@javafreedom.org>
# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
_railsver=4.2
pkgname=redmine
pkgver=3.2.1
pkgrel=2
pkgdesc="Project management web application written in Ruby"
url="http://redmine.org"
arch="noarch"
license="GPL2"
# ruby-io-console is part of ruby std package but splitted
# seems bundler does not detect its missing
depends="ruby
	ruby-actionpack-action_caching${_railsver}
	ruby-actionpack-xml_parser${_railsver}
	ruby-bigdecimal
	ruby-coderay
	ruby-fastercsv
	ruby-i18n
	ruby-jquery-rails${_railsver}
	ruby-json
	ruby-mocha
	ruby-net-ldap
	ruby-openid<2.4
	ruby-rack
	ruby-rack-openid
	ruby-rails${_railsver}
	ruby-rbpdf
	ruby-rdoc
	ruby-redcarpet
	ruby-request_store
	ruby-rmagick
	ruby-protected_attributes${_railsver}
	ruby-roadie-rails

	ruby-io-console
	"
depends_dev=ruby-io-console
makedepends="$depends_dev"
install="$pkgname.pre-install $pkgname.post-install"
subpackages=""
pkgusers="$pkgname"
pkggroups="$pkgname www-data"
source="http://www.redmine.org/releases/redmine-$pkgver.tar.gz
	gemfile.patch
	database.yml.patch
	"
_webapps="usr/share/webapps"

_builddir="$srcdir"/redmine-$pkgver

prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
	# verify that all deps are installed
	if ! bundler check; then
		bundler list
		return 1
	fi
}

package() {
	cd "$_builddir"
	# create dirs
	mkdir -p "$pkgdir/$_webapps/$pkgname" "$pkgdir"/etc/redmine \
		|| return 1
	install -o redmine -g www-data -m775 -d \
		"$pkgdir"/var/lib/redmine "$pkgdir"/var/log/redmine \
		|| return 1

	# move config files
	for i in database.yml.example configuration.yml.example \
			additional_environment.rb.example routes.rb; do
		mv config/${i} "$pkgdir"/etc/redmine/${i%.example} || return 1
		ln -s /etc/redmine/${i%.example} config/${i%.example} \
			|| return 1
	done

	# writeable data dirs
	for i in db files tmp public/plugin_assets; do
		chown redmine:www-data $i || return 1
		chmod 775 $i || return 1
		mv $i "$pkgdir"/var/lib/redmine/ || return 1
		ln -s /var/lib/redmine/${i#*/} $i || return 1
	done
	chown redmine Gemfile.lock || return 1

	# the secret token is generated by post-install
	ln -s /var/lib/redmine/secret_token.rb config/initializers/

	# log dir
	rm -r log && ln -s /var/log/redmine log || return 1

	mv * "$pkgdir/$_webapps/$pkgname" || return 1
}

md5sums="425aa0c56b66bf48c878798a9f7c6546  redmine-3.2.1.tar.gz
a80146b41b912f248140e616154073f6  gemfile.patch
d834bef9b5f01484f1e0ee82676f4109  database.yml.patch"
sha256sums="5e69ad50eef27b581e58ea0d72f2dcb19f38db3626e3bd6ed27b74d5a4da5bd6  redmine-3.2.1.tar.gz
d9d94fcb696aed05b308114c0b053f878918e3d2dbd12e5ee0b46c041bd18bcd  gemfile.patch
28b1ec099ae87c43d00d7e997edabaece01d6fc2e67b46c50735e9a1bb72f130  database.yml.patch"
sha512sums="20bc63f82aa58a67c10733338e7aebae3348689531f1f0a6dbedb00301f128ef6a29bd6a33d3075b614e01b23f5311a9739b251fb911298e54d4df06df628bf3  redmine-3.2.1.tar.gz
9f3be9039f9c576b56d77e3e3f477fe16fdd5d0f8b8b1bb3722cad1aff669f2ee65c308d27ec8c25300b4a3991b65fcf9d4d127abd0542477f1dd8f5af82d7ee  gemfile.patch
1b5880979f050a71d726c844369cc5340a8d4aa0b59b2301e1d32dea28f70ca2a85e619c8b845c37de08772154eef13fa63716c1beaaa50d97b80fd65c297bf9  database.yml.patch"
