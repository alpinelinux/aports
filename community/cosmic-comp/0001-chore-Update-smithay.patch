From 945a4258d5d92eab6ed16a583168563c22e29aaa Mon Sep 17 00:00:00 2001
From: Clayton Craft <clayton@craftyguy.net>
Date: Thu, 19 Feb 2026 12:57:49 -0800
Subject: [PATCH] chore: Update smithay

Fixes #2081

This also reverts commit 0f7e53b, because the upstream commit (2e00119)
that introduced this thing was reverted
(https://github.com/Smithay/smithay/pull/1941).

There was also change in the cursor_capture_constraints signature in
smithay 7d992793f.
---
 Cargo.lock                                    | 16 +++++-----
 Cargo.toml                                    |  2 +-
 .../handlers/image_copy_capture/mod.rs        |  3 +-
 src/wayland/handlers/virtual_keyboard.rs      | 31 +------------------
 4 files changed, 12 insertions(+), 40 deletions(-)

diff --git a/Cargo.lock b/Cargo.lock
index 5aafabe1..b66103de 100644
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -1268,7 +1268,7 @@ dependencies = [
  "libc",
  "option-ext",
  "redox_users",
- "windows-sys 0.60.2",
+ "windows-sys 0.61.2",
 ]
 
 [[package]]
@@ -1578,7 +1578,7 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "39cab71617ae0d63f51a36d69f866391735b51691dbda63cf6f96d042b63efeb"
 dependencies = [
  "libc",
- "windows-sys 0.60.2",
+ "windows-sys 0.61.2",
 ]
 
 [[package]]
@@ -2875,7 +2875,7 @@ version = "1.4.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "d463f34ca3c400fde3a054da0e0b8c6ffa21e4590922f3e18281bb5eeef4cbdc"
 dependencies = [
- "windows-sys 0.60.2",
+ "windows-sys 0.61.2",
 ]
 
 [[package]]
@@ -3499,7 +3499,7 @@ version = "0.50.3"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "7957b9740744892f114936ab4a57b3f487491bbeafaf8083688b16841a4240e5"
 dependencies = [
- "windows-sys 0.60.2",
+ "windows-sys 0.61.2",
 ]
 
 [[package]]
@@ -4685,7 +4685,7 @@ dependencies = [
  "errno",
  "libc",
  "linux-raw-sys 0.11.0",
- "windows-sys 0.60.2",
+ "windows-sys 0.61.2",
 ]
 
 [[package]]
@@ -4992,7 +4992,7 @@ checksum = "67b1b7a3b5fe4f1376887184045fcf45c69e92af734b7aaddc05fb777b6fbd03"
 [[package]]
 name = "smithay"
 version = "0.7.0"
-source = "git+https://github.com/smithay/smithay.git?rev=3d3f9e3#3d3f9e359352d95cffd1e53287d57df427fcbd34"
+source = "git+https://github.com/smithay/smithay.git?rev=89e58f7#89e58f77983ea10ce2c7ad0f5bf07ac826beab67"
 dependencies = [
  "aliasable",
  "appendlist",
@@ -5332,7 +5332,7 @@ dependencies = [
  "getrandom 0.3.4",
  "once_cell",
  "rustix 1.1.2",
- "windows-sys 0.60.2",
+ "windows-sys 0.61.2",
 ]
 
 [[package]]
@@ -6353,7 +6353,7 @@ version = "0.1.11"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "c2a7b1c03c876122aa43f3020e6c3c3ee5c05081c9a00739faf7503aeba10d22"
 dependencies = [
- "windows-sys 0.60.2",
+ "windows-sys 0.61.2",
 ]
 
 [[package]]
diff --git a/Cargo.toml b/Cargo.toml
index 4218c560..39646934 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -148,4 +148,4 @@ cosmic-protocols = { git = "https://github.com/pop-os//cosmic-protocols", branch
 cosmic-client-toolkit = { git = "https://github.com/pop-os//cosmic-protocols", branch = "main" }
 
 [patch.crates-io]
-smithay = { git = "https://github.com/smithay/smithay.git", rev = "3d3f9e3" }
+smithay = { git = "https://github.com/smithay/smithay.git", rev = "89e58f7" }
diff --git a/src/wayland/handlers/image_copy_capture/mod.rs b/src/wayland/handlers/image_copy_capture/mod.rs
index a63365c2..2dc9d5ca 100644
--- a/src/wayland/handlers/image_copy_capture/mod.rs
+++ b/src/wayland/handlers/image_copy_capture/mod.rs
@@ -15,7 +15,7 @@ use smithay::{
     },
     desktop::space::SpaceElement,
     output::Output,
-    reexports::wayland_server::protocol::wl_shm::Format as ShmFormat,
+    reexports::wayland_server::protocol::{wl_pointer::WlPointer, wl_shm::Format as ShmFormat},
     utils::{Buffer as BufferCoords, Point, Size, Transform},
     wayland::{
         dmabuf::get_dmabuf,
@@ -69,6 +69,7 @@ impl ImageCopyCaptureHandler for State {
     fn cursor_capture_constraints(
         &mut self,
         _source: &ImageCaptureSource,
+        _pointer: &WlPointer,
     ) -> Option<BufferConstraints> {
         let size = if let Some((geometry, _)) = self
             .common
diff --git a/src/wayland/handlers/virtual_keyboard.rs b/src/wayland/handlers/virtual_keyboard.rs
index 26d9ec81..f39ff22a 100644
--- a/src/wayland/handlers/virtual_keyboard.rs
+++ b/src/wayland/handlers/virtual_keyboard.rs
@@ -1,35 +1,6 @@
 // SPDX-License-Identifier: GPL-3.0-only
 
 use crate::state::State;
-use smithay::{
-    backend::input::KeyState,
-    delegate_virtual_keyboard_manager,
-    input::keyboard::{FilterResult, KeyboardHandle, Keycode, xkb::ModMask},
-    utils::SERIAL_COUNTER,
-    wayland::virtual_keyboard::VirtualKeyboardHandler,
-};
-
-impl VirtualKeyboardHandler for State {
-    fn on_keyboard_event(
-        &mut self,
-        keycode: Keycode,
-        state: KeyState,
-        time: u32,
-        keyboard: KeyboardHandle<Self>,
-    ) {
-        let serial = SERIAL_COUNTER.next_serial();
-        keyboard.input(self, keycode, state, serial, time, |_, _, _| {
-            FilterResult::Forward::<bool>
-        });
-    }
-    fn on_keyboard_modifiers(
-        &mut self,
-        _depressed_mods: ModMask,
-        _latched_mods: ModMask,
-        _locked_mods: ModMask,
-        _keyboard: KeyboardHandle<Self>,
-    ) {
-    }
-}
+use smithay::delegate_virtual_keyboard_manager;
 
 delegate_virtual_keyboard_manager!(State);
-- 
2.53.0

