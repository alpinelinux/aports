# Contributor: Guy Godfroy <guy.godfroy@gugod.fr>
# Maintainer: Guy Godfroy <guy.godfroy@gugod.fr>
pkgname=alloy
pkgver=1.11.3
pkgrel=1
pkgdesc="OpenTelemetry Collector distribution with programmable pipelines"
url="https://grafana.com/oss/alloy"
# riscv64: Check failed: (trampoline_pos - fixup_pos) <= kMaxBranchOffset
# https://github.com/nodejs/node/issues/60895
arch="all !armhf !armv7 !x86 !riscv64" # needs 64 bits arch
license="Apache-2.0"
makedepends="go yarn zstd-dev"
subpackages="$pkgname-openrc"
install="$pkgname.pre-install"
source="$pkgname-$pkgver.tar.gz::https://github.com/grafana/alloy/archive/refs/tags/v$pkgver.tar.gz
	alloy.initd
	alloy.confd
	"
options="net" # go dependancies
pkgusers="alloy"
pkggroups="alloy"

build() {
	# loongarch64: fix R_LARCH_B26 overflow
	case "$CARCH" in
		loongarch64)
			export CGO_CFLAGS="$CGO_CFLAGS -mcmodel=extreme"
			export CGO_CXXFLAGS="$CGO_CXXFLAGS -mcmodel=extreme"
			;;
		esac

	ldflags="-X github.com/grafana/alloy/internal/build.Version=$pkgver \
		 -X github.com/grafana/alloy/internal/build.BuildUser=aports@alpine \
		 -X github.com/grafana/alloy/internal/build.BuildDate=$(date -u "+%Y-%m-%dT%H:%M:%SZ" ${SOURCE_DATE_EPOCH:+-d @$SOURCE_DATE_EPOCH})"
	tags="netgo builtinassets external_libzstd"

	yarn --cwd internal/web/ui --frozen-lockfile
	yarn --cwd internal/web/ui run build
	go build -v \
		-ldflags "$ldflags" \
		-tags "$tags" \
		.
}

check() {
	TZ=UTC GOGC=10 go test
}

package() {
	install -m755 -D alloy "$pkgdir"/usr/bin/alloy
	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname
	install -m644 -D example/docker-compose/config/alloy/config.alloy \
		"$pkgdir"/etc/alloy/config.alloy
	install -m755 -d -o alloy -g alloy "$pkgdir"/var/lib/alloy
}

sha512sums="
f6b0ad0b02e999ea3df2534a103f8c9e0a82e510e920485cf5ff7b10c4c9474f95500292c89c6225214600293789df46e768d7c1e4a0fd1a5e9147dc5e61f953  alloy-1.11.3.tar.gz
4164dda3cad900b7ca99a3456f84e21a3b62b34203be829bd4ea7c1977e77d3281aae77745a5a4fed32bc39402ae07a6fc2fd1d80e3dbadeafba5c1c73baffcc  alloy.initd
37a09b44fde056fa896b60b17c554e6a8ec9d707b7f4abd81c3c5c7c9dbb06b957f8bdc4eea2ce0329e50ed882065b55cbac9c2ea89555e8298bf093729e2559  alloy.confd
"
