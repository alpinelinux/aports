# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=elasticsearch
pkgver=5.3.0
pkgrel=0
pkgdesc="Open Source, Distributed, RESTful Search Engine"
url="https://www.elastic.co/products/elasticsearch"
arch="x86 x86_64"
license="ASL-2.0"
depends="java-jna-native>=4.1 openjdk8-jre bash"
makedepends=""
options="!check"
install="$pkgname.pre-install"
subpackages="$pkgname-doc"
source="https://artifacts.elastic.co/downloads/$pkgname/$pkgname-$pkgver.tar.gz
	$pkgname.initd
	$pkgname.confd
	README.alpine
	"
builddir="$srcdir/$pkgname-$pkgver"
_basedir="/usr/share/java/$pkgname"

build() {
	return 0
}

package() {
	local destdir="$pkgdir/$_basedir"
	local confdir="$pkgdir/etc/$pkgname"
	local docdir="$pkgdir/usr/share/doc/elasticsearch"
	local heapsize="256m"

	cd "$builddir"

	install -dm755 "$destdir"/lib "$destdir"/bin
	install -m644 -t "$destdir"/lib lib/*

	install -dm755 "$docdir"
	install -dm755 "$confdir"
	install -m644 -t "$confdir" config/*

	# remove windows files
	find bin -type f -name *.bat -exec rm -f {} \;
	find bin -type f -name *.exe -exec rm -f {} \;

	# ES bin script parses the new jvm.options file
	install -m755 -t "$destdir"/bin bin/*

	# Modules are no longer subpkgs
	cp -rf modules $destdir/

	# reduce heap sizes
	sed -i \
	  -e "s|^-Xms.*|-Xms$heapsize|" \
	  -e "s|^-Xmx.*|-Xmx$heapsize|" \
	$confdir/jvm.options

	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname

	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname

	install -m644 -D "$srcdir"/README.alpine \
		"$docdir"
}

_builtin_module() {
	local name="$1"
	local destdir="$subpkgdir/$_basedir/modules/$name"

	install -dm755 "$destdir"
	install -m644 -t "$destdir" "$builddir"/modules/$name/*
}

sha512sums="343c4f9d752ff0fec2836620f758f3b02ac88aff0dcec979094ba20b869bf897df5a464a204e265a3e153c725aa87a4ca9a31597509196a3f2a2340d073c895e  elasticsearch-5.3.0.tar.gz
503d7093326f5f69aab66b3eb0e834bbdf1b898986155b131e9d226dad2801885c5aa60640c56e5fead5fecb177c53dee3fb3c634b97891ac8383a253cb4a36e  elasticsearch.initd
2ab1baf1b5c8782f3f371ba221aadd3e841abc62175f0b1ddcfc68d711e2370465124e076f8cc2e549c25a1da9db8c90172b2f410bd6bbe4153f0e831620b6ba  elasticsearch.confd
6de81485cdc059afef58382862e4155482463fde0b604aaa8dbe904c778b841467c4a383a5e54acd09e3436f1fb7be9923e001fb77bd3d7894e113a5e0f4036b  README.alpine"
