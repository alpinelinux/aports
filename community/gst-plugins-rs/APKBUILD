maintainer="team/alpine-desktop <achill@achill.org>"
pkgname=gst-plugins-rs
pkgver=0.15.0
pkgrel=0
pkgdesc="Gstreamer rust plugins"
url="https://gitlab.freedesktop.org/gstreamer/gst-plugins-rs"
arch="all"
license="MIT AND Apache-2.0 AND MPL-2.0 AND LGPL-2.1-or-later"
makedepends="
	cargo-auditable
	cargo-c
	clang-dev
	cmake
	dav1d-dev
	gst-plugins-bad-dev
	gst-plugins-base-dev
	gst-devtools-dev
	gtk4.0-dev
	libsodium-dev
	meson
	nasm
	openssl-dev
	"
_plugins="
	cdg
	claxon
	dav1d
	fallbackswitch
	ffv1
	gif
	gopbuffer
	gtk4
	hlssink3
	hsv
	isobmff
	json
	lewton
	livesync
	mpegtslive
	ndi
	originalbuffer
	quinn
	raptorq
	rav1e
	regex
	reqwest
	rsaudiofx
	rsclosedcaption
	rsfile
	rsflv
	rsinter
	rsonvif
	rspng
	rsrtp
	rsrtsp
	rstracers
	rsvideofx
	rswebp
	sodium
	spotify
	textahead
	textwrap
	threadshare
	togglerecord
	uriplaylistbin
	webrtchttp
	"
source="https://gitlab.freedesktop.org/gstreamer/gst-plugins-rs/-/archive/$pkgver/gst-plugins-rs-$pkgver.tar.gz
	cargo_wrapper.patch
	"
options="net !check" # they don't run

export SODIUM_USE_PKG_CONFIG=1

prepare() {
	default_prepare

	cargo fetch --locked
}

# Fails on trying to download prebuild binaries from
# https://github.com/rust-skia/skia-binaries/releases/
_opts="-Dskia=disabled"

# Fails to build
_opts="$_opts -Dwhisper=disabled"

case "$CARCH" in
	# Some plugins run out of memory compiling, disable them
	armhf|armv7|x86)
		_opts="$_opts -Daws=disabled -Dwebrtc=disabled"
		;;
	aarch64)
		_plugins="$_plugins aws"
		_opts="$_opts -Dwebrtc=disabled"
		;;
	*)
		_plugins="$_plugins aws rswebrtc"
		# tools is currently only used when webrtc is enabled
		subpackages="$subpackages $pkgname-tools"
		;;
esac

_sub_plugin() {
	local n=${subpkgname##"$pkgname"-}
	pkgdesc="Gstreamer rust plugin for $n"
	amove usr/lib/gstreamer-1.0/libgst"$n".so
}

for _plugin in $_plugins; do
	subpackages="$subpackages $pkgname-$_plugin:_sub_plugin"
done

build() {
	export CARGO_PROFILE_RELEASE_OPT_LEVEL=3
	abuild-meson \
		--buildtype=release \
		$_opts \
		. output
	meson compile -C output
}

check() {
	meson test --print-errorlogs -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
}

tools() {
	amove usr/bin
}

sha512sums="
d38ca01da58ae9212a2b2028cc1a190ce4a71327e7eb5fa8f07c565744da6f6f4b1b212b4c79a44265db04547bceb4846038cf9d83657f2b494319fa20566606  gst-plugins-rs-0.15.0.tar.gz
31a05258d7dca274b782e06bc56ddcb69c86d681b2c0d59acbed45ebcf17734828033da97a62751730aca2acab4f0c94a806d1cffdba2035539e2eb79f52fbe8  cargo_wrapper.patch
"
