# Contributor: Kevin Daudt <kdaudt@alpinelinux.org>
# Maintainer: Kevin Daudt <kdaudt@alpinelinux.org>
pkgname=gdu
pkgver=5.33.0
_majorver=${pkgver%%.*}
pkgrel=0
pkgdesc="Fast disk usage calculator with console interface"
url="https://github.com/dundee/gdu"
arch="all"
license="MIT"
depends="ncurses"
makedepends="go gzip"
checkdepends="tzdata"
subpackages="$pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/dundee/gdu/archive/refs/tags/v$pkgver.tar.gz
	ash.patch
	analyze-storage-set-explicit-vlog-size.patch
	test-skip-flaky-test-assertion.patch
	"

prepare() {
	default_prepare

	rm -rf vendor/
}

build() {
	local versionflags
	versionflags="
	-X github.com/dundee/gdu/v$_majorver/build.Version=$pkgver
	-X github.com/dundee/gdu/v$_majorver/build.User=buildozer
	-X 'github.com/dundee/gdu/v$_majorver/build.Time=$(date)'
	"
	go build -v \
		-ldflags="$versionflags" \
		./cmd/gdu

	gzip gdu.1
}

check() {
		go test -v ./...
}

package() {
	install -Dm0755 gdu -t "$pkgdir"/usr/bin/
	install -Dm0644 gdu.1.gz -t "$pkgdir"/usr/share/man/man1/
	install -Dm0644 LICENSE.md -t "$pkgdir"/usr/share/licenses/gdu/
}

sha512sums="
d7c226f72676a29cae73b5e128563945c893b6aeabe41173d3ef83b7e62a30a4921681e4048bc58b9796e6e3dae8ea0bcae54fd274400ba4abcd25989c206298  gdu-5.33.0.tar.gz
cc85da4cb2c015166c916ea33768c6b486b8c12bdfce37ffcf1b9c8b7e9c6504de25425d6f71d3d03750fc82732ee69ab34c5f494b0ef3d8c5cc4e4f79e79cd7  ash.patch
f7b2dcb5bce1383c7c4f600491f5796844158c823aa89ffb47806e2704b99a976674d32ca95ccf6ce2be9961a477cd4f3b63a557da68ee874d27a5083d47b493  analyze-storage-set-explicit-vlog-size.patch
90979122ace561917e9e1c1c37083c15ecdea62aa930a155961638cc5bca4f74e5727e4e1c3172a9919abd0c90234cf1a98c34c18eb0cb2e3c27754c7bf8e32e  test-skip-flaky-test-assertion.patch
"
