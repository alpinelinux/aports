From 53909bbc260e7bc9fe54f2e77bb0ad653dc345fe Mon Sep 17 00:00:00 2001
From: Tom Sepez <tsepez@google.com>
Date: Mon, 9 Feb 2026 16:37:53 -0800
Subject: [PATCH] [M144] Fix indexing in opj_j2k_read_sod()

Apply same check as in opj_j2k_add_tlmarker().

Bug: 477033835
Change-Id: I18def8cdd683cb1e8ed9359914e286de9837d382
Reviewed-on: https://pdfium-review.googlesource.com/c/pdfium/+/142390
Auto-Submit: Tom Sepez <tsepez@chromium.org>
Reviewed-by: Lei Zhang <thestig@chromium.org>
Commit-Queue: Lei Zhang <thestig@chromium.org>
Commit-Queue: Tom Sepez <tsepez@chromium.org>
(cherry picked from commit 40e5a93503adcdd4b9b3fdc085a31a58b7b0f2dd)
Reviewed-on: https://pdfium-review.googlesource.com/c/pdfium/+/142593
---
 .../libopenjpeg/0047-opj_j2k_read_sod.patch   | 27 +++++++++++++++++++
 third_party/libopenjpeg/README.pdfium         |  1 +
 third_party/libopenjpeg/j2k.c                 | 16 ++++++-----
 3 files changed, 37 insertions(+), 7 deletions(-)
 create mode 100644 third_party/libopenjpeg/0047-opj_j2k_read_sod.patch

diff --git a/third_party/pdfium/third_party/libopenjpeg/0047-opj_j2k_read_sod.patch b/third_party/pdfium/third_party/libopenjpeg/0047-opj_j2k_read_sod.patch
new file mode 100644
index 000000000..93259a54b
--- /dev/null
+++ b/third_party/pdfium/third_party/libopenjpeg/0047-opj_j2k_read_sod.patch
@@ -0,0 +1,27 @@
+diff --git a/third_party/libopenjpeg/j2k.c b/third_party/libopenjpeg/j2k.c
+index 5e9d75076..fc5ce62df 100644
+--- a/third_party/libopenjpeg/j2k.c
++++ b/third_party/libopenjpeg/j2k.c
+@@ -5082,13 +5082,15 @@ static OPJ_BOOL opj_j2k_read_sod(opj_j2k_t *p_j2k,
+ 
+         OPJ_UINT32 l_current_tile_part =
+             l_cstr_index->tile_index[p_j2k->m_current_tile_number].current_tpsno;
+-        l_cstr_index->tile_index[p_j2k->m_current_tile_number].tp_index[l_current_tile_part].end_header
+-            =
+-                l_current_pos;
+-        l_cstr_index->tile_index[p_j2k->m_current_tile_number].tp_index[l_current_tile_part].end_pos
+-            =
+-                l_current_pos + p_j2k->m_specific_param.m_decoder.m_sot_length + 2;
+-
++        if (l_cstr_index->tile_index[p_j2k->m_current_tile_number].tp_index &&
++            l_current_tile_part < l_cstr_index->tile_index[p_j2k->m_current_tile_number].nb_tps) {
++          l_cstr_index->tile_index[p_j2k->m_current_tile_number].tp_index[l_current_tile_part].end_header
++              =
++              l_current_pos;
++          l_cstr_index->tile_index[p_j2k->m_current_tile_number].tp_index[l_current_tile_part].end_pos
++              =
++              l_current_pos + p_j2k->m_specific_param.m_decoder.m_sot_length + 2;
++        }
+         if (OPJ_FALSE == opj_j2k_add_tlmarker(p_j2k->m_current_tile_number,
+                                               l_cstr_index,
+                                               J2K_MS_SOD,
diff --git a/third_party/pdfium/third_party/libopenjpeg/README.pdfium b/third_party/pdfium/third_party/libopenjpeg/README.pdfium
index 289f19a59..905c64001 100644
--- a/third_party/pdfium/third_party/libopenjpeg/README.pdfium
+++ b/third_party/pdfium/third_party/libopenjpeg/README.pdfium
@@ -33,6 +33,7 @@ Local Modifications:
 0039-opj_mqc_renorme.patch: Remove unused opj_mqc_renorme().
 0041-remove_opj_clock.patch: Remove unused opj_clock.h include.
 0046-func-ptr-mixup.patch: Prevent mixing up function pointer types.
+0047-opj_j2k_read_sod.patch: Fix out of bounds read.
 
 Note:
 
diff --git a/third_party/pdfium/third_party/libopenjpeg/j2k.c b/third_party/pdfium/third_party/libopenjpeg/j2k.c
index 5e9d75076..fc5ce62df 100644
--- a/third_party/pdfium/third_party/libopenjpeg/j2k.c
+++ b/third_party/pdfium/third_party/libopenjpeg/j2k.c
@@ -5082,13 +5082,15 @@ static OPJ_BOOL opj_j2k_read_sod(opj_j2k_t *p_j2k,
 
         OPJ_UINT32 l_current_tile_part =
             l_cstr_index->tile_index[p_j2k->m_current_tile_number].current_tpsno;
-        l_cstr_index->tile_index[p_j2k->m_current_tile_number].tp_index[l_current_tile_part].end_header
-            =
-                l_current_pos;
-        l_cstr_index->tile_index[p_j2k->m_current_tile_number].tp_index[l_current_tile_part].end_pos
-            =
-                l_current_pos + p_j2k->m_specific_param.m_decoder.m_sot_length + 2;
-
+        if (l_cstr_index->tile_index[p_j2k->m_current_tile_number].tp_index &&
+            l_current_tile_part < l_cstr_index->tile_index[p_j2k->m_current_tile_number].nb_tps) {
+          l_cstr_index->tile_index[p_j2k->m_current_tile_number].tp_index[l_current_tile_part].end_header
+              =
+              l_current_pos;
+          l_cstr_index->tile_index[p_j2k->m_current_tile_number].tp_index[l_current_tile_part].end_pos
+              =
+              l_current_pos + p_j2k->m_specific_param.m_decoder.m_sot_length + 2;
+        }
         if (OPJ_FALSE == opj_j2k_add_tlmarker(p_j2k->m_current_tile_number,
                                               l_cstr_index,
                                               J2K_MS_SOD,
