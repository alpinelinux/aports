From 197563d9f2a2e8870b265fe4e67cbf10fa8d7f55 Mon Sep 17 00:00:00 2001
From: Manos Koukoutos <manoskouk@chromium.org>
Date: Thu, 5 Feb 2026 11:57:01 +0000
Subject: [PATCH] [wasm][turboshaft] CHECK that Phi does not have too many
 inputs

(cherry picked from commit 04d57e1a869ae90d812cc66eb5946b42069558e8)

Bug: 481074858
Change-Id: I0a4481d5ca02ad92f5dd17d7c71fab31c1729b4d
Reviewed-on: https://chromium-review.googlesource.com/c/v8/v8/+/7545364
Reviewed-by: Nico Hartmann <nicohartmann@chromium.org>
Commit-Queue: Manos Koukoutos <manoskouk@chromium.org>
Reviewed-by: Clemens Backes <clemensb@chromium.org>
Cr-Original-Commit-Position: refs/heads/main@{#105094}
Reviewed-on: https://chromium-review.googlesource.com/c/v8/v8/+/7560811
Reviewed-by: Manos Koukoutos <manoskouk@chromium.org>
Cr-Commit-Position: refs/branch-heads/14.4@{#48}
Cr-Branched-From: 80acc26727d5a34e77dabeebe7c9213ec1bd4768-refs/heads/14.4.258@{#1}
Cr-Branched-From: ce7e597e90f6df3fa4b6df224bc613b80c635450-refs/heads/main@{#104020}
---
 src/compiler/turboshaft/operations.h | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/v8/src/compiler/turboshaft/operations.h b/v8/src/compiler/turboshaft/operations.h
index 4f00dc4ca77..601f734bf93 100644
--- a/v8/src/compiler/turboshaft/operations.h
+++ b/v8/src/compiler/turboshaft/operations.h
@@ -2600,7 +2600,12 @@ struct PhiOp : OperationT<PhiOp> {
   }
 
   explicit PhiOp(base::Vector<const OpIndex> inputs, RegisterRepresentation rep)
-      : Base(inputs), rep(rep) {}
+      : Base(inputs), rep(rep) {
+    // We add an additional CHECK specifically for Phi, to prevent Wasm from
+    // passing too many inputs, e.g. as part of a br_table operation.
+    CHECK_LE(inputs.size(),
+             std::numeric_limits<decltype(this->input_count)>::max());
+  }
 
   // Helpers to access loop phis forward/backedge. These should only be used for
   // loop phis (which isn't trivial to DCHECK since PhiOp doesn't know if it's a
