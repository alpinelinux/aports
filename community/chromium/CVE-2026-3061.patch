From effb3a5e7ee51a5cfec63f9cb3bb22fadbad6ae6 Mon Sep 17 00:00:00 2001
From: Eugene Zemtsov <eugene@chromium.org>
Date: Thu, 19 Feb 2026 16:58:57 -0800
Subject: [PATCH] [M144]media: Validate second_chroma_qp_index_offset range in
 H.264 parser

The H.264 spec requires second_chroma_qp_index_offset to be in the
range [-12, 12]. Previously, this value was read without validation.

(cherry picked from commit c4726aab7bf1e15741b090d8b401515bf7be2d6b)

Bug: 482862710
Change-Id: Ie40f42ff677d436a10c53779f55fcfb8279564dd
Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/7572949
Reviewed-by: Dale Curtis <dalecurtis@chromium.org>
Commit-Queue: Eugene Zemtsov <eugene@chromium.org>
Cr-Original-Commit-Position: refs/heads/main@{#1584344}
Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/7595179
Reviewed-by: Ted (Chromium) Meyer <tmathmeyer@chromium.org>
Reviewed-by: Eugene Zemtsov <eugene@chromium.org>
Cr-Commit-Position: refs/branch-heads/7559@{#4732}
Cr-Branched-From: 223dfbac1c7542a06b422390d954afe5b560b607-refs/heads/main@{#1552494}
---
 media/parsers/h264_parser.cc          |  1 +
 media/parsers/h264_parser_unittest.cc | 40 +++++++++++++++++++++++++++
 2 files changed, 41 insertions(+)

diff --git a/media/parsers/h264_parser.cc b/media/parsers/h264_parser.cc
index b32e70e23ce56..5e4fb93e9fe7d 100644
--- a/media/parsers/h264_parser.cc
+++ b/media/parsers/h264_parser.cc
@@ -1149,6 +1149,7 @@ H264Parser::Result H264Parser::ParsePPS(int* pps_id) {
       }
 
       READ_SE_OR_RETURN(&pps->second_chroma_qp_index_offset);
+      IN_RANGE_OR_RETURN(pps->second_chroma_qp_index_offset, -12, 12);
     }
   }
 
diff --git a/media/parsers/h264_parser_unittest.cc b/media/parsers/h264_parser_unittest.cc
index 1cadbe5ebed6a..d13f50b913caa 100644
--- a/media/parsers/h264_parser_unittest.cc
+++ b/media/parsers/h264_parser_unittest.cc
@@ -4,6 +4,7 @@
 
 #include "media/parsers/h264_parser.h"
 
+#include <array>
 #include <limits>
 #include <memory>
 #include <optional>
@@ -431,4 +432,43 @@ TEST(H264ParserTest, RecursiveSEIParsing) {
                sei_msg);
   }
 }
+
+TEST(H264ParserTest, ParsePPS_SecondChromaQPIndexOffset_OutRange) {
+  // SPS: High Profile (100), Level 1.0 (10), seq_parameter_set_id = 0.
+  // This is required because second_chroma_qp_index_offset is only parsed
+  // for High profile or above.
+  constexpr auto kSPS = std::to_array<uint8_t>({
+      0x00, 0x00, 0x01, 0x67,  // Header
+      0x64, 0x00, 0x0A,        // Profile/Level
+      0xF3, 0xDC, 0x40         // Payload
+  });
+
+  // PPS: pic_parameter_set_id = 0, seq_parameter_set_id = 0.
+  // second_chroma_qp_index_offset = 13 (invalid, range is -12 to 12).
+  // Encoded as se(v) -> ue(25) -> 0000 11010.
+  constexpr auto kPPS = std::to_array<uint8_t>({
+      0x00, 0x00, 0x01, 0x68,  // Header
+      0xCE, 0x38, 0x03, 0x50   // Payload
+  });
+
+  H264Parser parser;
+  H264NALU nalu;
+  int id;
+
+  // Parse SPS.
+  parser.SetStream(kSPS);
+  ASSERT_EQ(H264Parser::kOk, parser.AdvanceToNextNALU(&nalu));
+  ASSERT_EQ(H264NALU::kSPS, nalu.nal_unit_type);
+  ASSERT_EQ(H264Parser::kOk, parser.ParseSPS(&id));
+
+  // Parse PPS.
+  parser.SetStream(kPPS);
+  ASSERT_EQ(H264Parser::kOk, parser.AdvanceToNextNALU(&nalu));
+  ASSERT_EQ(H264NALU::kPPS, nalu.nal_unit_type);
+
+  // This should fail because second_chroma_qp_index_offset is out of range.
+  // Before the fix, this would return kOk.
+  EXPECT_EQ(H264Parser::kInvalidStream, parser.ParsePPS(&id));
+}
+
 }  // namespace media
