# Contributor: Leo <thinkabit.ukim@gmail.com>
# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=stellarium
pkgver=25.4
pkgrel=0
pkgdesc="Stellarium with great graphics and a nice database of sky-objects"
url="https://stellarium.org/"
# gigantic package
arch="aarch64 loongarch64 x86_64"
license="GPL-2.0-or-later"
depends="
	qt6-qtimageformats
	qt6-qtsvg
	"
makedepends="
	boost-dev
	cmake
	cmd:pod2man
	exiv2-dev
	freetype-dev
	gpsd-dev
	libpng-dev
	mesa-dev
	openssl-dev
	qt6-qtcharts-dev
	qt6-qtmultimedia-dev
	qt6-qtpositioning-dev
	qt6-qtserialport-dev
	qt6-qttools-dev
	samurai
	"
subpackages="$pkgname-doc"
_qxlsx=90d762625750c6b2c73f6cd96b633e9158aed72e
_indi=2.1.3
_md4c=0.5.2
_nlopt=2.9.0
source="https://github.com/Stellarium/stellarium/releases/download/v$pkgver/stellarium-$pkgver.tar.xz
	QXlsx-$_qxlsx.tar.gz.noauto::https://github.com/QtExcel/QXlsx/archive/$_qxlsx.tar.gz
	indi-$_indi.zip.noauto::https://github.com/indilib/indi/archive/v$_indi.zip
	md4c-$_md4c.tar.gz.noauto::https://github.com/mity/md4c/archive/release-$_md4c.tar.gz
	nlopt-$_nlopt.tar.gz.noauto::https://github.com/stevengj/nlopt/archive/refs/tags/v$_nlopt.tar.gz

	find-lupdate-lconvert.patch
	qslsx-bump.patch
	"

prepare() {
	#grep -q "URL https://github.com/QtExcel/QXlsx/archive/refs/tags/v$_qxlsx.tar.gz" CMakeLists.txt
	install -Dvm644 "$srcdir"/QXlsx-$_qxlsx.tar.gz.noauto \
		build/_deps/qxlsxqt6-subbuild/qxlsxqt6-populate-prefix/src/$_qxlsx.tar.gz
	grep -q "URL https://github.com/indilib/indi/archive/v$_indi.zip" src/external/CMakeLists.txt
	install -Dvm644 "$srcdir"/indi-$_indi.zip.noauto \
		build/_deps/indiclient-subbuild/indiclient-populate-prefix/src/v$_indi.zip
	grep -q "URL https://github.com/mity/md4c/archive/refs/tags/release-$_md4c.tar.gz" CMakeLists.txt
	install -Dvm644 "$srcdir"/md4c-$_md4c.tar.gz.noauto \
		build/_deps/md4c-subbuild/md4c-populate-prefix/src/release-$_md4c.tar.gz
	grep -q "URL https://github.com/stevengj/nlopt/archive/refs/tags/v$_nlopt.tar.gz" plugins/LensDistortionEstimator/src/CMakeLists.txt
	install -Dvm644 "$srcdir"/nlopt-$_nlopt.tar.gz.noauto \
		build/_deps/nlopt-subbuild/nlopt-populate-prefix/src/v$_nlopt.tar.gz

	default_prepare
}

build() {
	# SHOWMYSKY support needs qt6-qtopengl
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DENABLE_TESTING="$(want_check && echo ON || echo OFF)" \
		-DENABLE_SHOWMYSKY=OFF
	cmake --build build
}

check() {
	# Exclude a broken locale test
	ctest --test-dir build \
		-E 'test(INDIConnection|TelescopeControl_INDI|TelescopeClientINDI)'
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
a6b87ccb8670d66fe097817822631bda78b50a0e5371ed759b91f16f60c74e68711334e1c8263c80aaea7b3d4f512ece0bd7008aafd35393ddbe641cbda055e3  stellarium-25.4.tar.xz
57b9ffbcd2374ce8cbc36db0dbbcb3b93ceea4a4d2f2d3b62f7041e51c75ddddcff6e7bdcb21d01afc8799fce7e81ea1160bb198d14d63a40e39f593ce557751  QXlsx-90d762625750c6b2c73f6cd96b633e9158aed72e.tar.gz.noauto
c933dd2f27ccf04fa879e063e891e86b058c72f10a7354a592854a54d9a2e2dd970317c69f18b72c6a094632916d8122f01007bbc659e976307d97ac4389b84a  indi-2.1.3.zip.noauto
30607ba39d6c59329f5a56a90cd816ff60b82ea752ac2b9df356d756529cfc49170019fae5df32fa94afc0e2a186c66eaf56fa6373d18436c06ace670675ba85  md4c-0.5.2.tar.gz.noauto
bbe9421f20a786dba348c2c5f7b227d8e29098a03f566a1f478289d89710c5d977fa8646c1432263aa2f6e0e9fe663baf47fdfcaf9e658127b1a3a88abdf4515  nlopt-2.9.0.tar.gz.noauto
caa4f56b9e1975a7f05da9144e474d9696dbbc08cb5ed04d4489addcc10688c4329754b5aa4bc6d78068b91c9887978bf5f446690908d6acb9aa8815d9b32e38  find-lupdate-lconvert.patch
523824c6408c261b52b486d1ef9e725ed29f3360fa88867d7a00d30e83175784a20070801241b1f2eb7f8936cfbf097b19d7ea9952c8c9ba338f5c07ede05526  qslsx-bump.patch
"
