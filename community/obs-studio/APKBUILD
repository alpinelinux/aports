# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
pkgname=obs-studio
pkgver=32.0.3
pkgrel=0
pkgdesc="Free and open source software for live streaming and screen recording"
url="https://obsproject.com/"
arch="all !riscv64 !armhf" # luajit, openmp
license="GPL-2.0-or-later"
options="!check"
makedepends="
	alsa-lib-dev
	appstream-glib
	cmake
	curl-dev
	eudev-dev
	extra-cmake-modules
	fdk-aac-dev
	ffmpeg-dev
	ffnvcodec-headers
	fontconfig-dev
	freetype-dev
	jack-dev
	jansson-dev
	librist-dev
	libdatachannel-dev
	libsrt-dev
	libva-glx-dev
	libva-dev
	libxcb-dev
	libx11-dev
	libxcomposite-dev
	libxinerama-dev
	libxkbcommon-dev
	linux-headers
	luajit-dev
	mbedtls-static
	mesa-dev
	nlohmann-json
	openmp-dev
	openssl-dev
	pciutils-dev
	pipewire-dev
	pulseaudio-dev
	python3-dev
	py3-glad
	qt6-qtbase-dev
	qt6-qtbase-private-dev
	qt6-qtsvg-dev
	rnnoise-dev
	samurai
	sed
	simde-dev
	sndio-dev
	speexdsp-dev
	swig
	uthash-dev
	vlc-dev
	v4l-utils-dev
	wayland-dev
	x264-dev
	"
subpackages="$pkgname-dev"
source="https://github.com/obsproject/obs-studio/archive/$pkgver/obs-studio-$pkgver.tar.gz
obs-studio-12328.patch
fix-cmake-settings.patch"

# Regression for VPL only available for x86_64
# https://github.com/obsproject/obs-studio/issues/9578
case $CARCH in
	x86_64)
		makedepends="$makedepends libvpl-dev"
		_vpl=ON
	;;
	loongarch64)
		export CFLAGS="$CFLAGS -DSIMDE_NO_NATIVE -DSIMDE_NO_X86_SSE -DSIMDE_NO_X86_SSE2"
		export CXXFLAGS="$CXXFLAGS -DSIMDE_NO_NATIVE -DSIMDE_NO_X86_SSE -DSIMDE_NO_X86_SSE2"
	;;
	*)
		_vpl=OFF
	;;
esac

prepare() {
	default_prepare
	# no toggle for these, but the dirs are empty by default
	# make them valid cmake subdirs that do nothing
	touch plugins/obs-browser/CMakeLists.txt
	touch plugins/obs-websocket/CMakeLists.txt
	rm -rf deps/glad/include/EGL
	rm -rf deps/glad/include/KHR
}

build() {
	export CFLAGS="$CFLAGS  -Wno-incompatible-pointer-types"
	export SIMDe_INCLUDE_DIR="/usr/include/simde"
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_SKIP_INSTALL_RPATH=ON \
		-DOBS_VERSION_OVERRIDE=$pkgver \
		-DCALM_DEPRECATION=ON \
		-DOPENGL_opengl_LIBRARY=/usr/lib/libGL.so \
		-DENABLE_AJA=OFF \
		-DENABLE_DECKLINK=0 \
		-DENABLE_LIBFDK=ON \
		-DENABLE_JACK=ON \
		-DENABLE_NVENC=OFF \
		-DENABLE_FRONTEND=ON \
		-DENABLE_WAYLAND=ON \
		-DENABLE_FFMPEG_NVENC=OFF \
		-DENABLE_WEBRTC=ON \
		-DOpenGL_GL_PREFERENCE=GLVND \
		-DCALM_DEPRECATION=ON \
		-DENABLE_VST=ON \
		-DENABLE_VST=OFF \
		-DENABLE_QSV11=$_vpl \
		-DENABLE_VLC=ON \
		-DCMAKE_COMPILE_WARNING_AS_ERROR=OFF \
		-Wno-dev
	cmake --build build -j$(nproc)
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
533f365e47d44ec00def4bda5a2fa0a811631fb5872a098abc2d3e40306b2805170cacc421cb211ab6ed93913d26c7de93bcf154f8ddba9b933242574e8dfd2f  obs-studio-32.0.3.tar.gz
ae1026f9e15563ee23d87f3a769e2168e09b4e0ff3211947f66991b5e96068baada649428c5811f705fe555ea20345fb800909cb31573c74f5acdf6f48193023  obs-studio-12328.patch
fdb16f49be02e1ccc4c3ad7385184d6df19dffd368f4de616bf4dadf77db0af9fbca650ea893d342ac9daaedac00e7cb70e967e667c595144e79a0e9040fd218  fix-cmake-settings.patch
"
