# Contributor: Steeve Chailloux <steeve.chailloux@orus.io>
# Contributor: Sören Tempel <soeren+alpine@soeren-tempel.net>
# Contributor: Mitch Tishmack <mitch.tishmack@gmail.com>
# Maintainer: Sören Tempel <soeren+alpine@soeren-tempel.net>
pkgname=cabal
pkgver=3.16.0.0
pkgrel=0
pkgdesc="The Haskell Cabal"
url="https://haskell.org/cabal"
arch="aarch64 x86_64" # Limited by GHC
license="BSD-3-Clause"
depends="ghc gmp zlib curl"
makedepends="ghc>=9.10.3 gmp-dev libffi-dev zlib-dev cabal-bootstrap~$pkgver"
options="net !check" # TODO: enable tests
subpackages="$pkgname-doc"
source="https://hackage.haskell.org/package/cabal-install-$pkgver/cabal-install-$pkgver.tar.gz
	cabal.project.freeze"
builddir="$srcdir/cabal-install-$pkgver"

# We currently don't package Haskell dependencies in aports. As such,
# building cabal requires a pre-existing cabal version to download all
# dependencies of the cabal package itself. Presently, this is achieved
# through the separate cabal-stage0 package which bootstraps cabal
# from source using a provided Python script. From that point onward,
# we can use the previous version of cabal to compile cabal.
#
# For this reason, both community/cabal-stage0 and community/cabal
# provide the virtual cabal-bootstrap package but the former has the
# lower priority.
#
# See also https://lists.alpinelinux.org/~alpine/devel/%3C33KG0XO61I4IL.2Z7RTAZ5J3SY6%408pit.net%3E
provides="cabal-bootstrap=$pkgver-r$pkgrel"
provider_priority=100 # highest

# Directory were cabal files are stored.
_cabal_home="$srcdir/dist"

cabal_update() {
	cd $builddir
	# Build a freeze file to make the build reproducible.
	# This freeze file is stored in $source and thus tracked in Git.
	HOME="$_cabal_home" cabal v2-update
	(
		cd "$builddir"
		HOME="$_cabal_home" cabal v2-freeze \
			--shadow-installed-packages
		mv cabal.project.freeze "$startdir/"
	)
}

prepare() {
	default_prepare
	ln -sf "$srcdir/cabal.project.freeze" \
		"$builddir/cabal.project.freeze"
}

build() {
	HOME="$_cabal_home" cabal v2-update
	HOME="$_cabal_home" cabal v2-build cabal-install:exes \
		--jobs=${JOBS:-1} \
		--prefix=/usr \
		--docdir=/usr/share/doc/$pkgname \
		--sysconfdir=/etc
}

package() {
	# With v2- cabal no longer wants us to separate v2-build and
	# v2-install, however, we don't want to build everything in a
	# fakeroot. We work around this by copying binaries build in the
	# previous step manually.
	#
	# See https://github.com/haskell/cabal/issues/6919#issuecomment-761563498
	HOME="$_cabal_home" cabal list-bin cabal-install:exes | \
		xargs install -Dm755 -t "$pkgdir"/usr/bin

	mkdir -p "$pkgdir"/usr/share/man/man1
	HOME="$_cabal_home" cabal man --raw \
		> "$pkgdir"/usr/share/man/man1/cabal.1

	install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}

sha512sums="
4bd0a8afb0d215c6517a94563e1f2a231da87d088219a0c607012de14b9c374843dfacea4adf9e6ac70dbd27160628d05afef7e0cc44644ab48298fed8ab8c9b  cabal-install-3.16.0.0.tar.gz
04c6fb27d5200deeffc414f3f00006b39f4c570d3ae29986e8fbacc70f7e4fb0d6278b987f5c7714c779b3b6fc45024c8796b1dc5007b59db7ebaba7669ea832  cabal.project.freeze
"
