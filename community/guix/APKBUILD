# Contributor: Sören Tempel <soeren+alpine@soeren-tempel.net>
# Maintainer: Sören Tempel <soeren+alpine@soeren-tempel.net>
pkgname=guix
pkgver=1.5.0
pkgrel=1
pkgdesc="Functional package manager based on Guile Scheme"
url="https://guix.gnu.org"
# s390x loongarch64 not supported upstream
arch="all !s390x !loongarch64"
license="GPL-3.0-or-later"
depends="
	guile
	guile-gcrypt
	guile-git
	guile-gnutls
	guile-json
	guile-lzlib
	guile-semver
	guile-sqlite3
	guile-zlib
	guile-zstd"
# XXX: coreutils required because build system is not compatible
# with BusyBox's mktemp implementation.
makedepends="
	argp-standalone
	bzip2-dev
	coreutils
	gettext-dev
	git
	guile-dev
	libgcrypt-dev
	linux-headers
	po4a
	sqlite-dev
	help2man
	texinfo"
install="guix.pre-install guix.pre-upgrade"
subpackages="
	$pkgname-doc
	$pkgname-lang
	$pkgname-openrc
	$pkgname-zsh-completion
	$pkgname-fish-completion
	$pkgname-bash-completion"
source="https://ftp.gnu.org/gnu/guix/guix-$pkgver.tar.gz
	guix-daemon.confd
	guix-daemon.initd
	guix.sh"

# secfixes:
#   1.4.0-r5:
#     - CVE-2024-27297

build() {
	local guix_system="$CARCH-linux"
	case $CARCH in
	arm*)    guix_system="armhf-linux"       ;;
	x86)     guix_system="i686-linux"        ;;
	ppc64le) guix_system="powerpc64le-linux" ;;
	esac

	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--with-system="$guix_system" \
		--with-bash-completion-dir=/usr/share/bash-completion/completions \
		--with-fish-completion-dir=/usr/share/fish/vendor_completions.d \
		--disable-rpath
	make LIBS="-lintl -largp"
}

package() {
	make DESTDIR="$pkgdir" install
	install -Dm644 "$srcdir"/guix.sh \
		"$pkgdir"/etc/profile.d/guix.sh

	# Remove other files that we don't use.
	rm -r "$pkgdir"/usr/lib/upstart \
		"$pkgdir"/etc/init.d \
		"$pkgdir"/etc/openrc \
		"$pkgdir"/usr/lib/systemd \
		"$pkgdir"/usr/share/selinux \
		"$pkgdir"/etc/apparmor.d

	# Install a custom OpenRC service.
	install -Dm755 "$srcdir"/guix-daemon.initd "$pkgdir"/etc/init.d/guix-daemon
	install -Dm644 "$srcdir"/guix-daemon.confd "$pkgdir"/etc/conf.d/guix-daemon

	# Add /etc/guix/acl with the default substitute servers.
	# Taken from: https://salsa.debian.org/debian/guix/-/blob/2d44a707ccaacbee73410b770aa1a395eff1caa6/debian/rules#L57
	mkdir -p "$pkgdir"/etc/guix
	{
		printf '(acl\n (entry\n'
		sed -e 's,^,  ,g' -e 's, $$,,g' etc/substitutes/ci.guix.gnu.org.pub
		printf '  (tag\n   (guix import)\n   )\n  )\n (entry\n'
		sed -e 's,^,  ,g' -e 's, $$,,g' etc/substitutes/bordeaux.guix.gnu.org.pub
		printf '  (tag\n   (guix import)\n   )\n  )\n )\n'
	} > "$pkgdir"/etc/guix/acl
}

sha512sums="
c3da9644444b10a4d8dcbd1524ce51a3d85c356fd90b851b78f0b4b604f29e3cb7f742f5e4301e29a084aef76d2e56669f73cd413df49e956fa00aed4390c24c  guix-1.5.0.tar.gz
abf55ed6ef93aa2dd4098ea4445a5d078937de0955570a543e6e6ea4d1d4bd16ed0cc006f0ff94fd0a7c349b42a24d266475334857c57ca40a60839e8bb51449  guix-daemon.confd
5218881faafc850e6e56cf819fadbe7739a9176b9f7b3f2fdd5c5ea2af994b43f1a7b786982ae6643f7830ced799bbe2f714cdde3f0795fbbbab15c1f9efa30e  guix-daemon.initd
51c7d2e94b872f67497a2e5f62ce67f2cf52641da22b299eba0e1f4eb80f0af047ee48b49626d191d690877fd803b875612d542272dd2508c08e02ffb304970e  guix.sh
"
