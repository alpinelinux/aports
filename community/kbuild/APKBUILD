# Contributor: Natanael Copa <ncopa@alpinelinux.org>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=kbuild
pkgver=0.1.9998r3149
_ver=${pkgver/r/.}
pkgrel=0
pkgdesc="A makefile framework for writing simple makefiles for complex tasks"
url="http://svn.netlabs.org/kbuild/wiki"
arch="x86 x86_64"
license="GPL-3.0"
depends=""
depends_dev=""
makedepends="autoconf automake bash flex bison gettext-dev acl-dev"
install=""
subpackages="$pkgname-doc"
source="https://dev.gentoo.org/~polynomial-c/kbuild-${_ver}-src.tar.xz
	lchmod.patch
	strlcpy.patch
	underlinking.patch
	sys_siglist.patch
	0001-define-ALLPERMS-is-missing.patch
	sys-types.patch
	uclibc.patch
	kobjcache.patch
	obstack.patch
	glob.patch"

_builddir="$srcdir"/kbuild-$_ver
prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i
		esac
	done
}

build() {
	cd "$_builddir"
	echo "KBUILD_SVN_URL := http://svn.netlabs.org/repos/kbuild/trunk" > SvnInfo.kmk
	echo "KBUILD_SVN_REV := 3149" >> SvnInfo.kmk
	# Not sure why, but we need to
	touch $_builddir/src/kmk/po/Makefile.in.in
	# the bootstrap process will create a symlink to the system shell,
	# which happens to be (/bin/sh) a symlink to /bin/busybox
	# and busybox will get confused since there are no applet named
	# kmk_ash.
	echo '#!/bin/sh' >"$srcdir"/sh
	echo 'exec /bin/busybox sh "$@"' >> "$srcdir"/sh
	chmod +x "$srcdir"/sh
	sed -i -e "s:/bin/sh:$srcdir/sh:" "$_builddir"/bootstrap.gmk
	kBuild/env.sh --full make -f bootstrap.gmk SRC_DIR=`pwd` ASH=/bin/bash
}

package() {
	cd "$_builddir"
	kBuild/env.sh kmk NIX_INSTALL_DIR=/usr PATH_INS="$pkgdir" install
}

sha512sums="74808e6279c01739170535655edbbffb73809f60b18c7ee63a110af7af651628789b9e5d253821f5685f8e8c072890c4669493e64886f53587b810ea0f67826c  kbuild-0.1.9998.3149-src.tar.xz
3ab991b13a122e82125392d01e27ad8c06f2b5f5e0c5bb2fa024fdcf16a65f5f460c14222d84d50b31a2ad4040c89871ee2a47f885eca329c15bb9abb3f8f5df  lchmod.patch
413efd3a18da8679e43c8c6547fa9dbea4d201a9f55e5808284f85f37786bd07014e18aee288c6077f4423c847bced19ae57d3f54f22806eefefbe9d3bab75ae  strlcpy.patch
839c12659ae81e99c0c2f35f045ef8651c2d30ddb391ae76995ded6df19f4ca5ae728da96c16b7aab08cdf447030de645455751122a390755e0ff46c03cb23d6  underlinking.patch
a2c765d16d8b6c4c24c68d1f2754c7b7fa99b83e5456994df54a2d3ac41104fc3ad307434a0b8d94114aa667b07d9b7478e160a75267414b3daa436ea05e208a  sys_siglist.patch
4bdcae4362ff0ac6b401c65120f54e395a41b98d4bdea796a1e85405c3444853b94626c2be6d9d703ffd904fb89ea0a14d1e847a67eb56d81faf48246220e166  0001-define-ALLPERMS-is-missing.patch
58ae3ec4a1535fddd4af67803c081c9ca4cd66244ea2a7ddfbf59eb5b849421377116376d893d5e643a15413b902463affa51153afeb2d2217bac135122b66a5  sys-types.patch
c686e9a87d78175dcc998da7aa14bd076d362143f2d7da1411d4f7b272264b9067c1a91fe1f2711a0055a0674e44d95547f1f3673b92581f295fcf1a06b38f34  uclibc.patch
7afcc78589ee66c60dd7a73819b4776531a4fc0f73c8a8824f4b53967f7c903095206455d2b113288ad4cf337e67c0dc82cd679b994096c5d9270f83d55689ad  kobjcache.patch
de69c669f4513f3cd17157c60b06e8598f62d80db6e186a9ad479eba4a5101f36f96b2250213c77a8ed8b31b955b9a93a0e587ab865cc72929c0eed12f379422  obstack.patch
60e6b979e50c3fc44ebeebbbbfe00e6fc3e659b2787215cf0589ed0ffadedc9aadb15b7819bdb0cc76aa0fb3f002e3e59f10e5e22254b4f8b87d2ff158e6fd6d  glob.patch"
