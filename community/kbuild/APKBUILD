# Contributor: Pedro Filipe <xpecex@outlook.com>
# Contributor: Natanael Copa <ncopa@alpinelinux.org>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=kbuild
pkgver=0.1.5
_ver=-p2
pkgrel=0
pkgdesc="A makefile framework for writing simple makefiles for complex tasks"
url="http://svn.netlabs.org/kbuild/wiki"
arch="x86 x86_64"
license="GPL-3.0"
makedepends="autoconf automake flex bison"
subpackages="$pkgname-doc"
source="​kBuild-$pkgver$_ver-all.tar.gz::ftp://ftp.netlabs.org/pub/kbuild/kBuild-$pkgver$_ver-all.tar.gz
	lchmod.patch
	strlcpy.patch
	underlinking.patch
	sys_siglist.patch
	kbuild-0.1.9998_pre20110817-gcc-4.7.patch
	0001-define-ALLPERMS-is-missing.patch
	sys-types.patch
	uclibc.patch
	kobjcache.patch
	obstack.patch
	glob.patch
	dprintf-output.patch"
options="!check" # testsuite is not working correctly
builddir="$srcdir"/kBuild-$pkgver$_ver

prepare() {
	local i
	cd "$builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
	cd "$builddir"/src/kmk
	aclocal -I config && autoheader && autoconf && automake --add-missing \
		|| return 1
	cd "$builddir"/src/sed
	aclocal -I config && autoheader && autoconf && automake --add-missing \
		|| return 1

	# the bootstrap process will create a symlink to the system shell,
	# which happens to be (/bin/sh) a symlink to /bin/busybox
	# and busybox will get confused since there are no applet named
	# kmk_ash.
	echo '#!/bin/sh' >"$srcdir"/sh
	echo 'exec /bin/busybox sh "$@"' >> "$srcdir"/sh
	chmod +x "$srcdir"/sh
	sed -i -e "s:/bin/sh:$srcdir/sh:" "$builddir"/bootstrap.gmk
}

build() {
	cd "$builddir"
	kBuild/env.sh --full make -f bootstrap.gmk AUTORECONF=true
}

package() {
	cd "$builddir"
	kBuild/env.sh kmk NIX_INSTALL_DIR=/usr PATH_INS="$pkgdir" install
}

sha512sums="a007c21184c7b985c289f8393e43e22878613b0747e20059a3286b94bbc61fa536ffc2655df2592cef9259e181d7562a743a2a6fe368eaee409b5179735b2494  ​kBuild-0.1.5-p2-all.tar.gz
3ab991b13a122e82125392d01e27ad8c06f2b5f5e0c5bb2fa024fdcf16a65f5f460c14222d84d50b31a2ad4040c89871ee2a47f885eca329c15bb9abb3f8f5df  lchmod.patch
fbab0dc51f4e2d14b020a6b63820a26eeee884ac9cfd5b59a6afc6243ffb7679c775ed8529f6161917bf3cc5e2a651c959706cdc404a4a79c1b29cc9f3a614a5  strlcpy.patch
839c12659ae81e99c0c2f35f045ef8651c2d30ddb391ae76995ded6df19f4ca5ae728da96c16b7aab08cdf447030de645455751122a390755e0ff46c03cb23d6  underlinking.patch
2e0cb32b6e296d92c4c092f798e83eee1fe49753826426fd957f9977149b64487547f71bde64b654a3f3a0511dfa9ac1c533ad0cd469c7bdd7e0acdfa3c2e3ac  sys_siglist.patch
7a0618e9dbd18ba10f1afd9c2a47f6efb136143a86008d2562eb2ff704f289b7150bbc10f2e3c57341b485252366ff46d49bd70c24cadba45f09496333ceaa76  kbuild-0.1.9998_pre20110817-gcc-4.7.patch
4bdcae4362ff0ac6b401c65120f54e395a41b98d4bdea796a1e85405c3444853b94626c2be6d9d703ffd904fb89ea0a14d1e847a67eb56d81faf48246220e166  0001-define-ALLPERMS-is-missing.patch
58ae3ec4a1535fddd4af67803c081c9ca4cd66244ea2a7ddfbf59eb5b849421377116376d893d5e643a15413b902463affa51153afeb2d2217bac135122b66a5  sys-types.patch
8fa6eb144afad9f648218700c159596d737cfa8c7512aacc2b693c9768e634aecd97bebcbb18964987b3f2ea0240e368a6f8d0e82b332929b60bc868f2979ef8  uclibc.patch
7afcc78589ee66c60dd7a73819b4776531a4fc0f73c8a8824f4b53967f7c903095206455d2b113288ad4cf337e67c0dc82cd679b994096c5d9270f83d55689ad  kobjcache.patch
bdbdfe24429fcc66d8df78974d5d4b32f552ec59d0b8c4c35c8e203c0fd65115be3a4a5b5e7995ba87a29d5432593f0cbe38b55d886819f2c7b75f6463ad0abe  obstack.patch
00a20b7fba74f289a38e1be7b3f7692d1a605c89b107fe8ad308962d3547d238fb15736fd85a3ec2bf53a2010018da18451c502f4b4996b8a6db87d368fce27d  glob.patch
1e4c70705bfb5bbc44ade66a8bbfc466be4d57af4079673ff113fdcb01a6a1e983c6d7d8fa3cac0ea2fed5137c619bed3fb43c91643730b7bc6ecd5abce07478  dprintf-output.patch"
