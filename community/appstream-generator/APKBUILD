# Contributor: Rasmus Thomsen <oss@cogitri.dev>
maintainer="Achill Gilgenast <achill@achill.org>"
pkgname=appstream-generator
pkgver=0.10.2
pkgrel=0
pkgdesc="fast AppStream metadata generator"
url="https://github.com/ximion/appstream-generator"
arch="x86_64 aarch64 loongarch64" # ldc
license="LGPL-3.0-or-later"
depends="optipng ffmpeg"
# coreutils: needs cp with --no-preserve-ownership
makedepends="
	appstream-dev
	cairo-dev
	catch2-3
	coreutils
	curl-dev
	fontconfig-dev
	freetype-dev
	gdk-pixbuf-dev
	gobject-introspection-dev
	inja-dev
	libarchive-dev
	libfyaml-dev
	librsvg-dev
	lmdb-dev
	meson
	npm
	onetbb-dev
	pango-dev
	yarn
	"
options="net" # js libs
subpackages="$pkgname-doc"
source="https://github.com/ximion/appstream-generator/archive/v$pkgver/appstream-generator-$pkgver.tar.gz"

export ASGEN_YARN_EXTRA_ARGS="--frozen-lockfile"

build() {
	abuild-meson . output
	meson compile -C output
}

check() {
	export ASGEN_TESTS_NO_NET=1
	case "$CARCH" in
	loongarch64)
		# asgen_tests times out with the standard timeout on the builder
		meson test --timeout-multiplier 10 --print-errorlogs -C output
		;;
	*)
		meson test --print-errorlogs -C output
		;;
	esac
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
}

sha512sums="
06e44c05c223111fdca71744d92e0a9e4b2594f11ffcd95b2c2d759686f2d5dc0a354819639f6e84c9bc70f80be98dbfe72695e49351aa35923171a4be414d48  appstream-generator-0.10.2.tar.gz
"
