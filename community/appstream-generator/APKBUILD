# Contributor: Rasmus Thomsen <oss@cogitri.dev>
maintainer="Achill Gilgenast <achill@achill.org>"
pkgname=appstream-generator
pkgver=0.10.1
pkgrel=1
pkgdesc="fast AppStream metadata generator"
url="https://github.com/ximion/appstream-generator"
arch="x86_64 aarch64 loongarch64" # ldc
license="LGPL-3.0-or-later"
depends="optipng ffmpeg"
# coreutils: needs cp with --no-preserve-ownership
makedepends="
	appstream-dev
	catch2-3
	cairo-dev
	coreutils
	curl-dev
	fontconfig-dev
	freetype-dev
	gdk-pixbuf-dev
	gobject-introspection-dev
	inja-dev
	libarchive-dev
	libfyaml-dev
	librsvg-dev
	lmdb-dev
	meson
	npm
	onetbb-dev
	pango-dev
	yarn
	"
options="net"
subpackages="$pkgname-doc"
source="https://github.com/ximion/appstream-generator/archive/v$pkgver/appstream-generator-$pkgver.tar.gz
	fix-tests-misc.patch
	"

export ASGEN_YARN_EXTRA_ARGS="--frozen-lockfile"

build() {
	abuild-meson . output
	meson compile -C output
}

check() {
	case "$CARCH" in
	loongarch64)
		# asgen_tests times out with the standard timeout on the builder
		meson test --timeout-multiplier 10 --print-errorlogs -C output
		;;
	*)
		meson test --print-errorlogs -C output
		;;
	esac
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
}

sha512sums="
ed36195981187dcb345d153378071c40edba49495ba56971aeee25e7482a0fa179f4ef36932c75a49b7327a12b25531c89049e803c0bffb1a6eaf4bc7b52e550  appstream-generator-0.10.1.tar.gz
9513f65ecf0ab341373b168f0c1db33dcff5a096874afa38877f673de42ff5257631c5e6452ef7e31643fe6678d74f9ae5a7ee435c4e30edb28247572d6f29c8  fix-tests-misc.patch
"
