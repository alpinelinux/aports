# Contributor: Grigory Kirillov <txgk@bk.ru>
# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=fast_float
pkgver=8.2.1
pkgrel=0
_tests=088643e8d5010bd3d1540fe48685601b43b9a3e5
pkgdesc="Fast implementation of the C++ from_chars functions for float and double types"
url="https://github.com/fastfloat/fast_float"
arch="noarch"
license="Apache-2.0 OR MIT"
makedepends="cmake samurai"
checkdepends="doctest-dev"
source="https://github.com/fastfloat/fast_float/archive/v$pkgver/fast_float-$pkgver.tar.gz
	https://github.com/fastfloat/supplemental_test_files/archive/$_tests/fast_float-tests-$_tests.tar.gz
	"

prepare() {
	default_prepare

	mkdir -p builddir/_deps
	mv "$srcdir"/supplemental_test_files-$_tests \
		builddir/_deps/supplemental_test_files-src
}

build() {
	cmake -B builddir -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_DATAROOTDIR=/usr/lib \
		-DCMAKE_BUILD_TYPE=Release \
		-DFASTFLOAT_TEST="$(want_check && echo ON || echo OFF)" \
		-DSYSTEM_DOCTEST=ON \
		-DFETCHCONTENT_FULLY_DISCONNECTED=ON
	cmake --build builddir
}

check() {
	case "$CARCH" in
	s390x)
		# could not convert to unsigned char for input: "10 "
		ctest --test-dir builddir -E fast_int
		;;
	*)
		ctest --test-dir builddir
		;;
	esac
}

package() {
	DESTDIR="$pkgdir" cmake --install builddir
}

sha512sums="
5c945facb30d7bfdf1d4f9fae4c53ae66e7f81e12fa0279ebcbc660e02cc093b28a3d1a2fe36b152bbf166c475dfbea57f30c313b00795974af9cb828ba41e4b  fast_float-8.2.1.tar.gz
34d7c01cb036f5317507fac72f5c7d41f11aacc3d87c102068fbc849e77637a1955c2313a02347dfebc60b85cf831a3274af5639919d7683bd8e19ef5c66a86c  fast_float-tests-088643e8d5010bd3d1540fe48685601b43b9a3e5.tar.gz
"
