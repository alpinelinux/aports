# Contributor: Leo <thinkabit.ukim@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=libsoup
pkgver=2.66.1
pkgrel=0
pkgdesc="Gnome HTTP Library"
url="http://live.gnome.org/LibSoup"
arch="all"
options="!check"  # Requires a running Apache HTTPd.  not kidding...
license="LGPL-2.0-or-later"
subpackages="$pkgname-gnome:_gnome $pkgname-gnome-dev:_gnome_dev $pkgname-dev
	$pkgname-doc $pkgname-lang"
depends="glib-networking"
makedepends="meson libgpg-error-dev zlib-dev intltool vala gtk-doc libxml2-dev
	gobject-introspection-dev libpsl-dev sqlite-dev"
source="https://download.gnome.org/sources/$pkgname/${pkgver%.*}/$pkgname-$pkgver.tar.xz"

# secfixes:
#   2.58.2-r0:
#     - CVE-2017-2885

build() {
	meson \
		--prefix=/usr \
		-Dgssapi=false \
		-Dintrospection=true \
		-Dvapi=true \
		-Dtls_check=false \
		-Ddoc=true \
		-Dtests=false \
		build
	ninja -C build
}

package() {
	DESTDIR="$pkgdir" ninja -C build install
}

_gnome() {
	pkgdesc="$pkgdesc (GNOME libraries)"
	mkdir -p "$subpkgdir"/usr/lib/girepository-1.0
	mv "$pkgdir"/usr/lib/libsoup-gnome*.so.* "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/girepository-1.0/SoupGNOME* "$subpkgdir"/usr/lib/girepository-1.0
}

_gnome_dev() {
	pkgdesc="$pkgdesc (GNOME development files)"
	mkdir -p "$subpkgdir"/usr/include \
			 "$subpkgdir"/usr/lib/pkgconfig \
			 "$subpkgdir"/usr/share/gir-1.0 \

	mv "$pkgdir"/usr/include/libsoup-gnome* "$subpkgdir"/usr/include
	mv "$pkgdir"/usr/lib/pkgconfig/*gnome* "$subpkgdir"/usr/lib/pkgconfig
	mv "$pkgdir"/usr/share/gir-1.0/SoupGNOME* "$subpkgdir"/usr/share/gir-1.0
	mv "$pkgdir"/usr/lib/libsoup-gnome*.so "$subpkgdir"/usr/lib
}

sha512sums="bb9c15cae965606d5f7c009fab9223445235982269d23ff20e89249b10d3423797427e7cff39c31a3f5db99b0c2d7a01eb911edb61309603cdeb8f2467fe6039  libsoup-2.66.1.tar.xz"
