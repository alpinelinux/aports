# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=ghc-release
pkgver=9.14.1
pkgrel=0
_bootstrapver=9.12.2
_llvmver=18
_pkgver=$pkgver
# for building release candidates
#_pkgbase=${pkgver%%_*}
#_pkgminor=${_pkgbase##*.}
#_pkgver="${_pkgbase%.*}.$((_pkgminor - 1)).$_pkgdate"
pkgdesc="Latest release of the Glasgow Haskell Compiler"
_urlprefix=${pkgver/_/-}
url="https://haskell.org/ghc"
arch="aarch64 loongarch64 ppc64le riscv64 x86_64"
license="BSD-3-Clause"
depends="
	cmd:cc
	gmp-dev
	libffi-dev
	llvm$_llvmver
	"
case "$CARCH" in
loongarch64)
	makedepends_build="ghc-loongarch-bootstrap~$_bootstrapver"
	_bindist_bootstrap=false
	_ghcbin="/usr/bin/ghc"
	;;
*)
	_bindist_bootstrap=true
	_bindist_dir="$tmpdir/ghcbin-$_bootstrapver"
	export PATH="$_bindist_dir/bin:$PATH"
	_ghcbin="$_bindist_dir/bin/ghc"
	;;
esac
makedepends_build="
	$makedepends_build
	autoconf
	automake
	clang$_llvmver
	coreutils
	grep
	libffi-dev
	llvm$_llvmver
	ncurses-dev
	python3
	xz
	"
makedepends_host="
	gmp-dev
	libffi-dev
	linux-headers
	musl-dev
	ncurses-dev
	zlib-dev
	"
provides="ghc-bootstrap=$pkgver-r$pkgrel"
provider_priority=3 # lowest
install="$pkgname-cmds.post-install"
subpackages="
	$pkgname-cmds::noarch
	$pkgname-doc
	$pkgname-fllvm::noarch
	"
source="https://downloads.haskell.org/ghc/$_urlprefix/ghc-$_pkgver-src.tar.xz
	hadrian-bootstrap-of-$pkgver-with-$_bootstrapver.tar.gz::https://downloads.haskell.org/ghc/$_urlprefix/hadrian-bootstrap-sources/hadrian-bootstrap-sources-$_bootstrapver.tar.gz
	https://downloads.haskell.org/ghc/$_bootstrapver/ghc-$_bootstrapver-aarch64-alpine3_18-linux.tar.xz
	https://downloads.haskell.org/ghc/$_bootstrapver/ghc-$_bootstrapver-x86_64-alpine3_20-linux.tar.xz
	https://dev.alpinelinux.org/archive/ghc-ppc64le/ghc-$_bootstrapver-powerpc64le-alpine-linux-musl.tar.xz
	https://dev.alpinelinux.org/archive/ghc-riscv64/ghc-$_bootstrapver-riscv64-alpine-linux-musl.tar.xz
	fix-hadrian-bootstrap-riCabalHash.patch
	parallel-hadrian-bootstrap.patch
	"
builddir="$srcdir/ghc-$_pkgver"
options="!check !strip $pkgname-cmds::!tracedeps"

if [ -f "$HADRIAN" -a -x "$HADRIAN" ]; then
	# Allow using a Hadrian binary passed in through the environment
	# useful for restarting build without having to rebuild Hadrian.
	_hadrian="$HADRIAN"
else
	_hadrian="$builddir/hadrian/bootstrap/_build/bin/hadrian"
fi
_hadrian_args="-j${JOBS:-1} --docs=none"

if [ "$CBUILD" != "$CTARGET" ]; then
	_hadrian_args="$_hadrian_args --flavour=quickest"
else
	_hadrian_args="$_hadrian_args --flavour=perf+no_profiled_libs+omit_pragmas+hash_unit_ids"
fi

_configure() {
	# clang instead of llvm-as: https://gitlab.haskell.org/ghc/ghc/-/issues/24630
	./configure \
		--disable-ld-override \
		--enable-ignore-build-platform-mismatch \
		ac_cv_prog_CC="$CC" ac_cv_path_ac_pt_CXX="$CXX" \
		CC="$CC" CXX="$CXX" LD="$LD" \
		CLANG=/usr/lib/llvm$_llvmver/bin/clang \
		LLVMAS=/usr/lib/llvm$_llvmver/bin/clang \
		LLC=/usr/lib/llvm$_llvmver/bin/llc \
		OPT=/usr/lib/llvm$_llvmver/bin/opt \
		"$@"
}

_subst_alpine_targets() {
	# Switch llvm-targets from unknown-linux-gnueabihf->alpine-linux
	# so we can match the llvm vendor string alpine uses
	sed -i \
		-e 's/i386-unknown-linux/i586-alpine-linux/g' \
		-e 's/unknown-linux-musl/alpine-linux-musl/g' \
		-e 's/unknown-linux-gnueabihf/alpine-linux/g' \
		-e 's/unknown-linux-gnueabi/alpine-linux/g' \
		-e 's/unknown-linux-gnu/alpine-linux/g' \
		-e 's/riscv64-unknown-linux/riscv64-alpine-linux-musl/g' \
		-e 's/loongarch64-unknown-linux/loongarch64-alpine-linux-musl/g' \
		"$builddir"/llvm-targets
}

prepare() {
	local vendor
	case "$CBUILD_ARCH" in
	aarch64|x86_64)
		# upstream bindists
		vendor="unknown-linux"
		;;
	loongarch64|ppc64le|riscv64)
		vendor="alpine-linux-musl"
		;;
	esac

	if $_bindist_bootstrap; then
		mkdir -p "$_bindist_dir"
		cd "$srcdir/ghc-$_bootstrapver-${CBUILD%%-*}-$vendor"
		_configure --prefix="$_bindist_dir"
		make install
	fi

	default_prepare
	_subst_alpine_targets
}

build() {
	# Build the hadrian build system.
	#
	# See:
	#   * https://gitlab.haskell.org/ghc/ghc/-/tree/master/hadrian/bootstrap
	#   * https://www.haskell.org/ghc/blog/20220805-make-to-hadrian.html
	cd "$builddir"/hadrian/bootstrap/
	if [ ! -x "$_hadrian" ]; then
		python3 ./bootstrap.py \
			-j ${JOBS:-1} \
			-w "$_ghcbin" \
			--no-archive \
			-s "$srcdir"/hadrian-bootstrap-of-$pkgver-with-$_bootstrapver.tar.gz
	fi

	# NOTE: ghc build system requires host == build, and it ends up
	# compiling the cross-compiler (stage1) and cross-compiling with
	# that the native compiler (stage2)
	cd "$builddir"
	_configure \
		--build=$CBUILD \
		--host=$CBUILD \
		--target=$CTARGET \
		--prefix=/usr \
		--with-system-libffi

	"$_hadrian" $_hadrian_args binary-dist-dir
}

package() {
	local ghclib="$pkgdir/usr/lib/ghc-$_pkgver/lib"
	local newpath path target

	# Hadrian's install command doesn't support DESTDIR.
	# Hence, we need to install via the bindist.
	cd "$builddir"/_build/bindist/ghc-*
	# Need to re-run configure.
	# See: https://gitlab.haskell.org/ghc/ghc/-/issues/22058
	_configure --prefix=/usr

	make DESTDIR="$pkgdir" RECACHE_PACKAGE_DB=NO install

	install -Dvm644 "$builddir"/LICENSE \
		-t "$pkgdir"/usr/share/licenses/ghc/

	cd "$pkgdir"

	# This dir is empty when HTML docs aren't built.
	rmdir -v usr/share/doc/ghc-$_pkgver

	# Fixup install tree if needed.
	if [ -d usr/lib/$CTARGET-ghc-$_pkgver ]; then
		# different location
		ghclib="$pkgdir/usr/lib/$CTARGET-ghc-$_pkgver/lib"

		# Rename binaries and fix links.
		for path in usr/bin/"$CTARGET"-*; do
			newpath="${path//$CTARGET-/}"

			if [ -h "$path" ]; then
				target="$(readlink $path)"
				ln -vsf "${target//$CTARGET-/}" "$newpath"
				rm -v "$path"
			else
				mv -v "$path" "$newpath"
			fi
		done
	fi

	# Remove triplet prefix from settings -- the intention is
	# that the native compiler will use native gcc/ld on the target.
	sed -i "s|$CTARGET-||g" "$ghclib"/settings

	# Can't do a full strip on archives.
	find . -type f \( -name "*.so" -o -name "*.a" \) \
		-exec ${CROSS_COMPILE}strip --strip-unneeded {} \;
	find "$ghclib"/../bin -type f \
		-exec ${CROSS_COMPILE}strip {} \;
}

cmds() {
	pkgdesc="$pkgdesc (commands)"
	provides="$pkgname-bootstrap=$pkgver-r$pkgrel"
	depends="$pkgname=$pkgver-r$pkgrel"
	install_if="$pkgname=$pkgver-r$pkgrel"

	amove usr/bin
}

fllvm() {
	pkgdesc="$pkgdesc (dummy package depending on Clang version used during build)"
	depends="$pkgname=$pkgver-r$pkgrel clang$_llvmver"

	mkdir -p "$subpkgdir"
}

sha512sums="
81264e8bd0ef6bb51c7c4ac8b2525deb0819f2ae9cc47d69c00b521a6954c5a087b644e7fd334535f9d85289fef50315cd63501163c18d93c26c0a8ba84e10ea  ghc-9.14.1-src.tar.xz
4931318a10d2e202472aa32e23e43cf21e9ffbbf1b3f3c7616ba24ddf5504e7b4f63bc1ef7dcfd41551f1ff66e513b6648ce2dc86a445d4813404a16cee31621  hadrian-bootstrap-of-9.14.1-with-9.12.2.tar.gz
c071dadf61ea082a40bb384af9c676a4474c798356693b5190d50d78c84f7d3c30e7fc9fe3663f9f2e3d8bbb0a9dd4e5de9d4442e5a63f7eeda975b3cf01eda1  ghc-9.12.2-aarch64-alpine3_18-linux.tar.xz
3b9710734e7e624d1a1de49dca0008c7d8ed8eba0572ce953b352354bb865fe580e6ef276c8028d133693163aa85e4af2a699a1084b0fb73a46c17a92117aa16  ghc-9.12.2-x86_64-alpine3_20-linux.tar.xz
6ef7acd0b10e03785b14ee7b3f6c3cdaffba448ae327959a1b1e05c01da072a8797b5fbbc6eb215133037a2138f480e60f3bcc5c2efa0aa9483242c8661b8806  ghc-9.12.2-powerpc64le-alpine-linux-musl.tar.xz
7842f379c5725d23cc2cbbbbcd5a8be86a4348fd03ad72986cc05dd2f9d843387acc7f9aef40683324aea3dbace672b20fa3d3a43392164fa57db27c9e5df8d9  ghc-9.12.2-riscv64-alpine-linux-musl.tar.xz
7ae3095fb91a739b2285be682f82014953e17a10aef3d969d44ea54f80e3fc5dae080e55619b0bf69b482416477ebebe8fe5c0b1914b36b6de02cbdde6129794  fix-hadrian-bootstrap-riCabalHash.patch
0e59d1c39e1e51ed697edc3aa87f219212a0e19312f5cdfd30b8d219b1bf8e64b36495acf7bc75920dadab8eee04ca66e022e61842152668b0daf4d597010b58  parallel-hadrian-bootstrap.patch
"
