# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=java-postgresql-jdbc
_pkgname=postgresql-jdbc
pkgver=42.7.9
pkgrel=0
pkgdesc="Java JDBC 4.2 (JRE 8+) driver for PostgreSQL database"
url="https://jdbc.postgresql.org/"
# riscv64: RISCV_FLUSH_ICACHE not available
# aarch64: jdk segfaults building it
arch="noarch !aarch64 !riscv64"
license="BSD-3-Clause"
makedepends="java-jdk gradle"
source="$pkgname-$pkgver.tar.gz::https://github.com/pgjdbc/pgjdbc/archive/REL$pkgver.tar.gz
	increase-max-memory.patch
	"
options="!check net" # tests require running postgres server
builddir="$srcdir/pgjdbc-REL$pkgver"

# secfixes:
#   42.7.9-r0:
#     - CVE-2025-49146
#   42.6.2-r0:
#     - CVE-2024-1597
#   42.5.1-r0:
#     - CVE-2022-41946
#   42.4.2-r0:
#     - CVE-2022-31197
#   42.2.25-r0:
#     - CVE-2022-21724
#     - CVE-2020-13692

build() {
	# Note: Gradle downloads quite many dependencies, but
	# these are used only for building, not bundled to the final JAR.
	export JAVA_HOME="/usr/lib/jvm/default-jvm"
	gradle --no-daemon -p pgjdbc jar
}

check() {
	gradle --no-daemon -p pgjdbc test
}

package() {
	install -Dm644 ./pgjdbc/build/libs/postgresql-$pkgver-SNAPSHOT.jar \
		"$pkgdir"/usr/share/java/$_pkgname-$pkgver.jar
	ln -s $_pkgname-$pkgver.jar "$pkgdir"/usr/share/java/$_pkgname.jar
}

sha512sums="
d9b1f7d9161cf5e8a5e6a8f23188ecb2ee052699ad31ed07e7fab2700fd3f7553f6fc01c285746cf8c7eafb1ed212270333fc966c9fc0a853b34d2866247682c  java-postgresql-jdbc-42.7.9.tar.gz
5f761b43c5350e178e1f49e03625f01c61200033c220b93dded04069e96160d03bb7ca9ace9d733c7d14a9569d853772cc9df97e284da8e3daed4fcaf8313c8b  increase-max-memory.patch
"
