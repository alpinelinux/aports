# Contributor: Bart Ribbers <bribbers@disroot.org>
# Contributor: knuxify <knuxify@gmail.com>
# Maintainer: Sertonix <sertonix@posteo.net>
pkgname=prismlauncher
pkgver=10.0.5
pkgrel=1
_libnbtplusplus_commit=531449ba1c930c98e0bcf5d332b237a8566f9d78
pkgdesc="A custom launcher for Minecraft that allows you to easily manage multiple installations of Minecraft at once"
url="https://prismlauncher.org/"
# riscv64: blocked by openjdk
arch="all !riscv64"
license="GPL-3.0-only AND Apache-2.0"
depends="
	java-jre
	qt6-qtimageformats
	qt6-qtsvg
	"
makedepends="
	cmake
	cmark-dev
	extra-cmake-modules
	gamemode-dev
	libarchive-dev
	libqrencode-dev
	qt6-qtbase-dev
	qt6-qtimageformats-dev
	qt6-qtnetworkauth-dev
	openjdk8
	samurai
	scdoc
	tomlplusplus-dev
	zlib-dev
	"
case "$CARCH" in
armv7|armhf) makedepends="$makedepends clang" ;; # fails to build with gcc, see note in build()
esac
install="$pkgname.post-upgrade"
source="$pkgname-$pkgver.tar.gz::https://github.com/PrismLauncher/PrismLauncher/archive/refs/tags/$pkgver.tar.gz
	libnbtplusplus-$_libnbtplusplus_commit.tar.gz::https://github.com/PrismLauncher/libnbtplusplus/archive/$_libnbtplusplus_commit.tar.gz
	0001-system-jemalloc.patch
	0002-native-openal-lwjgl-2.patch
	0003-use-system.patch

	README.alpine
	"
subpackages="$pkgname-doc"
builddir="$srcdir/PrismLauncher-$pkgver"

prepare() {
	rmdir libraries/libnbtplusplus
	ln -s "$srcdir"/libnbtplusplus-$_libnbtplusplus_commit libraries/libnbtplusplus

	default_prepare
}

build() {
	case "$CARCH" in
	armv7|armhf)
		# building with gcc fails, see https://github.com/PrismLauncher/PrismLauncher/issues/128
		export CC=clang
		export CXX=clang++
		;;
	esac

	JAVA_HOME=/usr/lib/jvm/java-1.8-openjdk \
	cmake -B build \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DLauncher_BUILD_PLATFORM=alpinelinux \
		-DLauncher_ENABLE_JAVA_DOWNLOADER_DEFAULT=OFF
	cmake --build build
}

check() {
	ctest --test-dir build
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	install -Dm644 "$srcdir"/README.alpine -t "$pkgdir"/usr/share/doc/$pkgname
}

sha512sums="
70333c7b27dc2676b0ab91e3fe19fee7e67b5f45da66bdabf6631fa0506c2d1edf06ec7978e7565e6498714a785daacafd89ac18487447242ea41ba08dcc0499  prismlauncher-10.0.5.tar.gz
5e6e464aaa11e30d9fbb694bd63d2af2dba799806dc88d17ac34b211a4c532b23ed5e8a87632835ca065ad21a9aa497e271f17fe8dc0522f24d13533ecc03de9  libnbtplusplus-531449ba1c930c98e0bcf5d332b237a8566f9d78.tar.gz
22171682336dd2980137e164c31f513f2a3a33d2ee05fb779709e3e06d62b312123dc3c3944cf08624bd605ea3107ce35c7b67467d13e52016ad53b308cb7287  0001-system-jemalloc.patch
5ac5916fb2a2744810a1672f594eb5df40f179a77ea23f6cb5add51a8c49ff76769b7659320934ace42f2b0a45210569ac12660439c8a750087a89b5a7aa0d83  0002-native-openal-lwjgl-2.patch
87e72332a74476cb4b0f4761c76725a3c8ff60723dc58073387d38040a9b5d5317da70a9cebff1cdad5efd6cdeddc9719882d526f32af4efaef3f9251019de01  0003-use-system.patch
5a5f2026062b23b398c79762925b39bccfc71b94ed570a58711b5c58edf51344ee6c46fc416ab2e60424405f42c5ed973c4c7dd69b9893417c6437fec43bc5c6  README.alpine
"
