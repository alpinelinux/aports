# Contributor: solidnerd <niclas@mietz.io>
# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=glab
pkgver=1.78.3
pkgrel=0
pkgdesc="Open source GitLab CLI tool written in Go"
url="https://gitlab.com/gitlab-org/cli"
arch="all"
license="MIT"
depends="git"
makedepends="go"
options="!check"
subpackages="
	$pkgname-doc
	$pkgname-bash-completion
	$pkgname-zsh-completion
	$pkgname-fish-completion
	"
source="$pkgname-$pkgver.tar.gz::https://gitlab.com/gitlab-org/cli/-/archive/v$pkgver/cli-v$pkgver.tar.gz
	no-telemetry.patch
	unbump_go.patch
	"
builddir="$srcdir/cli-v$pkgver"

export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

build() {
	# date seems a little broken to override
	go build -ldflags "
		-X main.debugMode=false
		-X main.version=v$pkgver
		-X main.buildDate=$(date -u "+%Y-%m-%d" ${SOURCE_DATE_EPOCH:+-d @$SOURCE_DATE_EPOCH})
		-extldflags \"$LDFLAGS\"
		" \
		-o build/bin/glab \
		./cmd/glab/main.go

	go run ./cmd/gen-docs/docs.go --manpage --path ./build/man

	# XXX: When glab is run in fakeroot it segfaults for some reason
	# on ppc64le. By generating the compilation files here we
	# workaround that but we need to investigate why it segfaults in
	# fakeroot eventually.
	mkdir -p build/shell
	build/bin/glab completion --shell bash > build/shell/bash.comp
	build/bin/glab completion --shell zsh > build/shell/zsh.comp
	build/bin/glab completion --shell fish > build/shell/fish.comp
}

package() {
	install -Dm755 build/bin/glab -t "$pkgdir"/usr/bin/

	install -Dm644 build/man/*.1 -t "$pkgdir"/usr/share/man/man1/

	install -Dm644 build/shell/bash.comp \
		"$pkgdir"/usr/share/bash-completion/completions/glab.bash
	install -Dm644 build/shell/zsh.comp \
		"$pkgdir"/usr/share/zsh/site-functions/_glab
	install -Dm644 build/shell/fish.comp \
		"$pkgdir"/usr/share/fish/vendor_completions.d/glab.fish
}

sha512sums="
1099078ebeb14af95fdd8c076e1395e44b06920b3378eff1da98a0bb5540ded8d983f5873c8684518ad898c9c00b62e9d52999fbb84a41e2024ecad228f805a2  glab-1.78.3.tar.gz
e718c7f3734d95bcefde2475ee708dc4821c03e5b9b25da7f93c959aabe2ce88f4efa4f3a1e800eabde1fcff027f5f399a89cbade3d820cd1b27bae38d9f237c  no-telemetry.patch
2777b8ac42feb42707279f008dc99c1cd36cdd9aaf9f318bc1447a0ce1e9c8f6ea613cf1ed3ac30ff6c1e9bff077de1055c1277f35f21332a34e3cac129056b8  unbump_go.patch
"
