# Contributor: Carlo Landmeter <clandmeter@alpinelinux.org>
# Maintainer: Kevin Daudt <kdaudt@alpinelinux.org>
pkgname=mlt
pkgver=7.36.1
pkgrel=0
pkgdesc="MLT Multimedia Framework"
url="https://www.mltframework.org/"
arch="all"
license="GPL-2.0-or-later AND LGPL-2.1-or-later AND GPL-3.0-or-later"
makedepends="
	cmake
	ffmpeg-dev
	fftw-dev
	frei0r-plugins-dev
	gdk-pixbuf-dev
	jack-dev
	ladspa-dev
	libarchive-dev
	libexif-dev
	libsamplerate-dev
	libvorbis-dev
	libxml2-dev
	python3-dev
	qt6-qt5compat-dev
	qt6-qtbase-dev
	qt6-qtsvg-dev
	samurai
	sdl2-dev
	sox-dev
	swig
	vidstab-dev
	"
subpackages="$pkgname-dev $pkgname-doc py3-$pkgname:py3 $pkgname-qt6"
source="https://github.com/mltframework/mlt/releases/download/v$pkgver/mlt-$pkgver.tar.gz
	musl.patch
	melt-include-misisng-system-headers.patch
	"

case $CARCH in
s390x)
	_opencv=OFF
	;;
*)
	makedepends="$makedepends opencv-dev"
	_opencv=ON
	;;
esac

build() {
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=RelWithDebInfo \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_SKIP_INSTALL_RPATH=ON \
		-DBUILD_TESTING="$(want_check && echo YES || echo NO)" \
		-DBUILD_TESTS_WITH_QT6=ON \
		-DMOD_OPENCV=$_opencv \
		-DMOD_MOVIT=OFF \
		-DMOD_PLUS=OFF \
		-DMOD_RTAUDIO=OFF \
		-DMOD_RUBBERBAND=OFF \
		-DMOD_QT=OFF \
		-DMOD_QT6=ON \
		-DMOD_GLAXNIMATE_QT6=ON \
		-DSWIG_PYTHON=ON \
		-DKwalify_EXECUTABLE=/bin/true
	cmake --build build
}

check() (
	cd build
	. ../setenv
	ctest -E 'QtTest:properties'
)

package() {
	DESTDIR="$pkgdir" cmake --install build
}

py3() {
	pkgdesc="$pkgdesc (Python bindings)"

	amove usr/lib/python*
}

qt6() {
	amove usr/lib/mlt-7/libmltqt6.so
	amove usr/lib/mlt-7/libmltglaxnimate-qt6.so
}

sha512sums="
dbd25aca3d462e7db8f0673a04a16bed693e73f2c33ead11446933374a5b6f802803e55d7d16f522a97acaf457654bd6fc7710c5436f6c1ebc98568e9b816b35  mlt-7.36.1.tar.gz
18e8d87b8eda186c60002c31993aa615bebefe40037c76891812f6ff3201b0b8704d928da9f84d3bbda231149d1827448eebf81c5a7081d1afd05505547e479d  musl.patch
cdf229c8ed145ac054e1491214300175f5e86d280d2493402be7993c82da8db883fc71f2b3dabdaa710d94c13a8532dbcd97c3347a2b43ca75d61153a23e3f22  melt-include-misisng-system-headers.patch
"
