# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=austral
pkgver=0.2.0
pkgrel=0
pkgdesc="Systems language with linear types and capability-based security"
url="https://github.com/austral/austral"
# armhf, armv7, x86: some tests fail
# riscv64, loongarch64: ocaml 4 unavailable
arch="all !riscv64 !loongarch64 !armhf !armv7 !x86"
license="Apache-2.0 WITH LLVM-exception"
depends="cmd:cc"
makedepends="
	dune
	ocaml-menhir
	ocaml-ounit-dev
	ocaml-ppxlib-dev
	ocaml-ppx_deriving-dev
	ocaml-ppx_sexp_conv-dev
	ocaml-sexplib-dev
	ocaml-yojson-dev
	ocaml-zarith
	python3
	"
checkdepends="bash"
subpackages="
	$pkgname-doc
	$pkgname-emacs::noarch
	$pkgname-vim::noarch
	"
source="https://github.com/austral/austral/archive/refs/tags/v$pkgver/austral-$pkgver.tar.gz
	compiler-flags.patch
	"

build() {
	make
}

check() {
	./run-tests.sh
}

package() {
	install -Dvm755 austral -t "$pkgdir"/usr/bin/

	mkdir -p "$pkgdir"/usr/share/austral/standard
	cp -R examples "$pkgdir"/usr/share/austral/
	cp -R standard/src "$pkgdir"/usr/share/austral/standard/

	mkdir -p "$pkgdir"/usr/share/vim/vimfiles
	cp -R editor/austral.vim/*/ "$pkgdir"/usr/share/vim/vimfiles/
	install -Dvm644 editor/*.el -t "$pkgdir"/usr/share/emacs/site-lisp/
}

doc() {
	default_doc

	amove usr/share/austral/examples
}

emacs() {
	pkgdesc="Emacs mode for $pkgname"
	depends=
	install_if="$pkgname=$pkgver-r$pkgrel emacs"

	amove usr/share/emacs/site-lisp
}

vim() {
	pkgdesc="Vim filetype and syntax for $pkgname"
	depends=
	install_if="$pkgname=$pkgver-r$pkgrel vim"

	amove usr/share/vim/vimfiles
}

sha512sums="
9f06744e0822a3897c7f9094bba2d64f7ce8e54ec13aa9eff939ee2d74b6bab281becf3ded8289882a0eefe9c2ddbab855434aeb44c1baa89a528582af1ca527  austral-0.2.0.tar.gz
756298e51e8025348997f82f8e40b6901e2189265f9e3d9821cd686b874f87ddcb8e82d5033fcb5e57aa6b1fab3f8397ed8f6a6f18e954d367330db30a744803  compiler-flags.patch
"
