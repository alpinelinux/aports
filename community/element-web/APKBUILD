# Contributor: Carlo Landmeter <clandmeter@alpinelinux.org>
# Contributor: Galen Abell <galen@galenabell.com>
maintainer="lauren n. liberda <lauren@selfisekai.rocks>"
pkgname=element-web
pkgver=1.12.7
pkgrel=0
pkgdesc="A glossy Matrix collaboration client for the web"
url="https://element.io/"
#riscv64: ftbfs: memory access out of bounds
#x86, armhf, armv7: webpack: JavaScript heap out of memory
#s390x: rollup
arch="noarch !riscv64 !x86 !armv7 !armhf !s390x"
options="!check"
license="GPL-3.0-only"
makedepends="
	nodejs
	yarn
"
source="
	https://github.com/vector-im/element-web/archive/refs/tags/v$pkgver/element-web-$pkgver.tar.gz
	no-source-maps.patch
	rollup-wasm.patch
	"
install="$pkgname.post-upgrade"
provides="riot-web=$pkgver-r$pkgrel"
replaces="riot-web"

export VERSION=$pkgver

# secfixes:
#   1.11.30-r0:
#     - CVE-2023-30609
#   1.11.26-r0:
#     - CVE-2023-28103
#     - CVE-2023-28427
#   1.11.7-r0:
#     - CVE-2022-39249
#     - CVE-2022-39250
#     - CVE-2022-39251
#     - CVE-2022-39236
#   1.11.4-r0:
#     - CVE-2022-36059
#     - CVE-2022-36060
#   1.9.7-r0:
#     - CVE-2021-44538
#   1.8.4-r0:
#     - CVE-2021-40823
#     - CVE-2021-40824

prepare() {
	default_prepare

	yarn install --frozen-lockfile --ignore-scripts
	# install script
	(
		cd packages/shared-components
		yarn install --frozen-lockfile --ignore-scripts
	)
	# postinstall
	yarn run patch-package
}

build() {
	(
		cd packages/shared-components
		yarn run patch-package
	)
	NODE_ENV=production yarn build:res
	(
		cd packages/shared-components
		NODE_ENV=production node scripts/gatherTranslationKeys.ts
		NODE_ENV=production yarn run vite build
	)
	NODE_ENV=production yarn build
}

package() {
	mkdir -p "$pkgdir"/usr/share/webapps \
		"$pkgdir"/etc/element-web
	cp -r webapp "$pkgdir"/usr/share/webapps/element-web
	ln -s ../element-web "$pkgdir"/usr/share/webapps/riot-web
	mv config.sample.json \
		"$pkgdir"/etc/element-web
	ln -sf /etc/element-web/config.json \
		"$pkgdir"/usr/share/webapps/element-web/config.json
}

sha512sums="
2433af8b01f7b3ea6152a0778e7e1502f7fc2c678dcaad0af8147aa34235b3a9453617b611e2fd8bece511600518a8b512823dd79cf7f8b8d8284b649ba52fb1  element-web-1.12.7.tar.gz
ec635fde026f7fce8e8cc57960b5b9dcec4418416d4867ed47711422d48f068bb58a3c9ceb7715efc9c177beca3788da6b0babc9b689ea8c0724a0395f2b85f8  no-source-maps.patch
b1d2ae29325d945435ad7477b0f351d99503e5e2119e67674dfb69a51afb7297f707ce7f1b4404f31d84d9e9617ab08656c5d9692ed8412d6eef44e6ffb2c3b2  rollup-wasm.patch
"
