# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=lld
pkgver=6.0.1
pkgrel=1
_llvmver=${pkgver%%.*}
pkgdesc="The LLVM Linker"
url="http://llvm.org"
arch="all"
license="UOI-NCSA"
makedepends="
	cmake
	libedit-dev
	llvm-dev>=$_llvmver
	llvm-static>=$_llvmver
	llvm-test-utils>=$_llvmver
	zlib-dev"
checkdepends="gtest gtest-dev"
subpackages="$pkgname-dev $pkgname-libs"
source="https://llvm.org/releases/$pkgver/$pkgname-$pkgver.src.tar.xz"
builddir="$srcdir/$pkgname-$pkgver.src"

build() {
	mkdir -p "$builddir"/build
	cd "$builddir"/build

	cmake .. \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_VERBOSE_MAKEFILE=OFF \
		-DCMAKE_C_FLAGS_MINSIZEREL_INIT="$CFLAGS" \
		-DCMAKE_CXX_FLAGS_MINSIZEREL_INIT="$CXXFLAGS" \
		-DCMAKE_EXE_LINKER_FLAGS_MINSIZEREL_INIT="$LDFLAGS" \
		-DCMAKE_INSTALL_PREFIX=/usr \
		\
		-DCMAKE_SKIP_INSTALL_RPATH=ON \
		-DLLVM_INCLUDE_TESTS=ON \
		-DLLVM_EXTERNAL_LIT=/usr/bin/lit \
		-DLLVM_LINK_LLVM_DYLIB=ON \
		-DBUILD_SHARED_LIBS=ON \

	make
}

check() {
	cd "$builddir/build"
	# enable if tests on armhf are still failing
#	[ "$CARCH" = "armhf" ] && return 0
	make check-lld
}

package() {
	cd "$builddir"/build

	make install DESTDIR="$pkgdir"
}

sha512sums="856ccc125255ab6184919f1424372f0f8a5de8477777047e2ab1a131a2ecec0caa9b5163d01409c7c510df9c794f0bc8d65cc904df2baf6462ef53bc163e002a  lld-6.0.1.src.tar.xz"
