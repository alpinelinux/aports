maintainer="Bart Ribbers <bribbers@disroot.org>"
pkgname=mce
pkgver=1.116.4
pkgrel=0
_commit_dbus_gmain="d42176ae4763e5288ef37ea314fe58387faf2005"
pkgdesc="mce with support for tap-to-wake and tilt-to-wake"
url="https://github.com/sailfishos/mce"
arch="all"
license="LGPL-2.1-only"
depends="dsme"
makedepends="
	bsd-compat-headers
	dbus-dev
	doxygen
	elogind-dev
	eudev-dev
	glib-dev
	graphviz
	libdsme-dev
	libiphb-dev
	libngf-dev
	mce-dev
	usb-moded-dev
	"
subpackages="$pkgname-doc $pkgname-openrc $pkgname-systemd"
source="https://github.com/sailfishos/mce/archive/$pkgver/mce-$pkgver.tar.gz
	https://github.com/sailfishos-mirror/dbus-glib/archive/$_commit_dbus_gmain/dbus-glib-$_commit_dbus_gmain.tar.gz
	0001-Double-tap-emulation-Adapts-the-state-machine-to-a-s.patch
	0001-Keep-screen-on-by-default-on-emulator.patch
	0002-tilt-to-wake-Wake-screen-when-wrist-gesture-arrives.patch
	0003-inactivity-Allow-activities-in-lockscreen-mode.-aste.patch
	0004-Ambient-mode-Adapt-low-power-mode-to-allow-for-actua.patch
	0005-Ambient-Mode-Wait-for-compositor-when-sending-enable.patch
	0006-Ambient-Mode-Exit-ambient-mode-when-touch-is-detecte.patch
	0007-powerkey-Also-suspend-on-palm-reports.patch
	0008-fix-32bit-build.patch
	0009-fix-lfs64-lseek.patch
	mce.initd
	mce.confd
	"
options="!check" # Build failures

prepare() {
	default_prepare

	rmdir dbus-gmain
	mv "$srcdir/dbus-glib-$_commit_dbus_gmain" dbus-gmain
}

build() {
	make
	make doc
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install

	install -Dm755 "$srcdir"/mce.initd "$pkgdir"/etc/init.d/mce
	install -Dm644 "$srcdir"/mce.confd "$pkgdir"/etc/conf.d/mce

	mkdir -p "$pkgdir"/usr/share/dbus-1/system.d/
	mv "$pkgdir"/etc/dbus-1/system.d/* "$pkgdir"/usr/share/dbus-1/system.d/
}

sha512sums="
ebc73031bdc76ca63c5497873dee88579531dcca4e8b2b65c0ed97ad59d91a1adf9d0cc17fe509d1dac778090b1d8d5a7f89d6e3832214e0833c1fa829187054  mce-1.116.4.tar.gz
665cd6395ee0ea14086ba30188c62a72697b3f63484681e18fc7f54109c9aca162f2e33aa2fa4d45287c6c0b590e81ca310c143dac0232cd5887692cdaf51256  dbus-glib-d42176ae4763e5288ef37ea314fe58387faf2005.tar.gz
d5855bb7cf72920a57533ff0e6d567b1fc52104e04c3e4a15c01d72b83cf7011daf66c37b86ae5e20ff859c13606a2acd81f7f34ff29f8086c34979ca641491b  0001-Double-tap-emulation-Adapts-the-state-machine-to-a-s.patch
4cecf1b48266c4ec1d05412514eca1d63f9c442a39eaee25e654c1878f6c506995458f43d4f70ed4179198577ab2cadd4ab2d816e185e6f4d187aa449dbd0887  0001-Keep-screen-on-by-default-on-emulator.patch
a99570cd0996a10ac961373976d48c205d7258555addb19479425e5e92c97b3aa8ebaa4e977bfeb49e91e0267468378c2b726c7d962874d9d0dc74793a51e437  0002-tilt-to-wake-Wake-screen-when-wrist-gesture-arrives.patch
9777138f514591d34524ccde1b0646c0d8d8f980ac3f217fed4739e2718fef6c820106fa58a12999ff567eba49dfbff03f0a7b952d65d8763eb263f52086a6b0  0003-inactivity-Allow-activities-in-lockscreen-mode.-aste.patch
fb6031cd7e6cbca22ef5aae927803dcf60e10423770bbe4f86db5be9d3ab944342ae0eacc099c2966e741ced7735ec4f09876284ba4391f55dee7baf23a71486  0004-Ambient-mode-Adapt-low-power-mode-to-allow-for-actua.patch
23910efee13c22c3718bacd76d87f6b485d2de2eb5b6678022e439d6397e07c639eca17286a8bf1e716fbcd57b7e25b07352b15b469a22f3e9cf97fbc4e4975e  0005-Ambient-Mode-Wait-for-compositor-when-sending-enable.patch
8c601919930a84994b3ceab984544840147de98baca203a90d55b2ceb071279d48e482343f2eb3641e5461ebc25af5b25c715d5edf057ff0944dd4355ff54c9e  0006-Ambient-Mode-Exit-ambient-mode-when-touch-is-detecte.patch
9d01202edf21e848a8665076dfd02d0896a50251e4acda694733fbd1acc4e4be522ebc896206a5fc8d3e02f9435f85ab5f60f8a32d410bc2acfcaedde0c40670  0007-powerkey-Also-suspend-on-palm-reports.patch
ad76be70336bec361bfcb2cd664a627a26c1576d7acd98666f986d318ff1ac96e739696577381b99f5ff13febd62b497f9e5e7ee80c7ea1de02409c65d8a7a36  0008-fix-32bit-build.patch
0f22d22df8a458b732ff9598edb2369ba92ab473b5f239e39f6a27ce9c7268756994f33af42c6b74b28a2d2143d210c3aa3fa12a6173704a20d22c447ad5c518  0009-fix-lfs64-lseek.patch
b07d40a66fd9206b1e34164a0229b05456cbe268b4004045c8fda34742c40528c56c5f1cf81cbc4ba3662c20fcbcff4a8f8e00fc8fbb2ff7bb92e7ab125dd55b  mce.initd
b841282b96110ec59a7aa539db0737327b09549d55c78dc4b2c3b28b4a6ad1facf015b3175cb6d3a38f13e47aa6314ef3dc1514a4e60dd653a97409ec54ba706  mce.confd
"
