# Maintainer: kpcyrd <git@rxv.cc>
pkgname=wasm-bindgen
pkgver=0.2.108
pkgrel=0
pkgdesc="Interoperating JS and Rust code"
url="https://github.com/rustwasm/wasm-bindgen"
arch="all"
license="Apache-2.0"
depends="cargo nodejs rust-wasm"
makedepends="
	cargo-auditable
	"
source="https://github.com/rustwasm/wasm-bindgen/archive/refs/tags/$pkgver/wasm-bindgen-$pkgver.tar.gz
	Cargo.lock
	tests.patch
	"
options="net"

case "$CARCH" in
# FIXME most tests fail
x86|s390x|arm*) options="$options !check" ;;
esac

prepare() {
	# https://github.com/rustwasm/wasm-bindgen/issues/1819
	cp "$srcdir/Cargo.lock" .

	default_prepare

	cargo fetch --target="$CHOST" --locked
}

build() {
	cd crates/cli
	cargo auditable build --release --frozen
}

check() {
	cd crates/cli
	RUSTFLAGS= \
	cargo test --frozen
}

package() {
	install -Dm755 -t "$pkgdir"/usr/bin \
		target/release/wasm-bindgen \
		target/release/wasm-bindgen-test-runner \
		target/release/wasm2es6js
}

sha512sums="
e3651e7cb8cdc475648589076a3ed16f8989cca08b45f114defee1e5a0e37a8911c0f81a4cfa52a4fae5cfdb1b9822318642d2475ce728bf166cdd6372a49479  wasm-bindgen-0.2.108.tar.gz
22dc25963fbb5c2283e76a76a2a607f416594e4885fe769df724b8edad5018e9f46fdf2c4b58bac22bb78f625b8a8fc038ae2749b268b519895653d5e205bd4f  Cargo.lock
5f24dbd7f2e6c55e0a3e5207c4380d88d611b3335a5cfcdc1bd68e47d9336d99be53a1637a71b77d6a1e96ba6c2d362d7eea5edc798fee70a1d8906f086f3a7c  tests.patch
"
