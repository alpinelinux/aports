# Contributor: Pavlo Dembytskyi <me@devs.boo>
# Contributor: Thomas Boerger <thomas@webhippie.de>
# Contributor: Michał Polański <michal@polanski.me>
# Maintainer: Thomas Boerger <thomas@webhippie.de>
pkgname=hugo
pkgver=0.155.3
pkgrel=3
pkgdesc="Fast and flexible static site generator written in Go"
url="https://gohugo.io/"
license="Apache-2.0"
arch="all"
makedepends="go"
checkdepends="asciidoctor git npm py3-docutils tzdata"
subpackages="
	$pkgname-doc
	$pkgname-bash-completion
	$pkgname-fish-completion
	$pkgname-zsh-completion
	"
source="hugo-$pkgver.tar.gz::https://github.com/gohugoio/hugo/archive/v$pkgver/hugo-$pkgver.tar.gz
	skip-dartsass-test.patch
	skip-para-test.patch
	skip-tailwindcss-test.patch
	skip-images-test.patch
	skip-webp-test.patch
	"
options="net"

# secfixes:
#   0.140.1-r0:
#     - CVE-2024-55601

export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

build() {
	go build -v -o bin/$pkgname --tags extended,withdeploy
	./bin/hugo gen man
	./bin/hugo completion bash > hugo.bash
	./bin/hugo completion fish > hugo.fish
	./bin/hugo completion zsh > hugo.zsh
}

check() {
	go test -skip TestVimeoShortcode ./...
}

package() {
	install -Dm755 bin/$pkgname "$pkgdir"/usr/bin/$pkgname
	install -Dm644 man/*.1 -t "$pkgdir"/usr/share/man/man1

	install -Dm644 hugo.bash \
		"$pkgdir"/usr/share/bash-completion/completions/hugo
	install -Dm644 hugo.fish \
		"$pkgdir"/usr/share/fish/vendor_completions.d/hugo.fish
	install -Dm644 hugo.zsh \
		"$pkgdir"/usr/share/zsh/site-functions/_hugo
}

sha512sums="
b9c330ae145aac34dcf21c9503479889bfce69ec76b4c4407523473c9589043f47ea20585eed8b2eb8f8a24089a6c957261a7ca086df467ffad29fd9850d5c86  hugo-0.155.3.tar.gz
ac383010dd46d537462bd6a693557876b496ba0e083ad6f5a022f06a63619b2e5c63d08597e530a6bb301d5c198bb2d33c660cd238f110fa2e5d667db3ab28cf  skip-dartsass-test.patch
6ba192d8cb67f115f7ce596c297a55fc64713a4cdb0077cfbb7e45051c7560f5b668da88f513d4f34d8e0eeb4a9d991c5312d62e454c85e95960d8a33f0f8f69  skip-para-test.patch
ddb50e6ee6ec47cf6e59dbc5fdba7396700e1995c71670b79a34afd022cd13b5cb2ffbc750dbfba77025102710742b72b5664078f7f2763174140adaf4cd5b77  skip-tailwindcss-test.patch
608076119a549fa79150dcb030fc147a259be833210fbbcee29e8e06d6c2621ef6c5aae4ca920de45c22cc9b4dfc58fc0e350c70e9bb24182b481b014f02c954  skip-images-test.patch
1f449c79912508f7d288034d0800d496b1caa1032202e4156b4184ba9aad7906303a7fdd9b5ead32e66fac313371c47d79d7294a367a7ebb1e5c08e4ea8aa2a7  skip-webp-test.patch
"
