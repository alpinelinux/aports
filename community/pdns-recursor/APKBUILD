# Contributor: Olivier Mauras <olivier@mauras.ch>
pkgname=pdns-recursor
pkgver=4.0.9
pkgrel=0
pkgdesc="PowerDNS Recursive Server"
url="https://www.powerdns.com/"
arch="all !s390x"
license="GPL"
depends=""
depends_dev=""
makedepends="$depends_dev boost-dev lua-dev libressl-dev"
install="$pkgname.pre-install"
subpackages="$pkgname-doc"
pkgusers="pdns"
pkggroups="pdns"
source="https://downloads.powerdns.com/releases/pdns-recursor-$pkgver.tar.bz2
	pdns-recursor.initd
	recursor.conf
	"

_builddir="$srcdir/$pkgname-$pkgver"

# secfixes:
#   4.0.9-r0:
#     - CVE-2018-10851
#     - CVE-2018-14644
#     - CVE-2018-14626

prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
	./configure --prefix=/usr \
		--sysconfdir=/etc/pdns \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var \
		--libdir=/usr/lib/pdns \
		--disable-static \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	rm "$pkgdir"/etc/pdns/recursor.conf-dist || return 1

	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname || return 1

	install -m600 -D "$srcdir"/recursor.conf \
		"$pkgdir"/etc/pdns/recursor.conf || return 1
}

sha512sums="d1433a0b5f8d3ca94bd588790b78f3a48c8ee78b4c37cdc9c4f85a4db35499439a7e757bb2e8fab7cdc8398b5fe070ba7e3d7220ac43993801a7917da8fc4cb6  pdns-recursor-4.0.9.tar.bz2
f23cb30d943e0b0aea09371dc57aa43e55b8f91062a3caa3fac17e3565a8e36dfd304f45eba588f625ca2337cd2ade450ea5ae1776872c006204cdaf912f6651  pdns-recursor.initd
954df537693a202fc195e751011bbfaa605b3f3df42ac386fa82eb809b73c2b987f5e418b5c96bb3b0669497426ce0daa39a719844701e06990b82843a4cf0d4  recursor.conf"
