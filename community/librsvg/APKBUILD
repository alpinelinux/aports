# Contributor: Rasmus Thomsen <oss@cogitri.dev>
# Contributor: Patrycja Rosa <alpine@ptrcnull.me>
maintainer="Achill Gilgenast <achill@achill.org>"
pkgname=librsvg
pkgver=2.61.3
pkgrel=1
pkgdesc="Library to render SVG images to Cairo surfaces"
url="https://gitlab.gnome.org/GNOME/librsvg"
arch="all"
license="LGPL-2.1-or-later"
depends_dev="rsvg-convert=$pkgver-r$pkgrel"
makedepends="
	bzip2-dev
	cairo-dev
	cargo
	cargo-c
	dav1d-dev
	font-dejavu
	gi-docgen
	git
	glib-dev
	gobject-introspection-dev
	libgsf-dev
	meson
	py3-docutils
	rust
	vala
	"
install="$pkgname.post-upgrade"
subpackages="
	$pkgname-dbg
	$pkgname-dev
	rsvg-convert:_convert
	"
source="https://download.gnome.org/sources/librsvg/${pkgver%.*}/librsvg-$pkgver.tar.xz
	gdk-pixbuf.patch
	"
# tests are very dependent on versions of pango/cairo/freetype
options="!check net"

# secfixes:
#   2.56.3-r0:
#     - CVE-2023-38633
#   2.50.4-r0:
#     - RUSTSEC-2020-0146
#   2.46.2-r0:
#     - CVE-2019-20446

export RUSTFLAGS="$RUSTFLAGS -C debuginfo=1"

prepare() {
	default_prepare
	git init -q
}

build() {
	abuild-meson \
		-Dintrospection=enabled \
		-Dpixbuf=disabled \
		-Dpixbuf-loader=disabled \
		-Dvala=enabled \
		-Dtests="$(want_check && echo true || echo false)" \
		-Davif=enabled \
		-Ddocs=disabled \
		output
	meson compile -C output
}

check() {
	meson test --print-errorlogs -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
}

_convert() {
	pkgdesc="CLI utility to convert SVG files to PNG format"

	amove usr/bin/rsvg-convert
}

sha512sums="
f16a1997a5e174214454b5e398cb432d74192c03e2ce6d7aec1d4288d20a1206e06a359e047a0003dc8f6f11a9f0c87f6d9a8c808d621a97001e41b5cc7a062c  librsvg-2.61.3.tar.xz
829ab2f485d16e18879ed9d23523fca52d944498ce0b091fae3b9d6665a0635f90516d49f5891de1a590edec476b41dcf82750e67a0ea775e5b147f4a13b2177  gdk-pixbuf.patch
"
