From fd18ec27cf6ae7cdea2166efa6451a2fa36de759 Mon Sep 17 00:00:00 2001
From: Jens Reidel <adrian@travitia.xyz>
Date: Tue, 23 Sep 2025 12:59:12 +0000
Subject: [PATCH] statfs: Fix definitions for s390x musl with libc 0.2.176

Signed-off-by: Jens Reidel <adrian@travitia.xyz>
---
 vendored-nix/src/sys/statfs.rs | 20 ++++++++------------
 1 file changed, 8 insertions(+), 12 deletions(-)

diff --git a/vendored-nix/src/sys/statfs.rs b/vendored-nix/src/sys/statfs.rs
index c0a9f6c993..72958633fa 100644
--- a/vendored-nix/src/sys/statfs.rs
+++ b/vendored-nix/src/sys/statfs.rs
@@ -56,11 +56,10 @@ type fs_type_t = u32;
 type fs_type_t = libc::c_ulong;
 #[cfg(all(
     target_os = "linux",
-    target_arch = "s390x",
-    not(target_env = "musl")
+    target_arch = "s390x"
 ))]
 type fs_type_t = libc::c_uint;
-#[cfg(all(target_os = "linux", any(target_env = "musl", target_env = "ohos")))]
+#[cfg(all(target_os = "linux", any(target_env = "musl", target_env = "ohos"), not(target_arch = "s390x")))]
 type fs_type_t = libc::c_ulong;
 #[cfg(all(target_os = "linux", target_env = "uclibc"))]
 type fs_type_t = libc::c_int;
@@ -328,8 +327,7 @@ impl Statfs {
     /// Optimal transfer block size
     #[cfg(all(
         target_os = "linux",
-        target_arch = "s390x",
-        not(target_env = "musl")
+        target_arch = "s390x"
     ))]
     pub fn optimal_transfer_size(&self) -> u32 {
         self.0.f_bsize
@@ -338,7 +336,7 @@ impl Statfs {
     /// Optimal transfer block size
     #[cfg(any(
         target_os = "android",
-        all(target_os = "linux", target_env = "musl"),
+        all(target_os = "linux", target_env = "musl", not(target_arch = "s390x")),
         all(target_os = "linux", target_env = "ohos")
     ))]
     pub fn optimal_transfer_size(&self) -> libc::c_ulong {
@@ -387,8 +385,7 @@ impl Statfs {
     // f_bsize on linux: https://github.com/torvalds/linux/blob/master/fs/nfs/super.c#L471
     #[cfg(all(
         target_os = "linux",
-        target_arch = "s390x",
-        not(target_env = "musl")
+        target_arch = "s390x"
     ))]
     pub fn block_size(&self) -> u32 {
         self.0.f_bsize
@@ -396,7 +393,7 @@ impl Statfs {
 
     /// Size of a block
     // f_bsize on linux: https://github.com/torvalds/linux/blob/master/fs/nfs/super.c#L471
-    #[cfg(all(target_os = "linux", target_env = "musl"))]
+    #[cfg(all(target_os = "linux", target_env = "musl", not(target_arch = "s390x")))]
     pub fn block_size(&self) -> libc::c_ulong {
         self.0.f_bsize
     }
@@ -472,15 +469,14 @@ impl Statfs {
     /// Maximum length of filenames
     #[cfg(all(
         target_os = "linux",
-        target_arch = "s390x",
-        not(target_env = "musl")
+        target_arch = "s390x"
     ))]
     pub fn maximum_name_length(&self) -> u32 {
         self.0.f_namelen
     }
 
     /// Maximum length of filenames
-    #[cfg(all(target_os = "linux", target_env = "musl"))]
+    #[cfg(all(target_os = "linux", target_env = "musl", not(target_arch = "s390x")))]
     pub fn maximum_name_length(&self) -> libc::c_ulong {
         self.0.f_namelen
     }
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -14,3 +14,7 @@ opt-level = 3
 inherits = "release"
 lto = "thin"
 panic = "abort"
+
+[patch.crates-io]
+rustyline = { path = "vendored-rustyline" }
+nix = { path = "vendored-nix" }
--- a/minijinja-cli/Cargo.toml
+++ b/minijinja-cli/Cargo.toml
@@ -47,7 +47,7 @@ minijinja = { version = "=2.16.0", path
     "loop_controls"
 ] }
 minijinja-contrib = { version = "=2.16.0", optional = true, path = "../minijinja-contrib", features = ["pycompat", "datetime", "timezone", "rand", "unicode_wordwrap", "wordcount"] }
-rustyline = { version = "14.0.0", optional = true }
+rustyline = { version = "17.0.2", optional = true, path = "../vendored-rustyline" }
 serde = { version = "1.0.183", features = ["derive", "rc"] }
 serde_json = "1.0.105"
 serde_json5 = { version = "0.1.0", optional = true }
--- a/vendored-rustyline/Cargo.toml
+++ b/vendored-rustyline/Cargo.toml
@@ -16,9 +16,6 @@ exclude = ["/.github/*", "/rustfmt.toml"
 [badges]
 maintenance = { status = "actively-developed" }
 
-[workspace]
-members = ["rustyline-derive"]
-
 [dependencies]
 bitflags = "2.6"
 cfg-if = "1.0"
@@ -42,7 +39,7 @@ regex = { version = "1.10", optional = t
 rustyline-derive = { version = "0.11.1", optional = true, path = "rustyline-derive" }
 
 [target.'cfg(unix)'.dependencies]
-nix = { version = "0.30", default-features = false, features = [
+nix = { version = "0.31.1", path = "../vendored-nix", default-features = false, features = [
     "fs",
     "ioctl",
     "poll",
