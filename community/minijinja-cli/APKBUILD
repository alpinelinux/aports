# Maintainer: omni <omni+alpine@hack.org>
maintainer="omni <omni+alpine@hack.org>"
pkgname=minijinja-cli
pkgver=2.16.0
_nixver=0.31.1 # to patch with https://github.com/nix-rust/nix/pull/2678
_rustylinever=17.0.2 # together with above
pkgrel=0
pkgdesc="CLI using MiniJinja to render Jinja2 templates from the command line to stdout"
_pkgname=minijinja
url="https://docs.rs/minijinja/latest/minijinja/"
arch="all"
license="Apache-2.0"
makedepends="cargo
	cargo-auditable
	py3-gpep517
	py3-maturin
	py3-setuptools
	sequoia-sq
	"
checkdepends="py3-pytest"
subpackages="
	$pkgname-doc
	$pkgname-bash-completion
	$pkgname-fish-completion
	$pkgname-zsh-completion
	py3-$_pkgname-pyc
	py3-$_pkgname:py3
	"
options="net" # cargo
source="$_pkgname-$pkgver.tar.gz::https://github.com/mitsuhiko/minijinja/archive/refs/tags/$pkgver.tar.gz
	nix-$_nixver.tar.gz::https://github.com/nix-rust/nix/archive/refs/tags/v$_nixver.tar.gz
	rustyline-$_rustylinever.tar.gz::https://github.com/kkawakam/rustyline/archive/refs/tags/v$_rustylinever.tar.gz
	minimal-workspace.patch
	nix-s390x.patch
	Cargo.lock
	"
builddir="$srcdir"/"$_pkgname-$pkgver"

export CARGO_BUILD_TARGET="$CHOST"

prepare() {
	mv "$srcdir/nix-$_nixver" vendored-nix # fix s390x build
	mv "$srcdir/rustyline-$_rustylinever" vendored-rustyline # with above
	default_prepare

	cp "$srcdir"/Cargo.lock Cargo.lock

	msg2 "Fetching crates"
	cargo fetch --target="$CHOST" --locked
}

build() {
	msg2 "Building $pkgname"
	ASSET_OUT_DIR=asset_out_dir cargo auditable build --release --frozen \
		--all-features --package "$pkgname"

	cd minijinja-py
	msg2 "Building py3-$_pkgname"
	gpep517 build-wheel \
		--wheel-dir .dist\
		--config-json '{"build-args": "--frozen", "build-option": "--release --all-features --package minijinja-py"}' \
		--output-fd 3 3>&1 >&2
	# TODO: cargo auditable build with maturin
	# https://github.com/PyO3/maturin/issues/2495
}

check() {
	msg2 "Running tests for $pkgname"
	cargo test --frozen --package "$pkgname"

	cd minijinja-py
	msg2 "Running tests for py3-$_pkgname"
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer .dist/*.whl
	.testenv/bin/python3 -m pytest \
		-k 'not test_fucked_up_object' # Fatal Python error: Aborted
	# missing (check)dependency?
}

package() {
	install -Dm755 target/"$CARGO_BUILD_TARGET"/release/"$pkgname" \
		-t "$pkgdir"/usr/bin/

	_asset_out_dir="$pkgname/asset_out_dir"
	install -Dm644 "$_asset_out_dir"/man/*.1 \
		-t "$pkgdir"/usr/share/man/man1/
	install -Dm644 "$_asset_out_dir"/completions/"$pkgname".bash \
		"$pkgdir"/usr/share/bash-completion/completions/"$pkgname"
	install -Dm644 "$_asset_out_dir"/completions/"$pkgname".fish \
		-t "$pkgdir"/usr/share/fish/vendor_completions.d/
	install -Dm644 "$_asset_out_dir"/completions/_"$pkgname" \
		-t "$pkgdir"/usr/share/zsh/site-functions/

	cd minijinja-py
	python3 -m installer -d "$pkgdir" .dist/*.whl
}

py3() {
	pkgdesc="Python bindings for MiniJinja, a template engine compatible with Jinja/Jinja2"

	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/python3* "$subpkgdir"/usr/lib/
}

sha512sums="
aee2337898787a6608147965e70b7f186dd9130c320eeef588389315c41cb2e33142e394de678e60faf2d3830d4ebc38014e4b2f337838b4586a7909e69abbc3  minijinja-2.16.0.tar.gz
df5247b6ac05381195ba6c275bee1cc1f1a628a417e6e1247132bf705444ef8c98d7303e19b07fab416c4a1af132c92516cbe58d92e78479c8f194957ce8cd0a  nix-0.31.1.tar.gz
f887502594e089303d187891b57a75a6885d85eeada91c0ad1f94b41170717acf3471c9eeee7e4f4951c9daace42ca62d7736eab8daafdcfd59a91778abb4857  rustyline-17.0.2.tar.gz
ea04d996ddb5557e19c049b78e55f7099a5b197c9d6f4c89cd9b18ae0e588502ac55e30653e5d37941af4f03acecc292357ba84db8be099825b42a615202316d  minimal-workspace.patch
0c14bbfa1e280ff9fb8c9780e223910846d855cb0719c117824fed1bd58cb5acac15e152cd3d0db16361da1ddf15ea918d5aa4a02a2b99b474948892324703c8  nix-s390x.patch
0467ce3fa25afb218ae24bbd227e3b826a8dc48afd5e24a0c48fa2d38036e241d34949a74a67b7fa6a5542ea9bf5b9f9f542c4bac5d8e5957e3575e4a440fb3a  Cargo.lock
"
