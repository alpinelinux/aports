# Contributor: Matthieu Baerts (NGI0) <matttbe@kernel.org>
# Maintainer: Matthieu Baerts (NGI0) <matttbe@kernel.org>
pkgname=mptcpd
pkgver=0.14
pkgrel=0
pkgdesc="Multipath TCP Daemon"
url="https://mptcpd.mptcp.dev"
arch="all"
license="BSD-3-Clause"
makedepends="
	argp-standalone
	automake
	autoconf-archive
	ell-dev
	libtool
	linux-headers
	"
options="!check" # the tests require the libc
subpackages="
	$pkgname-dbg
	$pkgname-dev
	$pkgname-doc
	$pkgname-openrc
	mptcpize
	mptcpize-dbg:mptcpize_dbg
	mptcpize-doc:mptcpize_doc:noarch
	mptcp-get-debug:mptcp_get_debug:noarch
	"
source="https://github.com/multipath-tcp/mptcpd/releases/download/v$pkgver/mptcpd-$pkgver.tar.gz
	mptcpd.initd
	mptcpd.confd
	"

build() {
	# can be removed when 0002-mptcpize-define-error-if-not-available.patch
	# is dropped, same for 'automake', 'autoconf-archive' and 'libtool' deps
	autoreconf --install --symlink --force

	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--with-kernel=upstream
	make
}

package() {
	make DESTDIR="$pkgdir" install

	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
}

mptcpize() {
	pkgdesc="Force apps to use MPTCP instead of TCP"
	amove usr/bin/mptcpize
	amove usr/lib/mptcpize
}

mptcpize_dbg() {
	pkgdesc="Force apps to use MPTCP instead of TCP (dbg)"

	mkdir -p "$subpkgdir"/usr/lib/debug/usr/bin/
	mv -v "$pkgdir"-dbg/usr/lib/debug/usr/bin/mptcpize.debug \
		"$subpkgdir"/usr/lib/debug/usr/bin/
	mkdir -p "$subpkgdir"/usr/lib/debug/usr/lib/
	mv -v "$pkgdir"-dbg/usr/lib/debug/usr/lib/mptcpize \
		"$subpkgdir"/usr/lib/debug/usr/lib/
}

mptcpize_doc() {
	pkgdesc="Force apps to use MPTCP instead of TCP (doc)"
	depends=""

	mkdir -p "$subpkgdir"/usr/share/man/man8/
	mv -v "$pkgdir"-doc/usr/share/man/man8/mptcpize.8* \
		"$subpkgdir"/usr/share/man/man8/
}

mptcp_get_debug() {
	pkgdesc="MPTCP debug info script"
	depends="iproute2"

	amove usr/libexec/mptcp-get-debug
}

sha512sums="
b4e1c29319894c16030b6d359f635db9cbd649b78a01a6ff4f23873d3ac5ef8b5d9ff12281b893cd3be4f9fe40504e6d2a6b78ad7c54757a168da062bb4bbfcc  mptcpd-0.14.tar.gz
cc210ec33c5b047aeeb60f687176dcd3cc62be5218275be595a5367faeff108b099446ecc2a0b0bb9f21ab20d0c408fb7e9c827cc3283c7bd127ad4677ae488b  mptcpd.initd
097109e69e6f8d51c2e40ea21ac18c6e9a4ee09e52bf7761b9cbd8e4a6be5a7b550f3a17df556a1597b8d3260a27c5d7b53f47b1027bfb6e431d655b6de5e4c7  mptcpd.confd
"
