# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=repmgr
pkgver=4.0.2
pkgrel=0
pkgdesc="Replication Manager for PostgreSQL"
url="http://www.repmgr.org/"
arch="all"
license="GPL-3"
depends="postgresql-client"
makedepends="postgresql-dev libxml2-dev libedit-dev"
pkgusers="postgres"
subpackages="$pkgname-daemon"
source="$pkgname-$pkgver.tar.gz::https://github.com/2ndQuadrant/$pkgname/archive/v$pkgver.tar.gz
	repmgr.conf.patch
	repmgrd.initd"
builddir="$srcdir/$pkgname-$pkgver"
options="!checkroot"

build() {
	cd "$builddir"
	./configure && make USE_PGXS=1
}

check() {
	cd "$builddir"
	./repmgr --version
	./repmgrd --version
}

package() {
	cd "$builddir"

	make USE_PGXS=1 DESTDIR="$pkgdir" install

	install -D -m 640 -o postgres -g postgres \
		repmgr.conf.sample "$pkgdir"/etc/repmgr.conf

	cd "$pkgdir"
}

daemon() {
	pkgdesc="A management and monitoring daemon for PostgreSQL Replication Manager"
	depends="$pkgname"

	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/repmgrd "$subpkgdir"/usr/bin/

	install -D -m 755 "$srcdir"/repmgrd.initd "$subpkgdir"/etc/init.d/repmgrd
}

sha512sums="c77aa053a3de0cda4a2f98f79b3806987edc9fc7b3bd51e4c63429bd183f440146818425b33990a27d0d82701b242c504ea5a7764626a61dce0d527174ce6087  repmgr-4.0.2.tar.gz
cf4c80146160052d3b51e8ec50ecdf44b88fe2b49c823760fd5a0b3807a3ce39ad38c4d1cb3a223373fca3b1ef0b547ea59174c68abd53cb4a458efc2c2e4e26  repmgr.conf.patch
4ea90fc4b07898235eb3fd441a9f9857d2309e8c124e8e274ddcb44750db7aa2f59f03ac284ecba9150c1e17a8ae173cc5f493abfdc2b66cac3444802379c6e0  repmgrd.initd"
