# Contributor: Valery Kartel <valery.kartel@gmail.com>
# Maintainer: Fabian Affolter <fabian@affolter-engineering.ch>
pkgname=py3-pyzmq
_pkgname=pyzmq
pkgver=27.1.0
pkgrel=0
pkgdesc="Python bindings for ZeroMQ"
url="https://pypi.org/project/pyzmq"
arch="all"
license="LGPL-3.0-or-later AND BSD-3-Clause"
depends="python3 py3-tornado"
makedepends="python3-dev py3-gpep517 py3-setuptools zeromq-dev py3-scikit-build-core cython"
checkdepends="py3-pytest py3-pytest-asyncio"
subpackages="$pkgname-pyc"
source="https://files.pythonhosted.org/packages/source/p/$_pkgname/$_pkgname-$pkgver.tar.gz"
builddir="$srcdir/$_pkgname-$pkgver"

replaces=py-zmq # Backwards compatibility
provides=py-zmq=$pkgver-r$pkgrel # Backwards compatibility

build() {
	gpep517 build-wheel --wheel-dir .dist --output-fd 3 3>&1 >&2
}

check() {
	python3 -m venv --clear --system-site-packages .testenv
#	.testenv/bin/python3 -m installer .dist/*.whl
	.testenv/bin/python3 -m pip install -e "$builddir"
	# TestPubLog random failures on ppc64le/s390x/aarch64
	# https://github.com/zeromq/pyzmq/issues/1880
	.testenv/bin/python3 -m pytest -v \
		--deselect zmq/tests/test_log.py::TestPubLog::test_blank_root_topic \
		--deselect zmq/tests/test_log.py::TestPubLog::test_custom_debug_formatter \
		--deselect zmq/tests/test_log.py::TestPubLog::test_custom_global_formatter \
		--deselect zmq/tests/test_log.py::TestPubLog::test_init_iface \
		--deselect zmq/tests/test_log.py::TestPubLog::test_init_socket \
		--deselect zmq/tests/test_log.py::TestPubLog::test_root_topic \
		--deselect zmq/tests/test_log.py::TestPubLog::test_set_info_formatter_via_property \
		--deselect zmq/tests/test_log.py::TestPubLog::test_unicode_message
}

package() {
	python3 -m installer -d "$pkgdir" .dist/*.whl
}

sha512sums="
c95b2df1901df31ebf3bf7888af593a7a6cbf2a8c9f90214b7f9cb7792a157cd54cda95177d563b9ce02e9e9a51204706729205b3e492d202ab1c91147ec006c  pyzmq-27.1.0.tar.gz
"
