# Contributor: Justin Berthault <justin.berthault@zaclys.net>
# Contributor: Antoni Aloy <aaloytorrens@gmail.com>
# Maintainer:
pkgname=musescore
pkgver=4.6.3
pkgrel=0
pkgdesc="Create, play and print beautiful sheet music"
url="https://musescore.org/"
# armhf blocked by qt6-qtdeclarative
arch="all !armhf"
license="GPL-3.0-only"
depends="
	kirigami-addons
	sonnet
	"
makedepends="
	clang
	cmake
	doxygen
	flac
	jack-dev
	harfbuzz-dev
	lame-dev
	libopusenc-dev
	libsndfile-dev
	portmidi-dev
	pulseaudio-dev
	qt6-qt5compat-dev
	qt6-qtbase-dev
	qt6-qtdeclarative-dev
	qt6-qtnetworkauth-dev
	qt6-qtscxml-dev
	qt6-qtsvg-dev
	qt6-qttools-dev
	samurai
	tinyxml2-dev
	"
subpackages="$pkgname-doc $pkgname-lang"
source="$pkgname-$pkgver.tar.gz::https://github.com/musescore/MuseScore/archive/v$pkgver.tar.gz
	no-update-check.patch
	fix-build-qt-debug.patch
	qt6-6.10.0-guiprivate.patch
	qt6-6.10.0-update.patch
	"
builddir="$srcdir"/MuseScore-$pkgver
options="!check" # todo

build() {
	# FIXME https://gitlab.alpinelinux.org/alpine/aports/-/issues/17612
	CMAKE_PREFIX_PATH="/usr" \
	PATH="$PATH:/usr/lib/qt6/bin" \
	CC=clang \
	CXX=clang++ \
	CFLAGS="${CFLAGS/-fstack-clash-protection} -O2 -DNDEBUG" \
	CXXFLAGS="${CXXFLAGS/-fstack-clash-protection} -O2 -DNDEBUG -D_LARGEFILE64_SOURCE" \
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_SKIP_RPATH=ON \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DMUSESCORE_BUILD_CONFIGURATION=app \
		-DMUSE_APP_BUILD_MODE=release \
		-DMUE_BUILD_UNIT_TESTS="$(want_check && echo ON || echo OFF)" \
		-DMUE_COMPILE_USE_SYSTEM_FLAC=ON \
		-DMUE_COMPILE_USE_SYSTEM_FREETYPE=ON \
		-DMUE_COMPILE_USE_SYSTEM_HARFBUZZ=ON \
		-DMUE_COMPILE_USE_SYSTEM_OPUS=ON \
		-DMUE_COMPILE_USE_SYSTEM_OPUSENC=ON \
		-DMUE_COMPILE_USE_SYSTEM_TINYXML=ON \
		-DMUE_DOWNLOAD_SOUNDFONT=OFF
	cmake --build build --target all MuseScore_lrelease
}

check() {
	ctest --test-dir build
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

lang() {
	pkgdesc="Translations for $pkgname"
	install_if="$pkgname=$pkgver-r$pkgrel lang"

	amove usr/share/mscore-*/locale
}

sha512sums="
bd8f427154613f00d5a84a949b05351ce5fa8e9ce2f37410c97762d5dd29643c2e6c5bd763a40a99f927aa61d84a3572734189f2650daae5eb3a6a51717be923  musescore-4.6.3.tar.gz
8c3d3ac04abf18142a2e83ff8f28d78d6e004bf112a54796ab7fc16593dbd2c526d96927c171441c181ba0e377fd75f7f050972ce38d294e6fffc3ab1f174676  no-update-check.patch
f82273e78dda22eb7e540b3067cb8e6924c004d7883624925946939b36370de2a5e086815bdb258ed84b10caab45e321a21d15d0823694e79edfe29126349896  fix-build-qt-debug.patch
cf6a0073fc90d0ab3a44060a1dc299ba23d88d465973a7a2c8eac592526d3ac14634da880575aa818394ba6d7c7d2d591676d995bc17740906d2b5c69b6bb3ec  qt6-6.10.0-guiprivate.patch
afc23c5873bba398edeef88a5e666a6ebb806aa40b7873101ab20fd8488a01add608a2c15362ba2756a3a21c01e1e045a6b05ba0c8bc5897d0ed4cda29007b6c  qt6-6.10.0-update.patch
"
