# Contributor: Milan P. StaniÄ‡ <mps@arvanta.net>
# Contributor: Logan Gartner <git@lgartner.xyz>
# Maintainer: Logan Gartner <git@lgartner.xyz>
pkgname=bcachefs-tools
_modname=bcachefs
pkgver=1.36.0
pkgrel=0
pkgdesc="userspace tools for bcachefs"
url="https://bcachefs.org/"
# x86: bch_bindgen 0.1.0 fails on '#[repr(align)]' type
arch="all !x86 !armhf !armv7"
license="GPL-2-or-later"
makedepends="
	cargo
	clang21-dev
	coreutils
	libaio-dev
	libsodium-dev
	llvm21-dev
	eudev-dev
	util-linux-dev
	keyutils-dev
	lz4-dev
	userspace-rcu-dev
	zstd-dev
	pkgconf
	zlib
	jq
	"
subpackages="$pkgname-doc $pkgname-udev $_modname-src"
options="net" # cargo
source="$pkgname-$pkgver.tar.zst::https://evilpiepirate.org/bcachefs-tools/bcachefs-tools-$pkgver.tar.zst"

prepare() {
	default_prepare

	cat >AKMBUILD <<-EOF
	modname=$_modname
	modver=$pkgver-r$pkgrel
	built_modules='src/fs/bcachefs/bcachefs.ko'

	build() {
		touch "\$builddir"/Makefile
		export BCACHEFS_DKMS=1
		make \$MAKEFLAGS -C "\$kernel_srcdir" M="\$builddir" modules
	}
	EOF
}

build() {
	make PREFIX=/usr
}

check() {
	VERSION=$(./target/release/bcachefs version)

	test "$VERSION" = "$pkgver"
}

package() {
	make DESTDIR=$pkgdir PREFIX=/usr ROOT_SBINDIR="/usr/sbin" install
	install -m644 AKMBUILD "$pkgdir"/usr/src/$_modname-$pkgver/AKMBUILD
}

src() {
	depends="akms"
	pkgdesc="Kernel module for BCacheFS (sources, AKMS)"

	amove usr/src/$_modname-$pkgver
}

sha512sums="
ae7d5c73bff8748527077160e6a69b946924771ef1784c3f54fb7e1b595348a89640baa5e35d51746a25e4524209f04a1b554af76bf37f13ca3df90ff8523f32  bcachefs-tools-1.36.0.tar.zst
"
