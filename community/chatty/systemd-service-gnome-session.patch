Patch-Source: https://gitlab.gnome.org/World/Chatty/-/merge_requests/1484
---
From 2a293fa1faef7b76d2f2ddd3ecc40a9d24e5792d Mon Sep 17 00:00:00 2001
From: Sebastian Krzyszkowiak <sebastian.krzyszkowiak@puri.sm>
Date: Thu, 11 Dec 2025 02:37:36 +0100
Subject: [PATCH 1/2] data: Fix D-Bus service installation with Devel profile

Part-of: <https://gitlab.gnome.org/World/Chatty/-/merge_requests/1484>
---
 data/meson.build | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/data/meson.build b/data/meson.build
index 0206dd54..95e20b3f 100644
--- a/data/meson.build
+++ b/data/meson.build
@@ -72,10 +72,9 @@ endif
 service_data = configuration_data()
 service_data.set('appid', app_id)
 service_data.set('bindir', get_option('prefix') / get_option('bindir'))
-service_file = '@0@.service'.format(app_id)
 configure_file(
-  input : service_file + '.in',
-  output : service_file,
+  input : 'sm.puri.Chatty.service.in',
+  output : '@0@.service'.format(app_id),
   configuration : service_data,
   install : true,
   install_dir : get_option('datadir') / 'dbus-1' / 'services'
-- 
GitLab


From 097a85961840e1537cd4fba7e14fab6efab68afc Mon Sep 17 00:00:00 2001
From: Sebastian Krzyszkowiak <sebastian.krzyszkowiak@puri.sm>
Date: Thu, 11 Dec 2025 02:39:35 +0100
Subject: [PATCH 2/2] data: Switch to a systemd user unit for the daemon

Fixes #992

Part-of: <https://gitlab.gnome.org/World/Chatty/-/merge_requests/1484>
---
 data/meson.build                         | 18 +++++++++++++++++-
 data/sm.puri.Chatty-daemon.desktop.in.in |  1 +
 data/sm.puri.Chatty-daemon.service.in    | 14 ++++++++++++++
 data/sm.puri.Chatty.service.in           |  1 +
 debian/chatty.install                    |  1 +
 5 files changed, 34 insertions(+), 1 deletion(-)
 create mode 100644 data/sm.puri.Chatty-daemon.service.in

diff --git a/data/meson.build b/data/meson.build
index 95e20b3f..f697d0bc 100644
--- a/data/meson.build
+++ b/data/meson.build
@@ -68,10 +68,11 @@ if compile_schemas.found()
   )
 endif
 
-# DBus service
 service_data = configuration_data()
 service_data.set('appid', app_id)
 service_data.set('bindir', get_option('prefix') / get_option('bindir'))
+
+# DBus service
 configure_file(
   input : 'sm.puri.Chatty.service.in',
   output : '@0@.service'.format(app_id),
@@ -80,4 +81,19 @@ configure_file(
   install_dir : get_option('datadir') / 'dbus-1' / 'services'
 )
 
+# Systemd user service
+systemd_user_unit_dir = join_paths(get_option('prefix'), 'lib/systemd/user/')
+systemd_dep = dependency('systemd', required: false)
+if systemd_dep.found()
+  systemd_user_unit_dir = systemd_dep.get_variable('systemd_user_unit_dir')
+endif
+
+configure_file(
+  input: 'sm.puri.Chatty-daemon.service.in',
+  output : '@0@-daemon.service'.format(app_id),
+  configuration : service_data,
+  install : true,
+  install_dir : systemd_user_unit_dir
+)
+
 subdir('icons')
diff --git a/data/sm.puri.Chatty-daemon.desktop.in.in b/data/sm.puri.Chatty-daemon.desktop.in.in
index 3d1cb1de..34677280 100644
--- a/data/sm.puri.Chatty-daemon.desktop.in.in
+++ b/data/sm.puri.Chatty-daemon.desktop.in.in
@@ -9,3 +9,4 @@ Type=Application
 Categories=Network;GNOME;GTK;Chat;InstantMessaging;
 NoDisplay=true
 X-GNOME-AutoRestart=true
+X-GNOME-HiddenUnderSystemd=true
diff --git a/data/sm.puri.Chatty-daemon.service.in b/data/sm.puri.Chatty-daemon.service.in
new file mode 100644
index 00000000..01030270
--- /dev/null
+++ b/data/sm.puri.Chatty-daemon.service.in
@@ -0,0 +1,14 @@
+[Unit]
+Description=SMS/MMS, Matrix and XMPP chat application (daemon mode)
+PartOf=gnome-session.target
+Requisite=gnome-session-initialized.target
+After=gnome-session-initialized.target
+
+[Service]
+BusName=@appid@
+ExecStart=@bindir@/chatty --gapplication-service
+Type=dbus
+Restart=on-failure
+
+[Install]
+WantedBy=gnome-session.target
diff --git a/data/sm.puri.Chatty.service.in b/data/sm.puri.Chatty.service.in
index 37eda45a..9ee98abc 100644
--- a/data/sm.puri.Chatty.service.in
+++ b/data/sm.puri.Chatty.service.in
@@ -1,3 +1,4 @@
 [D-BUS Service]
 Name=@appid@
 Exec=@bindir@/chatty --gapplication-service
+SystemdService=@appid@-daemon.service
diff --git a/debian/chatty.install b/debian/chatty.install
index 886050c1..7c6afe05 100644
--- a/debian/chatty.install
+++ b/debian/chatty.install
@@ -1,5 +1,6 @@
 etc/
 usr/bin
+usr/lib
 usr/share/applications/*
 usr/share/bash-completion/*
 usr/share/applications
-- 
GitLab

