# Contributor: Clayton Craft <clayton@craftyguy.net>
# Maintainer: Clayton Craft <clayton@craftyguy.net>
pkgname=cosmic-greeter
pkgver=1.0.0
_upstreamver="${pkgver/_beta/-beta.}"
_upstreamver="${_upstreamver/_p/.}"
pkgrel=1
pkgdesc="Greeter for the COSMIC Desktop Environment"
url="https://github.com/pop-os/cosmic-greeter"
# s390x: greetd
# riscv64: too slow to build
arch="all !s390x !riscv64"
license="GPL-3.0-only"
depends="
	cosmic-comp
	greetd
"
makedepends="
	cargo
	clang-libclang
	eudev-dev
	just
	libinput-dev
	libxkbcommon-dev
	linux-pam-dev
	llvm-dev
	libseat-dev
	wayland-dev
"
install="$pkgname-openrc.pre-install"
options="net !check"  # fetch dependencies, no tests
subpackages="$pkgname-openrc $pkgname-systemd"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/pop-os/cosmic-greeter/archive/refs/tags/epoch-$_upstreamver.tar.gz
	cosmic-greeter-daemon.initd
	cosmic-greeter.initd
	cosmic-greeter.pam
	systemd-enable-display-manager-alias.patch
	"
builddir="$srcdir/$pkgname-epoch-$_upstreamver"

prepare() {
	default_prepare
	cargo fetch --target="$CTARGET" --locked
}

build() {
	export VERGEN_GIT_COMMIT_DATE="$(date -d @"$SOURCE_DATE_EPOCH" '+%Y-%m-%d')"
	export VERGEN_GIT_SHA="unknown"

	just build-release --frozen
}

check() {
	cargo test --release --frozen
}

package() {
	just rootdir="$pkgdir" install
	# TODO: install to /usr/share (?)
	install -Dm644 cosmic-greeter.toml \
		-t "$pkgdir"/etc/greetd/
	install -Dm644 "$srcdir"/cosmic-greeter.pam \
		"$pkgdir"/usr/lib/pam.d/cosmic-greeter

	# OpenRC Services
	install -Dm755 "$srcdir"/cosmic-greeter-daemon.initd \
		"$pkgdir"/etc/init.d/cosmic-greeter-daemon
	install -Dm755 "$srcdir"/cosmic-greeter.initd \
		"$pkgdir"/etc/init.d/cosmic-greeter

	# systemd Services
	install -Dm644 debian/cosmic-greeter-daemon.service \
		-t "$pkgdir"/usr/lib/systemd/system/
	install -Dm644 debian/cosmic-greeter.service \
		-t "$pkgdir"/usr/lib/systemd/system/
}

sha512sums="
51be5128bb844b1e8803061b05296d9f395477e4d507f8f28618ea25d9c2afb062bf695b2af4ae157a4404903d4697b128cee25f45d03ce2b37e711878896df2  cosmic-greeter-1.0.0.tar.gz
9c128313598221511c0bd852f086edb4453f66d88eb041460a62343a361e35d78f15414e6f68c42269dd9aca2ff9a16b498b0503702446138f1a530b80d2479f  cosmic-greeter-daemon.initd
ab6739f91d84033dd96db570d683b5f7c5058832cfaf0a4cdd52648914a7157eedd41dcef670e2512cfa9b60ef35f5925afa78b7b8caf2327c47430c26b96ed3  cosmic-greeter.initd
e7284cf9d3ede2e3108f54a0af9751fba3c399a5fa9b7274fc036a15ec366f5bfe737f68f5aa26628e7c72236be06f2ab5c4abb83e069fc6f9f05a148d38d1e0  cosmic-greeter.pam
d0836d76e06e94da650002b83e92e17cccf0b2d27eff2ddf3abb14e439603409d729fd4ef31a3981522d4e5bb1134f049b7805cae67b2d773f8eb1f7c1393a19  systemd-enable-display-manager-alias.patch
"
