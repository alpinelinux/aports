# Contributor: lauren n. liberda <lauren@selfisekai.rocks>
# Maintainer: lauren n. liberda <lauren@selfisekai.rocks>
pkgname=yt-dlp-ejs
pkgver=0.3.1
pkgrel=0
pkgdesc="External JavaScript for yt-dlp"
url="https://github.com/yt-dlp/ejs"
# s390x: rollup "Unknown node type: 1207959552"
arch="noarch !s390x"
license="Unlicense"
makedepends="
	nodejs
	npm
	py3-gpep517
	py3-hatchling
	py3-hatch-vcs
	"
# !check: one test total that checks if the file exists, breaks
#   due to checking in the src directory rather than the built wheel
# net: npm dependencies (build-time)
options="!check net"
subpackages="$pkgname-pyc"
source="
	https://github.com/yt-dlp/ejs/archive/$pkgver/ejs-$pkgver.tar.gz
	clean-install.patch
	rollup-wasm.patch
	lock.patch
	"
builddir="$srcdir/ejs-$pkgver"

build() {
	export SETUPTOOLS_SCM_PRETEND_VERSION=$pkgver
	gpep517 build-wheel \
		--wheel-dir .dist \
		--output-fd 3 3>&1 >&2
}

check() {
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer .dist/*.whl
	.testenv/bin/python3 -m pytest
}

package() {
	python3 -m installer -d "$pkgdir" \
		.dist/*.whl
}

sha512sums="
03cba4a4ca4a46832a45fa67d868c980dc920b56fbfb0fb74875d817e8a0974b8fd456df8f842c85cb94794188675bb8109366e5e48d79d00e04de4a36662bec  ejs-0.3.1.tar.gz
568bbbee27e4695e51b1f82ad0109344cdb9781b89e54189ff47f4a04a307bcbacef4b4bc3f45ed34f4a09ce2a41beb0c0ffdc6755ec6d2c686f6541569e8117  clean-install.patch
57abb8d761b7a93641aa81282f1cb74fa2ed863dd09545357c6892a667856ea8edf9fa9f3223f56916f3f92890564ac465f66f664142596d3d39d5f212131c1d  rollup-wasm.patch
57ee285809b5c5a347af721d6446fbf5b72061d839952bf5e3aaf369fccee4c9d33e118bf682585b2a0740b5064e87e0355aceb1619a9a3adbd1f7a32d92c077  lock.patch
"
