# Contributor: lauren n. liberda <lauren@selfisekai.rocks>
# Maintainer: lauren n. liberda <lauren@selfisekai.rocks>
pkgname=yt-dlp-ejs
pkgver=0.3.2
pkgrel=0
pkgdesc="External JavaScript for yt-dlp"
url="https://github.com/yt-dlp/ejs"
# s390x: rollup "Unknown node type: 1207959552"
arch="noarch !s390x"
license="Unlicense"
makedepends="
	nodejs
	pnpm
	py3-gpep517
	py3-hatchling
	py3-hatch-vcs
	"
# !check: one test total that checks if the file exists, breaks
#   due to checking in the src directory rather than the built wheel
# net: npm dependencies (build-time)
options="!check net"
subpackages="
	$pkgname-pyc
	$pkgname-rt-nodejs:_nodejs
	$pkgname-rt-quickjs:_quickjs
	"
case "$CARCH" in
	x86_64|aarch64) subpackages="$subpackages $pkgname-rt-deno:_deno" ;;
	*) ;;
esac
install="yt-dlp-ejs-rt-quickjs.post-install"
source="
	https://github.com/yt-dlp/ejs/archive/$pkgver/ejs-$pkgver.tar.gz
	ignore-scripts.patch
	rollup-wasm.patch
	lock.patch
	"
builddir="$srcdir/ejs-$pkgver"

build() {
	export SETUPTOOLS_SCM_PRETEND_VERSION=$pkgver
	gpep517 build-wheel \
		--wheel-dir .dist \
		--output-fd 3 3>&1 >&2
}

check() {
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer .dist/*.whl
	.testenv/bin/python3 -m pytest
}

package() {
	depends="yt-dlp-ejs-rt=$pkgver-r$pkgrel"

	python3 -m installer -d "$pkgdir" \
		.dist/*.whl
}

_nodejs() {
	provides="yt-dlp-ejs-rt=$pkgver-r$pkgrel"
	provider_priority=10
	depends="nodejs"

	mkdir -p "$subpkgdir"
}

_quickjs() {
	provides="yt-dlp-ejs-rt=$pkgver-r$pkgrel"
	provider_priority=20
	depends="quickjs"

	mkdir -p "$subpkgdir"
}

_deno() {
	provides="yt-dlp-ejs-rt=$pkgver-r$pkgrel"
	provider_priority=100
	depends="deno"

	mkdir -p "$subpkgdir"
}

sha512sums="
f3750f42ab82e79b4d7344baf2b2963e2122f53b1217ea96d227ad8aa2e971c1c2b1e194dd461ad5dab786f5f74c8d0d36fcedc6ee4d46435311488a6b9548d4  ejs-0.3.2.tar.gz
59a5c4ca18bf3f05063e9673ed41b2e0db05703aa21ea89d63632c9f170ad8025ce794c9693a7a1b3cee5bab249a878c3b2151c7f0e2e2634bb9aade3a3a035d  ignore-scripts.patch
75279e5dd5781ca29dc3fb73a1f0dd44d38ee657f734d6c47b214eab797f4fa15dcb05a14ecb7cec3c54e98a7327f7696b81c6c566179fc655d1efafd14e7d5f  rollup-wasm.patch
5b07b11847be1532c6672b8172bf8ea235541f165865e6ad592bc41b051543c536c9967966ec9bafef3a1fcf5e3971e6cf6d769ca19f91f29be6ab8db9a0fc82  lock.patch
"
