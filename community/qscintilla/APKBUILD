# Contributor: Holger Jaekel <holger.jaekel@gmx.de>
# Maintainer: Marian Buschsieweke <marian.buschsieweke@posteo.net>
pkgname=qscintilla
pkgver=2.14.1
pkgrel=3
pkgdesc="QScintilla is a port to Qt of Neil Hodgson's Scintilla C++ editor control"
url="https://www.riverbankcomputing.com/software/qscintilla"
arch="all"
license="GPL-3.0-only"
subpackages="
	$pkgname-dev
	$pkgname-designer:designer
	$pkgname-lang::noarch
	"
makedepends="
	py3-ply
	py3-pyqt-builder
	py3-sip
	python3-dev
	qt5-qttools-dev
	qt6-qttools-dev
	rsync
	"
source="https://www.riverbankcomputing.com/static/Downloads/QScintilla/$pkgver/QScintilla_src-$pkgver.tar.gz"
builddir="$srcdir/QScintilla_src-$pkgver"

# py3-qscintilla is blocked by py3-qt6 on armhf
_with_python3_bindings="no"
case "$CARCH" in
	armhf) ;;
	*)
		makedepends="$makedepends py3-qt5 py3-qt6"
		subpackages="$subpackages py3-$pkgname:py3"
		_with_python3_bindings="yes"
		;;
esac

prepare() {
	default_prepare
	cp -ar "$builddir" "$srcdir/QScintilla_src-$pkgver-qt5"
	mv "$builddir" "$srcdir/QScintilla_src-$pkgver-qt6"
}

build() {
	qt5_build
	qt6_build
}

qt5_build() {
	cd "$builddir-qt5/src"
	qmake-qt5
	make

	cd "$builddir-qt5/designer"
	qmake-qt5 INCLUDEPATH+=../src QMAKE_LIBDIR+=../src
	make

	if [ "$_with_python3_bindings" = "yes" ]; then
		cd "$builddir-qt5/Python"
		mv pyproject-qt5.toml pyproject.toml
		sip-build \
			--no-make \
			--qmake /usr/bin/qmake-qt5 \
			--qsci-features-dir ../src/features \
			--qsci-include-dir ../src \
			--qsci-library-dir ../src \
			--api-dir /usr/share/qt5/qsci/api/python
		cd build
		make
	fi
}

qt6_build() {
	cd "$builddir-qt6/src"
	export QMAKEFEATURES="$builddir-qt6/src/features/"
	qmake6
	make

	cd "$builddir-qt6/designer"
	qmake6 INCLUDEPATH+=../src QMAKE_LIBDIR+=../src
	make

	if [ "$_with_python3_bindings" = "yes" ]; then
		cd "$builddir-qt6/Python"
		mv pyproject-qt6.toml pyproject.toml
		LD_LIBRARY_PATH="$builddir-qt6/src" sip-build \
			--no-make \
			--qmake /usr/bin/qmake6 \
			--qsci-features-dir ../src/features \
			--qsci-include-dir ../src \
			--qsci-library-dir ../src \
			--api-dir /usr/share/qt6/qsci/api/python
		cd build
		make
	fi
}

check() {
	# check build for Qt5
	cd "$builddir-qt5/src"
	make check

	# check build for Qt6
	cd "$builddir-qt6/src"
	make check
}

package() {
	# package for Qt5
	make -C "$builddir-qt5/src" INSTALL_ROOT="$pkgdir" install
	make -C "$builddir-qt5/designer" INSTALL_ROOT="$pkgdir" install

	if [ "$_with_python3_bindings" = "yes" ]; then
		make -C "$builddir-qt5/Python/build" INSTALL_ROOT="$pkgdir/py3-qt5-qscintilla" install
	fi

	# package for Qt6
	make -C "$builddir-qt6/src" INSTALL_ROOT="$pkgdir" install
	make -C "$builddir-qt6/designer" INSTALL_ROOT="$pkgdir" install

	if [ "$_with_python3_bindings" = "yes" ]; then
		make -C "$builddir-qt6/Python/build" INSTALL_ROOT="$pkgdir/py3-qt6-qscintilla" install
	fi
}

designer() {
	pkgdesc="$pkgdesc (Qt5 and Qt6 designer plugin)"
	depends="$pkgname=$pkgver-r$pkgrel"

	# Qt5
	amove usr/lib/qt5/plugins/designer

	# Qt6
	amove usr/lib/qt6/plugins/designer
}

py3() {
	pkgdesc="$pkgdesc (Python3 Qt5 and Qt6 bindings)"
	depends="py3-qt5 py3-qt6"

	# Qt5
	mkdir -p "$subpkgdir"
	mv -v "$pkgdir/py3-qt5-qscintilla/usr" "$subpkgdir"
	rmdir "$pkgdir/py3-qt5-qscintilla"

	# Qt6
	mkdir -p "$subpkgdir/usr"
	rsync -a "$pkgdir/py3-qt6-qscintilla/usr" "$subpkgdir"
	rm -rf "$pkgdir/py3-qt6-qscintilla"
}

lang() {
	pkgdesc="$pkgdesc (Qt5 and Qt6 translations)"
	install_if="lang $pkgname=$pkgver-r$pkgrel"

	# Qt5
	amove usr/share/qt5/translations

	# Qt6
	amove usr/share/qt6/translations
}

sha512sums="
19e2f9e0a14947501c575018df368d24eb7f8c74e74faa5246db36415bf28dc0beee507ed0e73107c02b36a99bbaf55f0ef3349f479d2332e1b92b2c4a32788a  QScintilla_src-2.14.1.tar.gz
"
