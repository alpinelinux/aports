# Maintainer: Pawe≈Ç Tomak <pawel@tomak.eu>
pkgname=pike
pkgver=8.0.610
pkgrel=0
pkgdesc="Pike Programing language"
url="https://pike.lysator.liu.se"
arch="x86_64"
license="GPL-2.0-or-later"
options="!check" # there is no tests for those packages
depends=
makedepends="gmp-dev
	bzip2-dev
	freeglut-dev
	gdbm-dev
	giflib-dev
	giflib-utils
	gtk+2.0
	libglade-dev
	libsm-dev
	mesa-gl
	nettle
	nettle-dev
	nettle-utils
	pcre-dev
	sdl-dev
	sdl_mixer-dev
	sqlite-dev
	sqlite-libs
	readline
	zlib-dev
	librsvg-dev"
install=
subpackages="$pkgname-bzip2
	$pkgname-gdbm
	$pkgname-gl
	$pkgname-gtk
	$pkgname-image
	$pkgname-pcre
	$pkgname-sdl
	$pkgname-svg
	$pkgname-sqlite
	$pkgname-doc
	$pkgname-core"
source="http://pike.lysator.liu.se/pub/pike/all/${pkgver}/Pike-v${pkgver}.tar.gz"
builddir="$srcdir/Pike-v$pkgver"

build() {
	cd "$builddir"
	make CONFIGUREARGS=" \
		--prefix=/usr \
		--disable-make_conf \
		--disable-noopty-retry \
		--without-cdebug \
		--without-bundles \
		--without-ssleay \
		--with-gmp \
		--with-crypt \
		--with-bignums \
		--without-rtldebug \
		--with-Bz2 \
		--without-fftw \
		--without-_Ffmpeg \
		--with-gdbm \
		--without-GTK1 \
		--with-GTK2 \
		--with-jpeglib \
		--without-Kerberos \
		--without-msql \
		--without-mysql \
		--without-Odbc \
		--without-oracle \
		--with-GL \
		--with-GLUT \
		--with-_Regexp_PCRE \
		--without-libpdf \
		--without-sass \
		--with-sane \
		--with-SDL \
		--with-SDL_Mixer \
		--with-svg \
		--with-tifflib \
		--without-freetype \
		--without-vcdiff \
		--with-_Image_WebP \
		--with-zlib"
	PATH="${builddir}/bin:${PATH}" make doc || die "doc failed"
}

package() {
	cd "$builddir"
	local pkg
	for pkg in $(printf "%s" "$subpackages" | tr ' ' '\n'); do
		depends="$depends $pkg=$pkgver-r$pkgrel"
	done
	make INSTALLARGS="--traditional" buildroot="$pkgdir" install
}

_install() {
	while [ -n "$1" ]; do
		local bn=$(basename "$1")
		local dn=$(dirname "$1")
		mkdir -p "$subpkgdir/$dn"
		mv "$1" "$subpkgdir/$dn/$bn"
		shift
	done
}

bzip2() {
	cd "$pkgdir"
	pkgdesc="$pkgname support"
	depends="pike-core=$pkgver-r$pkgrel bzip2"
	_install usr/lib/pike/modules/*Bz2.*
}

gdbm() {
	cd "$pkgdir"
	pkgdesc="$pkgname GDBM support"
	depends="pike-core=$pkgver-r$pkgrel gdbm"
	_install usr/lib/pike/modules/*Gdbm.*
}

gl() {
	cd "$pkgdir"
	pkgdesc="$pkgname OpenGL/GLUT support"
	depends="pike-core=$pkgver-r$pkgrel freeglut mesa-gl libsm"
	_install usr/lib/pike/modules/*GL*
}

gtk() {
	cd "$pkgdir"
	pkgdesc="$pkgname GTK2 support"
	depends="pike-image=$pkgver-r$pkgrel libglade gtk+2.0"
	_install usr/lib/pike/modules/*GTK2*
	_install usr/lib/pike/modules/Tools.pmod/PV.pike
}

image() {
	cd "$pkgdir"
	pkgdesc="$pkgname image handling modules"
	depends="pike-core=$pkgver-r$pkgrel giflib-utils libjpeg tiff libwebp"
	_install usr/lib/pike/?.?/modules/Image.pmod
	_install usr/lib/pike/modules/Image.so
	_install usr/lib/pike/modules/*Image_[!S]*.so
	_install usr/lib/pike/modules/*Image*.pmod
	_install usr/lib/pike/modules/Graphics.pmod
	_install usr/lib/pike/modules/Colors.pmod
	_install usr/lib/pike/modules/Protocols.pmod/X.pmod/XImage.pmod
}

pcre() {
	cd "$pkgdir"
	pkgdesc="$pkgname PCRE support"
	depends="pike-core=$pkgver-r$pkgrel pcre"
	_install usr/lib/pike/modules/*Regexp_PCRE.*
}

sdl() {
	cd "$pkgdir"
	pkgdesc="$pkgname SDL support"
	depends="pike-image=$pkgver-r$pkgrel sdl sdl_mixer"
	_install usr/lib/pike/modules/*SDL.*
}

svg() {
	cd "$pkgdir"
	pkgdesc="$pkgname SVG support"
	depends="pike-core=$pkgver-r$pkgrel"
	_install usr/lib/pike/modules/_Image_SVG.so
}

sqlite() {
	cd "$pkgdir"
	pkgdesc="$pkgname SQLite support"
	depends="pike-core=$pkgver-r$pkgrel"
	_install usr/lib/pike/modules/*SQLite.*
	_install usr/lib/pike/modules/Sql.pmod/sqlite*
}

doc() {
	cd "$pkgdir"
	mkdir -p usr/share/doc/
	mv "$builddir/refdoc/traditional_manual/" usr/share/doc/pike/
	rm -rf usr/doc/
	default_doc
}

core() {
	cd "$pkgdir"
	pkgdesc="Pike's core files and executables"
	depends="gmp nettle nettle-utils zlib readline"
	mkdir -p "$subpkgdir"
	mv usr "$subpkgdir/"
}

sha512sums="9e3a49140698715f80a08428c1e61964d756bb91f69ef0cdc39cd5bf7832d9416eec43063f5ab24e65ffbccbb7f7f75338a40ae6f141d6d1d3b29a29a02ab19f  Pike-v8.0.610.tar.gz"
