# Maintainer: Pawe≈Ç Tomak <pawel@tomak.eu>
pkgname=pike
pkgver=8.0.610
pkgrel=0
pkgdesc="Pike Programing language"
url="https://pike.lysator.liu.se"
arch="x86_64"
license="GPL-2.0-or-later"
options="!check" # there is no tests for those packages
depends=
makedepends="gmp-dev
	bzip2-dev
	freeglut-dev
	gdbm-dev
	giflib-dev
	giflib-utils
	gtk+2.0
	libgcrypt-dev
	libglade-dev
	libsm-dev
	mesa-gl
	nettle
	nettle-dev
	nettle-utils
	pcre-dev
	sdl-dev
	sdl_mixer-dev
	sqlite-dev
	sqlite-libs
	readline
	zlib-dev
	librsvg-dev"
install=
subpackages="$pkgname-bzip2
	$pkgname-gdbm
	$pkgname-gl
	$pkgname-gtk
	$pkgname-image
	$pkgname-pcre
	$pkgname-sdl
	$pkgname-svg
	$pkgname-sqlite
	$pkgname-doc
	$pkgname-core"
source="http://pike.lysator.liu.se/pub/pike/all/${pkgver}/Pike-v${pkgver}.tar.gz"
builddir="$srcdir/Pike-v$pkgver"

build() {
	cd "$builddir"
	make CONFIGUREARGS=" \
		--prefix=/usr \
		--disable-make_conf \
		--disable-noopty-retry \
		--without-cdebug \
		--without-bundles \
		--without-ssleay \
		--with-gmp \
		--with-crypt \
		--with-bignums \
		--without-rtldebug \
		--with-Bz2 \
		--without-fftw \
		--without-_Ffmpeg \
		--with-gdbm \
		--without-GTK1 \
		--with-GTK2 \
		--with-jpeglib \
		--without-Kerberos \
		--without-msql \
		--without-mysql \
		--without-Odbc \
		--without-oracle \
		--with-GL \
		--with-GLUT \
		--with-_Regexp_PCRE \
		--without-libpdf \
		--without-sass \
		--with-sane \
		--with-SDL \
		--with-SDL_Mixer \
		--with-svg \
		--with-tifflib \
		--without-freetype \
		--without-vcdiff \
		--with-_Image_WebP \
		--with-zlib"
	PATH="${builddir}/bin:${PATH}" make doc || die "doc failed"
}

package() {
	cd "$builddir"
	for pkg in $(printf "%s" "$subpackages" | tr ' ' '\n'); do
		depends="$depends $pkg=$pkgver-r$pkgrel"
	done
	make INSTALLARGS="--traditional" buildroot="$pkgdir" install
}

_move_item() {
	local bn=$(basename "$1")
	local dn=$(dirname "$1")
	local dst="$2/$dn"
	mkdir -p "$dst"
	mv "$1" "$dst/$bn"
}

_install() {
	local bn=$(basename "$1")
	local dn=$(dirname "$1")
	find "$dn" -maxdepth 1 -name "$bn" | \
		while IFS= read item; do _move_item "$item" "$2"; done
}

bzip2() {
	cd "$pkgdir"
	pkgdesc="$pkgname bzip2 support"
	depends="pike-core=$pkgver-r$pkgrel bzip2"
	_install "usr/lib/pike/modules/*Bz2.*" "$subpkgdir"
}

gdbm() {
	cd "$pkgdir"
	pkgdesc="$pkgname GDBM support"
	depends="pike-core=$pkgver-r$pkgrel gdbm"
	_install "usr/lib/pike/modules/*Gdbm.*" "$subpkgdir"
}

gl() {
	cd "$pkgdir"
	pkgdesc="$pkgname OpenGL/GLUT support"
	depends="pike-core=$pkgver-r$pkgrel freeglut mesa-gl libsm"
	_install "usr/lib/pike/modules/*GL*" "$subpkgdir"
}

gtk() {
	cd "$pkgdir"
	pkgdesc="$pkgname GTK2 support"
	depends="pike-image=$pkgver-r$pkgrel libglade gtk+2.0"
	_install "usr/lib/pike/modules/*GTK2*" "$subpkgdir"
	_install "usr/lib/pike/modules/Tools.pmod/PV.pike" "$subpkgdir"
}

image() {
	cd "$pkgdir"
	pkgdesc="$pkgname image handling modules"
	depends="pike-core=$pkgver-r$pkgrel giflib-utils libjpeg tiff libwebp"
	_install "usr/lib/pike/?.?/modules/Image.pmod" "$subpkgdir"
	_install "usr/lib/pike/modules/Image.so" "$subpkgdir"
	_install "usr/lib/pike/modules/*Image_[!S]*.so" "$subpkgdir"
	_install "usr/lib/pike/modules/*Image*.pmod" "$subpkgdir"
	_install "usr/lib/pike/modules/Graphics.pmod" "$subpkgdir"
	_install "usr/lib/pike/modules/Colors.pmod" "$subpkgdir"
	_install "usr/lib/pike/modules/Protocols.pmod/X.pmod/XImage.pmod" "$subpkgdir"
}

pcre() {
	cd "$pkgdir"
	pkgdesc="$pkgname PCRE support"
	depends="pike-core=$pkgver-r$pkgrel pcre"
	_install "usr/lib/pike/modules/*Regexp_PCRE.*" "$subpkgdir"
}

sdl() {
	cd "$pkgdir"
	pkgdesc="$pkgname SDL support"
	depends="pike-image=$pkgver-r$pkgrel sdl sdl_mixer"
	_install "usr/lib/pike/modules/*SDL.*" "$subpkgdir"
}

svg() {
	cd "$pkgdir"
	pkgdesc="$pkgname SVG support"
	depends="pike-core=$pkgver-r$pkgrel librsvg"
	_install "usr/lib/pike/modules/_Image_SVG.so" "$subpkgdir"
}

sqlite() {
	cd "$pkgdir"
	pkgdesc="$pkgname SQLite support"
	depends="pike-core=$pkgver-r$pkgrel sqlite-libs"
	_install "usr/lib/pike/modules/*SQLite.*" "$subpkgdir"
	_install "usr/lib/pike/modules/Sql.pmod/sqlite*" "$subpkgdir"
}

doc() {
	cd "$pkgdir"
	mkdir -p usr/share/doc/
	mv "$builddir/refdoc/traditional_manual/" usr/share/doc/pike/
	rm -rf usr/doc/
	default_doc
}

core() {
	cd "$pkgdir"
	pkgdesc="Pike's core files and executables"
	depends="gmp nettle nettle-utils zlib readline libgcrypt"
	mkdir -p "$subpkgdir"
	mv usr "$subpkgdir/"
}

sha512sums="9e3a49140698715f80a08428c1e61964d756bb91f69ef0cdc39cd5bf7832d9416eec43063f5ab24e65ffbccbb7f7f75338a40ae6f141d6d1d3b29a29a02ab19f  Pike-v8.0.610.tar.gz"
