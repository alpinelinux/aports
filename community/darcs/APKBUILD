# Contributor: gay <gay@disroot.org>
# Contributor: Celeste <cielesti@protonmail.com>
# Maintainer:
pkgname=darcs
pkgver=2.18.5
pkgrel=1
pkgdesc="Patch-based revision control system"
url="https://darcs.net/"
arch="aarch64 x86_64" # limited by ghc
license="GPL-2.0-or-later"
makedepends="cabal ghc curl-dev ncurses-dev zlib-dev"
checkdepends="diffutils grep lighttpd musl-locales"
options="!check" # tests relying on presence of shell utils fail without giving detailed log
subpackages="$pkgname-doc"
source="https://hackage.haskell.org/package/darcs-$pkgver/darcs-$pkgver.tar.gz
	ghc-9.10.patch
	cabal-3.12.patch
	cabal.project.freeze
	"

# Directory where cabal files are stored.
export CABAL_DIR="${CABAL_DIR:-"$srcdir/dist"}"

cabal_update() {
	local repo="hackage.haskell.org"

	# Default config uses HTTP, change it to HTTPS.
	[ -f "$CABAL_DIR"/config ] || {
		cabal user-config init
		cabal user-config update -a \
			"repository $repo {url: https://$repo/}"
	}

	cd "$startdir"
	[ -d "$builddir" ] || abuild unpack
	msg "Freezing $pkgname dependencies"

	# Resolve deps and generate fresh cabal.project.freeze with version constraints.
	(
		cd "$builddir" || {
			error 'Is $builddir set correctly?'
			return 1
		}
		cabal v2-update
		cabal v2-freeze --shadow-installed-packages

		mv -v cabal.project.freeze "$startdir"/
	)

	if ! abuild checksum; then
		die "Failed to update checksum, run 'abuild checksum' manually"
	fi
}

prepare() {
	default_prepare

	ln -svf "$srcdir"/cabal.project.freeze "$builddir"/
}

build() {
	cabal v2-update
	cabal v2-build darcs:exes \
		--jobs=${JOBS:-1} \
		--prefix=/usr \
		--docdir=/usr/share/doc/$pkgname \
		--sysconfdir=/etc
}

check() {
	cabal test
}

package() {
	cd dist-newstyle/build/*-linux/ghc-*/$pkgname-$pkgver/build/$pkgname
	install -Dm755 $pkgname "$pkgdir"/usr/bin/$pkgname
	install -Dm644 $pkgname.1 "$pkgdir"/usr/share/man/man1/$pkgname.1
}

sha512sums="
858d134e0ad4af1b4adeb4dd8250a34b12358de5993c34ee33c9ebbbe85f5b7bf49e219da7f0cdd254601095c4c70f41430871c2dd7508d5f02f1b141ff1ad4d  darcs-2.18.5.tar.gz
fe5f6904a2918e4860460a302d6ff54fc86941a2e31069a4c68f928ee32c767cffdfcdb3e0e98851ef79cf10ae0b692b95853bed5a7865024b9362fcdd78f770  ghc-9.10.patch
7b679a45826c9fd3c9fea1e49e59d825c2fced7f6c11c3ef3f060f4bc41ab4fcb96c5fc8078395d1ca44fbca942d1a6affaf6fb4869e51ff0d820c0bec2087bc  cabal-3.12.patch
498a36059dd344a1fb2235a42a248da016b7fdef9bd2b8595e9a31d9a4caf9b3aa7fb1b32fb175c7c08f9f370f6deb0251c9da917f9142eeda1784cbc7900688  cabal.project.freeze
"
