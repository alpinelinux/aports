# Contributor: Leo <thinkabit.ukim@gmail.com>
# Maintainer: qaqland <qaq@qaq.land>
pkgname=tl-expected
pkgver=1.3.1
pkgrel=0
pkgdesc="C++11/14/17 std::expected with functional-style extensions"
url="https://tl.tartanllama.xyz/"
arch="noarch"
license="CC0-1.0"
makedepends="cmake samurai"
checkdepends="catch2"
source="$pkgname-$pkgver.tar.gz::https://github.com/TartanLlama/expected/archive/v$pkgver.tar.gz"
builddir="$srcdir/expected-$pkgver"

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		CMAKE_CROSSOPTS="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DEXPECTED_BUILD_TESTS=OFF \
		$CMAKE_CROSSOPTS
	cmake --build build

	# https://github.com/TartanLlama/expected/pull/147
	# build manually to avoid fetching online resources
	local tests=$(find tests -name "*.cpp" ! -name "test.cpp")
	local catch=$(pkg-config --cflags --libs catch2)
	$CXX $tests $catch -Iinclude -Wall -Wextra -o tl-expected-tests
}

check() {
	# https://gitlab.alpinelinux.org/alpine/aports/-/issues/17658
	# skip exception tests
	./tl-expected-tests --nothrow
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	mkdir -p "$pkgdir"/usr/lib
	mv "$pkgdir"/usr/share/cmake "$pkgdir"/usr/lib
}

sha512sums="
764e11097fe6ff18499e0941288fbd1cac91fe68009e077ef803742d48dd38efa8cc57cd6207e7d384f577a11bcb9bff43d3d853ade20340af36fccaaa5d47ed  tl-expected-1.3.1.tar.gz
"
