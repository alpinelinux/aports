# Contributor: Hugo Osvaldo Barrera <hugo@whynothugo.nl>
maintainer="Hugo Osvaldo Barrera <hugo@whynothugo.nl>"
pkgname=ublock-origin
pkgver=1.69.0
pkgrel=0
# to update asset commits, run `abuild _update_assets`
pkgdesc="Efficient blocker add-on for Firefox"
url="https://github.com/gorhill/uBlock"
arch="noarch"
license="GPL-3.0-or-later"
makedepends="git python3 zip bash strip-nondeterminism"
# Upstream's build script pulls latest master for uAssets.
# Pin the versions we use so we don't need network at built-time and the package
# sources are deterministic.
_uassets_master=3a12e45c974f11a491eb6926d6cac37d1100f150
_uassets_ghpages=52a04294ee065c04ac3e805092a62d00cdecbedd
source="ublock-origin-$pkgver.tar.gz::https://github.com/gorhill/uBlock/archive/refs/tags/$pkgver.tar.gz
	uAssets-$_uassets_master.tar.gz::https://github.com/uBlockOrigin/uAssets/archive/$_uassets_master.tar.gz
	uAssets-$_uassets_ghpages.tar.gz::https://github.com/uBlockOrigin/uAssets/archive/$_uassets_ghpages.tar.gz
"
builddir="$srcdir/uBlock-$pkgver"
options="!check" # no tests

_update_assets() {
	msg "Updating assets for $APKBUILD..."

	new_uassets=$(git ls-remote https://github.com/uBlockOrigin/uAssets master | cut -f0)
	new_pages=$(git ls-remote https://github.com/uBlockOrigin/uAssets gh-pages | cut -f0)

	sed -i \
		-e "s|^_uassets_master=.*|_uassets_master=$new_uassets|" \
		-e "s|^_uassets_ghpages=.*|_uassets_ghpages=$new_pages|" \
		$APKBUILD
}

prepare() {
	default_prepare

	mkdir -p dist/build/uAssets
	mv ../uAssets-$_uassets_master dist/build/uAssets/main
	mv ../uAssets-$_uassets_ghpages dist/build/uAssets/prod
}

build() {
	make firefox
	strip-nondeterminism -t zip -T "$SOURCE_DATE_EPOCH" dist/build/uBlock0.firefox.xpi
}

package() {
	install -Dm644 dist/build/uBlock0.firefox.xpi "$pkgdir/usr/lib/firefox/browser/extensions/uBlock0@raymondhill.net.xpi"
}

sha512sums="
2c6ff94aae2ecbc55dacb165b728d7d7c766980e72dfb67161e2f9c36675d2e6c1cf1bff59791970514caa6f4129690fcfdcdde184c56f15f232fd0cfea15319  ublock-origin-1.69.0.tar.gz
a651ec099055a479e5a4bf88ea98acfb870cd80385f14989f5bd66b09acaaeae4ea7010940aa268b6ee764e3c72a775f8b5727c16e4de0cdb7dd80765c98178a  uAssets-3a12e45c974f11a491eb6926d6cac37d1100f150.tar.gz
93897ec7cab7e007ee941e0f59fbafb7b0fcd5815418b5f5392e7d5c2f74d769b50906a7d0d4dcdccfb12435a2e06e28aa12d9177a8ba11f62947de11d2a6968  uAssets-52a04294ee065c04ac3e805092a62d00cdecbedd.tar.gz
"
