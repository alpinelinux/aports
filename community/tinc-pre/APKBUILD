# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer: Carlo Landmeter <clandmeter@gmail.com>
pkgname=tinc-pre
_realver="1.1pre16"
pkgver=${_realver/pre/.}
pkgrel=1
pkgdesc="Virtual Private Network (VPN) daemon (pre-release)"
url="http://tinc-vpn.org/"
# s390x: tests hang
# armhf: tests fail
# aarch64: FAIL: legacy-protocol.test
# disable due to FAIL: legacy-protocol.test
arch=x86_64   #"all !s390x !armhf !armv7 !aarch64"
license="GPL-2.0"
makedepends="linux-headers ncurses-dev readline-dev
	zlib-dev lzo-dev openssl-dev texinfo
	automake autoconf libtool bash"
subpackages="$pkgname-doc"
source="https://tinc-vpn.org/packages/tinc-$_realver.tar.gz
	tinc-1.1-fix-paths.patch
	$pkgname.initd
	$pkgname.confd
	$pkgname.networks
	"
builddir="$srcdir/tinc-$_realver"

prepare() {
	default_prepare
	cd "$builddir"
	autoreconf -fsi
}

build() {
	cd "$builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var \
		--enable-legacy-protocol \
		--enable-curses \
		--enable-readline \
		--enable-zlib \
		--enable-lzo \
		--disable-miniupnpc \
		--enable-jumbograms \
		--without-systemd
	make
}

check() {
	cd "$builddir"
	make check
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir" install
	install -Dm755 "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/tincd
	install -Dm644 "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/tincd
	install -Dm644 "$srcdir"/$pkgname.networks \
		"$pkgdir"/etc/conf.d/tinc.networks
}

sha512sums="b32a0a734a4c8a91bad4cef4177cb45757c97c09dc179da1e3357f2fde48b3b0747587dbac31ecb5400e1553b6712d474a6a1808ac24bce1a3494c1842bb6c43  tinc-1.1pre16.tar.gz
bb6f9a1fedf6ffab21f6bfa65c8d977b24453a5d667229eec995b979bbe8dcdaa0617f076a3d9081c4580068b385f7595b80856d5abcf9c928b866eb9c6f4910  tinc-1.1-fix-paths.patch
59811c3e5241d08ebdfbd539556b7cee0dfaab89727ad503512c98f1a696fae143ecdf2682a652c5d71d077ed254ffe2e1c442b1c305c7e7ea94d9af9a1d385e  tinc-pre.initd
f8d9354af5ebc07420ced98059262751bffef434b61c6333964338f327e2ac01ae676e375954efa794a1bccf8b939c78387b9fb7261f675f1237b0d946b529c9  tinc-pre.confd
f7cb459c170898e51176bd92c642335386db90b7bca2abb3f6eb2514546efbd74e5fd2c8845060111dd48a0dd2cc1890717a03315c9b86185047c259cdc27135  tinc-pre.networks"
