# Contributor: Clayton Craft <clayton@craftyguy.net>
# Maintainer: Clayton Craft <clayton@craftyguy.net>
pkgname=openmw
pkgver=0.49.0
pkgrel=0
pkgdesc="Open-source engine reimplementation for the role-playing game Morrowind"
# Note: only tested on the following archs, may work on others too but not
# adding them until this has been confirmed
arch="x86_64 aarch64"
url="http://www.openmw.org"
license="GPL-3.0-or-later"
makedepends="
	boost-dev
	bullet-dev
	cmake
	doxygen
	ffmpeg-dev
	gtest-dev
	libxt-dev
	luajit-dev
	lz4-dev
	mesa-dev
	mygui-dev
	openal-soft-dev
	openscenegraph-dev
	qt5-qtbase-dev
	qt5-qtsvg-dev
	qt5-qttools-dev
	recastnavigation-dev
	samurai
	sdl2-dev
	tinyxml-dev
	unshield-dev
	yaml-cpp-dev
	"
checkdepends="gtest-dev"
source="
	https://gitlab.com/OpenMW/openmw/-/archive/openmw-$pkgver/openmw-openmw-$pkgver.tar.gz
	gcc15.patch
	"
builddir="$srcdir/openmw-openmw-$pkgver"
options="!check" # need cloning some test files

build() {
	# build OpenMW
	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DBUILD_BENCHMARKS=OFF \
		-DBUILD_COMPONENTS_TESTS=ON="$(want_check && echo ON || echo OFF)" \
		-DBUILD_OPENCS_TESTS=ON="$(want_check && echo ON || echo OFF)" \
		-DBUILD_OPENMW_TESTS=ON="$(want_check && echo ON || echo OFF)" \
		-DBUILD_WITH_CODE_COVERAGE=0 \
		-DOPENMW_USE_SYSTEM_BULLET=ON \
		-DOPENMW_USE_SYSTEM_GOOGLETEST=ON \
		-DOPENMW_USE_SYSTEM_ICU=ON \
		-DOPENMW_USE_SYSTEM_MYGUI=ON \
		-DOPENMW_USE_SYSTEM_OSG=ON \
		-DOPENMW_USE_SYSTEM_RECASTNAVIGATION=ON \
		-DOPENMW_USE_SYSTEM_SQLITE3=ON \
		-DOPENMW_USE_SYSTEM_YAML_CPP=ON \
		-DUSE_SYSTEM_TINYXML=TRUE
	cmake --build build
}

check() {
	ctest --test-dir build
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
ed62af975fb745beb2d425dbfa710cde0df1d75440a2fb2408fc1a9c2256b178bf4882031d810b23fc4743b4348de72de8a28a34ee7c81d57b78cc218ef339f2  openmw-openmw-0.49.0.tar.gz
39b2d9b9ae9c809c79093eeef964d0b38fe9fe4d5dba727b80cc99fae05d9299ddc2feab4f252e9adf51ca02da47bc75a685ddb154a77708e6de95a845aeb89d  gcc15.patch
"
