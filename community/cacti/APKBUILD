# Contributor: Valery Kartel <valery.kartel@gmail.com>
# Maintainer: Jeff Bilyk <jbilyk@gmail.com>
pkgname=cacti
pkgver=1.1.30
pkgrel=0
pkgdesc="The complete rrdtool-based graphing solution"
url="http://www.cacti.net"
arch="all"
license="GPL2+"
options="!check"
pkgusers=$pkgname
pkggroups="$pkgname www-data"
depends="bash perl coreutils net-snmp-tools rrdtool ttf-dejavu"
makedepends="libcap-dev help2man mariadb-dev net-snmp-dev"
subpackages="$pkgname-doc $pkgname-lang $pkgname-setup::noarch $pkgname-spine \
	$pkgname-php5:_php:noarch $pkgname-php7:_php:noarch
	"
install="$pkgname.pre-install $pkgname-setup.post-install $pkgname-setup.post-deinstall"
source="https://www.cacti.net/downloads/$pkgname-$pkgver.tar.gz
	https://www.cacti.net/downloads/spine/$pkgname-spine-$pkgver.tar.gz
	$pkgname.crontab
	$pkgname.nginx.conf
	$pkgname.php-fpm.conf
	"
_cactidir="$srcdir/$pkgname-$pkgver"
_spinedir="$srcdir/$pkgname-spine-$pkgver"
builddir=$_spinedir

prepare() {
	default_prepare

	# fix permissions
	find "$_cactidir"/ -perm 755 -type f -exec chmod -x {} \;
	local dir; for dir in cli scripts; do
		chmod +x "$_cactidir"/$dir/*
		chmod -x "$_cactidir"/$dir/index.php
	done

	sed -i "s:/usr/local/bin/spine:/usr/bin/spine:" "$_cactidir"/install/functions.php
}

build() {
	cd "$builddir"

	./configure \
		--prefix=/usr \
		--sysconfdir=/etc/$pkgname \
		--with-mysql \
		--with-snmp \
		--with-lcap
	make
}

package() {
	cd "$_cactidir"

	mkdir -p "$pkgdir"/usr/share/webapps/$pkgname \
		"$pkgdir"/var/lib/$pkgname \
		"$pkgdir"/var/log

	cp -r * "$pkgdir"/usr/share/webapps/$pkgname

	install -Dm644 "$srcdir"/$pkgname.crontab "$pkgdir"/etc/crontabs/$pkgname

	# install spine
	make -C "$builddir" DESTDIR="$pkgdir" install

	# remove development data
	rm -fr "$pkgdir"/usr/share/webapps/$pkgname/locales/po \
		"$pkgdir"/usr/share/webapps/$pkgname/locales/update-pot.sh

	# switch to system fonts
	rm -fr "$pkgdir"/usr/share/webapps/$pkgname/include/fonts
	ln -s /usr/share/fonts/ttf-dejavu \
		"$pkgdir"/var/lib/$pkgname/fonts
	ln -s /var/lib/$pkgname/fonts \
		"$pkgdir"/usr/share/webapps/$pkgname/include/fonts

	# symlink to help webserver find relative path
	ln -s . "$pkgdir"/usr/share/webapps/$pkgname/$pkgname

	# symlink cli/ to cacti's home
	ln -s /usr/share/webapps/$pkgname/cli "$pkgdir"/var/lib/$pkgname/cli

	# move variable and writable data to cacti's home
	local dir; for dir in cache plugins resource rra scripts; do
		mv "$pkgdir"/usr/share/webapps/$pkgname/$dir \
			"$pkgdir"/var/lib/$pkgname/$dir
		chown -R $pkgname:$pkgname "$pkgdir"/var/lib/$pkgname/$dir
		ln -s /var/lib/$pkgname/$dir "$pkgdir"/usr/share/webapps/$pkgname/$dir
	done
	# make resource and scripts read-only
	local dir; for dir in resource scripts; do
		chown -R root: "$pkgdir"/var/lib/$pkgname/$dir
	done

	# move log to /var/log
	mv "$pkgdir"/usr/share/webapps/$pkgname/log \
		"$pkgdir"/var/log/$pkgname
	chown $pkgname:$pkgname "$pkgdir"/var/log/$pkgname
	ln -s /var/log/$pkgname "$pkgdir"/usr/share/webapps/$pkgname/log

	# move config to /etc
	mv "$pkgdir"/usr/share/webapps/$pkgname/include/config.php \
		"$pkgdir"/etc/$pkgname/config.php || return 1
	chmod 750 "$pkgdir"/etc/$pkgname
	chown :$pkgname "$pkgdir"/etc/$pkgname
	ln -s /etc/$pkgname/config.php \
		"$pkgdir"/usr/share/webapps/$pkgname/include/config.php

	find "$pkgdir" -name ".htaccess" -exec chown root: {} \;
	find "$pkgdir" -name "index.php" -exec chown root: {} \;
}

doc() {
	default_doc

	mkdir -p "$subpkgdir"/usr/share/webapps/$pkgname
	cd "$pkgdir"/usr/share/webapps/$pkgname
	mv docs "$subpkgdir"/usr/share/webapps/$pkgname/

	local file;
	for file in $(find ./ -name "LICENSE" -o -name "NEWS" \
			 -o -name "README*" -o -name "VERSION" \
			 -o -name "CHANGELOG" -o -name "*.rst")
	do
		mkdir -p "$subpkgdir"/usr/share/webapps/$pkgname/${file%/*}
		mv $file "$subpkgdir"/usr/share/webapps/$pkgname/$file
	done

	install -Dm644 "$srcdir"/$pkgname.nginx.conf \
		"$subpkgdir"/usr/share/webapps/$pkgname/docs/txt/nginx.conf
}

lang() {
	pkgdesc="$pkgdesc (localisations)"
	install_if="lang $pkgname=$pkgver-r$pkgrel"
	depends=""

	mkdir -p "$subpkgdir"/usr/share/webapps/$pkgname/locales/LC_MESSAGES \
		"$subpkgdir"/usr/share/webapps/$pkgname/include/js/LC_MESSAGES \
		"$subpkgdir"/usr/share/webapps/$pkgname/include/phpmailer/language

	# cacti l10n
	mv "$pkgdir"/usr/share/webapps/$pkgname/locales/LC_MESSAGES/* \
		"$subpkgdir"/usr/share/webapps/$pkgname/locales/LC_MESSAGES

	# jquery l10n
	mv "$pkgdir"/usr/share/webapps/$pkgname/include/js/LC_MESSAGES/* \
		"$subpkgdir"/usr/share/webapps/$pkgname/include/js/LC_MESSAGES

	# phpmailer l10n
	mv "$pkgdir"/usr/share/webapps/$pkgname/include/phpmailer/language/*lang*.php \
		"$subpkgdir"/usr/share/webapps/$pkgname/include/phpmailer/language
}

setup() {
	pkgdesc="$pkgdesc (initial setup)"
	depends="$pkgname $pkgname-doc mariadb-client"

	mkdir -p "$subpkgdir"/usr/share/webapps/$pkgname
	mv "$pkgdir"/usr/share/webapps/$pkgname/install \
		"$pkgdir"/usr/share/webapps/$pkgname/*.sql \
		"$subpkgdir"/usr/share/webapps/$pkgname/
}

spine() {
	license="LGPL-2.1"
	pkgdesc="A high speed poller for Cacti"
	depends=""
	mkdir -p "$subpkgdir"/etc/$pkgname "$subpkgdir"/usr
	chmod 750 "$subpkgdir"/etc/$pkgname
	chown :$pkgname "$subpkgdir"/etc/$pkgname
	mv "$pkgdir"/etc/$pkgname/spine.conf.dist \
		"$subpkgdir"/etc/$pkgname/spine.conf
	mv "$pkgdir"/usr/bin "$subpkgdir"/usr
}

_php() {
	local php=${subpkgname#$pkgname-}
	pkgdesc="$pkgdesc ($php dependencies)"
	install_if="$php-config $pkgname=$pkgver-r$pkgrel"
	depends="$php $php-gd $php-gmp $php-json $php-ldap $php-mbstring $php-pdo_mysql
		$php-openssl $php-posix $php-session $php-simplexml $php-snmp $php-sockets
		$php-xml $php-zlib"

	# cacti's php-fpm pool config
	install -Dm644 "$srcdir"/$pkgname.php-fpm.conf \
		"$subpkgdir"/etc/$php/php-fpm.d/$pkgname.conf
}

sha512sums="2516deffcbd5a2394b2fdde0359f9a52eeabe019d340ebd7c9f26de454984243760b54733fd4d0e63e3d04fc2b511d3e0066bfc8ed9aaa6374c809705d06e828  cacti-1.1.30.tar.gz
b3592fbef2569e844360deff263af4bfc08633292c2dbcfbd431d6c27a644095804f6683a7c96ce6c2c8f2ec3f5f645b787ac7b061ff7f8501853dc5619e3ed6  cacti-spine-1.1.30.tar.gz
70f47dbbca76489fc3a84452ee8065f9571ee627b3e346cd3c866501d723a609372c4fbd7e53c4bdcdb22439d876d78847f8902dfa43f3f66b2329639e795ab9  cacti.crontab
9b3fe765c6196c0e4988efaa7236d8a8b945725548371b4a0e2a371de374c9577a908d58dcef5a4e59e089ca923cfeb7c5ddea9ee983a5115239052cf9b8ab59  cacti.nginx.conf
056358fc69752fb5129729db91a22d06c97ca452068017ccfe0ede8f2bf42f62e5072415c7db2eb5b9346d6bc54092bc147044e40b2156d8037dfee4a7e55e5b  cacti.php-fpm.conf"
