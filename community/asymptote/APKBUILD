# Contributor: Julian Weigt <juw@posteo.de>
# Contributor: Celeste <cielesti@protonmail.com>
# Maintainer: John Vogel <jvogel@stygian.me>
maintainer="John Vogel <jvogel@stygian.me>"
pkgname=asymptote
pkgver=3.06
pkgrel=0
pkgdesc="Vector graphics language for technical drawing"
url="https://asymptote.sourceforge.io/"
arch="all !s390x !armhf" # s390x blocked by texlive, armhf block by pyside6
license="LGPL-3.0-or-later"
depends="
	dvisvgm
	ghostscript
	perl
	py3-cson
	py3-graphviz
	py3-numpy
	py3-pyside6
	py3-qt6
	py3-rapidjson
	pyside6
	python3
	rsvg-convert
	texlive
	texlive-context
	texlive-dvi
	"
makedepends="
	autoconf
	automake
	bison
	cmake
	curl-dev
	doxygen
	eigen-dev
	fftw-dev
	flex
	freeglut-dev
	gc-dev
	glm-dev
	gsl-dev
	libsigsegv-dev
	libtirpc-dev
	libtool
	ncurses-dev
	py3-numpy-dev
	pyside6-dev
	qt6-qtbase
	readline-dev
	samurai
	texinfo
	texmf-dist-lang
	texmf-dist-context
	texmf-dist-latexextra
	texmf-dist-plaingeneric
	utfcpp
	zlib-dev
	"

subpackages="$pkgname-doc"
source="https://downloads.sourceforge.net/sourceforge/asymptote/asymptote-$pkgver.src.tgz
	asymptote-2.92-xdg-utils.patch
	asymptote-3.05-gc-link-fix.patch
	"

prepare() {
	default_prepare

	# pyside6-tools is not packaged, but these wrapper around qt's uic and rcc
	# tools do well enough for now.
	mkdir -p "$srcdir"/bin
	cat <<-EOF > "$srcdir"/bin/pyside6-uic
#!/bin/sh
exec /usr/lib/qt6/libexec/uic -g python \$@
EOF

	cat <<-EOF > "$srcdir"/bin/pyside6-rcc
#!/bin/sh
exec /usr/lib/qt6/libexec/rcc -g python \$@
EOF

	chmod +x "$srcdir"/bin/pyside6-uic "$srcdir"/bin/pyside6-rcc

	autoreconf -vif
}

build() {
	# Since we are installing this from outside of the texlive sources, we use
	# TEXMFLOCAL for asymptote's texmf files, else they conflict with the ones
	# installed from texmf-dist-binextra.
	local _texmf_dist="$(kpsewhich -expand-var '$TEXMFLOCAL')"

	# Needed for LspCpp, else it fails because a makefile is not generated.
	export CMAKE_GENERATOR="Unix Makefiles"

	# Put our uic/rcc wrappers at the front of our PATH
	local _oldpath="$PATH"
	export PATH="$PATH:$srcdir/bin"

	./configure \
		--prefix=/usr \
		--with-latex="$_texmf_dist/tex/latex" \
		--with-context="$_texmf_dist/tex/context" \
		--enable-offscreen=no

	make all

	export PATH="$_oldpath"
}

check() {
	make check
}

package() {
	DESTDIR="$pkgdir" make install-all

	install -Dm644 -t "$pkgdir/usr/share/doc/$pkgname" README
	install -Dm644 -t "$pkgdir/usr/share/licenses/$pkgname" \
		LICENSE LICENSE.LESSER
}

sha512sums="
d0dfc3ecefe9b46a52c194cf80e2efe36845cce67e3bad7eee6b30e00629145cbefbdfabab6a6950e1a711eb801c7a815491b6755b2714722f030b58bec44e2e  asymptote-3.06.src.tgz
3a5bb68a43100d8759ce8c6302251bcfc46a883ec1ab204d9d1adecc4363e6626cea377139f85712fe99e9b2bc79a8060d0edc3054c393f795e1082a70c3d3cf  asymptote-2.92-xdg-utils.patch
a1578a3c603546be20a4f891a7cb17b67ca9eebf3acc12fde21feb65a1301dd574d525ed8ea609cd9011d637ea14c1e9d585a943db94af5dc521748f166168bb  asymptote-3.05-gc-link-fix.patch
"
