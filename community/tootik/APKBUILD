# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=tootik
pkgver=0.20.6
pkgrel=0
pkgdesc="Federated nanoblogging service with Gemini frontend"
url="https://github.com/dimkr/tootik"
# riscv64: tests fail in CI, even with the 3 retries
arch="all !riscv64"
license="Apache-2.0"
depends_openrc="openssl"
makedepends="go sqlite-dev"
install="$pkgname.pre-install"
pkgusers="tootik"
pkggroups="tootik"
subpackages="$pkgname-openrc"
source="https://github.com/dimkr/tootik/archive/refs/tags/v$pkgver/tootik-$pkgver.tar.gz
	tootik.cfg
	tootik.initd
	tootik.confd
	"

export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

export CGO_ENABLED=1
export _GOTAGS="libsqlite3 fts5"

build() {
	local _goldflags="
		-X github.com/dimkr/tootik/buildinfo.Version=$pkgver
		"

	go generate -v ./migrations
	go vet -v -tags "$_GOTAGS" ./...
	go build -v -ldflags "$_goldflags" -tags "$_GOTAGS" ./cmd/tootik
}

check() {
	./tootik --version

	local i; for i in $(seq 0 3); do
		[ $i -eq 0 ] || msg "Retrying ($i/3)..."

		# cleanup sqlite database files used by test/register_test.go
		rm -vf /tmp/TestRegister*.sqlite3

		go test -v -tags "$_GOTAGS" -timeout 30m ./... && return 0
		sleep 5
	done
	return 1
}

package() {
	install -Dm755 tootik -t "$pkgdir"/usr/bin/
	install -dm750 -o tootik -g tootik "$pkgdir"/var/lib/tootik

	install -dm750 -o tootik -g tootik "$pkgdir"/etc/tootik
	install -Dm640 -o tootik -g tootik "$srcdir"/tootik.cfg \
		-t "$pkgdir"/etc/tootik/

	install -Dm755 "$srcdir"/tootik.initd "$pkgdir"/etc/init.d/tootik
	install -Dm644 "$srcdir"/tootik.confd "$pkgdir"/etc/conf.d/tootik
}

sha512sums="
02709f652316d38d35c0054aac43c2db3a3bfb57d9f97b55583cf347333c38296430c15b5e4e2600f0fad0263989a16091ccfcf62c005b2485f2d87a8165147b  tootik-0.20.6.tar.gz
796cfe324fb70ed776b3bb1a6eb014bf037dfd61c6aa35a86abcd755d300d3988e1e61b92a8ae00e88f54af0c8516d139685f282763ac1c388d6ba58f5e225bb  tootik.cfg
b5fef270015b325021c85474cef6132203aa9dacd89ca990b01f5e5fabac13e8fb669d297b5cb07daa4e5ce4826675e6784de6ceaa24ecd88a688d204543d698  tootik.initd
ba4e25149d343142308c17adc6d6df1424138bd4b8cbb4c9495fb00416e543d2c1c6b8ddccab84aec58fe3cc095ce8283f47bef51faf2982f5c38398c9009dc9  tootik.confd
"
