# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=keyd
pkgver=2.5.0
pkgrel=1
pkgdesc="A key remapping daemon for Linux"
url="https://github.com/rvaiya/keyd"
arch="all"
license="MIT"
makedepends="cmd:scdoc linux-headers"
install="$pkgname.pre-install $pkgname.pre-upgrade"
subpackages="
	$pkgname-application-mapper:application_mapper:noarch
	$pkgname-doc
	$pkgname-openrc
	$pkgname-systemd
	"
source="$pkgname-$pkgver-2.tar.gz::https://github.com/rvaiya/keyd/archive/v$pkgver/keyd-$pkgver.tar.gz
	musl-time64.patch
	fix-makefile.patch
	rm-groupadd-from-makefile.patch
	var-run-to-run.patch
	$pkgname.initd
	"
options="!check"  # doesn't work on CI

build() {
	make
	make man
}

check() {
	make test
}

package() {
	# Enable installation of quirks file.
	mkdir -p "$pkgdir"/usr/share/libinput

	make install DESTDIR="$pkgdir" PREFIX=/usr

	install -D -m755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	echo uinput | install -D -m644 /dev/stdin "$pkgdir"/usr/lib/modules-load.d/$pkgname.conf

	install -Dm644 keyd.service -t "$pkgdir"/usr/lib/systemd/system/
}

application_mapper() {
	pkgdesc="$pkgdesc - application specific remapping"
	depends="$pkgname=$pkgver-r$pkgrel python3"

	amove usr/bin/keyd-application-mapper
}

sha512sums="
71717b6a72b047c2891bdfeb393c93a004f7a2e673ba07f6b3bcf66f89c9185c3edb1dcf983525d48afd58472793901dceb55fb9fcf51900705d3fabc55cf73a  keyd-2.5.0-2.tar.gz
2c9340cda19f6b64ec6be02f79caec83d7bf21c6813081fb763615c03969dd7050281b61fa3951635eaa953f99520b875d5b1b088c083ff1154ffe50bbdb6fd1  musl-time64.patch
5c4e7e3607a60c01631db4bd9107cc4b61b608e78320032fb42087ade6459c359df633ecf1b2ec5c4a36940f6e73f922e54583a1b470843e33f3c5af6201f054  fix-makefile.patch
0dc1fbba6316a260b7aa8ccad7556372ca36205aa24f1adee8793bfb6c91635608a260ffd8facc63bcac54ec0c8e62cc59389d2e2e2eff952838e293ffbccd20  rm-groupadd-from-makefile.patch
f02b71e890c05d7f130f2021f23201325484f53c04b21dbd1241006b9b7398d972bda67a9a8e5b563518293617c65bed6641806cbbffd376da4b5c6076acd8e8  var-run-to-run.patch
5fb22510cd89ce23e347773d2b49a7be5b342899f1653f8dbac1ca0a85dca54091be3f165dd0952a9384851c109ab6b20ec3dfa15dc7c6b7ce53d46e1723b2e2  keyd.initd
"
