# Maintainer: Stuart Cardall <developer@it-offshore.co.uk>
pkgname=bitcoin
pkgver=30.0
pkgrel=0
pkgdesc="Decentralized P2P electronic cash system"
url="https://www.bitcoincore.org/"
# x86: segfault in check
arch="all !x86"
license="MIT"
makedepends="boost-dev capnproto-dev chrpath cmake db-dev doxygen graphviz libevent-dev
	libqrencode-dev protobuf-dev qt6-qtbase-dev qt6-qttools-dev qt6-qtwayland samurai zeromq-dev"
install="$pkgname.post-install $pkgname.post-upgrade $pkgname.pre-install"
subpackages="$pkgname-qt $pkgname-cli $pkgname-tx $pkgname-tests $pkgname-bench
	$pkgname-doc $pkgname-openrc"
source="https://bitcoincore.org/bin/bitcoin-core-$pkgver/bitcoin-$pkgver.tar.gz
	ssize_t.patch
	use-c-locale.patch
	$pkgname.initd
	$pkgname.conf
	"

build() {
	cmake -B build -G Ninja \
		-DBoost_INCLUDE_DIRS=/usr/include/boost \
		-DBUILD_BENCH=ON \
		-DBUILD_GUI=ON \
		-DBUILD_SHARED_LIBS=ON \
		-DCMAKE_INSTALL_LIBDIR=/usr/lib \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DENABLE_IPC=ON \
		-DENABLE_WALLET=ON \
		-DWITH_CCACHE=OFF \
		-DWITH_ZMQ=ON
	cmake --build build
}

check() {
	ctest --test-dir build
}

package() {
	DESTDIR="$pkgdir" cmake --install build
	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -m600 -D "$srcdir"/$pkgname.conf "$pkgdir"/etc/$pkgname.conf
	rm -f "$pkgdir"/usr/lib/*.la
}

qt() {
	pkgdesc="Bitcoin with a Qt frontend & QR Code support"
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/$pkgname-qt "$subpkgdir"/usr/bin/
}

cli() {
	pkgdesc="Bitcoin CLI"
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/$pkgname-cli "$subpkgdir"/usr/bin/
}

tx() {
	pkgdesc="Bitcoin TX (Transaction Tool)"
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/$pkgname-tx "$subpkgdir"/usr/bin/
}

tests() {
	pkgdesc="Bitcoin & Bitcoin-QT Unit Tests"
	mkdir -p "$subpkgdir"/usr/bin
	chrpath -d "$pkgdir"/usr/libexec/test_$pkgname
	mv "$pkgdir"/usr/libexec/test_$pkgname-qt "$subpkgdir"/usr/bin/
	mv "$pkgdir"/usr/libexec/test_$pkgname "$subpkgdir"/usr/bin/
}

bench() {
	pkgdesc="Bitcoin Benchmarking Tools"
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/libexec/bench_$pkgname "$subpkgdir"/usr/bin/
}

sha512sums="
70f0cd08cccb0b6668dc829d73ef93bd2c9cfba26b2a0ff8057db21d2ce387c7e0f60ab90019fffe9adf5c87f7ea78279f24169d5db29cf8edf9719668a8176a  bitcoin-30.0.tar.gz
b150ed46dc8ae230acd1ac1930936670f4195bf1bdd3fefaf743919b99a2de3a8ec5d0012df3b1b1280f3f31abf961ab02de461742799bffbeda7bfe5e0adb14  ssize_t.patch
13857b5391ecb60f68a150ba98c840cb7dad8eb5e476e867337383cfe3b25ec05e8f39216443399f5d6c9a5d8bfcbc8dacf70e3f7280ca7279cf1f789443a1d5  use-c-locale.patch
c88ca4f0c8a3179dbac274db1719983352caa5074b236e59d8fe31ab45ffa99bd90c1a566c4459261a9dcdcc990b826f3466c77aa7a32cf9fb15529a510ac7fd  bitcoin.initd
a65a81b8c58639f6aaa41b94425f1d5e31ebc25f682a51e0a80865caf96eaa0642ccba485bb9182743d3aabb624e5b4d0dd804172263d82e93bf32554913e2f3  bitcoin.conf
"
