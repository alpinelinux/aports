# Contributor: Guy Godfroy <guy.godfroy@gugod.fr>
# Maintainer: Guy Godfroy <guy.godfroy@gugod.fr>
pkgname=haproxy-dataplaneapi3
_pkgname=dataplaneapi
pkgver=3.2.5
pkgrel=1
pkgdesc="HAProxy data plane API"
url="https://github.com/haproxytech/dataplaneapi"
# loongarch64: incompatible github.com/shirou/gopsutil
arch="all !loongarch64"
license="Apache-2.0"
provides="haproxy-dataplaneapi=$pkgver"
makedepends="go"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc"
source="$_pkgname-$pkgver.tar.gz::https://github.com/haproxytech/dataplaneapi/archive/refs/tags/v$pkgver.tar.gz
	haproxy-dataplaneapi.initd
	haproxy-dataplaneapi.confd
	dataplaneapi.yml
	"
options="net"
builddir="$srcdir/$_pkgname-$pkgver"

build() {
	export LD_FLAGS="\
		-X main.Version=$pkgver \
		-X main.GitTag=$pkgver \
		-X main.GitCommit=release \
		-X main.GitDirty= \
		-X main.GitRepo=$url \
		-X main.BuildTime=$(date -u '+%Y-%m-%dT%H:%M:%SZ') \
		"
	go build -ldflags="$LD_FLAGS" -o dataplaneapi $builddir/cmd/dataplaneapi/main.go
}

check() {
	# TestReloadAgentDoesntMissReloads needs systemd
	go test -skip TestReloadAgentDoesntMissReloads ./...
}

package() {
	install -m755 -D "$builddir"/dataplaneapi \
		"$pkgdir"/usr/bin/dataplaneapi
	install -m644 -D "$srcdir"/dataplaneapi.yml \
		"$pkgdir"/etc/haproxy/dataplaneapi.yml
	install -m755 -D "$srcdir"/haproxy-dataplaneapi.initd \
		"$pkgdir"/etc/init.d/haproxy-dataplaneapi
	install -m644 -D "$srcdir"/haproxy-dataplaneapi.confd \
		"$pkgdir"/etc/conf.d/haproxy-dataplaneapi
}

sha512sums="
e990acf29e74de7cb303ad4eb6bb53677ef6a01bb14e595189f030c4ec65ac6a7a44faab1c4b204dc9b1f755b3718b16eb791a7a7ea5b74a3941d983cd642301  dataplaneapi-3.2.5.tar.gz
b9bb89b429acde6513a6a5a62fba14cf265bf4d84fc81ec0cf91256b36a46bc03bda967081a8797f4ddf90b4276e7bee97056825b59a757b6bf0f628fcde3cc4  haproxy-dataplaneapi.initd
76c173820d513de762e6834ad3dcaf53695d2a8f6bb2340c0a50be769fdb9abd1a63a254d5ea4a51bcf8d7a8edd1d9b531aa73974cffbed5d95be05e111b2211  haproxy-dataplaneapi.confd
95b843518ecc90c0bf052982c12a4de5f2b3d2d98fc831a85ad22508ba25b01739e1d3cd8318c22369771dad765f2e45059cb5094b8456be6bbc084bff3136be  dataplaneapi.yml
"
