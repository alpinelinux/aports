# Maintainer: Simon Zeni <simon@bl4ckb0ne.ca>
pkgname=hare
pkgver=0.26.0
pkgrel=1
pkgdesc="The Hare systems programming language"
url="https://harelang.org"
arch="aarch64 riscv64 x86_64"
license="MPL-2.0 AND GPL-3.0-only"
depends="qbe harec binutils cmd:cc cmd:as cmd:ld"
makedepends="scdoc"
checkdepends="tzdata"
subpackages="$pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://git.sr.ht/~sircmpwn/hare/archive/$pkgver.tar.gz
	0001-hare-parse-fix-crash-on-invalid-input.patch
	config.mk
	"

prepare() {
	default_prepare

	cp "$srcdir"/config.mk config.mk

	sed -i "s/@CARCH@/$CARCH/g" config.mk
	sed -i "s/@VERSION@/$pkgver-alpine/g" config.mk

	# use unprefixed toolchain for local target
	sed -i "s/\(${CARCH}_..\)=$CHOST-/\1=/Ig" config.mk
}

build() {
	make
}

check() {
	make HARETEST_INCLUDE='slow' HARECACHE=.testcache check
}

package() {
	make DESTDIR="$pkgdir" install
}

sha512sums="
3b3e4625f63b3ea5650bbb4c6e690b874292cae85a749cc602a120fa07437a491a0c4fba414565141e7de9b3736fde8d3ba7597b91f7f0d3fa4e95938a11ae77  hare-0.26.0.tar.gz
9b0e03fd1810ffe86dabbf25d493f9fa249e15ff244dc86e7478d5a4e6238227a084759492c810a1a65123c0b09fbb86075c601deb4ce4f431fecebee8196191  0001-hare-parse-fix-crash-on-invalid-input.patch
8e8a8a9f24c89e24e6f6fad8370d31061294285d3f28195b42b4ee1a658cb9bf9019acb28c41370ae244bab77e9f9a954b908703b1224ce754253411e09a7bc3  config.mk
"
