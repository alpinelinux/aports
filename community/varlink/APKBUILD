# Contributor: Adam Thiede <me@adamthiede.com>
# Maintainer: Adam Thiede <me@adamthiede.com>
pkgname=varlink
pkgver=24.0.1
pkgrel=0
pkgdesc="Varlink C library and command-line tool"
url="https://github.com/varlink/libvarlink"
arch="all"
license="Apache-2.0"
makedepends="meson"
checkdepends="bash"
subpackages="$pkgname-dev libvarlink:libs $pkgname-bash-completion $pkgname-vim::noarch"
source="$pkgname-$pkgver.tar.gz::https://github.com/varlink/libvarlink/archive/refs/tags/v$pkgver.tar.gz"
builddir="$srcdir/libvarlink-$pkgver"

# tests fail on ppc64le
# upstream issue: https://github.com/varlink/libvarlink/issues/63
case "$CARCH" in
ppc64le*) options="$options !check" ;;
esac

build() {
	abuild-meson . output
	meson compile -C output
}

check() {
	meson test --print-errorlogs -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
}

vim() {
	pkgdesc="$pkgdesc (vim syntax)"
	install_if="vim $pkgname=$pkgver-r$pkgrel"

	amove usr/share/vim
}

sha512sums="
712dd827a850f06c35cbe93e8517127d3bc0709b3d057dc63d0aea7143a630490da194dc26c75e6a97db1c3adac528a3c5f0b9cfb5fa647cb898d2d5f50b443e  varlink-24.0.1.tar.gz
"
