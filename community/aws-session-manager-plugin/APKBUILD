# Contributor: Will Sinatra <wpsinatra@gmail.com>
# Maintainer: Will Sinatra <wpsinatra@gmail.com>
pkgname=aws-session-manager-plugin
pkgver=1.2.779.0
pkgrel=1
pkgdesc="AWS Session Manager Plugin for aws-cli."
url="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html"
license="Apache-2.0"
arch="all !loongarch64" # blocked by amazon-ssm-agent
depends="aws-cli amazon-ssm-agent"
makedepends="go"
source="$pkgname-$pkgver.tar.gz::https://github.com/aws/session-manager-plugin/archive/refs/tags/$pkgver.tar.gz
	002_version_go.patch
	003_version.patch
	ssmcli.initd
	session-manager-plugin.initd"
options="!check"
builddir="$srcdir/session-manager-plugin-$pkgver"
subpackages="$pkgname-openrc"

export GOPATH="$builddir/build/private:$builddir/vendor"
export GO111MODULE=auto

build() {
	make copy-src
	go build -ldflags "-s -w" -o session-manager-plugin -v src/sessionmanagerplugin-main/main.go
	go build -ldflags "-s -w" -o ssmcli -v src/ssmcli-main/main.go
}

package() {
	#ssmcli
	install -Dm0755 "$builddir"/ssmcli -t "$pkgdir"/usr/bin/
	install -Dm0644 "$builddir"/seelog_unix.xml -t "$pkgdir"/etc/amazon/ssmcli/seelog.xml

	#session-manager-plugin
	install -Dm0755 "$builddir"/session-manager-plugin -t "$pkgdir"/usr/bin/
	install -Dm0644 "$builddir"/seelog_unix.xml -t "$pkgdir"/etc/amazon/sessionmanagerplugin/seelog.xml
	install -Dm0644 "$builddir"/seelog_windows.xml.template -t "$pkgdir"/etc/amazon/sessionmanagerplugin/

	install -Dm0755 "$srcdir"/session-manager-plugin.initd -t "$pkgdir"/etc/init.d/session-manager-plugin
	install -Dm0755 "$srcdir"/ssmcli.initd -t "$pkgdir"/etc/init.d/ssmcli
}

sha512sums="
65f4ee2b1e7e4c73be2c846814c716c25e515d6e020ee19016e0be8eebb1d0b1f541a969288430721f66dc98a0dc4c504f8eaade92bab5c1f8db4bc343cd6c45  aws-session-manager-plugin-1.2.779.0.tar.gz
8797f2dcd1cdaa40e1ffb74baabee114f18c9523bb9393312976886eefe33b84f6e6fd9ba07ccb41d8719df75efc6e0c764d255e5604cecb952e260ba11db32d  002_version_go.patch
55b1da328040101706dae29847d96bbca37adf8cb86d66b0f380c509ff5b33974bfe36450f0f7ba416d108e64ff8611ac1f3ac072a26064d0bd76529493ddfda  003_version.patch
5e08d65a18117bcf821fea79ae03c69063196c116864ae7261ab58a07000c3dc04d53cdab50a47461ab2b08421f0d63a4c349d91d05223634cc8e4f1af8bca74  ssmcli.initd
c0c9a0f24005b0c0c609a82b7754f41a5511a730d6cf5a74f01c427596c5e676f9a96077cb917530ded49dca06a916cde62152f006a3856f9313d7681dc6ebf5  session-manager-plugin.initd
"
