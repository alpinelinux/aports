# Contributor: Timo Ter√§s <timo.teras@iki.fi>
# Maintainer: DWwanghao <wanghao03@loongson.cn>
maintainer="DWwanghao <wanghao03@loongson.cn>"
pkgname=vigra
pkgver=1.12.3
pkgrel=0
pkgdesc="An image processing and analysis library"
url="http://ukoethe.github.io/vigra/"
arch="all"
license="MIT"
depends_dev="tiff-dev libjpeg-turbo-dev libpng-dev boost-dev"
makedepends="$depends_dev
	cmake
	doxygen
	python3-dev
	py3-numpy
	py3-numpy-dev
	py3-setuptools
	py3-sphinx
	samurai
	"
checkdepends="py3-pytest"
subpackages="$pkgname-dev $pkgname-doc py3-$pkgname:_py"
source="vigra-$pkgver.tar.gz::https://github.com/ukoethe/vigra/archive/refs/tags/Version-${pkgver//./-}.tar.gz
	broken-workaround.patch
	"
builddir="$srcdir/vigra-Version-${pkgver//./-}"

build() {
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DDOCINSTALL=share/doc \
		-DCREATE_CTEST_TARGETS=ON \
		-DAUTOEXEC_TESTS=OFF \
		-DAUTOBUILD_TESTS="$(want_check && echo ON || echo OFF)"
	cmake --build build
	cmake --build build --target doc
}

check() {
	case "$CARCH" in
		# FIXME tests fail
		aarch64|loongarch64|ppc64le|riscv64|s390x) ctest --test-dir build -E 'test_math|test_multiconvolution' ;;
		*) ctest --test-dir build ;;
	esac
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	# relocate cmake include files
	mkdir -p "$pkgdir"/usr/lib/cmake
	mv "$pkgdir"/usr/lib/vigra* "$pkgdir"/usr/lib/cmake
}

_py() {
	amove usr/lib/python\*
}

sha512sums="
e2f28ded5538fb088409f51bb1c210c951b7a5ab1611f94b329d66e7b4b6903715bdbbb3d5f2ef927ed282b548fd067b6d8527409236f72346bd7780a5a5799a  vigra-1.12.3.tar.gz
83d6728989d91d6d97562f084055f3bda11285197533e2c6a465d7bbb71bdb3c4d976540eba3504a7900242d769c102783663c9ab6d5fd5fe57ceacaeba45bc0  broken-workaround.patch
"
