From 0d94de761ce96cd071d23e16b083642d41f85186 Mon Sep 17 00:00:00 2001
PatchSource: https://github.com/dotnet/installer/pull/14549
From: Tom Deseyn <tom.deseyn@gmail.com>
Date: Tue, 20 Sep 2022 08:16:44 +0200
Subject: [PATCH 1/1] Eliminate portable runtime build.

---
 .../tools/SourceBuildArcadeTarball.targets    |   4 -
 .../tarball/content/Directory.Build.props     |   8 -
 .../tarball/content/repos/aspnetcore.proj     |   1 +
 .../tarball/content/repos/installer.proj      |   2 +-
 .../tarball/content/repos/known-good.proj     |   1 -
 .../content/repos/package-source-build.proj   |   2 +-
 .../content/repos/runtime-portable.proj       |  47 ---
 .../content/repos/runtime.common.props        |  47 ---
 .../content/repos/runtime.common.targets      |  46 ---
 .../tarball/content/repos/runtime.proj        |  86 ++++-
 .../source-build-reference-packages.proj      |   5 +-
 .../aspnetcore/0004-non-portable-build.patch  | 337 ++++++++++++++++++
 .../installer/0001-non-portable-build.patch   | 156 ++++++++
 .../installer/0002-crossgen2-rid.patch        |  25 ++
 .../patches/runtime/0004-update-graph.patch   | 127 +++++++
 .../runtime/0005-non-portable-build.patch     |  45 +++
 .../runtime/0006-Pass-source-build-args.patch | 243 +++++++++++++
 ...nCompilers-map-non-portable-rids-whe.patch |  91 +++++
 18 files changed, 1114 insertions(+), 159 deletions(-)
 delete mode 100644 src/SourceBuild/tarball/content/repos/runtime-portable.proj
 delete mode 100644 src/SourceBuild/tarball/content/repos/runtime.common.props
 delete mode 100644 src/SourceBuild/tarball/content/repos/runtime.common.targets
 create mode 100644 src/SourceBuild/tarball/patches/aspnetcore/0004-non-portable-build.patch
 create mode 100644 src/SourceBuild/tarball/patches/installer/0001-non-portable-build.patch
 create mode 100644 src/SourceBuild/tarball/patches/installer/0002-crossgen2-rid.patch
 create mode 100644 src/SourceBuild/tarball/patches/runtime/0004-update-graph.patch
 create mode 100644 src/SourceBuild/tarball/patches/runtime/0005-non-portable-build.patch
 create mode 100644 src/SourceBuild/tarball/patches/runtime/0006-Pass-source-build-args.patch
 create mode 100644 src/SourceBuild/tarball/patches/sdk/0003-ResolveReadyToRunCompilers-map-non-portable-rids-whe.patch

diff --git a/Directory.Build.props b/Directory.Build.props
index 860785575..633ea886c 100644
--- a/Directory.Build.props
+++ b/Directory.Build.props
@@ -23,14 +23,6 @@
     <Platform Condition="'$(Platform)' == ''">x64</Platform>
 
     <UseStableVersions Condition="'$(UseStableVersions)' == ''">false</UseStableVersions>
-
-    <!-- new supported portable/nonportable options.  These control whether to build portable runtime
-         or portable SDK.  The PortableBuild flag is only set in runtime-portable.proj and should
-         no longer be passed in.  -->
-    <BuildPortableRuntime Condition="'$(BuildPortableRuntime)' == ''">false</BuildPortableRuntime>
-    <BuildPortableSdk Condition="'$(BuildPortableSdk)' == ''">false</BuildPortableSdk>
-    <UseSystemLibraries Condition="'$(UseSystemLibraries)' == '' AND '$(PortableRuntime)' != 'true'">true</UseSystemLibraries>
-    <UseSystemLibraries Condition="'$(UseSystemLibraries)' == ''">false</UseSystemLibraries>
   </PropertyGroup>
 
   <!-- This repo's projects are entirely infrastructure and do not ship. -->
diff --git a/repos/aspnetcore.proj b/repos/aspnetcore.proj
index a779e9213..5b2dfacbc 100644
--- a/repos/aspnetcore.proj
+++ b/repos/aspnetcore.proj
@@ -9,6 +9,7 @@
     <BuildCommandArgs>$(BuildCommandArgs) --no-build-repo-tasks</BuildCommandArgs>
     <BuildCommandArgs>$(BuildCommandArgs) --no-build-nodejs</BuildCommandArgs>
     <BuildCommandArgs>$(BuildCommandArgs) /p:PublishCompressedFilesPathPrefix=$(SourceBuiltAspNetCoreRuntime)</BuildCommandArgs>
+    <BuildCommandArgs>$(BuildCommandArgs) /p:PortableBuild=false /p:TargetRuntimeIdentifier=$(TargetRid)</BuildCommandArgs>
     <!-- Update to 1.0.0 version of reference assemblies which are built in SBRP instead of the preview.2 version
          included by Arcade -->
     <BuildCommandArgs>$(BuildCommandArgs) /p:MicrosoftNetFrameworkReferenceAssembliesVersion=1.0.0</BuildCommandArgs>
diff --git a/repos/installer.proj b/repos/installer.proj
index f6803f4cf..1a644b359 100644
--- a/repos/installer.proj
+++ b/repos/installer.proj
@@ -25,7 +25,7 @@
     <BuildCommandArgs Condition="'$(TargetOS)' == 'Linux'">$(BuildCommandArgs) /p:Rid=$(TargetRid)</BuildCommandArgs>
     <BuildCommandArgs>$(BuildCommandArgs) /p:DOTNET_INSTALL_DIR=$(DotNetCliToolDir)</BuildCommandArgs>
 
-    <BuildCommandArgs Condition="'$(TargetOS)' == 'Linux'">$(BuildCommandArgs) /p:AspNetCoreInstallerRid=linux-$(Platform)</BuildCommandArgs>
+    <BuildCommandArgs Condition="'$(TargetOS)' == 'Linux'">$(BuildCommandArgs) /p:AspNetCoreInstallerRid=$(TargetRid)</BuildCommandArgs>
     <!-- core-sdk always wants to build portable on OSX and FreeBSD -->
     <BuildCommandArgs Condition="'$(TargetOS)' == 'FreeBSD'">$(BuildCommandArgs) /p:CoreSetupRid=freebsd-x64 /p:PortableBuild=true</BuildCommandArgs>
     <BuildCommandArgs Condition="'$(TargetOS)' == 'OSX'">$(BuildCommandArgs) /p:CoreSetupRid=osx-x64</BuildCommandArgs>
diff --git a/repos/known-good.proj b/repos/known-good.proj
index 50720cc4c..8c994f571 100644
--- a/repos/known-good.proj
+++ b/repos/known-good.proj
@@ -42,7 +42,6 @@
 
         <!-- Tier 2 -->
         <RepositoryReference Include="linker" />
-        <RepositoryReference Include="runtime-portable" />
         <RepositoryReference Include="runtime" />
         <RepositoryReference Include="msbuild" />
 
diff --git a/repos/package-source-build.proj b/repos/package-source-build.proj
index 0ada671fb..fbc5a0cc1 100644
--- a/repos/package-source-build.proj
+++ b/repos/package-source-build.proj
@@ -50,7 +50,7 @@
       <SourceBuiltTarballName>$(OutputPath)$(SourceBuiltArtifactsTarballName).$(installerOutputPackageVersion).tar.gz</SourceBuiltTarballName>
     </PropertyGroup>
 
-    <Exec Command="tar --numeric-owner --exclude='Microsoft.SourceBuild.Intermediate.*.nupkg' --exclude='runtime.$(TargetRid).*.nupkg' -czf $(SourceBuiltTarballName) *.nupkg *.props SourceBuildReferencePackages/"
+    <Exec Command="tar --numeric-owner --exclude='Microsoft.SourceBuild.Intermediate.*.nupkg' -czf $(SourceBuiltTarballName) *.nupkg *.props SourceBuildReferencePackages/"
           WorkingDirectory="$(SourceBuiltPackagesPath)" />
 
     <Message Importance="High" Text="Packaged source-built artifacts to $(SourceBuiltTarballName)" />
diff --git a/repos/runtime.proj b/repos/runtime.proj
index 59ea1d6fc..85d0efa77 100644
--- a/repos/runtime.proj
+++ b/repos/runtime.proj
@@ -1,18 +1,57 @@
 <Project>
-  <Import Project="runtime.common.props"/>
+  <Import Project="Sdk.props" Sdk="Microsoft.NET.Sdk" />
 
+  <!-- Build arguments -->
   <PropertyGroup>
+    <LogVerbosityOptOut>true</LogVerbosityOptOut>
+
+    <CleanCommand>$(ProjectDirectory)/clean$(ShellExtension)</CleanCommand>
+
     <OverrideTargetRid>$(TargetRid)</OverrideTargetRid>
     <OverrideTargetRid Condition="'$(TargetOS)' == 'OSX'">osx-x64</OverrideTargetRid>
     <OverrideTargetRid Condition="'$(TargetOS)' == 'FreeBSD'">freebsd-x64</OverrideTargetRid>
     <OverrideTargetRid Condition="'$(TargetOS)' == 'Windows_NT'">win-x64</OverrideTargetRid>
 
+    <_platformIndex>$(NETCoreSdkRuntimeIdentifier.LastIndexOf('-'))</_platformIndex>
+    <RuntimeOS>$(NETCoreSdkRuntimeIdentifier.Substring(0, $(_platformIndex)))</RuntimeOS>
+
+    <_platformIndex>$(NETCoreSdkPortableRuntimeIdentifier.LastIndexOf('-'))</_platformIndex>
+    <BaseOS>$(NETCoreSdkPortableRuntimeIdentifier.Substring(0, $(_platformIndex)))</BaseOS>
+
     <BuildCommandArgs>$(StandardSourceBuildArgs)</BuildCommandArgs>
     <BuildCommandArgs>$(BuildCommandArgs) /p:TargetRid=$(OverrideTargetRid)</BuildCommandArgs>
+    <BuildCommandArgs>$(BuildCommandArgs) /p:RuntimeOS=$(RuntimeOS)</BuildCommandArgs>
+    <BuildCommandArgs>$(BuildCommandArgs) /p:BaseOS=$(BaseOS)</BuildCommandArgs>
     <BuildCommandArgs>$(BuildCommandArgs) /p:SourceBuildNonPortable=true</BuildCommandArgs>
     <BuildCommand>$(StandardSourceBuildCommand) $(BuildCommandArgs)</BuildCommand>
   </PropertyGroup>
 
+  <!-- Output / source-build flags -->
+  <PropertyGroup>
+    <GlobalJsonFile>$(ProjectDirectory)global.json</GlobalJsonFile>
+    <NuGetConfigFile>$(ProjectDirectory)NuGet.config</NuGetConfigFile>
+    <OutputPlacementRepoApiImplemented>false</OutputPlacementRepoApiImplemented>
+    <DependencyVersionInputRepoApiImplemented>true</DependencyVersionInputRepoApiImplemented>
+  </PropertyGroup>
+
+  <!-- SDK Overrides -->
+  <ItemGroup>
+    <UseSourceBuiltSdkOverride Include="@(ArcadeSdkOverride)" />
+    <UseSourceBuiltSdkOverride Include="@(ArcadeCoreFxTestingOverride)" />
+    <UseSourceBuiltSdkOverride Include="@(ArcadePackagingOverride)" />
+    <UseSourceBuiltSdkOverride Include="@(ArcadeTargetFrameworkOverride)" />
+    <UseSourceBuiltSdkOverride Include="@(ArcadeSharedFrameworkSdkOverride)" />
+  </ItemGroup>
+
+  <!-- Environment Variables -->
+  <ItemGroup>
+    <EnvironmentVariables Include="BuildInParallel=false" />
+  </ItemGroup>
+
+  <ItemGroup>
+    <ExtraPackageVersionPropsPackageInfo Include="MicrosoftCodeAnalysisVersion_4_X" Version="%24(MicrosoftCodeAnalysisVersion)" />
+  </ItemGroup>
+
   <!-- Repository References -->
   <ItemGroup>
       <RepositoryReference Include="arcade" />
@@ -20,8 +59,49 @@
       <RepositoryReference Include="linker" />
       <RepositoryReference Include="source-build-externals" />
       <RepositoryReference Include="roslyn" />
-      <RepositoryReference Include="runtime-portable" />
   </ItemGroup>
 
-  <Import Project="runtime.common.targets" />
+  <UsingTask AssemblyFile="$(XPlatSourceBuildTasksAssembly)" TaskName="AddRidToRuntimeJson" />
+  <UsingTask AssemblyFile="$(XPlatSourceBuildTasksAssembly)" TaskName="PublishCoreSetupBinaries" />
+
+  <Target Name="SetOutputList" AfterTargets="Package" BeforeTargets="GatherBuiltPackages">
+    <ItemGroup>
+      <PackagesOutputList Include="$(ShippingPackagesOutput)" />
+      <PackagesOutputList Include="$(NonShippingPackagesOutput)" />
+    </ItemGroup>
+  </Target>
+
+  <Target Name="UpdateRuntimeGraph"
+          BeforeTargets="Build"
+          Condition="'$(_IsBootstrapping)' == 'true'">
+    <PropertyGroup>
+      <RuntimeJsonFile>$(ProjectDirectory)pkg/Microsoft.NETCore.Platforms/runtime.json</RuntimeJsonFile>
+    </PropertyGroup>
+
+    <Message Importance="High" Text="Adding rid, $(TargetRid), to $(RuntimeJsonFile)" />
+    <AddRidToRuntimeJson RuntimeJson="$(RuntimeJsonFile)"
+                         Rid="$(TargetRid)-$(Platform)" />
+  </Target>
+
+  <Target Name="CopyBinariesToBinFolder"
+          AfterTargets="ExtractIntermediatePackages"
+          Inputs="$(MSBuildProjectFullPath)"
+          Outputs="$(RepoCompletedSemaphorePath)CopyBinariesToBinFolder.complete">
+    <ItemGroup>
+      <_builtRuntimePackages Include="$(SourceBuiltAssetsDir)*.symbols.nupkg" />
+      <_builtRuntimePackages>
+        <TransformedFileName>$([System.String]::Copy('%(FileName)').Replace('symbols', 'nupkg'))</TransformedFileName>
+      </_builtRuntimePackages>
+      <BinariesToCopy Include="$(SourceBuiltAssetsDir)*.*" Exclude="$(SourceBuiltAssetsDir)*.nupkg;$(SourceBuiltAssetsDir)*.requires_nupkg_signing" />
+      <BinariesToCopy Include="@(_builtRuntimePackages->'$(SourceBuiltPackagesPath)%(TransformedFileName)')" />
+    </ItemGroup>
+
+    <Copy SourceFiles="@(BinariesToCopy)"
+          DestinationFolder="$(OutputPath)runtime"
+          Condition="'@(BinariesToCopy)'!=''" />
+
+    <WriteLinesToFile File="$(RepoCompletedSemaphorePath)CopyBinariesToBinFolder.complete" Overwrite="true" />
+  </Target>
+
+  <Import Project="Sdk.targets" Sdk="Microsoft.NET.Sdk" />
 </Project>
diff --git a/repos/source-build-reference-packages.proj b/repos/source-build-reference-packages.proj
index a4fb27340..076902ac0 100644
--- a/repos/source-build-reference-packages.proj
+++ b/repos/source-build-reference-packages.proj
@@ -3,8 +3,11 @@
 
   <PropertyGroup>
     <LocalNuGetPackageCacheDirectory>$(BaseIntermediatePath)source-build-reference-package-cache</LocalNuGetPackageCacheDirectory>
+    <BuildCommandArgs>$(StandardSourceBuildArgs)</BuildCommandArgs>
+    <BuildCommandArgs>$(BuildCommandArgs) /p:MicrosoftNetCoreIlasmPackageRuntimeId=$(NETCoreSdkRuntimeIdentifier)</BuildCommandArgs>
+    <BuildCommandArgs>$(BuildCommandArgs) /p:LocalNuGetPackageCacheDirectory=$(LocalNuGetPackageCacheDirectory)</BuildCommandArgs>
 
-    <BuildCommand>$(StandardSourceBuildCommand) $(StandardSourceBuildArgs) /p:LocalNuGetPackageCacheDirectory=$(LocalNuGetPackageCacheDirectory)</BuildCommand>
+    <BuildCommand>$(StandardSourceBuildCommand) $(BuildCommandArgs)</BuildCommand>
 
     <NuGetConfigFile>$(ProjectDirectory)NuGet.config</NuGetConfigFile>
     <GlobalJsonFile>$(ProjectDirectory)global.json</GlobalJsonFile>
-- 
2.36.2

