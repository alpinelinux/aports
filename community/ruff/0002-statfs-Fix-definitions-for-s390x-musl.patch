From 10c8d7480c3b158d529f4bd78ba075f1a109e9ac Mon Sep 17 00:00:00 2001
From: Hugo Osvaldo Barrera <hugo@whynothugo.nl>
Date: Sun, 30 Nov 2025 14:26:01 +0100
Subject: [PATCH 2/2] statfs: Fix definitions for s390x musl

Backported version of: https://github.com/nix-rust/nix/pull/2678
---
 Cargo.lock                   |  2 --
 Cargo.toml                   |  3 +++
 nix-0.29.0/src/sys/statfs.rs | 18 +++++++++---------
 3 files changed, 12 insertions(+), 11 deletions(-)

diff --git a/Cargo.lock b/Cargo.lock
index e402e1785e..9f359a2791 100644
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -2103,8 +2103,6 @@ dependencies = [
 [[package]]
 name = "nix"
 version = "0.29.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "71e2746dc3a24dd78b3cfcb7be93368c6de9963d30f43a6a73998a9cf4b17b46"
 dependencies = [
  "bitflags 2.10.0",
  "cfg-if",
diff --git a/Cargo.toml b/Cargo.toml
index ae0432817f..723c773b8c 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -324,3 +324,6 @@ lto = false
 # The profile that 'cargo dist' will build with.
 [profile.dist]
 inherits = "release"
+
+[patch.crates-io]
+nix = { path = "nix-0.29.0" }
diff --git a/nix-0.29.0/src/sys/statfs.rs b/nix-0.29.0/src/sys/statfs.rs
index b2315f4ceb..e6e61904fb 100644
--- a/nix-0.29.0/src/sys/statfs.rs
+++ b/nix-0.29.0/src/sys/statfs.rs
@@ -51,11 +51,11 @@ pub struct Statfs(type_of_statfs);
 type fs_type_t = u32;
 #[cfg(target_os = "android")]
 type fs_type_t = libc::c_ulong;
-#[cfg(all(target_os = "linux", target_arch = "s390x", not(target_env = "musl")))]
+#[cfg(all(target_os = "linux", target_arch = "s390x"))]
 type fs_type_t = libc::c_uint;
-#[cfg(all(target_os = "linux", target_env = "musl"))]
+#[cfg(all(target_os = "linux", target_env = "musl", not(target_arch = "s390x")))]
 type fs_type_t = libc::c_ulong;
-#[cfg(all(target_os = "linux", target_env = "ohos"))]
+#[cfg(all(target_os = "linux", target_env = "ohos", not(target_arch = "s390x")))]
 type fs_type_t = libc::c_ulong;
 #[cfg(all(target_os = "linux", target_env = "uclibc"))]
 type fs_type_t = libc::c_int;
@@ -318,7 +318,7 @@ impl Statfs {
     }
 
     /// Optimal transfer block size
-    #[cfg(all(target_os = "linux", target_arch = "s390x", not(target_env = "musl")))]
+    #[cfg(all(target_os = "linux", target_arch = "s390x"))]
     pub fn optimal_transfer_size(&self) -> u32 {
         self.0.f_bsize
     }
@@ -326,7 +326,7 @@ impl Statfs {
     /// Optimal transfer block size
     #[cfg(any(
         target_os = "android",
-        all(target_os = "linux", target_env = "musl"),
+        all(target_os = "linux", target_env = "musl", not(target_arch = "s390x")),
         all(target_os = "linux", target_env = "ohos")
     ))]
     pub fn optimal_transfer_size(&self) -> libc::c_ulong {
@@ -373,14 +373,14 @@ impl Statfs {
 
     /// Size of a block
     // f_bsize on linux: https://github.com/torvalds/linux/blob/master/fs/nfs/super.c#L471
-    #[cfg(all(target_os = "linux", target_arch = "s390x", not(target_env = "musl")))]
+    #[cfg(all(target_os = "linux", target_arch = "s390x"))]
     pub fn block_size(&self) -> u32 {
         self.0.f_bsize
     }
 
     /// Size of a block
     // f_bsize on linux: https://github.com/torvalds/linux/blob/master/fs/nfs/super.c#L471
-    #[cfg(all(target_os = "linux", target_env = "musl"))]
+    #[cfg(all(target_os = "linux", target_env = "musl", not(target_arch = "s390x")))]
     pub fn block_size(&self) -> libc::c_ulong {
         self.0.f_bsize
     }
@@ -454,13 +454,13 @@ impl Statfs {
     }
 
     /// Maximum length of filenames
-    #[cfg(all(target_os = "linux", target_arch = "s390x", not(target_env = "musl")))]
+    #[cfg(all(target_os = "linux", target_arch = "s390x"))]
     pub fn maximum_name_length(&self) -> u32 {
         self.0.f_namelen
     }
 
     /// Maximum length of filenames
-    #[cfg(all(target_os = "linux", target_env = "musl"))]
+    #[cfg(all(target_os = "linux", target_env = "musl", not(target_arch = "s390x")))]
     pub fn maximum_name_length(&self) -> libc::c_ulong {
         self.0.f_namelen
     }
-- 
2.52.0

