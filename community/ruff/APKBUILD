maintainer="Hugo Osvaldo Barrera <hugo@whynothugo.nl>"
pkgname=ruff
pkgver=0.14.6
pkgrel=0
_nixver=0.29.0
pkgdesc="Extremely fast Python linter"
url="https://github.com/astral-sh/ruff"
arch="all"
license="MIT"
makedepends="py3-gpep517 py3-maturin cargo py3-installer git jemalloc-dev"
subpackages="
	$pkgname-pyc
	$pkgname-bash-completion
	$pkgname-fish-completion
	$pkgname-zsh-completion
	py3-$pkgname:_python:noarch
	"
source="https://github.com/astral-sh/ruff/archive/$pkgver/ruff-$pkgver.tar.gz
	nix-$_nixver.tar.gz::https://github.com/nix-rust/nix/archive/refs/tags/v$_nixver.tar.gz
	0001-Enable-jemalloc-on-all-architectures.patch
	0002-statfs-Fix-definitions-for-s390x-musl.patch
	"
# net: cargo
options="net"
[ "$CARCH" = "riscv64" ] && options="$options !check" # No file descriptors available (os error 24) on build-edge-riscv64

export CARGO_PROFILE_RELEASE_OPT_LEVEL=2

prepare() {
	mv "$srcdir/nix-$_nixver" .

	default_prepare

	# shadow git repo for tests
	git init -q

	# Avoid downloading a different toolchain on systems with rustup installed.
	rm rust-toolchain.toml

	cat >> .cargo/config.toml <<-EOF
		[target.$CHOST]
		jemalloc = { rustc-link-lib = ["jemalloc"] }
	EOF

	cargo fetch --locked
}

build() {
	gpep517 build-wheel \
		--wheel-dir .dist \
		--config-json '{"build-args": "--frozen"}' \
		--output-fd 3 3>&1 >&2

	./target/release/ruff generate-shell-completion bash > $pkgname.bash
	./target/release/ruff generate-shell-completion fish > $pkgname.fish
	./target/release/ruff generate-shell-completion zsh > $pkgname.zsh

	# Update ruff.schema.json as the pre-built one is generated
	# using the '--all-features' Cargo flag which we don't pass.
	cargo dev generate-all
}

check() {
	unset CI_PROJECT_DIR

	ulimit -n 4096

	# See: https://github.com/astral-sh/ruff/pull/19652
	case "$CARCH" in
	x86|armv7|armhf) skip_tests="--skip test_multi_file_function_references" ;;
	*) skip_tests="" ;;
	esac

	cargo test --frozen --workspace --exclude ruff_benchmark --exclude ty_server -- $skip_tests

	ldd ./target/release/ruff | grep libjemalloc.so
}

package() {
	python3 -m installer -d "$pkgdir" \
		.dist/*.whl

	install -Dm644 $pkgname.bash \
		"$pkgdir"/usr/share/bash-completion/completions/$pkgname
	install -Dm644 $pkgname.fish \
		"$pkgdir"/usr/share/fish/vendor_completions.d/$pkgname.fish
	install -Dm644 $pkgname.zsh \
		"$pkgdir"/usr/share/zsh/site-functions/_$pkgname
}

_python() {
	amove usr/lib/python3.12/site-packages/
}

sha512sums="
7bf4f1884054408999ac477ab4dd34f5c5fa45d59462187d582fdfd01fdff62c802844fc67c0165387072d7127df89a42ff3da27e7fd165d9f7d5b96230cd5bc  ruff-0.14.6.tar.gz
437e1d7e9e487d88682219bd9267161caded51e0c7291ee17f272dfe8c4e2c44dd4faa5d0d49cf67feaa70ce47bdcd2ff32102c72d9b71757c5b92b6f2fab1bc  nix-0.29.0.tar.gz
3bcdb3f5ccf8fed2971fb037e551e608a29f0a6d2dfe5bb4f8e3452feca605c8c2675c1b463f3c8dc1747714cd6239c81ccf0d0aee70f613aad120825daab98d  0001-Enable-jemalloc-on-all-architectures.patch
77d8afb68fc2933bf8f1f96ee05c7d1ed7646ad8be96accdfc1a16a848993aca0b5d5a9b0ad13035cf7b42a6cd4f127a0e2f2b48ba2ba2672c70bcc0c41856a4  0002-statfs-Fix-definitions-for-s390x-musl.patch
"
