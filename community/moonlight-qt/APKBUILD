maintainer="Leon White <badfunkstripe@gmail.com>"
pkgname=moonlight-qt
pkgver=6.1.0
pkgrel=0
pkgdesc="Open Source PC client for NVIDIA GameStream, as used by the NVIDIA Shield"
url="https://moonlight-stream.org/"
# armhf: blocked by qt6-qtdeclarative
arch="all !armhf"
license="GPL-3.0-or-later"
depends="ffmpeg"
makedepends="openssl-dev sdl2-dev sdl2_ttf-dev ffmpeg-dev qt6-qtsvg-dev qt6-qtdeclarative-dev libva-dev libvdpau-dev opus-dev pulseaudio-dev alsa-lib-dev"
_h264bitstream_commit="70124d3051ba45e6b326264f0b25e6f48a7479e7"
_moonlight_common_c_commit="5f2280183cb62cba1052894d76e64e5f4153377d"
_enet_commit="115a10baa1d7f291ff5b870765610fd3b4a6e43c"
_qmdnsengine_commit="b7a5a9f225d5e14b39f9fd1f905c4f505cf2ee99"
_libsoundio_commit="34bbab80bd4034ba5080921b6ba6d61314126310"
_sdl_gamecontrollerdb_commit="38fc811c715365e963a6942092cae147eddddc90"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/moonlight-stream/moonlight-qt/archive/refs/tags/v$pkgver.tar.gz
	h264bitstream-$_h264bitstream_commit.tar.gz::https://github.com/aizvorski/h264bitstream/archive/$_h264bitstream_commit.tar.gz
	moonlight-common-c-$_moonlight_common_c_commit.tar.gz::https://github.com/moonlight-stream/moonlight-common-c/archive/$_moonlight_common_c_commit.tar.gz
	enet-$_enet_commit.tar.gz::https://github.com/cgutman/enet/archive/$_enet_commit.tar.gz
	qmdnsengine-$_qmdnsengine_commit.tar.gz::https://github.com/cgutman/qmdnsengine/archive/$_qmdnsengine_commit.tar.gz
	libsoundio-$_libsoundio_commit.tar.gz::https://github.com/cgutman/libsoundio/archive/$_libsoundio_commit.tar.gz
	sdl-gamecontrollerdb-$_sdl_gamecontrollerdb_commit.tar.gz::https://github.com/gabomdq/SDL_GameControllerDB/archive/$_sdl_gamecontrollerdb_commit.tar.gz
	riscv64.patch
	"
options="!check" # no tests in upstream

prepare() {
	cp -r "$srcdir/h264bitstream-$_h264bitstream_commit" \
		-T h264bitstream/h264bitstream
	cp -r "$srcdir/moonlight-common-c-$_moonlight_common_c_commit" \
		-T moonlight-common-c/moonlight-common-c
	cp -r "$srcdir/enet-$_enet_commit" \
		-T moonlight-common-c/moonlight-common-c/enet
	cp -r "$srcdir/qmdnsengine-$_qmdnsengine_commit" \
		-T qmdnsengine/qmdnsengine
	cp -r "$srcdir/libsoundio-$_libsoundio_commit" \
		-T soundio/libsoundio
	cp -r "$srcdir/SDL_GameControllerDB-$_sdl_gamecontrollerdb_commit" \
		-T app/SDL_GameControllerDB

	default_prepare
}

build() {
	qmake6 PREFIX=/usr moonlight-qt.pro
	make
}

package() {
	make INSTALL_ROOT="$pkgdir" install
}

sha512sums="
251ed119ff71159c8d95089403302560643f0f0701b0013990353ee04878453e367a5b7102ec7791adde169f387ec62f40fc07466f661d995e131931ce7ec04f  moonlight-qt-6.1.0.tar.gz
dcf5f09537082d93e2ada280f89efd1f1d5ae9a131d245f259adf2987e039d667f85bcb5058aa51e0795bd32edf19f425484892a2e8988e1611ead6643240bc3  h264bitstream-70124d3051ba45e6b326264f0b25e6f48a7479e7.tar.gz
60443c09d4388060d3fdce8d7561f52a3629818760149495c8bc86f689bf202f0a8cfae7bbaa3794b5c73119c26efea502714f63212b4898659bb92c5f9f1d5f  moonlight-common-c-5f2280183cb62cba1052894d76e64e5f4153377d.tar.gz
1ea4ce7ddebd33019823bb7d310d6c4e20a281ea88a8853239e89b94d23e9813fcdd842d7c1a6f1a4eaad300d5996fd1c15edac6f764f08ab256f173a47488de  enet-115a10baa1d7f291ff5b870765610fd3b4a6e43c.tar.gz
49a857698f44baad8c539a0b889f4c0bf1b3af8f770fba4d6ea41ed145b825a81ed7a7e78813f66e3ccbf887612dba6988ffea2fcf7f016bad0fbebfc29705a4  qmdnsengine-b7a5a9f225d5e14b39f9fd1f905c4f505cf2ee99.tar.gz
946bd120eed3ffeb016dc6a7d6d29faf4006fb7a07ca7941b18a16fb7428307035a738da191016969287a544be6c98747802bb0b846f1ae03b24303b527ae415  libsoundio-34bbab80bd4034ba5080921b6ba6d61314126310.tar.gz
359e4c2cbec08c21cd61e68a2a99afbecc181d587f1320d0780b38dd5c6d23aa559cc26933de4ed7370a2a5401b79354e39c1b548fa171d8e098627f891c0fd2  sdl-gamecontrollerdb-38fc811c715365e963a6942092cae147eddddc90.tar.gz
3eaaa6a4f9ac8cfe6ac62625b39b624ae7c5720bc5af9f2335b628d690295e1e7e6f114c00320dc4a795b7cd71ca598bc2259f5e4b991fcac1f38ec64854634e  riscv64.patch
"
