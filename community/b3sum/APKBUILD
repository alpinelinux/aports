# Contributor: Leo <thinkabit.ukim@gmail.com>
# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=b3sum
pkgver=1.8.3
pkgrel=0
pkgdesc="BLAKE3 hash function"
url="https://github.com/BLAKE3-team/BLAKE3"
arch="all"
license="CC0-1.0 OR Apache-2.0"
makedepends="
	cargo
	cargo-auditable
	cmake
	samurai
	onetbb-dev
	"
subpackages="blake3-libs blake3-dev"
source="https://github.com/BLAKE3-team/BLAKE3/archive/refs/tags/$pkgver/BLAKE3-$pkgver.tar.gz"
builddir="$srcdir/BLAKE3-$pkgver/b3sum"

case "$CARCH" in
armhf)
	# hang forever, probably due to non-native hardware
	options="$options !check"
	;;
aarch64|armv7)
	_features="neon"
	;;
esac


prepare() {
	default_prepare

	cargo fetch --target="$CTARGET" --locked
}

build() {
	cargo auditable build --release --frozen \
		${_features:+--features $_features}

	cmake -S ../c/ -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=ON \
		-DCMAKE_BUILD_TYPE=None \
		-DBLAKE3_USE_TBB=ON
	cmake --build build
}

check() {
	cargo test --frozen ${_features:+--features $_features}
}

package() {
	pkgdesc="Command line implementation of the BLAKE3 hash function"

	install -Dm755 target/release/b3sum -t "$pkgdir"/usr/bin/

	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
d0861c3c0294d84a46a3760e5e51734f4040036aa74d72d32242adb9311c0f85f580c17fbee9ca17dc2b3818ff68048b3156a19b8d11fe5c459c5e9266709fb9  BLAKE3-1.8.3.tar.gz
"
