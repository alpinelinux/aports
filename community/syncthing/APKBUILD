# Contributor: Łukasz Jendrysik <scadu@yandex.com>
# Contributor: Carlo Landmeter <clandmeter@alpinelinux.org>
# Contributor: Sören Tempel <soeren+alpine@soeren-tempel.net>
# Maintainer: Sertonix <sertonix@posteo.net>
pkgname=syncthing
pkgver=2.0.14
pkgrel=0
pkgdesc="Open Source Continuous File Synchronization"
url="https://syncthing.net/"
arch="all"
license="MPL-2.0"
pkgusers="$pkgname"
pkggroups="$pkgname"
makedepends="go sqlite-dev"
install="$pkgname.pre-install $pkgname.post-upgrade"
subpackages="
	$pkgname-doc
	$pkgname-utils
	$pkgname-openrc
	$pkgname-nftrules
	$pkgname-systemd
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/syncthing/syncthing/archive/v$pkgver.tar.gz
	only-test-with-race-when-provided.patch
	$pkgname.initd
	$pkgname-user.initd
	$pkgname.nft
	"
options="chmod-clean net"

# secfixes:
#   1.15.1-r0:
#     - CVE-2021-21404

export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

build() {
	# Build syncthing + server utils
	local cmd
	for cmd in syncthing stdiscosrv strelaypoolsrv strelaysrv; do
		echo "Compiling $cmd"
		go run build.go -tags=libsqlite3 -no-upgrade -version=v$pkgver install $cmd
	done
}

check() {
	local testflags=
	case $CARCH in
		# https://github.com/syncthing/syncthing/issues/6209
		arm*|x86) testflags="-short";;
	esac
	# shellcheck disable=SC2086
	go test $testflags ./... || go test $testflags ./...
}

package() {
	local i

	install -d -o $pkgname -g $pkgname "$pkgdir"/var/lib/$pkgname
	install -D -m755 -t "$pkgdir"/usr/bin/ bin/*
	install -D -m755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -D -m755 "$srcdir"/$pkgname-user.initd "$pkgdir"/etc/user/init.d/$pkgname

	# Desktop files so people in Desktop Environments can put them on Autostart
	install -Dm0644 etc/linux-desktop/*.desktop -t "$pkgdir"/usr/share/applications

	install -Dm644 etc/linux-systemd/system/*.service -t "$pkgdir"/usr/lib/systemd/system/
	install -Dm644 etc/linux-systemd/user/*.service -t "$pkgdir"/usr/lib/systemd/user/

	for i in 32 64 128 256 512; do
		install -Dm644 "$builddir"/assets/logo-"$i".png \
			"$pkgdir"/usr/share/icons/hicolor/"$i"x"$i"/apps/$pkgname.png
	done
	install -Dm644 "$builddir"/assets/logo-only.svg \
		"$pkgdir"/usr/share/icons/hicolor/scalable/apps/$pkgname.svg
	install -Dm644 "$srcdir"/syncthing.nft \
		"$pkgdir"/usr/share/nftables.avail/50_syncthing.nft

	# man pages
	for i in 1 5 7; do
		install -Dm644 -t "$pkgdir"/usr/share/man/man"$i"/ man/*."$i"
	done
}

utils() {
	pkgdesc="Syncthing server utilities"

	amove usr/bin/st*
}

sha512sums="
cbad22a592e870806511f7a098383f488a8226d5b9a470f3643aa3d7aec29f9d46e7a2d47cd0b646818e76c14288a5800f1d1b62777325625670b038e53ab757  syncthing-2.0.14.tar.gz
81bcb6b2e0956624b596201d1de24a3b6fcb10d08761f2c426081350b611295a7f4d47775d175f2ee5dbbb289b98bc022389fc9992f0d31bcdbfde855ceafaf8  only-test-with-race-when-provided.patch
c53e897982d19b218166a0e4977e50b493478640a50165ecc1c3fc2361a01ad92d15d5f5fc1899ef86b8ec53ec7dde9aab9663e5a54b645d0eeabefa382608f1  syncthing.initd
e63189dfa1cc091b75d0fe03c766dfb8ffc66a882fa630b808e612454f18cb29c94805448264e28f0699cc693b24b54480685bef182a206082937580cafefefb  syncthing-user.initd
938c1a17a2c3448638270e1a84fac7848ed7e5bbc913404ef3f5ac3a0c285fbb57e0b851af8c69e207a679c8e35e673ab2fa8882642650ecda9af9a98de0b010  syncthing.nft
"
