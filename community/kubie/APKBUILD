# Maintainer: Lauri Tirkkonen <lauri@hacktheplanet.fi>
pkgname=kubie
pkgver=0.26.1
pkgrel=0
pkgdesc="A more powerful alternative to kubectx and kubens"
url="https://github.com/sbstp/kubie"
# s390x: blocked by https://github.com/nix-rust/nix/pull/2678
arch="all !s390x"
license="Zlib"
subpackages="$pkgname-bash-completion $pkgname-fish-completion $pkgname-zsh-completion"
makedepends="
	cargo
	cargo-auditable
	clang-dev
	cmake
	cmd:ninja
	"
source="v$pkgver.tar.gz::$url/archive/refs/tags/v$pkgver.tar.gz
loongarch64-downgrade-libc.patch
"

prepare() {
	default_prepare
	cargo fetch --target="$CTARGET" --locked
}

build() {
	cargo auditable build --frozen --release --no-default-features
}

check() {
	cargo test --frozen
}

package() {
	install -D -m 0755 target/release/$pkgname "$pkgdir"/usr/bin/$pkgname

	local bashdir="$pkgdir"/usr/share/bash-completion/completions
	local fishdir="$pkgdir"/usr/share/fish/vendor_completions.d
	local zshdir="$pkgdir"/usr/share/zsh/site-functions

	mkdir -p "$bashdir" "$fishdir" "$zshdir"
	"$pkgdir"/usr/bin/$pkgname generate-completion bash >"$bashdir"/$pkgname
	"$pkgdir"/usr/bin/$pkgname generate-completion fish >"$fishdir"/$pkgname.fish
	"$pkgdir"/usr/bin/$pkgname generate-completion zsh >"$zshdir"/_$pkgname
}

sha512sums="
f5df387864cddd003c07a4442f582c0fbcf3ecd7d8b4f8fbac87b61a536bdd3e81085f1961ae70dff90afb3d54373be4eaeefdfba59438a7ef7822174edd4bee  v0.26.1.tar.gz
30e60ef32d7c96046982ae59d6bfb2069068786ed83c19cb933dc86bc593f8f779fce4a69ac665a4fec3d8904995ed2ce8b166eb8b66f59464fa7475559c0e95  loongarch64-downgrade-libc.patch
"
