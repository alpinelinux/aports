# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=kati
pkgver=0_git20251208
_gitrev=c31dcf6ed1c4ffad88b076bf37df7f645ca1c070
pkgrel=0
pkgdesc="Experimental GNU make clone"
url="https://github.com/google/kati"
arch="all"
license="Apache-2.0"
checkdepends="bash findutils go python3"
_make=4.2.1 # check README.md for compatible version
source="https://github.com/google/kati/archive/$_gitrev/kati-$_gitrev.tar.gz
	https://ftp.gnu.org/gnu/make/make-$_make.tar.gz
	makefile-no-git.patch
	no-march-native.patch
	testcase-wildcard.patch
	"
builddir="$srcdir/$pkgname-$_gitrev"

prepare() {
	default_prepare

	cd "$srcdir"
	update_config_guess
}

build() {
	make KATI_VERSION="$_gitrev"

	if want_check; then
		cd "$srcdir/make-$_make"
		CFLAGS="$CFLAGS -std=gnu17" ./configure
		"$builddir"/ckati -C glob libglob.a
		"$builddir"/ckati make
	fi
}

check() {
	PATH="$srcdir/make-$_make:$PATH" go test -v
}

package() {
	install -Dvm755 ckati -t "$pkgdir"/usr/bin/

	# Golang kati has been deleted from the upstream repo
	ln -sv ckati "$pkgdir"/usr/bin/kati
}

sha512sums="
1cdf8df34b142cd8a4739ef32df12ee14f6e252db02126bc82ba88a0a3c209ec1a53d8a24d3c53faddb733d34ccca10b470f4466334c8cf5d5878cbfaf2c0753  kati-c31dcf6ed1c4ffad88b076bf37df7f645ca1c070.tar.gz
d5f6ce3ac7c9a55cf8c1c04afa7d967dd311c9bb3167275ebb2649cf144f3740cf08450dc010a6acdea1fd529fd528a50b3c3381f4c9a7e83ec59b761817a038  make-4.2.1.tar.gz
a5279564ab22120b12970cc79f9c1a2924a9aa74044a08d55e057e0a3a48a0749331528a2a6a9d736b3b63e2aa7d5edc41826b58e63adc309ab05fd8ba9215b6  makefile-no-git.patch
7a8922fbb9c6732bdb8a4be1dc5f0bea6a9512702b3c1080a0cbd1887af76b4b29ee9a6646584e7fffb1f7c590d22f71d2ef5350ab0fdf613e3439aa688740d3  no-march-native.patch
67511d8536eda05af6856335757b6da735e1b377eeb0e7a66e54ba0011d400be3f093cc1039163fe0e74ccb7ca7c37db5af6db2723bed5478eb4ed418ed87352  testcase-wildcard.patch
"
