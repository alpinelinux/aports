# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: team/kde <bribbers@disroot.org>

# The group tag is just to easily find this APKBUILD by some scripts for automation
# group=kde-other
pkgname=digikam
pkgver=8.8.0
_test_data_commit=d02dd20b23cc279792325a0f03d21688547a7a59
pkgrel=1
pkgdesc="An advanced open-source digital photo management application"
url="https://www.digikam.org/"
# armhf, riscv64, s390x and x86 blocked by qt6-qtwebengine
arch="all !armhf !s390x !riscv64 !x86"
license="LGPL-2.1-or-later AND GPL-2.0-or-later"
makedepends="
	akonadi-contacts-dev
	bison
	boost-dev
	doxygen
	eigen-dev
	exiv2-dev
	expat-dev
	extra-cmake-modules
	flex
	gettext
	graphviz
	imagemagick-dev
	jasper-dev
	kcalendarcore-dev
	kdoctools-dev
	kfilemetadata-dev
	lcms2-dev
	lensfun-dev
	libgphoto2-dev
	libheif-dev
	libksane-dev
	libpng-dev
	libxml2-dev
	libxslt-dev
	marble-dev
	opencv-dev
	qt6-qtmultimedia-dev
	qt6-qtnetworkauth-dev
	qt6-qtscxml-dev
	qt6-qtwebengine-dev
	samurai
	tiff-dev
	x265-dev
	"
checkdepends="xwayland-run exiftool"
subpackages="$pkgname-dev $pkgname-doc $pkgname-lang"
_repo_url="https://invent.kde.org/graphics/digikam.git"
source="https://download.kde.org/stable/digikam/$pkgver/digiKam-$pkgver.tar.xz
	https://invent.kde.org/graphics/digikam-test-data/-/archive/$_test_data_commit/digikam-test-data-$_test_data_commit.tar.gz
	byteorder.patch
	fetch.patch
	"

prepare() {
	default_prepare

	mv "$srcdir"/digikam-test-data-$_test_data_commit test-data
}

build() {
	cmake -B build -G Ninja \
		-DBUILD_WITH_QT6=ON \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_C_STANDARD=11 \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_TESTING="$(want_check && echo enabled || echo disabled)"

	# FIXME this should be done by cmake
	sed -e 's/@MYGITVERSION@/unknown/' -e 's/@MYGITBRANCH@/unknown/' < core/cmake/templates/gitversion.h.cmake.in > build/core/app/utils/digikam_gitversion.h
	sed -e "s/@MYBUILDDATE@/$(date -u "+%Y%m%dT%H%M%S" -d @${SOURCE_DATE_EPOCH:-0})/" < core/cmake/templates/builddate.h.cmake.in > build/core/app/utils/digikam_builddate.h

	cmake --build build
}

check() {
	local tests="
		databasesqliteinit
		databaseswitch
		dimghistorygraph
		edit
		faceclassifier
		haariface
		identityprovider
		setiptcpreview
		timestampupdate
		upload
		"
	local skipped_tests="digikam-("
	for test in $tests; do
		skipped_tests="$skipped_tests|$test"
	done
	skipped_tests="$skipped_tests)_utest"

	xwfb-run -- ctest -j 1 --test-dir build -E "$skipped_tests"
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
eb10afff5639657ff4ca4870c0c02c89dd00a627fec0b64262c4f9f50048819f82024da8d943c23288313076723fcf4c04d6cc281e4890e0f5d9f36e33bf3b33  digiKam-8.8.0.tar.xz
a14c3b81d9dfea3aecb5dd6e930fe5b6b7b43cfefa5ad7bf4fccbfd5abdabd720b6b8f01e8eadf788e2f7043e8cfecd2a87c1e1e2263010a77d51761614f961d  digikam-test-data-d02dd20b23cc279792325a0f03d21688547a7a59.tar.gz
9861dd71c5ace2e4cbf95bda19b18e77dc4aee61e2335036e94faf88de63a1cf3f97ae2866fa382eb00bafe94048cad16441c0318d0169c13fc120dbd948a369  byteorder.patch
cf112c9a97282ab0cfa774a6e307b1b3a681103d17461eab09da868c4e3fe280a731a72c75c05627a48c9d5a47b3bb465aa73b1ee0faa1c33d9011d738ce4354  fetch.patch
"
