# Contributor: SÃ¶ren Tempel <soeren+alpine@soeren-tempel.net>
# Maintainer:
pkgname=bear
pkgver=4.0.3
pkgrel=0
pkgdesc="Tool that generates a compilation database for clang tooling"
url="https://github.com/rizsotto/Bear"
arch="all"
license="GPL-3.0-or-later"
makedepends="
	cargo
	cargo-auditable
	lld
	"
subpackages="$pkgname-doc"
source="https://github.com/rizsotto/Bear/archive/$pkgver/bear-$pkgver.tar.gz
	set-preload-path.patch
	"
builddir="$srcdir/Bear-$pkgver"

prepare() {
	default_prepare

	cargo fetch --target="$CHOST" --locked
}

build() {
	cargo auditable build --frozen --release
}

check() {
	case "$CARCH" in
	# intercept::tcp::tests::tcp_reporter_and_collectors_work: panicked at
	# bear/src/intercept/tcp.rs:219:9: assertion `left == right` failed
	# left: 2, right: 3
	riscv64) cargo test --frozen -- \
		--skip intercept::tcp::tests::tcp_reporter_and_collectors_work ;;
	*) cargo test --frozen ;;
	esac
}

package() {
	install -Dm755 target/release/bear -t "$pkgdir"/usr/bin/
	install -Dm755 target/release/wrapper -t "$pkgdir"/usr/lib/bear/
	install -Dm755 target/release/libexec.so -t "$pkgdir"/usr/lib/bear/

	install -Dm644 man/bear.1 -t "$pkgdir"/usr/share/man/man1/
	install -Dm644 README.md -t "$pkgdir"/usr/share/doc/bear/
	install -Dm644 COPYING -t "$pkgdir"/usr/share/licenses/bear/
}

sha512sums="
c33b23c6e36b898638b94678484075426bc7faabe7e1d597ff56cee75d8d98914e6cf9d608f0b7188d4ea940311b80c7e7d47deb15368b485d0c95761522d5c8  bear-4.0.3.tar.gz
c56d227d551a02a11dc17932b25e35305ce5a433f331f3bb2a6cdfa8a5c7de4bb211305a8e4f4656abac915e8703ee480953fdbe8603ec03534cac9ad1d5a961  set-preload-path.patch
"
