# Contributor: omni <omni+alpine@hack.org>
# Maintainer: omni <omni+alpine@hack.org>
maintainer="omni <omni+alpine@hack.org>"
pkgname=snowflake
pkgver=2.11.0
pkgrel=8
pkgdesc="Pluggable Transport for Tor using WebRTC"
url="https://snowflake.torproject.org/"
license="BSD-3-Clause"
arch="all"
makedepends="go"
subpackages="$pkgname-doc
	$pkgname-client:_client
	$pkgname-client-doc:_client_doc
	$pkgname-proxy:_proxy
	$pkgname-proxy-doc:_proxy_doc
	$pkgname-proxy-openrc:_proxy_openrc
	"
install="$pkgname-proxy.pre-install"
options="net" # go
source="https://gitlab.torproject.org/tpo/anti-censorship/pluggable-transports/snowflake/-/archive/v$pkgver/snowflake-v$pkgver.tar.gz
	snowflake-proxy.initd
	snowflake-proxy.confd
	0001-fix-build-error-on-loongarch64_patch
	"
builddir="$srcdir/$pkgname-v$pkgver"

export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

prepare() {
	default_prepare

	case "$CARCH" in
	loongarch64)
		patch -p1 -i "$srcdir"/0001-fix-build-error-on-loongarch64_patch
		;;
	esac
}

build() {
	msg2 "Building snowflake client"
	cd "$builddir"/client
	go build -v .

	msg2 "Building snowflake proxy"
	cd "$builddir"/proxy
	go build -v .

	gzip -9 "$builddir"/doc/*.1
}

check() {
	# no test files, but let's at least do this
	msg2 "Print version information"
	./client/client -version
	./proxy/proxy -version
}

package() {
	pkgdesc="$pkgdesc - meta package"
	depends="$pkgname-client=$pkgver-r$pkgrel $pkgname-proxy=$pkgver-r$pkgrel"

	install -Dm0644 -t "$pkgdir"/usr/share/doc/"$pkgname"/ \
		doc/broker-spec.txt doc/rendezvous-with-sqs.md \
		ChangeLog
}

_client() {
	pkgdesc="$pkgdesc - client"

	install -Dm0755 "$builddir"/client/client \
		"$subpkgdir"/usr/bin/"$pkgname"-client
}

_client_doc() {
	pkgdesc="$pkgdesc - client (man page)"
	install_if="docs ${subpkgname%-doc}=$pkgver-r$pkgrel"

	install -Dm0644 "$builddir"/doc/snowflake-client.1.gz \
		-t "$subpkgdir"/usr/share/man/man1/
}

_proxy() {
	pkgdesc="$pkgdesc - proxy"

	install -Dm0755 "$builddir"/proxy/proxy \
		"$subpkgdir"/usr/bin/"$pkgname"-proxy
}

_proxy_doc() {
	pkgdesc="$pkgdesc - proxy (man page)"
	install_if="docs ${subpkgname%-doc}=$pkgver-r$pkgrel"

	install -Dm0644 "$builddir"/doc/snowflake-proxy.1.gz \
		-t "$subpkgdir"/usr/share/man/man1/
}

_proxy_openrc() {
	pkgdesc="$pkgdesc - proxy (OpenRC init scripts)"
	install_if="openrc ${subpkgname%-openrc}=$pkgver-r$pkgrel"

	install -Dm644 "$srcdir"/snowflake-proxy.confd \
		"$subpkgdir"/etc/conf.d/snowflake-proxy
	install -Dm755 "$srcdir"/snowflake-proxy.initd \
		"$subpkgdir"/etc/init.d/snowflake-proxy

}

sha512sums="
6e1f1d0ed9741b019829b378b14742065f410e483d134e7ac7601ecf970da73090ecbe6106b633e0d8158e94490941b6b62186d7d4415069f7ff412c56d5558e  snowflake-v2.11.0.tar.gz
2fc5e69ebd4696e6d3962e23eb7e07e283e1996d01b9fe6edeeed21e997b2fad7e5860a624558b525a9ca133d2e1748065aba4dfb80f5167c66c7c57f0df0349  snowflake-proxy.initd
d0c07d01dea47daa49861c5dac2f70b315cc81f1daeb3911165ae7157a27a4b188cd1fdecb46791d31386f24d16c9ef45397fe961cd7408150ac45b2c9265778  snowflake-proxy.confd
3dbffdef813ced4e33346d4655be5ac1f40c1c2150b5e3a6826794a15aa76bdbbb3f00b4672f5e0fb18b9dccc5215772856061031ed036a585f65384732352e0  0001-fix-build-error-on-loongarch64_patch
"
