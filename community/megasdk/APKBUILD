# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=megasdk
# NOTE: It's usually needed to also bump the megacmd aport.
pkgver=4.17.1a
pkgrel=0
pkgdesc="MEGA C++ SDK"
url="https://github.com/meganz/sdk"
# s390x: tests fail
# x86: blocked by crypto++-dev
arch="all !s390x !x86"
license="BSD-2-Clause"
depends_dev="
	c-ares-dev
	crypto++-dev
	curl-dev
	libsodium-dev
	sqlite-dev
	"
makedepends="
	$depends_dev
	autoconf
	automake
	libtool
	linux-headers
	openssl-dev
	"
checkdepends="
	gtest-dev
	"
subpackages="$pkgname-dev"
source="https://github.com/meganz/sdk/archive/refs/tags/v$pkgver/megasdk-$pkgver.tar.gz
	fix-null-to-bool-cast.patch
	fix-missing-headers.patch
	"
builddir="$srcdir/sdk-$pkgver"

prepare() {
	default_prepare

	# gtest requires at least c++14
	sed -i 's/-std=c++11/-std=c++14/g' configure.ac

	./autogen.sh
}

build() {
	# MEGAsdk still uses autohells for Linux builds and they don't provide
	# install task for cmake.
	CXXFLAGS="$CXXFLAGS -flto=auto" \
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--enable-shared \
		--disable-chat \
		--disable-examples \
		--$(want_check && echo enable || echo disable)-tests \
		--with-cryptopp \
		--with-sodium \
		--with-sqlite \
		--without-ffmpeg \
		--without-libmediainfo \
		--with-cares \
		--without-freeimage \
		--without-pdfium \
		--with-gtest=/usr/lib
	make
}

check() {
	./tests/test_unit
}

package() {
	make DESTDIR="$pkgdir" install
}

sha512sums="
539b557d7562fd50389648ae050bcc9457cd65957894da7a1e6bda98a4cda4baeda19cc528943ce221531544c9c7125b52fece938e8d0aa24521f55ae886316d  megasdk-4.17.1a.tar.gz
62bd518dbd01541f4300c887491d9d00ee03d0ee9b19d3d8ab419c8bce401999c98677e591c53acedc4a4fe0d90f4125a69ac0396c0dbb2dc250c2fedaec7720  fix-null-to-bool-cast.patch
d11dce3f9ed63ff4da76af547fb581ec3a60339b6a01c3bd239e6742986bdf16208d7849cadcbc85580b9f9d688c8df1365da0f14fe22d2e81c1348334536c80  fix-missing-headers.patch
"
