# Contributor: Carlo Landmeter <clandmeter@alpinelinux.org>
# Contributor: Patrycja Rosa <alpine@ptrcnull.me>
# Maintainer: Will Sinatra <wpsinatra@gmail.com>
maintainer="Will Sinatra <wpsinatra@gmail.com>"
pkgname=woodpecker
pkgver=3.12.0
pkgrel=1
pkgdesc="Simple yet powerful CI/CD engine with great extensibility"
url="https://woodpecker-ci.org"
arch="all"
license="Apache-2.0"
pkgusers="woodpecker"
pkggroups="woodpecker"
makedepends="
	go
	go-swag
	sqlite-dev
	pnpm
	"
checkdepends="coreutils-env"
subpackages="
	$pkgname-agent
	$pkgname-agent-openrc:agent_openrc
	$pkgname-cli
	$pkgname-doc
	$pkgname-openrc
	"
install="$pkgname.pre-install $pkgname-agent.pre-install"
source="$pkgname-$pkgver.tar.gz::https://github.com/woodpecker-ci/woodpecker/releases/download/v$pkgver/woodpecker-src.tar.gz
	woodpecker-server.initd
	woodpecker-agent.initd
	woodpecker-server.conf
	woodpecker-agent.conf
	woodpecker-agent-state.conf
	woodpecker-server.logrotate
	woodpecker-agent.logrotate
	respect-cgo-flags.patch
	disable-race-tests.patch
	disable-ui-openai-generation.patch
	skip-alternate-unix-sh-test.patch
	skip-fifo-cancel-test.patch
	"
options="net"

case "$CARCH" in
	riscv64|armv7) options="$options !check" # tests fail, but otherwise works fine.
esac

export GOFLAGS="$GOFLAGS -tags=libsqlite3"
export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

unpack() {
	mkdir -p $builddir
	tar -xzvf $srcdir/$pkgname-$pkgver.tar.gz -C $builddir
}

build() {
	export TARGETARCH="$(go env GOHOSTARCH)"
	make build -j1 STATIC_BUILD=false VERSION=$pkgver
	make docs
}

check() {
	make test
}

package() {
	# Install server
	install -Dm755 "$builddir"/dist/woodpecker-server \
		"$pkgdir"/usr/bin/woodpecker-server

	# Install initd & conf
	install -Dm755 "$srcdir"/woodpecker-server.initd \
		"$pkgdir"/etc/init.d/woodpecker-server
	install -Dm640 -o woodpecker -g woodpecker "$srcdir"/woodpecker-server.conf \
		"$pkgdir"/etc/woodpecker/server.conf

	# Install web resources
	install -d -m 755 -o woodpecker -g woodpecker "$pkgdir"/usr/share/webapps/$pkgname
	cp -R "$builddir"/web/dist/* "$pkgdir"/usr/share/webapps/$pkgname/

	# Create empty log & lib directories
	install -d -m0750 -o woodpecker -g woodpecker \
		"$pkgdir"/var/log/woodpecker "$pkgdir"/var/lib/woodpecker

	# Install logrotate rules
	install -Dm644 "$srcdir"/woodpecker-server.logrotate \
		"$pkgdir"/etc/logrotate.d/woodpecker-server

	# Install mandocs
	mkdir -p "$pkgdir"/usr/share/doc/$pkgname
	cp -R "$builddir"/docs/docs/* "$pkgdir"/usr/share/doc/$pkgname/
}

cli() {
	pkgdesc="Woodpecker Server CLI"

	install -Dm755 "$builddir"/dist/woodpecker-cli \
		"$subpkgdir"/usr/bin/woodpecker-cli
}

agent() {
	pkgdesc="Woodpecker CI agent"

	install -Dm755 "$builddir"/dist/woodpecker-agent \
		"$subpkgdir"/usr/bin/woodpecker-agent

	# This is the agent's configuration
	install -Dm640 -o woodpecker -g woodpecker "$srcdir"/woodpecker-agent.conf \
		"$subpkgdir"/etc/woodpecker/agent.conf

	# This holds configuration state from the Woodpecker Server component
	install -Dm640 -o woodpecker -g woodpecker "$srcdir"/woodpecker-agent-state.conf \
		"$subpkgdir"/etc/woodpecker/agent-state.conf

	# Install logrotate rules
	install -Dm644 "$srcdir"/woodpecker-agent.logrotate \
		"$pkgdir"/etc/logrotate.d/woodpecker-agent

	# Create empty log & lib directories
	install -d -m0750 -o woodpecker -g woodpecker \
		"$subpkgdir"/var/log/woodpecker "$subpkgdir"/var/lib/woodpecker
		
}

agent_openrc() {
	pkgdesc="Woodpecker CI agent (OpenRC init scripts)"
	depends=openrc
	install_if="openrc $pkgname-agent=$pkgver-r$pkgrel"

	install -Dm755 "$srcdir"/woodpecker-agent.initd \
		"$subpkgdir"/etc/init.d/woodpecker-agent
}

sha512sums="
2a64f5d5ed30bec1b12fac84de95192cd5914782ffc83cd088fe521238dbc721358f68dd0cad12af2dd751fc7a3ab1f67837d0407c16af077ba35706dfdc3571  woodpecker-3.12.0.tar.gz
78ab8bb18039dd9f754e6561dd9b439642c2dbf897bcd24e6cd1f4473e0aec51ed7a0b1bf37c3ccb57144542ff3db83775ce7254ba9b53c306a653c4dc1a0d5f  woodpecker-server.initd
5f2f9357fd4f4f5a71e65a33992b41ef329b93fc25bffcc304590638bc9bbb95eeef9e8922753ebd7b0aa87bf1dc14c12ca2106563fd585076bb1c6e42aed773  woodpecker-agent.initd
4972ae45fe944c4921a22613f69cdc806b8d76b152cc9e1f7dac83ce760e7f0860495d48efd79bcf490f551d18661979b9e7b85a8b44220af1ff684a1664ff83  woodpecker-server.conf
ef444ecb44555f1d6ec59421c7e06cd9ebe56d2a66cfa239a5ca64b0e83dfb14f8e7723b0b0cf0db858c3938437f147083682eb52d51d97d6fd266e464f6c997  woodpecker-agent.conf
cf83e1357eefb8bdf1542850d66d8007d620e4050b5715dc83f4a921d36ce9ce47d0d13c5d85f2b0ff8318d2877eec2f63b931bd47417a81a538327af927da3e  woodpecker-agent-state.conf
e6fbecc95f9e0be9f3c0410492e58167e6aa2a7c47a02446585484cb8f506a6e84ea61f35e656dd335ad9bd297a3dd842b1333bdc8f3581786b3e67029fe7a44  woodpecker-server.logrotate
e6fbecc95f9e0be9f3c0410492e58167e6aa2a7c47a02446585484cb8f506a6e84ea61f35e656dd335ad9bd297a3dd842b1333bdc8f3581786b3e67029fe7a44  woodpecker-agent.logrotate
f18c649d1daa6f868e7cc20145d4b2ae24e4a4099f0c5ecd7ac1449b783760614d073c00bb193b9d72d4804fca1131b207afd4a8a8c56595c17fb73f59c33a1c  respect-cgo-flags.patch
a7c55de3fd4b293d3e625f59f3fc2427507736670852a0a52104d029dd77ca9a4b201f387d403436cf23d3b0a624c2f4e86ca1cf9c0b0c126b18e979096b8758  disable-race-tests.patch
eb4a489d4700758b496f9bbe87fe344afe93c3095111cf6bc66c867f1b24c173776327804d363fa3acebefde4d0b34e953286ca8a124a4fefcf90a0e1b6d2db2  disable-ui-openai-generation.patch
05b43290d902e9d5dd9c666831e7fc448861236a6248fab96ffbacf34bb6c2dc423882cc2e5252921993d1d48b46a931ce0de919d2cb5252f6fe5f47b871210c  skip-alternate-unix-sh-test.patch
16411b10acf2753cf5f92912daa984503d4348cfd5eae605b3cb6713e99aff69581865980aa277638ae99966ecaa2973ac41a6958082ed1f87086ad58548855a  skip-fifo-cancel-test.patch
"
