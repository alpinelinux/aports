# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=sdc
pkgver=0.0.15_git20251214
pkgrel=0
_gitrev=25a390355a9105ca9da05c40314c7568b135975d
pkgdesc="Snazzy D Compiler"
url="https://github.com/snazzy-d/sdc"
arch="x86_64" # limited by dmd
license="MIT"
_llvmver=21
depends="
	gcc
	musl-dev
	"
makedepends="
	coreutils
	dmd
	lld$_llvmver
	llvm$_llvmver-dev
	llvm$_llvmver-gtest
	llvm$_llvmver-static
	llvm-libunwind-dev
	"
checkdepends="dtools" # for cmd:rdmd
source="https://github.com/snazzy-d/sdc/archive/$_gitrev/sdc-$_gitrev.tar.gz
	avoid-builder-specific-cpu-features.patch
	"
builddir="$srcdir/$pkgname-$_gitrev"

export LLVM_CONFIG=llvm-config-$_llvmver

prepare() {
	default_prepare

	if want_check; then
		# uses `git rev-parse --show-toplevel` to find $builddir
		git init
	fi
}

build() {
	unset DFLAGS LDFLAGS
	make
}

check() {
	make check
}

package() {
	install -Dvm755 bin/sdc bin/sdfmt bin/sdunit -t "$pkgdir"/usr/bin/
	install -Dvm644 lib/* -t "$pkgdir"/usr/lib/sdc/
	install -Dvm644 LICENCE -t "$pkgdir"/usr/share/licenses/$pkgname/

	mkdir -p "$pkgdir"/usr/include
	cp -RT sdlib "$pkgdir"/usr/include/sdc
	rm -v "$pkgdir"/usr/include/sdc/*.mak \
		"$pkgdir"/usr/include/sdc/tools/*.o

	mkdir -p "$pkgdir"/etc
	cat > "$pkgdir"/etc/sdconfig <<-'EOF'
	{
		"includePaths": ["/usr/include/sdc", "."],
		"libPaths": ["/usr/lib/sdc"],
	}
	EOF
}

sha512sums="
3fb06ed36d135e4b72c7698b45637e9ba2a00d8ee82f82397417f030961a7fd08ec1fde34e48370133dc97dd84d4e00cbde50628f94bf2b8c89a59fbda13517f  sdc-25a390355a9105ca9da05c40314c7568b135975d.tar.gz
aadae92a1aff4631796e5beb0f05a48ebdaf4eaf91837e3bc5202689eb8b661aaefcb3d531625d08c995b408e1651ee3387990c64ba9a66d16ba3c355940189b  avoid-builder-specific-cpu-features.patch
"
