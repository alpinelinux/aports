# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=sdc
pkgver=0.0.15_git20251211
pkgrel=0
_gitrev=9ba819b097f358a2f986f1f1deef654185377c22
pkgdesc="Snazzy D Compiler"
url="https://github.com/snazzy-d/sdc"
arch="x86_64" # limited by dmd
license="MIT"
_llvmver=21
depends="
	gcc
	musl-dev
	"
makedepends="
	coreutils
	dmd
	lld$_llvmver
	llvm$_llvmver-dev
	llvm$_llvmver-gtest
	llvm$_llvmver-static
	llvm-libunwind-dev
	"
checkdepends="dtools" # for cmd:rdmd
source="https://github.com/snazzy-d/sdc/archive/$_gitrev/sdc-$_gitrev.tar.gz
	avoid-builder-specific-cpu-features.patch
	"
builddir="$srcdir/$pkgname-$_gitrev"

export LLVM_CONFIG=llvm-config-$_llvmver

prepare() {
	default_prepare

	if want_check; then
		# uses `git rev-parse --show-toplevel` to find $builddir
		git init
	fi
}

build() {
	unset DFLAGS LDFLAGS
	make
}

check() {
	make check
}

package() {
	install -Dvm755 bin/sdc bin/sdfmt bin/sdunit -t "$pkgdir"/usr/bin/
	install -Dvm644 lib/* -t "$pkgdir"/usr/lib/sdc/
	install -Dvm644 LICENCE -t "$pkgdir"/usr/share/licenses/$pkgname/

	mkdir -p "$pkgdir"/usr/include
	cp -RT sdlib "$pkgdir"/usr/include/sdc
	rm -v "$pkgdir"/usr/include/sdc/*.mak \
		"$pkgdir"/usr/include/sdc/tools/*.o

	mkdir -p "$pkgdir"/etc
	cat > "$pkgdir"/etc/sdconfig <<-'EOF'
	{
		"includePaths": ["/usr/include/sdc", "."],
		"libPaths": ["/usr/lib/sdc"],
	}
	EOF
}

sha512sums="
14cfcc24df3a0941e579555a7a289299db59673a0d30ec97fe431ecf8362a741f9a9bd7c68e248af8ca25367b741bf799013e0287e1138be8baf7b8ebe0a8f58  sdc-9ba819b097f358a2f986f1f1deef654185377c22.tar.gz
aadae92a1aff4631796e5beb0f05a48ebdaf4eaf91837e3bc5202689eb8b661aaefcb3d531625d08c995b408e1651ee3387990c64ba9a66d16ba3c355940189b  avoid-builder-specific-cpu-features.patch
"
