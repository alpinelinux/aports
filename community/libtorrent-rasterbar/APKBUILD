# Contributor: August Klein <amatcoder@gmail.com>
# Maintainer: August Klein <amatcoder@gmail.com>
pkgname=libtorrent-rasterbar
pkgver=1.2.15
pkgrel=0
pkgdesc="Feature complete C++ bittorrent implementation"
url="https://www.rasterbar.com/products/libtorrent"
arch="all !armv7 !aarch64 !x86" # on aarch64 and x86 failed to build
license="BSD-3-Clause"
depends_dev="boost-build boost-dev openssl1.1-compat-dev python3-dev py3-setuptools automake autoconf"
makedepends="$depends_dev linux-headers"
subpackages="py3-$pkgname:_py3 $pkgname-static $pkgname-dev"
source="
	https://github.com/arvidn/libtorrent/releases/download/v$pkgver/libtorrent-rasterbar-$pkgver.tar.gz
	fix-python-binding-build.patch
	"

build() {
	local _py3ver=$(python3 -c 'import sys; print("{}{}".format(sys.version_info.major, sys.version_info.minor))')
	PYTHON=/usr/bin/python3 \
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--enable-tests \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--enable-python-binding \
		--with-boost-system=boost_python$_py3ver \
		--with-cxx-standard=17
	make
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install

	cd bindings/python
	python3 setup.py install --prefix /usr --root "$pkgdir/python"
}

dev() {
	default_dev

	mkdir -p "$subpkgdir/usr/share"
	mv "$pkgdir/usr/share/cmake" "$subpkgdir/usr/share"
}

_py3() {
	pkgdesc="Python3 bindings for $pkgname"

	rm -rfv "$pkgdir"/usr/lib/python*
	mv "$pkgdir/python" "$subpkgdir"
}

sha512sums="
c409c53ec9c299a05b51ab61d7df1209803cbd6070f0a014dd6fb42c30f6f5230ea90848330f901c61816bc70901e618409acacc95bb0e5acb7f81211d001fa2  libtorrent-rasterbar-1.2.15.tar.gz
5a49bcd6d2f04931df41bf3bd3f5733615fc4db5fb2d031422c825918f636b813fa2715a828069f02c2245ec3b1495af108ee129cdf48652f0f094b357ef064c  fix-python-binding-build.patch
"
