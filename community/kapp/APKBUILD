# Contributor: Kevin Daudt <kdaudt@alpinelinux.org>
maintainer="Kevin Daudt <kdaudt@alpinelinux.org>"
pkgname=kapp
pkgver=0.65.1
pkgrel=0
pkgdesc="deployment tool focused on the concept of a kubernetes application"
url="https://carvel.dev/kapp"
arch="all"
license="Apache-2.0"
options="net"
makedepends="go"
checkdepends="gotestfmt"
subpackages="
	$pkgname-bash-completion:bashcomp
	$pkgname-zsh-completion:zshcomp
	$pkgname-fish-completion:fishcomp
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/carvel-dev/kapp/archive/v$pkgver/kapp-$pkgver.tar.gz
	test-increase-timeouts.patch
	"

build() {
	go build \
		-ldflags="-X carvel.dev/kapp/pkg/kapp/version.Version=$pkgver -buildid=" \
		-trimpath \
		-o kapp ./cmd/kapp

	./kapp completion bash >kapp.bash
	./kapp completion zsh >kapp.zsh
	./kapp completion fish >kapp.fish
}

check() {
	go test -json -v ./pkg/... | tee test.log | gotestfmt -showteststatus -hide empty-packages
}

package() {
	install -Dm0755 kapp "$pkgdir"/usr/bin/kapp
	install -Dm0644 kapp.bash "$pkgdir"/usr/share/bash-completion/completions/kapp
	install -Dm0644 kapp.zsh "$pkgdir"/usr/share/zsh/site-functions/kapp.sh
	install -Dm0644 kapp.fish "$pkgdir"/usr/share/fish/vendor_completions.d/kapp.fish
}

sha512sums="
cb076d8dbadf5fbd722b3687907ce6d300c83e80df4b0cf4dbe39bf8c3af65333943aae95d4d595b9690b1910d97ff58331f0c29f2f64ebbd41edc3de411bccc  kapp-0.65.1.tar.gz
65e69e960e3d4d58ffb42b3dd664960b26db8f98f381d384d7cc8c29b2614d3b036cbd52f5e54272c362c34f1a6fbbd4c73539b574bbe9a5f7c7bb21aef7d4d5  test-increase-timeouts.patch
"
