# Contributor: Kevin Daudt <kdaudt@alpinelinux.org>
maintainer="Kevin Daudt <kdaudt@alpinelinux.org>"
pkgname=kapp
pkgver=0.65.0
pkgrel=1
pkgdesc="deployment tool focused on the concept of a kubernetes application"
url="https://carvel.dev/kapp"
arch="all"
license="Apache-2.0"
options="net"
makedepends="go"
checkdepends="gotestfmt"
subpackages="
	$pkgname-bash-completion:bashcomp
	$pkgname-zsh-completion:zshcomp
	$pkgname-fish-completion:fishcomp
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/carvel-dev/kapp/archive/v$pkgver/kapp-$pkgver.tar.gz
	test-increase-timeouts.patch
	"

build() {
	go build \
		-ldflags="-X carvel.dev/kapp/pkg/kapp/version.Version=$pkgver -buildid=" \
		-trimpath \
		-o kapp ./cmd/kapp

	./kapp completion bash >kapp.bash
	./kapp completion zsh >kapp.zsh
	./kapp completion fish >kapp.fish
}

check() {
	go test -json -v ./pkg/... | tee test.log | gotestfmt -showteststatus -hide empty-packages
}

package() {
	install -Dm0755 kapp "$pkgdir"/usr/bin/kapp
	install -Dm0644 kapp.bash "$pkgdir"/usr/share/bash-completion/completions/kapp
	install -Dm0644 kapp.zsh "$pkgdir"/usr/share/zsh/site-functions/kapp.sh
	install -Dm0644 kapp.fish "$pkgdir"/usr/share/fish/vendor_completions.d/kapp.fish
}

sha512sums="
c70b1a9bd769ab541217f75808c83d410dd1837ba6429f1547ca71114a947cacf132261d9ac9323ce7a5ecdbcd48a14d2a3cfe4d3cb29075e4b6339aa7f21019  kapp-0.65.0.tar.gz
65e69e960e3d4d58ffb42b3dd664960b26db8f98f381d384d7cc8c29b2614d3b036cbd52f5e54272c362c34f1a6fbbd4c73539b574bbe9a5f7c7bb21aef7d4d5  test-increase-timeouts.patch
"
