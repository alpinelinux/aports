# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=mitra
pkgver=4.13.1
pkgrel=0
_mitraweb="${pkgver%.*}.0"
pkgdesc="ActivityPub microblogging platform written in Rust"
url="https://mitra.social/@mitra"
# loongarch64, ppc64le, riscv64, s390x: mitra v3 removed native-tls feature
# armhf, armv7, x86: starting with v3.4.0 - "literal out of range for usize"
arch="aarch64 x86_64"
license="AGPL-3.0-only"
depends="postgresql"
makedepends="
	cargo
	cargo-auditable
	nodejs
	npm
	"
install="$pkgname.pre-install $pkgname.post-install"
pkgusers="mitra"
pkggroups="mitra"
subpackages="$pkgname-doc $pkgname-openrc"
source="mitra-$pkgver.tar.gz::https://codeberg.org/silverpill/mitra/archive/v$pkgver.tar.gz
	mitra-web-$_mitraweb.tar.gz::https://codeberg.org/silverpill/mitra-web/archive/v$_mitraweb.tar.gz
	mitra.initd
	init.sql
	config.yaml
	"
builddir="$srcdir/mitra"

_cargo_opts="--frozen --no-default-features --features production"

prepare() {
	default_prepare

	cargo fetch --target="$CTARGET" --locked

	cd "$srcdir/mitra-web"

	npm ci --foreground-scripts
}

build() {
	RUSTFLAGS="--cfg=ammonia_unstable" \
	DEFAULT_CONFIG_PATH="/etc/mitra/config.yaml" \
	cargo auditable build $_cargo_opts --release

	cd "$srcdir/mitra-web"

	echo 'VITE_BACKEND_URL=' > .env.local
	npm run build
}

check() {
	# These tests require a database connection
	RUSTFLAGS="--cfg=ammonia_unstable" \
	cargo test $_cargo_opts --workspace \
		--exclude mitra_models -- \
		--skip test_follow_unfollow \
		--skip test_hide_reblogs \
		--skip test_subscribe_unsubscribe \
		--skip test_get_jrd \
		--skip test_filter_mentions_none \
		--skip test_filter_mentions_only_known \
		--skip test_prepare_instance_ed25519_key \
		--skip test_mute \
		--skip test_federation_filter \
		--skip test_parse_content_object_link_and_mention \
		--skip test_get_dynamic_config \
		--skip test_parse_content_empty_post

	cd "$srcdir/mitra-web"

	npm run test
}

package() {
	install -Dm755 target/release/mitra -t "$pkgdir"/usr/bin

	mkdir -p "$pkgdir"/usr/share/webapps
	cp -r "$srcdir"/mitra-web/dist \
		"$pkgdir"/usr/share/webapps/mitra

	install -Dm644 docs/* -t "$pkgdir"/usr/share/doc/$pkgname
	install -Dm644 config_dev.example.yaml \
		contrib/*.nginx \
		contrib/monero/wallet.conf \
		-t "$pkgdir"/usr/share/doc/$pkgname/examples

	install -Dm640 -g mitra "$srcdir"/config.yaml -t "$pkgdir"/etc/mitra
	install -dm755 -o mitra -g mitra "$pkgdir"/var/lib/mitra
	install -Dm644 "$srcdir"/init.sql -t "$pkgdir"/usr/share/mitra
	install -Dm755 "$srcdir"/mitra.initd "$pkgdir"/etc/init.d/mitra
}

sha512sums="
933e8c328f53c0e56e28c85d41c87a7abeca3368a94d69edb14e6d3dad4dc67d7cdd75e9a552a6588904febd2409d96a71df0ab360335f6b026bc128d8c7e867  mitra-4.13.1.tar.gz
b4120d86feb91d82a8b6da31649f44a4f19d6880b7eba164383973d0112702f7b6e163facfe366bae5e9d9e1828edfb3c6d2c4e4d805a4a3bd1ab439f4dd16fe  mitra-web-4.13.0.tar.gz
549646eff4fcc03109d6eddb6f2540f4d0d3f5994273c00f688ea616a4f02c6866b4ef88fdc00e8fb06e50d7d22cd882beb40926e9931d16fa0332ad06f6a677  mitra.initd
180a47f5072534418b4aac3ce7c885a4f7e4dc38aca80d6d81c79848d12fbe24799788c3575bd195030a10da5e0372f87fa2809a4ef99a48eaa6df52f4d053dd  init.sql
bd1e23d6168d2df1bf5c97b20ce5343c34d5bb1b3d7dacaa8a71d66c8bd7920c2fb2d2d2f77722d13594553c24287581b75f3b6c2dfee233d17993442299e768  config.yaml
"
