# Contributor: André Klitzing <aklitzing@gmail.com>
# Maintainer: André Klitzing <aklitzing@gmail.com>
pkgname=ostree
pkgver=2019.1
pkgrel=0
pkgdesc="Operating system and container binary deployment and upgrades"
options="!check" # Tests are flaky on CI
url="https://github.com/ostreedev/ostree"
arch="all"
license="LGPL-2.0-or-later"
makedepends="bison glib-dev xz-dev libarchive-dev e2fsprogs-dev
	libsoup-dev gpgme-dev fuse-dev linux-headers gtk-doc libxslt
	automake autoconf libtool"
checkdepends="bash coreutils diffutils py3-yaml xz findutils grep cpio tar"
subpackages="$pkgname-dev $pkgname-doc"
source="https://github.com/ostreedev/ostree/releases/download/v$pkgver/libostree-$pkgver.tar.xz
	disable-tests.patch
	"
builddir="$srcdir/lib$pkgname-$pkgver"

prepare() {
	default_prepare
	autoreconf -fi # Rebuild due to disable-tests.patch

	# Taken from glibc's unistd.h and fixes musl
	cat <<- __EOF__ >> config.h.in
	#ifndef TEMP_FAILURE_RETRY
	#define TEMP_FAILURE_RETRY(expression) \
	  (__extension__                                                              \
	    ({ long int __result;                                                     \
	       do __result = (long int) (expression);                                 \
	       while (__result == -1L && errno == EINTR);                             \
	       __result; }))
	#endif
	__EOF__
}

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--sbindir=/usr/bin \
		--enable-gtk-doc \
		--disable-static \
		--disable-glibtest
	make
}

check() {
	# 2 Tests fail on drone-ci on armv7
	[ "$CARCH" = armv7 ] && return 0
	make check
}

package() {
	make DESTDIR="$pkgdir" install
}

sha512sums="71edc8175f05cc65baeb2973a951b3ac11d2557c2fd1a3faf2671057519e079b2ad49caca5d940935ad67674f192969325c898b60bd4d77035268c067d3f3c78  libostree-2019.1.tar.xz
9bd1abacbebac34aee929af25aed0dc18831c4624167d9f8f71875ec0a121a0b7b2ede6e95294143ecf92984f7167b02d0e34c0bf63f2f42d0ed41e6d11a95e3  disable-tests.patch"
