# Maintainer: Jo Zzsi <jozzsicsataban@gmail.com>
pkgname=dracut
pkgver=110
pkgrel=0
pkgdesc="An event driven initramfs infrastructure"
url="https://dracut-ng.github.io/dracut-ng/"
arch="noarch !armhf" # checkdepends fails
license="GPL-2.0-or-later"
makedepends="asciidoctor bash kmod-dev musl-fts-dev"
subpackages="$pkgname-modules-network $pkgname-tests $pkgname-modules $pkgname-dev $pkgname-doc $pkgname-bash-completion $pkgname-core::all"
triggers="$pkgname.trigger=/usr/share/kernel/*"
source="$pkgname-$pkgver.tar.gz::https://github.com/dracut-ng/dracut/archive/refs/tags/$pkgver.tar.gz
	README.alpine
	"
provides="initramfs-generator"
provider_priority=100 # low, somewhat experimental
builddir="$srcdir/$pkgname-ng-$pkgver"
_coredepends="bash findmnt"
_moduledepends="blkid coreutils eudev grep losetup sed util-linux-misc"

checkdepends="
	$_coredepends
	$_moduledepends
	btrfs-progs
	cpio
	cryptsetup
	device-mapper
	e2fsprogs
	elogind
	file
	gpg
	jq
	kbd
	keyutils
	kmod
	libcap-utils
	losetup
	lvm2
	mdadm
	nvme-cli
	parted
	plymouth-themes
	procps
	qemu-img
	sfdisk
	squashfs-tools
	util-linux
	xorriso
	"

case "$CARCH" in
	arm*) _qemu="qemu-system-arm";;
	ppc64le) _qemu="qemu-system-ppc64";;
	x86_64) _qemu="qemu-system-x86_64";;
	x86) _qemu="qemu-system-i386";;
	*) _qemu="qemu-system-$CARCH";;
esac

case $CARCH in
	aarch64|x86_64) checkdepends="$checkdepends $_qemu linux-virt";;
	*) checkdepends="$checkdepends $_qemu linux-lts";;
esac

build() {
	./configure --sysconfdir="/etc" --enable-test
	CFLAGS="$CFLAGS -D__GLIBC_PREREQ=" CWD="$(pwd)" make
}

package() {
	depends="$pkgname-core $pkgname-modules-network"

	DESTDIR="$pkgdir" make install
	rm -rf "$pkgdir"/usr/lib/dracut/test/container "$pkgdir"/usr/lib/dracut/test/TEST*SYSTEMD*

	install -Dm644 "$srcdir"/README.alpine -t "$pkgdir"/usr/share/doc/$pkgname/
}

network() {
	pkgdesc="network dracut modules"
	depends="dracut-modules networkmanager-cli networkmanager-initrd-generator"

	for f in \
		cifs \
		fcoe \
		fcoe-uefi \
		iscsi \
		kernel-network-modules \
		livenet \
		nbd \
		net-lib \
		network \
		nfs \
		qemu-net \
		ssh-client \
		url-lib; do
		amove usr/lib/dracut/modules.d/[0-9][0-9]$f
	done
}

modules() {
	pkgdesc="local dracut modules"
	depends="dracut-core $_moduledepends"

	rm -rf "$pkgdir"/usr/share/man/man8/*.service.*
	rm -rf "$pkgdir"/usr/lib/kernel

	amove usr/lib/dracut/modules.d
}

core() {
	pkgdesc="core tools for dracut"
	depends="$_coredepends"

	amove etc usr
}

tests() {
	pkgdesc="dracut tests"
	depends="dracut-modules-network $makedepends $checkdepends"

	amove \
		usr/lib/dracut/test \
		usr/lib/dracut/dracut.conf.d/test* \
		usr/lib/dracut/modules.d/[0-9][0-9]test*
}

check() {
	export dracutbasedir="$builddir"
	export DRACUT="$dracutbasedir"/dracut.sh

	# module tests - no qemu required
	TESTS="81" make check

	# TEST-10-BASIC fails on the aarch64|x86_64|s390x builders
	# boot tests with qemu, only pass in some architectures currently
	# case $CARCH in
	# aarch64|x86_64|s390x) TESTS="10" make check;;
	# esac
}

sha512sums="
be5affbe1c76889c0ffe3ae6c52704b559e364cfa5fa149e07a0bbe5e373c7e8c4b54e4a20e7564c91750c8e1593f7cd108806cf63053c8e30d143246e549597  dracut-110.tar.gz
fa1d65d8987d9b5846f5cd7989bc373ca4f9d787a3025284ce55e2d5439dce29f70bd75ff5e07bfa783548e080859ec8972b6887ec58993bc54a8dcc849066d6  README.alpine
"
