# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=openjdk8-loongarch
pkgver=8.472.08
pkgrel=0
_bootver=8.452.09-r0
_majorver=${pkgver%%.*}
_pkgver=${pkgver#*.}
_pkgver=${_majorver}u${_pkgver/\./-b}-ls-ga
pkgdesc="Loongarch port of OpenJDK $_majorver"
url="https://github.com/loongson/jdk${_majorver}u"
arch="loongarch64"
license="GPL-2.0-only WITH Classpath-exception-2.0"
options="sover-namecheck !archcheck" # arch dependent files moved into subpkgs
makedepends_build="
	autoconf
	bash
	gawk
	grep
	lld
	make
	sed
	zip
	zlib-dev
	"
makedepends_host="
	alsa-lib-dev
	cups-dev
	elfutils-dev
	fontconfig-dev
	freetype-dev
	giflib-dev
	lcms2-dev
	libffi-dev
	libjpeg-turbo-dev
	libx11-dev
	libxext-dev
	libxrandr-dev
	libxrender-dev
	libxt-dev
	libxtst-dev
	linux-headers
	zlib-dev
	"
[ "$CBUILD" = "$CTARGET" ] && makedepends="
	$makedepends_build
	$makedepends_host
	java-cacerts
	java-common
	"
subpackages="
	$pkgname-demos
	$pkgname-doc
	$pkgname-jre
	$pkgname-jre-lib:jrelib:noarch
	$pkgname-jre-base:jrebase
	$pkgname-jdk
	"
source="jdk-$_pkgver.tar.gz::https://github.com/loongson/jdk${_majorver}u/archive/refs/tags/jdk$_pkgver.tar.gz
	https://dev.alpinelinux.org/archive/openjdk-loongarch/jdk-$_bootver-miniboot.tgz
	gcc15.patch
	icedtea-hotspot-lfs64.patch
	icedtea-hotspot-musl.patch
	icedtea-hotspot-noagent-musl.patch
	icedtea-int-conversion.patch
	icedtea-issue13032.patch
	icedtea-jdk-disable-vfork.patch
	icedtea-jdk-execinfo.patch
	icedtea-jdk-fix-ipv6-init.patch
	icedtea-jdk-fix-libjvm-load.patch
	icedtea-jdk-implicit.patch
	icedtea-jdk-includes.patch
	icedtea-jdk-musl.patch
	icedtea-pointer-types.patch
	loongarch-fpu_control.patch
	Example.java
	"
builddir="$srcdir/jdk${_majorver}u-jdk$_pkgver"

case "$CARCH" in
loongarch64)
	_jarch="$CARCH"
	_jvm_variants=server
	provides="
		$pkgname-bootstrap=$pkgver-r$pkgrel
		openjdk$_majorver-bootstrap=$pkgver-r$pkgrel
		openjdk$_majorver=$pkgver-r$pkgrel
		"
	replaces="openjdk$_majorver"
	provider_priority=$((_majorver + 1))
	;;
esac

_java_home="usr/lib/jvm/java-1.8-openjdk"
_jrelib="/$_java_home/jre/lib/$_jarch"

somask="lib.so libjawt.so" # prevent duplicate provides
ldpath="$_jrelib:$_jrelib/native_threads:$_jrelib/headless:$_jrelib/server:$_jrelib/jli"
sonameprefix="$pkgname:"

# enable running the JTReg tests in check?
# see comment in that function for explanation
_run_jtreg=${_run_jtreg:-0}
if [ $_run_jtreg -ne 0 ]; then
	makedepends="$makedepends java-jtreg"
	checkdepends="$checkdepends font-freefont xvfb-run"
fi

prepare() {
	default_prepare

	# update autoconf files to detect alpine
	update_config_guess
	update_config_sub

	case "$CARCH" in
	loongarch64)
		;;
	*)
		error "Please use community/openjdk8"
		return 1
		;;
	esac
}

build() {
	if [ $_run_jtreg -ne 0 ]; then
		_with_jtreg="--with-jtreg=/usr/share/java/jtreg"
	else
		_with_jtreg="--with-jtreg=no"
	fi

	if [ -n "$USE_CCACHE" ]; then
		# workaround ccache being disallowed
		export PATH="/usr/bin:/bin:/sbin:/usr/sbin"
		local ccache="--enable-ccache"
	fi

	# we want to build hotspot with better optimisations; it's set to this
	# (prepended) anyway, and it's huge
	export CFLAGS="$CFLAGS -O3"
	export CXXFLAGS="$CXXFLAGS -O3"

	# CFLAGS, CXXFLAGS and LDFLAGS are ignored as shown by a warning
	# in the output of ./configure unless used like such:
	#  --with-extra-cflags="$CFLAGS"
	#  --with-extra-cxxflags="$CXXFLAGS"
	#  --with-extra-ldflags="$LDFLAGS"
	# See also paragraph "Configure Control Variables" from "common/doc/building.md"
	# shellcheck disable=2097 disable=2098
	CFLAGS='' CXXFLAGS='' LDFLAGS='' \
		bash ./configure \
		--openjdk-target=$CHOST \
		--prefix="/$_java_home" \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var \
		--with-extra-cflags="$CFLAGS" \
		--with-extra-cxxflags="$CXXFLAGS" \
		--with-extra-ldflags="$LDFLAGS -fuse-ld=lld -Wl,--undefined-version" \
		--with-zlib=system \
		--with-giflib=system \
		--with-jobs=${JOBS:-4} \
		--with-native-debug-symbols=none \
		--with-boot-jdk="$srcdir/bootjdk" \
		$ccache \
		$_with_jtreg \
		--with-milestone="fcs" \
		--with-jvm-variants=$_jvm_variants \
		--with-debug-level=release \
		--with-vendor-name="Alpine" \
		--with-vendor-url="https://alpinelinux.org/" \
		--with-vendor-bug-url="https://gitlab.alpinelinux.org/alpine/aports/issues" \
		--with-vendor-vm-bug-url="https://gitlab.alpinelinux.org/alpine/aports/issues"

	MAKEFLAGS='' make JOBS="${JOBS:-4}" images
}

check() {
	cd build/linux-*-$_jvm_variants-release/images/j2sdk-image

	./bin/java -version

	./bin/javac "$srcdir"/Example.java -d "$builddir"
	./bin/java -classpath "$builddir" Example
}

package() {
	depends="$pkgname-jdk=$pkgver-r$pkgrel"

	mkdir -p "$pkgdir"/$_java_home

	cd build/linux-*-$_jvm_variants-release/images/
	cp -a j2sdk-image/* "$pkgdir"/$_java_home/
	rm -v "$pkgdir"/$_java_home/src.zip

	# symlink to shared java cacerts store
	rm -v "$pkgdir"/$_java_home/jre/lib/security/cacerts
	ln -sv /etc/ssl/certs/java/cacerts \
		"$pkgdir"/$_java_home/jre/lib/security/cacerts
}

jrelib() {
	pkgdesc="$pkgdesc Java Runtime (class libraries)"
	depends="java-cacerts"
	provides="openjdk$_majorver-jre-lib=$pkgver-r$pkgrel"
	replaces="openjdk$_majorver-jre-lib"

	amove \
		$_java_home/jre/lib/images \
		$_java_home/jre/lib/*.jar \
		$_java_home/jre/lib/security \
		$_java_home/jre/lib/ext/*.jar \
		$_java_home/jre/lib/cmm \
		$_java_home/jre/ASSEMBLY_EXCEPTION \
		$_java_home/jre/THIRD_PARTY_README \
		$_java_home/jre/LICENSE
}

jre() {
	pkgdesc="$pkgdesc Java Runtime"
	depends="font-dejavu"
	provides="java-jre openjdk$_majorver-jre=$pkgver-r$pkgrel"
	replaces="openjdk$_majorver-jre"

	amove \
		$_java_home/jre/bin/policytool \
		$_java_home/bin/appletviewer \
		$_java_home/bin/policytool \
		$_java_home/jre/lib/$_jarch/libawt_xawt.so \
		$_java_home/jre/lib/$_jarch/libfontmanager.so \
		$_java_home/jre/lib/$_jarch/libjawt.so \
		$_java_home/jre/lib/$_jarch/libjsoundalsa.so \
		$_java_home/jre/lib/$_jarch/libsplashscreen.so
}

jrebase() {
	pkgdesc="$pkgdesc Java Runtime (no GUI support)"
	depends="$pkgname-jre-lib=$pkgver-r$pkgrel java-common"
	provides="java-jre-headless openjdk$_majorver-jre-base=$pkgver-r$pkgrel"
	replaces="openjdk$_majorver-jre-base"

	amove \
		$_java_home/bin/java \
		$_java_home/bin/orbd \
		$_java_home/bin/rmid \
		$_java_home/bin/servertool \
		$_java_home/bin/unpack200 \
		$_java_home/bin/keytool \
		$_java_home/bin/pack200 \
		$_java_home/bin/rmiregistry \
		$_java_home/bin/tnameserv \
		$_java_home/lib/$_jarch/jli

	# Rest of the jre subdir (which were not taken by -jre subpkg).
	amove $_java_home/jre

	ln -s java-1.8-openjdk "$subpkgdir"/usr/lib/jvm/java-8-openjdk
}

doc() {
	default_doc

	amove $_java_home/man
}

demos() {
	pkgdesc="$pkgdesc Java Demos and Samples"
	depends="$pkgname-jdk=$pkgver-r$pkgrel"
	provides="openjdk$_majorver-demos=$pkgver-r$pkgrel"
	replaces="openjdk$_majorver-demos"

	amove \
		$_java_home/demo \
		$_java_home/sample
}

jdk() {
	pkgdesc="$pkgdesc (JDK) ($_jvm_variants variant)"
	depends="$pkgname-jre=$pkgver-r$pkgrel"
	provides="java-jdk openjdk$_majorver-jdk=$pkgver-r$pkgrel"
	replaces="openjdk$_majorver-jdk"

	amove \
		$_java_home/bin \
		$_java_home/lib \
		$_java_home/include
}

create_miniboot() {
	(
		cat <<-'EOF'
			bin/jar
			bin/java
			bin/javac
			bin/javah
			bin/javap
			bin/native2ascii
			bin/rmic
			jre/lib/charsets.jar
			jre/lib/currency.data
			jre/lib/jce.jar
			jre/lib/jfr.jar
			jre/lib/jsse.jar
			jre/lib/loongarch64/jvm.cfg
			jre/lib/loongarch64/libawt.so
			jre/lib/loongarch64/libawt_headless.so
			jre/lib/loongarch64/libjava.so
			jre/lib/loongarch64/libnet.so
			jre/lib/loongarch64/libnio.so
			jre/lib/loongarch64/libverify.so
			jre/lib/loongarch64/libzip.so
			jre/lib/loongarch64/server/libjvm.so
			jre/lib/resources.jar
			jre/lib/rt.jar
			jre/lib/security/java.security
			jre/lib/tzdb.dat
			lib/ct.sym
			lib/loongarch64/jli/libjli.so
			lib/tools.jar
		EOF
	) | tar -C "$builddir"/build/linux-*-$_jvm_variants-release/images/j2sdk-image \
		-zcf "jdk-$pkgver-r$pkgrel-miniboot.tgz" \
		--transform 's|^|bootjdk/|' \
		--numeric-owner --owner=0 --group=0 -T -
}

sha512sums="
9ea80280253925a9d1425e26f22aca114565b5738a99f44aea4c55ad798029ab633b74ba09586b7a09f06a88004ad98e4e8a88d064948b7edf67f36648b7c4a8  jdk-8u472-b08-ls-ga.tar.gz
fe3081670926d7d81ebbba5300942e221e1adb63b9a7396d04bd7fc79ee396263723321c8980ca52ac0d40021741082204439f3f215c05faf59eeca77bc4792b  jdk-8.452.09-r0-miniboot.tgz
c29d01f8a2028cdb07a92fbee7602e0c12bdba93d31c9455c3a0c7172486988073f9e56397f93a677f5040d82505f496d4992c8214b3434d7d5e38c29906aba6  gcc15.patch
1c41de61fbd389a17dae9ecc45c2c6c75690982fd68c977b83ed114a12c6501847dd7072b42a4467a90874703d364859b4142e00fef0150dda3e9b84784aa2f2  icedtea-hotspot-lfs64.patch
3108162f047feaeeded4f5f9e1b9acc56cb574db26a0bfef1d06ec566080d2700e79336a05a63562fa0daa06508f77a7da55ea69e4700c5f4811585eed044a89  icedtea-hotspot-musl.patch
9cb136c2419120dfac9c1344ca04bf379c8e9d2feaf8be9e82ea35360bfd8bba7e0d329076c5df23b327a843f519a91f60e5b1d2ce7d4f0241c28293fda85686  icedtea-hotspot-noagent-musl.patch
4fcad23d533d6a1fd5526223cb76330aebbbbab3766c43a5b6d5d8cc9c729381d153cced81aae2666798c82e90e10e193db33207b357e01fb5ebd0b686263394  icedtea-int-conversion.patch
e1bca07aa1a25258ee9c8e9870f8d475db788bab1a354c5458196012aaf20fba8b3968b646d18792ab7135e9b75cbebafc53fda176166bc6ddfd13e4a43b1c8d  icedtea-issue13032.patch
67cc3e267044ab46b0b40fa57e0a0a769070b544799bdb1ba63facd351cc608cd9bc764615991f7c2b0446e697a653a67d15476ca1c263dbc1f03e90cfe23ec4  icedtea-jdk-disable-vfork.patch
7128d322582edb4e3edc7beb16b079c078bac98f66e20693dc84c78afc4e3ea6042fc35d69787cfffa17cdbc36f04b6794807d1a681864059e673e4875e72eea  icedtea-jdk-execinfo.patch
2e1f63fb27b02c168a22bad5ebce1c44d1967989e3ffd2dc4ce5d13ddb7f9ac273c970b1e24548debdee1eac6651adb6ede9430a61f96349adbd0962c390b6e5  icedtea-jdk-fix-ipv6-init.patch
e327ea56c245603bcb5562c4155dfd3c4d7c071fbface84f7cc821a73de8a4f23a2cdbb6c412656127c7ac12bed24068e63e77d6dd10150afbab631827f8a4f0  icedtea-jdk-fix-libjvm-load.patch
21a16599d7e0aaf2997db59ada5af63e25484949ca965a34536ee44b950a132a6b5ca0b4922a6919d840a84ba0bb8413d87d2b97ea2c65c00e8766cc470c267d  icedtea-jdk-implicit.patch
ca29f22485f311d08ac2c465b9be39e77e0fda38c3f18fff6cbd19e5127fe6aafb3d062fa12fc52dad6903a337e3fb406996780d7d4c02dd408f509b5921594f  icedtea-jdk-includes.patch
9137942281063bc0f9762dd0a9f2f7b847f00a0b351e73613a70d0f0123070f45d48df484ab51619daa567e801891d4486fa7fe76b4d06063eaa0123fa7244cf  icedtea-jdk-musl.patch
d794c31589dc708ac842a1d89776d617cfd045f5afef89c36093018f6dfdf7cd99973fe9573edb707865f31fe6cec407a7f550c0c32769d583916e4700608a83  icedtea-pointer-types.patch
bb8b954d1bebf0f739527890ed20e80bcb1f3c78ef42cab45fb42e0641008a4234492df03d01d04e0f394a00e02f3b346695b7df9f45a87101971f640bacd450  loongarch-fpu_control.patch
601ac59e59d32cbaf91f7541bd8173b38c68cbec96a7fb74227017afc8e5dc6ce4b8be03e92dd34cf52370e5d52beb780808af57b17c79c53ae8ec64cd34a92d  Example.java
"
