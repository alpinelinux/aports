# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Bart Ribbers <bribbers@disroot.org>
pkgname=kdb
pkgver=3.2.0
pkgrel=15
pkgdesc="Database connectivity and creation framework for various database vendors"
url="https://community.kde.org/KDb"
# armhf blocked by extra-cmake-modules
arch="all !armhf"
license="LGPL-2.0-or-later"
makedepends="
	extra-cmake-modules
	icu-dev
	kcoreaddons5-dev
	mariadb-dev
	postgresql-dev
	python3
	qt5-qtbase-dev
	qt5-qttools-dev
	samurai
	sqlite-dev
	"
subpackages="$pkgname-dev $pkgname-lang $pkgname-sqlite $pkgname-mysql $pkgname-postgresql"
source="https://download.kde.org/stable/kdb/src/kdb-$pkgver.tar.xz
	0001-fix-build-with-newer-qt.patch
	0002-fix-build-with-postgresql-12+.patch
	cmake-postgresql12+.patch
	fix-build-with-newer-ICU.patch
	cmake4-1.patch
	cmake4-2.patch
	"

build() {
	cmake -B build -G Ninja \
		-DBUILD_TESTING=1 \
		-DCMAKE_BUILD_TYPE=RelWithDebInfo \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DPYTHON_EXECUTABLE=/usr/bin/python3
	cmake --build build
}

check() {
	ctest --test-dir build -E "HeadersTest"
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sqlite() {
	pkgdesc="$pkgdesc (sqlite driver)"

	amove \
		usr/lib/qt5/plugins/kdb3/kdb_sqlitedriver.so \
		usr/lib/qt5/plugins/kdb3/sqlite3/kdb_sqlite_icu.so \
		usr/bin/kdb3_sqlite3_dump
}

mysql() {
	pkgdesc="$pkgdesc (mysql driver)"

	amove usr/lib/qt5/plugins/kdb3/kdb_mysqldriver.so
}

postgresql() {
	pkgdesc="$pkgdesc (postgresql driver)"

	amove usr/lib/qt5/plugins/kdb3/kdb_postgresqldriver.so
}

sha512sums="
7df22f2c5b6e20ae3de71cb6c76b234d2f1f33b2abcdffa85be313c63d067a40a85ed102b6256207315db08ced5d69f8bc40afdf84a188463713a6b2ffdb2df7  kdb-3.2.0.tar.xz
7fc18bd99d45ed6f874d7aceff271d6262bae550340b243414026c1683837a27b6e261a992a187f4fbebfdf5ac5fd67400528b6d1b3b9c33abb35fe4237989bf  0001-fix-build-with-newer-qt.patch
c7d6fe068bf1dfd206d96e1214595d7001ce03cc591837bbb1e500d440178d95eedb3f07d2fe4a5d9c07fcfe6dad0ee5e0a74ede5ecca4e09572dea1ca35110b  0002-fix-build-with-postgresql-12+.patch
f91131c4d8ffcac3b2f05c8f60b4ec736027054168acb8699b9b3e017f12923ad9a2fbbf3530c4d19840099c5aac79fefd9c53060451285ef8a1eccef8f14694  cmake-postgresql12+.patch
69c3901ebfee776303be25ee6da22b26b3aa030a81ffbbc2a7bafa9e741fc888cc453022314c09da0873f94c9c34e6a8b98491c32c7650c277bbe6e45532594c  fix-build-with-newer-ICU.patch
d1b604b7cca7c3ba3e2825580e9985bc31549531877004b7a77e55e336ba39eaa6b151d0766df7bac37131fe786356c87c277beafca06e4eb4b1a33922b6587f  cmake4-1.patch
d12d7c307f71b9251b30308df40173a48a957f339084a77290240b0d7cde6c0916f2516fadd86b21270c7eacac90164a5ad85379b410b6a0b9e219938dcd05b7  cmake4-2.patch
"
