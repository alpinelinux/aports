# Maintainer: omni <omni+alpine@hack.org>
maintainer="omni <omni+alpine@hack.org>"
pkgname=racksdb
pkgver=0.6.0
pkgrel=1
pkgdesc="YAML-based database of datacenter infrastructures"
url="https://rackslab.io/en/solutions/racksdb/"
arch="noarch"
license="GPL-3.0-or-later"
depends="py3-$pkgname=$pkgver-r$pkgrel"
_pydepends="python3
	pango
	py3-clustershell
	py3-cairo
	py3-gobject3
	py3-pyaml
	py3-rfl-log
	"
_webdepends="py3-flask
	py3-requests-toolbelt
	"
makedepends="asciidoctor npm py3-gpep517 py3-setuptools py3-wheel"
checkdepends="$_pydepends
	$_webdepends
	py3-parameterized
	py3-pytest
	py3-pytest-cov
	py3-werkzeug
	"
subpackages="$pkgname-doc
	py3-$pkgname-web-pyc:_py3_web_pyc
	py3-$pkgname-web:_py3_web
	py3-$pkgname-pyc
	py3-$pkgname:_py3
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/rackslab/RacksDB/archive/refs/tags/v$pkgver.tar.gz
	quickstart.adoc.patch
	"
builddir="$srcdir/RacksDB-$pkgver"
options="net" # npm

case "$CARCH" in
loongarch64|ppc64le|s390x|x86)
	# https://github.com/rollup/rollup/pull/5997
	;;
*)
	subpackages="$subpackages $pkgname-web:_web $pkgname-web-doc:_web_doc"
	;;
esac

prepare() {
	default_prepare

	case "$CARCH" in
	loongarch64|ppc64le|s390x|x86) ;;
	*)
		cd frontend
		npm ci --foreground-scripts
		;;
	esac
}

build() {
	gpep517 build-wheel --wheel-dir .dist --output-fd 3 3>&1 >&2

	for adocman in docs/man/*.adoc; do
		asciidoctor --backend manpage --attribute mansource="RacksDB $pkgver" "$adocman"
	done

	case "$CARCH" in
	loongarch64|ppc64le|s390x|x86) ;;
	*)
		cd frontend
		npm run build
		;;
	esac
}

check() {
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer .dist/*.whl
	.testenv/bin/python3 -m pytest

	case "$CARCH" in
	loongarch64|ppc64le|s390x|x86) ;;
	*)
		cd frontend
	# check for vulnerabilities, some fixes may have breaking changes and need
	# to be handled with care, only fail on Severity: high, TODO: change this
		npm audit --audit-level=high
		;;
	esac
}

package() {
	python3 -m installer -d "$pkgdir" .dist/*.whl
	rm -r "$pkgdir"/usr/lib/python3.*/site-packages/"$pkgname"/tests

	case "$CARCH" in
	loongarch64|ppc64le|s390x|x86) ;;
	*)
		install -dm0755 "$pkgdir"/usr/share/"$pkgname"/frontend
		cp -r frontend/dist/* \
			"$pkgdir"/usr/share/"$pkgname"/frontend/
		;;
	esac

	install -Dm0644 schemas/* \
		-t "$pkgdir"/usr/share/"$pkgname"/schemas/

	install -dm0755 "$pkgdir"/etc/racksdb/ "$pkgdir"/var/lib/racksdb/

	install -Dm0644 docs/man/racksdb.1 -t "$pkgdir"/usr/share/man/man1/
	install -Dm0644 CHANGELOG.md -t "$pkgdir"/usr/share/doc/"$pkgname"/
	cp -r examples docs/modules/db docs/modules/usage \
		docs/modules/install/pages/quickstart.adoc \
		-t "$pkgdir"/usr/share/doc/"$pkgname"/
}

_web() {
	depends="py3-$pkgname-web=$pkgver-r$pkgrel"
	pkgdesc="$pkgname Web UI"

	amove usr/bin/racksdb-web
	amove usr/share/racksdb/frontend
}

_web_doc() {
	pkgdesc="$pkgname Web UI (documentation)"
	install_if="${subpkgname%-doc}=$pkgver-r$pkgrel docs"

	install -Dm0644 "$builddir"/docs/man/racksdb-web.1 \
		-t "$subpkgdir"/usr/share/man/man1/
	gzip -9 "$subpkgdir"/usr/share/man/man1/*.1
}

_py3_web_pyc() {
	pkgdesc="Precompiled Python bytecode for ${subpkgname%-pyc}"
	install_if="${subpkgname%-pyc}=$pkgver-r$pkgrel pyc"

	amove usr/lib/python3*/site-packages/racksdb/web/__pycache__
}

_py3_web() {
	depends="$_webdepends
		py3-$pkgname=$pkgver-r$pkgrel
		"
	pkgdesc="$pkgname Web UI python3 bindings"

	amove usr/lib/python3*/site-packages/racksdb/web
}

_py3() {
	depends="$_pydepends"
	pkgdesc="$pkgname python3 bindings"

	amove usr/lib/python3*
}

sha512sums="
ef642ab23a63ebd516a9e15e5302eea47c78cc9679b72b45331f2484246747003e802653f76083ba20b57e494730ef50660333e38a6aa98c0d7588c17ad6fad0  racksdb-0.6.0.tar.gz
ca7d1f64185ad179d3ac21ec955784226558f3bb270efc3a6e9355e4a363978b25ada9e73488b61b67c5e5ab7a7600a276bd16768839f66409828d2a55c2197b  quickstart.adoc.patch
"
