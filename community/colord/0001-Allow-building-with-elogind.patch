From 069f8df541f461b8d34416137318a21d6cddb7a2 Mon Sep 17 00:00:00 2001
From: Clayton Craft <clayton@craftyguy.net>
Date: Wed, 8 Jan 2025 12:09:12 -0800
Subject: [PATCH] Allow building with elogind

This makes the runtime systemd dep requirement optional when building
with -Dsystemd=true so that colord can be built with support for
libsystemd on distros that use elogind. There should be no impact here
when building colord on distros that use systemd, both libsystemd and
systemd should exist in that case.

Signed-off-by: Achill Gilgenast <achill@achill.org>
---
 meson.build     | 27 +++++++++++++++++----------
 src/meson.build |  2 +-
 2 files changed, 18 insertions(+), 11 deletions(-)

diff --git a/meson.build b/meson.build
index 67b417038cf9..4a0937c598ba 100644
--- a/meson.build
+++ b/meson.build
@@ -127,20 +127,27 @@ if get_option('udev_rules')
 endif
 
 if get_option('systemd')
-  systemd = dependency('systemd')
+  systemd = dependency('systemd', required : false)
   libsystemd = dependency('libsystemd')
   conf.set('HAVE_SYSTEMD', '1')
   systemd_root_prefix = get_option('systemd_root_prefix')
-  if systemd_root_prefix == ''
-    systemduserunitdir = systemd.get_variable(pkgconfig: 'systemduserunitdir')
-    systemdsystemunitdir = systemd.get_variable(pkgconfig: 'systemdsystemunitdir')
-    tmpfilesdir = systemd.get_variable(pkgconfig: 'tmpfilesdir')
-    sysusersdir = systemd.get_variable(pkgconfig: 'sysusersdir')
+  if systemd.found()
+    if systemd_root_prefix == ''
+      systemduserunitdir = systemd.get_variable(pkgconfig: 'systemduserunitdir')
+      systemdsystemunitdir = systemd.get_variable(pkgconfig: 'systemdsystemunitdir')
+      tmpfilesdir = systemd.get_variable(pkgconfig: 'tmpfilesdir')
+      sysusersdir = systemd.get_variable(pkgconfig: 'sysusersdir')
+    else
+      systemduserunitdir = systemd.get_variable(pkgconfig: 'systemduserunitdir', pkgconfig_define: ['rootprefix', systemd_root_prefix])
+      systemdsystemunitdir = systemd.get_variable(pkgconfig: 'systemdsystemunitdir', pkgconfig_define: ['rootprefix', systemd_root_prefix])
+      tmpfilesdir = systemd.get_variable(pkgconfig: 'tmpfilesdir', pkgconfig_define: ['rootprefix', systemd_root_prefix])
+      sysusersdir = systemd.get_variable(pkgconfig: 'sysusersdir', pkgconfig_define: ['rootprefix', systemd_root_prefix])
+    endif
   else
-    systemduserunitdir = systemd.get_variable(pkgconfig: 'systemduserunitdir', pkgconfig_define: ['rootprefix', systemd_root_prefix])
-    systemdsystemunitdir = systemd.get_variable(pkgconfig: 'systemdsystemunitdir', pkgconfig_define: ['rootprefix', systemd_root_prefix])
-    tmpfilesdir = systemd.get_variable(pkgconfig: 'tmpfilesdir', pkgconfig_define: ['rootprefix', systemd_root_prefix])
-    sysusersdir = systemd.get_variable(pkgconfig: 'sysusersdir', pkgconfig_define: ['rootprefix', systemd_root_prefix])
+    systemduserunitdir = get_option('prefix') / 'lib' / 'systemd' / 'user'
+    systemdsystemunitdir = get_option('prefix') / 'lib' / 'systemd' / 'system'
+    tmpfilesdir = get_option('prefix') / 'lib' / 'tmpfiles.d'
+    sysusersdir = get_option('prefix') / 'lib' / 'sysusers.d'
   endif
 endif
 
diff --git a/src/meson.build b/src/meson.build
index afe3b2c0a617..3c866e60d1b2 100644
--- a/src/meson.build
+++ b/src/meson.build
@@ -26,7 +26,7 @@ resources_src = gnome.compile_resources(
 )
 
 colord_extra_deps = []
-if get_option('systemd')
+if get_option('systemd') and libsystemd.found()
   colord_extra_deps += libsystemd
 endif
 
-- 
2.52.0

