# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=ncspot
pkgver=0.11.2
pkgrel=0
pkgdesc="Cross-platform ncurses Spotify client inspired by ncmpc and the likes"
url="https://github.com/hrkfdn/ncspot"
# ppc64le: fails to build ring crate
# others: limited by rust/cargo
arch="aarch64 armhf armv7 x86 x86_64"
license="BSD-2-Clause"
makedepends="
	cargo
	dbus-dev
	libxcb-dev
	ncurses-dev
	openssl-dev>3
	pulseaudio-dev
	python3
	"
source="https://github.com/hrkfdn/ncspot/archive/v$pkgver/ncspot-$pkgver.tar.gz"
options="!check"  # there's only one unit test (in v0.8.1)

# Optimize binary for size (18 MiB -> 8.2 MiB in v0.8.1).
export CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1
export CARGO_PROFILE_RELEASE_LTO="true"
export CARGO_PROFILE_RELEASE_OPT_LEVEL="s"
export CARGO_PROFILE_RELEASE_PANIC="abort"

_cargo_opts='--frozen --features cover,share_selection'

prepare() {
	default_prepare

	cargo fetch --locked
}

build() {
	cargo build $_cargo_opts --release
}

check() {
	cargo test $_cargo_opts
}

package() {
	cargo install $_cargo_opts --offline --path . --root="$pkgdir/usr"
	rm "$pkgdir"/usr/.crates*
}

sha512sums="
e673a27067b09133975a7b8ae97fea25075ab4a5ff759fa5199100c08c5883625b5bea2a7b90983e68f9fca0b92b44964a795724c5f9327839e3d758754b949f  ncspot-0.11.2.tar.gz
"
