# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@lucaweiss.eu>
pkgname=openrazer
pkgver=3.11.0
pkgrel=1
pkgdesc="Open source driver and user-space daemon to control Razer lighting and other features on GNU/Linux"
url="https://openrazer.github.io/"
arch="noarch"
license="GPL-2.0-only"
depends="
	py3-daemonize
	py3-dbus
	py3-gobject3
	py3-setproctitle
	py3-udev
	"
makedepends="
	py3-setuptools
	"
subpackages="
	$pkgname-doc
	$pkgname-src
	$pkgname-systemd
	$pkgname-udev
	py3-$pkgname-pyc
	py3-$pkgname:py3
	"
source="https://github.com/openrazer/openrazer/archive/v$pkgver/openrazer-v$pkgver.tar.gz"
options="!check" # No tests

# secfixes:
#   3.4.0-r0:
#     - CVE-2022-29021
#     - CVE-2022-29022
#     - CVE-2022-29023
#   3.5.1-r0:
#     - CVE-2022-23467

package() {
	DESTDIR="$pkgdir" make appstream_install udev_install daemon_install xdg_install setup_dkms
}

src() {
	depends="akms"

	local destdir="usr/src/openrazer-driver-$pkgver"

	install -d "$subpkgdir/$destdir"

	cd "$subpkgdir"

	mv "$pkgdir/$destdir"/driver/* "$destdir"/
	rm -r "$pkgdir"/usr/src

	cat > "$destdir"/AKMBUILD <<-EOF
	modname=openrazer-driver
	modver=$pkgver-r$pkgrel
	built_modules='razeraccessory.ko razerkbd.ko razerkraken.ko razermouse.ko'
	EOF
}

py3() {
	depends="py3-numpy"

	cd "$builddir"
	DESTDIR="$subpkgdir" make python_library_install
}

sha512sums="
fe55558a5b43d2074da8f04bcc1e52000c9adfa1a9aa72595e40dc460367a387f525e5597e30d6877c760ed87e472a4390c9b217142fbdbc2bbee9aaf03aec49  openrazer-v3.11.0.tar.gz
"
