# Contributor: Leo <thinkabit.ukim@gmail.com>
# Maintainer: team/alpine-desktop <pabloyoyoista@postmarketos.org>
pkgname=elogind
pkgver=255.22
pkgrel=0
pkgdesc="Standalone fork of systemd's elogind"
url="https://github.com/elogind/elogind"
arch="all"
license="GPL-2.0-or-later LGPL-2.1-or-later"
depends="dbus shadow busctl=$pkgver-r$pkgrel"
options="!check" # Tests fail on builders
makedepends="
	acl-dev
	coreutils
	dbus-dev
	docbook-xsl
	eudev-dev
	gettext-dev
	glib-dev
	gperf
	libcap-dev
	libseccomp-dev
	libxslt-dev
	linux-pam-dev
	m4
	meson
	pcre2-dev
	py3-jinja2
	"
subpackages="
	$pkgname-common:_common
	$pkgname-dev
	$pkgname-doc
	$pkgname-lang
	$pkgname-openrc
	lib$pkgname:libs
	$pkgname-zsh-completion
	$pkgname-bash-completion
	busctl:_busctl
	"
source="https://github.com/elogind/elogind/archive/V$pkgver/elogind-V$pkgver.tar.gz
	elogind.initd
	0001-shared-remove-gshadow.patch
	0002-basic-use-sh-instead-of-bash-in-the-shebang.patch
	0003-shared-include-signal.h-in-async.h.patch
	0004-add-missing-musl_missing.h.patch
	0005-use-sys-prctl-instead-of-linux-prctl-to-avoid-duplic.patch
	0006-pass-correct-parameters-to-getdents64.patch
	0007-errno-util-Make-STRERROR-portable-for-musl.patch
	0008-distinguish-XSI-compliant-strerror_r-from-GNU-specif.patch
	0009-sd-journal-remove-last_stat.patch
	"

build() {
	export LDFLAGS="$LDFLAGS -lintl"
	abuild-meson \
		--libexecdir=/usr/libexec/elogind \
		-Db_lto=true \
		-Dcgroup-controller=elogind \
		-Ddefault-hierarchy=unified \
		-Ddefault-kill-user-processes=false \
		-Dhalt-path=/sbin/halt \
		-Dman=enabled \
		-Dpolkit=enabled \
		-Dreboot-path=/sbin/reboot \
		-Dtests="$(want_check && echo true || echo false)" \
		\
		-Dpamconfdir=/etc/pam.d \
		-Dudevrulesdir=/usr/lib/udev/rules.d \
		-Dsplit-usr=false \
		-Dutmp=false \
		build
	meson compile -C build
}

check() {
	meson test --print-errorlogs -C build
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C build

	# Claim compatiblity with systemd and systemd-logind
	ln -s libelogind.pc "$pkgdir"/usr/lib/pkgconfig/libsystemd.pc
	ln -s libelogind.pc "$pkgdir"/usr/lib/pkgconfig/libsystemd-logind.pc
	ln -s elogind "$pkgdir"/usr/include/systemd

	# Install headers from elogind
	install -Dm644 src/systemd/sd-id128.h usr/include/sd-id128.h
	install -Dm644 src/systemd/_sd-common.h usr/include/_sd-common.h

	# Install openrc service
	install -Dm755 "$srcdir"/elogind.initd "$pkgdir"/etc/init.d/elogind
}

_common() {
	pkgdesc="common components for elogind and related tools"
	depends=
	amove usr/lib/elogind/libelogind-shared-*.so
}

_busctl() {
	pkgdesc="tool for monitoring and introspecting the D-Bus bus"
	depends=
	amove usr/bin/busctl
}

sha512sums="
7b1e1c6cc917bcaac1b6f8ac538b355cf53a4236f1c5248bdc44caec25d012b6bced5395dc3a0d77c4e2783f196d939e0edbabd7c901124e683c54e298c05b03  elogind-V255.22.tar.gz
fe8855ffbb8149a8c3892791c4d179c8edf863e9641892c700637b352e8d9d31e406b1d6c5fed5c19e35eb9dcf33bfdb93f0b5a659aaef299ec10b442a878146  elogind.initd
6ec56a5a76709ea02bb72e107b0205148c70882c11e439ae3dc80478d465475d054291e432af6f43ccc5dcd177e6883cea944c3155d44d55dfb67bcf695eb1ae  0001-shared-remove-gshadow.patch
c842f69bdbdeceea126972401380b5b543bd13481aa57c173e95ebf1f22d6f07af8187ec1e4a488bd15d8e6c296a92f3c3121264af0f91c8dfda6f2341712c01  0002-basic-use-sh-instead-of-bash-in-the-shebang.patch
d3f5e71fe8b4a2eae4474c048ee06f587833757b47d4a03b73debeb2e5b977cc36419e09bb1517ad3437c3e3810c859abb98197afa9df2dc9a5851c448af971f  0003-shared-include-signal.h-in-async.h.patch
3603a3e9fa6997dc0a194aea5d74adb0509f7f47dee7617240c8744f47d087a347fee01ed6c4084bd4491515554745b8687f769cbc3c9272f8786114e90bb3a1  0004-add-missing-musl_missing.h.patch
3669c5949e22dab107cfbf6b822c6f8aca12489c057e8d75948177c91e40a2788c26f07aa918499a1ae9aea49132d1448ae89af62dd65b955420034a16d7142d  0005-use-sys-prctl-instead-of-linux-prctl-to-avoid-duplic.patch
34409602a6b4a0b19e2f6110bbd96821da059d030a716881d58f7701187d3297a75760c647f076f858bffaf6dfbb100480b22a51fcce5b7353a537f1af1734c1  0006-pass-correct-parameters-to-getdents64.patch
3c0437e438239fc3e56c0a02f13d2dc3c614f82b09237a79cbca888e3c6318c2d748712898021411a1ac73d1293b37103d01cd90fbe62d9fe47524644ed369b0  0007-errno-util-Make-STRERROR-portable-for-musl.patch
8931ac0a4192550e092bb27d135935597ba54ba9b75adbb732cd0133bf4cc093687d18baff6a2e3fe9dde9be35f91806ca20a5975256b6110786e228c9d966c8  0008-distinguish-XSI-compliant-strerror_r-from-GNU-specif.patch
b98917101f5b4489048f655613e7d4dad1f23247d67ac0765a14fd92b37ad66a76407a22745b6ae43715dffff8d5898cf4c070e85fe1fcc9cf23bed9d951a393  0009-sd-journal-remove-last_stat.patch
"
