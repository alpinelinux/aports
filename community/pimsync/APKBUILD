maintainer="Hugo Osvaldo Barrera <hugo@whynothugo.nl>"
pkgname=pimsync
pkgver=0.5.6
pkgrel=0
pkgdesc="Synchronise calendars and contacts using CalDAV, CardDAV and others"
url="https://pimsync.whynothugo.nl/"
arch="all"
license="EUPL-1.2"
makedepends="cargo sqlite-dev"
subpackages="
	$pkgname-doc
	$pkgname-zsh-completion
	"
source="pimsync-$pkgver.tar.gz::https://git.sr.ht/~whynothugo/pimsync/archive/v$pkgver.tar.gz"
builddir="$srcdir/$pkgname-v$pkgver"
options="net" # fetch dependencies

prepare() {
	default_prepare

	cargo fetch --target="$CTARGET" --locked
}

build() {
	export PIMSYNC_VERSION=v$pkgver-r$pkgrel
	mkdir target
	make build
}

check() {
	cargo test --frozen
	# Ensure that the system sqlite is being dynamically linked.
	ldd target/release/pimsync | grep libsqlite3.so
}

package() {
	DESTDIR="$pkgdir" PREFIX="/usr" make install --trace
}

sha512sums="
554124c69623da02ad2d1813565b403c9413da22b76ff5c233d02cac39517d2987c7b06c716442eec53d394193ec0845420743c11a86e605c5da497834384839  pimsync-0.5.6.tar.gz
"
