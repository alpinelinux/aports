# Contributor: Sören Tempel <soeren+alpine@soeren-tempel.net>
# Contributor: Stefan Wagner <stw@bit-strickerei.de>
# Contributor: Celeste <cielesti@protonmail.com>
maintainer="Hugo Osvaldo Barrera <hugo@whynothugo.nl>"
pkgname=notmuch
pkgver=0.40
pkgrel=0
pkgdesc="E-Mail index, search and tagging"
url="https://notmuchmail.org/"
arch="all"
license="GPL-3.0-or-later"
makedepends="
	bash
	bash-completion-dev
	doxygen
	emacs-nox
	git
	gmime-dev
	gpgme-dev
	gzip
	perl
	py3-cffi
	py3-gpep517
	py3-pytest
	py3-requests
	py3-setuptools
	py3-sphinx
	py3-wheel
	python3-dev
	talloc-dev
	xapian-core-dev
	"
checkdepends="
	coreutils
	dtach
	git
	mandoc
	sed
	tar
	"
subpackages="
	py3-$pkgname-pyc
	py3-$pkgname:py3
	$pkgname-doc
	$pkgname-dev
	$pkgname-libs
	$pkgname-emacs:emacs:noarch
	$pkgname-vim:vim:noarch
	$pkgname-zsh-completion
	$pkgname-bash-completion"
source="https://notmuchmail.org/releases/notmuch-$pkgver.tar.xz
	test-musl-invalid-regexp.patch
	0001-Ignore-flake-check-in-.-configure.patch
	"

prepare() {
	default_prepare
	git init -q .
}

build() {
	CFLAGS="$CFLAGS -flto=auto" \
	./configure \
		--build="$CBUILD" \
		--host="$CHOST" \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--with-api-docs \
		--without-rpath \
		--bashcompletiondir=/usr/share/bash-completion/completions \
		--zshcompletiondir=/usr/share/zsh/site-functions \
		--with-api-docs
	make

	cd bindings/python-cffi
	gpep517 build-wheel \
		--wheel-dir .dist \
		--output-fd 3 3>&1 >&2
}

check() {
	cd test
	make test-binaries

	local test
	for test in T*.sh; do
		name="$(basename "$test")"
		case "${name%%.*}" in
		# seems to have an extra Cc: and fail
		T220-reply) continue ;;
		# Requires dtach ↦ doesn't work on the builders
		*emacs*|T355-smime|T350-crypto) continue ;;

		# Requires smartcard daemon
		T351-pgpmime-mangling) continue ;;

		# XXX: Doesn't pass on the builders for some reason
		T030-config|T080-search|T050-new|T140-excludes|T520-show|T570-revision-tracking|T590-libconfig|T592-thread-breakage) continue ;;

		# FIXME fails on riscv64
		T620-lock) continue ;;

		# FIXME: These should pass but currently don't
		T150-tagging|T060-count|T070-insert|T356-protected-headers|T357-index-decryption) continue ;;

		# FIXME: hangs forever
		T391-python-cffi) continue ;;

		# Requires Python bindings installed
		T055-path-config) continue ;;
		esac

		./$test
	done
}

package() {
	make DESTDIR="$pkgdir" install

	cd bindings/python-cffi
	python3 -m installer -d "$pkgdir" .dist/*.whl

	make -C "$builddir"/vim DESTDIR="$pkgdir" \
		prefix="/usr/share/vim/vimfiles" install
}

vim() {
	depends="vim notmuch=$pkgver-r$pkgrel"
	pkgdesc="Vim plugins for $pkgname"

	amove usr/share/vim
}

emacs() {
	depends="emacs notmuch=$pkgver-r$pkgrel"
	pkgdesc="Emacs plugins for $pkgname"

	amove usr/share/emacs

	amove usr/bin/notmuch-emacs-mua
}

py3() {
	pkgdesc="$pkgdesc (for python3)"
	depends="py3-cffi"

	amove usr/lib/python3*
}

sha512sums="
937c72c05b00520cc3dbc7db6282ad65a621c8e102fbcbac3c9d99061ae510741b13ef9cf5c6476ba8e7fa15a6905631159477a938d1369db6d9885780b90867  notmuch-0.40.tar.xz
0defaeb6781694d55f2e11a5ede37214d261bab4eed328d523cfda80deb11085a1486aa13e180cebc3b24dddfa073d17f7b9e2891c176d60aafa62509a28d55c  test-musl-invalid-regexp.patch
249d1e721f09e3ef0c67691446991fbff1678ea96c4f27550bc2e8ce7ca7d043152812e919c93d3522bff7f5a3530e39d7eee5282dc4d4cd186702cd5ad904b3  0001-Ignore-flake-check-in-.-configure.patch
"
