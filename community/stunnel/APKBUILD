# Contributor: SÃ¶ren Tempel <soeren+alpine@soeren-tempel.net>
# Contributor: Dean Takemori <deant@hawaii.rr.com>
# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=stunnel
pkgver=5.76
pkgrel=0
pkgdesc="SSL encryption wrapper between network client and server"
url="https://www.stunnel.org"
arch="all"
license="GPL-2.0-or-later WITH OpenSSL-Exception"
# support for SO_ORIGINAL_DST will be silently disabled without linux-headers
makedepends="openssl-dev>3 linux-headers"
checkdepends="py3-cryptography"
subpackages="
	$pkgname-doc
	$pkgname-openrc
	stunnel3
	"
install="$pkgname.pre-install"
source="https://www.stunnel.org/archive/${pkgver%%.*}.x/stunnel-$pkgver.tar.gz
	stunnel.initd
	stunnel.conf"

prepare() {
	default_prepare

	# remove FIPS-related tests
	rm tests/plugins/p10_fips.py
	rm tests/plugins/p11_fips_cipher.py

	# Hangs forever on s390x.
	if [ "$CARCH" = s390x ]; then
		rm tests/plugins/p02_require_cert.py
	fi
}

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--disable-fips
	make
}

check() {
	timeout 300 \
	make check
}

package() {
	make DESTDIR="$pkgdir" install

	install -Dm755 "$srcdir"/stunnel.initd "$pkgdir"/etc/init.d/stunnel
	install -m644 "$srcdir"/stunnel.conf "$pkgdir"/etc/stunnel/stunnel.conf

	mkdir -p "$pkgdir"/usr/share/doc/$pkgname/examples/
	mv "$pkgdir"/etc/stunnel/stunnel.conf-sample \
		"$pkgdir"/usr/share/doc/$pkgname/examples/
}

stunnel3() {
	pkgdesc="Perl wrapper to use stunnel 3.x syntax in stunnel >=4.05"
	depends="perl"

	amove usr/bin/stunnel3
}

sha512sums="
245f8888476de7d109c9a18ef08f87c4713e1082b6d17c296529ed55b6a5eddd7dd2e624402afed31512a83e65de2cca197704cda8c22cf96063e9283c074a96  stunnel-5.76.tar.gz
51d56a6c0d961f6de5cd2ef07a1cfdb19fb1b74300da9c340899daa919bd9b2c0bfff472f03746df0dd1aa6098c79035921ca36108ca0b93693377f1ac1c7fb4  stunnel.initd
a72bfddeb74787d58c9fd24782d86c0498ce3530a43fbdd4ec4c4b57baa6257b6ef21005aca274b22c4a22cdbbbcee63dd3d841f458af248db9c69e8d59fa56f  stunnel.conf
"
