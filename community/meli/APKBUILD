# Contributor: Thomas BÃ¶hler <witcher@wiredspace.de>
# Maintainer: omni <omni+alpine@hack.org>
maintainer="omni <omni+alpine@hack.org>"
pkgname=meli
pkgver=0.8.13
_nixver=0.30.1 # to patch with https://github.com/nix-rust/nix/pull/2678
pkgrel=0
pkgdesc="terminal e-mail client"
arch="all"
url="https://meli-email.org/"
license="GPL-3.0-or-later"
makedepends="cargo
	cargo-auditable
	curl-dev
	openssl-dev
	zlib-dev
	"
checkdepends="m4"
subpackages="$pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://git.meli-email.org/meli/meli/archive/v$pkgver.tar.gz
	nix-$_nixver.tar.gz::https://github.com/nix-rust/nix/archive/refs/tags/v$_nixver.tar.gz
	0002-allow-tests-without-cli-docs-feature.patch
	0003-hide-man-related-subcommands-if-disabled.patch
	nix-s390x.patch
	"
builddir="$srcdir/$pkgname"
options="net" # cargo fetch

_features=sqlite3,notmuch,smtp,gpgme,jmap

export OPENSSL_NO_VENDOR=1

prepare() {
	mv "$srcdir/nix-$_nixver" vendored-nix
	cargo fetch --target="$CTARGET" --locked

	default_prepare
}

build() {
	cargo auditable build --release --frozen \
		--no-default-features --features "$_features"
}

check() {
	cargo test --frozen \
		--no-default-features --features "$_features"
}

package() {
	install -Dm0755 -t "$pkgdir"/usr/bin/ target/release/"$pkgname"

	install -Dm0644 -t "$pkgdir"/usr/share/man/man1/ meli/docs/*.1
	install -Dm0644 -t "$pkgdir"/usr/share/man/man5/ meli/docs/*.5
	install -Dm0644 -t "$pkgdir"/usr/share/man/man7/ meli/docs/*.7
	install -Dm0644 -t "$pkgdir"/usr/share/doc/"$pkgname"/ \
		meli/docs/samples/sample-config.toml
	install -Dm0644 -t "$pkgdir"/usr/share/doc/"$pkgname"/themes/ \
		meli/docs/samples/themes/*
}

sha512sums="
7ddf579bee95ad79959f01461927ee7f05befb2f12567559c6a84143069952673e751ee4757db686573c513e9c43c3181fb077ae0131a5d35a53a7a862847efe  meli-0.8.13.tar.gz
94f5a72f099fbe488b2f09a9bbe33d63ad08308ee3c12999b8ad0743a3d9567b759799a32120575abdfb1ab6891cf83951acf7145408b27d3368b5c0f1e35d0a  nix-0.30.1.tar.gz
92b35f4ee8ca419da89245c4278026409657daf581b42a6f54810e05320d7e7ac708dd586496a5ccf939a4c718e25abaf7702ea66c09b7bc6df6f05af4e39e23  0002-allow-tests-without-cli-docs-feature.patch
a6bee439a53836bccdfc5db826b11a75deb1ad30e1f0e2a5efbdce74736518ca3cf2ea7e4237c7188cb5bfcb23524f0180949aa32903b725398b4367d3ce7905  0003-hide-man-related-subcommands-if-disabled.patch
ad7c0f0e9562dba7fa5340d19b9631e04fc295e772605f383f90998d31773024c0420492e212cec9d12bdd2e46fece215f92e8eb9d0425e60df87746e29eac2f  nix-s390x.patch
"
