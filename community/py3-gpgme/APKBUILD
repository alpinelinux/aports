# Contributor: Leo <thinkabit.ukim@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=py3-gpgme
pkgver=2.0.0
pkgrel=0
pkgdesc="gnupg made easy"
url="https://www.gnupg.org/related_software/gpgme/"
arch="all"
license="LGPL-2.1-or-later AND GPL-3.0-or-later"
makedepends="
	autoconf
	automake
	git
	gpgmepp-dev
	libtool
	py3-build
	py3-installer
	py3-setuptools
	py3-wheel
	python3-dev
	swig
	"
subpackages="$pkgname-pyc"
source="https://www.gnupg.org/ftp/gcrypt/gpgmepy/gpgmepy-$pkgver.tar.bz2"
builddir="$srcdir/gpgmepy-$pkgver"

prepare() {
	default_prepare

	# autoreconf adds '-unknown' suffix and may even blast the version away
	# entirely to 0.0.0.
	sed -i -e "s:mym4_version:$pkgver:" configure.ac

	# The dynamic version machinery doesn't work with proper PEP517
	# builds, as it relies on a hack in setup.py.
	sed -i -e "s:dynamic = \[\"version\"\]:version = \"$pkgver\":" pyproject.toml

	# For some reason it fails to find our Swig
	sed -e 's|, \"swig\"||' -i pyproject.toml
	autoreconf -fiv
}

build() {
	./configure
	mv src gpg
	python3 -m build --wheel --no-isolation
}

check() {
	TESTFLAGS="--python-libdir=$PWD/$(ls -d build/lib*)" make -C tests check
}

package() {
	python3 -m installer --destdir="$pkgdir" dist/*.whl
}


sha512sums="
c7f7a0f6961cd6c4338a01df08f15afafa6dbc83e5ee9ca1694dc1f7eb11e7a4e3c37b05ec2fff0d69297aa2de678c66deb41ab5877e6bf5c2373bd6954afae6  gpgmepy-2.0.0.tar.bz2
"
