# Contributor: Oleg Titov <oleg.titov@gmail.com>
# Maintainer: Miles Alan <m@milesalan.com>
pkgname=ollama
pkgver=0.13.5
pkgrel=0
pkgdesc="Download and run large language models locally (CPU)"
options="chmod-clean net"
url="https://github.com/ollama/ollama"
ldpath="/usr/lib/$pkgname"
license="MIT"
# armhf: undefined reference to `ggml_vec_dot_q4_0_q8_0'
# armv7: undefined reference to `ggml_vec_dot_q4_0_q8_0'
# loongarch64: ggml-cpu-quants.c:2516:31: error: incompatible types when initializing type '__m128i' using type 'int'
# ppc64le: Cannot find source file: ggml-cpu/arch/powerpc/quants.c
# riscv64: GGML_CPU_ALL_VARIANTS not yet supported with riscv64 on Linux
# s390x: mxfp4_test.go:116 test fails
# x86: ggml-cpu-quants.c:11865:42: error: implicit declaration of function '_pdep_u64'
arch="all !armhf !armv7 !loongarch64 !ppc64le !riscv64 !s390x !x86"
makedepends="go>=1.24.0 cmake ninja patchelf"
subpackages="
	$pkgname-doc
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/ollama/ollama/archive/refs/tags/v$pkgver.tar.gz"

case $CARCH in
	armv7|armhf) options="$options !check";;
esac

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		local crossopts="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=ON \
		-DCMAKE_BUILD_TYPE=None \
		$crossopts
	cmake --build build
	go build .
}

check() {
	go test ./...
}

package() {
	mkdir -p "$pkgdir"/usr/lib/ollama
	install -Dm0644 build/lib/ollama/*.so "$pkgdir"/usr/lib/ollama/
	for lib in "$pkgdir"/usr/lib/ollama/*.so; do
		patchelf --set-rpath '$ORIGIN' "$lib"
	done
	install -Dm0755 $pkgname -t "$pkgdir"/usr/bin
	patchelf --set-rpath '$ORIGIN/../lib/ollama' "$pkgdir/usr/bin/ollama"
	mkdir -p "$pkgdir"/usr/share/doc/"$pkgname"
	cp -r docs/* "$pkgdir"/usr/share/doc/"$pkgname"
	install -Dm644 LICENSE -t "$pkgdir"/usr/share/licenses/$pkgname/
}

sha512sums="
c9d26a7993f3b63da9d734f45245118793ed8746052e33cf86bec24da9ec5811a969a079e8885537dce38f56042d9fbaccb524d417817cddd0372c1f3c68eab5  ollama-0.13.5.tar.gz
"
