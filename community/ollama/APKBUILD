# Maintainer: Miles Alan <m@milesalan.com>
pkgname=ollama
pkgver=0.11.7
pkgrel=0
pkgdesc="Download and run large language models locally (CPU)"
options="chmod-clean net"
url="https://github.com/ollama/ollama"
ldpath="/usr/lib/$pkgname"
license="MIT"
# armhf: undefined reference to `ggml_vec_dot_q4_0_q8_0'
# armv7: undefined reference to `ggml_vec_dot_q4_0_q8_0'
# loongarch64: ggml-cpu-quants.c:2516:31: error: incompatible types when initializing type '__m128i' using type 'int'
# ppc64le: Cannot find source file: ggml-cpu/arch/powerpc/quants.c
# s390x: mxfp4_test.go:116 test fails
# x86: ggml-cpu-quants.c:11865:42: error: implicit declaration of function '_pdep_u64'
arch="all !armhf !armv7 !loongarch64 !ppc64le !s390x !x86"
makedepends="go>=1.24.0 cmake ninja patchelf"
subpackages="
	$pkgname-doc
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/ollama/ollama/archive/refs/tags/v$pkgver.tar.gz"

case $CARCH in
	armv7|armhf) options="$options !check";;
esac

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		local crossopts="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=ON \
		-DCMAKE_BUILD_TYPE=None \
		$crossopts
	cmake --build build
	go build .
}

check() {
	go test ./...
}

package() {
	mkdir -p "$pkgdir"/usr/lib/ollama
	install -Dm0644 build/lib/ollama/*.so "$pkgdir"/usr/lib/ollama/
	for lib in "$pkgdir"/usr/lib/ollama/*.so; do
		patchelf --set-rpath '$ORIGIN' "$lib"
	done
	install -Dm0755 $pkgname -t "$pkgdir"/usr/bin
	patchelf --set-rpath '$ORIGIN/../lib/ollama' "$pkgdir/usr/bin/ollama"
	mkdir -p "$pkgdir"/usr/share/doc/"$pkgname"
	cp -r docs/* "$pkgdir"/usr/share/doc/"$pkgname"
	install -Dm644 LICENSE -t "$pkgdir"/usr/share/licenses/$pkgname/
}

sha512sums="
1040cddf433321eed5d565e08e49dd3ad4aa4c42592089bccf47fc3518a406dd655133fcae8ff8ef690303f69afb6cb9a014b43a51e1b2d9c4c9f6dd59a0bc54  ollama-0.11.7.tar.gz
"
