# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=cargo
pkgver=0.26.0
pkgrel=0
pkgdesc="The Rust package manager"
url="https://crates.io"
arch="x86_64"  # limited by rust pkg
license="MIT Apache-2.0"
depends="rust"
makedepends="cmake curl-dev libgit2-dev libssh2-dev libressl-dev python2 zlib-dev"
subpackages="$pkgname-doc
	$pkgname-bash-completion:bashcomp:noarch
	$pkgname-zsh-completion:zshcomp:noarch"
source="$pkgname-$pkgver.tar.gz::https://github.com/rust-lang/$pkgname/archive/$pkgver.tar.gz
	test-http_auth_offered-fix.patch"

builddir="$srcdir/$pkgname-$pkgver"

export CARGO_HOME="$srcdir/.cargo"
_cargo_opts="--release --verbose ${JOBS:+--jobs $JOBS}"

_exit_handler() {
	abuild-apk del --wait 30 --purge ".bootstrap-$pkgname"
}

trap _exit_handler EXIT

build() {
	cd "$builddir"

	# Convince libgit2-sys to use the distro libgit2.
	export LIBGIT2_SYS_USE_PKG_CONFIG=1

	# bootstrap cargo
	abuild-apk add --wait 30 --virtual ".bootstrap-$pkgname" "$pkgname>=0.18.0"
	cargo build $_cargo_opts
	cargo install --root "$CARGO_HOME" --path . --verbose

	# clean files built by previous cargo version
	"$CARGO_HOME/bin/cargo" clean --verbose
	rm -rf target "$CARGO_HOME"/registry
	abuild-apk del --wait 30 --purge ".bootstrap-$pkgname"

	# rebuild with the just built cargo binary
	"$CARGO_HOME/bin/cargo" build $_cargo_opts
	"$CARGO_HOME/bin/cargo" test $_cargo_opts --no-run
}

check() {
	cd "$builddir"

	./target/release/cargo --version

	CFG_DISABLE_CROSS_TESTS=1 RUST_BACKTRACE=1 \
		"$CARGO_HOME/bin/cargo" test $_cargo_opts --no-fail-fast
}

package() {
	cd "$builddir"

	install -D -m 755 target/release/cargo "$pkgdir"/usr/bin/cargo

	mkdir -p "$pkgdir"/usr/share/man/man1
	install -m 644 -t "$pkgdir"/usr/share/man/man1/ src/etc/man/*.1

	mkdir -p "$pkgdir"/usr/share/licenses/$pkgname
	install -m 644 -t "$pkgdir"/usr/share/licenses/$pkgname/ LICENSE*
}

bashcomp() {
	pkgdesc="Bash completions for $pkgname"
	depends=""
	install_if="$pkgname=$pkgver-r$pkgrel bash"

	cd "$builddir"
	install -D -m 644 -D src/etc/cargo.bashcomp.sh \
		"$subpkgdir"/usr/share/bash-completion/completions/cargo
}

zshcomp() {
	pkgdesc="ZSH completions for $pkgname"
	depends=""
	install_if="$pkgname=$pkgver-r$pkgrel zsh"

	cd "$builddir"
	install -D -m 644 src/etc/_cargo \
		"$subpkgdir"/usr/share/zsh/site-functions/_cargo
}

sha512sums="0ceba204f6effb0b636b8a4cab38ae876e32d548a158cc2a67f3f80f144d4a05ce5ec44df74eb7e17a3dcd57105298dae1ac599b917c0dbb4b7386d3cf424070  cargo-0.26.0.tar.gz
1ed00014808350ca065035a18efd8cdcec9cdc76c9cb7bbe004e4156b79615317469f8dda51c4c3a378ac8cc66a8572fac4d997f9853bd03b9ba34cf1ae49e16  test-http_auth_offered-fix.patch"
