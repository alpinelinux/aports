# Contributor: ≈Åukasz Jendrysik <scadu@yandex.com>
# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Contributor: TBK <alpine@jjtc.eu>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
pkgname=sphinx
pkgver=2.3.2
_type=beta # release/beta
pkgrel=0
pkgdesc="Free open-source SQL full-text search engine"
url="http://www.sphinxsearch.com"
arch="all"
license="GPL-2.0"
depends=""
makedepends="$depends_dev postgresql-dev mariadb-dev unixodbc-dev expat-dev
	libre2-dev snowball-dev"
install="$pkgname.pre-install"
pkgusers="$pkgname"
pkggroups="$pkgname"
subpackages="$pkgname-doc $pkgname-php::noarch $pkgname-python::noarch"
source="http://sphinxsearch.com/files/$pkgname-$pkgver-$_type.tar.gz
	sphinx.initd
	sphinx.confd
	sphinx.logrotated
	sphinx-pagesize.patch
        fix-pthread.patch
       "
builddir="$srcdir"/$pkgname-$pkgver-$_type

prepare() {
        local i
        cd "$builddir"
        for i in $source; do
                case $i in
                *.patch) msg $i; patch -p1 -i "$srcdir"/$i;;
                esac
        done
}

build() {
	cd "$builddir"
	./configure --prefix=/usr \
		--exec-prefix=/usr \
		--localstatedir=/var/lib/sphinx \
		--sysconfdir=/etc/sphinx \
		--docdir=/usr/share/doc/sphinx \
		--mandir=/usr/share/man \
		--with-pgsql \
		--with-mysql \
		--with-unixodbc \
		--with-libexpat \
		--with-iconv \
		--with-libstemmer \
		--with-syslog \
		--with-re2 \
		--enable-id64
	make
}

package() {
	cd "$builddir"

	make DESTDIR="$pkgdir" install
	install -Dm755 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
	install -Dm755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	chown -R $pkgusers:$pkggroups "$pkgdir"/var/lib/sphinx
}


php() {
	pkgdesc="PHP API for Sphinx search engine"

	mkdir -p "$subpkgdir"/usr/share/php/$pkgname/api
	for i in $(ls $builddir/api/*.php); do
		mv $i "$subpkgdir"/usr/share/php/$pkgname/api ;
	done
}


python() {
	pkgdesc="Python API for Sphinx search engine"

	mkdir -p "$subpkgdir"/usr/lib/python2.7/site-packages/$pkgname/
	for i in $(ls $builddir/api/*.py); do
		mv $i "$subpkgdir"/usr/lib/python2.7/site-packages/$pkgname/ ;
	done
}

doc() {
	default_doc;
	mkdir -p "$subpkgdir"/usr/share/doc/$pkgname/misc
	cp -r "$builddir"/misc/* "$subpkgdir"/usr/share/doc/$pkgname/misc

}

sha512sums="c09044785b55aa988505457f0efc5c4c366d907ede2bda67093fb5fbb09310425421a4a5f0b918cba3d10977e7cc9f1dfa99ba46cb41572852266607812384e6  sphinx-2.3.2-beta.tar.gz
583601ff63e663099ae40048b8a216d0bc815a50a82370a42d3e7b923c90c650d58951636041ff9000141d897357767b7895a238a4edc49c328e46241b391350  sphinx.initd
8dbbb3b75bfbde5c6d2bee801df8c7a82650d3943dd667a4330cae473cbf18390aff5eb8d6aa6e5d69c4c995065d48289047b9166fa756c6015bf71f2b13a8f0  sphinx.confd
bfb21ff49dd9f96dbd430366245893bb7158e336b9949aba6303482655be2b6f8d94765de9d786b18457ee4d2ddd9c8aac6211ff3570548bd2b5666b8d1bb5bb  sphinx.logrotated
9563c5a926e5be30477781038ccf115a809a32bbcbc02c5b82e7985fca76185005968b5f0442772ec598b2ff17ef5c185582e24ae74775e5358abc88192345f2  sphinx-pagesize.patch
805bc19c0548074ae27384554e9c3c9d1410a055e424a485798aa4011f733ff598fd172c816fbf43f306ea9296789dda599a38538a75502e3b67fa53831f8916  fix-pthread.patch"
