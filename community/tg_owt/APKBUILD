# Contributor: Newbyte <newbie13xd@gmail.com>
# Contributor: Nulo <alpine@nulo.in>
# Maintainer: Nulo <alpine@nulo.in>
pkgname=tg_owt
pkgver=0_git20250603
pkgrel=0
_commit="62321fd7128ab2650b459d4195781af8185e46b5"
_libyuv_commit="04821d1e7d60845525e8db55c7bcd41ef5be9406"
pkgdesc="Telegram Desktop's fork of Google's WebRTC"
url="https://github.com/desktop-app/tg_owt"
# s390x: "Code not working properly for big endian platforms."
arch="all !s390x"
license="BSD-3-Clause"

# Sorted according to
# https://github.com/telegramdesktop/tdesktop/wiki/The-Packaged-Building-Mode
# https://github.com/desktop-app/tg_owt/pull/55#discussion_r599718405
# Not specified in the wiki page (see
# https://github.com/desktop-app/tg_owt/pull/55):
# pffft bundled because there's no stable ABI and patched
# rnnoise bundled because "all remaining files are custom"
# libyuv bundled because there's no stable ABI and has many breaking updates
depends_dev="
	abseil-cpp-dev
	crc32c-dev
	libdrm-dev
	libepoxy-dev
	libsrtp-dev
	ffmpeg-dev
	mesa-dev
	glib-dev
	jpeg-dev
	openssl-dev>3
	openh264-dev
	opus-dev
	pipewire-dev
	libvpx-dev
	libx11-dev
	libxcomposite-dev
	libxdamage-dev
	libxext-dev
	libxfixes-dev
	libxrender-dev
	libxrandr-dev
	libxtst-dev
	"
makedepends="
	$depends_dev
	cmake
	yasm
	samurai
	"

subpackages="$pkgname-dev"
source="
	$pkgname-$_commit.tar.gz::https://github.com/desktop-app/tg_owt/archive/$_commit.tar.gz
	libyuv-$_libyuv_commit.tar.gz::https://github.com/klemensn/libyuv/archive/$_libyuv_commit.tar.gz
	abseil-cpp-20250814.patch
	cstdint.patch
	gcc12.patch
	gcc13.patch
	"
builddir="$srcdir/$pkgname-$_commit"

prepare() {
	default_prepare
	mv ../libyuv-$_libyuv_commit/* src/third_party/libyuv
}

build() {
	case "$CARCH" in
	arm*)
		# our armv7 baseline has no neon
		export CXXFLAGS="$CXXFLAGS -DLIBYUV_DISABLE_NEON"
		;;
	esac
	# dynamic version has broken linking
	cmake -B build -G Ninja \
		-DTG_OWT_PACKAGED_BUILD=True \
		-DTG_OWT_ARCH_ARMV7_USE_NEON=OFF \
		-DBUILD_SHARED_LIBS=OFF \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_BUILD_TYPE=MinSizeRel

	cmake --build build
}

check() {
	cd build
	ctest
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
84add65513e17d36235fa91686c142b31e65b8b9f3932677a62da9d410dcf00dd809593bf932efa396d241bf55fee0ad335b0319b50734607e3f9e384115b0b5  tg_owt-62321fd7128ab2650b459d4195781af8185e46b5.tar.gz
d2bdc7efff2c3bb1daaecf19d6232f1fa5cba1f2459e84d71824ff11c69b40bcc35993d0d6c96e286d2128312390d1f6ca3ca980b7240c665ebaece9140bf4cb  libyuv-04821d1e7d60845525e8db55c7bcd41ef5be9406.tar.gz
e634e072b78273f0e4eaaabe16f993a05fad598d2871cfa244d591662664b82958eb1a06716a04e4ff4e2a72da8b0b147674c6703d63de71dc38f649242acd8c  abseil-cpp-20250814.patch
b530508390370ca1ed0728e4429920a7d3132293f3d8a2a3f3220efd2c00ceb7a40ee58184f595b1101389133570257900e4a44e7611d4064f7220b67c33b93b  cstdint.patch
2eb235583c952b07f19e455f79a0d464b77f7fce99b5434bff54f7cea2770c117261409c70d7963c78c55822b45c6da467e966df1bcadda70048673b73ed3a95  gcc12.patch
b65e0c1108a0f03bd317df77ac8c4c720cddb39bd878c86a3130aa08fce5ed083c553b552a8a3314473c2deee0f04111a2a67c97c7285c5b6f0e35dd93e2b52b  gcc13.patch
"
