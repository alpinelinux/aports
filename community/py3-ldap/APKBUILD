# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=py3-ldap
_pkgname=python-ldap
pkgver=3.4.5
pkgrel=0
pkgdesc="Python modules for implementing LDAP clients"
url="https://github.com/python-ldap/python-ldap"
arch="all"
license="Python-2.0 AND MIT"
depends="py3-asn1 py3-asn1-modules"
checkdepends="
	openldap
	openldap-back-mdb
	openldap-clients
	openldap-overlay-syncprov
	"
makedepends="python3-dev py3-setuptools openldap-dev"
provides="py3-pyldap=$pkgver-r$pkgrel"  # for backward compatibility with Alpine <3.19
subpackages="$pkgname-pyc"
source="https://github.com/$_pkgname/$_pkgname/archive/$_pkgname-$pkgver.tar.gz
	skip-broken-test.patch"
builddir="$srcdir/$_pkgname-$_pkgname-$pkgver"

# secfixes:
#   3.4.5-r0:
#     - CVE-2025-61911
#     - CVE-2025-61912

case "$CARCH" in
	# FIXME: Some tests fail.
	s390x) options="!check";;
esac

build() {
	python3 setup.py build
}

check() {
	PYTHONPATH=$(echo ./build/lib*) python3 -m unittest discover -v -s Tests -p 't_*'
}

package() {
	python3 setup.py install --skip-build --root="$pkgdir"
}

sha512sums="
5161b7f2b5a0d975f7e5c7e16df132f0b709b986ec8a8e304d836bad278b971f5fdaf4ef39116d62947695f9eb5d7b3315317a3c7973d045c3cbde03933f4308  python-ldap-3.4.5.tar.gz
79d09aafb047d53bfbb1dd08ad662099e3493797859c31fd821a4cb9ece7eb5557828262e8e83e8aab7980a728ce3c60682770998256844ea52de5dcee1f220a  skip-broken-test.patch
"
