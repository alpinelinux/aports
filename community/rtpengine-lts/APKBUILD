# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>

# rtpengine version
# when changing _ver we *must* bump _rel
_ver=13.0.1.4
_rel=0

# kernel version
# when changing _kver make sure _krel=0 & _rel=0
_kver=6.18.0
_krel=6

_kpkgver="$_kver-r$_krel"

# for custom kernels set $FLAVOR
_extra_flavors=
if [ -z "$FLAVOR" ]; then
	_flavor=lts
	case $CARCH in
	x86|x86_64|armv7|aarch64) _extra_flavors="virt";;
	esac
else
	_flavor=$FLAVOR
fi
_kpkg=linux-$_flavor

pkgname=rtpengine-$_flavor
pkgver=$_kver
pkgrel=$((_rel + _krel))

pkgdesc="Kernel module for rtpengine"
url="https://github.com/sipwise/rtpengine"
# armhf and riscv64 blocked by linux-lts
arch="all !armhf !riscv64"
license="GPL-3.0-only"
makedepends="linux-$_flavor-dev=$_kpkgver"
install_if="rtpengine linux-$_flavor=$_kpkgver"
options="!check"
source="$pkgname-$_ver.tar.gz::https://github.com/sipwise/rtpengine/archive/mr$_ver.tar.gz
	kernel-6.18.patch"
builddir="$srcdir"/rtpengine-mr$_ver

for f in $_extra_flavors; do
	makedepends="$makedepends linux-$f-dev=$_kpkgver"
	subpackages="$subpackages rtpengine-$f:_extra"
done

prepare() {
	default_prepare
	if [ -z "$FLAVOR" ]; then
		( . "$startdir"/../../main/linux-"$_flavor"/APKBUILD
			[ "$_kver" != "$pkgver" ] && die "please update _kver to $pkgver"
			[ "$_krel" != "$pkgrel" ] && die "please update _krel to $pkgrel"
			return 0
		)
	fi
	local flavor=
	for flavor in $_flavor $_extra_flavors; do
		cp -r "$builddir" "$srcdir/$flavor"
	done
}

build() {
	unset LDFLAGS
	local flavor= kabi=
	for flavor in $_flavor $_extra_flavors; do
		kabi="${_kver/_rc/-rc}-$_krel-$flavor"
		make -C "$srcdir/$flavor"/kernel-module \
			KSRC=/lib/modules/"$kabi"/build \
			V=1 \
			RTPENGINE_VERSION="$pkgver"
	done
}

package() {
	local kabi="${_kver/_rc/-rc}-$_krel-$_flavor"
	install -Dm644 "$srcdir/$_flavor"/kernel-module/xt_RTPENGINE.ko \
		"$pkgdir/lib/modules/$kabi/extra/xt_RTPENGINE.ko"
}

_extra() {
	flavor=${subpkgname##*-}
	# shellcheck disable=SC2154
	depends="linux-$flavor=$_kpkgver"
	install_if="rtpengine linux-$flavor=$_kpkgver"
	pkgdesc="$flavor kernel modules for rtpengine"
	local kabi="${_kver/_rc/-rc}-$_krel-$flavor"
	install -Dm644 "$srcdir"/virt/kernel-module/xt_RTPENGINE.ko \
		"$subpkgdir/lib/modules/$kabi/extra/xt_RTPENGINE.ko"
}

sha512sums="
c923cd77de3f0c1a40e869276b0c627ec05b0d69be31283a525ada40c8144332987509410169b871ed0f75f24ab4147ae07006f129d623b4c8abb953ce3bd7ec  rtpengine-lts-13.0.1.4.tar.gz
a9c56292ab5b7b44be6fa07b86003a9cd482063cf6133469ca9e3e4bc2e402f473408a3b57780aa02010f7d00ab76e4033c2f8eb99fde09d50e4b6f70b50fe63  kernel-6.18.patch
"
