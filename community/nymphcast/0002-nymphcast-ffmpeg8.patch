From b1a6cad588927e4965e781725786a2737db13fd7 Mon Sep 17 00:00:00 2001
From: Maya Posch <1096451+MayaPosch@users.noreply.github.com>
Date: Thu, 1 Jan 2026 20:22:05 +0100
Subject: [PATCH] Refactor audio filter graph to work with FFmpeg 8.x.

---
 src/server/ffplay/audio_renderer.cpp | 63 +++++++++++++---------------
 src/server/ffplay/player.cpp         |  5 +++
 2 files changed, 35 insertions(+), 33 deletions(-)

diff --git a/src/server/ffplay/audio_renderer.cpp b/src/server/ffplay/audio_renderer.cpp
index 2d010c2e..efc41101 100644
--- a/src/server/ffplay/audio_renderer.cpp
+++ b/src/server/ffplay/audio_renderer.cpp
@@ -126,10 +126,8 @@ extern "C" {
 
 
 int AudioRenderer::configure_audio_filters(VideoState *is, const char *afilters, int force_output_format) {
-    static const enum AVSampleFormat sample_fmts[] = { AV_SAMPLE_FMT_S16, AV_SAMPLE_FMT_NONE };
-    int sample_rates[2] = { 0, -1 };
-    int64_t channel_layouts[2] = { 0, -1 };
-    //int channels[2] = { 0, -1 };
+    //static const enum AVSampleFormat sample_fmts[] = { AV_SAMPLE_FMT_S16, AV_SAMPLE_FMT_NONE };
+    //int sample_rates[2] = { 0, -1 };
     AVFilterContext *filt_asrc = NULL, *filt_asink = NULL;
     char aresample_swr_opts[512] = "";
     AVDictionaryEntry *e = NULL;
@@ -144,8 +142,8 @@ int AudioRenderer::configure_audio_filters(VideoState *is, const char *afilters,
 
     av_bprint_init(&bp, 0, AV_BPRINT_SIZE_AUTOMATIC);
 
-    while ((e = av_dict_get(swr_opts, "", e, AV_DICT_IGNORE_SUFFIX))) {
-	//while ((e = av_dict_iterate(swr_opts, e))) {
+    //while ((e = av_dict_get(swr_opts, "", e, AV_DICT_IGNORE_SUFFIX))) {
+	while ((e = (AVDictionaryEntry*) av_dict_iterate(swr_opts, e))) {
         av_strlcatf(aresample_swr_opts, sizeof(aresample_swr_opts), "%s=%s:", e->key, e->value);
 	}
 	
@@ -154,12 +152,6 @@ int AudioRenderer::configure_audio_filters(VideoState *is, const char *afilters,
 	}
 	
     av_opt_set(is->agraph, "aresample_swr_opts", aresample_swr_opts, 0);
-
-    /* ret = snprintf(asrc_args, sizeof(asrc_args),
-                   "sample_rate=%d:sample_fmt=%s:channels=%d:time_base=%d/%d",
-                   is->audio_filter_src.freq, av_get_sample_fmt_name(is->audio_filter_src.fmt),
-                   is->audio_filter_src.channels,
-                   1, is->audio_filter_src.freq); */
 				   
 	av_channel_layout_describe_bprint(&is->audio_filter_src.ch_layout, &bp);
 
@@ -167,10 +159,6 @@ int AudioRenderer::configure_audio_filters(VideoState *is, const char *afilters,
                    "sample_rate=%d:sample_fmt=%s:time_base=%d/%d:channel_layout=%s",
                    is->audio_filter_src.freq, av_get_sample_fmt_name(is->audio_filter_src.fmt),
                    1, is->audio_filter_src.freq, bp.str);
-	
-    /* if (is->audio_filter_src.channel_layout)
-        snprintf(asrc_args + ret, sizeof(asrc_args) - ret,
-                 ":channel_layout=0x%" PRIx64,  is->audio_filter_src.channel_layout); */
 
     ret = avfilter_graph_create_filter(&filt_asrc,
                                        avfilter_get_by_name("abuffer"), "ffplay_abuffer",
@@ -179,33 +167,29 @@ int AudioRenderer::configure_audio_filters(VideoState *is, const char *afilters,
         goto end;
 
 
-    ret = avfilter_graph_create_filter(&filt_asink,
+    /* ret = avfilter_graph_create_filter(&filt_asink,
                                        avfilter_get_by_name("abuffersink"), "ffplay_abuffersink",
                                        NULL, NULL, is->agraph);
     if (ret < 0)
-        goto end;
+        goto end; */
 
-    if ((ret = av_opt_set_int_list(filt_asink, "sample_fmts", sample_fmts,  AV_SAMPLE_FMT_NONE, AV_OPT_SEARCH_CHILDREN)) < 0)
+   /*  if ((ret = av_opt_set_int_list(filt_asink, "sample_fmts", sample_fmts,  AV_SAMPLE_FMT_NONE, AV_OPT_SEARCH_CHILDREN)) < 0)
         goto end;
     if ((ret = av_opt_set_int(filt_asink, "all_channel_counts", 1, AV_OPT_SEARCH_CHILDREN)) < 0)
+        goto end; */
+	
+	filt_asink = avfilter_graph_alloc_filter(is->agraph, avfilter_get_by_name("abuffersink"),
+                                             "ffplay_abuffersink");
+    if (!filt_asink) {
+        ret = AVERROR(ENOMEM);
         goto end;
+    }
 
-    /* if (force_output_format) {
-        channel_layouts[0] = is->audio_tgt.channel_layout;
-        channels       [0] = is->audio_tgt.channels;
-        sample_rates   [0] = is->audio_tgt.freq;
-        if ((ret = av_opt_set_int(filt_asink, "all_channel_counts", 0, AV_OPT_SEARCH_CHILDREN)) < 0)
-            goto end;
-        if ((ret = av_opt_set_int_list(filt_asink, "channel_layouts", channel_layouts,  -1, AV_OPT_SEARCH_CHILDREN)) < 0)
-            goto end;
-        if ((ret = av_opt_set_int_list(filt_asink, "channel_counts" , channels       ,  -1, AV_OPT_SEARCH_CHILDREN)) < 0)
-            goto end;
-        if ((ret = av_opt_set_int_list(filt_asink, "sample_rates"   , sample_rates   ,  -1, AV_OPT_SEARCH_CHILDREN)) < 0)
-            goto end;
-    } */
+    if ((ret = av_opt_set(filt_asink, "sample_formats", "s16", AV_OPT_SEARCH_CHILDREN)) < 0)
+        goto end;
 	
 	if (force_output_format) {
-        av_bprint_clear(&bp);
+        /* av_bprint_clear(&bp);
         av_channel_layout_describe_bprint(&is->audio_tgt.ch_layout, &bp);
         sample_rates   [0] = is->audio_tgt.freq;
         if ((ret = av_opt_set_int(filt_asink, "all_channel_counts", 0, AV_OPT_SEARCH_CHILDREN)) < 0)
@@ -213,9 +197,19 @@ int AudioRenderer::configure_audio_filters(VideoState *is, const char *afilters,
         if ((ret = av_opt_set(filt_asink, "ch_layouts", bp.str, AV_OPT_SEARCH_CHILDREN)) < 0)
             goto end;
         if ((ret = av_opt_set_int_list(filt_asink, "sample_rates"   , sample_rates   ,  -1, AV_OPT_SEARCH_CHILDREN)) < 0)
+            goto end; */
+		
+		if ((ret = av_opt_set_array(filt_asink, "channel_layouts", AV_OPT_SEARCH_CHILDREN,
+                                    0, 1, AV_OPT_TYPE_CHLAYOUT, &is->audio_tgt.ch_layout)) < 0)
+            goto end;
+        if ((ret = av_opt_set_array(filt_asink, "samplerates", AV_OPT_SEARCH_CHILDREN,
+                                    0, 1, AV_OPT_TYPE_INT, &is->audio_tgt.freq)) < 0)
             goto end;
     }
 
+	ret = avfilter_init_dict(filt_asink, NULL);
+    if (ret < 0)
+        goto end;
 
     if ((ret = configure_filtergraph(is->agraph, afilters, filt_asrc, filt_asink)) < 0)
         goto end;
@@ -226,6 +220,9 @@ int AudioRenderer::configure_audio_filters(VideoState *is, const char *afilters,
 end:
     if (ret < 0)
         avfilter_graph_free(&is->agraph);
+	
+	av_bprint_finalize(&bp, NULL);
+	
     return ret;
 }
 
diff --git a/src/server/ffplay/player.cpp b/src/server/ffplay/player.cpp
index 31176989..d1162b2c 100644
--- a/src/server/ffplay/player.cpp
+++ b/src/server/ffplay/player.cpp
@@ -429,6 +429,11 @@ void Player::run_updates() {
 		av_usleep((int64_t)(remaining_time * 1000000.0));
 	}
 	
+	// Check again after the wait.
+	if (StreamHandler::get_fault()) {
+		return; // Playback fault. Return immediately.
+	}
+	
 	remaining_time = REFRESH_RATE;
 	if (cur_stream->show_mode != SHOW_MODE_NONE && (!cur_stream->paused || cur_stream->force_refresh)) {
 		VideoRenderer::video_refresh(cur_stream, &remaining_time);
