maintainer="Bart Ribbers <bribbers@disroot.org>"
pkgname=nymphcast
pkgver=0.2_alpha0
_pkgver="${pkgver/_/-}"
pkgrel=0
arch="all"
url="http://nyanko.ws/product_nymphcast.php"
pkgdesc="Audio and video casting system with support for custom applications"
license="BSD-3-Clause"
depends="avahi"
makedepends="
	alsa-lib-dev
	cmake
	curl-dev
	ffmpeg7-dev
	freeimage-dev
	freetype-dev
	libnymphcast-dev
	nymphrpc-dev
	openssl-dev>3
	qt5-qtbase-dev
	rapidjson-dev
	samurai
	sdl2-dev
	sdl2_image-dev
	vlc-dev
	"
subpackages="$pkgname-openrc $pkgname-client $pkgname-nftables"
source="https://github.com/MayaPosch/NymphCast/archive/v$_pkgver/nymphcast-v$_pkgver.tar.gz
	0001-nymphcast-chmod-posix.patch
	gcc12.patch
	gcc13.patch
	gcc15.patch
	lfs64.patch
	60_nymphcast.nft
	"
options="!check" # No tests
builddir="$srcdir/NymphCast-$_pkgver"

build() {
	make -C src/server

	cmake -B build -G Ninja player \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr
	cmake --build build
}

package() {
	make DESTDIR="$pkgdir" PREFIX=/usr -C src/server install
	make DESTDIR="$pkgdir" PREFIX=/usr -C src/server install-openrc
}

client() {
	DESTDIR="$subpkgdir" cmake --install "$builddir"/build
}

nftables() {
	pkgdesc="$pkgdesc (nftables rules)"
	install_if="$pkgname=$pkgver-r$pkgrel nftables"

	install -Dm644 -t "$subpkgdir"/etc/nftables.d "$srcdir"/60_nymphcast.nft
}

sha512sums="
c97d9beedf29b053d6f04abf9db57c722198bf3980bf2219f88fd453c80a52ccfbca6c3b25511d52fb1d2cf2068d60d91ae469985a781a476ba657b081364e7a  nymphcast-v0.2-alpha0.tar.gz
9f6f3ce50c6abfc6925ff62ec18a8f788f72e12845e57c38a019bd863f377ba294cd703ef58bab29dfad3bb7d3bb891c0c950f222aa253a2ae505b46bb7a89e3  0001-nymphcast-chmod-posix.patch
6628f67f9f778634d77a8bd42ff2ff39031c0ef3b873a22882f04f00892d129a22f1679f4518a8e0bf08a66477f161ea2ce927d39ece3c63b7904f0b8a5226d0  gcc12.patch
95e1b87647fa99da17ffcebc8659abc56439a3ac01efe596bac2cd59bf4c19881c011db67019778a7f3783f8277327e2a0ca234b65d4ffc17cf4806885777b25  gcc13.patch
0ea227871ad29e24b4b67b98dd7b30a3cc1500d222ae8ebca16bc82a49bde53df1b5493c872e06ec4cb33eabadbbbdac5585104e08c0203ff5a6ac49b72e9d94  gcc15.patch
551c473e63a22505221a70a422b57f6468d2a4c0f2ba48a61b6305598a02f7a2c08306747216a9c38fbf1f38fb17cca0c7dd2e2796434dbbaca35e3e790cd042  lfs64.patch
fba04b7fc8c9a4cbab57b20ba2f8e7274e759165e5b0830590796da4a955f3c843b7516cf6bd34d8d82523328d95932610554b2f0decf051b1cc7022319f6b37  60_nymphcast.nft
"
