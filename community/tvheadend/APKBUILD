# Contributor: Carlo Landmeter <clandmeter@alpinelinux.org>
maintainer="Achill Gilgenast <achill@achill.org>"
pkgname=tvheadend
# they use a "rolling release" model
pkgver=4.3_git20260214
_commit=5abbcda4d8c82d2d4889452a7056a7bfcd728fc6
pkgrel=1
pkgdesc="TV Streaming server for linux"
url="https://tvheadend.org/"
arch="all"
license="GPL-3.0-only"
makedepends="
	bash
	bsd-compat-headers
	cmake
	coreutils
	ffmpeg-dev
	findutils
	gettext-dev
	git
	gnu-libiconv-dev
	libdvbcsa-dev
	libvpx-dev
	linux-headers
	openssl-dev
	opus-dev
	python3
	uriparser-dev
	wget
	x264-dev
	x265-dev
	zlib-dev
	"
pkgusers="tvheadend"
pkggroups="video"
install="$pkgname.pre-install"
options="!check" # no testsuites
subpackages="$pkgname-doc $pkgname-openrc $pkgname-dbg"
source="$pkgname-$pkgver.tar.gz::https://github.com/tvheadend/tvheadend/archive/$_commit.tar.gz
	$pkgname.initd
	"
builddir="$srcdir/$pkgname-$_commit"

prepare() {
	default_prepare
	_tvhver=${pkgver//_git/-}~${_commit%"${_commit#?????????}"}
	printf '%s\n' "$_tvhver" > rpm/version
}

build() {
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var \
		--disable-execinfo \
		--enable-libav \
		--disable-ffmpeg_static \
		--disable-libx264_static \
		--disable-libx265_static \
		--disable-libvpx_static \
		--disable-libtheora_static \
		--disable-libvorbis_static \
		--disable-libfdkaac_static \
		--disable-libmfx_static \
		--disable-hdhomerun_static \
		--python=python3 \
		--nowerror
	make
}

package() {
	make DESTDIR="$pkgdir" install
	install -Dm755 "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -dm755 -o $pkgusers -g $pkggroups \
		"$pkgdir"/etc/tvheadend \
		"$pkgdir"/var/lib/tvheadend \
		"$pkgdir"/var/log/tvheadend
}

sha512sums="
947ca1ca1929be73b32269cdbfc8fbf79e586ec605424d8a3c81ee8dea263b63e9ba6ca833bfb7c8ffb99f76f0c566233f8f57df141c2e0e16341fcc054e6183  tvheadend-4.3_git20260214.tar.gz
8b6463996b9635654cba4458e58cef2970e31c98c1469ccc694276e5542eec451a0859a972b6c056b53d97deb2cef55d701fb1ee3ca980b1606f9126a88ab64f  tvheadend.initd
"
