# Contributor: Carlo Landmeter <clandmeter@alpinelinux.org>
maintainer="Achill Gilgenast <achill@achill.org>"
pkgname=tvheadend
# they use a "rolling release" model
pkgver=4.3_git20251215
_commit=9f22b4d2b697d3acc30e3cf4da3a015c32d5d0db
pkgrel=0
pkgdesc="TV Streaming server for linux"
url="https://tvheadend.org/"
arch="all"
license="GPL-3.0-only"
makedepends="
	bash
	bsd-compat-headers
	cmake
	coreutils
	ffmpeg-dev
	findutils
	gettext-dev
	git
	libdvbcsa-dev
	libvpx-dev
	linux-headers
	openssl-dev
	opus-dev
	python3
	uriparser-dev
	wget
	x264-dev
	x265-dev
	zlib-dev
	"
pkgusers="tvheadend"
pkggroups="video"
install="$pkgname.pre-install"
options="!check" # no testsuites
subpackages="$pkgname-doc $pkgname-openrc"
source="$pkgname-$pkgver.tar.gz::https://github.com/tvheadend/tvheadend/archive/$_commit.tar.gz
	$pkgname.initd
	"
builddir="$srcdir/$pkgname-$_commit"

prepare() {
	default_prepare
	_tvhver=${pkgver//_git/-}~${_commit%"${_commit#?????????}"}
	printf '%s\n' "$_tvhver" > rpm/version
}

build() {
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var \
		--disable-execinfo \
		--enable-libav \
		--disable-ffmpeg_static \
		--disable-libx264_static \
		--disable-libx265_static \
		--disable-libvpx_static \
		--disable-libtheora_static \
		--disable-libvorbis_static \
		--disable-libfdkaac_static \
		--disable-libmfx_static \
		--python=python3 \
		--nowerror
	make
}

package() {
	make DESTDIR="$pkgdir" install
	install -Dm755 "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -dm755 -o $pkgusers -g $pkggroups \
		"$pkgdir"/etc/tvheadend \
		"$pkgdir"/var/lib/tvheadend \
		"$pkgdir"/var/log/tvheadend
}

sha512sums="
b22491fffcdecc110f29f4c9ac40a80e600b14684df6499cc532994d1e5e64e6526fc937c2231db12b2653bf8aaa27b05d089f888f96b2ef60f03b948744c3ed  tvheadend-4.3_git20251215.tar.gz
8b6463996b9635654cba4458e58cef2970e31c98c1469ccc694276e5542eec451a0859a972b6c056b53d97deb2cef55d701fb1ee3ca980b1606f9126a88ab64f  tvheadend.initd
"
