# Maintainer: Carlo Landmeter <clandmeter@alpinelinux.org>
pkgname=tvheadend
# stable versions have an even minor version number
pkgver=4.0.9
pkgrel=3
pkgdesc="TV Streaming server for linux"
url="http://tvheadend.org/"
arch="all"
license="GPL3"
depends=""
depends_dev=""
makedepends="$depends_dev findutils bash git python linux-headers
	bsd-compat-headers coreutils libressl-dev ffmpeg2.8-dev libhdhomerun-dev"
pkgusers="$pkgname"
pkggroups="$pkgname"
install="$pkgname.pre-install"
subpackages="$pkgname-doc $pkgname-dvb-scan:dvb_scan $pkgname-satellites-xml:satellites_xml"
source="$pkgname-$pkgver.tar.gz::https://github.com/tvheadend/tvheadend/archive/v$pkgver.tar.gz
	$pkgname.initd
	$pkgname.confd
	satellites.xml
	fix-canal-digitaal-hd-on-astra3.patch
	fix-indentation.patch"
builddir="$srcdir/$pkgname-$pkgver"

build() {
	cd "$builddir"

	./configure --prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var \
		--enable-libav \
		--enable-hdhomerun_client \
		--disable-hdhomerun_static \
                || return 1
	make || return 1
}

package() {
        cd "$builddir"

	make -j1 DESTDIR="$pkgdir" install || return 1

	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname || return 1
	install -m755 -D -o $pkgname -g $pkgname "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname || return 1
	# /usr/bin/install seems to fail to apply ownership
	# when running from abuild on aarch64
	mkdir -p "$pkgdir"/etc/"$pkgname" || return 1
	chown "$pkgusers:$pkggroups" "$pkgdir/etc/$pkgname" || return 1
}

dvb_scan() {
	pkgdesc="$pkgname dvb scan files"
	depends="$pkgname"
	arch="noarch"

	cd "$builddir"

	mkdir -p "$subpkgdir"/usr/share/tvheadend/data
	mv "$pkgdir"/usr/share/tvheadend/data/dvb-scan \
		"$subpkgdir"/usr/share/tvheadend/data || return 1
}

satellites_xml() {
	pkgdesc="$pkgname sattelites from http://satellites-xml.eu"
	depends="$pkgname"
	arch="noarch"

	cd "$builddir"

	mkdir -p "$subpkgdir"/usr/share/tvheadend/data/satellites-xml/dvb-s
        msg "Generating sattelites from satellites.xml"
	support/sat_xml_scan.py "$srcdir"/satellites.xml \
		"$subpkgdir"/usr/share/tvheadend/data/satellites-xml/dvb-s || return 1
}

md5sums="afe45a345151e7ce31db673e0c738e6e  tvheadend-4.0.9.tar.gz
67d1cfcaf2dc211d702abe67285f9333  tvheadend.initd
a409c44aecd93626a1a3a39306993c5d  tvheadend.confd
b2a8bae3e81eb114d489c38c658bbd36  satellites.xml
98d74270cc77aeb38a33569d95ab0840  fix-canal-digitaal-hd-on-astra3.patch
36b529977dbd20d773bbd5353cba04a7  fix-indentation.patch"
sha256sums="cea1106f45e286e8c25e6b2f0a581c28bd85e93ce3801ecaac7041568a214977  tvheadend-4.0.9.tar.gz
cd0db26b3da95df7cd100e5e30b47cd884fa4a7d2cd27f1bee2f6bec0d6ad211  tvheadend.initd
671f7d410e51aaed4c93f284c180f646680f6b195b5bef47b3ae1fb99ed76dce  tvheadend.confd
fd545f9d960eabaca431f54208e4ef5ae97a6868d2a1b3da65493e609e7b7564  satellites.xml
5e80a1a5d7e5bb2beccc6a47007389c197f23472fd094faf9496350359c2467f  fix-canal-digitaal-hd-on-astra3.patch
fd078485deece74f21bc2a75f628f581d6e36082e1091b2e651e01ab44cad926  fix-indentation.patch"
sha512sums="ba8c6edcef126c6a260a9251b0948747074061c8f16fb20f03b250c6698645172c9396530b7fa44bf9cf4d8305fcece08c672c812ba6c48211edfbb2691fb58e  tvheadend-4.0.9.tar.gz
41143b33e18000aad99d7b17433ac7935fa40a6980c4bf0733e5cc16e2948d18810ce198ca435791c93992ba1e39dc6d55ca6af33c49087557310fd31ad22447  tvheadend.initd
f81ace2fd2a86c561f70dca6c89a6217e632db01d5f5d1c6ccfd951c4a798a131767140c176a0a764fe3842363958b31fb2a707a871836795688136bc458f7d5  tvheadend.confd
905b98859d23a1d422a9de1bf002ad438bcd2ec30eb5804aa0701fab64ffeb140098db16b6522c8d0f602f44020232798650dd80fdffc15cd2b0225fd1f37501  satellites.xml
e35ac8d991134d531c6d436e391bb2a4c207a3ec40691fe07b178db798b6253bf5a2814c149254c2846f56c340ae63501d2afd0c5e90afb49251ee653d1f1b37  fix-canal-digitaal-hd-on-astra3.patch
fd0de0acbb2e211aaf67dd22928176821b38c450464fbc8e31fdc00bd656b54256e0d285d67a0af62dcc6816e91a51be60d4eaac8495765a1af937c802b8b8e8  fix-indentation.patch"
