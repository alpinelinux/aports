# Contributor: Patrycja Rosa <alpine@ptrcnull.me>
maintainer="Achill Gilgenast <achill@achill.org>"
pkgname=forgejo-runner
pkgver=12.1.2
pkgrel=1
pkgdesc="CI/CD job runner for Forgejo"
url="https://code.forgejo.org/forgejo/runner"
arch="all"
license="GPL-3.0-or-later"
depends="git"
makedepends="go"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc $pkgname-systemd"
source="$pkgname-$pkgver.tar.gz::https://code.forgejo.org/forgejo/runner/archive/v$pkgver.tar.gz
	forgejo-runner.logrotate
	forgejo-runner.initd
	forgejo-runner.confd
	systemd-service.patch
	"
builddir="$srcdir/runner"
# !check: tests require running forgejo
# net: downloading go packages
options="!check net"

build() {
	go build \
		-o forgejo-runner \
		-ldflags "-X code.forgejo.org/forgejo/runner/v${pkgver%%.*}/internal/pkg/ver.version=v$pkgver"
	./forgejo-runner generate-config > config.example.yaml
}

check() {
	go test ./...
}

package() {
	install -Dm755 forgejo-runner -t "$pkgdir"/usr/bin/
	install -Dm644 config.example.yaml -t "$pkgdir"/etc/forgejo-runner/

	install -Dm755 "$srcdir"/forgejo-runner.initd "$pkgdir"/etc/init.d/forgejo-runner
	install -Dm644 "$srcdir"/forgejo-runner.confd "$pkgdir"/etc/conf.d/forgejo-runner
	install -Dm644 "$srcdir"/forgejo-runner.logrotate "$pkgdir"/etc/logrotate.d/forgejo-runner

	install -Dm644 contrib/forgejo-runner.service -t "$pkgdir"/usr/lib/systemd/system/
}

sha512sums="
b9d86312c630202cce34c8bf091958dfe50d7a7a50b245b4195b64bdb449279dc78029d279c53d1e5bf2440918ab058fa773d85e84e96581da2bc97b0dcc6696  forgejo-runner-12.1.2.tar.gz
a3c7238b0c63053325d31e09277edd88690ef5260854517f82d9042d6173fb5d24ebfe36e1d7363673dd8801972638a6e69b6af8ad43debb6057515c73655236  forgejo-runner.logrotate
bb0c6fbe90109c77f9ef9cb0d35d20b8033be0e4b7a60839b596aa5528dfa24309ec894d8c04066bf8fb30143e63a5fd8cc6fc89aac364422b583e0f840e2da6  forgejo-runner.initd
e11eab27f88f1181112389befa7de3aa0bac7c26841861918707ede53335535425c805e6682e25704e9c8a6aecba3dc13e20900a99df1183762b012b62f26d5f  forgejo-runner.confd
e93f3ca81533ff7d19ebdcd3ae8cd9d3c870de6d43f280c58ad1081e4b56ee3c61f0b78e483b23972ba013bd16c5bd7235d3b23c6c9dca670697bb1cc547c770  systemd-service.patch
"
