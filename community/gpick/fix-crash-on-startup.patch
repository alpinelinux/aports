Patch-Source: https://github.com/thezbyg/gpick/commit/480f9ef15bb657aed0d320d67e30197fe02bcad4
---
From 480f9ef15bb657aed0d320d67e30197fe02bcad4 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Albertas=20Vy=C5=A1niauskas?= <thezbyg@gmail.com>
Date: Sun, 30 Nov 2025 10:16:29 +0200
Subject: [PATCH] Fix crash on startup when settings are empty.

Issue #234.
---
 source/GlobalState.cpp |  2 +-
 source/dynv/Map.cpp    | 11 +++++++----
 source/dynv/Map.h      |  4 ++--
 3 files changed, 10 insertions(+), 7 deletions(-)

diff --git a/source/GlobalState.cpp b/source/GlobalState.cpp
index 47b5a2f..1f130cb 100644
--- a/source/GlobalState.cpp
+++ b/source/GlobalState.cpp
@@ -48,7 +48,7 @@ struct ConverterOptions: public Converter::Options, public IEventHandler {
 		m_settings(settings) {
 	}
 	void update() {
-		auto options = m_settings.getMap("gpick.options");
+		auto options = m_settings.getOrEmptyMap("gpick.options");
 		upperCaseHex = options->getString("hex_case", "upper") == "upper";
 		cssPercentages = options->getBool("css_percentages", false);
 		cssAlphaPercentage = options->getBool("css_alpha_percentage", false);
diff --git a/source/dynv/Map.cpp b/source/dynv/Map.cpp
index a895951..7d3c26b 100644
--- a/source/dynv/Map.cpp
+++ b/source/dynv/Map.cpp
@@ -118,9 +118,6 @@ std::vector<Color> Map::getColors(const std::string &name) const {
 std::vector<std::string> Map::getStrings(const std::string &name) const {
 	return getVector<std::string>(*this, name);
 }
-Ref Map::getMap(const std::string &name) {
-	return get<Ref>(*this, name);
-}
 Ref Map::getOrCreateMap(const std::string &name) {
 	bool valid;
 	std::string fieldName;
@@ -141,9 +138,15 @@ Ref Map::getOrCreateMap(const std::string &name) {
 	}
 	return std::get<Ref>(data);
 }
-const Ref Map::getMap(const std::string &name) const {
+Ref Map::getMap(const std::string &name) const {
 	return get<Ref>(*this, name);
 }
+Ref Map::getOrEmptyMap(const std::string &name) const {
+	auto result = get<Ref>(*this, name);
+	if (!result)
+		return create();
+	return result;
+}
 std::vector<Ref> Map::getMaps(const std::string &name) {
 	bool valid;
 	std::string fieldName;
diff --git a/source/dynv/Map.h b/source/dynv/Map.h
index 832405a..d6910a7 100644
--- a/source/dynv/Map.h
+++ b/source/dynv/Map.h
@@ -56,9 +56,9 @@ struct Map: public common::Ref<Map>::Counter {
 	std::vector<int32_t> getInt32s(const std::string &name) const;
 	std::vector<Color> getColors(const std::string &name) const;
 	std::vector<std::string> getStrings(const std::string &name) const;
-	Ref getMap(const std::string &name);
 	std::vector<Ref> getMaps(const std::string &name);
-	const Ref getMap(const std::string &name) const;
+	Ref getMap(const std::string &name) const;
+	Ref getOrEmptyMap(const std::string &name) const;
 	std::vector<Ref> getMaps(const std::string &name) const;
 	Ref getOrCreateMap(const std::string &name);
 	std::vector<Ref> getOrCreateMaps(const std::string &name);
