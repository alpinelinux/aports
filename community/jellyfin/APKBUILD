# Contributor: Fabricio Silva <hi@fabricio.dev>
# Contributor: Martin Kjær Jørgensen <me@lagy.org>
# Maintainer: Simon Zeni <simon@bl4ckb0ne.ca>
pkgname=jellyfin
pkgver=10.11.6
pkgrel=1
pkgdesc="The Free Software Media System"
install="$pkgname.pre-install"
url="https://jellyfin.org/"
arch="x86_64 armv7 aarch64"
license="GPL-2.0-only"
makedepends="dotnet9-sdk gawk"
depends="aspnetcore9-runtime jellyfin-ffmpeg skiasharp"
subpackages="$pkgname-openrc"
pkgusers="jellyfin"
pkggroups="jellyfin"
source="$pkgname-$pkgver.tar.gz::https://github.com/jellyfin/jellyfin/archive/refs/tags/v$pkgver.tar.gz
	$pkgname.initd
	$pkgname.confd
	remove-prebuilt-library.patch
	"

prepare() {
	default_prepare

	# set SkiaSharp and SkiaSharp.Harfbuzz version based on packaged library
	local _skia_packagedver=$(apk version skiasharp | tail -n 1 | cut -d '=' -f 2  | tr -d ' ')
	local _skia_packagedver=${_skia_packagedver/-*}
	msg "Building against skiasharp $_skia_packagedver"
	gawk -i inplace -v skia_version="Version=\"$_skia_packagedver\"" '{if($2 == "Include=\"SkiaSharp\""){ $3 = skia_version}{print}}' Directory.Packages.props
	gawk -i inplace -v skia_version="Version=\"$_skia_packagedver\"" '{if($2 == "Include=\"SkiaSharp.HarfBuzz\""){ $3 = skia_version}{print}}' Directory.Packages.props
}

build() {
	dotnet publish Jellyfin.Server \
		--configuration Release \
		--no-self-contained \
		--use-current-runtime \
		--output publish
}

check() {
	dotnet test --no-restore
}

package() {
	mkdir -p "$pkgdir"/usr/lib "$pkgdir"/usr/bin "$pkgdir"/etc/jellyfin

	chmod 0750 "$pkgdir"/etc/jellyfin
	chown jellyfin:jellyfin "$pkgdir"/etc/jellyfin

	cp -a publish "$pkgdir"/usr/lib/jellyfin
	ln -s ../lib/jellyfin/jellyfin "$pkgdir"/usr/bin/jellyfin
	ln -s ../libSkiaSharp.so "$pkgdir"/usr/lib/jellyfin/libSkiaSharp.so

	install -Dm755 "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -Dm644 "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname
}

sha512sums="
be4d47b35e43e0e06b397f9af85caad13f573c520f3e6367f84a014e77ab2c63a2cc14c856b3c392f7c06ad48a696e7c2242995bf32b66132e5f6be8954a9c9b  jellyfin-10.11.6.tar.gz
078e8997cb631b24d29dfe92bb13a3d71749e1fd13a146a438848f4090074e08d9ee6c94caf3871854bdb0620714f96fbe80ee05a9e3cef4fe41187edcc29185  jellyfin.initd
486bd56306291d8f31cc6d489d3d57f16b892f6b583dd2d02f91076c4d420cc698e3aac9cabc27161340a3bdcf91d9006088058e2bd3cfc6cdef778267b544bb  jellyfin.confd
bc91d16b2a3595079353d511d063785f06e6870431b8365f38f3b1a4f9414285a4d9fb7b033d786df6422b308948c410462733ce2a2cb3472818784dec532f5e  remove-prebuilt-library.patch
"
