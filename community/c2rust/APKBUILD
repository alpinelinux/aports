# Contributor: Marian Buschsieweke <marian.buschsieweke@posteo.net>
# Maintainer: Marian Buschsieweke <marian.buschsieweke@posteo.net>
pkgname=c2rust
pkgver=0.21.0
pkgrel=0
pkgdesc="Transpile C99-compliant code to (unsafe) Rust code"
url="https://github.com/immunant/c2rust"
# riscv64, loongarch64: libc crate sup
# s390x: missing big endian support in c2rust-bitfields-derive
arch="all !riscv64 !s390x !loongarch64"
license="BSD-3-Clause"
# Note: LLVM's CMake hooks check for presence of static libs and tools and
# failif they are missing. So they are needed for building even when linking
# dynamically
_llvmver=21
makedepends="
	cargo
	cargo-auditable
	clang$_llvmver-dev
	clang$_llvmver-extra-tools
	clang$_llvmver-static
	cmake
	libxml2-dev
	llvm$_llvmver-dev
	llvm$_llvmver-gtest
	llvm$_llvmver-static
	ncurses-dev
	openssl-dev
	rust
	samurai
	tinycbor-dev
	"
checkdepends="
	python3
	py3-plumbum
	py3-psutil
	py3-toml
	"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/immunant/c2rust/archive/refs/tags/v$pkgver.tar.gz
	0001-link-clang-dynamic.patch
	0002-use-system-tinycbor.patch
	"

# Unit tests all fail using rust 1.86.0 with:
#
#    error[E0554]: #![feature] may not be used on the stable release channel
#
# and
#
#    error[E0635]: unknown feature `stdsimd`
#
# Eventually, unit tests should also run on stable rust
options="!check"

export CARGO_PROFILE_RELEASE_LTO="true"
export CARGO_PROFILE_RELEASE_PANIC="abort"
export CARGO_PROFILE_RELEASE_OPT_LEVEL="s"

prepare() {
	default_prepare

	cargo fetch --target="$CTARGET" --locked
}

build() {
	export PATH="$PATH:/usr/lib/llvm$_llvmver/bin/"
	cargo auditable build --release --frozen --package c2rust
}

check() {
	./scripts/test_translator.py tests
}

package() {
	mkdir -p "$pkgdir"/usr/bin "$pkgdir"/usr/lib
	for bin in c2rust c2rust-transpile; do
		install -D -m755 target/release/$bin -t "$pkgdir"/usr/bin/
	done
}

sha512sums="
3a59c6ff7b1d71cbf229b2163944874354d799869d11d159d8c21b5b0099e62a314bf8d0be18e2f0c926955b4fd495b1cb0c72e0f80663ae1f9a45c3a1001925  c2rust-0.21.0.tar.gz
8d4af6b0f3efaab1c9d030442cdbba9079471d4c849757cd8fb60018e9dba35d19b128fb6a006a99df3f63f718ee49af0ad1fbd8cb5d95d29aa47b221c503158  0001-link-clang-dynamic.patch
be29e0f4576301b64f5fc38684ddb90e469526be4ce8ef428feee0d5962748c428045dcb81635ff92e132daebb1fa1b338a81ce1ea13d02b802ec057d0653b93  0002-use-system-tinycbor.patch
"
