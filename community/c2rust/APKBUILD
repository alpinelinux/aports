# Contributor: Marian Buschsieweke <marian.buschsieweke@posteo.net>
# Maintainer: Marian Buschsieweke <marian.buschsieweke@posteo.net>
pkgname=c2rust
pkgver=0.22.0
pkgrel=0
pkgdesc="Transpile C99-compliant code to (unsafe) Rust code"
url="https://github.com/immunant/c2rust"
# riscv64, loongarch64: libc crate sup
# s390x: missing big endian support in c2rust-bitfields-derive
arch="all !riscv64 !s390x !loongarch64"
license="BSD-3-Clause"
# Note: LLVM's CMake hooks check for presence of static libs and tools and
# failif they are missing. So they are needed for building even when linking
# dynamically
_llvmver=21
makedepends="
	cargo
	cargo-auditable
	clang$_llvmver-dev
	clang$_llvmver-extra-tools
	clang$_llvmver-static
	cmake
	libxml2-dev
	llvm$_llvmver-dev
	llvm$_llvmver-gtest
	llvm$_llvmver-static
	ncurses-dev
	openssl-dev
	rust
	samurai
	tinycbor-dev
	"
checkdepends="
	python3
	py3-plumbum
	py3-psutil
	py3-toml
	"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/immunant/c2rust/archive/refs/tags/v$pkgver.tar.gz
	0001-link-clang-dynamic.patch
	0002-use-system-tinycbor.patch
	"

# Unit tests all fail using rust 1.86.0 with:
#
#    error[E0554]: #![feature] may not be used on the stable release channel
#
# and
#
#    error[E0635]: unknown feature `stdsimd`
#
# Eventually, unit tests should also run on stable rust
options="!check"

export CARGO_PROFILE_RELEASE_LTO="true"
export CARGO_PROFILE_RELEASE_PANIC="abort"
export CARGO_PROFILE_RELEASE_OPT_LEVEL="s"

prepare() {
	default_prepare

	cargo fetch --target="$CTARGET" --locked
}

build() {
	export PATH="$PATH:/usr/lib/llvm$_llvmver/bin/"
	cargo auditable build --release --frozen --package c2rust
}

check() {
	./scripts/test_translator.py tests
}

package() {
	mkdir -p "$pkgdir"/usr/bin "$pkgdir"/usr/lib
	for bin in c2rust c2rust-transpile; do
		install -D -m755 target/release/$bin -t "$pkgdir"/usr/bin/
	done
}

sha512sums="
c9c63ef3dd5b6d77ca60ececa0a4f59aa221e60b0b7791373fe43f81fbb3be51810e7527d335fee804b16955cb99846f8668db71ba53ba8f9b11e44bf157a81d  c2rust-0.22.0.tar.gz
2c8ef765ca1c3744eaad58552d2c8a45b9d72a2dc446921ad233792618eeb022821f7659b94190d7bf6b3e3892e73c4ead4baa14212bcd595b7fd9aac747efc1  0001-link-clang-dynamic.patch
3aeaf269cb940fed83da0b90823fb379b4d0f9031786865b3f7b6268cadf932693a9ff3ac7679435d2ce029b9a4b4bfc7ca8328d3bb2387e797dc3b10606eab5  0002-use-system-tinycbor.patch
"
