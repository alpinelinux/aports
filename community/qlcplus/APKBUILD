maintainer="Achill Gilgenast <achill@achill.org>"
pkgname=qlcplus
pkgver=5.2.0
pkgrel=0
pkgdesc="The open DMX lighting desk software for controlling professional lighting fixtures"
url="https://qlcplus.org/"
# armhf blocked by qt6-qtmultimedia, x86/armv7 build fails
arch="all !armhf !x86 !armv7"
license="Apache-2.0"
makedepends="
	alsa-lib-dev
	bash
	cmake
	desktop-file-utils
	fftw
	libftdi1-dev
	libmad-dev
	libsndfile-dev
	qt6-qt3d-dev
	qt6-qtmultimedia-dev
	qt6-qtserialport-dev
	qt6-qttools-dev
	qt6-qtwebsockets-dev
	samurai
	shared-mime-info
	"
checkdepends="py3-lxml"
subpackages="$pkgname-udev"
source="$pkgname-$pkgver.tar.gz::https://github.com/mcallegari/qlcplus/archive/QLC+_$pkgver.tar.gz"
builddir="$srcdir/qlcplus-QLC-_$pkgver"
options="!check" # currently failing

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		local crossopts="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	export PATH="$PATH:/usr/lib/qt6/bin"
	cmake -B build \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=ON \
		-DCMAKE_BUILD_TYPE=None \
		-DUDEVRULESDIR=/usr/lib/udev/rules.d \
		-Dqmlui=ON \
		$crossopts
	cmake --build build
}

check() {
	cmake --build build --target check
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
44bdd41219a4a8f1f281e1634f735150982697c2eee80d25ba9b5ce35a440871273410088a64275c181a70ef92f5c9a69e980d7fbe6a174923aae42fe7917d1a  qlcplus-5.2.0.tar.gz
"
