# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=cfengine
# Upgrade to LTS versions only: https://cfengine.com/supported-versions/
pkgver=3.27.0
pkgrel=0
pkgdesc="A systems administration tool for networks"
url="https://www.cfengine.com/"
arch="all"
license="GPL-3.0-only"
install="$pkgname.post-install"
makedepends="
	acl-dev
	bison
	flex-dev
	librsync-dev
	linux-headers
	lmdb-dev
	openssl-dev>3
	pcre2-dev
	"
depends="procps"
subpackages="$pkgname-doc $pkgname-masterfiles::noarch"
source="https://cfengine-package-repos.s3.amazonaws.com/tarballs/cfengine-community-$pkgver.tar.gz
	https://cfengine-package-repos.s3.amazonaws.com/tarballs/cfengine-masterfiles-$pkgver.tar.gz
	fix-32bit-ulong.patch
	"

_builddirmasterfiles="$srcdir"/cfengine-masterfiles-${pkgver%_p*}
options="!check" # testsuite shows some unknown errors

# secfixes:
#   3.12.2-r0:
#     - CVE-2019-9929

prepare() {
	default_prepare
	update_config_sub

	# Also extract masterfiles
	cd $srcdir
	tar xf $pkgname-masterfiles-$pkgver.tar.gz
	cd "$_builddirmasterfiles"
	update_config_guess
}

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--with-pic \
		--prefix=/usr \
		--enable-fhs \
		--localstatedir=/var \
		--mandir=/usr/share/man \
		--with-lmdb \
		--without-pam
	make

	cd "$_builddirmasterfiles"
	./configure \
		--prefix=/var/lib/cfengine
	make
}

package() {
	make install DESTDIR="$pkgdir"

	# not FHS but the tools seems to require those
	install -d "$pkgdir"/var/lib/cfengine/bin
	for i in "$pkgdir"/usr/bin/*; do
		ln -s ../../../../usr/bin/${i##*/} "$pkgdir"/var/lib/cfengine/bin/
	done
}

masterfiles() {
	pkgdesc="Cfengine default masterfiles"
	depends="cfengine"

	cd "$_builddirmasterfiles"
	make install DESTDIR="$subpkgdir"
}

sha512sums="
2c000c7a8d2357ba82a5da76855fd5b0cf3198ca432f5909e36cfd640de268ed935b4b54e2d93be4c5d8b3a5b58b4a06bee290dfa838c4a05804f783e3d18f30  cfengine-community-3.27.0.tar.gz
7cd02b6a7d14b1909b532f0d66a7a3089a5d0bf81487851dd3d08debd473328918cba73825878eaa7ca1feb765c62ba703f1ea2ebe520a40ee5beb4edf0b26a0  cfengine-masterfiles-3.27.0.tar.gz
3d194074562477f48dcb4c8c63d4d82d59a0da6f15c2806dedae68472c8b10e20b98c25e4aa693e91d6fe33561843c89df82e7cc4eff4c43917ea62e1a8004b2  fix-32bit-ulong.patch
"
