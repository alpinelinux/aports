# Contributor: Isaac Dunham <ibid.ag@gmail.com>
# Contributor: Aiden Grossman <agrossman154@yahoo.com>
# Contributor: Holger Jaekel <holger.jaekel@gmx.de>
maintainer="Achill Gilgenast <achill@achill.org>"
pkgname=py3-matplotlib
pkgver=3.10.6
_imgver=3.10.3
_ftver=2.13.1
pkgrel=0
pkgdesc="Python3 library for plots"
url="https://matplotlib.org"
arch="all"
license="PSF-2.0"
depends="
	py3-contourpy
	py3-cycler
	py3-dateutil
	py3-fonttools
	py3-kiwisolver
	$pkgname-data
	py3-numpy
	py3-packaging
	py3-parsing
	py3-pillow
	"
makedepends="
	freetype-dev
	py3-gpep517
	py3-meson-python
	py3-numpy-dev
	py3-pybind11-dev
	py3-setuptools_scm
	python3-dev
	qhull-dev
	"
checkdepends="
	font-opensans
	ghostscript
	inkscape
	jupyter-nbformat
	jupyter-nbconvert
	py3-pandas
	py3-pikepdf
	py3-psutil
	py3-pytest
	py3-pytest-cov
	py3-pytest-timeout
	py3-pytest-xdist
	py3-pytzdata
	py3-sphinx
	py3-xarray
	"
subpackages="
	$pkgname-fonts::noarch
	$pkgname-data::noarch
	$pkgname-qt5-pyc:qt5_pyc
	$pkgname-qt5::noarch
	$pkgname-qt6::noarch
	$pkgname-gtk3-pyc:gtk3_pyc
	$pkgname-gtk3::noarch
	$pkgname-gtk4-pyc:gtk4_pyc
	$pkgname-gtk4::noarch
	$pkgname-tk-pyc:tk_pyc
	$pkgname-tk
	$pkgname-wx-pyc:wx_pyc
	$pkgname-wx::noarch
	$pkgname-pyc
	"
# from https://src.fedoraproject.org/rpms/python-matplotlib/tree/rawhide
source="https://github.com/matplotlib/matplotlib/archive/v$pkgver/matplotlib-v$pkgver.tar.gz
	https://github.com/QuLogic/mpl-images/archive/v$_imgver-with-freetype-$_ftver/mpl-images-$_imgver-ft$_ftver.tar.gz
	0001-matplotlibrc-path-search-fix.patch
	0002-Set-FreeType-version-to-2.13.1-and-update-tolerances.patch
	0003-Unpin-meson-python-build-requirement.patch
	0004-Use-old-stride_windows-implementation-on-32-bit-x86.patch
	0005-Partially-revert-TST-Fix-minor-issues-in-interactive.patch
	0006-TST-Use-a-temporary-directory-for-test_save_figure_r.patch
	gi_require_version.patch
	"
builddir="$srcdir/matplotlib-$pkgver"
# tests are flaking
options="!check"

case "$CARCH" in
	armhf|armv7|x86|loongarch64|riscv64|s390x)
		options="$options !check" # jupyter-nbconvert -> py3-jupyterlab_pygments -> py3-jupyterlab_pygments
		;;
esac

build() {
	export SETUPTOOLS_SCM_PRETEND_VERSION=$pkgver
	gpep517 build-wheel \
		--wheel-dir .dist \
		--config-json '{"setup-args": ["-Dsystem-freetype=true", "-Dsystem-qhull=true"]}' \
		--output-fd 3 3>&1 >&2
}

check() {
	local python_version=$(python -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
	python3 -m venv --clear --without-pip --system-site-packages test-env
	test-env/bin/python3 -m installer .dist/*.whl
	mkdir -p test-env/share/matplotlib
	cp -r test-env/lib/python$python_version/site-packages/matplotlib/mpl-data test-env/share/matplotlib/mpl-data

	for _module in matplotlib mpl_toolkits
	do
		cp -r lib/$_module/* test-env/lib/python$python_version/site-packages/$_module
		cp -r "$srcdir"/mpl-images-$_imgver-with-freetype-$_ftver/lib/$_module/* test-env/lib/python$python_version/site-packages/$_module
	done

	# musl locale deficiencies
	local k="not test_locale_comma"
	case "$CARCH" in
	aarch64|arm*|ppc64le|s390x|x86_64)
		# FIXME: failing on at least armhf & s390x package builders
		k="$k and not test_get_font_names"
		;;
	esac
	case "$CARCH" in
	loongarch64|riscv64)
		# some tests fail on loongarch64 and riscv64
		k="$k and not test_imshow_clip and not test_contour_addlines and not test_contour_colorbar and not test_contour3d"
		;;
	esac
	case "$CARCH" in
	aarch64|ppc64le|s390x|loongarch64|riscv64)
		# FIXME: fails for some reason only on these architectures
		k="$k and not test_zoom_inset_connector_styles"
		;;
	esac

	test-env/bin/python3 -m pytest -n $JOBS -v \
		--pyargs matplotlib mpl_toolkits.axes_grid1 mpl_toolkits.axisartist mpl_toolkits.mplot3d \
		-k "$k"
}

package() {
	python3 -m installer --destdir="$pkgdir" .dist/*.whl

	# Remove tests from installation
	find "$pkgdir" -type d -name tests -exec rm -r {} \+
}

fonts() {
	pkgdesc="Fonts used by $pkgname"
	license="OFL-1.0 AND Bitstream-Vera AND Public-Domain"
	depends=""

	local python_version=$(python -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
	amove usr/lib/python$python_version/site-packages/matplotlib/mpl-data/fonts
}

data() {
	pkgdesc="Data used by $pkgname"
	depends="$pkgname-fonts=$pkgver-r$pkgrel"

	local python_version=$(python -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
	amove usr/lib/python$python_version/site-packages/matplotlib/mpl-data
}

qt5() {
	pkgdesc="Qt5 backend for $pkgname"
	depends="$pkgname=$pkgver-r$pkgrel py3-cairocffi py3-qt5"

	local python_version=$(python -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
	amove usr/lib/python$python_version/site-packages/matplotlib/backends/backend_qt5*.py
}

qt5_pyc() {
	pkgdesc="Precompiled Python bytecode for ${subpkgname%-pyc}"
	install_if="${subpkgname%-pyc}=$pkgver-r$pkgrel pyc"
	depends="$pkgname-qt5=$pkgver-r$pkgrel"

	local python_version=$(python -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
	amove usr/lib/python$python_version/site-packages/matplotlib/backends/__pycache__/backend_qt5*.pyc
}

qt6() {
	pkgdesc="Qt6 backend for $pkgname"
	depends="$pkgname=$pkgver-r$pkgrel py3-cairocffi py3-qt6"

	# This is handled by backend_qt*.py (no number), so the package exists only for
	# the dependencies.
	mkdir $subpkgdir
}

gtk3() {
	pkgdesc="GTK3 backend for $pkgname"
	depends="$pkgname=$pkgver-r$pkgrel py3-gobject3"

	local python_version=$(python -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
	amove usr/lib/python$python_version/site-packages/matplotlib/backends/backend_gtk3*.py
}

gtk3_pyc() {
	pkgdesc="Precompiled Python bytecode for ${subpkgname%-pyc}"
	install_if="${subpkgname%-pyc}=$pkgver-r$pkgrel pyc"
	depends="$pkgname-gtk3=$pkgver-r$pkgrel"

	local python_version=$(python -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
	amove usr/lib/python$python_version/site-packages/matplotlib/backends/__pycache__/backend_gtk3*.pyc
}

gtk4() {
	pkgdesc="GTK4 backend for $pkgname"
	depends="$pkgname=$pkgver-r$pkgrel py3-gobject3"

	local python_version=$(python -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
	amove usr/lib/python$python_version/site-packages/matplotlib/backends/backend_gtk4*.py
}

gtk4_pyc() {
	pkgdesc="Precompiled Python bytecode for ${subpkgname%-pyc}"
	install_if="${subpkgname%-pyc}=$pkgver-r$pkgrel pyc"
	depends="$pkgname-gtk4=$pkgver-r$pkgrel"

	local python_version=$(python -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
	amove usr/lib/python$python_version/site-packages/matplotlib/backends/__pycache__/backend_gtk4*.pyc
}

tk() {
	pkgdesc="Tk backend for $pkgname"
	depends="$pkgname=$pkgver-r$pkgrel python3-tkinter"

	local python_version=$(python -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
	amove usr/lib/python$python_version/site-packages/matplotlib/backends/backend_tk*.py
	amove usr/lib/python$python_version/site-packages/matplotlib/backends/_backend_tk.py
	amove usr/lib/python$python_version/site-packages/matplotlib/backends/_tkagg.*
}

tk_pyc() {
	pkgdesc="Precompiled Python bytecode for ${subpkgname%-pyc}"
	install_if="${subpkgname%-pyc}=$pkgver-r$pkgrel pyc"
	depends="$pkgname-tk=$pkgver-r$pkgrel"

	local python_version=$(python -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
	amove usr/lib/python$python_version/site-packages/matplotlib/backends/__pycache__/backend_tk*.pyc
	amove usr/lib/python$python_version/site-packages/matplotlib/backends/__pycache__/_backend_tk*.pyc
}

wx() {
	pkgdesc="WX backend for $pkgname"
	depends="$pkgname=$pkgver-r$pkgrel py3-wxpython"

	local python_version=$(python -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
	amove usr/lib/python$python_version/site-packages/matplotlib/backends/backend_wx*.py
}

wx_pyc() {
	pkgdesc="Precompiled Python bytecode for ${subpkgname%-pyc}"
	install_if="${subpkgname%-pyc}=$pkgver-r$pkgrel pyc"
	depends="$pkgname-wx=$pkgver-r$pkgrel"

	local python_version=$(python -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
	amove usr/lib/python$python_version/site-packages/matplotlib/backends/__pycache__/backend_wx*.pyc
}

sha512sums="
caf7dc80ecbe93d47b65af1fb605dbcd0c384d6e453c76171dfef9c42db0b7045a9413e5fcb1a46a738d95e161431fb013b531353e01b82c5c7d3cf461e67e7b  matplotlib-v3.10.6.tar.gz
bb32e57bbd341c652d03361e3785145a9e89f59709eb588882f81cba4061c8aa7250c0d46ed07a588d75a055d72bbc6126c59e8777634385a458287f6ef8812f  mpl-images-3.10.3-ft2.13.1.tar.gz
40cb46a514937b81d12c14e7105ca978f07e9a554844ce24989f0552143ab0a0cc2fb6a700040678c791cae40bc47c17ef287834931cb384985780fc199cb535  0001-matplotlibrc-path-search-fix.patch
9e9744002c91a98bec32c56b4b85e195681cdd7b70bf681b3d5af61aaf20d8aaa816550e06539c0dd22977acaa1eff604d927b0b55d2bc650e4c2137d9b8074c  0002-Set-FreeType-version-to-2.13.1-and-update-tolerances.patch
96ca37482b8e65792ff2abb54942819ce7e50ba9df8bb3d8c8a5daf9c0fb607cc6f413592387a9cd6c74564dfbc3c617d1556f732d08822a255f90adc50bc70d  0003-Unpin-meson-python-build-requirement.patch
dcb63962d0629415b47478dae487e652164693d5f6e88fb43fe2669b69fba735d98287f427bce4f3498fdcb2aabc4c885ef5d5d5830cf49e447be59c889fd879  0004-Use-old-stride_windows-implementation-on-32-bit-x86.patch
2364786bf8f443860d30ded1f1ba4557b1ed9fc7e2391e9207f588c23ea5c40f726dc3217b35676a8da7e37296309ee00aea569587e390c01ee9a725f887812c  0005-Partially-revert-TST-Fix-minor-issues-in-interactive.patch
b4d6b8d2fc5283532119ef921fe19b9e6e585e028df9544663ab8480f4db0331b4261c650f364d49442a007a8bf4ae283b2a69c3b4e7c1528d63e84e0378172d  0006-TST-Use-a-temporary-directory-for-test_save_figure_r.patch
3d9834c7a15ab855e050c224bd8c7d70982ab134f735a1e00c201717a1d79898bf99dc72c64174cec922ccdb3dd7fe4f5618a5d6ef1cb04e35a7db575e7b8e8a  gi_require_version.patch
"
