maintainer="Michał Polański <michal@polanski.me>"
pkgname=black
pkgver=25.11.0
pkgrel=0
pkgdesc="The uncompromising Python code formatter"
url="https://github.com/psf/black"
license="MIT"
arch="noarch"
depends="
	py3-aiohttp
	py3-click
	py3-mypy-extensions
	py3-packaging
	py3-pathspec
	py3-platformdirs
	py3-pytokens
	"
makedepends="
	py3-gpep517
	py3-hatchling
	py3-hatch-vcs
	py3-wheel
	"
checkdepends="
	py3-parameterized
	py3-pytest
	"
subpackages="
	$pkgname-pyc
	$pkgname-bash-completion
	$pkgname-fish-completion
	$pkgname-zsh-completion
	"
source="https://files.pythonhosted.org/packages/source/b/black/black-$pkgver.tar.gz
	remove-fancy-pypi-readme.patch
	"

# secfixes:
#   24.3.0-r0:
#     - CVE-2024-21503

build() {
	gpep517 build-wheel \
		--wheel-dir .dist \
		--output-fd 3 3>&1 >&2

	python3 -m venv --clear --without-pip --system-site-packages venv
	./venv/bin/python3 -m installer \
		.dist/black-$pkgver-py3-none-any.whl

	for cmd in black blackd; do
		_BLACK_COMPLETE=bash_source ./venv/bin/black >$cmd.bash
		_BLACK_COMPLETE=fish_source ./venv/bin/black >$cmd.fish
		_BLACK_COMPLETE=zsh_source ./venv/bin/black >$cmd.zsh
	done
}

check() {
	ulimit -n 4096 # prevent running out of file descriptors
	./venv/bin/python3 -m pytest
}

package() {
	python3 -m installer -d "$pkgdir" \
		.dist/black-$pkgver-py3-none-any.whl

	for cmd in black blackd; do
		install -Dm644 $cmd.bash "$pkgdir"/usr/share/bash-completion/completions/$cmd
		install -Dm644 $cmd.fish "$pkgdir"/usr/share/fish/vendor_completions.d/$cmd.fish
		install -Dm644 $cmd.zsh "$pkgdir"/usr/share/zsh/site-functions/_$cmd
	done
}

sha512sums="
e6b91cc3772b5a079baf99792140d8d66448b2d17aa27706af5a9c652fca04ed4815dab4fdcaf93721d0b7e85e5fec85ba3fd14f08487a82f558c140a3dfbfd6  black-25.11.0.tar.gz
df4e0b6784d61cbc478662cbe3aeb07bb91c496e43cf54349004c516211f48571a92b2460c2823c2556ff477cfa4017e2d4b80ade482496445af9a66af31990b  remove-fancy-pypi-readme.patch
"
