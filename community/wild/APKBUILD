# Contributor: Matthias Ahouansou <matthias@ahouansou.cz>
maintainer="Matthias Ahouansou <matthias@ahouansou.cz>"
pkgname=wild
pkgver=0.8.0
pkgrel=0
pkgdesc="Very fast linker for Linux"
url="https://github.com/davidlattimore/wild"
# Only x86_64, aarch64, loongarch64 and riscv64 are officially supported (as of 0.8.0)
# https://github.com/davidlattimore/wild?tab=readme-ov-file#whats-working
arch="x86_64 aarch64 loongarch64 riscv64"
license="MIT OR Apache-2.0"
makedepends="cargo-auditable"
checkdepends="
	bash
	cmd:clang-format
	lld
"
# gcc doesn't support using arbitrary linkers
depends="clang"
subpackages="$pkgname-doc"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/davidlattimore/wild/archive/refs/tags/$pkgver.tar.gz
	fix-riscv64-test.patch
"
options="net"

prepare() {
	default_prepare

	cargo fetch --target="$CTARGET" --locked
}

build() {
	# https://github.com/davidlattimore/wild/blob/main/PACKAGING.md
	cargo auditable build --frozen --features mimalloc --profile dist
}

check() {
	cargo test --frozen
}

package() {
	install -Dm 755 target/dist/wild "$pkgdir"/usr/bin/wild

	install -Dm 644 LICENSE-APACHE LICENSE-MIT -t "$pkgdir"/usr/share/licenses/"$pkgname"/
}

sha512sums="
dc88b41cdfbbdbff69c4dedf121e30dc5f3543bfab0eb53ebcc35590a200582d2157f752effd0750d9862addd92252dc1e61e60b545a5bb9dcff4a59adcd9217  wild-0.8.0.tar.gz
8a6c232c225102b99c93ec8abc4c82c1d5912409b3d2e1ac44dbd2ce2442d9fe15e2df1e9813cc02d83fa0543b43333997783f58497d0ecae345324c35e2cd7c  fix-riscv64-test.patch
"
