maintainer="Dekedro <dekedro@protonmail.com>"
pkgname=rnnoise
pkgver=0.2
pkgrel=0
pkgdesc="Recurrent neural network for audio noise reduction"
url="https://jmvalin.ca/demo/rnnoise/"
arch="all"
license="BSD-3-Clause"
makedepends="autoconf automake libtool"
subpackages="$pkgname-dev $pkgname-doc"
options="!check" # No tests
_model_version=0b50c45
source="$pkgname-$pkgver.tar.gz::https://gitlab.xiph.org/xiph/rnnoise/-/archive/v$pkgver/rnnoise-v$pkgver.tar.gz
	https://media.xiph.org/rnnoise/models/rnnoise_data-$_model_version.tar.gz
	$pkgname-fix-compilation-errors.patch::https://gitlab.xiph.org/xiph/rnnoise/-/commit/372f7b4b76cde4ca1ec4605353dd17898a99de38.patch"
builddir="$srcdir/$pkgname-v$pkgver"

prepare() {
	default_prepare

	test $_model_version = "$(cat model_version)" || exit 1
	mv "$srcdir"/models "$builddir/"
	mv "$srcdir"/src/* "$builddir/src/"

	rm "$builddir/update_version"
	echo "PACKAGE_VERSION='$pkgver'" > "$builddir/package_version"

	case "$CARCH" in
	x86*) flags="--enable-x86-rtcd" ;;
	esac

	autoreconf -isf
	./configure --prefix=/usr --build=$CBUILD --host=$CHOST $flags
}

build() {
	make
}

package() {
	make DESTDIR="$pkgdir" install
}

sha512sums="
930aa892299edbc1d512803df6b845ea6164eb498cacdab9970e5ae799bc6cf3c8c94d2b9576955fb9a2d8aa13a6d255e58fb99d0367a0d0ef842a1cb938e674  rnnoise-0.2.tar.gz
c15fef7c88d86264a29a3dab14d94bde769da68f255d131d135f6a40d94037b1ffe521f9e0a26339114750dbdd7cf774c3185ba40279c74200fb32732f57db8b  rnnoise_data-0b50c45.tar.gz
5f841d2971b66cc4ac492857975aee2d00b6d16defd5aaad00b4dc3ff697a3a426dff24406483a0fdf85594de61ae6a99d02e57bf931544e88948fdc724184f4  rnnoise-fix-compilation-errors.patch
"
