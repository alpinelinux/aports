# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
pkgname=py3-cx_freeze
_pkgname=cx_Freeze
pkgver=8.4.1
pkgrel=0
pkgdesc="Set of utilities for freezing Python scripts into executables"
url="https://github.com/marcelotduarte/cx_Freeze"
arch="all"
license="PSF-2.0"
depends="patchelf"
makedepends="py3-gpep517 py3-setuptools python3-dev py3-wheel"
checkdepends="py3-pytest py3-pytest-mock py3-filelock py3-pip"
subpackages="$pkgname-pyc"
source="$pkgname-$pkgver.tar.gz::https://github.com/marcelotduarte/cx_Freeze/archive/refs/tags/$pkgver.tar.gz
	tests.patch
	"
builddir="$srcdir"/$_pkgname-$pkgver

case "$CARCH" in
# tests use networking
x86_64) options="net" ;;
# FIXME fetched packages seem to expect x86_64
*) options="!check" ;;
esac

prepare() {
	default_prepare

	sed -i 's/DESTSHARED/DESTLIB/' "$builddir/cx_Freeze/freezer.py"
}

build() {
	gpep517 build-wheel \
		--wheel-dir .dist \
		--output-fd 3 3>&1 >&2
}

check() {
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer .dist/*.whl
	PYTHONSAFEPATH=1 .testenv/bin/python3 -m pytest --import-mode=importlib \
		--ignore tests/hooks/test_numpy.py \
		--ignore tests/hooks/test_ortools.py \
		--ignore tests/hooks/test_qt.py \
		--ignore tests/test_winmsvcr.py \
		--deselect tests/test_command_build_exe.py::test_zip_include_packages \
		--deselect tests/test_command_build_exe.py::test_zip_exclude_packages
}

package() {
	python3 -m installer -d "$pkgdir" \
		.dist/*.whl
}

sha512sums="
6efa67cc5b6fd20614bff4abb1e55e7cb3eaf8fc0334d7c643606f1a55898083e578f499432e71ad4dc7a16702e44c58aa743bcd034b5762b3a794fe1fad23d8  py3-cx_freeze-8.4.1.tar.gz
a827d6f838ace8dbfc4162977c29e23b09264327e3eb46f2e89db17e51138bd8d93f2a90ff332a95f6f2978d23f5f25484297d5d88d40273674aafdeb584c3e1  tests.patch
"
