# Contributor: Adrián Arroyo Calle <adrian.arroyocalle@gmail.com>
# Maintainer: Adrián Arroyo Calle <adrian.arroyocalle@gmail.com>
pkgname=scryer-prolog
pkgver=0.10.0
pkgrel=0
pkgdesc="Modern Prolog implementation written in Rust"
url="https://github.com/mthom/scryer-prolog"
# s390x: nix crate
arch="all !s390x"
license="BSD-3-Clause"
makedepends="
	cargo>1.74
	cargo-auditable
	libffi-dev
	libsodium-dev
	m4
	openssl-dev>3
	rustfmt
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/mthom/scryer-prolog/archive/refs/tags/v$pkgver.tar.gz
	fix-system-ffi.patch
	"

# system libs
export OPENSSL_NO_VENDOR=1
export CARGO_FEATURE_USE_SYSTEM_LIBS=1
export SODIUM_USE_PKG_CONFIG=1

prepare() {
	default_prepare

	cargo fetch --target="$CTARGET" --locked
}

build() {
	cargo auditable build --release --frozen
}

check() {
	cargo test --frozen -- \
		--skip issues::issue_delete_directory \
		--skip issues::issue_delete_file \
		--skip issues::issue_directory_files \
		--skip issues::issue_file_copy \
		--skip issues::issue_file_exists \
		--skip issues::issue_file_size \
		--skip issues::issue_file_time \
		--skip issues::issue_make_directory \
		--skip issues::issue_make_directory_path \
		--skip issues::issue_path_canonical \
		--skip issues::issue_rename_file
}

package() {
	install -Dm755 target/release/scryer-prolog -t "$pkgdir"/usr/bin
}

sha512sums="
48fa675acdb56fc5405953b4d1a5d55adce00808eebd76d32157bff205b610d98dbcf25ca5903d274e6d8e22d177ead981d61cdae06ecc9264f30b1692c5db8b  scryer-prolog-0.10.0.tar.gz
dc22560c4968758ace48e9aafc674e9c3254acffe3f5309f08d3c1869abd0121d8b12102dce86593096cc58906df926ceb82843c95dbd924fbcfce83316df3f0  fix-system-ffi.patch
"
