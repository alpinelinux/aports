# Based on Arch's uusi package
# Contributor: Celeste <cielesti@protonmail.com>
# Maintainer:
pkgname=uusi
pkgver=0.4.3
pkgrel=1
pkgdesc="Tweak cabal package descriptions"
url="https://github.com/berberman/uusi"
arch="aarch64 x86_64" # ghc
license="MIT"
makedepends="ghc patchelf"
subpackages="$pkgname-doc"
source="https://github.com/berberman/uusi/archive/$pkgver/uusi-$pkgver.tar.gz
	cabal-3.12.patch
	fix-type-mismatch-error.patch
	"
options="!check" # needs HUnit package

build() {
	runhaskell Setup configure -O \
		--enable-shared \
		--enable-executable-dynamic \
		--disable-library-vanilla \
		--prefix=/usr \
		--docdir=/usr/share/licenses/$pkgname \
		--datasubdir=$pkgname \
		--disable-tests \
		--dynlibdir=/usr/lib \
		--libsubdir=\$compiler/site-local/\$pkgid \
		--ghc-option=-optl-Wl\,-z\,relro\,-z\,now \
		--ghc-option='-pie'

	runhaskell Setup build
}

package() {
	runhaskell Setup copy --destdir="$pkgdir"

	# Trim rpath containing $builddir
	patchelf --shrink-rpath --allowed-rpath-prefixes /usr/lib \
		"$pkgdir"/usr/bin/gen-setup
}

sha512sums="
12ea510341face022ce51a39f10a85c620446daa29170618c0421746dccd9c726837a8309a01bf9b326186a03a508baed5213cf01d5dcb1bf9b35f40adbadaf2  uusi-0.4.3.tar.gz
cefe11de278de64ea2ace46a186caa2a9822faa5c1652abbfbb17bfd856ad86f473d82ef4d771804129032a272ef71802d46de892c3b9fcc24e846e2253a0b6d  cabal-3.12.patch
5a3fa2a9fc5c4203a2cf51db27b6dab19301a6db24b10d05afbd0f7f7e091d1d33fab43807af4093d22dca73293e19c08f946f64c32d61e1f1153827c48646c7  fix-type-mismatch-error.patch
"
