# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Bart Ribbers <bribbers@disroot.org>
pkgname=usb-moded
pkgver=0.86.0.69
_pkgver=${pkgver%.*}+mer${pkgver##*.}
pkgrel=1
_commit_dbus_glib="d42176ae4763e5288ef37ea314fe58387faf2005"
pkgdesc="A daemon activating a certain USB profile based on the usb cable connection status"
url="https://github.com/sailfishos/usb-moded"
arch="all"
license="GPL-2.0-only"
depends_dev="
	eudev-dev
	elogind-dev
	glib-dev
	gobject-introspection-dev
	kmod-dev
	libdsme-dev
	sailfish-access-control
	ssu-sysinfo-dev
	"
makedepends="$depends_dev
	autoconf
	automake
	dbus-dev
	libtool
	"
subpackages="$pkgname-dbg $pkgname-dev $pkgname-openrc $pkgname-systemd"
source="$pkgname-$pkgver.tar.gz::https://github.com/sailfishos/usb-moded/archive/refs/tags/mer/${_pkgver/\//-}.tar.gz
	https://github.com/sailfishos-mirror/dbus-glib/archive/$_commit_dbus_glib/dbus-glib-$_commit_dbus_glib.tar.gz
	usb-moded.confd
	usb-moded.initd
	basename.patch
	"
options="!check" # No test suite available
builddir="$srcdir/$pkgname-mer-${_pkgver/+/-}"

prepare() {
	default_prepare

	# Fix invalid pkgconf version
	sed -i 's/+mer/./' configure.ac

	rmdir dbus-gmain
	mv "$srcdir/dbus-glib-$_commit_dbus_glib" dbus-gmain
}

build() {
	./autogen.sh

	# --enable-systemd is required to build, otherwise it can't find sd-login.h
	./configure \
		--prefix=/usr \
		--enable-connman \
		--enable-ofono \
		--enable-app-sync \
		--enable-systemd
	make
}

package() {
	DESTDIR="$pkgdir" make install

	install -Dm755 "$srcdir"/usb-moded.initd "$pkgdir"/etc/init.d/usb-moded
	install -Dm644 "$srcdir"/usb-moded.confd "$pkgdir"/etc/conf.d/usb-moded

	# The pkg-config & systemd-service file aren't installed automatically for some reason
	install -Dm644 usb_moded.pc -t "$pkgdir"/usr/lib/pkgconfig/
	install -Dm644 systemd/usb-moded.service -t "$pkgdir"/usr/lib/systemd/service/

	install -dm 755 "$pkgdir"/usr/include/$pkgname
	cp src/*.h src/*.xml "$pkgdir"/usr/include/$pkgname

	# Install DBus policies
	install -Dm644 debian/usb_moded.conf \
		"$pkgdir"/usr/share/dbus-1/system.d/usb_moded.conf
}

sha512sums="
55c8892c9f9c5a9cc6b526e8c1f9c55cd5f61922dbc52b1c85abb2850a00d1146c0d8e4f7a631bd0d7927e40908dae2541870bf1cc591b9d527ce29306051829  usb-moded-0.86.0.69.tar.gz
665cd6395ee0ea14086ba30188c62a72697b3f63484681e18fc7f54109c9aca162f2e33aa2fa4d45287c6c0b590e81ca310c143dac0232cd5887692cdaf51256  dbus-glib-d42176ae4763e5288ef37ea314fe58387faf2005.tar.gz
d6548342e6b83fe08d050d81825d14f07aa5ede4961dd7e34d5fca45fbe474e786198559f89e4de3002c7d86737c69e85d21932a5f8c6785c5f2f2b51cbf65bf  usb-moded.confd
38f263a9f1c6711396b2672e53b297dbaa2f41222061da7eb90e2646e52f124b126b9bcedcec5b85e387518d455c132c37ce2196e5975f8e7732be240ead490d  usb-moded.initd
8e15fcdcb5199c7c9deffc417035e2260aa7d4a437056f2ab9141c33220618da59324b87cbcebe9857d0269b170f98e2ea703c69b6543cbae237555cc6e297a4  basename.patch
"
