# Contributor: William Desportes <williamdes@wdes.fr>
# Maintainer: William Desportes <williamdes@wdes.fr>
pkgname=horust
pkgver=0.1.11
pkgrel=0
pkgdesc="Horust is a supervisor / init system written in rust and designed to be run inside containers"
url="https://github.com/FedericoPonzi/Horust"
# s390x: nix crate (https://github.com/nix-rust/nix/pull/2678, https://github.com/nix-rust/nix/issues/2683)
arch="all !s390x"
license="MIT"
makedepends="cargo cargo-auditable protoc"
checkdepends="bash" # test_single_command uses bash
subpackages="$pkgname-doc"
options="net"
source="$pkgname-$pkgver.tar.gz::https://github.com/FedericoPonzi/Horust/archive/v$pkgver.tar.gz
test_multiple-increase-timeout.patch
"
builddir="$srcdir/Horust-$pkgver"

prepare() {
	default_prepare

	cargo fetch --target="$CTARGET" --locked
}

build() {
	cargo auditable build --release --frozen
}

check() {
	# Add USER ENV for test_should_correctly_deserialize_sample test
	USER="$(whoami)" cargo test --frozen -- --skip test_termination_all_custom_signals
}

package() {
	install -Dm755 target/release/horust -t "$pkgdir"/usr/bin
	install -Dm0644 README.md -t "$pkgdir"/usr/share/doc/"$pkgname"
	install -Dm0644 docs/*.md -t "$pkgdir"/usr/share/doc/"$pkgname"/docs
	install -Dm0644 horust/example_services/* -t "$pkgdir"/usr/share/doc/"$pkgname"/example_services
}

sha512sums="
6f9bfb12a49385cdab1f3ff8bcbce7f8ec03fbfa59ec0b276afdbcc6ef8b671cc077509b81d0e546db2c4edfd9dc9533db116f88a45a31b4278d0e197bb03872  horust-0.1.11.tar.gz
341cfedcfad2f61d9aaecaa336d8937166bf153ad7be80582f1b1f35e05464159a88c42934f8eaac622e0710e110e19c6abed3072793fd295365f8010af1aa20  test_multiple-increase-timeout.patch
"
