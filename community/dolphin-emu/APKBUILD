maintainer="Bart Ribbers <bribbers@disroot.org>"
pkgname=dolphin-emu
pkgver=2512
pkgrel=0
_commit_cpp_ipc="ce0773b3e6d5abaa8d104100c5704321113853ca"
_commit_cpp_optparse="2265d647232249a53a03b411099863ceca35f0d3"
_commit_cubeb="54217bca3f3e0cd53c073690a23dd25d83557909"
_commit_gtest="eb2d85edd0bff7a712b6aff147cd9f789f0d7d0b"
_commit_imgui="45acd5e0e82f4c954432533ae9985ff0e1aad6d5"
_commit_implot="3da8bd34299965d3b0ab124df743fe3e076fa222"
_commit_mgba="0b40863f64d0940f333fa1c638e75f86f8a26a33"
_commit_minizip_ng="55db144e03027b43263e5ebcb599bf0878ba58de"
_commit_rcheevos="b443902b1cdfee5a66b09fec20a94d2d2afaf2ec"
_commit_sfml="016bea9491ccafc3529019fe1d403885a8b3a6ae"
_commit_spirv="ebe2aa0cd80f5eb5cd8a605da604cacf72205f3b"
_commit_tinygltf="c5641f2c22d117da7971504591a8f6a41ece488b"
_commit_vulkan_memory="3bab6924988e5f19bf36586a496156cf72f70d9f"
_commit_watcher="b03bdcfc11549df595b77239cefe2643943a3e2f"
_commit_zlib="ce01b1e41da298334f8214389cc9369540a7560f"
 # Upstream doesn't actively support non 64-bit platforms and they're too slow
 # to emulate any games anyway
arch="x86_64 aarch64 riscv64"
url="https://dolphin-emu.org"
pkgdesc="Gamecube / Wii emulator"
license="GPL-2.0-or-later"
makedepends="
	bluez-dev
	cmake
	curl-dev
	enet-dev
	eudev-dev
	ffmpeg-dev
	fmt-dev
	git
	glslang-dev
	gtest-dev
	hidapi-dev
	libevdev-dev
	libpng-dev
	libspng-dev
	libusb-dev
	libx11-dev
	libxi-dev
	libxrandr-dev
	lz4-dev
	lzo-dev
	mesa-dev
	mbedtls2-dev
	miniupnpc-dev
	ninja
	pugixml-dev
	pulseaudio-dev
	qt6-qtbase-dev
	qt6-qtbase-private-dev
	qt6-qtsvg-dev
	sdl3-dev
	sfml-dev
	spirv-tools-dev
	vulkan-headers
	vulkan-loader-dev
	xxhash-dev
	xz-dev
	zlib-dev
	zstd-dev
	"
subpackages="
	$pkgname-udev
	$pkgname-doc
	$pkgname-lang
	"
# The following dependencies are required, but atm not supported for using system wide libraries
# minizip-dev soundtouch-dev gtest-dev
source="$pkgname-$pkgver.tar.gz::https://github.com/dolphin-emu/dolphin/archive/refs/tags/$pkgver.tar.gz
	https://github.com/mutouyun/cpp-ipc/archive/$_commit_cpp_ipc/cpp-ipc-$_commit_cpp_ipc.tar.gz
	https://github.com/weisslj/cpp-optparse/archive/$_commit_cpp_optparse/cpp-optparse-$_commit_cpp_optparse.tar.gz
	https://github.com/mozilla/cubeb/archive/$_commit_cubeb/cubeb-$_commit_cubeb.tar.gz
	https://github.com/syoyo/tinygltf/archive/$_commit_tinygltf/tinygltf-$_commit_tinygltf.tar.gz
	https://github.com/google/googletest/archive/$_commit_gtest/googletest-$_commit_gtest.tar.gz
	https://github.com/ocornut/imgui/archive/$_commit_imgui/imgui-$_commit_imgui.tar.gz
	https://github.com/epezent/implot/archive/$_commit_implot/implot-$_commit_implot.tar.gz
	https://github.com/mgba-emu/mgba/archive/$_commit_mgba/mgba-$_commit_mgba.tar.gz
	https://github.com/SFML/SFML/archive/$_commit_sfml/SFML-$_commit_sfml.tar.gz
	https://github.com/zlib-ng/minizip-ng/archive/$_commit_minizip_ng/minizip-ng-$_commit_minizip_ng.tar.gz
	https://github.com/RetroAchievements/rcheevos/archive/$_commit_rcheevos/rcheevos-$_commit_rcheevos.tar.gz
	https://github.com/KhronosGroup/SPIRV-Cross/archive/$_commit_spirv/spirv-cross-$_commit_spirv.tar.gz
	https://github.com/GPUOpen-LibrariesAndSDKs/VulkanMemoryAllocator/archive/$_commit_vulkan_memory/VulkanMemoryAllocator-$_commit_vulkan_memory.tar.gz
	https://github.com/e-dant/watcher/archive/$_commit_watcher/watcher-$_commit_watcher.tar.gz
	https://github.com/zlib-ng/zlib-ng/archive/$_commit_zlib/zlib-ng-$_commit_zlib.tar.gz
	"
builddir="$srcdir/dolphin-$pkgver"

prepare() {
	default_prepare

	git init -q

	rmdir Externals/mGBA/mgba
	mv "$srcdir"/mgba-$_commit_mgba Externals/mGBA/mgba

	rmdir Externals/spirv_cross/SPIRV-Cross
	mv "$srcdir"/SPIRV-Cross-$_commit_spirv Externals/spirv_cross/SPIRV-Cross

	rmdir Externals/tinygltf/tinygltf
	mv "$srcdir"/tinygltf-$_commit_tinygltf Externals/tinygltf/tinygltf

	rmdir Externals/zlib-ng/zlib-ng
	mv "$srcdir"/zlib-ng-$_commit_zlib Externals/zlib-ng/zlib-ng

	rmdir Externals/cpp-ipc/cpp-ipc
	mv "$srcdir"/cpp-ipc-$_commit_cpp_ipc Externals/cpp-ipc/cpp-ipc

	rmdir Externals/cpp-optparse/cpp-optparse
	mv "$srcdir"/cpp-optparse-$_commit_cpp_optparse Externals/cpp-optparse/cpp-optparse

	rmdir Externals/cubeb/cubeb
	mv "$srcdir"/cubeb-$_commit_cubeb Externals/cubeb/cubeb

	rmdir Externals/gtest
	mv "$srcdir"/googletest-$_commit_gtest Externals/gtest

	rmdir Externals/imgui/imgui
	mv "$srcdir"/imgui-$_commit_imgui Externals/imgui/imgui

	rmdir Externals/rcheevos/rcheevos
	mv "$srcdir"/rcheevos-$_commit_rcheevos Externals/rcheevos/rcheevos

	rmdir Externals/SFML/SFML
	mv "$srcdir"/SFML-$_commit_sfml Externals/SFML/SFML

	rmdir Externals/implot/implot
	mv "$srcdir"/implot-$_commit_implot Externals/implot/implot

	rmdir Externals/VulkanMemoryAllocator
	mv "$srcdir"/VulkanMemoryAllocator-$_commit_vulkan_memory Externals/VulkanMemoryAllocator

	rmdir Externals/minizip-ng/minizip-ng
	mv "$srcdir"/minizip-ng-$_commit_minizip_ng Externals/minizip-ng/minizip-ng

	rmdir Externals/watcher/watcher
	mv "$srcdir"/watcher-$_commit_watcher Externals/watcher/watcher

	# Make sure we never use non-system libraries except the ones that are not
	# supported being used system-wide by removing them from the Externals
	# folder
	KEEP_SOURCES="
		Bochs_disasm
		FatFs
		FreeSurround
		SFML
		VulkanMemoryAllocator
		cpp-ipc
		cpp-optparse
		cubeb
		expr
		glslang
		gtest
		imgui
		implot
		mGBA
		minizip-ng
		picojson
		rangeset
		rcheevos
		spirv_cross
		tinygltf
		watcher
		zlib-ng
		"

	# Move the libraries we want to keep out of the externals folder
	for s in $KEEP_SOURCES; do
		mv -v "Externals/$s" .
	done

	# Remove the rest
	rm -r Externals/*

	# Move them back
	for s in $KEEP_SOURCES; do
		mv -v "$s" "Externals/"
	done
}

build() {
	# Enable a generic build for riscv64
	# This enables building for the architecture but disables JIT and is thus slow
	# TODO: see if support for riscv64 has been enabled upstream and disable the generic build
	case "$CARCH" in
		riscv64) _generic=ON ;;
		*) _generic=OFF ;;
	esac

	# analytics is opt-in, a pop up box at first launch, thus fine
	CFLAGS="$CFLAGS -O2" \
	CXXFLAGS="$CXXFLAGS -O2" \
	cmake3.5 -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DENABLE_LLVM=OFF \
		-DENABLE_GENERIC=$_generic \
		-DDISTRIBUTOR="alpinelinux.org" \
		-DUSE_DISCORD_PRESENCE=OFF \
		-DENABLE_AUTOUPDATE=OFF \
		-DENABLE_ANALYTICS=ON \
		-DUSE_SANITIZERS=OFF \
		-DWITH_SANITIZER=OFF \
		-DUSE_SYSTEM_FMT=ON
	cmake --build build
}

check() {
	cd build
	ctest
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	install -Dm 644 Data/51-usb-device.rules -t "$pkgdir"/usr/lib/udev/rules.d/
}

sha512sums="
31c3a2f3720460ab3f21747ffba41f3ceb21083b7416d30720904b34fbc195e87bc9fe9f4a3bf7dd4e6a194f026d7e84de088d9e17f82f67a62cc4d5eb0b8a22  dolphin-emu-2512.tar.gz
3cfbb566d153106e2b148d89d79ffcd0a7f73a24455ecb2c346c4b30cb302d7cfc4a8aec196cfab804fe6fb8bebad6afadf6d23a7b25b95d4b2c8d92dda3bfab  cpp-ipc-ce0773b3e6d5abaa8d104100c5704321113853ca.tar.gz
6b99478738980df3186b8487a33c96ee80107ed35fdd36cf615a53f58e9b1e72ab6099c2081e3622fa374f338609e747a1aa0c6c1295f2f71dea1ed17dbc6cf2  cpp-optparse-2265d647232249a53a03b411099863ceca35f0d3.tar.gz
7ba1cd5b74d49512d2ebf9b07889ee3ad46559afe3293bcbebae0613661f7502f0baaa20b6723738c21b2d71f9d8f72ed1252703533507dec5d2b5ad84784017  cubeb-54217bca3f3e0cd53c073690a23dd25d83557909.tar.gz
486bcf32be137dea5746117074dc51bc978290698de7831e1c4bbaa4acb56ed99fc34c38e69878a955b3e5f10f43eab07b0637164f822beae0fddd099aa0c56d  tinygltf-c5641f2c22d117da7971504591a8f6a41ece488b.tar.gz
4ee7cce375589e1411bf41aa1dc840a7cf9b77105e5e69cde6ae750ec1d0911d72ae960c374331db2beacb14fc8d889ab555c4548efcd45167cedfd574816aa5  googletest-eb2d85edd0bff7a712b6aff147cd9f789f0d7d0b.tar.gz
76fd04305cb48cf6bfa5c5dc884738137bd5c08f2ce12dfd77c1fc9b9294e6c592739d3ec4ceab7d65226775c3be5076710b58bcc40b8abed7da3620db3be511  imgui-45acd5e0e82f4c954432533ae9985ff0e1aad6d5.tar.gz
8a95f76ae4a14adf6f3bcd798d2334d8282ff7b50fc7def6308c0556adcc1dbd151c0a36aa676a82e10e1ae80d1ecc1ac54e705180650eed46d0a609611c73c5  implot-3da8bd34299965d3b0ab124df743fe3e076fa222.tar.gz
101c7f3de728ca7888bfa3f322b2efba369461afc640f7c2004d3246acc53ca5577d8087b39713504e817c4a1673fbbca070460fc638eb3f73a0e3b4f42f5dde  mgba-0b40863f64d0940f333fa1c638e75f86f8a26a33.tar.gz
3b4846ccc5f699d0e1b5559a025c6e7bfaeb2313f2cda24c9a3daaab89d7caeaa55546e4115725f8a64f97db846a5bb9a4a9e10898164ed9dd239e7f1952902d  SFML-016bea9491ccafc3529019fe1d403885a8b3a6ae.tar.gz
88d1222886a3b5cd3ca1aff7b12902d1d19462c446ef39a092a56bb91b5889956afcce047b4227c79a50a95d9275bd0a23f5cd6cbef76478b6e21bbf86dd486b  minizip-ng-55db144e03027b43263e5ebcb599bf0878ba58de.tar.gz
f43677f75cbe1f4e3d5b1f7dfcbb71337b4c38cd772c34d8b8792be0a6c3dd41ed2798b09139421ca1722de525e9757ed4824729c21dad60ba4018b8ee773729  rcheevos-b443902b1cdfee5a66b09fec20a94d2d2afaf2ec.tar.gz
aa9d2bab9d7047382553b2b4f35cac87ec70b1f6399169c5e5b468e070a684bb9c1faa86f83a5b908aee0370936e4dcc4d7068e1a9917bbdb87040bef0ecd11c  spirv-cross-ebe2aa0cd80f5eb5cd8a605da604cacf72205f3b.tar.gz
6e2935ce6fbafc2cc8c5a34bf3eaa5dc2e8f65c97c886cfa57da0b45ca83bc8ade4429a7556ce6292af9aeb947d69231b50ae64a55a281c304176e8ea1cd2098  VulkanMemoryAllocator-3bab6924988e5f19bf36586a496156cf72f70d9f.tar.gz
b1e4bad6564b5036f4bf66ea269b148c9818d5e6fa4626a0f7d04e65b81be737a0fbcd995c103681297240e78e54d8152825c1b6674a45e8bbe0c35b9bf900d0  watcher-b03bdcfc11549df595b77239cefe2643943a3e2f.tar.gz
73f4e56410ae298ef211ebab52b1a0d3d5bfae91c2de3cd294b56cd0a78ab50e1203b396c7df462f360c1aaaa9392ec5625473d1e9eb084cc64bc813e28d12a1  zlib-ng-ce01b1e41da298334f8214389cc9369540a7560f.tar.gz
"
