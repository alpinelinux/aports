# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=gthumb
pkgver=3.12.8.1
pkgrel=1
pkgdesc="Image viewer and browser from GNOME"
url="https://gitlab.gnome.org/GNOME/gthumb"
# optional libjxl, but nobody uses this on s390x
arch="all !s390x"
license="GPL-2.0-or-later"
depends="hicolor-icon-theme"
makedepends="
	bison
	clutter-gtk-dev
	colord-dev
	exiv2-dev
	flex
	gsettings-desktop-schemas-dev
	gst-plugins-base-dev
	gstreamer-dev
	gtk+3.0-dev
	itstool
	jpeg-dev
	json-glib-dev
	lcms2-dev
	libchamplain-dev
	libheif-dev
	libjxl-dev
	libpng-dev
	libraw-dev
	librsvg-dev
	libsecret-dev
	libsoup-dev
	meson
	webkit2gtk-4.1-dev
	"
provides="$pkgname-gstreamer=$pkgver-r$pkgrel"  # for backward compatibility (Alpine <3.23)
sonameprefix="$pkgname:"
# Ignore libcairo_io.so in automatically traced dependencies to avoid conflict
# between gthumb and gthumb-extra-formats (both provides this extension library).
somask="libcairo_io.so"
subpackages="
	$pkgname-dev
	$pkgname-doc
	$pkgname-lang
	$pkgname-extra-formats:extra_formats
	$pkgname-full
	"
source="https://gitlab.gnome.org/GNOME/gthumb/-/archive/$pkgver/gthumb-$pkgver.tar.gz
	time_t.patch
	"

# List of extensions splitted into subpackages.
_extensions="
	map-view:map_view
	raw-files:raw_files
	webalbums
	"
_depends_full="
	$pkgname=$pkgver-r$pkgrel
	$pkgname-extra-formats
	"
for _i in $_extensions; do
	subpackages="$subpackages $pkgname-$_i"
	_depends_full="$_depends_full $pkgname-${_i%:*}"
done

_extsdir='usr/lib/gthumb/extensions'

build() {
	msg 'Building full variant'
	_build output true

	msg 'Building smaller variant'
	_build output-small false
}

_build() {
	local outdir=$1
	local toggle=$2

	# When built with gstreamer, /usr/bin/gthumb is linked with
	# libgstreamer-1.0.so.0, so we cannot simply split it into a subpackage
	# (see !85657).
	abuild-meson \
		-Dwarn-deprecated=false \
		-Dclutter=false \
		-Dgstreamer=true \
		-Dlibchamplain=true \
		-Dlcms2=true \
		-Dcolord=true \
		-Dlibtiff=false \
		-Dlibwebp=false \
		-Dlibjxl=$toggle \
		-Dlibheif=$toggle \
		-Dlibraw=true \
		-Dlibrsvg=$toggle \
		-Dlibbrasero=false \
		. "$outdir"
	meson compile -C "$outdir"
}

check() {
	meson test --print-errorlogs -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output

	_rename "$pkgdir"/usr/lib/gthumb/extensions/libcairo_io.so libcairo_io.so.extra

	DESTDIR="$pkgdir" meson install --no-rebuild -C output-small

	cd "$pkgdir"

	# Keep only "C" (English) variant of help.
	mv usr/share/help/C .
	rm -rf usr/share/help/*
	mv C usr/share/help/
}

extra_formats() {
	pkgdesc="gThumb support for AVIF, HEIF, JPEG XL, and SVG image formats"
	depends="$pkgname=$pkgver-r$pkgrel"
	replaces="$pkgname"  # libcairo_io.so

	amove $_extsdir/libcairo_io.so.extra
	_rename "$subpkgdir"/$_extsdir/libcairo_io.so.extra libcairo_io.so
}

map_view() {
	pkgdesc="gThumb extension for viewing the photo position on the map"
	depends="$pkgname=$pkgver-r$pkgrel"

	amove $_extsdir/map_view.extension
	amove $_extsdir/libmap_view.so
}

raw_files() {
	pkgdesc="gThumb extension for RAW format support"
	depends="$pkgname=$pkgver-r$pkgrel"

	amove $_extsdir/raw_files.extension
	amove $_extsdir/libraw_files.so
}

webalbums() {
	pkgdesc="gThumb extension for creating static webalbums"
	depends="$pkgname=$pkgver-r$pkgrel"

	amove $_extsdir/webalbums.extension
	amove $_extsdir/libwebalbums.so
	amove usr/share/gthumb/albumthemes
}

full() {
	pkgdesc="$pkgdesc (with all built-in extensions)"
	depends="$_depends_full"

	mkdir -p "$subpkgdir"
}

_rename() {
	mv "$1" "${1%/*}/$2"
}

sha512sums="
7c53d1ecf2397af8226cfa508844943b93b49353a59b348695dceff7cffc802f04445f09e0f06cb50dbfc782b59eca665d4aed2aa048b32dc3c5805a9902aac2  gthumb-3.12.8.1.tar.gz
fead72fb5735c9b6f14a35a1ac74f1649b6be910c1862ba7828ef8f4e6beeb2706d372e5e98fccbaa9d49359292c0ed6f3880afb60a6a948948769275fd12036  time_t.patch
"
