# Contributor: Valery Kartel <valery.kartel@gmail.com>
# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Valery Kartel <valery.kartel@gmail.com>

# Bundled libraries
#
# Name      | License | Location               | State
# ----------+---------+------------------------+---------
# bcmath    | LGPL2   | ext/bcmath/libbcmath   | used
# date      | MIT     | ext/date/lib           | used
# gd        | BSD     | ext/gd/libgd           | used
# file      | BSD     | ext/fileinfo/libmagic  | used
# libmbfl   | LGPLv2  | ext/mbstring/libmbfl   | used
# oniguruma | BSD     | ext/mbstring/oniguruma | used
# pcre      | BSD     | ext/pcre/pcrelib       | not used
# sqlite3   | Public  | ext/sqlite3/libsqlite  | not used
# libzip    | BSD     | ext/zip/lib            | not used
# libXMLRPC | BSD     | ext/xmlrpc/libxmlrpc   | used

pkgname=php7
_pkgreal=php
pkgver=7.1.4
pkgrel=0
_suffix=${pkgname#php}
pkgdesc="The PHP$_suffix language runtime engine"
url="http://www.php.net/"
arch="all"
license="PHP-3 BSD LGPL2 MIT Zend"
options=""
depends="$pkgname-common"
depends_mysqlnd="$pkgname-openssl"
# openssl is actually transitive dependency here, but we need to because of
# load index based on number of dependencies.
depends_mysqli="$pkgname-mysqlnd $pkgname-openssl"
depends_pdo_mysql="$pkgname-pdo $pkgname-mysqlnd"
depends_phar="$pkgname"
makedepends="autoconf bison re2c apache2-dev libxml2-dev libxslt-dev libzip-dev bzip2-dev zlib-dev
	aspell-dev enchant-dev pcre-dev curl-dev gmp-dev icu-dev imap-dev
	libical-dev libressl-dev openldap-dev net-snmp-dev db-dev krb5-dev gdbm-dev sqlite-dev
	freetds-dev postgresql-dev unixodbc-dev freetype-dev tidyhtml-dev libxpm-dev
	libpng-dev libwebp-dev libjpeg-turbo-dev libmcrypt-dev recode-dev libedit-dev gettext-dev
	"
source="http://php.net/distributions/$_pkgreal-$pkgver.tar.bz2
	$pkgname-fpm.initd
	$pkgname-fpm.logrotate
	$pkgname-module.conf
	install-pear.patch
	includedir.patch
	fix-asm-constraints-in-aarch64-multiply-macro.patch
	php7-fpm-version-suffix.patch
	allow-build-recode-and-imap-together.patch
	"
builddir="$srcdir/$_pkgreal-$pkgver"

_libdir="/usr/lib/$pkgname"
_extension_dir="$_libdir/modules"
_extension_confd="/etc/$pkgname/conf.d"

_exts="bcmath bz2 calendar ctype curl dba dom enchant exif fileinfo ftp gd gettext gmp iconv imap intl json
	ldap mbstring mcrypt mysqli mysqlnd odbc opcache openssl pcntl pdo pdo_dblib pdo_mysql
	pdo_odbc pdo_pgsql pdo_sqlite pgsql phar posix pspell recode session shmop simplexml snmp soap
	sockets sqlite3 sysvmsg sysvsem sysvshm tidy tokenizer wddx xml xmlreader xmlrpc xmlwriter xsl zip zlib
	"
subpackages="$pkgname-dev $pkgname-doc $pkgname-apache2 $pkgname-phpdbg $pkgname-embed
	$pkgname-litespeed $pkgname-cgi $pkgname-fpm $pkgname-pear::noarch
	"
for _ext in $_exts; do
	case "$_ext" in
	phar) subpackages="$subpackages $pkgname-$_ext:$_ext";;
	*) subpackages="$subpackages $pkgname-$_ext:_package_ext";;
	esac
done
subpackages="$subpackages $pkgname-common::noarch"

_apiver="20160303"

prepare() {
	cd "$builddir"

	default_prepare || return 1
	update_config_sub || return 1

	local vapi=$(sed -n '/#define PHP_API_VERSION/{s/.* //;p}' main/php.h)
	if [ "$vapi" != "$_apiver" ]; then
		error "Upstreram API version is now $vapi. Expecting $_apiver"
		return 1
	fi

	# https://bugs.php.net/63362 - Not needed but installed headers.
	# Drop some Windows specific headers to avoid installation,
	# before build to ensure they are really not needed.
	rm -f TSRM/tsrm_win32.h \
		TSRM/tsrm_config.w32.h \
		Zend/zend_config.w32.h \
		ext/mysqlnd/config-win.h \
		ext/standard/winver.h \
		main/win32_internal_function_disabled.h \
		main/win95nt.h

	# Fix some bogus permissions.
	find . -name \*.[ch] -exec chmod 644 {} \;

	autoconf
}

# Notes:
# * gd-jis-conv breaks any non-latin font rendering (vakartel).
# * libxml cannot be build as shared.
# * Doesn't work with system-provided onigurama, some tests fail (invalid code
#   point); probably because bundled onigurama is version 5.x, but we have 6.x.
_build() {
	[ "$CARCH" = "s390x" ] && _disable_pcre_jit="--without-pcre-jit"

	EXTENSION_DIR=$_extension_dir ./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--program-suffix=$_suffix \
		--libdir=$_libdir \
		--datadir=/usr/share/$pkgname \
		--sysconfdir=/etc/$pkgname \
		--localstatedir=/var \
		--with-layout=GNU \
		--with-pic \
		--with-pear=/usr/share/$pkgname \
		--with-config-file-path=/etc/$pkgname \
		--with-config-file-scan-dir=$_extension_confd \
		--disable-short-tags \
		--with-openssl=shared --with-kerberos --with-system-ciphers \
		--with-pcre-regex=/usr --with-pcre-dir=/usr \
		$_disable_pcre_jit \
		--with-zlib=shared --with-zlib-dir=/usr \
		--enable-bcmath=shared \
		--with-bz2=shared \
		--enable-calendar=shared \
		--enable-ctype=shared \
		--with-curl=shared \
		--enable-dba=shared --with-gdbm --with-db4 \
		--enable-dom=shared \
		--with-enchant=shared \
		--enable-exif=shared \
		--enable-fileinfo=shared \
		--enable-ftp=shared \
		--with-gd=shared --with-webp-dir=/usr --with-jpeg-dir=/usr --with-png-dir=/usr --with-xpm-dir=/usr \
		--with-freetype-dir=/usr --enable-gd-native-ttf --disable-gd-jis-conv \
		--with-gettext=shared \
		--with-gmp=shared \
		--with-iconv=shared \
		--with-imap=shared --with-imap-ssl \
		--enable-intl=shared --with-icu-dir=/usr \
		--enable-json=shared \
		--enable-libxml --with-libxml-dir=/usr \
		--with-ldap=shared --with-ldap-sasl \
		--enable-mbstring=shared \
		--with-mcrypt=shared \
		--with-sqlite3=shared,/usr --with-pdo-sqlite=shared,/usr \
		--with-pdo-dblib=shared \
		--with-mysqli=shared,mysqlnd \
		--enable-mysqlnd=shared --with-pdo-mysql=shared,mysqlnd --with-mysql-sock=/run/mysqld/mysqld.sock \
		--with-pgsql=shared --with-pdo-pgsql=shared \
		--with-unixODBC=shared,/usr --with-pdo-odbc=shared,unixODBC,/usr \
		--with-dbmaker=shared \
		--enable-opcache=shared \
		--enable-pdo=shared \
		--enable-pcntl=shared \
		--enable-posix=shared \
		--enable-phar=shared \
		--with-pspell=shared \
		--without-readline \
		--with-libedit \
		--with-recode=shared \
		--enable-session=shared \
		--enable-shmop=shared \
		--enable-simplexml=shared \
		--with-snmp=shared \
		--enable-soap=shared \
		--enable-sockets=shared \
		--enable-sysvmsg=shared \
		--enable-sysvsem=shared \
		--enable-sysvshm=shared \
		--with-tidy=shared \
		--enable-tokenizer=shared \
		--enable-xml=shared \
		--enable-xmlreader=shared \
		--with-xmlrpc=shared \
		--enable-xmlwriter=shared \
		--with-xsl=shared \
		--enable-wddx=shared \
		--enable-zip=shared --with-libzip=/usr \
		$@ || return 1
	make || return 1
}

build() {
	cd "$builddir"

	# phpdbg
	_build --enable-phpdbg \
		--enable-phpdbg \
		--enable-phpdbg-webhelper \
		--disable-cgi \
		--disable-cli \
		|| return 1
	# apache2 module
	_build --disable-phpdbg \
		--disable-cgi \
		--disable-cli \
		--with-apxs2 \
		|| return 1
	mv libs/libphp$_suffix.so sapi/apache2handler/mod_php$_suffix.so
	# cgi,cli,fpm,embed,litespeed
	_build --disable-phpdbg \
		--enable-fpm \
		--enable-embed \
		--with-litespeed \
		|| return 1
}

package() {
	cd "$builddir"

	make -j1 INSTALL_ROOT="$pkgdir" install || return 1

	install -Dm644 php.ini-production "$pkgdir"/etc/$pkgname/php.ini || return 1

	local file; for file in pear peardev pecl; do
		sed -i -e "s~/usr/bin/php~/usr/bin/php$_suffix~g" \
			-e "s~PHP=php~PHP=php$_suffix~" \
			"$pkgdir"/usr/bin/$file || return 1
	done

	find "$pkgdir" -name '.*' | xargs rm -rf || return 1
	rmdir "$pkgdir"/var/run
}

dev() {
	default_dev
	replaces="php-dev"
	depends="$depends $pkgname $pkgname-pear"

	mkdir -p "$subpkgdir"/usr/bin \
		"$subpkgdir"/$_libdir || return 1

	mv "$pkgdir"/usr/bin/php-config$_suffix \
		"$pkgdir"/usr/bin/phpize$_suffix \
		"$subpkgdir"/usr/bin/ || return 1

	mv "$pkgdir"/$_libdir/build \
		"$subpkgdir"/$_libdir/ || return 1

	ln -s phpize$_suffix "$subpkgdir"/usr/bin/phpize
	ln -s php-config$_suffix "$subpkgdir"/usr/bin/php-config
}

doc() {
	default_doc

	mkdir -p "$subpkgdir"/usr/share/doc/$pkgname

	local file
	for file in CODING_STANDARDS CREDITS EXTENSIONS INSTALL LICENSE NEWS README* UPGRADING*; do
		cp "$builddir"/$file "$subpkgdir"/usr/share/doc/$pkgname/ || return 1
	done
}

apache2() {
	pkgdesc="PHP Module for Apache2"
	depends="$pkgname-common apache2"

	install -D -m755 "$builddir"/sapi/apache2handler/mod_php$_suffix.so \
		"$subpkgdir"/usr/lib/apache2/mod_php$_suffix.so || return 1

	install -D -m644 "$srcdir"/php$_suffix-module.conf \
		"$subpkgdir"/etc/apache2/conf.d/php$_suffix-module.conf
}

phpdbg() {
	pkgdesc="Interactive PHP debugger"
	depends="$pkgname-common"

	install -Dm755 "$builddir"/sapi/phpdbg/phpdbg \
		"$subpkgdir"/usr/bin/phpdbg$_suffix
}

embed() {
	pkgdesc="PHP Embedded Library"
	depends="$pkgname-common"

	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libphp*.so "$subpkgdir"/usr/lib/
}

litespeed() {
	pkgdesc="PHP LiteSpeed SAPI"
	depends="$pkgname-common"

	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/lsphp "$subpkgdir"/usr/bin/lsphp$_suffix
}

cgi() {
	pkgdesc="PHP Common Gateway Interface"
	depends="$pkgname-common"

	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/php-cgi$_suffix "$subpkgdir"/usr/bin/
	ln -s php-cgi$_suffix "$subpkgdir"/usr/bin/php-cgi
}

fpm() {
	pkgdesc="PHP FastCGI Process Manager"
	depends="$pkgname-common"

	mv "$pkgdir"/var "$subpkgdir"/ || return 1

	mkdir -p "$subpkgdir"/etc/$pkgname \
		"$subpkgdir"/usr \
		"$subpkgdir"/var/lib \
		"$subpkgdir"/var/log/$pkgname

	mv "$pkgdir"/usr/share/$pkgname/fpm "$subpkgdir"/var/lib/$pkgname/ || return 1
	mv "$pkgdir"/usr/sbin "$subpkgdir"/usr/ || return 1
	mv "$pkgdir"/etc/$pkgname/php-fpm* "$subpkgdir"/etc/$pkgname/ || return 1

	local file; for file in php-fpm.conf php-fpm.d/www.conf; do
		mv "$subpkgdir"/etc/$pkgname/$file.default \
			"$subpkgdir"/etc/$pkgname/$file || return 1
	done

	install -D -m755 "$srcdir"/$pkgname-fpm.initd \
		"$subpkgdir"/etc/init.d/php-fpm$_suffix || return 1
	install -D -m644 "$srcdir"/$pkgname-fpm.logrotate \
		"$subpkgdir"/etc/logrotate.d/php-fpm$_suffix
}

pear() {
	pkgdesc="PHP Extension and Application Repository"
	depends="$pkgname $pkgname-xml"

	# pecl needs xml extension and since we build it as shared, it must be
	# explicitly declared to be loaded.
	sed -i 's/\$INCARG/& -d extension=xml.so/' \
		"$pkgdir"/usr/bin/pecl || return 1

	mkdir -p "$subpkgdir"/usr/bin \
		"$subpkgdir"/etc/$pkgname

	local file; for file in pecl pear peardev; do
		mv "$pkgdir"/usr/bin/$file "$subpkgdir"/usr/bin/$file$_suffix
	done
	mv "$pkgdir"/etc/$pkgname/pear.conf "$subpkgdir"/etc/$pkgname/ || return 1
	mv "$pkgdir"/usr/share "$subpkgdir"/usr/
}

common() {
	pkgdesc="$pkgdesc (common config)"
	depends=""

	mkdir -p "$subpkgdir"/usr
	mv "$pkgdir"/usr/lib "$subpkgdir"/usr/ || return 1
	mv "$pkgdir"/etc "$subpkgdir"/ || return 1

	mkdir -p "$subpkgdir"/$_extension_confd
}

phar() {
	_package_ext || return 1

	mkdir -p "$subpkgdir"/usr/bin

	mv "$pkgdir"/usr/bin/phar.phar \
		"$subpkgdir"/usr/bin/phar.phar$_suffix || return 1

	rm "$pkgdir"/usr/bin/phar
	ln -s phar.phar$_suffix "$subpkgdir"/usr/bin/phar$_suffix
}

_package_ext() {
	local extname="${subpkgname#$pkgname-}"
	local extdepends="$(eval "echo \$depends_$extname")"
	pkgdesc="PHP$_suffix extension: $extname"

	: ${extdepends:=$(_resolve_extension_deps "$extname")}
	depends="$depends $extdepends"

	# Compute prefix for extension config, so extension depending on other
	# extension(s) will be loaded later than those without dependencies.
	# This is flawed, but good enough for now.
	local index=$(echo "$extdepends" | wc -w)

	# extension prefix
	local prefix=
	[ "$extname" != "opcache" ] || prefix="zend_"

	mkdir -p "$subpkgdir"/$_extension_dir \
		"$subpkgdir"/$_extension_confd

	mv "$pkgdir"/$_extension_dir/$extname.so \
		"$subpkgdir"/$_extension_dir/ || return 1

	echo "${prefix}extension=$extname.so" \
		> "$subpkgdir"/$_extension_confd/$(printf %02d $index)_$extname.ini
}

# Resolves dependencies of the given extension name (without $pkgname- prefix)
# on other extensions in $_exts and prints them with $pkgname- prefix.
_resolve_extension_deps() {
	local name="$1"

	# We use config.w32 just because it's more accurate than config.m4.
	local config="$builddir/ext/$name/config.w32"
	[ -f "$config" ] || return 0

	cat "$config" \
		| sed -En "s/.*ADD_EXTENSION_DEP\('$name', ([^)]+)\).*/\1/p" \
		| tr -d "'," | tr ' ' '\n' \
		| sort -u \
		| while read dep; do
			if echo "$_exts" | grep -qw "$dep"; then
				echo "$pkgname-$dep"
			fi
		done
}

sha512sums="a1dd5ffd756176e6ba600dd850510033d0d6f07aff314de69fec0c42437e6a006449e3f4f98679146a2f2645caa65ea351e31a8e1da7c14cc5260856ad40eaff  php-7.1.4.tar.bz2
1c708de82d1086f272f484faf6cf6d087af7c31750cc2550b0b94ed723961b363f28a947b015b2dfc0765caea185a75f5d2c2f2b099c948b65c290924f606e4f  php7-fpm.initd
cacce7bf789467ff40647b7319e3760c6c587218720538516e8d400baa75651f72165c4e28056cd0c1dc89efecb4d00d0d7823bed80b29136262c825ce816691  php7-fpm.logrotate
fbf9a1572d37370ec0d126502e1d066e045a992484d8fc4f1e2ede330134c1a15f4029f29fa4daebd48eed78b045dc051ced69fbf1f11efc7ad81d884a639a99  php7-module.conf
f1177cbf6b1f44402f421c3d317aab1a2a40d0b1209c11519c1158df337c8945f3a313d689c939768584f3e4edbe52e8bd6103fb6777462326a9d94e8ab1f505  install-pear.patch
199aecdbd3b4035aabf5379c215f82412d3c98b79a1ee186944e7fe1f0ed6f40789ea30e2355149491de6be34fc66c5e486e2a79a7e41ab2ae18706ef3ffe79b  includedir.patch
d93d3fc015580cf5f75c6cbca4cd980e054b61e1068495da81a7e61f1af2c9ae14f09964c04928ad338142de78e4844aed885b1ad1865282072999fb045c8ad7  fix-asm-constraints-in-aarch64-multiply-macro.patch
a4c35446745ab0ac806de801f0651fc5d2c98cf60063c3c2d3963a84f1c71ef78e09b7650c08e7231be0fdb93c0c255de38894d7f0e4f4c5a190d17f1a6bc476  php7-fpm-version-suffix.patch
f8ecae241a90cbc3e98aa4deb3d5d35ef555f51380e29f4e182a8060dffeb84be74f030a14c6b452668471030d78964f52795ca74275db05543ccad20ef1f2cc  allow-build-recode-and-imap-together.patch"
