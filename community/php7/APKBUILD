# Contributor: Valery Kartel <valery.kartel@gmail.com>
# Maintainer: Valery Kartel <valery.kartel@gmail.com>
provides=php
pkgname=php7
pkgver=7.1.0
pkgrel=0
_apiver="20160303"
pkgdesc="The PHP language runtime engine - 7th branch"
url="http://www.php.net/"
arch="all"
license="PHP-3"
options=""
install="$pkgname-common.pre-upgrade $pkgname-common.pre-deinstall"
triggers="$pkgname-common.trigger=/usr/bin"
depends="$pkgname-common"
depends_dev="$pkgname-pear"
_depends_dom="$pkgname-xml"
_depends_imap="--"
_depends_mysqlnd="$pkgname-mysqli"
_depends_pdo_dblib="$pkgname-pdo"
_depends_pdo_mysql="$pkgname-pdo"
_depends_pdo_odbc="$pkgname-pdo"
_depends_pdo_pgsql="$pkgname-pdo"
_depends_pdo_sqlite="$pkgname-pdo"
_depends_soap="$pkgname-xml"
_depends_wddx="$pkgname-xml"
_depends_xmlrpc="$pkgname-xml"
_depends_xmlreader="$pkgname-dom $pkgname-xml"
_depends_xmlwriter="$pkgname-dom $pkgname-xml"
_depends_xsl="$pkgname-dom $pkgname-xml"
_prefix_opcache="zend_"
_pkgdesc_opcache="Zend OPcache"
makedepends="autoconf bison re2c apache2-dev libxml2-dev libxslt-dev libzip-dev bzip2-dev zlib-dev
	aspell-dev enchant-dev expat-dev pcre-dev curl-dev gmp-dev icu-dev imap-dev
	libical-dev libressl-dev openldap-dev net-snmp-dev db-dev krb5-dev gdbm-dev sqlite-dev
	freetds-dev mariadb-dev postgresql-dev unixodbc-dev freetype-dev tidyhtml-dev libxpm-dev
	libpng-dev libwebp-dev libjpeg-turbo-dev libmcrypt-dev gsoap-dev recode-dev
	libedit-dev gettext-dev
	"
source="http://php.net/distributions/php-$pkgver.tar.bz2
	$pkgname-fpm.initd
	$pkgname-fpm.logrotate
	$pkgname-module.conf
	fix-asm-constraints-in-aarch64-multiply-macro.patch
	install-pear.patch
	includedir.patch
	php-fpm.patch
	"
# unimplemented extensions: com_dotnet interbase oci8 pdo_firebird pdo_oci
_extensions="bcmath bz2 calendar ctype curl dba dom enchant exif ftp gd gettext gmp iconv imap intl json
	ldap mbstring mcrypt mysqli mysqlnd odbc opcache openssl pcntl pdo pdo_dblib pdo_mysql
	pdo_odbc pdo_pgsql pdo_sqlite pgsql phar posix pspell recode session shmop snmp soap
	sockets sqlite3 sysvmsg sysvsem sysvshm tidy wddx xml xmlreader xmlrpc xmlwriter xsl zip zlib
	"
for _extension in $_extensions; do
	subpackages="$subpackages $pkgname-$_extension:_extension"
done
subpackages="$pkgname-dev $pkgname-doc $subpackages $pkgname-apache2 $pkgname-phpdbg $pkgname-embed
	$pkgname-litespeed $pkgname-cgi $pkgname-fpm $pkgname-pear::noarch $pkgname-common::noarch"
builddir="$srcdir"/php-$pkgver

prepare() {
	cd "$builddir"
	default_prepare || return 1
	update_config_sub || return 1
	local vapi=$(sed -n '/#define PHP_API_VERSION/{s/.* //;p}' main/php.h)
	if [ "$vapi" != "$_apiver" ]; then
		error "Upstreram API version is now $vapi. Expecting $_apiver"
		return 1
	fi
	autoconf
}

_build() {
	export EXTENSION_DIR=/usr/lib/$pkgname/modules
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--libdir=/usr/lib/$pkgname \
		--datadir=/usr/share/$pkgname \
		--sysconfdir=/etc/$pkgname \
		--localstatedir=/var \
		--with-layout=GNU \
		--with-pic \
		--with-pear=/usr/share/php \
		--with-config-file-path=/etc/$pkgname \
		--with-config-file-scan-dir=/etc/$pkgname/conf.d \
		--disable-rpath \
		--disable-short-tags \
		--with-openssl=shared --with-kerberos --with-system-ciphers \
		--with-pcre-regex --with-pcre-dir \
		--with-zlib=shared --with-zlib-dir \
		--enable-bcmath=shared \
		--with-bz2=shared \
		--enable-calendar=shared \
		--enable-ctype=shared \
		--with-curl=shared \
		--enable-dba=shared --with-gdbm --with-db4 \
		--enable-dom=shared \
		--with-enchant=shared \
		--enable-exif=shared \
		--enable-ftp=shared \
		--with-gd=shared --with-webp-dir=shared --with-jpeg-dir=shared --with-png-dir=shared --with-xpm-dir=shared \
		--with-freetype-dir=shared --enable-gd-native-ttf --enable-gd-jis-conv \
		--with-gettext=shared \
		--with-gmp=shared \
		--with-iconv=shared \
		--enable-intl=shared --with-icu-dir=/usr \
		--enable-json=shared \
		--enable-libxml=shared --with-libxml-dir=shared --with-libexpat-dir=shared \
		--with-ldap=shared --with-ldap-sasl \
		--enable-mbstring=shared --enable-mbregex \
		--with-mcrypt=shared \
		--with-sqlite3=shared,/usr --with-pdo-sqlite=shared,/usr \
		--with-pdo-dblib=shared \
		--with-mysqli=shared,/usr/bin/mysql_config \
		--enable-mysqlnd=shared --with-pdo-mysql=shared,/usr/bin/mysql_config --with-mysql-sock=/run/mysqld/mysqld.sock \
		--with-pgsql=shared --with-pdo-pgsql=shared \
		--with-unixODBC=shared,/usr -with-pdo-odbc=shared,unixODBC,/usr \
		--with-dbmaker=shared \
		--enable-opcache=shared \
		--enable-pdo=shared \
		--enable-pcntl=shared \
		--enable-posix=shared \
		--enable-phar=shared \
		--with-pspell=shared \
		--enable-session=shared \
		--enable-shmop=shared \
		--with-snmp=shared \
		--enable-soap=shared \
		--enable-sockets=shared \
		--enable-sysvmsg=shared \
		--enable-sysvsem=shared \
		--enable-sysvshm=shared \
		--with-tidy=shared \
		--enable-xml=shared \
		--enable-xmlreader=shared \
		--enable-xmlwriter=shared \
		--with-xmlrpc=shared \
		--with-xsl=shared \
		--enable-wddx=shared \
		--enable-zip=shared --with-libzip=shared \
		--with-libedit \
		$@ || return 1
	sed -ri "s/^(EXTRA_LDFLAGS[ ]*\=.*)/\1 -lpthread/" Makefile
	make || return 1
}

build() {
	cd "$builddir"
	# build phpdbg
	_build --enable-phpdbg \
		--enable-phpdbg-webhelper \
		--disable-cgi \
		--disable-cli \
		|| return 1
	# build apache2 module + recode extension
	_build --disable-phpdbg \
		--disable-cgi \
		--disable-cli \
		--with-apxs2 \
		--with-recode=shared \
		|| return 1
	mv libs/lib$pkgname.so sapi/apache2handler/
	# build all other
	_build --disable-phpdbg \
		--enable-fpm \
		--enable-embed \
		--with-litespeed \
		--with-imap=shared --with-imap-ssl \
		|| return 1
}

package() {
	cd "$builddir"
	make -j1 INSTALL_ROOT="$pkgdir" install || return 1
	rm -fr "$pkgdir"/.[[:alpha:]]* "$pkgdir"/var || return 1
	mv "$pkgdir"/usr/share/man/man1/php.1 \
		"$pkgdir"/usr/share/man/man1/$pkgname.1
	mv "$pkgdir"/usr/share/man/man1/php-cgi.1 \
		"$pkgdir"/usr/share/man/man1/$pkgname-cgi.1
	mv "$pkgdir"/usr/share/man/man8/php-fpm.8 \
		"$pkgdir"/usr/share/man/man8/$pkgname-fpm.8
	mv "$pkgdir"/usr/bin/php "$pkgdir"/usr/bin/$pkgname
}

dev() {
	default_dev
	replaces="php5-dev"
	depends="$depends $pkgname-phar"
	mv "$pkgdir"/usr/bin/phpize "$subpkgdir"/usr/bin/${pkgname}ize
	mv "$subpkgdir"/usr/bin/php-config "$subpkgdir"/usr/bin/$pkgname-config
	mv "$pkgdir"/usr/bin/peardev "$pkgdir"/usr/bin/phar* \
		"$subpkgdir"/usr/bin/
	mv "$pkgdir"/usr/lib/$pkgname/build "$subpkgdir"/usr/lib/$pkgname/
	# for compatibility with current builds
	ln -sf /usr/bin/${pkgname}ize "$subpkgdir"/usr/bin/phpize7
	ln -sf /usr/bin/$pkgname-config "$subpkgdir"/usr/bin/php-config7
}

doc() {
	default_doc
	install_if="docs $pkgname-common=$pkgver-r$pkgrel"
	cd "$builddir"
	for file in $(ls CODING_STANDARDS CREDITS EXTENSIONS INSTALL LICENSE NEWS README* UPGRADING*); do
		install -Dm644 $file "$subpkgdir"/usr/share/doc/$pkgname/$file || return 1
	done
}

apache2() {
	provides="php-apache2"
	pkgdesc="$pkgname module for Apache2"
	depends="$pkgname-common apache2"
	install -Dm755 "$builddir"/sapi/apache2handler/lib$pkgname.so \
		"$subpkgdir"/usr/lib/apache2/lib$pkgname.so || return 1
	install -Dm644 "$srcdir"/$pkgname-module.conf \
		"$subpkgdir"/etc/apache2/conf.d/$pkgname-module.conf
}

phpdbg() {
	provides="php-phpdbg"
	pkgdesc="$pkgname interactive debugger"
	depends="$pkgname-common"
	install -Dm755 "$builddir"/sapi/phpdbg/phpdbg \
		 "$subpkgdir"/usr/bin/${pkgname}dbg
}

embed() {
	provides="php-embed"
	pkgdesc="$pkgname embedded library"
	depends="$pkgname-common"
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/lib$pkgname.so "$subpkgdir"/usr/lib/
}

litespeed() {
	provides="php-litespeed"
	pkgdesc="$pkgname litespeed SAPI"
	depends="$pkgname-common"
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/lsphp "$subpkgdir"/usr/bin/ls$pkgname
}

cgi() {
	provides="php-cgi"
	pkgdesc="$pkgname common gateway interface"
	depends="$pkgname-common"
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/php-cgi "$subpkgdir"/usr/bin/$pkgname-cgi
}

fpm() {
	provides="php-fpm"
	pkgdesc="$pkgname FastCGI process manager"
	depends="$pkgname-common"
	mkdir -p "$subpkgdir"/etc/$pkgname \
		"$subpkgdir"/usr/share/$pkgname \
		"$subpkgdir"/var/log/$pkgname
	mv "$pkgdir"/usr/share/$pkgname/fpm "$subpkgdir"/usr/share/$pkgname || return 1
	mv "$pkgdir"/usr/sbin "$subpkgdir"/usr/
	mv "$subpkgdir"/usr/sbin/php-fpm "$subpkgdir"/usr/sbin/$pkgname-fpm || return 1
	mv "$pkgdir"/etc/$pkgname/php-fpm* "$subpkgdir"/etc/$pkgname/ || return 1
	find "$subpkgdir"/etc/$pkgname -name *.default -exec sh -c 'f={}; mv $f ${f%.default}' \;
	install -D -m755 "$srcdir"/$pkgname-fpm.initd "$subpkgdir"/etc/init.d/$pkgname-fpm
	install -D -m644 "$srcdir"/$pkgname-fpm.logrotate "$subpkgdir"/etc/logrotate.d/$pkgname-fpm
}

pear() {
	replaces="php5-pear"
	provides="php-pear"
	pkgdesc="$pkgname extension and application repository"
	depends="$pkgname $pkgname-xml"
	mkdir -p "$subpkgdir"/usr/bin "$subpkgdir"/etc/$pkgname
	mv "$pkgdir"/usr/bin/pecl "$pkgdir"/usr/bin/pear "$subpkgdir"/usr/bin/
	mv "$pkgdir"/etc/$pkgname/pear.conf "$subpkgdir"/etc/$pkgname/ || return 1
	mv "$pkgdir"/usr/share "$subpkgdir"/usr/
	rmdir "$subpkgdir"/usr/share/$pkgname || return 1
}

common() {
	pkgdesc="$pkgname common config"
	depends=
	install -Dm644 "$builddir"/php.ini-production \
		"$subpkgdir"/etc/$pkgname/php.ini || return 1
	# exit with an error if there is any configs
	# or if some modules were not in subpackages
	rmdir "$pkgdir"/usr/lib/$pkgname/modules \
		"$pkgdir"/etc/$pkgname || return 1
	rm -fr "$pkgdir"/etc "$pkgdir"/usr/lib
}

_extension() {
	local extname=${subpkgname#*-}
	provides="php-$extname"
	pkgdesc=$(eval echo \$_pkgdesc_$extname)
	[ ! "$pkgdesc" ] && pkgdesc=$(head -n1 "$builddir"/ext/$extname/CREDITS)
	pkgdesc="$pkgname extension: $pkgdesc"
	depends=$(eval echo \$_depends_$extname)
	local index=$(echo $depends | wc -w)
	depends="${depends%--*}"
	mkdir -p "$subpkgdir"/usr/lib/$pkgname/modules \
		"$subpkgdir"/etc/$pkgname/conf.d
	mv "$pkgdir"/usr/lib/$pkgname/modules/$extname.so \
		"$subpkgdir"/usr/lib/$pkgname/modules/ || return 1
	echo $(eval echo \$_prefix_$extname)extension=$extname.so >\
		"$subpkgdir"/etc/$pkgname/conf.d/$(printf %02d $index)_${extname}.ini
}

md5sums="54e364b60a88db77adb96aacb10f10a4  php-7.1.0.tar.bz2
2046fed9c4d2d8c53bd18e4c7e728e67  php7-fpm.initd
6085eb7854c192b6a533bb18eeaebe2f  php7-fpm.logrotate
3cea5c5334508dfc43591cd5bb1483c6  php7-module.conf
fa807a684fa853720b7523eb99869b34  fix-asm-constraints-in-aarch64-multiply-macro.patch
483bc0a85c50a9a9aedbe14a19ed4526  install-pear.patch
d872e633c9b33c3c9f629dd2edd2e5c5  includedir.patch
edb29ea13fab52e50d3ee305e3f38060  php-fpm.patch"
sha256sums="68bcfd7deed5b3474d81dec9f74d122058327e2bed0ac25bbc9ec70995228e61  php-7.1.0.tar.bz2
84bd361b3d9ee3aab3fd12dded3a6aa47665cdf5bff46be1bb3c169e72114106  php7-fpm.initd
bcd2f0a5caed573e4ac31a0dea6a7cd2584cdb9943f8a390b80ed900180dbb2a  php7-fpm.logrotate
dc73bb3a3bca94cdf070338ecfed85940548eda978e9392a711226ba62c1ce60  php7-module.conf
86f4186699f0bc61ce91986fe5efdd7b0da77ff9568c10ba52ca1094da94ed6e  fix-asm-constraints-in-aarch64-multiply-macro.patch
f739ca427a1dd53a388bad0823565299c5d4a5796b1171b892884e4d7d099bab  install-pear.patch
ea74966a23b1b54548ee35e9ccc2fc8d2b7c2285c385c44d6b23d9e2f25ea1a7  includedir.patch
60ced777af95bd0110c71a3d00a3169fd4b1e599560028e799c45599cc14c2a6  php-fpm.patch"
sha512sums="94c051abd19dbdf3d016f068269b5c6d667938def4df1732f7826a0ab2dd1fa541ff838dafc1531e1c4fa790df0b07feaef97512b28dda3e4ce5e724ede89b37  php-7.1.0.tar.bz2
a995a8af69ac353839015512afdcdb6eb9b062b925549f724451a4ba5f8ad4487f339de1c79bbee64e6dee8bfb28ce1ffae47d13d2628c8c980c316300026227  php7-fpm.initd
da404e9d7bb7af484351b6c9d2a2e8f1eff8d44704da3d877bc6af11c638e0a1f7225ea5ac381cada316876dfaaa81254c87fe3867849fb898478f459fdc367b  php7-fpm.logrotate
ebfa4365c88c745fb27d9271d66daabeaecb26ce31e01716d42c187a0afd06e22e815a66e2aafb29e1e88a23248e3b4182928033294928985c9b8362174738c8  php7-module.conf
d93d3fc015580cf5f75c6cbca4cd980e054b61e1068495da81a7e61f1af2c9ae14f09964c04928ad338142de78e4844aed885b1ad1865282072999fb045c8ad7  fix-asm-constraints-in-aarch64-multiply-macro.patch
f1177cbf6b1f44402f421c3d317aab1a2a40d0b1209c11519c1158df337c8945f3a313d689c939768584f3e4edbe52e8bd6103fb6777462326a9d94e8ab1f505  install-pear.patch
199aecdbd3b4035aabf5379c215f82412d3c98b79a1ee186944e7fe1f0ed6f40789ea30e2355149491de6be34fc66c5e486e2a79a7e41ab2ae18706ef3ffe79b  includedir.patch
9503514f22d591125fb08da23f4bcc9fc47e9b2cf8b53c6ca0130e1325acce621c21a59a60ab687c87972feba7f0007d52f4bd4790a1aca592383212891c4e7c  php-fpm.patch"
