# Contributor: Valery Kartel <valery.kartel@gmail.com>
# Maintainer: Valery Kartel <valery.kartel@gmail.com>
_suffix=7
_pkgreal=php
provides=$_pkgreal
pkgname=$_pkgreal$_suffix
pkgver=7.1.1
pkgrel=0
_apiver="20160303"
pkgdesc="The PHP$_suffix language runtime engine"
url="http://www.php.net/"
arch="all"
license="PHP-3"
options=""
depends="$pkgname-common"
depends_dev="$pkgname"
_depends_imap="--"
_depends_mysqlnd="$pkgname-mysqli"
_depends_pdo_dblib="$pkgname-pdo"
_depends_pdo_mysql="$pkgname-pdo"
_depends_pdo_odbc="$pkgname-pdo"
_depends_pdo_pgsql="$pkgname-pdo"
_depends_pdo_sqlite="$pkgname-pdo"
_depends_dom="$pkgname-xml"
_depends_soap="$pkgname-xml"
_depends_wddx="$pkgname-xml"
_depends_xmlrpc="$pkgname-xml"
_depends_xmlreader="$pkgname-dom $pkgname-xml"
_depends_xmlwriter="$pkgname-dom $pkgname-xml"
_depends_xsl="$pkgname-dom $pkgname-xml"
_prefix_opcache="zend_"
_pkgdesc_opcache="Zend OPcache"
makedepends="autoconf bison re2c apache2-dev libxml2-dev libxslt-dev libzip-dev bzip2-dev zlib-dev
	aspell-dev enchant-dev expat-dev pcre-dev curl-dev gmp-dev icu-dev imap-dev
	libical-dev libressl-dev openldap-dev net-snmp-dev db-dev krb5-dev gdbm-dev sqlite-dev
	freetds-dev mariadb-dev postgresql-dev unixodbc-dev freetype-dev tidyhtml-dev libxpm-dev
	libpng-dev libwebp-dev libjpeg-turbo-dev libmcrypt-dev gsoap-dev recode-dev
	libedit-dev gettext-dev
	"
source="http://php.net/distributions/$_pkgreal-$pkgver.tar.bz2
	$pkgname-fpm.initd
	$pkgname-fpm.logrotate
	$pkgname-module.conf
	install-pear.patch
	includedir.patch
	fix-asm-constraints-in-aarch64-multiply-macro.patch
	pid_log.patch
	"
subpackages="$pkgname-dev $pkgname-doc $pkgname-libs $pkgname-apache2 $pkgname-phpdbg
	$pkgname-litespeed $pkgname-cgi $pkgname-fpm $pkgname-pear::noarch $pkgname-phar-phar:_phar:noarch
	"
# unimplemented extensions: com_dotnet interbase oci8 pdo_firebird pdo_oci
_extensions="bcmath bz2 calendar ctype curl dba dom enchant exif ftp gd gettext gmp iconv imap intl json
	ldap mbstring mcrypt mysqli mysqlnd odbc opcache openssl pcntl pdo pdo_dblib pdo_mysql
	pdo_odbc pdo_pgsql pdo_sqlite pgsql phar posix pspell recode session shmop snmp soap
	sockets sqlite3 sysvmsg sysvsem sysvshm tidy wddx xml xmlreader xmlrpc xmlwriter xsl zip zlib
	"
for _extension in $_extensions; do
	subpackages="$subpackages $pkgname-$_extension:_extension"
done
subpackages="$subpackages $pkgname-common::noarch"
builddir="$srcdir/$_pkgreal-$pkgver"

prepare() {
	cd "$builddir"

	default_prepare || return 1
	update_config_sub || return 1

	local vapi=$(sed -n '/#define PHP_API_VERSION/{s/.* //;p}' main/php.h)
	if [ "$vapi" != "$_apiver" ]; then
		error "Upstreram API version is now $vapi. Expecting $_apiver"
		return 1
	fi

	autoconf
}

_build() {
	export EXTENSION_DIR=/usr/lib/$pkgname/modules
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--program-suffix=$_suffix \
		--libdir=/usr/lib/$pkgname \
		--datadir=/usr/share/$pkgname \
		--sysconfdir=/etc/$pkgname \
		--localstatedir=/var \
		--with-layout=GNU \
		--with-pic \
		--with-pear=/usr/share/pear \
		--with-config-file-path=/etc/$pkgname \
		--with-config-file-scan-dir=/etc/$pkgname/conf.d \
		--disable-short-tags \
		--with-openssl=shared --with-kerberos --with-system-ciphers \
		--with-pcre-regex --with-pcre-dir \
		--with-zlib=shared --with-zlib-dir \
		--enable-bcmath=shared \
		--with-bz2=shared \
		--enable-calendar=shared \
		--enable-ctype=shared \
		--with-curl=shared \
		--enable-dba=shared --with-gdbm --with-db4 \
		--enable-dom=shared \
		--with-enchant=shared \
		--enable-exif=shared \
		--enable-ftp=shared \
		--with-gd=shared --with-webp-dir=shared --with-jpeg-dir=shared --with-png-dir=shared --with-xpm-dir=shared \
		--with-freetype-dir=shared --enable-gd-native-ttf --disable-gd-jis-conv \
		--with-gettext=shared \
		--with-gmp=shared \
		--with-iconv=shared \
		--enable-intl=shared --with-icu-dir=/usr \
		--enable-json=shared \
		--enable-libxml=shared --with-libxml-dir=shared --with-libexpat-dir=shared \
		--with-ldap=shared --with-ldap-sasl \
		--enable-mbstring=shared --enable-mbregex \
		--with-mcrypt=shared \
		--with-sqlite3=shared,/usr --with-pdo-sqlite=shared,/usr \
		--with-pdo-dblib=shared \
		--with-mysqli=shared,/usr/bin/mysql_config \
		--enable-mysqlnd=shared --with-pdo-mysql=shared,/usr/bin/mysql_config --with-mysql-sock=/run/mysqld/mysqld.sock \
		--with-pgsql=shared --with-pdo-pgsql=shared \
		--with-unixODBC=shared,/usr -with-pdo-odbc=shared,unixODBC,/usr \
		--with-dbmaker=shared \
		--enable-opcache=shared \
		--enable-pdo=shared \
		--enable-pcntl=shared \
		--enable-posix=shared \
		--enable-phar=shared \
		--with-pspell=shared \
		--without-readline \
		--with-libedit \
		--enable-session=shared \
		--enable-shmop=shared \
		--with-snmp=shared \
		--enable-soap=shared \
		--enable-sockets=shared \
		--enable-sysvmsg=shared \
		--enable-sysvsem=shared \
		--enable-sysvshm=shared \
		--with-tidy=shared \
		--enable-xml=shared \
		--enable-xmlreader=shared \
		--enable-xmlwriter=shared \
		--with-xmlrpc=shared \
		--with-xsl=shared \
		--enable-wddx=shared \
		--enable-zip=shared --with-libzip=shared \
		$@ || return 1
	sed -ri "s/^(EXTRA_LDFLAGS[ ]*\=.*)/\1 -lpthread/" Makefile
	make || return 1
}

build() {
	cd "$builddir"
	# build phpdbg
	_build --enable-phpdbg \
		--enable-phpdbg-webhelper \
		--disable-cgi \
		--disable-cli \
		|| return 1
	# build apache2 module + recode extension
	_build --disable-phpdbg \
		--disable-cgi \
		--disable-cli \
		--with-apxs2 \
		--with-recode=shared \
		|| return 1
	mv libs/lib$pkgname.so sapi/apache2handler/
	# build all other + imap extension
	_build --disable-phpdbg \
		--enable-fpm \
		--enable-embed \
		--with-litespeed \
		--with-imap=shared --with-imap-ssl \
		|| return 1
}

package() {
	cd "$builddir"
	make -j1 INSTALL_ROOT="$pkgdir" install || return 1

	rm -fr "$pkgdir"/.[[:alpha:]]* || return 1

	ln -sf php$_suffix "$pkgdir"/usr/bin/php
}

dev() {
	default_dev

	mkdir -p "$subpkgdir"/usr/bin \
		"$subpkgdir"/usr/lib/$pkgname

	local file
	for file in php-config phpize; do
		mv "$pkgdir"/usr/bin/$file$_suffix \
			"$subpkgdir"/usr/bin/ || return 1
		ln -sf $file$_suffix "$subpkgdir"/usr/bin/$file
	done

	mv "$pkgdir"/usr/lib/$pkgname/build \
		"$subpkgdir"/usr/lib/$pkgname/ || return 1
}

doc() {
	default_doc
	install_if="docs $pkgname-common=$pkgver-r$pkgrel"

	cd "$builddir"
	local file
	for file in $(ls CODING_STANDARDS CREDITS EXTENSIONS INSTALL LICENSE NEWS README* UPGRADING*); do
		install -Dm644 $file "$subpkgdir"/usr/share/doc/$pkgname/$file || return 1
	done
}

apache2() {
	pkgdesc="$pkgdesc (apache2 module)"
	depends="$pkgname-common apache2"

	install -D -m755 "$builddir"/sapi/apache2handler/lib$pkgname.so \
		"$subpkgdir"/usr/lib/apache2/mod_$pkgname.so || return 1

	install -D -m644 "$srcdir"/$pkgname-module.conf \
		"$subpkgdir"/etc/apache2/conf.d/$pkgname-module.conf
}

phpdbg() {
	provides="php-phpdbg"
	pkgdesc="$pkgdesc (interactive debugger)"
	depends="$pkgname-common"

	install -Dm755 "$builddir"/sapi/phpdbg/phpdbg \
		 "$subpkgdir"/usr/bin/phpdbg$_suffix || return 1
	ln -sf phpdbg$_suffix "$subpkgdir"/usr/bin/phpdbg
}

libs() {
	pkgdesc="$pkgdesc (embedded library)"
	depends="$pkgname-common"

	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/lib$pkgname.so \
		"$subpkgdir"/usr/lib/ || return 1
}

litespeed() {
	provides="php-litespeed"
	pkgdesc="$pkgdesc (litespeed)"
	depends="$pkgname-common"

	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/lsphp \
		"$subpkgdir"/usr/bin/lsphp$_suffix || return 1
	ln -sf lsphp$_suffix "$subpkgdir"/usr/bin/lsphp
}

cgi() {
	provides="php-cgi"
	pkgdesc="$pkgdesc (common gateway interface)"
	depends="$pkgname-common"

	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/php-cgi$_suffix \
		 "$subpkgdir"/usr/bin/ || return 1
	ln -sf /usr/bin/php-cgi$_suffix "$subpkgdir"/usr/bin/php-cgi
}

fpm() {
	pkgdesc="$pkgdesc (fastcgi process manager)"
	depends="$pkgname-common"

	mkdir -p "$subpkgdir"/usr/share \
		"$subpkgdir"/etc/$pkgname \
		"$subpkgdir"/var/log/$pkgname

	mv "$pkgdir"/usr/sbin "$subpkgdir"/usr/ || return 1
	mv "$pkgdir"/usr/share/$pkgname \
		"$subpkgdir"/usr/share/ || return 1
	mv "$pkgdir"/etc/$pkgname/php-fpm* \
		"$subpkgdir"/etc/$pkgname/ || return 1

	local file;
	for file in php-fpm.conf php-fpm.d/www.conf; do
		mv "$subpkgdir"/etc/$pkgname/$file.default \
			"$subpkgdir"/etc/$pkgname/$file || return 1
	done

	install -D -m755 "$srcdir"/$pkgname-fpm.initd \
		"$subpkgdir"/etc/init.d/php-fpm$_suffix || return 1
	install -D -m644 "$srcdir"/$pkgname-fpm.logrotate \
		"$subpkgdir"/etc/logrotate.d/php-fpm$_suffix || return 1
}

pear() {
	provides="php-pear"
	pkgdesc="$pkgdesc (extension and application repository)"
	depends="$pkgname $pkgname-xml"

	mkdir -p "$subpkgdir"/usr/bin \
		"$subpkgdir"/etc/$pkgname

	mv "$pkgdir"/usr/bin/pecl \
		"$pkgdir"/usr/bin/pear \
		"$pkgdir"/usr/bin/peardev \
		"$subpkgdir"/usr/bin/ || return 1

	mv "$pkgdir"/etc/$pkgname/pear.conf \
		"$subpkgdir"/etc/$pkgname/ || return 1

	mv "$pkgdir"/usr/share \
		"$subpkgdir"/usr/ || return 1
}

common() {
	pkgdesc="$pkgdesc (common config)"
	depends=""

	mkdir -p "$subpkgdir"/etc/$pkgname/conf.d
	
	install -Dm644 "$builddir"/php.ini-production \
		"$subpkgdir"/etc/$pkgname/php.ini || return 1

	# exit with an error if some modules were not in subpackages
	rmdir "$pkgdir"/usr/lib/$pkgname/modules || return 1

	rm -fr "$pkgdir"/etc "$pkgdir"/var "$pkgdir"/usr/lib
}

_phar() {
	pkgdesc="$pkgdesc (archive script)"
	depends="$pkgname $pkgname-phar"

	mkdir -p "$subpkgdir"/usr/bin

	mv "$pkgdir"/usr/bin/phar* \
		"$subpkgdir"/usr/bin/ || return 1
}

_extension() {
	local extname=${subpkgname#*-}

	pkgdesc=$(eval echo \$_pkgdesc_$extname)
	[ ! "$pkgdesc" ] && pkgdesc=$(head -n1 "$builddir"/ext/$extname/CREDITS)
	[ ! "$pkgdesc" ] && return 1
	pkgdesc="PHP$_suffix extension: $pkgdesc"

	depends=$(eval echo \$_depends_$extname)
	local index=$(echo $depends | wc -w)
	depends="${depends%--*}"

	mkdir -p "$subpkgdir"/usr/lib/$pkgname/modules \
		"$subpkgdir"/etc/$pkgname/conf.d

	mv "$pkgdir"/usr/lib/$pkgname/modules/$extname.so \
		"$subpkgdir"/usr/lib/$pkgname/modules/ || return 1

	echo $(eval echo \$_prefix_$extname)extension=$extname.so >\
		"$subpkgdir"/etc/$pkgname/conf.d/$(printf %02d $index)_${extname}.ini
}

md5sums="cd5b7dfc4bcf99fe11cae7917e9453e1  php-7.1.1.tar.bz2
0eb07d4c8e77d99e3c101d61971d82e5  php7-fpm.initd
25bde13e7894c2930d97fad68d5dd3b3  php7-fpm.logrotate
47be6cd1ed92f21579e15bf2003a709f  php7-module.conf
483bc0a85c50a9a9aedbe14a19ed4526  install-pear.patch
d872e633c9b33c3c9f629dd2edd2e5c5  includedir.patch
fa807a684fa853720b7523eb99869b34  fix-asm-constraints-in-aarch64-multiply-macro.patch
20c182d85a9761d3c7140d47368e2d54  pid_log.patch"
sha256sums="d791d39d7b54ec42441a05a5f06d68a495647d843210e3ae4f2c6adb99c675bc  php-7.1.1.tar.bz2
a2eb6041f75347619957a038eee1f00f9627d5408010d0465cf4d421f323592a  php7-fpm.initd
6e4406f21b69085714cdb9d9a67c08e27a1c737ab353f9813cb2fc268352d2c6  php7-fpm.logrotate
276c823ee666ea73b36d4e97174eeea05713125b61f7f8681e350453c4123143  php7-module.conf
f739ca427a1dd53a388bad0823565299c5d4a5796b1171b892884e4d7d099bab  install-pear.patch
ea74966a23b1b54548ee35e9ccc2fc8d2b7c2285c385c44d6b23d9e2f25ea1a7  includedir.patch
86f4186699f0bc61ce91986fe5efdd7b0da77ff9568c10ba52ca1094da94ed6e  fix-asm-constraints-in-aarch64-multiply-macro.patch
e823b8470a2ca54ce9d523371bf8422c3b96c6cc3faa68467e3105a19b47e724  pid_log.patch"
sha512sums="005471c0233e04fd95e159f8106ecfb059500076482cd49b26d2597ac390f4fa09ec14146058cdcd38e7d27665ac1d2afdc758f41b86e7fb88c8ba405b6e6415  php-7.1.1.tar.bz2
3723ab7a0ec81b97b73da70c927ec3ea1db65eb238393f0fa85698750c1a09f727ad64c599717b9982feb65ca3977f4a8b0cf7457577ef8f68bc8d95409948ee  php7-fpm.initd
cacce7bf789467ff40647b7319e3760c6c587218720538516e8d400baa75651f72165c4e28056cd0c1dc89efecb4d00d0d7823bed80b29136262c825ce816691  php7-fpm.logrotate
fbf9a1572d37370ec0d126502e1d066e045a992484d8fc4f1e2ede330134c1a15f4029f29fa4daebd48eed78b045dc051ced69fbf1f11efc7ad81d884a639a99  php7-module.conf
f1177cbf6b1f44402f421c3d317aab1a2a40d0b1209c11519c1158df337c8945f3a313d689c939768584f3e4edbe52e8bd6103fb6777462326a9d94e8ab1f505  install-pear.patch
199aecdbd3b4035aabf5379c215f82412d3c98b79a1ee186944e7fe1f0ed6f40789ea30e2355149491de6be34fc66c5e486e2a79a7e41ab2ae18706ef3ffe79b  includedir.patch
d93d3fc015580cf5f75c6cbca4cd980e054b61e1068495da81a7e61f1af2c9ae14f09964c04928ad338142de78e4844aed885b1ad1865282072999fb045c8ad7  fix-asm-constraints-in-aarch64-multiply-macro.patch
5578265ad961ddc2826697a084a3b3a64081acff35412bedd834c03a9107b30f7a6ac1ea32d452ab4547eaf525294752dd11093132c7c042071916ca0214538b  pid_log.patch"
