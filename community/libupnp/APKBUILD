# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Contributor: Mike Crute <mike@crute.us>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
pkgname=libupnp
pkgver=1.14.25
pkgrel=1
pkgdesc="Portable Open Source UPnP Development Kit"
url="https://pupnp.github.io/pupnp/"
arch="all"
license="BSD-3-Clause"
makedepends="cmake samurai"
subpackages="$pkgname-dev $pkgname-nftrules"
source="$pkgname-$pkgver.tar.gz::https://github.com/pupnp/pupnp/archive/refs/tags/release-$pkgver.tar.gz
	$pkgname.nft
	disable-failing-test.patch
	"
builddir="$srcdir"/pupnp-release-$pkgver

# secfixes:
#   1.12.1-r1:
#     - CVE-2020-13848

build() {
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-Dblocking_tcp_connections=OFF \
		-Dreuseaddr=ON \
		-Dsamples=OFF
	cmake --build build
}

check() {
	cmake --build build --target test
}

package() {
	DESTDIR="$pkgdir" cmake --build build --target install
	install -Dm644 "$srcdir"/$pkgname.nft "$pkgdir"/usr/share/nftables.avail/50_$pkgname.nft
}

sha512sums="
2aed5c72cb8e33b89d85e6755b99e7bd4e82ffb58d03ef58c2cdd790d4dc6c33b3a9f91168595930be53f0bb803e266e2bb02ea5fcc5cda8edada9453bf56492  libupnp-1.14.25.tar.gz
5779bbcc55e411ec4da58e4e7eaaa6918cdcea5b8818cd72ab93be2d1108f020861457dbd8079a60b0912f84d05eb7b42274cc9a0577f66e8322f3596b89b411  libupnp.nft
f5890d2c1a3540fd1717eb038d1c4fc361b04e5a13be37d4f0ecbc574651b054b7326160c9399c6f7a4ce631c6ab912151d49a724615ee8f87138e4c0da9af0a  disable-failing-test.patch
"
