# Contributor: Naomi Rennie-Waldock <naomi.renniewaldock@gmail.com>
# Maintainer: Antoine Martin (ayakael) <dev@ayakael.net>
pkgname=skiasharp
pkgver=3.119.1
pkgrel=0
pkgdesc="2D graphics API for .NET - native library"
url="https://github.com/mono/SkiaSharp"
arch="x86_64 armv7 aarch64"
license="BSD-3-Clause"
_llvmver=21
makedepends="
	cmd:envsubst
	clang$_llvmver
	llvm$_llvmver
	gn
	ninja
	freetype-dev
	fontconfig-dev
	libwebp-dev
	libjpeg-turbo-dev
	harfbuzz-dev
	cmake
	zstd
	"
subpackages="$pkgname-dbg"
# tar generated using [workflow](https://ayakael.net/mirrors/skiasharp/src/branch/ci/.forgejo/workflows/generate-tarball.yml)
# to include submodules not included by upstream, including skia source code and its submodules
source="
	https://ayakael.net/api/packages/mirrors/generic/skiasharp/v$pkgver/skiasharp-v$pkgver.tar.zst
	args.gn.in
	0001-add-missing-includes.patch
	"
builddir="$srcdir"/skiasharp-v$pkgver
options="!check"

build() {
	export PATH="$PATH:/usr/lib/llvm$_llvmver/bin"
	local soname=$(awk '$1 == "libSkiaSharp" && $2 == "soname" { print $3 }' "$builddir"/scripts/VERSIONS.txt)
	local map="$builddir"/native/linux/libSkiaSharp/libSkiaSharp.map
	local _skia_arch=$CTARGET_ARCH

	case "$CARCH" in
		aarch64) _skia_arch=arm64 ;;
		armv7) _skia_arch=arm ;;
		x86_64) _skia_arch=x64 ;;
	esac

	export soname map _skia_arch _llvmver

	(
		cd externals/skia

		[ -d _build ] || mkdir _build
		envsubst < "$srcdir"/args.gn.in > _build/args.gn

		gn gen _build
		ninja -C _build SkiaSharp
	)
}

package() {
	local soname=$(awk '$1 == "libSkiaSharp" && $2 == "soname" { print $3 }' "$builddir"/scripts/VERSIONS.txt)

	install -Dm644 "$builddir"/externals/skia/_build/libSkiaSharp.so.$soname -t "$pkgdir"/usr/lib/
	ln -s libSkiaSharp.so.$soname "$pkgdir"/usr/lib/libSkiaSharp.so.${soname%%.*}
	ln -s libSkiaSharp.so.$soname "$pkgdir"/usr/lib/libSkiaSharp.so
}

sha512sums="
f46ae10474cbf66de5d86a6041e682ebaa7c68d640836ba283023d4d5787ddfa32ae7853b2e19da1ec5a65e40f4ae71d11e55721f6e0ed136b7bbd8477464564  skiasharp-v3.119.1.tar.zst
705945ca1cd1b6922a2491ef1ab17b3899334b5b30fb236ced09f7383779184d1c670698874602da3d367bcf35297e14bc6a362ed85f19f8ecc5209fb2918917  args.gn.in
a189922f8870352223b2aa9b922167398513333f6f82627b0499d7ca7fbeb211f0f5b192e5caad5b4eb9ebbb49de16f41c691309c3d41b3b19dc17cd13cf18b8  0001-add-missing-includes.patch
"
