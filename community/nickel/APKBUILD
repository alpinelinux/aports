maintainer="Hoang Nguyen <folliekazetani@protonmail.com>"
pkgname=nickel
pkgver=1.15.1
pkgrel=0
pkgdesc="Generic configuration language for less"
url="https://nickel-lang.org/"
# s390x: nix crate fails to build
# riscv64: apply_client_options test hangs indefinitely
arch="all !s390x !riscv64"
license="MIT"
makedepends="
	cargo
	cargo-auditable
	nix
	nix-dev
	oniguruma-dev
	py3-gpep517
	py3-installer
	py3-maturin
	python3-dev
	"
checkdepends="python3"
subpackages="
	$pkgname-doc
	$pkgname-language-server:_langserver
	py3-$pkgname-pyc
	py3-$pkgname:_py3
	"
options="net"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/tweag/nickel/archive/refs/tags/$pkgver.tar.gz
	explicit-dep-comrak.patch
	"

export RUSTONIG_DYNAMIC_LIBONIG=1

prepare() {
	default_prepare

	cargo fetch --target="$CTARGET" --locked
}

build() {
	cargo auditable build \
		--frozen \
		--release \
		--workspace \
		--features=package-experimental,nix-experimental \
		--bin nickel \
		--bin nls

	cd py-nickel
	gpep517 build-wheel \
		--wheel-dir .dist \
		--output-fd 3 3>&1 >&2
}

check() {
	# conflicting-index-deps fails on 32-bit architectures
	# https://github.com/tweag/nickel/issues/2372
	case "$CARCH" in
		x86|armhf|armv7) _skip_tests="--skip conflicting-index-deps" ;;
		*) _skip_tests="" ;;
	esac

	cargo test --frozen --workspace -- $_skip_tests
}

package() {
	install -Dm755 -t "$pkgdir"/usr/bin/ \
		target/release/nickel \
		target/release/nls

	install -Dm644 doc/manual/*.md -t "$pkgdir"/usr/share/doc/$pkgname/

	python3 -m installer -d "$pkgdir" \
		py-nickel/.dist/*.whl
}

_langserver() {
	pkgdesc="LSP server for Nickel configuration language"
	amove usr/bin/nls
}

_py3() {
	pkgdesc="Python 3 bindings for $pkgname"

	amove usr/lib/python3.*
}

sha512sums="
a75a32b9e168dfa77954b775638c5246f0332bdb3dc77fe9f815fc7715071e33d631676a34c3e2c498e9a2d1b362096e8abd139351482fbe2f6e524b065b0396  nickel-1.15.1.tar.gz
a5d2c2899e81d480702f4f43d42373019a28d032e711a12d133b320ff4ad43b158bb4fb9577a5bfbc150131913d7267a8fe511b908b1e62b09de089fb440a677  explicit-dep-comrak.patch
"
