# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
pkgname=py3-rencode
_pkgname=rencode
pkgver=1.0.8
pkgrel=0
pkgdesc="The rencode module is similar to bencode from the BitTorrent project."
url="https://pypi.org/project/rencode"
arch="all"
license="GPL-3.0-or-later"
makedepends="py3-gpep517 py3-setuptools py3-wheel py3-poetry-core python3-dev cython"
checkdepends="py3-pytest"
subpackages="$pkgname-pyc"
source="$pkgname-$pkgver.tar.gz::https://github.com/aresch/rencode/archive/v$pkgver.tar.gz
	change-default-compile-args.patch
	fix-tests-rencode-orig.patch
	"
builddir="$srcdir"/$_pkgname-$pkgver

replaces="py-rencode" # Backwards compatibility
provides="py-rencode=$pkgver-r$pkgrel" # Backwards compatibility

# secfixes:
#   1.0.6-r7:
#     - CVE-2021-40839

build() {
	gpep517 build-wheel \
		--wheel-dir .dist \
		--output-fd 3 3>&1 >&2
}

check() {
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer .dist/*.whl
	.testenv/bin/python3 -m pytest
}

package() {
	python3 -m installer -d "$pkgdir" \
		.dist/*.whl
}

sha512sums="
0c929d557f20b055c2c1ccbb29e6e8bedd2dbab2b356da7cdc9bb985a78be7bfb3a0d43bb7576fd7f95a830e99eb23f3a9dcd01547307d00905bdd2555b49294  py3-rencode-1.0.8.tar.gz
2a5207897622e2424abd5b132cb861297d53594462c1bba1570fed2c577592384e7caf9f8d92a315bbb489bc342092b901ee8f3e4b0d0b9c02b2ac27b62a10d2  change-default-compile-args.patch
1cc8b0a7b6731fcccdec94698e6e648e5b7056d21ce5ef98081b1418bdbffce6cd8b8631a6df80290aedf8bf4d7da13d56a0ba9091f1b3775b477fbba92c651e  fix-tests-rencode-orig.patch
"
