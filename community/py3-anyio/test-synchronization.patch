Patch-Source: https://github.com/agronholm/anyio/commit/fe26657433801160bc6b36804ee82f7d7781da29
---
From fe26657433801160bc6b36804ee82f7d7781da29 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Alex=20Gr=C3=B6nholm?= <alex.gronholm@nextday.fi>
Date: Mon, 3 Nov 2025 14:17:16 +0200
Subject: [PATCH] Allowed 0 tokens in a CapacityLimiter (#1019)

This matches the new behavior in Trio.
---
 docs/versionhistory.rst             |  3 +++
 pyproject.toml                      |  5 ++++-
 src/anyio/_backends/_asyncio.py     |  5 +++--
 src/anyio/_core/_synchronization.py |  2 ++
 tests/test_synchronization.py       | 22 ++++++++++++++++++++--
 5 files changed, 32 insertions(+), 5 deletions(-)

diff --git a/src/anyio/_backends/_asyncio.py b/src/anyio/_backends/_asyncio.py
index 07f175be..0b1c315d 100644
--- a/src/anyio/_backends/_asyncio.py
+++ b/src/anyio/_backends/_asyncio.py
@@ -1989,8 +1989,9 @@ def total_tokens(self) -> float:
     def total_tokens(self, value: float) -> None:
         if not isinstance(value, int) and not math.isinf(value):
             raise TypeError("total_tokens must be an int or math.inf")
-        if value < 1:
-            raise ValueError("total_tokens must be >= 1")
+
+        if value < 0:
+            raise ValueError("total_tokens must be >= 0")
 
         waiters_to_notify = max(value - self._total_tokens, 0)
         self._total_tokens = value
diff --git a/src/anyio/_core/_synchronization.py b/src/anyio/_core/_synchronization.py
index 66c1a9d3..74cd386e 100644
--- a/src/anyio/_core/_synchronization.py
+++ b/src/anyio/_core/_synchronization.py
@@ -540,6 +540,8 @@ def total_tokens(self) -> float:
 
         .. versionchanged:: 3.0
             The property is now writable.
+        .. versionchanged:: 4.12
+            The value can now be set to 0.
 
         """
         raise NotImplementedError
diff --git a/tests/test_synchronization.py b/tests/test_synchronization.py
index 1a6a22d0..374d336f 100644
--- a/tests/test_synchronization.py
+++ b/tests/test_synchronization.py
@@ -1,6 +1,7 @@
 from __future__ import annotations
 
 import asyncio
+import sys
 from typing import Any
 
 import pytest
@@ -666,8 +667,25 @@ async def test_bad_init_type(self) -> None:
             "total_tokens must be an int or math.inf"
         )
 
-    async def test_bad_init_value(self) -> None:
-        pytest.raises(ValueError, CapacityLimiter, 0).match("total_tokens must be >= 1")
+    async def test_bad_init_value(self, anyio_backend_name: str) -> None:
+        # TODO: Remove this once Python 3.9 is dropped
+        if sys.version_info < (3, 10) and anyio_backend_name == "trio":
+            bad_value = 0
+            min_value = 1
+        else:
+            bad_value = -1
+            min_value = 0
+
+        pytest.raises(ValueError, CapacityLimiter, bad_value).match(
+            f"total_tokens must be >= {min_value}"
+        )
+
+    async def test_zero_tokens(self, anyio_backend_name: str) -> None:
+        if sys.version_info < (3, 10) and anyio_backend_name == "trio":
+            pytest.skip("Trio does not support zero-capacity limiters on Python 3.9")
+
+        limiter = CapacityLimiter(0)
+        assert limiter.total_tokens == 0
 
     async def test_borrow(self) -> None:
         limiter = CapacityLimiter(2)
