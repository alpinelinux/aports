# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Contributor: Olivier Mauras <olivier@mauras.ch>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
pkgname=salt
pkgver=2016.3.3
pkgrel=1
pkgdesc="A parallel remote execution system"
url="https://github.com/saltstack/salt"
arch="noarch"
license="ASL 2.0"
depends="py-tornado py2-yaml py-jinja2 py2-markupsafe py2-msgpack py2-crypto py2-zmq
	py2-six py2-requests py2-futures py2-pygit2 procps"
depends_dev=""
makedepends="$depends_dev python2-dev py-tornado py2-yaml py-jinja2 py2-markupsafe
	py2-msgpack py2-crypto py2-zmq py2-six py2-requests py2-futures py2-libcloud"
install=""
subpackages="$pkgname-doc $pkgname-master $pkgname-minion $pkgname-syndic $pkgname-api
	$pkgname-cloud $pkgname-ssh"
source="$pkgname-$pkgver.tar.gz::https://codeload.github.com/saltstack/$pkgname/tar.gz/v$pkgver
		salt-api.confd
		salt-api.initd
		salt-master.confd
		salt-master.initd
		salt-minion.confd
		salt-minion.initd
		salt-syndic.confd
		salt-syndic.initd
		0001-alpine-support.patch"

builddir="$srcdir"/$pkgname-$pkgver
build() {
	cd "$builddir"
	python2 setup.py build || return 1
}

package() {
	cd "$builddir"
	python2 setup.py install --root="$pkgdir"/ --optimize=1 || return 1
	mkdir -p "${pkgdir}"/var/log/$pkgname || return 1
}

_init_copy() {
	local type="$1"
	install -m 755 -D "$srcdir"/salt-$type.initd "$subpkgdir"/etc/init.d/salt-$type || return 1
	install -m 644 -D "$srcdir"/salt-$type.confd "$subpkgdir"/etc/conf.d/salt-$type || return 1
}

_conf_copy() {
	local type="$1"
	mkdir -p "${subpkgdir}"/etc/salt/ || return 1
	cp -rf "${srcdir}"/${pkgname}-${pkgver}/conf/${type}* "${subpkgdir}"/etc/salt/ || return 1
}

master() {
	pkgdesc="Management component for salt, a parallel remote execution system"
	depends="$pkgname"

	_init_copy master
	_conf_copy master

	install -m 755 -D "$pkgdir"/usr/bin/salt "$subpkgdir"/usr/bin/salt || return 1

	local i
	for i in cp key master run unity
	do
		mv "${pkgdir}"/usr/bin/salt-$i "${subpkgdir}"/usr/bin || return 1
	done
}

minion() {
	pkgdesc="Client component for Salt, a parallel remote execution system"
	depends="$pkgname"

	_init_copy minion
	_conf_copy minion
	_conf_copy proxy

	mkdir -p "${subpkgdir}"/usr/bin || return 1

	local i
	for i in call minion proxy
	do
		mv "${pkgdir}"/usr/bin/salt-$i "${subpkgdir}"/usr/bin || return 1
	done
}

syndic() {
	pkgdesc="Master-of-master component for Salt, a parallel remote execution system"
	depends="$pkgname-master"

	mkdir -p ${subpkgdir}/usr/bin || return 1
	mv ${pkgdir}/usr/bin/salt-syndic ${subpkgdir}/usr/bin || return 1
}

api() {
	pkgdesc="REST API for Salt, a parallel remote execution system"
	depends="$pkgname-master"

	_init_copy api

	mkdir -p ${subpkgdir}/usr/bin || return 1
	mv ${pkgdir}/usr/bin/salt-api ${subpkgdir}/usr/bin || return 1
}

cloud() {
	pkgdesc="Cloud provisioner for Salt, a parallel remote execution system"
	depends="$pkgname-master py2-libcloud"

	_conf_copy cloud

	mkdir -p ${subpkgdir}/usr/bin || return 1
	mv ${pkgdir}/usr/bin/salt-cloud ${subpkgdir}/usr/bin || return 1
}

ssh() {
	pkgdesc="Agentless SSH-based version of Salt, a parallel remote execution system"
	depends="$pkgname"

	_conf_copy roster

	mkdir -p ${subpkgdir}/usr/bin || return 1
	mv ${pkgdir}/usr/bin/salt-ssh ${subpkgdir}/usr/bin || return 1
}

md5sums="5db25ad762a0780ff5d74561516a97fa  salt-2016.3.3.tar.gz
322f17cc48aabdc8cbf5f0bccf3e2059  salt-api.confd
3c30e20c642407b9351eef6989783d98  salt-api.initd
7bb58f256213aaaa23d86d5127c9ffe3  salt-master.confd
0b40fd1b49ff4c2f34382fd69c341c34  salt-master.initd
75badf5042aa93a6da74659ca12bef70  salt-minion.confd
c8326b9cff0df6065a1320eefea09b2c  salt-minion.initd
a24d13b018a35b31b34167bcaa749db5  salt-syndic.confd
dffce15d3a16a2dc40dd02d0c24fb4c6  salt-syndic.initd
87331025b2b76a4b608b54304efd8f53  0001-alpine-support.patch"
sha256sums="7d09bc9142d96ecdfe779cf813e43ab62b9b4632f6e0711af383809661b87e1d  salt-2016.3.3.tar.gz
b25cfdb769305f2245b27f6753adee590bac10faeb8c43ba605dbf7e931fe258  salt-api.confd
6788663f24c9b4427bb3bd2fac2164b5ed34a0a2eaada0ca50600a9dd1e9892a  salt-api.initd
383475b21261ac22c5930e99060d53630dfb35aac67aa03a18ec738e0f4dff50  salt-master.confd
40c9864ab001c00de60b52baff5c9cf7c2c0f248a1e02fb15260ae70287bce70  salt-master.initd
286148f5391d42c04a62a13cc125fa2130b5821e50da913c5a20d3a913e5f2d1  salt-minion.confd
ae9236919c3fee3eef0ef8ad54334d6f833a51bbd4d42c40214614498acbe573  salt-minion.initd
66a663c426e2fa157ea78f7f9b2f33f17b72dbc48e119f8dd2609aab8f8370e7  salt-syndic.confd
6a453f63e51f2cc1ecb024ee8e7fa1beab7fbcea010f3eb10ea23bdb2383e7f5  salt-syndic.initd
b3680210e046ca19eba34169f17eba2604e7dfe5b05984c29ac5663d4f3bd17f  0001-alpine-support.patch"
sha512sums="89a6f9e7d8a337ec5addda2374c833d251162150c4e57ce34f7f9e81a75f540539071064c0e7c4486ef6e447c6422363f868e9b035e4c5af2f3d320e98e0226d  salt-2016.3.3.tar.gz
975ba2f5e681fbd62045da61cc3dc065b148683a07b5df7eca9f131e47314eb6bfa8660ca1c06a3bd93683c7097d0ff9f8e514273dd24d82fb2de6a255e6b275  salt-api.confd
cf196bd47761b4c22ed3f79815a0ebaa378ebdfc1bb29ee45d2db7c0f99bd65583c59accdb7c34d8cc1a2a33dac999e2e1007f9a8f435ef892ed6ee8895960ff  salt-api.initd
cfbbeb8023a383e7c42d84e3346edfd068c9ec7650c4ddc3caa38534da325a67497e1f06ca02cc1f0941b7348a3af6d1dca7cd6f2bcb3612ca10e1ec98997e5a  salt-master.confd
324e687e8b0eaccb799b4a719448341a4e09cda3add102890beddaf371ac42957bbc1622f145b2b86420061655bb27f27879302b5b34c6eee1987d2dcae6b8ef  salt-master.initd
0051e13351cef8db81dc075a194bb384723f07d5591b5b4d3f3adf4180afaf7beced470ab79ceca9d1ec0dae62dbd72084eb76af009fc78411a011050a94a2ed  salt-minion.confd
c6634a592c6f3e65dd2b704cb500486bf8004c5b287d4a4d42b09af36ef129c59d6a89f005af058cf7911e8587d927b3db931186569084f13ebaca56f6ef93a0  salt-minion.initd
bafc6ea10cdafd0aef868feb35aecbe4ae6a7dff0ae42862bded85715ad763eb89e1ed27437866a7e5f2b9f7064e3c2a3fb59814487744ba4227238d95cf3818  salt-syndic.confd
d71133e834685304e0167554035ebbc861252f972bbe981cc71e45b70f15d94a28a02a369463c9a641372919689f96b62a0408b14f824ad986d536e52b1e5ec0  salt-syndic.initd
6e4d3129b661184317f60dda7217fec3815f59d126c368ff73e89a32a46e96c1b243614506f5f81b4f42130ef64153e90c9828e0d7c743d52dcff980d068c0fa  0001-alpine-support.patch"
