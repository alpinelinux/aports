# Contributor: Klemens Nanni <kn@openbsd.org>
# Maintainer: Klemens Nanni <kn@openbsd.org>

# when changing _ver we *must* bump _rel
_name=vmm_clock
_ver=0.2.2
_rel=0

# kernel version
# when changing _kver make sure _krel=0 & _rel=0
_flavor=${FLAVOR:-lts}
_kpkg="linux-$_flavor"
_kver=6.18.0
_krel=6
_kpkgver="$_kver-r$_krel"

# for custom kernels set $FLAVOR
case $CARCH in
# see $arch comment
x86|x86_64) _extra_flavors="virt";;
esac

pkgname="$_name-$_flavor"
pkgver=$_kver
pkgrel=$(( _rel + _krel ))

pkgdesc="clocksource under OpenBSD VMM"
url="https://github.com/voutilad/vmm_clock"
# amd64-only https://man.openbsd.org/vmm.4 supports i386 and amd64 guests
arch="x86 x86_64"
license="GPL-2.0-only"
depends="$_kpkg=$_kpkgver"
makedepends="$_kpkg-dev=$_kpkgver"
source="$_name-$_ver.tar.gz::https://github.com/voutilad/vmm_clock/archive/refs/tags/$_ver.tar.gz
	kernel-6.18.patch"
builddir="$srcdir/$_name-$_ver"
options="!check" # no tests

for f in $_extra_flavors; do
	makedepends="$makedepends linux-$f-dev=$_kpkgver"
	subpackages="$subpackages $_name-$f:_extra"
done

prepare() {
	default_prepare
	# verify the kernel version
	local _kapkbuild="$startdir/../../main/linux-$_flavor/APKBUILD"
	if [ -f "$_kapkbuild" ]; then
		(	. $_kapkbuild
			pkgname=$_name-$_flavor
			[ "$_kver" != "$pkgver" ] && die "please update _kver to $pkgver"
			[ "$_krel" != "$pkgrel" ] && die "please update _krel to $pkgrel"
			return 0
		)
	fi
	local flavor=
	for flavor in $_flavor $_extra_flavors; do
		cp -r "$builddir" "$srcdir/$flavor"
	done
}

build() {
	local flavor= kabi=
	for flavor in $_flavor $_extra_flavors; do
		kabi="${_kver/_rc/-rc}-$_krel-$flavor"
		make -C "$srcdir/$flavor" KERNELRELEASE="$kabi"
	done
}

package() {
	local flavor= kabi= module= modules="vmm_clock"
	for flavor in $_flavor $_extra_flavors; do
		kabi="${_kver/_rc/-rc}-$_krel-$flavor"
		for module in $modules; do
			install -Dm644 "$srcdir/$flavor/$module.ko" \
				"$pkgdir/lib/modules/$kabi/extra/$module.ko"
		done
		printf '%s\n' $modules |
			install -D -m644 /dev/stdin \
				"$pkgdir/usr/lib/modules-load.d/$_name-$flavor".conf
	done
}

_extra() {
	local flavor=${subpkgname##*-}
	depends="linux-$flavor=$_kpkgver"
	pkgdesc="$pkgdesc for $flavor kernel"

	amove \
		lib/modules/*-$flavor \
		usr/lib/modules-load.d/*-$flavor.conf
}

sha512sums="
6d737fdbcc4d797c4356aa0307dcb2741dc22945fd33eb464d540c5c9eff83b6e7b90b39b8e3440f7e204b2b1c400fe317ccd96b6e566fc02d364772ed1e26c2  vmm_clock-0.2.2.tar.gz
f619515179e06b8d63ad7b24045ef98d63e0d3ad15cf3831801595d16315751852ffd789640c638ae846c74c8fe9a522eaaf5e12bf4a994f2cd16418fe00e4c8  kernel-6.18.patch
"
