# Maintainer: omni <omni+alpine@hack.org>
maintainer="omni <omni+alpine@hack.org>"
pkgname=uutils
pkgver=0.6.0
pkgrel=0
pkgdesc="Rust rewrite of the GNU coreutils"
arch="all"
url="https://uutils.github.io/coreutils/"
license="MIT"
makedepends="cargo help2man oniguruma-dev cargo-auditable"
checkdepends="coreutils" # test_ls.rs incompatible with busybox truncate
subpackages="$pkgname-doc
	$pkgname-coreutils:_coreutils
	$pkgname-coreutils-doc:_coreutils_doc
	$pkgname-coreutils-groups:_groups
	$pkgname-coreutils-groups-doc:_groups_doc
	$pkgname-coreutils-hostname:_hostname
	$pkgname-coreutils-hostname-doc:_hostname_doc
	$pkgname-coreutils-more:_more
	$pkgname-coreutils-more-doc:_more_doc
	$pkgname-coreutils-uptime:_uptime
	$pkgname-coreutils-uptime-doc:_uptime_doc
	"
source="$pkgname-coreutils-$pkgver.tar.gz::https://github.com/uutils/coreutils/archive/$pkgver.tar.gz
	coreutils-as-uutils.patch
	downgrade-rlimit_patch
	downgrade-libc_patch
	ppc64le_patch
	"
builddir="$srcdir/coreutils-$pkgver"
options="net"

export RUSTONIG_DYNAMIC_LIBONIG=1

prepare() {
	default_prepare

	case "$CARCH" in
	loongarch64|s390x)
		patch Cargo.toml "$srcdir"/downgrade-rlimit_patch
		patch Cargo.lock "$srcdir"/downgrade-libc_patch
		;;
	ppc64le)
		patch src/uu/stty/src/stty.rs "$srcdir"/ppc64le_patch
		;;
	esac

	cargo fetch --target="$CTARGET" --locked
}

build() {
	cargo auditable build --frozen \
		--profile=release-small --features=feat_os_unix

	install -Dm0755 target/release-small/coreutils build/bin/"$pkgname"

	cd build

	help2man --no-info --name=uutils --manual="$pkgname" \
		--version-string="$pkgver" bin/"$pkgname" > "$pkgname".1

	# create symlinks and individual man pages
	install -dm0755 man1/ usr/bin/ && cd usr/bin
	for uutil in $(../../bin/uutils --list); do
		ln -s ../../bin/uutils $uutil
		case "$uutil" in
			test) ;; # helpless
			\[) help2man --no-info --name=test --manual="$pkgname coreutils" \
				./"$uutil" > ../../man1/test.1 ;;
			uniq) help2man --no-info --name="$uutil" --manual="$pkgname coreutils" \
				--no-discard-stderr \
				./"$uutil" > ../../man1/"$uutil".1 ;;
			*) help2man --no-info --name="$uutil" --manual="$pkgname coreutils" \
				./"$uutil" > ../../man1/"$uutil".1 ;;
		esac
	done
}

check() {
	ulimit -n 4096 # running out of file descriptors

	cargo test --frozen \
		--features=feat_os_unix \
		--no-fail-fast -- \
		--skip "test_error_messages_french_translation" \
		--skip "test_french_colored_error_messages" \
		--skip "test_help_messages_french_translation" \
		|| true # TODO: FIXME
}

package() {
	pkgdesc="$pkgdesc - main binary"
	replaces="uutils-coreutils<0.0.28-r0"

	# Install to /bin to fix symlinks on usr-merged systems
	install -Dm0755 build/bin/"$pkgname" -t "$pkgdir"/bin/
	# remove the binary and keep the symlinks
	rm build/bin/"$pkgname"

	install -Dm0644 build/"$pkgname".1 -t "$pkgdir"/usr/share/man/man1/
	install -Dm0644 LICENSE -t "$pkgdir"/usr/share/licenses/"$pkgname"/
}

_coreutils() {
	# prefix with 0. to ensure it never gets above GNU coreutils' version
	provides="coreutils=0.$pkgver-r$pkgrel"
	# stat used to be a separate subpackage
	provides="$provides uutils-coreutils-stat=$pkgver-r$pkgrel"
	depends="$pkgname"

	# binaries that busybox puts in /bin (mimic main/coreutils)
	local busybox_bin="arch base64 cat chgrp chmod chown cp date dd df echo
		false kill link ln ls mkdir mknod mktemp mv nice printenv pwd rm rmdir
		sleep stty sync touch true uname"

	# as these binaries live in /bin on busybox, we want to put them in /bin with uutils
	install -dm0755 "$subpkgdir"/bin/
	for bbb in $busybox_bin; do
		rm "$builddir"/build/usr/bin/"$bbb"
		ln -s "$pkgname" "$subpkgdir"/bin/"$bbb"
	done

	# chroot lives in /usr/sbin with busybox
	rm "$builddir"/build/usr/bin/chroot
	install -dm0755 "$subpkgdir"/usr/sbin/
	ln -s ../../bin/"$pkgname" "$subpkgdir"/usr/sbin/chroot

	# resolve conflict between shadow and uutils-coreutils for cmd:groups
	rm "$builddir"/build/usr/bin/groups
	mv "$builddir"/build/man1/groups.1 "$builddir"/
	# TODO: resolve this some other way between this aport, main/coreutils and
	# community/shadow

	# resolve conflict between procps-ng and uutils-coreutils for cmd:uptime
	rm "$builddir"/build/usr/bin/uptime
	mv "$builddir"/build/man1/uptime.1 "$builddir"/
	# TODO: resolve this some other way between this aport and main/procps-ng

	# uutils hostname does not take -F FILE (keep busybox for now)
	rm "$builddir"/build/usr/bin/hostname
	mv "$builddir"/build/man1/hostname.1 "$builddir"/

	# resolve conflict between utils-linux-misc and uutils-coreutils for cmd:more
	rm "$builddir"/build/usr/bin/more
	mv "$builddir"/build/man1/more.1 "$builddir"/

	# install what's left
	install -dm0755 "$subpkgdir"/usr/bin/
	mv "$builddir"/build/usr/bin/* "$subpkgdir"/usr/bin/
}

_coreutils_doc() {
	# prefix with 0. to ensure it never gets above GNU coreutils' version
	provides="coreutils-doc=0.$pkgver-r$pkgrel"
	# stat used to be a separate subpackage
	provides="$provides uutils-coreutils-stat-doc=$pkgver-r$pkgrel"

	install -Dm0644 "$builddir"/build/man1/* -t "$subpkgdir"/usr/share/man/man1/

	default_doc
}

_groups() {
	pkgdesc="$pkgdesc - cmd:groups"
	depends="$pkgname"

	install -dm0755 "$subpkgdir"/usr/bin/
	ln -s ../../bin/"$pkgname" "$subpkgdir"/usr/bin/groups
}

_groups_doc() {
	pkgdesc="$pkgdesc - cmd:groups (documentation)"
	install_if="docs $pkgname-coreutils-groups=$pkgver-r$pkgrel"

	install -Dm0644 "$builddir"/groups.1 -t "$subpkgdir"/usr/share/man/man1/
	gzip -n -9 "$subpkgdir"/usr/share/man/man1/groups.1
}

_hostname() {
	pkgdesc="$pkgdesc - cmd:hostname"
	depends="$pkgname"

	# busybox path
	install -dm0755 "$subpkgdir"/bin/
	ln -s "$pkgname" "$subpkgdir"/bin/hostname
}

_hostname_doc() {
	pkgdesc="$pkgdesc - cmd:hostname (documentation)"
	install_if="docs $pkgname-coreutils-hostname=$pkgver-r$pkgrel"

	install -Dm0644 "$builddir"/hostname.1 -t "$subpkgdir"/usr/share/man/man1/
	gzip -n -9 "$subpkgdir"/usr/share/man/man1/hostname.1
}

_more() {
	pkgdesc="$pkgdesc - cmd:more"
	depends="$pkgname"

	# busybox/util-linux-misc path
	install -dm0755 "$subpkgdir"/bin/
	ln -s "$pkgname" "$subpkgdir"/bin/more
}

_more_doc() {
	pkgdesc="$pkgdesc - cmd:more (documentation)"
	install_if="docs $pkgname-coreutils-more=$pkgver-r$pkgrel"

	install -Dm0644 "$builddir"/more.1 -t "$subpkgdir"/usr/share/man/man1/
	gzip -n -9 "$subpkgdir"/usr/share/man/man1/more.1
}

_uptime() {
	pkgdesc="$pkgdesc - cmd:uptime"
	depends="$pkgname"

	# busybox/procps-ng path
	install -dm0755 "$subpkgdir"/usr/bin/
	ln -s ../../bin/"$pkgname" "$subpkgdir"/usr/bin/uptime
}

_uptime_doc() {
	pkgdesc="$pkgdesc - cmd:uptime (documentation)"
	install_if="docs $pkgname-coreutils-uptime=$pkgver-r$pkgrel"

	install -Dm0644 "$builddir"/uptime.1 -t "$subpkgdir"/usr/share/man/man1/
	gzip -n -9 "$subpkgdir"/usr/share/man/man1/uptime.1
}

sha512sums="
f493472a021aaa2008eb55d726ac5f76fa6a38ec6bc9db27dcb1f451731c7e3358c61a1eeeffabe9233767dc230a3695b455e1f7558588e034c7c9e0d5ee6b31  uutils-coreutils-0.6.0.tar.gz
6bb266dc5098acaca67d91168513cfcf6d5dc3c92cfcf1ae34ea2ebd92a1476b34d76519604473160785fbcb72c5d310f110d429d41aedd8d58149f2073b2933  coreutils-as-uutils.patch
2836a61ea82771ea4ac7f3e033c9465de2b6076ef20b151bf4ba42ce99106136d2719b06303ba4d66785904a57d1be059e67081cbef52838d2173a79a4d78154  downgrade-rlimit_patch
5c1d9bc439f9c29985644f93024ac590eca7fd133714dbdc6d8c82d29fc6133858611428c0ea5adb50cb45c9843e208cbf33bbebf715464d746c670ab48e34ae  downgrade-libc_patch
49e9e25c7d4da99c5c1a0fc04df003a4a7bd6ca2ece47e9ca99d2235fdde4bb451362b5641093b25c20328a54af02f5a3a305bec97a9db88487e7663267d75e0  ppc64le_patch
"
