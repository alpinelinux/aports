# Contributor: kpcyrd <git@rxv.cc>
# Contributor: Bart≈Çomiej Piotrowski <bpiotrowski@alpinelinux.org>
# Maintainer: kpcyrd <git@rxv.cc>
pkgname=cjdns
pkgver=22.1
pkgrel=0
pkgdesc="A routing engine designed for security, scalability, speed and ease of use"
url="https://github.com/cjdelisle/cjdns"
# loongarch64: blocked by ring crate
# 32-bit: tokio-runtime-worker panicked at rust/cjdns_sys/src/rffi/util.rs:32:5
# Assertion failure, core dump when running cjdroute
arch="all !s390x !ppc64le !riscv64 !loongarch64 !armhf !armv7 !x86"
license="GPL-3.0-or-later"
makedepends="
	cargo
	cargo-auditable
	linux-headers
	nodejs
	"
install="$pkgname.post-install"
subpackages="$pkgname-doc $pkgname-openrc"
source="$pkgname-$pkgver.tar.gz::https://github.com/cjdelisle/cjdns/archive/cjdns-v$pkgver.tar.gz
	getrandom-0.2.10.patch
	rust1.89.patch
	"
builddir="$srcdir/$pkgname-$pkgname-v$pkgver"
options="net"


prepare() {
	default_prepare

	cargo fetch --target=$CTARGET --locked
}

build() {
	export CJDNS_RELEASE_VERSION="$pkgver"
	export CFLAGS="$CFLAGS -Wno-incompatible-pointer-types"
	cargo auditable build --release --frozen
}

check() {
	./target/release/cjdroute --help
}

package() {
	find ./target/release -maxdepth 1 -type f -perm -a=x \
		-exec install -Dm755 -t "$pkgdir"/usr/sbin/ {} \+
	install -Dm755 contrib/openrc/cjdns "$pkgdir/etc/init.d/cjdns"
	install -Dm644 doc/man/cjdroute.1 \
		"$pkgdir/usr/share/man/man1/cjdroute.1"
	install -Dm644 doc/man/cjdroute.conf.5 \
		"$pkgdir/usr/share/man/man5/cjdroute.conf.5"
	install -Dm 644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
	install -Dm644 -t "$pkgdir/usr/share/doc/$pkgname" \
		doc/admin-api.md \
		doc/configure.md \
		doc/djc_layer_model.md \
		doc/nat-gateway.md \
		doc/network-services.md \
		doc/non-root-user.md \
		doc/security_specification.md \
		doc/shorewall_and_vpn_gateway_howto.md \
		doc/tunnel.md
}

sha512sums="
8793318ac09ee3ae951c6eee9ac2f4165976cba9d4a35675902215b9a49badf4e050b9d1ff0a2e986a991a708d7e3b4efae480953e054402432838221710ba98  cjdns-22.1.tar.gz
9c0fdc3d685710158a52fd318fe24fe80fe00938529def94c3694335824ff8407e83d39eff96a57fecd86a4b4f09ad7685c7229622bb8fb3098dc04aba247212  getrandom-0.2.10.patch
ae72e10122f13b2844aa2e8fe0aa28f5025b7b2f3c667fcca9683b70d473d1406c17d03a1c0c38529b2be246e13022cb519580f7bff28cfe6a01f96439a2f348  rust1.89.patch
"
