Patch-Source: https://github.com/cjdelisle/cjdns/commit/53007ebb2e18e8052054675f979fcaeea5de0437
PR: https://github.com/cjdelisle/cjdns/pull/1271
---
From 53007ebb2e18e8052054675f979fcaeea5de0437 Mon Sep 17 00:00:00 2001
From: Rui Chen <rui@chenrui.dev>
Date: Mon, 15 Sep 2025 01:01:43 -0400
Subject: [PATCH] fix(rffi): remove implicit autoref on raw pointers and
 clarify lifetime

Signed-off-by: Rui Chen <rui@chenrui.dev>
---
 rust/cjdns_sys/src/rffi/allocator.rs | 12 +++++++-----
 rust/cjdns_sys/src/rffi/benc.rs      |  6 +++++-
 2 files changed, 12 insertions(+), 6 deletions(-)

diff --git a/rust/cjdns_sys/src/rffi/allocator.rs b/rust/cjdns_sys/src/rffi/allocator.rs
index 883d3d99c..1a4c3c0bf 100644
--- a/rust/cjdns_sys/src/rffi/allocator.rs
+++ b/rust/cjdns_sys/src/rffi/allocator.rs
@@ -217,9 +217,11 @@ impl Allocator {
         // This "as" does not cast, but it fails if we're wrong
         let a = Box::into_raw(a);
         unsafe {
-            (*a).inner.ident.replace(format!("{}/{:p}", file_line.print(), a));
-            (*a).inner.mebox.replace(a);
-            log::trace!("New allocator {} <- {}", (*a).ident(), parent);
+            // Avoid creating implicit references from raw pointer field chaining; take an explicit ref.
+            let alloc_ref: &mut Allocator = &mut *a;
+            alloc_ref.inner.ident.replace(format!("{}/{:p}", file_line.print(), a));
+            alloc_ref.inner.mebox.replace(a);
+            log::trace!("New allocator {} <- {}", alloc_ref.ident(), parent);
         }
         a as *mut Allocator_t
     }
@@ -234,7 +236,7 @@ impl Allocator {
         Self::new_int(file_line, Vec::new())
     }
 
-    pub fn ident(&self) -> Ref<String> {
+    pub fn ident(&self) -> Ref<'_, String> {
         self.inner.ident.borrow()
     }
 
@@ -439,4 +441,4 @@ pub fn rs(a: *mut Allocator_t) -> Allocator {
     };
     Box::into_raw(b);
     out
-}
\ No newline at end of file
+}
diff --git a/rust/cjdns_sys/src/rffi/benc.rs b/rust/cjdns_sys/src/rffi/benc.rs
index 524c634e3..9ad2fa1f4 100644
--- a/rust/cjdns_sys/src/rffi/benc.rs
+++ b/rust/cjdns_sys/src/rffi/benc.rs
@@ -51,7 +51,11 @@ pub fn string_to_c<'a>(alloc: *mut Allocator_t, v: impl Into<&'a[u8]>) -> *mut S
     let len = v.len();
     v.push(0);
     let bytes = allocator::adopt(alloc, v);
-    let bytes = unsafe { (*bytes)[..].as_mut_ptr() };
+    // Avoid implicit autoref of raw pointer (*bytes) by taking an explicit mutable reference first
+    let bytes = unsafe {
+        let v_ref: &mut Vec<u8> = &mut *bytes;
+        v_ref.as_mut_ptr()
+    };
     allocator::adopt(alloc, String_t{
         len,
         bytes: bytes as _,
