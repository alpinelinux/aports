# Contributor: Antoine Martin (ayakael) <dev@ayakael.net>
# Maintainer: Antoine Martin (ayakael) <dev@ayakael.net>
pkgname=zotero
pkgver=8.0.2
pkgrel=0
_fxver=140.7.0
_gittag=$pkgver
pkgdesc="A free, easy-to-use tool to help you collect, organize, cite, and share your research sources."
url="https://www.zotero.org/"
# s390x and riscv64: blocked by rust and cargo
# armhf: build failure on armhf due to wasm
# ppc64le: test suite stalls
# armv7 and x86: since 7.0.12, note-editor depends on rollup.
# 	Attempts at overriding with rollup/wasm-node has failed.
arch="x86_64 aarch64"
license="GPL-3.0-only AND LGPL-2.1-only AND LGPL-3.0-only AND MPL-2.0"
depends="
	ffmpeg7-libavcodec
	"
_llvmver=21
makedepends="
	alsa-lib-dev
	automake
	bash
	bsd-compat-headers
	cargo
	cbindgen
	clang$_llvmver
	clang$_llvmver-libclang
	compiler-rt
	curl
	dbus-dev
	gettext
	grep
	gtk+3.0-dev
	hunspell-dev
	icu-dev
	libevent-dev
	libffi-dev
	libjpeg-turbo-dev
	libnotify-dev
	libogg-dev
	libtheora-dev
	libtool
	libvorbis-dev
	libvpx-dev
	libwebp-dev
	libxcomposite-dev
	libxt-dev
	lld$_llvmver
	llvm
	llvm$_llvmver-dev
	m4
	mesa-dev
	nasm
	nodejs
	npm
	nspr-dev
	nss-dev
	perl
	pipewire-dev
	pulseaudio-dev
	python3
	rsync
	sed
	wasi-compiler-rt
	wasi-sdk
	unzip
	wireless-tools-dev
	xvfb-run
	zip
	"
source="https://ftp.mozilla.org/pub/firefox/releases/${_fxver}esr/source/firefox-${_fxver}esr.source.tar.xz
	abseil-cpp.patch
	esr-metainfo.patch
	bmo-1952657-no-execinfo.patch
	fix-fortify-system-wrappers.patch
	fix-rust-target.patch
	fix-webrtc-glibcisms.patch
	lfs64.patch
	no-ccache-stats.patch
	rust-lto-thin.patch
	riscv64-no-lto.patch
	sandbox-sched_setscheduler.patch
	sqlite-ppc.patch
	rust1.90-ppc.patch
	icu78.patch

	loong0001-Enable-WebRTC-for-loongarch64.patch
	loong0003-Define-HWCAP_LOONGARCH_LSX_and_LASX.patch
	loong0004-Fix-ycbcr-chromium_types-warning.patch

	stab.h
	mozilla-location.keys
	vendor-prefs.js
	mozconfig

	zotero.desktop
	https://ayakael.net/api/packages/mirrors/generic/zotero/$pkgver/zotero-$pkgver.tar.gz
	zotero_build-modifications.patch
	zotero_test-drop-build.patch
	zotero_test-fix-chars.patch
	zotero_test-push-timeout-to-30sec.patch
	zotero_avoid-bash-runtime-dependency.patch
	"

builddir="$srcdir"/firefox-$_fxver
_zoterodir="$srcdir"/zotero-$_gittag
_mozappdir=/usr/lib/zotero

# help our shared-object scanner to find the libs
ldpath="$_mozappdir"
sonameprefix="$pkgname:"

# we need this because cargo verifies checksums of all files in vendor
# crates when it builds and gives us no way to override or update the
# file sanely... so just clear out the file list
_clear_vendor_checksums() {
	sed -i 's/\("files":{\)[^}]*/\1/' third_party/rust/$1/.cargo-checksum.json
}

prepare() {
	# zotero prepare
	mv "$_zoterodir" "$builddir"/zotero
	(
		cd "$builddir"/zotero

		# checks that we're using expected fx version
		local _exp_fxver=$(grep GECKO_VERSION_LINUX "$builddir"/zotero/app/config.sh | sed 's|.*=||' | tr -d '"' | sed 's|esr||')
		if [ "$_fxver" != "$_exp_fxver" ]; then
			msg "Expected firefox version $_exp_fxver, got $_fxver"
		fi

		# zotero build expects to be in a git repo
		git init
		git config user.name info
		git config user.email info@example.org
		git commit --allow-empty -m 'Initial'

		npm i --legacy-peer-deps
	)
	default_prepare

	cp "$srcdir"/stab.h toolkit/crashreporter/google-breakpad/src/

	export CFLAGS="${CFLAGS/-fstack-clash-protection/} -g0 -O2"
	export CXXFLAGS="${CXXFLAGS/-fstack-clash-protection/} -g0 -O2 -Wno-deprecated-builtins -Wno-deprecated-declarations"

	_clear_vendor_checksums audio_thread_priority
	_clear_vendor_checksums libc
	_clear_vendor_checksums cc

	base64 -d "$srcdir"/mozilla-location.keys > "$builddir"/mozilla-api-key
}

build() {
	export MOZ_BUILD_DATE="$(date ${SOURCE_DATE_EPOCH:+ -d@${SOURCE_DATE_EPOCH}} "+%Y%m%d%H%M%S")"

	# for lto
	ulimit -n 4096

	# can't be set here and fail
	unset RUSTFLAGS

	local thinlto_jobs=${JOBS:-1}
	local link_threads=${JOBS:-1}

	case "$CARCH" in
	# on this platform, lld seems to not utilise >1 threads for thinlto for some reason.
	# at the same time, having more than 8 also crashes lld for firefox buildsystems (why?).
	aarch64)
		if [ $thinlto_jobs -gt 8 ]; then
			thinlto_jobs=8
		fi
		;;
	esac

	# on 32-bit, using more than 1 threads leads to OOM issues
	case "$CARCH" in
	arm*|x86)
		link_threads=1
		;;
	esac

	export LDFLAGS="$LDFLAGS -Wl,--thinlto-jobs=$thinlto_jobs -Wl,--threads=$link_threads"

	export SHELL=/bin/sh
	export BUILD_OFFICIAL=1
	export MOZILLA_OFFICIAL=1
	export USE_SHORT_LIBNAME=1
	export MACH_BUILD_PYTHON_NATIVE_PACKAGE_SOURCE=system
	export MOZ_APP_REMOTINGNAME=firefox-esr
	export MOZBUILD_STATE_PATH="$srcdir"/mozbuild
	# disable desktop notifications
	export MOZ_NOSPAM=1
	# Find our triplet JSON
	export RUST_TARGET="$CTARGET"

	# Build with Clang, takes less RAM
	# make sure we're using same version as llvm
	export CC="clang-$_llvmver"
	export CXX="clang++-$_llvmver"

	# set rpath so linker finds the libs
	export LDFLAGS="$LDFLAGS -Wl,-rpath,$_mozappdir"

	# let firefox do this itself.
	unset CARGO_PROFILE_RELEASE_OPT_LEVEL
	unset CARGO_PROFILE_RELEASE_LTO

	export CBUILD CHOST builddir
	envsubst < "$srcdir"/mozconfig > base-mozconfig

	case "$CARCH" in
	x86|armv7|loongarch64)
		# x86: https://github.com/rust-lang/libc/issues/3476
		# armv7: error: unknown type name 'fpregset_t'
		echo "ac_add_options --disable-crashreporter" >> base-mozconfig
		;;
	esac

	export MOZCONFIG=base-mozconfig
 	./mach build

	# install to where zotero expects it
	DESTDIR="$builddir"/zotero/app/xulrunner/firefox ./mach install
	mv "$builddir"/zotero/app/xulrunner/firefox/usr/lib/firefox-esr/* "$builddir"/zotero/app/xulrunner/firefox/.
	rm -R "$builddir"/zotero/app/xulrunner/firefox/usr

	# zotero build
	(
		cd "$builddir"/zotero
		NODE_OPTIONS=--openssl-legacy-provider npm run build

		SKIP_32=1 app/scripts/dir_build -p l
		# move to seperate folder as check will rebuild with test files added
		mv "$builddir"/zotero/app/staging  "$builddir"/zotero/app/package
	)

	rm -R "$builddir"/zotero/app/xulrunner/firefox # clean-up unused firefox install
}

check() {
	# skip problematic test units
	## should add an epub...: can't find file stub.epub. Suspect broken test unit
	## should download a missing file: tends to fail
	## should download a missing file | should remove a tag...: broken on armv7, needs investigation
	echo "should add an EPUB from a URL with a redirect" > skip-tests
	echo "should download a missing file" >> skip-tests
	case $CARCH in
		armv7)
			echo "should remove a tag when an item is removed from a collection" >> skip-tests
		;;
	esac

	# apply test skip
	while IFS= read -r test; do
		echo "Skipping test: $test"
		sed -i "s|it(\"$test|it.skip(\"$test|" zotero/test/tests/*.js
	done < skip-tests

	# install to where zotero expects it
	DESTDIR="$builddir"/zotero/app/xulrunner/firefox ./mach install
	mv "$builddir"/zotero/app/xulrunner/firefox/usr/lib/firefox-esr/* "$builddir"/zotero/app/xulrunner/firefox/.
	rm -R "$builddir"/zotero/app/xulrunner/firefox/usr

	# zotero test build
	(
		cd "$builddir"/zotero

		NODE_OPTIONS=--openssl-legacy-provider npm run build
		ZOTERO_TEST=1 SKIP_32=1 app/scripts/dir_build -p l
	)

	# test-suite is not very stable, false failure occur from time to time, thus never fails
	CI=true LD_LIBRARY_PATH="$builddir"/zotero/app/staging/Zotero_linux xvfb-run "$builddir"/zotero/test/runtests.sh -x "$builddir"/zotero/app/staging/Zotero_linux/zotero || true

	rm -R "$builddir"/zotero/app/xulrunner/firefox # clean-up unused firefox install
}

package() {
	install -dDm755 "$pkgdir"/usr/bin
	install -dDm755 "$pkgdir"/usr/lib/zotero
	cp -r "$builddir"/zotero/app/package/Zotero_linux/* "$pkgdir/usr/lib/zotero"
	ln -s /usr/lib/zotero/zotero "$pkgdir/usr/bin/zotero"
	install -Dm644 "$srcdir/zotero.desktop" "$pkgdir/usr/share/applications/zotero.desktop"

	# Copy zotero icons to a standard location
	install -Dm644 "$pkgdir/usr/lib/zotero/icons/icon32.png" "$pkgdir/usr/share/icons/hicolor/32x32/apps/zotero.png"
	install -Dm644 "$pkgdir/usr/lib/zotero/icons/icon64.png" "$pkgdir/usr/share/icons/hicolor/64x64/apps/zotero.png"
	install -Dm644 "$pkgdir/usr/lib/zotero/icons/icon128.png" "$pkgdir/usr/share/icons/hicolor/128x128/apps/zotero.png"

	# Close shell when launching
	sed -i -r 's:^("\$CALLDIR/zotero-bin" -app "\$CALLDIR/application.ini" "\$@"):exec \1:' "$pkgdir/usr/lib/zotero/zotero"
}

sha512sums="
7781b1e203130c1cdf2a0c2ecb05a9cfa824c75d467e7faca78b66bd5568c821324112aecb774883d9f447af7fa4ade36488ff1017255af5510c8f641990e472  firefox-140.7.0esr.source.tar.xz
616169325dc7715d3ff558c1846394d992f1a0a9427af5339e84abf3d9e7d85a5f9f6bae218ee3416ef39769a56150ac35881435ac09b976876fd556fddeac38  abseil-cpp.patch
6abf840d5208fcf2a0d6a7d737b843ae2e41e9097e18a0738fa21f7108d5fd6e844a46510b467af10d09b502827757adf79731139ad43c55335468d128649caf  esr-metainfo.patch
32c566a1529d36b4816cef80bb56f0723d0ec2e407e5e4a61cd278d40dafa3a3032d5a77497f191989f4954fa3ee539845dd170a596e0b22c6ef5b337405a72e  bmo-1952657-no-execinfo.patch
19eea840aa9c1c21e7bd1f832ec078989fe6f08fca40baa271be7e74f1cffeb5ab8d3218a93e664b8d90a41506dede524e2a5174cd47580866109bc6711ea969  fix-fortify-system-wrappers.patch
cd68b89e29e5f6379fbd5679db27b9a5ef70ea65e51c0d0a8137e1f1fd210e35a8cfb047798e9549bc7275606d7ec5c8d8af1335d29da4699db7acd8bc7ff556  fix-rust-target.patch
305c874fdea3096e9c4c6aa6520ac64bb1c347c4b59db8360096646593fe684c3b5377874d91cecd33d56d1410b4714fbdea2b514923723ecbeff79d51265d9b  fix-webrtc-glibcisms.patch
e75daab5573ec6e28d3940a9bb98304d572dfb26ce7c1709e99fdd75dfa58abce170c96de683f8dc2224ea2e118aa7d78affbd54f99c4e328a4641685d64bd7d  lfs64.patch
c0437a6753f3f350968fa12d250efdfe1bea77baf0e4c06b072b5cc9e78c774dbf4506bc536337030d349fb3ba4460097b75b0c7c5b8fb2d39d8b0a392948936  no-ccache-stats.patch
1c6918dd6655d3a1251bfd4af2e1c561cbb00d540a883b4c1ebf7f5de530d754d9ac07b4b5f56cdab6c511d25c8910ec94043f5733e97501a67abffe1bafaeb1  rust-lto-thin.patch
b12dbff6513ac8c231d91c257a9accecc034d9ea9c31d99ca0454334ccf80fe7b50d6a356182dc46a9f25064366ea9a177f463cb2544b1cf5368ee6bd71bc095  riscv64-no-lto.patch
f8c3555ef6207933cbffbf4fc101a9b4c0d2990c0063162f0f0bde70ef0b46f86bfac42e7110695183424a87948de593f3927b2d8509ede3e4fc7bd8a1fad1ce  sandbox-sched_setscheduler.patch
67bc0be3da973e6859256bf9be4df7100837430e6076fc0bd623f504c35e02e6c191e9c5a3a1d202e5ad4d89f874f254a09e164e39c7bfd97bbc8d4c8d0632a5  sqlite-ppc.patch
2e2cc51767349576122cc3ca068616e805a7e4b91739f03af3188778b080cfa5b06b1228bc59722d2c2ba70abb8538ea491cd88f9d49b426d8d086184309a1d6  rust1.90-ppc.patch
69afe760bc35ff4767b4264a484b9d2a5d54ef7e4bd3fe49f97c33a962dbfb4464d5763e8e319cbf7cd9505235c26f2dac69b157d108f94b2aab4cb41de9d6a1  icu78.patch
10190908796ea681cb9c7726e5f000d010dc438560f1c9574ad52f91b984c92634291453d4f7cdb3a5b5e54c1968513bf78d4dc44f5befa39d58065d0e9c3326  loong0001-Enable-WebRTC-for-loongarch64.patch
bcc6987568082e5471962fed98110c13f9a81de7bba11cd961c2ac6c1240e677dc141d6834bf5755d2d85fc8251e522920dd3d9afae20ed9d9896b632ee9336f  loong0003-Define-HWCAP_LOONGARCH_LSX_and_LASX.patch
f95b3a8338b34c98ae028278fcec3a1ae48d8de9fa9eed54544151ae994b57b8d0ff0e6363632257d3cbe9452bcd93ade5c139cf728d0a149a038a179a0b4016  loong0004-Fix-ycbcr-chromium_types-warning.patch
0b3f1e4b9fdc868e4738b5c81fd6c6128ce8885b260affcb9a65ff9d164d7232626ce1291aaea70132b3e3124f5e13fef4d39326b8e7173e362a823722a85127  stab.h
382510375b1a2fa79be0ab79e3391a021ae2c022429ffbaa7e7a69166f99bb56d01e59a1b10688592a29238f21c9d6977672bd77f9fae439b66bdfe0c55ddb15  mozilla-location.keys
5ac990fce470485b244831a9121c9349cbd23093a372547aadc3c16f071537ede6f001e0f4c7769b01923e9b94262e99667b6187052df4db167ef36441743f65  vendor-prefs.js
34869e2c490f40160ce1b89ee4a4d9bfbcd18dcddeeaee1fc2eda01b98807ed3c648250124b58b7a14b33458bcbe6b5505a8fe231959cdffb39bd26aabb6faa3  mozconfig
e1a0a4ff5cc1b53f13776ca11927d671426b0691e78e74a4adf2166d57bb2ae8ac409cc11a37ce5e2f680fdf05d5bc3849c33a9717aca1bb62d03ae5231a67fb  zotero.desktop
5cbb430742302ee6958fb10cd843822791908c14866ca99fee5f251358153dca58285e2a67c5354608ef7dcdfbefd352bed2b917cbcd0d5252d0a89615fa8fc4  zotero-8.0.2.tar.gz
78084904b2474bae1fecdb20984f97132fe7b8ff465541efa8f568421e19a23f8604a1603511d6f24c4dd41930eabd0b481c1ea5f372266e9d92089a3b379012  zotero_build-modifications.patch
337070ee4c44ccb35c6b6290c18327740bb9fccfd1a6ad1045782e83daa290b6ced7d53955d3a889f661d588738a64f2e7f383639f4c46be9fdf891168abc9ff  zotero_test-drop-build.patch
f0e4f09496531222e8400959f9ef12852bca269eb3bf4c3b87ccaf92f28a12b9374461a1c79ad294a4393dbe30800aa1c85497033d0bc304fa8c198dfab3efd2  zotero_test-fix-chars.patch
9dc390d8bae42e645cae45fe5551751d8f38d5c1b8b2cc0eec1c2191f4bde293ffb2c67cfc4de765f2d48b1da4d5fcd4f1c03711e5da3180cd1b63710ccf5599  zotero_test-push-timeout-to-30sec.patch
c5ac1226c029295cb70c43e21894da1347cf98c156bd6acdcf77edabe803d7969c8e774e78d67f9b2e730943c09767b6f58e3a976de8cff4aa635e8aae5099a1  zotero_avoid-bash-runtime-dependency.patch
"
