From 00515141c15d1f8368c8b8fb7c1696a32421c2e1 Mon Sep 17 00:00:00 2001
From: Friedemann Kleint <Friedemann.Kleint@qt.io>
Date: Mon, 10 Feb 2025 13:58:49 +0100
Subject: [PATCH] Adapt to 6.10

Task-number: PYSIDE-3011
Change-Id: I0c09b222e68ee0563dc4b0bf07f798f800a63371
Reviewed-by: Shyamnath Premnadh <Shyamnath.Premnadh@qt.io>
---
 coin/dependencies.yaml                        |  2 +-
 sources/pyside6/.cmake.conf                   |  2 +-
 .../PySide6/QtCore/typesystem_core_common.xml | 12 +++++++++++
 .../PySide6/QtGraphs/typesystem_graphs.xml    |  6 +++++-
 sources/pyside6/PySide6/QtGui/CMakeLists.txt  |  2 ++
 .../PySide6/QtGui/typesystem_gui_common.xml   |  6 ++++++
 .../PySide6/QtGui/typesystem_gui_rhi.xml      |  1 +
 .../PySide6/QtMultimedia/CMakeLists.txt       |  1 +
 .../QtMultimedia/typesystem_multimedia.xml    |  5 +++++
 .../pyside6/PySide6/QtSql/typesystem_sql.xml  | 21 +++++++++++++++++++
 .../PySide6/QtWebEngineCore/CMakeLists.txt    |  2 ++
 .../typesystem_webenginecore.xml              |  3 +++
 sources/shiboken6/.cmake.conf                 |  2 +-
 .../shibokensupport/signature/mapping.py      |  5 ++++-
 14 files changed, 65 insertions(+), 5 deletions(-)

diff --git a/sources/pyside6/PySide6/QtCore/typesystem_core_common.xml b/sources/pyside6/PySide6/QtCore/typesystem_core_common.xml
index 7bad50e95f..54e63cb8fe 100644
--- a/sources/pyside6/PySide6/QtCore/typesystem_core_common.xml
+++ b/sources/pyside6/PySide6/QtCore/typesystem_core_common.xml
@@ -621,6 +621,7 @@
     <enum-type name="ConnectionType"/>
     <enum-type name="ContextMenuPolicy"/>
     <enum-type name="ContextMenuTrigger" since="6.8"/>
+    <enum-type name="ContrastPreference" since="6.10"/>
     <enum-type name="CoordinateSystem"/>
     <enum-type name="Corner"/>
     <enum-type name="CursorShape"/>
@@ -970,6 +971,14 @@
     <enum-type name="Filter" flags="Filters"/>
     <enum-type name="SortFlag" flags="SortFlags"/>
 
+    <declare-function signature="mkdir(QString)const" return-type="bool"/>
+    <declare-function signature="mkdir(QString,QFileDevice::Permissions)const" return-type="bool"/>
+    <modify-function signature="mkdir(QString,std::optional&lt;QFileDevice::Permissions&gt;)const" remove="all"/>
+
+    <declare-function signature="mkpath(QString)const" return-type="bool"/>
+    <declare-function signature="mkpath(QString,QFileDevice::Permissions)const" return-type="bool"/>
+    <modify-function signature="mkpath(QString,std::optional&lt;QFileDevice::Permissions&gt;)const" remove="all"/>
+
     <!-- PYSIDE-1499: Replace QString by pathlib.Path (qdir.h) -->
     <modify-function signature="QDir(const QString &amp;)">
       <modify-argument index="1" pyi-type="Optional[PyPathLike]">
@@ -1770,6 +1779,7 @@
       <include file-name="QStringList" location="global"/>
       <include file-name="QSize" location="global"/>
     </extra-includes>
+    <enum-type name="Direction" flags="Directions" since="6.10"/>
     <modify-function signature="setSourceModel(QAbstractItemModel*)">
       <modify-argument index="1">
         <reference-count action="set"/>
@@ -3147,6 +3157,7 @@
     <enum-type name="ReadElementTextBehaviour"/>
   </object-type>
   <object-type name="QXmlStreamWriter">
+    <enum-type name="Error" since="6.10"/>
     <!-- Removed because it expect QString to be mutable -->
     <modify-function signature="QXmlStreamWriter(QString*)" remove="all"/>
   </object-type>
@@ -3168,6 +3179,7 @@
       <configuration condition="QT_CONFIG(future)"/>
       <enum-type name="State"/>
       <enum-type name="CancelMode" since="6.3"/>
+      <enum-type name="ContinuationType" since="6.10"/>
   </object-type>
   <value-type name="QFuture" generate="no">
       <include file-name="QtCore/qfuture.h" location="global"/>
diff --git a/sources/pyside6/PySide6/QtGraphs/typesystem_graphs.xml b/sources/pyside6/PySide6/QtGraphs/typesystem_graphs.xml
index 81485a706a..ba0a8a486c 100644
--- a/sources/pyside6/PySide6/QtGraphs/typesystem_graphs.xml
+++ b/sources/pyside6/PySide6/QtGraphs/typesystem_graphs.xml
@@ -23,6 +23,7 @@
      <enum-type name="ShadowQuality"/>
      <enum-type name="TransparencyTechnique" since="6.7"/>
      <enum-type name="CameraPreset" since="6.7"/>
+     <enum-type name="SliceCaptureType" since="6.10"/>
    </namespace-type>
 
    <value-type name="QGraphsLine" since="6.8">
@@ -54,6 +55,7 @@
   <object-type name="QAbstract3DSeries">
     <enum-type name="Mesh"/>
     <enum-type name="SeriesType"/>
+    <enum-type name="LightingMode" since="6.10"/>
   </object-type>
   <object-type name="QAbstractDataProxy">
     <enum-type name="DataType"/>
@@ -98,7 +100,9 @@
     </modify-function>
   </object-type>
   <object-type name="QPieModelMapper" since="6.8"/>
-  <object-type name="QPieSeries" since="6.8"/>
+  <object-type name="QPieSeries" since="6.8">
+    <enum-type name="LabelVisibility" since="6.10"/>
+  </object-type>
   <object-type name="QPieSlice" since="6.8">
       <enum-type name="LabelPosition"/>
   </object-type>
diff --git a/sources/pyside6/PySide6/QtGui/CMakeLists.txt b/sources/pyside6/PySide6/QtGui/CMakeLists.txt
index 64e5f1f8bf..b9e842912b 100644
--- a/sources/pyside6/PySide6/QtGui/CMakeLists.txt
+++ b/sources/pyside6/PySide6/QtGui/CMakeLists.txt
@@ -19,6 +19,7 @@ set_property(SOURCE ${QtGui_SRC_UNITY_EXCLUDED_SRC}
 
 set(QtGui_SRC_RHI
 ${QtGui_GEN_DIR}/qrhi_wrapper.cpp
+${QtGui_GEN_DIR}/qrhiadapter_wrapper.cpp
 ${QtGui_GEN_DIR}/qrhibuffer_wrapper.cpp
 ${QtGui_GEN_DIR}/qrhicolorattachment_wrapper.cpp
 ${QtGui_GEN_DIR}/qrhicommandbuffer_wrapper.cpp
@@ -84,6 +85,7 @@ ${QtGui_GEN_DIR}/qabstractfileiconprovider_wrapper.cpp
 ${QtGui_GEN_DIR}/qabstracttextdocumentlayout_paintcontext_wrapper.cpp
 ${QtGui_GEN_DIR}/qabstracttextdocumentlayout_selection_wrapper.cpp
 ${QtGui_GEN_DIR}/qabstracttextdocumentlayout_wrapper.cpp
+${QtGui_GEN_DIR}/qaccessibilityhints_wrapper.cpp
 ${QtGui_GEN_DIR}/qaccessible_wrapper.cpp
 ${QtGui_GEN_DIR}/qaccessibleactioninterface_wrapper.cpp
 ${QtGui_GEN_DIR}/qaccessibleannouncementevent_wrapper.cpp
diff --git a/sources/pyside6/PySide6/QtGui/typesystem_gui_common.xml b/sources/pyside6/PySide6/QtGui/typesystem_gui_common.xml
index 9f521a0043..3f4e307807 100644
--- a/sources/pyside6/PySide6/QtGui/typesystem_gui_common.xml
+++ b/sources/pyside6/PySide6/QtGui/typesystem_gui_common.xml
@@ -10,6 +10,11 @@
   <load-typesystem name="templates/gui_common.xml" generate="no"/>
 
   <rejection class="^Q.*$" argument-type="^QPlatform.*$"/>
+
+  <extra-includes>
+      <include file-name="QtGui/qquaternion.h" location="global"/> <!-- for qFuzzyCompare -->
+  </extra-includes>
+
   <function signature="qAlpha(uint)"/>
   <function signature="qBlue(uint)"/>
   <function signature="qGray(int,int,int)"/>
@@ -120,6 +125,7 @@
       </add-function>
   </value-type>
 
+  <object-type name="QAccessibilityHints" since="6.10"/>
   <object-type name="QAccessibleActionInterface"/>
   <object-type name="QAccessibleAttributesInterface" since="6.8"/>
   <object-type name="QAccessibleEditableTextInterface"/>
diff --git a/sources/pyside6/PySide6/QtGui/typesystem_gui_rhi.xml b/sources/pyside6/PySide6/QtGui/typesystem_gui_rhi.xml
index 656f18ca4e..29e9789f58 100644
--- a/sources/pyside6/PySide6/QtGui/typesystem_gui_rhi.xml
+++ b/sources/pyside6/PySide6/QtGui/typesystem_gui_rhi.xml
@@ -4,6 +4,7 @@
 // SPDX-License-Identifier: LicenseRef-Qt-Commercial OR LGPL-3.0-only OR GPL-2.0-only OR GPL-3.0-only
 -->
 <typesystem package="PySide6.QtGui">
+  <object-type name="QRhiAdapter" since="6.10" private="yes"/>
   <value-type name="QRhiDepthStencilClearValue" since="6.6" private="yes"/>
   <value-type name="QRhiViewport" since="6.6" private="yes"/>
   <value-type name="QRhiScissor" since="6.6" private="yes"/>
diff --git a/sources/pyside6/PySide6/QtMultimedia/CMakeLists.txt b/sources/pyside6/PySide6/QtMultimedia/CMakeLists.txt
index 8e6d3e3ce8..32b218ff91 100644
--- a/sources/pyside6/PySide6/QtMultimedia/CMakeLists.txt
+++ b/sources/pyside6/PySide6/QtMultimedia/CMakeLists.txt
@@ -31,6 +31,7 @@ ${QtMultimedia_GEN_DIR}/qmediaplayer_wrapper.cpp
 ${QtMultimedia_GEN_DIR}/qmediarecorder_wrapper.cpp
 ${QtMultimedia_GEN_DIR}/qmediatimerange_wrapper.cpp
 ${QtMultimedia_GEN_DIR}/qmediatimerange_interval_wrapper.cpp
+${QtMultimedia_GEN_DIR}/qplaybackoptions_wrapper.cpp
 ${QtMultimedia_GEN_DIR}/qscreencapture_wrapper.cpp
 ${QtMultimedia_GEN_DIR}/qsoundeffect_wrapper.cpp
 ${QtMultimedia_GEN_DIR}/qtvideo_wrapper.cpp
diff --git a/sources/pyside6/PySide6/QtMultimedia/typesystem_multimedia.xml b/sources/pyside6/PySide6/QtMultimedia/typesystem_multimedia.xml
index 18082888bf..b04c2fc3c0 100644
--- a/sources/pyside6/PySide6/QtMultimedia/typesystem_multimedia.xml
+++ b/sources/pyside6/PySide6/QtMultimedia/typesystem_multimedia.xml
@@ -125,6 +125,7 @@
     </value-type>
     <object-type name="QMediaPlayer">
         <enum-type name="MediaStatus"/>
+        <enum-type name="PitchCompensationAvailability" since="6.10"/>
         <enum-type name="PlaybackState" since="6.1"/>
         <enum-type name="Error"/>
         <enum-type name="Loops" python-type="IntEnum" since="6.2.3"/>
@@ -143,6 +144,10 @@
         <value-type name="Interval"/>
     </value-type>
 
+    <value-type name="QPlaybackOptions" since="6.10">
+        <enum-type name="PlaybackIntent"/>
+    </value-type>
+
     <object-type name="QScreenCapture" since="6.5">
         <enum-type name="Error"/>
     </object-type>
diff --git a/sources/pyside6/PySide6/QtSql/typesystem_sql.xml b/sources/pyside6/PySide6/QtSql/typesystem_sql.xml
index 70c3e6f695..451c191dd3 100644
--- a/sources/pyside6/PySide6/QtSql/typesystem_sql.xml
+++ b/sources/pyside6/PySide6/QtSql/typesystem_sql.xml
@@ -20,6 +20,7 @@
     </extra-includes>
   </namespace-type>
 
+  <value-type name="QSqlDatabaseDefaultConnectionName" generate="no"/>
   <value-type name="QSqlDatabase">
     <extra-includes>
         <include file-name="QSqlQuery" location="global"/>
@@ -29,6 +30,26 @@
         <include file-name="QStringList" location="global"/>
         <include file-name="QSize" location="global"/>
     </extra-includes>
+    <modify-function signature="addDatabase(QString,QString)">
+        <modify-argument index="2">
+            <replace-default-expression with="QSqlDatabase::defaultConnectionName()"/>
+        </modify-argument>
+    </modify-function>
+    <modify-function signature="addDatabase(QSqlDriver*,QString)">
+        <modify-argument index="2">
+            <replace-default-expression with="QSqlDatabase::defaultConnectionName()"/>
+        </modify-argument>
+    </modify-function>
+    <modify-function signature="contains(QString)">
+        <modify-argument index="1">
+            <replace-default-expression with="QSqlDatabase::defaultConnectionName()"/>
+        </modify-argument>
+    </modify-function>
+    <modify-function signature="database(QString,bool)">
+        <modify-argument index="1">
+            <replace-default-expression with="QSqlDatabase::defaultConnectionName()"/>
+        </modify-argument>
+    </modify-function>
     <modify-function signature="exec(QString)const" allow-thread="yes"/>
     <add-function signature="exec_(QString @query@ = QString())const" return-type="QSqlQuery">
         <inject-code file="../glue/qtsql.cpp" snippet="qsqldatabase-exec"/>
diff --git a/sources/pyside6/PySide6/QtWebEngineCore/CMakeLists.txt b/sources/pyside6/PySide6/QtWebEngineCore/CMakeLists.txt
index 7afb9ef108..4d934438d2 100644
--- a/sources/pyside6/PySide6/QtWebEngineCore/CMakeLists.txt
+++ b/sources/pyside6/PySide6/QtWebEngineCore/CMakeLists.txt
@@ -20,6 +20,8 @@ ${QtWebEngineCore_GEN_DIR}/qwebenginecookiestore_wrapper.cpp
 ${QtWebEngineCore_GEN_DIR}/qwebenginecookiestore_filterrequest_wrapper.cpp
 ${QtWebEngineCore_GEN_DIR}/qwebenginedesktopmediarequest_wrapper.cpp
 ${QtWebEngineCore_GEN_DIR}/qwebenginedownloadrequest_wrapper.cpp
+${QtWebEngineCore_GEN_DIR}/qwebengineextensioninfo_wrapper.cpp
+${QtWebEngineCore_GEN_DIR}/qwebengineextensionmanager_wrapper.cpp
 ${QtWebEngineCore_GEN_DIR}/qwebenginefilesystemaccessrequest_wrapper.cpp
 ${QtWebEngineCore_GEN_DIR}/qwebenginefindtextresult_wrapper.cpp
 ${QtWebEngineCore_GEN_DIR}/qwebengineframe_wrapper.cpp
diff --git a/sources/pyside6/PySide6/QtWebEngineCore/typesystem_webenginecore.xml b/sources/pyside6/PySide6/QtWebEngineCore/typesystem_webenginecore.xml
index 003c18deb0..3c15f4ee4d 100644
--- a/sources/pyside6/PySide6/QtWebEngineCore/typesystem_webenginecore.xml
+++ b/sources/pyside6/PySide6/QtWebEngineCore/typesystem_webenginecore.xml
@@ -52,6 +52,9 @@
     <enum-type name="SavePageFormat"/>
   </object-type>
 
+  <object-type name="QWebEngineExtensionInfo" since="6.10"/>
+  <object-type name="QWebEngineExtensionManager" since="6.10"/>
+
   <value-type name="QWebEngineFileSystemAccessRequest">
     <enum-type name="AccessFlag" flags="AccessFlags"/>
     <enum-type name="HandleType"/>
diff --git a/sources/shiboken6/shibokenmodule/files.dir/shibokensupport/signature/mapping.py b/sources/shiboken6/shibokenmodule/files.dir/shibokensupport/signature/mapping.py
index 54fa21ff89..a175fb5eea 100644
--- a/sources/shiboken6/shibokenmodule/files.dir/shibokensupport/signature/mapping.py
+++ b/sources/shiboken6/shibokenmodule/files.dir/shibokensupport/signature/mapping.py
@@ -266,6 +266,7 @@ def check_module(mod):
     "QSet": typing.Set,
     "QString": str,
     "QLatin1String": str,
+    "QAnyStringView": str,
     "QStringView": str,
     "QStringList": StringList,
     "quint16": int,
@@ -542,6 +543,8 @@ def init_PySide6_QtCore():
         "QVariant.Type": type,  # not so sure here...
         "QVariantMap": typing.Dict[str, Variant],
         "std.chrono.seconds{5}" : ellipsis,
+        "Internal.defaultTryTimeout": 5000,
+        "static_cast<int>(Internal.defaultTryTimeout.count())": 5000
     })
     from shibokensupport.signature.parser import using_snake_case
     if using_snake_case():
@@ -624,7 +627,7 @@ def init_PySide6_QtWidgets():
 def init_PySide6_QtSql():
     from PySide6.QtSql import QSqlDatabase
     type_map.update({
-        "QLatin1StringView(QSqlDatabase.defaultConnection)": QSqlDatabase.defaultConnection,
+        "QSqlDatabase.defaultConnectionName()": "",
         "QVariant.Invalid": Invalid("Variant"),  # not sure what I should create, here...
     })
     return locals()
