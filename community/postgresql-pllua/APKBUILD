# Contributor: Michael Mason <ms13sp@gmail.com>
# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Michael Mason <ms13sp@gmail.com>
pkgname=postgresql-pllua
pkgver=2.0.12
_pkgver="REL_${pkgver//./_}"
pkgrel=3
pkgdesc="Procedural language for PostgreSQL using Lua"
url="https://github.com/RhodiumToad/pllua-ng"
# riscv64: limited by luajit
arch="all !riscv64"
license="MIT"
makedepends="postgresql-dev postgresql luajit-dev"
options="!check"  # tests require running PostgreSQL
provides="pllua=$pkgver-r$pkgrel"  # for backward compatibility
replaces="pllua"  # for backward compatibility
subpackages="$pkgname-dev"
source="https://github.com/RhodiumToad/pllua-ng/archive/$_pkgver/pllua-ng-$_pkgver.tar.gz
	pgsql18-compat.patch
	"
builddir="$srcdir/pllua-ng-$_pkgver"

build() {
	_make
}

package() {
	depends="postgresql$(pg_config --major-version)"

	_make DESTDIR="$pkgdir" install
}

_make() {
	make \
		LUAJIT=luajit \
		LUA_INCDIR="$(pkgconf --variable=includedir luajit)" \
		LUALIB="$(pkgconf --libs luajit)" \
		USE_PGXS=1 \
		"$@"
}

sha512sums="
c27892e12cabc406e320537827c46b8ed5eb7d6ba8bffffca56300664edd68da2bddf6d9abe1c272732a5fc0d468dc9b0b030c52acc4fb14539a36483064ae20  pllua-ng-REL_2_0_12.tar.gz
ce8113bc54e95ba0e65954edea2f39551528acb686bdc597e71f2ca463ba938d2c56b574b46461aa6ec85a82cdeb25c80b7825bd163461674dda90a894678602  pgsql18-compat.patch
"
