# Contributor: Kevin Wang <kevin@muxable.com>
# Maintainer: Kevin Wang <kevin@muxable.com>
pkgname=librist
pkgver=0.2.11
pkgrel=0
pkgdesc="Reliable Internet Stream Transport (RIST)"
url="https://www.rist.tv/"
arch="all"
license="BSD-2-Clause"
makedepends="meson linux-headers cjson-dev mbedtls-dev"
checkdepends="cmocka-dev"
subpackages="$pkgname-progs $pkgname-dev"
source="$pkgname-$pkgver.tar.gz::https://code.videolan.org/rist/librist/-/archive/v$pkgver/librist-v$pkgver.tar.gz"
builddir="$srcdir/librist-v$pkgver"

build() {
	abuild-meson build
	meson compile -C build
}

check() {
	# Tests are flaky & will fail if packets do not arrive in exact order.
	# This often leads to having to retry the whole CI pipeline for s390x.
	# Hopefully, repeating tests 3 times before failing will prevent that.
	local i; for i in $(seq 0 3); do
		[ $i -eq 0 ] || msg "Retrying ($i/3)..."
		meson test --print-errorlogs -C build && return 0
		sleep 1
	done
	return 1
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C build
}

progs() {
	pkgdesc="Tools for working with RIST"
	depends=""
	amove usr/bin
}

sha512sums="
2038d085a3f0d52ac8ebdef7eebb9eaa30649581cff83f60b7128ad0b8efec398a5f606157869c2c3bf0a0011e50360f38cb04d2ad5e9885fefaa5b9fc9a817a  librist-0.2.11.tar.gz
"
