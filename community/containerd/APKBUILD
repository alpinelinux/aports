# Contributor: Jake Buchholz Göktürk <tomalok@gmail.com>
# Maintainer: Jake Buchholz Göktürk <tomalok@gmail.com>

pkgname=containerd

# NOTE: containerd's Makefile tries to get REVISION from git, but we're building from a tarball.
_commit=1c4457e00facac03ce1d75f7b6777a7a851e5c41
pkgver=2.2.0
pkgrel=3
pkgdesc="An open and reliable container runtime"
url="https://containerd.io/"
arch="all"
license="Apache-2.0"
depends="runc"
makedepends="btrfs-progs-dev go go-md2man libseccomp-dev log_proxy"
subpackages="
	$pkgname-ctr
	$pkgname-doc
	$pkgname-openrc
	$pkgname-stress
	$pkgname-systemd
"
source="containerd-$pkgver.tar.gz::https://github.com/containerd/containerd/archive/v$pkgver.tar.gz
	containerd.confd
	containerd.initd
"
options="net"

# secfixes:
#   2.1.1-r0:
#     - CVE-2025-47290
#   1.6.18-r0:
#     - CVE-2023-25153
#     - CVE-2023-25173
#   1.6.12-r0:
#     - CVE-2022-23471
#   1.6.6-r0:
#     - CVE-2022-31030
#   1.6.2-r0:
#     - CVE-2022-24769
#   1.6.1-r0:
#     - CVE-2022-23648
#   1.5.9-r0:
#     - CVE-2021-43816
#   1.5.8-r0:
#     - CVE-2021-41190
#   1.5.7-r0:
#     - CVE-2021-41103
#   1.5.4-r0:
#     - CVE-2021-32760
#   1.4.4-r0:
#     - CVE-2021-21334
#   1.4.3-r0:
#     - CVE-2020-15257
#   1.3.3-r0:
#     - CVE-2019-19921
#     - CVE-2020-0601
#     - CVE-2020-7919
#     - CVE-2019-11253
#   1.3.1-r0:
#     - CVE-2019-17596
#   1.3.0-r0:
#     - CVE-2019-16884
#   1.2.9-r0:
#     - CVE-2019-9512
#     - CVE-2019-9514
#     - CVE-2019-9515
#   1.2.6-r0:
#     - CVE-2019-9946

export GOFLAGS="$GOFLAGS -modcacherw -mod=readonly"
export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

build() {
	export GO111MODULE=on
	case "$CARCH" in loongarch64)
		# upgrade ebpf for loongarch64
		go get -u github.com/cilium/ebpf@v0.11.0
		;;
	esac

	go mod tidy

	make SHIM_CGO_ENABLED=1 VERSION="v$pkgver" REVISION="$_commit" BUILDMODE=pie
	make man
}

check() {
	./bin/containerd --version
}

package() {
	install -d "$pkgdir"/usr/bin/
	install -Dsm755 ./bin/* "$pkgdir"/usr/bin/
	# useless binary only to make manpages
	rm "$pkgdir"/usr/bin/gen-manpages

	install -Dm755 "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -Dm644 "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname
	install -Dm644 containerd.service \
		-t "$pkgdir"/usr/lib/systemd/system/

	install -d "$pkgdir"/usr/share/man/man5/
	install -Dm644 "$builddir"/man/*.5 "$pkgdir"/usr/share/man/man5/
	install -d "$pkgdir"/usr/share/man/man8/
	install -Dm644 "$builddir"/man/*.8 "$pkgdir"/usr/share/man/man8/
	install -d "$pkgdir"/etc/containerd/
	"$pkgdir"/usr/bin/containerd config default | sed "s|/opt/cni/bin|/usr/libexec/cni|g" > "$pkgdir"/etc/containerd/config.toml

}

openrc() {
	default_openrc
	depends="log_proxy"
	install_if="openrc $pkgname=$pkgver-r$pkgrel"
}

ctr() {
	pkgdesc="unsupported debug/admin client for containerd"
	amove usr/bin/ctr
}

stress() {
	pkgdesc="containerd-stress utility"
	amove usr/bin/containerd-stress
}

sha512sums="
3121a1e0401e0283ff9d8454e945b427bcb0214e7e67271815117cb82dee1488c4d963c2193eb9c0ab5d395dd2e2705975ac31ce3e400264933d05d62fd0faac  containerd-2.2.0.tar.gz
5fb37b88554422738cc75b944b75836c123d87d418a16c6a25b9d49da023bd0e654d1aa694e60026de42c055ccf7469f5b4778a4876e94720ec2f40d618db580  containerd.confd
c7b3be864da47ab8492f13570cc984233c5635a2d7eda00d8dae46d61981761cd62cd4c39dfcbb117166e0760e8e7bb5bd64568b103c8193002970b0faf6558c  containerd.initd
"
