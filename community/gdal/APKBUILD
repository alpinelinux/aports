# Contributor: Trevor R.H. Clarke <trevor@notcows.com>
# Contributor: Holger Jaekel <holger.jaekel@gmx.de>
maintainer="Holger Jaekel <holger.jaekel@gmx.de>"
pkgname=gdal
pkgver=3.12.1
pkgrel=3
pkgdesc="A translator library for raster and vector geospatial data formats"
url="https://gdal.org/"
arch="all"
license="MIT"
makedepends="
	apache-arrow-dev
	armadillo-dev
	basisu-dev
	bison
	blosc-dev
	brunsli-dev
	cfitsio-dev
	cmake
	curl-dev
	expat-dev
	exprtk
	freexl-dev
	geos-dev
	giflib-dev
	gnu-libiconv-dev
	hdf5-dev
	json-c-dev
	kealib-dev
	libaec-dev
	libarchive-dev
	libavif-dev
	libdeflate-dev
	libgeotiff-dev
	libheif-dev
	libjpeg-turbo-dev
	libjxl-dev
	libkml-dev
	libopendrive-dev
	libpng-dev
	libpq-dev
	libspatialite-dev
	libtirpc-dev
	libwebp-dev
	libxml2-dev
	linux-headers
	lz4-dev
	mariadb-dev
	muparser-dev
	odbc-cpp-wrapper-dev
	openexr-dev
	openjpeg-dev
	openssl-dev
	poppler-dev
	proj-dev
	py3-numpy-dev
	py3-setuptools
	python3-dev
	qhull-dev
	samurai
	sfcgal-dev
	sqlite-dev
	swig
	tiff-dev
	unixodbc-dev
	xerces-c-dev
	zlib-dev
	zstd-dev
	"
checkdepends="
	py3-pytest
	"
subpackages="
	$pkgname-dev
	py3-$pkgname-pyc
	py3-$pkgname:_py3
	$pkgname-tools
	$pkgname-doc
	$pkgname-bash-completion
	$pkgname-driver-all:_gdal_driver_all:noarch
	$pkgname-driver-basisu_ktx2:_driver
	$pkgname-driver-exr:_driver
	$pkgname-driver-fits:_driver
	$pkgname-driver-gif:_driver
	$pkgname-driver-hdf5:_driver
	$pkgname-driver-heif:_driver
	$pkgname-driver-jp2openjpeg:_driver
	$pkgname-driver-jpeg:_driver
	$pkgname-driver-jpegxl:_driver
	$pkgname-driver-kea:_driver
	$pkgname-driver-pcidsk:_driver
	$pkgname-driver-pcraster:_driver
	$pkgname-driver-pdf:_driver
	$pkgname-driver-png:_driver
	$pkgname-driver-postgisraster:_driver
	$pkgname-driver-webp:_driver
	$pkgname-driver-wms:_driver
	$pkgname-driver-cad:_driver
	$pkgname-driver-carto:_driver
	$pkgname-driver-elastic:_driver
	$pkgname-driver-gmlas:_driver
	$pkgname-driver-hana:_driver
	$pkgname-driver-libkml:_driver
	$pkgname-driver-mssqlspatial:_driver
	$pkgname-driver-mysql:_driver
	$pkgname-driver-odbc:_driver
	$pkgname-driver-pg:_driver
	$pkgname-driver-plscenes:_driver
	$pkgname-driver-vfk:_driver
	$pkgname-driver-xls:_driver
	$pkgname-driver-xodr:_driver
	$pkgname-driver-arrow:_driver
	$pkgname-driver-parquet:_driver
	"
source="https://download.osgeo.org/gdal/$pkgver/gdal-$pkgver.tar.gz
	10-atoll.patch
	20-plugin_installation_message.patch
	30-pugixml.patch
	"

# secfixes:
#   3.10.3-r0:
#     - CVE-2025-29480

# Optional dependency netcdf-dev is not available on s390x
_with_netcdf="OFF"
case "$CARCH" in
	s390x) ;;
	*)
		makedepends="$makedepends netcdf-dev"
		subpackages="$subpackages $pkgname-driver-netcdf:_driver"
		_with_netcdf="ON";;
esac

# Optional dependency lerc-dev is not available on s390x
_with_lerc="OFF"
case "$CARCH" in
	s390x) ;;
	*)
		makedepends="$makedepends lerc-dev"
		_with_lerc="ON";;
esac

# Optional dependency librasterlite2-dev is only available on x86 and x86_64
_with_librasterlite2="OFF"
case "$CARCH" in
	x86|x86_64)
		makedepends="$makedepends librasterlite2-dev"
		_with_librasterlite2="ON"
		;;
esac

# Optional dependency apache-ant is not available on riscv64
case "$CARCH" in
	riscv64)
		_with_java="OFF"
		;;
	*)
		makedepends="$makedepends apache-ant java-jdk"
		subpackages="$subpackages java-$pkgname:_java"
		_with_java="ON"
		_java_home="/usr/lib/jvm/default-jvm"
		_java_include_path="$_java_home/include"
		_java_include_path2="$_java_home/include/linux"
		_java_awt_library="$_java_home/lib/libjawt.so"
		_java_jvm_library="$_java_home/lib/server/libjvm.so"
		;;
esac

# Optional dependency tiledb-dev is not available on s390x and 32-bit platforms
_with_tiledb="OFF"
case "$CARCH" in
armhf|armv7|x86|s390x) ;;
*)
	makedepends="$makedepends tiledb-dev"
	subpackages="$subpackages $pkgname-driver-tiledb:_driver"
	_with_tiledb="ON"
	;;
esac

# Optional dependency libqb3-dev is not available on s390x and 32-bit platforms
case "$CARCH" in
armhf|armv7|x86|s390x) ;;
*)
	makedepends="$makedepends libqb3-dev"
	;;
esac

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		local crossopts="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi

	local i name
	for i in $subpackages; do
		i=${i%%:*}
		case "$i" in
			*-driver-*)
				name=$(echo "${i#"$pkgname-driver-"}" | tr '[:lower:]' '[:upper:]')
				export "GDAL_DRIVER_${name}_PLUGIN_INSTALLATION_MESSAGE=You may install it with 'apk add $i'"
				export "OGR_DRIVER_${name}_PLUGIN_INSTALLATION_MESSAGE=You may install it with 'apk add $i'"
				;;
		esac
	done

	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_CXX_STANDARD=17 \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DENABLE_IPO=OFF \
		-DGDAL_USE_ARMADILLO=ON \
		-DGDAL_USE_ARROW=ON \
		-DGDAL_USE_BASISU=ON \
		-DGDAL_USE_BLOSC=ON \
		-DGDAL_USE_BRUNSLI=ON \
		-DGDAL_USE_CFITSIO=ON \
		-DGDAL_USE_CRNLIB=OFF \
		-DGDAL_USE_CRYPTOPP=OFF \
		-DGDAL_USE_CURL=ON \
		-DGDAL_USE_DEFLATE=ON \
		-DGDAL_USE_EXPAT=ON \
		-DGDAL_USE_FILEGDB=OFF \
		-DGDAL_USE_FREEXL=ON \
		-DGDAL_USE_FYBA=OFF \
		-DGDAL_USE_GEOS=ON \
		-DGDAL_USE_GEOTIFF=ON \
		-DGDAL_USE_GIF=ON \
		-DGDAL_USE_GTA=OFF \
		-DGDAL_USE_HDF4=OFF \
		-DGDAL_USE_HDF5=ON \
		-DGDAL_USE_HDFS=OFF \
		-DGDAL_USE_HEIF=ON \
		-DGDAL_USE_ICONV=ON \
		-DGDAL_USE_IDB=OFF \
		-DGDAL_USE_JPEG=ON \
		-DGDAL_USE_JSONC=ON \
		-DGDAL_USE_JXL=ON \
		-DGDAL_USE_KDU=OFF \
		-DGDAL_USE_KEA=ON \
		-DGDAL_USE_LERC=$_with_lerc \
		-DGDAL_USE_LIBKML=ON \
		-DGDAL_USE_LIBLZMA=ON \
		-DGDAL_USE_LIBXML2=ON \
		-DGDAL_USE_LZ4=ON \
		-DGDAL_USE_MONGOCXX=OFF \
		-DGDAL_USE_MRSID=OFF \
		-DGDAL_USE_MSSQL_NCLI=OFF \
		-DGDAL_USE_MSSQL_ODBC=OFF \
		-DGDAL_USE_MYSQL=ON \
		-DGDAL_USE_NETCDF=$_with_netcdf \
		-DGDAL_USE_ODBC=ON \
		-DGDAL_USE_ODBCCPP=ON \
		-DGDAL_USE_OPENCAD=OFF \
		-DGDAL_USE_OPENDRIVE=ON \
		-DGDAL_USE_OPENEXR=ON \
		-DGDAL_USE_OPENJPEG=ON \
		-DGDAL_USE_OPENSSL=ON \
		-DGDAL_USE_ORACLE=OFF \
		-DGDAL_USE_PARQUET=ON \
		-DGDAL_USE_PCRE2=ON \
		-DGDAL_USE_PDFIUM=OFF \
		-DGDAL_USE_PNG=ON \
		-DGDAL_USE_POPPLER=ON \
		-DGDAL_USE_POSTGRESQL=ON \
		-DGDAL_USE_QHULL=ON \
		-DGDAL_USE_RASTERLITE2=$_with_librasterlite2 \
		-DGDAL_USE_SFCGAL=ON \
		-DGDAL_USE_SPATIALITE=ON \
		-DGDAL_USE_SQLITE3=ON \
		-DGDAL_USE_TEIGHA=OFF \
		-DGDAL_USE_TIFF=ON \
		-DGDAL_USE_TILEDB=$_with_tiledb \
		-DGDAL_USE_WEBP=ON \
		-DGDAL_USE_XERCESC=ON \
		-DGDAL_USE_ZLIB=ON \
		-DGDAL_USE_ZSTD=ON \
		-DGDAL_ENABLE_PLUGINS=ON \
		-DBUILD_PYTHON_BINDINGS=ON \
		-DBUILD_CSHARP_BINDINGS=OFF \
		-DBUILD_JAVA_BINDINGS=$_with_java \
		-DJAVA_HOME="$_java_home" \
		-DJAVA_INCLUDE_PATH="$_java_include_path" \
		-DJAVA_INCLUDE_PATH2="$_java_include_path2" \
		-DJAVA_AWT_LIBRARY="$_java_awt_library" \
		-DJAVA_JVM_LIBRARY="$_java_jvm_library" \
		-DGDAL_USE_TIFF_INTERNAL=ON \
		-DGDAL_USE_GEOTIFF_INTERNAL=ON \
		-DIconv_INCLUDE_DIR=/usr/include/gnu-libiconv \
		-DIconv_LIBRARY=/usr/lib/libiconv.so \
		-DlibQB3_DIR=/usr/lib/cmake \
		-DOpenDrive_DIR=/usr/lib/cmake \
		$crossopts
	cmake --build build
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

_py3() {
	pkgdesc="$pkgdesc (Python3 bindings)"
	depends="py3-numpy"

	amove usr/lib/python3*
}

_java() {
	pkgdesc="$pkgdesc (Java bindings)"
	amove "usr/share/java/gdal-$pkgver.jar"
	cd "$subpkgdir/usr/share/java/"
	ln -s gdal-$pkgver.jar gdal.jar

	mv "$pkgdir/usr/lib/jni/libgdalalljni.so" "$pkgdir/usr/lib/libgdalalljni.so"
	amove "usr/lib/libgdalalljni.so"
}

_driver() {
	local name="${subpkgname#"$pkgname"-driver-}"

	local file="$builddir"/frmts/$name/${name%_*}drivercore.cpp
	if ! [ -f "$file" ]; then
		file="$builddir"/ogr/ogrsf_frmts/$name/ogr${name}drivercore.cpp
	fi
	case "$name" in
		jp2openjpeg) file="$builddir"/frmts/openjpeg/openjpegdrivercore.cpp ;;
		arrow) file="$builddir"/ogr/ogrsf_frmts/$name/ogrfeatherdrivercore.cpp ;;
	esac
	pkgdesc="$pkgdesc ($(
		sed -n -e '/GDAL_DMD_LONGNAME/{ :l; /"/!{ n; t l } s/^[^"]*"//; s/"[^*]*$//; p; q }' < "$file"
	) driver)"

	local file="$(cd "$pkgdir"; find usr/lib/gdalplugins -iname "*_$name.so")"
	local libname="${file#*_}"
	libname="${libname%.so}"

	# Package name with uppercase letters for backward compatibility (Alpine <3.20).
	[ "$subpkgname" != "$pkgname-driver-$libname" ] \
		&& provides="$pkgname-driver-$libname=$pkgver-r$pkgrel"

	amove "$file"
}

_gdal_driver_all() {
	pkgdesc="$pkgdesc (all drivers)"
	depends=
	local i
	for i in $subpackages; do
		i=${i%:*}
		case "$i" in
			*-driver-all) ;;
			*-driver-*) depends="$depends $i=$pkgver-r$pkgrel" ;;
		esac
	done

	mkdir -p "$subpkgdir"
}

tools() {
	pkgdesc="$pkgdesc (command line utilities)"
	depends="py3-$pkgname"

	install -Dm755 -t "$subpkgdir/usr/bin/" \
		"$builddir"/swig/python/gdal-utils/scripts/*.py

	amove usr/bin/*
}

check() {
	# TODO: https://trac.osgeo.org/gdal/wiki/TestingNotes

	chmod a+x build/apps/gdal-config
	build/apps/gdal-config --version | grep -q "$pkgver"

	# confirms MBTiles support
	build/apps/gdal_translate --formats | grep "MBTiles -raster,vector- (rw+v): MBTiles"
}

dev() {
	default_dev

	if [ "$_with_java" = "ON" ]; then
		amove usr/share/java/gdal-*.pom
	fi
}

doc() {
	default_doc

	if [ "$_with_java" = "ON" ]; then
		amove usr/share/java/gdal-*-javadoc.jar
		amove usr/share/java/gdal-*-sources.jar
	fi
}

sha512sums="
87e542d01b8332664ca13703c1698bcc5f1b0ddfa9deaa3b13baedabff3756d14b4fd5f35a9450b7cd474b36e714b7336120f7a6b45776df6eac725d1f25a4e5  gdal-3.12.1.tar.gz
c1059034f62fa4f5088d3f6abbfae73773047b6ca3a0a197667c936c57266b68417c9e3bb436f507146d5440891de5fe059b62d560576e9c85b1b21afd0e5546  10-atoll.patch
eae398e7d610115bb4df91771036986af3174dbc2b6fa1bead2144dd73c1546ead38a999aa5a55e38b4b4f3d19724cb24486d3fe57d3ca77f12f90b98ebf1988  20-plugin_installation_message.patch
ba3ed801ed5966c3e848cb8e28c1c3fb50f46334effce88490db368551cef52d42137824b27969f461d52cff489f9757cbf63c7f62e585e83f65fb6523e676f9  30-pugixml.patch
"
