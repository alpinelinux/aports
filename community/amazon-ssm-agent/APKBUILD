# Contributor: Will Sinatra <wpsinatra@gmail.com>
# Maintainer: Will Sinatra <wpsinatra@gmail.com>
maintainer="Will Sinatra <wpsinatra@gmail.com>"
pkgname=amazon-ssm-agent
pkgver=3.3.3572.0
pkgrel=0
pkgdesc="Amazon SSM Agent for managing EC2 Instances using the SSM APIs."
url="https://aws.amazon.com/documentation/systems-manager/"
license="Apache-2.0"
# loongarch64: blocked by old github.com/creack/pty version
arch="all !loongarch64"
makedepends="go bash"
source="https://github.com/aws/amazon-ssm-agent/archive/$pkgver/amazon-ssm-agent-$pkgver.tar.gz
	amazon-ssm-agent.initd"
subpackages="$pkgname-openrc"
options="!check net"
_binaries="amazon-ssm-agent
	ssm-agent-worker
	ssm-cli
	ssm-document-worker
	ssm-session-logger
	ssm-session-worker
	ssm-setup-cli
	"

build() {
	GOOS= GOARCH= GO_BUILD='go build -ldflags "-s -w"' make build-any-linux
}

package() {
	for bin in $_binaries; do
		install -Dm0755 "$builddir"/bin/_/$bin "$pkgdir"/usr/bin/$bin
	done

	install -Dm0644 "$builddir"/bin/amazon-ssm-agent.json.template \
		"$pkgdir"/etc/amazon/ssm/amazon-ssm-agent.json.template
	install -Dm0644 "$builddir"/bin/seelog_unix.xml \
		"$pkgdir"/etc/amazon/ssm/seelog.xml
	install -Dm0644 "$builddir"/bin/seelog_windows.xml.template \
		"$pkgdir"/etc/amazon/ssm/seelog_windows.xml.template

	install -Dm0755 "$srcdir"/amazon-ssm-agent.initd \
		"$pkgdir"/etc/init.d/amazon-ssm-agent
}

sha512sums="
246d612f532f2cc21c20c621d56dc7705d624aeb3934c9b23812f67815c33008a0f398dae6715afb7fdb3ea9f87562929a52acba6e4c003df6df4c49d71a5727  amazon-ssm-agent-3.3.3572.0.tar.gz
a905c4272c5aa3ed65147f6aa58d70ba5bd0311d26308e7aa0f77da7b9860056d24a2a31ce7dddd25dc09c355275dd2f56847e2ab00ac1cb92eaa2aa732c34f3  amazon-ssm-agent.initd
"
