# Contributor: Minoplhy <c@3qx.nl>
maintainer="Minoplhy <c@3qx.nl>"
pkgname=beszel
pkgver=0.18.4
pkgrel=0
pkgdesc="Lightweight server monitoring hub with historical data, docker stats, and alerts."
url="https://beszel.dev/"
arch="x86_64 aarch64"
license="MIT"
depends="tar curl"
makedepends="go>=1.25 npm"
install="$pkgname.pre-install $pkgname-agent.pre-install"
pkgusers="beszel beszel-agent"
pkggroups="beszel beszel-agent"
subpackages="$pkgname-openrc
	$pkgname-agent
	$pkgname-agent-openrc:agent_openrc
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/henrygd/beszel/archive/refs/tags/v$pkgver.tar.gz
	$pkgname.confd
	$pkgname.initd
	$pkgname-agent.confd
	$pkgname-agent.initd
	00-go-version.patch
	01-go-downgrade.patch
	"
options="net !check" # check: no test suite

export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

build() {
	make -j1 -C $builddir
}


package() {
	install -D -m 755 "$builddir"/build/${pkgname}_linux_* "$pkgdir"/usr/bin/$pkgname
	install -D -m 755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -D -m 644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
	install -d -m 750 -o $pkgusers -g $pkggroups "$pkgdir"/var/lib/$pkgname

	install -D -m 755 "$builddir"/build/$pkgname-agent_linux_* "$pkgdir"/usr/bin/$pkgname-agent

	install -d -m 755 -o beszel -g beszel "$pkgdir"/var/log/$pkgname
	install -d -m 755 -o beszel-agent -g beszel-agent "$pkgdir"/var/log/$pkgname-agent
}

agent() {
	pkgdesc="Beszel agent"

	amove usr/bin/$pkgname-agent
	amove var/log/$pkgname-agent
}

agent_openrc() {
	pkgdesc="Beszel agent OpenRC scripts"

	install_if="openrc ${subpkgname%-openrc}=$pkgver-r$pkgrel"
	install -D -m 755 "$srcdir"/$pkgname-agent.initd "$pkgdir"/etc/init.d/$pkgname-agent
	install -D -m 644 "$srcdir"/$pkgname-agent.confd "$pkgdir"/etc/conf.d/$pkgname-agent
	amove etc/init.d/$pkgname-agent
	amove etc/conf.d/$pkgname-agent
}

sha512sums="
342ebedf59c08bd924c75cd3eabb623030b50a3991b47b361a88e660881dc3c5b3e8446eea5b476cdfa14ebc132396584f3da601261cc1da555a0797ad003d14  beszel-0.18.4.tar.gz
6fc05a7195283c2f3f24aa2100a91de163511ca46b75ef8f8637af380c5068b5dc7d7ac875e9638775242e70f2530db0902835b60b705d865ac64f28bb551944  beszel.confd
fd64065cc06b2ec3492722bdd2da0ea3bb2a823533239e1c79c117de163dd1a9832853538f1377af57524c9023e636afc09e163a38007e8e4b71e63035d1881f  beszel.initd
c127684e14265037eef9d6ea16149e7a3ee0a6846fd3019de630aa026e0a679ef6e80df2a8d8459963438c30836f543da54bb9cee489e205ec34e60fdb09d805  beszel-agent.confd
c76cbee4d66cd188432805ea0fc0cd048178ea7794fc25cffcb71935f0dac013a547f0912dee2b0cd62c23602e49432c843100229a2c3ef3d6dd15617221af39  beszel-agent.initd
492d609a3a61fa5cfca50e2451a2cbd22a2962a699552be169236f4ad5248a56afc9b2bf080eca88ebbc878c4adf5ca97f6d244ccf6f71eaad26685803278ecf  00-go-version.patch
7e4b1bfbda697dd66f3f2f0c55d5bd7ce0ff18b8835fcce4352425fbaacc047a5da2c81c7649c7084fd5aa0aa9710fb6423b16a7078605535249f69f18ab2c2c  01-go-downgrade.patch
"
