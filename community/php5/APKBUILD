# Contributor: Valery Kartel <valery.kartel@gmail.com>
# Contributor: Andy Blyler <andy@blyler.cc>
# Contributor: ≈Åukasz Jendrysik <scadu@yandex.com>
# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer: Matt Smith <mcs@darkregion.net>
pkgname=php5
pkgver=5.6.30
pkgrel=2
_apiver=20131106
_suffix=${pkgname#php}
_pkgreal=${pkgname%$_suffix}
pkgdesc="The PHP$_suffix language runtime engine"
url="http://www.php.net/"
arch="all"
license="PHP-3"
options="!check"
depends="$pkgname-config"
depends_dev="$pkgname autoconf pcre-dev"
depends_doc=
replaces="php7"
provides=$_pkgreal
makedepends="autoconf bison re2c apache2-dev libxml2-dev libxslt-dev libzip-dev bzip2-dev zlib-dev
	aspell-dev enchant-dev expat-dev pcre-dev curl-dev gmp-dev icu-dev imap-dev gd-dev
	libical-dev libressl-dev openldap-dev net-snmp-dev db-dev krb5-dev gdbm-dev sqlite-dev
	freetds-dev postgresql-dev unixodbc-dev freetype-dev tidyhtml-dev libwebp-dev
	libpng-dev libjpeg-turbo-dev libmcrypt-dev recode-dev libedit-dev gettext-dev
	"
source="http://php.net/distributions/$_pkgreal-$pkgver.tar.bz2
	fix-asm-constraints-in-aarch64-multiply-macro.patch
	$pkgname-module.conf
	$pkgname-fpm.logrotate
	$pkgname-fpm.initd
	$pkgname-fpm.patch
	$pkgname-includedir.patch
	install-conf.patch
	install-pear.patch
	gd-iconv.patch
	"
# unimplemented extensions: com_dotnet interbase oci8 pdo_firebird pdo_oci
_extension_dir=/usr/lib/$pkgname
_extension_conf=/etc/$pkgname/conf.d
_extensions="bcmath bz2 calendar ctype curl dba dom enchant exif fileinfo ftp gd gettext gmp iconv imap:1
	intl json ldap mbstring mcrypt mssql mysql:1 mysqli:1 mysqlnd odbc opcache openssl pcntl pdo pdo_dblib
	pdo_mysql pdo_odbc pdo_pgsql pdo_sqlite pgsql phar posix pspell recode session shmop snmp soap
	sockets sqlite3 sysvmsg sysvsem sysvshm tidy wddx xml xmlreader xmlrpc xmlwriter xsl zip zlib
	"
for _extension in $_extensions; do
	[ -z "${_extension##*:*}" ] && eval _index_${_extension%:*}=${_extension#*:}
	subpackages="$subpackages $pkgname-${_extension%:*}:_extension"
done
_prefix_opcache="zend_"
_pkgdesc_opcache="Zend OPcache"
_depends_mysqlnd="$pkgname-openssl"
subpackages="$pkgname-dev $pkgname-doc $pkgname-libs $pkgname-apache2 $pkgname-phpdbg
	$pkgname-litespeed $pkgname-cgi $pkgname-fpm $pkgname-pear::noarch $pkgname-pecl::noarch
	$pkgname-phar-utils:_phar:noarch $subpackages $pkgname-config::noarch"
builddir="$srcdir/$_pkgreal-$pkgver"

prepare() {
	cd "$builddir"

	sed "$(($(grep -n 'Pool Definitions' sapi/fpm/php-fpm.conf.in | cut -d: -f1)+3)),\$d" \
		-i sapi/fpm/php-fpm.conf.in && \
		echo include=@php_fpm_sysconfdir@/php-fpm.d/*.conf >> \
		sapi/fpm/php-fpm.conf.in

	default_prepare || return 1
	update_config_sub || return 1

	local vapi=$(sed -n '/#define PHP_API_VERSION/{s/.* //;p}' main/php.h)
	if [ "$vapi" != "$_apiver" ]; then
		error "Upstreram API version is now $vapi. Expecting $_apiver"
		error "After updating _apiver, all 3rd-party extensions must be rebuilt"
		return 1
	fi

	autoconf
}

# Notes to ./configure parameters
# recode and imap are defined in build function because can't build together
# --with-libgd -- do not swith to system-wide libgd - runtime bugs.
# --with-xmlrpc -- do not swith to system-wide xmlrpc - build errors.

_build() {
	./configure \
		EXTENSION_DIR=$_extension_dir \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--program-suffix=$_suffix \
		--libdir=$_extension_dir \
		--datadir=/usr/share/$pkgname \
		--sysconfdir=/etc/$pkgname \
		--localstatedir=/var \
		--with-layout=GNU \
		--with-pic \
		--with-pear=/usr/share/pear \
		--with-config-file-path=/etc/$pkgname \
		--with-config-file-scan-dir=$_extension_conf \
		--disable-short-tags \
		--without-readline \
		--with-libedit \
		--enable-bcmath=shared \
		--with-bz2=shared \
		--enable-calendar=shared \
		--enable-ctype=shared \
		--with-curl=shared \
		--enable-dba=shared \
			--with-gdbm \
			--with-db4 \
		--enable-dom=shared \
			--with-libxml-dir \
		--with-enchant=shared \
		--enable-exif=shared \
		--enable-fileinfo=shared \
		--enable-ftp=shared \
			--with-openssl-dir \
		--with-gd=shared \
			--with-jpeg-dir \
			--with-png-dir \
			--with-webp-dir \
			--with-xpm-dir=no \
			--with-freetype-dir \
			--enable-gd-native-ttf \
			--disable-gd-jis-conv \
		--with-gettext=shared \
		--with-gmp=shared \
		--with-iconv=shared \
		--enable-intl=shared \
			--with-icu-dir=/usr \
		--enable-json=shared \
		--enable-libxml=shared \
			--with-libxml-dir \
			--with-libexpat-dir \
		--with-ldap=shared \
			--with-ldap-sasl \
		--enable-mbstring=shared \
			--enable-mbregex \
		--with-mcrypt=shared \
		--with-mssql=shared \
		--with-mysql=shared,mysqlnd \
		--with-mysqli=shared,mysqlnd \
			CFLAGS=-DMYSQLI_NO_CHANGE_USER_ON_PCONNECT \
		--enable-mysqlnd=shared \
			--with-zlib-dir \
		--enable-opcache=shared \
		--with-openssl=shared \
			--with-kerberos \
			--with-system-ciphers \
		--enable-pcntl=shared \
		--with-pcre-regex=/usr \
			--with-pcre-dir \
		--enable-pdo=shared \
		--with-pdo-dblib=shared \
		--with-pdo-mysql=shared,mysqlnd \
		--with-pdo-odbc=shared,unixODBC,/usr \
		--with-pdo-pgsql=shared \
		--with-pdo-sqlite=shared,/usr \
		--with-pgsql=shared \
		--enable-phar=shared \
		--enable-posix=shared \
		--with-pspell=shared \
		--enable-session=shared \
		--enable-shmop=shared \
		--with-snmp=shared \
		--enable-soap=shared \
		--enable-sockets=shared \
		--with-sqlite3=shared,/usr \
		--enable-sysvmsg=shared \
		--enable-sysvsem=shared \
		--enable-sysvshm=shared \
		--with-tidy=shared \
		--with-unixODBC=shared,/usr \
		--enable-wddx=shared \
		--enable-xml=shared \
		--enable-xmlreader=shared \
		--with-xmlrpc=shared \
		--enable-xmlwriter=shared \
		--with-xsl=shared \
		--enable-zip=shared \
			--with-libzip \
		--with-zlib=shared \
			--with-zlib-dir \
		$@ || return 1
	make
}

build() {
	cd "$builddir"
	# build phpdbg
	_build --enable-phpdbg \
		--enable-phpdbg-webhelper \
		--disable-cgi \
		--disable-cli \
		|| return 1
	# build apache2 module + recode extension
	_build --disable-phpdbg \
		--disable-cgi \
		--disable-cli \
		--with-apxs2 \
		--with-recode=shared \
		|| return 1
	mv libs/lib$_pkgreal*.so sapi/apache2handler/
	# build all other + imap extension
	_build --disable-phpdbg \
		--enable-fpm \
		--enable-embed \
		--with-litespeed \
		--with-imap=shared \
			--with-imap-ssl \

package() {
	pkgdesc="$pkgdesc (command line interface)"
	make -C "$builddir" INSTALL_ROOT="$pkgdir" install || return 1

	ln -sf /usr/bin/php$_suffix "$pkgdir"/usr/bin/php
	rm -fr "$pkgdir"/.[[:alpha:]]*
}

dev() {
	replaces=$replaces-${subpkgname#$pkgname-}
	default_dev || return 1

	mkdir -p "$subpkgdir"/usr/bin \
		"$subpkgdir"/$_extension_dir || return 1

	local file
	for file in php-config phpize; do
		mv "$pkgdir"/usr/bin/$file$_suffix \
			"$subpkgdir"/usr/bin/ || return 1
		ln -sf /usr/bin/$file$_suffix "$subpkgdir"/usr/bin/$file
	done

	mv "$pkgdir"/$_extension_dir/build "$subpkgdir"/$_extension_dir
}

doc() {
	default_doc || return 1
	install_if="docs $pkgname-config=$pkgver-r$pkgrel"

	cd "$builddir"
	local file
	for file in $(ls CODING_STANDARDS CREDITS EXTENSIONS INSTALL LICENSE NEWS README* UPGRADING*); do
		install -Dm644 $file "$subpkgdir"/usr/share/doc/$pkgname/$file || return 1
	done
}

apache2() {
	replaces=
	pkgdesc="$pkgdesc (apache2 module)"
	depends="$pkgname-config apache2"

	mkdir -p "$subpkgdir"/usr/lib/apache2 || return 1
	cp "$builddir"/sapi/apache2handler/lib$_pkgreal*.so \
		"$subpkgdir"/usr/lib/apache2/mod_$pkgname.so || return 1

	install -Dm644 "$srcdir"/$pkgname-module.conf \
		"$subpkgdir"/etc/apache2/conf.d/$pkgname-module.conf
}

phpdbg() {
	replaces=$replaces-${subpkgname#$pkgname-}
	pkgdesc="$pkgdesc (interactive debugger)"
	depends="$pkgname-config"

	install -Dm755 "$builddir"/sapi/phpdbg/phpdbg \
		 "$subpkgdir"/usr/bin/phpdbg$_suffix || return 1
	ln -sf /usr/bin/phpdbg$_suffix "$subpkgdir"/usr/bin/phpdbg
}

libs() {
	replaces=
	pkgdesc="$pkgdesc (embedded library)"
	depends="$pkgname-config"

	mkdir -p "$subpkgdir"/usr/lib || return 1
	mv "$pkgdir"/usr/lib/lib$_pkgreal*.so \
		"$subpkgdir"/usr/lib/lib$pkgname.so || return 1
}

litespeed() {
	replaces=$replaces-${subpkgname#$pkgname-}
	pkgdesc="$pkgdesc (litespeed)"
	depends="$pkgname-config"

	mkdir -p "$subpkgdir"/usr/bin || return 1
	mv "$pkgdir"/usr/bin/lsphp \
		"$subpkgdir"/usr/bin/lsphp$_suffix || return 1
	ln -sf /usr/bin/lsphp$_suffix "$subpkgdir"/usr/bin/lsphp
}

cgi() {
	replaces=$replaces-${subpkgname#$pkgname-}
	pkgdesc="$pkgdesc (common gateway interface)"
	depends="$pkgname-config"

	mkdir -p "$subpkgdir"/usr/bin || return 1
	mv "$pkgdir"/usr/bin/php-cgi$_suffix \
		 "$subpkgdir"/usr/bin/ || return 1
	ln -sf /usr/bin/php-cgi$_suffix "$subpkgdir"/usr/bin/php-cgi
}

fpm() {
	replaces=
	pkgdesc="$pkgdesc (fastcgi process manager)"
	depends="$pkgname-config"

	mkdir -p "$subpkgdir"/usr/bin \
		"$subpkgdir"/usr/share \
		"$subpkgdir"/etc/$pkgname \
		"$subpkgdir"/var/log/$pkgname || return 1

	mv "$pkgdir"/usr/sbin "$subpkgdir"/usr/ || return 1
	mv "$pkgdir"/usr/share/$pkgname \
		"$subpkgdir"/usr/share/ || return 1
	mv "$pkgdir"/etc/$pkgname/php-fpm* \
		"$subpkgdir"/etc/$pkgname/ || return 1
	# compatibility link
	ln -sf /usr/sbin/php-fpm$_suffix "$subpkgdir"/usr/bin/php-fpm

	local file;
	for file in php-fpm.conf php-fpm.d/www.conf; do
		mv "$subpkgdir"/etc/$pkgname/$file.default \
			"$subpkgdir"/etc/$pkgname/$file || return 1
	done

	install -Dm755 "$srcdir"/$pkgname-fpm.initd \
		"$subpkgdir"/etc/init.d/$_pkgreal-fpm$_suffix || return 1
	install -Dm644 "$srcdir"/$pkgname-fpm.logrotate \
		"$subpkgdir"/etc/logrotate.d/$_pkgreal-fpm$_suffix || return 1
}

pear() {
	replaces=$replaces-${subpkgname#$pkgname-}
	pkgdesc="$pkgdesc (php extension and application repository)"
	depends="$pkgname $pkgname-xml"

	mkdir -p "$subpkgdir"/usr/bin \
		"$subpkgdir"/etc/$pkgname || return 1

	mv "$pkgdir"/etc/$pkgname/pear.conf \
		"$subpkgdir"/etc/$pkgname/ || return 1

	mv "$pkgdir"/usr/share \
		"$subpkgdir"/usr/ || return 1

	sed -e "s/\$INCARG/\$INCARG -d extension=xml.so/" \
		 -i "$pkgdir"/usr/bin/pecl || return 1

	local file
	for file in pear peardev pecl; do
		mv "$pkgdir"/usr/bin/$file \
			"$subpkgdir"/usr/bin/$file$_suffix || return 1
		sed -e "s:/usr/bin/php:/usr/bin/php$_suffix:g" \
			-i "$subpkgdir"/usr/bin/$file$_suffix || return 1
		ln -sf /usr/bin/$file$_suffix \
			"$subpkgdir"/usr/bin/$file || return 1
	done
}

pecl() {
	replaces=
	pkgdesc="$pkgdesc (php extension community library)"
	depends="$pkgname-pear $pkgname-dev gcc make musl-dev"
	mkdir -p "$subpkgdir"
}

config() {
	provides="phpapi$_apiver"
	replaces=
	depends=
	pkgdesc="$pkgdesc (common config)"

	mkdir -p "$subpkgdir"/$_extension_conf || return 1

	install -Dm644 "$builddir"/php.ini-production \
		"$subpkgdir"/etc/$pkgname/php.ini || return 1

	# exit with an error if some modules were not in subpackages
	rmdir "$pkgdir"/$_extension_dir || return 1
	rm -fr "$pkgdir"/etc "$pkgdir"/var "$pkgdir"/usr/lib
}

_phar() {
	replaces=$replaces-${subpkgname#$pkgname-}
	pkgdesc="$pkgdesc (archive script)"
	depends="$pkgname $pkgname-phar"

	mkdir -p "$subpkgdir"/usr/bin || return 1

	rm "$pkgdir"/usr/bin/phar || return 1
	mv "$pkgdir"/usr/bin/phar.phar \
		"$subpkgdir"/usr/bin/phar.phar$_suffix || return 1

	local file
	for file in phar$_suffix phar phar.phar; do
		ln -sf /usr/bin/phar.phar$_suffix \
			"$subpkgdir"/usr/bin/$file || return 1
	done
}

_extension() {
	local dep deps
	local name=${subpkgname#$pkgname-}
	local index=$(eval echo \${_index_$name:-0})
	replaces=
	depends=$(eval echo \$_depends_$name)

	pkgdesc=$(eval echo \$_pkgdesc_$name)
	: ${pkgdesc:=$(head -n1 "$builddir"/ext/$name/CREDITS)}
	pkgdesc="PHP$_suffix extension: ${pkgdesc:-$name}"

	[ -f "$builddir"/ext/$name/config.w32 ] && \
		deps=$(grep -o "_DEP('$name'.*" "$builddir"/ext/$name/config.w32 | sed "s/[',);]//g")
	[ -f "$builddir"/ext/$name/config.m4 ] && \
		deps="$deps $(grep -o "_DEP($name,.*" "$builddir"/ext/$name/config.m4 | sed "s/[,)]//g")"
	for dep in $(echo -e ${deps//[[:space:]]/\\n} | sort -u); do
		[ -z "${_extensions##*$dep*}" ] && depends="$depends $pkgname-$dep"
	done

	index=$(($(echo $depends | wc -w)+$index))
	depends="$pkgname-config phpapi$_apiver $depends"

	mkdir -p "$subpkgdir"/$_extension_dir \
		"$subpkgdir"/$_extension_conf || return 1

	mv "$pkgdir"/$_extension_dir/$name.so \
		"$subpkgdir"/$_extension_dir || return 1

	echo $(eval echo \$_prefix_$name)extension=$name.so > \
		"$subpkgdir"/$_extension_conf/$(printf %02d $index)_$name.ini
}

sha512sums="12734d786cca5767b8b8838affbe1c3d578dd179c8d5339653d905658562c5fdf39a88349213b1340f320320700a5378aed617447b6e15909019788a49ad2da0  php-5.6.30.tar.bz2
d93d3fc015580cf5f75c6cbca4cd980e054b61e1068495da81a7e61f1af2c9ae14f09964c04928ad338142de78e4844aed885b1ad1865282072999fb045c8ad7  fix-asm-constraints-in-aarch64-multiply-macro.patch
0b6b5b9fc7e66b3ee940c3e046fae1fe39204a33e5f83e218d05a88db9a73908e95831d453dd6ea8db7dae210ef6edc234bd312e321b39d14c57b5b1097cc6c9  php5-module.conf
d7226c54bf89dd45abf75f5bc844aa18bfaeca5637d8812cce653fd7f947590c3054845c74a819eea5f4fededddf725a989703ed6a97d7f9f80cfb87aa2fe511  php5-fpm.logrotate
1de51e59d587cbe8b1dfac63494047001e234a37c91243e41d457afa794efe6ed3278c787a24fc2641860ef70b1db6c0c204ccf8695011b045eba09b7f5d8615  php5-fpm.initd
6faee5ac025a4ac1b263a4b88d0f559e3af61126f5000fafb63691631d260f346a85204389b552eb103889e1455eb4f887e35c712329dd5cc827c2fdc0d55172  php5-fpm.patch
8fc56dc52b8eb2c88c69b445dd667ceefc5407017ba323701134bda9cd4f6b154db86442e5285817b5eb9799bf9e9dd11523e75006760fba80b334991d477088  php5-includedir.patch
8082cfde05fddf7a1f5d6db058b186228948b020c585fba694d00fb7c4a8fc974f6d24f720bebc26ac4399fa7cc2a7dcd38465dc5e30745d521fd6354a899960  install-conf.patch
f1177cbf6b1f44402f421c3d317aab1a2a40d0b1209c11519c1158df337c8945f3a313d689c939768584f3e4edbe52e8bd6103fb6777462326a9d94e8ab1f505  install-pear.patch
6ecd0be2da1dc5b1d7512e46a2a5cd107a8b2a8c364efc9c624a7d6b2ab081685a329c94c22c970dc14c5c1115f702c512e97ae858da1bc69c6423323dbeeba2  gd-iconv.patch"
