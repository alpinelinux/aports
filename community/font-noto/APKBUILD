# Contributor: Carlo Landmeter <clandmeter@alpinelinux.org>
# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Carlo Landmeter <clandmeter@alpinelinux.org>
pkgname=font-noto
pkgver=0_git20211101
_gitrev=364fb14e20f82887280f103f638ff6450dbfc525
pkgrel=2
pkgdesc="Noto font families for Latin, Cyrillic and Greek scripts"
url="https://github.com/googlefonts/noto-fonts/"
arch="noarch"
license="OFL-1.1"
depends="fontconfig"
makedepends="ruby"
checkdepends="cmd:xmllint"
source="https://github.com/googlefonts/noto-fonts/archive/$_gitrev/noto-fonts-$_gitrev.tar.gz
	58-noto-math.xml
	fontconfig.xml.erb
	noto-meta.json
	noto-meta
	"
builddir="$srcdir/noto-fonts-$_gitrev"

# List of subpackages generated by './noto-meta list-subpkgs'.
# NOTE: List is sorted by string length to prevent find doing partial matching.
_subpkgs="
	nyiakeng-puachue-hmong
	canadian-aboriginal
	indic-siyaq-numbers
	hanifi-rohingya
	mayan-numerals
	gunjala-gondi
	masaram-gondi
	mende-kikakui
	nastaliq-urdu
	meetei-mayek
	naskh-arabic
	pahawh-hmong
	rashi-hebrew
	sora-sompeng
	syloti-nagri
	kufi-arabic
	medefaidrin
	new-tai-lue
	pau-cin-hau
	signwriting
	warang-citi
	devanagari
	historical
	saurashtra
	bassa-vah
	malayalam
	mongolian
	samaritan
	sundanese
	armenian
	balinese
	buginese
	cherokee
	duployan
	ethiopic
	georgian
	gujarati
	gurmukhi
	javanese
	kayah-li
	ol-chiki
	tagbanwa
	tifinagh
	vithkuqi
	bengali
	elbasan
	grantha
	hanunoo
	kannada
	myanmar
	sharada
	sinhala
	soyombo
	symbols
	tibetan
	tirhuta
	arabic
	chakma
	coptic
	hebrew
	kaithi
	khojki
	lepcha
	rejang
	syriac
	telugu
	thaana
	wancho
	yezidi
	adlam
	bamum
	batak
	buhid
	khmer
	limbu
	music
	nushu
	oriya
	osage
	tamil
	ahom
	cham
	lisu
	math
	miao
	modi
	newa
	thai
	lao
	mro
	nko
	tai
	vai
	yi
	"
for _sub in $_subpkgs; do
	subpackages="$subpackages $pkgname-$_sub:_split"
done
subpackages="$subpackages
	font-croscore
	$pkgname-extra
	$pkgname-all:_all
	"

_fontsdir='usr/share/fonts/noto'

build() {
	noto_meta gen-font-confs conf.d/
}

check() {
	xmllint --quiet --loaddtd --valid --nonet \
		--path /usr/share/xml/fontconfig/ conf.d/*.xml >/dev/null
}

package() {
	depends="$depends
		$pkgname-math=$pkgver-r$pkgrel
		$pkgname-symbols=$pkgver-r$pkgrel
		"

	install -D -m644 hinted/ttf/*/*.ttf -t "$pkgdir/$_fontsdir"/
	install -D -m644 conf.d/*.xml -t "$pkgdir"/etc/fonts/conf.avail/

	cd "$pkgdir"

	mkdir -p etc/fonts/conf.d
	local f; for f in etc/fonts/conf.avail/*.xml; do
		ln -s ../conf.avail/${f##*/} "$pkgdir"/etc/fonts/conf.d/${f##*/}
	done
}

_split() {
	pkgdesc=$(noto_meta pkgdesc $subpkgname)
	provides=""
	replaces=""

	# For backward compatibility (Alpine <3.16).
	case "${subpkgname#font-noto-}" in
		kayah-li) replaces="$pkgname-kayahli";;
		ol-chiki) replaces="$pkgname-olchiki";;
		historical) replaces="$pkgname-egyptianhieroglyphs $pkgname-oldturkic";;
	esac
	local name
	[ "$replaces" ] && for name in $replaces; do
		provides="$provides $name=$pkgver-r$pkgrel"
	done
	replaces="$replaces $pkgname<0_git20211101-r1 $pkgname-extra<0_git20211101-r1"

	local font; for font in $(noto_meta font-basenames $subpkgname); do
		amove "$_fontsdir"/$font-*.ttf
	done

	local fontconf="58-${subpkgname#font-}.xml"
	amove etc/fonts/conf.avail/$fontconf
	amove etc/fonts/conf.d/$fontconf
}

croscore() {
	pkgdesc="Chrome OS core fonts"

	local font; for font in Arimo Cousine Tinos; do
		amove "$_fontsdir"/$font*.ttf
	done
}

extra()	{
	pkgdesc="$pkgdesc (extra weights and variants)"
	depends="$pkgname=$pkgver-r$pkgrel"

	cd "$pkgdir"
	mkdir -p "$builddir"/.tmp

	local font weight
	for font in $(noto_meta font-basenames '@'); do
		for weight in Regular Italic Bold BoldItalic; do
			mv "$_fontsdir"/$font-$weight.ttf "$builddir"/.tmp/ 2>/dev/null || true
		done
		amove "$_fontsdir"/$font-*.ttf
	done

	# Take advantage of the fact that this split function runs as the last
	# one (we don't count -all) and check if there are any files not listed
	# in fonts-meta.json
	if [ "$(ls -A "$_fontsdir")" ]; then
		error "Unknown files found in /$_fontsdir (update fonts-meta.json):"
		ls -1 "$_fontsdir" >&2
		return 1
	fi

	mkdir -p "$_fontsdir"
	mv "$builddir"/.tmp/*.ttf "$_fontsdir"/
}

_all() {
	pkgdesc="Google Noto font families that aim to support all the world's languages (meta package)"
	depends="$pkgname=$pkgver-r$pkgrel
		font-croscore=$pkgver-r$pkgrel
		$pkgname-extra=$pkgver-r$pkgrel
		"

	local subname; for subname in $_subpkgs; do
		depends="$depends $pkgname-$subname"
	done

	mkdir -p "$subpkgdir"
}

noto_meta() {
	"$srcdir"/noto-meta "$@"
}

sha512sums="
cb484098015a6847c1b2538635f5bc92e7fc50d1ffd9fbd406ae086b4c0dd8ae9a504ac6cf65320cc96c13a5b7462463466e72799a7facd116bcb092b9142452  noto-fonts-364fb14e20f82887280f103f638ff6450dbfc525.tar.gz
5c74a4b7a8abbb95326598f8e28b5c06c95e351a926cbaa4ed0ebad24635963e52488e3981b049d8da9b63172dcdb1d8c0c1c8d31430199baefd3115bfccfa3f  58-noto-math.xml
066d295b03b7504b707e1a81abace4dad10e5bda203dc1806b105d2665e0a7ab1dfc256934fb44acd50dfdcd9298788c1403c6f0620f919ab17b16794191f97b  fontconfig.xml.erb
685a9e4de403a0bad5e7a83380220f8f789433b211e3412193324cc0c9d6032da6bf057d370497b949d78456cbacfdae5c45c0773b2a53b6d229d5abf3b9bb03  noto-meta.json
df03b1dcc0417f045348ac5fca03e126022c6e9fa14109925c2ecba85880df2c6ac797573834054f511735866dc03f56d2dcf2f9a3790a16802969041a091227  noto-meta
"
