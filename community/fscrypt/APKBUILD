# Contributor: Dermot Bradley <dermot_bradley@yahoo.com>
# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=fscrypt
pkgver=0.3.6
pkgrel=1
pkgdesc="Manage Linux native filesystem encryption"
url="https://github.com/google/fscrypt"
# Tests fail on ppc64le with SIGSEGV and memory lock errors
arch="all"
license="Apache-2.0"
makedepends="
	findutils
	go
	linux-pam-dev
	"
subpackages="$pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/google/fscrypt/archive/refs/tags/v$pkgver.tar.gz"

export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

build() {
	make
}

check() {
	# Test fails consistently on the builder, sometimes on the CI
	case "$CARCH" in
	riscv64)
		go test -skip TestLoadSourceDevice ./...
		;;
	*)
		go test ./...
		;;
	esac
}

package() {
	install -Dvm755 bin/fscrypt -t "$pkgdir"/usr/bin/
	install -Dvm644 README.md -t "$pkgdir"/usr/share/doc/$pkgname/

	install -Dvm755 -o root \
		bin/pam_fscrypt.so \
		-t "$pkgdir"/usr/lib/security/
}

sha512sums="
ddabe9f9387faf4633de36eb778f1bb7986bc54db6bfa9f60521bf7faa69c7ad191e4a8eff30ea3be0742d9a4372270dd20e8018c6464806d2332636ebd7e110  fscrypt-0.3.6.tar.gz
"
