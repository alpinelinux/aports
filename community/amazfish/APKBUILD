# Contributor: Bart Ribbers <bribbers@disroot.org>
# Contributor: Jozef Mlich <jmlich83@gmail.com>
# Maintainer: Marco Schr√∂der <marco.schroeder96@gmail.com>
pkgname=amazfish
pkgver=2.8.0
pkgrel=2
_commit_qble="eb6192bf81c4f97b6d393c37d32e56946184b86f"
_commit_libwatchfish="9b5ddbd8a67acc38281be7c553d70a2e1a814589"
_commit_qt_aes="e55c81b502c89165ba3a0c94999ea7727b0f3030"

pkgdesc="Companion application for Huami Devices (such as Amazfit Bip, Cor, MiBand2/3 and GTS and GTS) and the Pinetime Infinitime"
url="https://github.com/piggz/harbour-amazfish"
# armhf blocked by kdb
arch="all !armhf"
license="GPL-3.0-or-later"
depends="
	bluez
	bluez-qt
	kdb-sqlite
	kirigami2
	kcoreaddons5
	nemo-qml-plugin-dbus
	qt5-qtconnectivity
	qt5-qtquickcontrols
	"
makedepends="
	cmake
	ninja
	icu-dev
	karchive5-dev
	kdb-dev
	kcoreaddons5-dev
	qt5-qtbase-dev
	qt5-qtconnectivity-dev
	qt5-qtlocation-dev
	qt5-qttools-dev
	qtmpris-dev
	"
subpackages="$pkgname-systemd"
source="https://github.com/piggz/harbour-amazfish/archive/$pkgver/harbour-amazfish-$pkgver.tar.gz
	https://github.com/piggz/qble/archive/$_commit_qble/qble-$_commit_qble.tar.gz
	https://github.com/piggz/libwatchfish/archive/$_commit_libwatchfish/libwatchfish-$_commit_libwatchfish.tar.gz
	https://github.com/bricke/Qt-AES/archive/$_commit_qt_aes/Qt-AES-$_commit_qt_aes.tar.gz
	0001-Add-generate_export_header-to-be-able-compile-with-D.patch
	amazfish-launcher.sh
	amazfish.desktop
	"
options="!check" # No tests
builddir="$srcdir/harbour-amazfish-$pkgver"

prepare() {
	rmdir qble daemon/libwatchfish daemon/Qt-AES
	mv "$srcdir/qble-$_commit_qble" qble
	mv "$srcdir/libwatchfish-$_commit_libwatchfish" daemon/libwatchfish
	mv "$srcdir/Qt-AES-$_commit_qt_aes" daemon/Qt-AES

	default_prepare
}

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		local crossopts="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake -B build \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=ON \
		-DCMAKE_BUILD_TYPE=None \
		$crossopts \
		-G Ninja \
		-DFLAVOR=kirigami
	cmake --build build --verbose
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	install -Dm644 "$srcdir"/amazfish.desktop -t "$pkgdir"/etc/xdg/autostart/
	install -Dm755 "$srcdir"/amazfish-launcher.sh "$pkgdir"/usr/libexec/amazfish-launcher
}

sha512sums="
0040b3c59bdd912dd99340a5061f48ec9bc23d9eac06d030614a2d804f92b9246972f6e72984fddc2349dd03f3b5a68d41f4c8e4182cdb982e65ef2f00277dbf  harbour-amazfish-2.8.0.tar.gz
50119b362986c9c65d0ded878d3943711617304c35093f2e2538c3cdfe7b73c4f789dbc40c7df046f112e5abd67de37c9aa1fc09f780049ffad2a082574f228c  qble-eb6192bf81c4f97b6d393c37d32e56946184b86f.tar.gz
389b9d445fc8e88bfb133106877f7cfad7ad1ced618a8a69695380b3fe045d4a774408736db7ff1c5ae3ce9832458190f162769ee91d2952c2d940a6f9d93c3b  libwatchfish-9b5ddbd8a67acc38281be7c553d70a2e1a814589.tar.gz
12e1bb687f8ab4875693ad45ac1f33556b40602a150d928e48206ccb7c5aa0ef99acdade9cd6e59142b8e062761de8d0a3b1a83316964ade9577d28e05f1aac9  Qt-AES-e55c81b502c89165ba3a0c94999ea7727b0f3030.tar.gz
33338ed1340e0918c133bb203938a66a8a0e42ce4f095d385568d2a5c6afaa3e90ba297832afce2d0a73fd97607fe02cbe5a1a92daa5ba5d6736146ecbcc62ee  0001-Add-generate_export_header-to-be-able-compile-with-D.patch
a17c0d6578e0d6878099f9c913e54100c44dbb94cf8803f2780d5709ec08136daa832ec2ffe947fb8a91e02320f01041d0e763bcc08350270af36d89f767ca14  amazfish-launcher.sh
930f2cae5f88559a83dd46d11d2161a9239efdd46ad6b91dc530eb4a7863f197a7865f9599973b71bcc7d1e2346c848ea7b9a57f5b714560d101b0f384c0f4d1  amazfish.desktop
"
