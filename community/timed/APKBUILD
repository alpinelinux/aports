maintainer="Bart Ribbers <bribbers@disroot.org>"
pkgname=timed
pkgver=3.6.24
pkgrel=1
pkgdesc="The time daemon manages system time, timezone and settings, executing actions at given time and managing the event queue"
url="https://github.com/sailfishos/timed"
arch="all"
license="LGPL-2.1-only"
depends="tzdata-timed"
depends_dev="
	elogind-dev
	libdsme-dev
	libiodata-dev
	pcre-dev
	qt6-qtbase-dev
	sailfish-access-control
	"
makedepends="$depends_dev
	cmd:iodata-qt6-type-to-c++
	libcap-utils
	"
options="setcap"
subpackages="$pkgname-dev $pkgname-systemd"
install="$pkgname.pre-install"
source="https://github.com/sailfishos/timed/archive/$pkgver/timed-$pkgver.tar.gz
	timed.privileges
	timed.desktop
	"
pkggroups="users"

export TIMED_VERSION="$pkgver"

prepare() {
	default_prepare

	# The build system refers to qmacro.h in a different location
	# Taken from upstream RPM packaging
	mkdir -p src/h/timed-qt6
	ln -f src/lib/qmacro.h src/h/timed-qt6/qmacro.h

	# Fix location of the path
	sed -e 's|etc/dbus-1|usr/share/dbus-1|' \
		-i src/server/server.pro \
		-i tests/ut_networktime/ut_networktime.pro
}

build() {
	qmake6 \
		PREFIX=/usr \
		CONFIG+="dsme_dbus_if ofono"
	make
}

check() {
	make check
}

package() {
	INSTALL_ROOT="$pkgdir" make install

	setcap cap_sys_time+ep "$pkgdir"/usr/bin/timed

	install -Dm755 "$srcdir"/timed.desktop -t "$pkgdir"/etc/xdg/autostart
	install -Dm644 \
		-t "$pkgdir"/usr/share/mapplauncherd/privileges.d \
		"$srcdir"/timed.privileges
	install -dm755 -g users "$pkgdir"/var/lib/timed
	ln -s /usr/share/zoneinfo/UTC "$pkgdir"/var/lib/timed/localtime

	# Remove installed tests
	rm -r "$pkgdir"/opt "$pkgdir"/usr/share/dbus-1/system.d/org.fakeofono.conf

	# Remove setcaps script, we already do this in our packaging
	rm -r "$pkgdir"/usr/lib/oneshot.d
}

sha512sums="
65640e0d779f9db8066b442769e2dac17ea05de119606e862865b8e54a7130d98dcc403b369e4639a14131aad657df8f652f2037d140ea5d0e15f195be381360  timed-3.6.24.tar.gz
8b984fa983f28666d4eb66cde197ba6912e091830671cd105320a161a1708c83736330cfd12dcb0a1288c4a5b5c04f82115fca8651960feba0b1e5f26eccd9e6  timed.privileges
c06426e8066e9a741143c73c7dbcce73e58b079e8571b26135945e8be78cab482a9f831d9d34ce848372659f206ee5e920f80827482b2da0ac80fbddb5a3b125  timed.desktop
"
