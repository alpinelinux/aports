From 8e01c053aae403af786e43540e6a96256e80bd00 Mon Sep 17 00:00:00 2001
From: Damiano Galassi <galad87@users.noreply.github.com>
Date: Sat, 24 Jan 2026 12:27:10 +0100
Subject: [PATCH] contrib: update to SVT-AV1 4.0.0 (#7599)

---
 contrib/svt-av1/module.defs  |  6 +++---
 libhb/common.c               | 10 ++++++++--
 libhb/encsvtav1.c            | 16 +++++++++++++---
 libhb/handbrake/av1_common.h |  2 +-
 4 files changed, 25 insertions(+), 9 deletions(-)

diff --git a/contrib/svt-av1/module.defs b/contrib/svt-av1/module.defs
index a63058238a70..b14624f14a8d 100644
--- a/contrib/svt-av1/module.defs
+++ b/contrib/svt-av1/module.defs
@@ -1,9 +1,9 @@
 $(eval $(call import.MODULE.defs,SVT-AV1,svt-av1))
 $(eval $(call import.CONTRIB.defs,SVT-AV1))
 
-SVT-AV1.FETCH.url     = https://github.com/HandBrake/HandBrake-contribs/releases/download/contribs2/SVT-AV1-v3.1.2.tar.gz
-SVT-AV1.FETCH.url    += https://gitlab.com/AOMediaCodec/SVT-AV1/-/archive/v3.1.2/SVT-AV1-v3.1.2.tar.gz
-SVT-AV1.FETCH.sha256  = d0d73bfea42fdcc1222272bf2b0e2319e9df5574721298090c3d28315586ecb1
+SVT-AV1.FETCH.url     = https://github.com/HandBrake/HandBrake-contribs/releases/download/contribs2/SVT-AV1-v4.0.0.tar.gz
+SVT-AV1.FETCH.url    += https://gitlab.com/AOMediaCodec/SVT-AV1/-/archive/v4.0.0/SVT-AV1-v4.0.0.tar.gz
+SVT-AV1.FETCH.sha256  = 1d99666733ed1359f4ab989b612f88b62a159c2b27b5bfd5e12800f539fe1d70
 
 SVT-AV1.GCC.args.c_std =
 
diff --git a/libhb/common.c b/libhb/common.c
index dfe3e4dbe954..0e2856280974 100644
--- a/libhb/common.c
+++ b/libhb/common.c
@@ -1667,14 +1667,20 @@ void hb_video_quality_get_limits(uint32_t codec, float *low, float *high,
         case HB_VCODEC_FFMPEG_VP8:
         case HB_VCODEC_FFMPEG_VP9:
         case HB_VCODEC_FFMPEG_VP9_10BIT:
-        case HB_VCODEC_SVT_AV1:
-        case HB_VCODEC_SVT_AV1_10BIT:
             *direction   = 1;
             *granularity = 1.;
             *low         = 0.;
             *high        = 63.;
             break;
 
+        case HB_VCODEC_SVT_AV1:
+        case HB_VCODEC_SVT_AV1_10BIT:
+            *direction   = 1;
+            *granularity = 0.25;
+            *low         = 0.;
+            *high        = 70.;
+            break;
+
         case HB_VCODEC_VT_H264:
         case HB_VCODEC_VT_H265:
         case HB_VCODEC_VT_H265_10BIT:
diff --git a/libhb/encsvtav1.c b/libhb/encsvtav1.c
index b24dec46fd22..7da8b440a5a2 100644
--- a/libhb/encsvtav1.c
+++ b/libhb/encsvtav1.c
@@ -27,6 +27,8 @@ void encsvtClose(hb_work_object_t *);
 #define FRAME_INFO_SIZE 2048
 #define FRAME_INFO_MASK (FRAME_INFO_SIZE - 1)
 
+#define MAX_QP_VALUE 63
+
 hb_work_object_t hb_encsvtav1 =
 {
     WORK_ENCSVTAV1,
@@ -124,7 +126,8 @@ int encsvtInit(hb_work_object_t *w, hb_job_t *job)
     }
     else
     {
-        param->qp                = job->vquality;
+        param->qp                         = fmin(job->vquality, MAX_QP_VALUE); // truncated 
+        param->extended_crf_qindex_offset = (job->vquality - param->qp) * 4;
         param->rate_control_mode = SVT_AV1_RC_MODE_CQP_OR_CRF;
         param->force_key_frames = 1;
     }
@@ -184,7 +187,15 @@ int encsvtInit(hb_work_object_t *w, hb_job_t *job)
         }
     }
 
-    if (job->encoder_tune != NULL && strstr("ssim", job->encoder_tune) != NULL)
+    if (job->encoder_tune != NULL && strstr("ms-ssim", job->encoder_tune) != NULL)
+    {
+        param->tune = 4;
+    }
+    else if (job->encoder_tune != NULL && strstr("iq", job->encoder_tune) != NULL)
+    {
+        param->tune = 3;
+    }
+    else if (job->encoder_tune != NULL && strstr("ssim", job->encoder_tune) != NULL)
     {
         param->tune = 2;
     }
@@ -206,7 +217,6 @@ int encsvtInit(hb_work_object_t *w, hb_job_t *job)
         param->fast_decode = 0;
     }
 
-    param->intra_period_length = ((double)job->orig_vrate.num / job->orig_vrate.den + 0.5) * 10;
     // VFR isn't supported, the rate control will ignore
     // the frames timestamps and use the values below
     param->frame_rate_numerator = job->orig_vrate.num;
diff --git a/libhb/handbrake/av1_common.h b/libhb/handbrake/av1_common.h
index f6fd448c1028..50ea96fd021d 100644
--- a/libhb/handbrake/av1_common.h
+++ b/libhb/handbrake/av1_common.h
@@ -31,7 +31,7 @@ static const char * const hb_av1_svt_preset_names[] =
 
 static const char * const hb_av1_svt_tune_names[] =
 {
-    "vq", "psnr", "ssim", "fastdecode", NULL
+    "vq", "psnr", "ssim", "iq", "ms-ssim", "fastdecode", NULL
 };
 
 static const char * const hb_av1_svt_profile_names[] =
