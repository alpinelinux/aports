# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=just
pkgver=1.46.0
pkgrel=0
pkgdesc="Just a command runner"
url="https://github.com/casey/just"
# getting a spurious network error, so added net option
options="net"
arch="all !s390x" # missing nix patch for s390x: https://github.com/nix-rust/nix/pull/2678
license="CC0-1.0"
checkdepends="
	bash
	fzf
	python3
	"
makedepends="cargo cargo-auditable"
subpackages="
	$pkgname-doc
	$pkgname-bash-completion
	$pkgname-fish-completion
	$pkgname-zsh-completion
	"
source="https://github.com/casey/just/archive/$pkgver/just-$pkgver.tar.gz"

export CARGO_PROFILE_RELEASE_OPT_LEVEL="z"

prepare() {
	default_prepare

	cargo fetch --target="$CTARGET" --locked
}

build() {
	cargo auditable build --release --frozen

	mkdir -p completions
	local shell; for shell in bash fish zsh; do
		./target/release/just --completions $shell > completions/just.$shell
	done

	mkdir -p man
	./target/release/just --man > man/just.1
}

check() {
	# Skipped tests are somehow broken.
	cargo test --frozen -- \
		--skip choose::default \
		--skip edit::editor_precedence \
		--skip functions::env_var_functions \
		--skip completions::bash
}

package() {
	install -D -m755 target/release/just -t "$pkgdir"/usr/bin/

	install -D -m644 man/just.1 -t "$pkgdir"/usr/share/man/man1/

	install -D -m644 completions/just.bash \
		"$pkgdir"/usr/share/bash-completion/completions/$pkgname
	install -D -m644 completions/just.fish \
		"$pkgdir"/usr/share/fish/vendor_completions.d/$pkgname.fish
	install -D -m644 completions/just.zsh \
		"$pkgdir"/usr/share/zsh/site-functions/_$pkgname
}

sha512sums="
b374e43ab61199046009aef2e6396f90c3df65246f8551c414e7d342c77587a12e44237620955072adbbe169d1d9befa9592305b0e84178559f4080b49a9cdb2  just-1.46.0.tar.gz
"
