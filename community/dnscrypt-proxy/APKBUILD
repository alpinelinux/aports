# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
pkgname=dnscrypt-proxy
pkgver=2.0.9
pkgrel=1
pkgdesc="A tool for securing communications between a client and a DNS resolver"
url="https://dnscrypt.org/"
arch="all"
license="custom"
makedepends="go libcap"
depends="ca-certificates"
install="$pkgname.pre-install"
pkgusers=dnscrypt
pkggroups=dnscrypt
subpackages="$pkgname-doc"
source="${pkgname}-${pkgver}.tar.gz::https://github.com/jedisct1/$pkgname/archive/$pkgver.tar.gz
	$pkgname.initd
	"
builddir="$srcdir"/$pkgname-$pkgver

build() {
	cd "$srcdir"
	mv $pkgname-$pkgver src
	export GOPATH=$PWD
	cd src/$pkgname
	go clean
	go build -ldflags="-s -w" -o $GOPATH/../build/dnscrypt-proxy
}

check() {
	echo "CHECK"
}

package() {
	mkdir -p "$pkgdir"/usr/sbin
	cp $GOPATH/../build/dnscrypt-proxy "$pkgdir"/usr/sbin
	mkdir -p "$pkgdir"/etc/dnscrypt-proxy
	install -m644 -D "$GOPATH/src/$pkgname/example-dnscrypt-proxy.toml" "$pkgdir"/etc/dnscrypt-proxy/dnscrypt-proxy.toml
	install -m644 -D "$GOPATH/src/$pkgname/example-forwarding-rules.txt" "$pkgdir"/etc/dnscrypt-proxy
	install -m644 -D "$GOPATH/src/$pkgname/example-cloaking-rules.txt" "$pkgdir"/etc/dnscrypt-proxy
	install -m644 -D "$GOPATH/src/$pkgname/example-blacklist.txt" "$pkgdir"/etc/dnscrypt-proxy
	mkdir -p "$pkgdir"/var/log/$pkgname
	mkdir -p "$pkgdir"/var/run/$pkgname
	mkdir -p $pkgdir/usr/share/licenses/$pkgname
	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	setcap cap_net_bind_service=+pe "$pkgdir"/usr/sbin/dnscrypt-proxy
}


sha512sums="4a7273e0a779b4103998930d5e07cd49678b47ec1de242e7865e3f8519ba9d15ce4e672c240e46eff97c407e97ea47f05508c5e70c03dfa569216d403625659e  dnscrypt-proxy-2.0.9.tar.gz
344fc63dda228206c8e2f5b71524481bccb544ecbd71acfb6691044596a0ab27aaf7d97d4031fa6f77e65880bb1a4be23e2d885cbd18290bb484b388e5498954  dnscrypt-proxy.initd"
