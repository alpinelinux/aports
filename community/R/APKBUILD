# Contributor: Artem Klevtsov <a.a.klevtsov@gmail.com>
# Contributor: Nirosan <pnirosan@gmail.com>
# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=R
pkgver=3.3.1
pkgrel=3
pkgdesc="Language and environment for statistical computing"
url="https://www.r-project.org"
# openjdk8-jre-base is currently built only for x86*
arch="x86_64 x86"
license="GPL-2 GPL-3 LGPL-2.1"
depends="$pkgname-mathlib"
depends_dev="gcc gfortran icu-dev libjpeg-turbo libpng-dev make openblas-dev
	pcre-dev>=8.10 readline-dev xz-dev zlib-dev bzip2-dev curl-dev>=7.28
	"
makedepends="$depends_dev tiff-dev cairo-dev pango-dev libxmu-dev tk-dev
	openjdk8-jre-base perl
	"
install="$pkgname.post-install"
subpackages="$pkgname-mathlib $pkgname-dev $pkgname-doc"
source="https://cran.r-project.org/src/base/R-${pkgver%%.*}/$pkgname-$pkgver.tar.gz"
builddir="$srcdir/$pkgname-$pkgver"

build() {
	cd "$builddir"

	# CXXFLAGS is propagated to /etc/R/Makeconf that is read when building
	# additional R modules. -D__MUSL__ is needed for some modules like Rcpp.
	# htps://github.com/RcppCore/Rcpp/issues/448
	CFLAGS="${CFLAGS} -D_DEFAULT_SOURCE" \
	CXXFLAGS="${CXXFLAGS} -D__MUSL__" ./configure \
		--prefix=/usr \
		--sysconfdir=/etc/R \
		--localstatedir=/var \
		rdocdir=/usr/share/doc/R \
		rincludedir=/usr/include/R \
		rsharedir=/usr/share/R \
		--enable-memory-profiling \
		--disable-nls \
		--enable-R-shlib \
		--without-recommended-packages \
		--with-blas="-lopenblas" \
		--with-lapack \
		--with-x \
		|| return 1

	make || return 1
	make -C src/nmath/standalone || return 1
}

package() {
	cd "$builddir"

	make DESTDIR="$pkgdir" install || return 1

	# Install libRmath.so.
	cd src/nmath/standalone
	make DESTDIR="$pkgdir" install || return 1
	cd -

	# Fixup R wrapper script (taken from Arch).
	rm "$pkgdir"/usr/lib/R/bin/R
	ln -sf /usr/bin/R "$pkgdir"/usr/lib/R/bin/R

	# Remove some useless files (COPYING is duplicated, it will be
	# in -doc, don't worry).
	rm "$pkgdir"/usr/lib/R/COPYING "$pkgdir"/usr/lib/R/SVN-REVISION

	mkdir -p "$pkgdir"/etc/R

	# Add Rprofile.site to use further in /etc/R
	touch "$pkgdir"/usr/lib/R/etc/Rprofile.site

	# R apparently ignores --sysconfdir, so we must manually move configs
	# to /etc/R and make symlinks.
	ln -sf "$pkgdir"/usr/lib/R/etc/* "$pkgdir"/etc/R/ || return 1
}

mathlib() {
	pkgdesc="Standalone math library from the R project"

	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libRmath.so* "$subpkgdir"/usr/lib
}

md5sums="f50a659738b73036e2f5635adbd229c5  R-3.3.1.tar.gz"
sha256sums="3dc59ae5831f5380f83c169bac2103ad052efe0ecec4ffa74bde4d85a0fda9e2  R-3.3.1.tar.gz"
sha512sums="d0ff85e99b9ec9cac672aa30d7d1a854778c6a610bcc5336e8c60c8c74f20856f2bfeae085af793fad646ff45cb4677d9d6dcbaa18212591f72f00a02339f4cd  R-3.3.1.tar.gz"
