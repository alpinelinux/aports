# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=wasm-pack
pkgver=0.14.0
pkgrel=0
pkgdesc="rust to wasm build tool"
url="https://github.com/drager/wasm-pack"
arch="all"
license="Apache-2.0"
depends="
	cargo
	rustc-dev
	rust-wasm
	"
makedepends="
	bzip2-dev
	cargo-auditable
	cmake
	curl-dev
	openssl-dev>3
	samurai
	wasi-sdk
	zstd-dev
	"
checkdepends="
	binaryen
	cargo-generate
	nodejs
	wasm-bindgen
	"
source="
	https://github.com/drager/wasm-pack/archive/refs/tags/v$pkgver/wasm-pack-v$pkgver.tar.gz
	any-version.patch
	musl.patch
	upgrade-binary-install.patch
	wasm-bindgen-ver.patch
	"
options="net"

case "$CARCH" in
# blocked by binaryen
s390x) options="$options !check" ;;
esac

export OPENSSL_NO_VENDOR=1

prepare() {
	default_prepare

	# Build against system-provided libzstd.
	mkdir -p .cargo
	cat >> .cargo/config.toml <<-EOF
		[target.$CHOST]
		zstd = { rustc-link-lib = ["zstd"] }
	EOF

	cargo fetch --target="$CHOST" --locked
}

build() {
	cargo auditable build --release --frozen
}

check() {
	RUSTFLAGS= \
	USER="${USER:-user}" \
	cargo test --frozen
}

package() {
	install -Dm755 target/release/wasm-pack \
		-t "$pkgdir"/usr/bin
}

sha512sums="
99d301f9bdfbf0699f381954d8f1a39357e287bdbbd26290a8d8495735f710999be61e5f029b6ff42f5e246f6911ec611e6ac37b5d53145f17146dc88bf43c69  wasm-pack-v0.14.0.tar.gz
761118ab77cfda4d5ae6bbb3b35dfdec7e60287d56cee106ac83f34fd013a60ecb7d8261d30b14ea35a510a87ddcc3887d71b55237b4182e4666a287c9c51766  any-version.patch
eadea4a209fc3916ef755ce2b663585e47f10f857ab32e999d1e995a24a830a21289fc4b59e689484fa7595f2fd3931e5cb3b02e2698d2d9e610494031ed83f9  musl.patch
c7ad5b265e9b4d63189ab1e04d327b57bb50e147d5c9d09fc2991520a267eef64774cdcf110505d9cb830eea51225c1b04410e655b773e69626f6e25b6ebf41d  upgrade-binary-install.patch
56595701ec182b130956382ce55bb48eb174e5dc98cdf51e4c115e8cecefeb5450b6fb8057d683516f98de91ac80a05bcac3612da8a9c430f56f4cac6fd5fcbc  wasm-bindgen-ver.patch
"
