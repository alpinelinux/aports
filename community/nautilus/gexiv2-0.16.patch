From 220a3f644d397937da3895e9a80dc1ca7c70f3c9 Mon Sep 17 00:00:00 2001
From: Khalid Abu Shawarib <khalid.shawarib@gmail.com>
Date: Fri, 19 Sep 2025 03:09:16 +0300
Subject: [PATCH] extensions/image-properties: Update gexiv dependency to 0.16

This requires a library name change.
---
 build-aux/flatpak/org.gnome.Nautilus.json     | 21 +++++++-
 .../nautilus-image-properties-model.c         | 49 +++++++++++--------
 meson.build                                   |  2 +-
 3 files changed, 48 insertions(+), 24 deletions(-)

diff --git a/extensions/image-properties/nautilus-image-properties-model.c b/extensions/image-properties/nautilus-image-properties-model.c
index 8d62d95694..e1f0050d9e 100644
--- a/extensions/image-properties/nautilus-image-properties-model.c
+++ b/extensions/image-properties/nautilus-image-properties-model.c
@@ -122,7 +122,7 @@ append_basic_info (NautilusImagesPropertiesModel *self)
 
     if (self->md_ready)
     {
-        orientation = gexiv2_metadata_try_get_orientation (self->md, NULL);
+        orientation = gexiv2_metadata_get_orientation (self->md, NULL);
     }
 
     if (orientation == GEXIV2_ORIENTATION_ROT_90
@@ -187,15 +187,15 @@ append_gexiv2_tag (NautilusImagesPropertiesModel  *self,
 
     for (const char **i = tag_names; *i != NULL; i++)
     {
-        if (gexiv2_metadata_try_has_tag (self->md, *i, NULL))
+        if (gexiv2_metadata_has_tag (self->md, *i, NULL))
         {
-            g_autofree char *tag_value = NULL;
-
-            tag_value = gexiv2_metadata_try_get_tag_interpreted_string (self->md, *i, NULL);
+            g_autofree char *tag_value = gexiv2_metadata_get_tag_interpreted_string (self->md,
+                                                                                     *i,
+                                                                                     NULL);
 
             if (tag_description == NULL)
             {
-                tag_description = gexiv2_metadata_try_get_tag_description (*i, NULL);
+                tag_description = gexiv2_metadata_get_tag_description (*i, NULL);
             }
 
             /* don't add empty tags - try next one */
@@ -243,22 +243,29 @@ append_gexiv2_info (NautilusImagesPropertiesModel *self)
     append_gexiv2_tag (self, rights, _("Copyright"));
     append_gexiv2_tag (self, rating, _("Rating"));
 
-    if (gexiv2_metadata_try_get_gps_info (self->md, &longitude, &latitude, &altitude, NULL))
+    gexiv2_metadata_get_gps_info (self->md, &longitude, &latitude, &altitude, NULL);
+
+    if (isnan (longitude) == 0 && isinf (longitude) == 0 &&
+        isnan (latitude) == 0 && isinf (latitude) == 0)
     {
-        g_autofree char *gps_coords = NULL;
-
-        gps_coords = g_strdup_printf ("%f째 %s %f째 %s (%.0f m)",
-                                      fabs (latitude),
-                                      /* Translators: "N" and "S" stand for
-                                       * north and south in GPS coordinates. */
-                                      latitude >= 0 ? _("N") : _("S"),
-                                      fabs (longitude),
-                                      /* Translators: "E" and "W" stand for
-                                       * east and west in GPS coordinates. */
-                                      longitude >= 0 ? _("E") : _("W"),
-                                      altitude);
-
-        append_item (self, _("Coordinates"), gps_coords);
+        g_autoptr (GString) gps_coords = g_string_new ("");
+
+        g_string_append_printf (gps_coords, "%f째 %s %f째 %s",
+                                latitude,
+                                /* Translators: "N" and "S" stand for
+                                 * north and south in GPS coordinates. */
+                                latitude >= 0 ? _("N") : _("S"),
+                                longitude,
+                                /* Translators: "E" and "W" stand for
+                                 * east and west in GPS coordinates. */
+                                longitude >= 0 ? _("E") : _("W"));
+
+        if (isnan (altitude) == 0 && isinf (altitude) == 0)
+        {
+            g_string_append_printf (gps_coords, " (%.0f m)", altitude);
+        }
+
+        append_item (self, _("Coordinates"), gps_coords->str);
     }
 }
 
diff --git a/meson.build b/meson.build
index 1f5400f87f..f6faeedae7 100644
--- a/meson.build
+++ b/meson.build
@@ -124,7 +124,7 @@ dependency('wayland-client', required: gtk_wayland.found())
 selinux = dependency('libselinux', version: '>= 2.0', required: get_option('selinux'))
 cloudproviders = dependency('cloudproviders', version: '>= 0.3.1', required: get_option('cloudproviders'))
 if get_option('extensions')
-  gexiv = dependency('gexiv2', version: '>= 0.14.2')
+  gexiv = dependency('gexiv2-0.16', version: '>= 0.16.0')
   gdkpixbuf = dependency('gdk-pixbuf-2.0', version: '>= 2.30.0')
   gst_tag_dep = dependency('gstreamer-tag-1.0')
   gst_pbutils_dep = dependency('gstreamer-pbutils-1.0')
-- 
GitLab

