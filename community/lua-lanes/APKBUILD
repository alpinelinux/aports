# Contributor: Will Sinatra <wpsinatra@gmail.com>
# Maintainer: Will Sinatra <wpsinatra@gmail.com>
pkgname=lua-lanes
_rockname=${pkgname#lua-}
pkgver=3.17.2
pkgrel=0
pkgdesc="portable, message passing multithreading library"
url="https://github.com/LuaLanes/lanes"
license="MIT"
arch="all"
makedepends="luarocks"
source="$_rockname-$pkgver.tar.gz::https://github.com/LuaLanes/lanes/archive/v$pkgver.tar.gz
	fix-inline.patch"
builddir="$srcdir/$_rockname-$pkgver"
_luaversions="5.1 5.2 5.3 5.4"

for _luaversion in $_luaversions; do
	makedepends="$makedepends lua$_luaversion-dev lua$_luaversion-libs"
	subpackages="$subpackages lua$_luaversion-$_rockname:_subpackage"
done

build() {
	local lver; for lver in $_luaversions; do
	msg "Building for Lua $lver..."

	luarocks-$lver \
		CFLAGS="-fPIC -DPTHREAD_MUTEX_RECURSIVE_NP=PTHREAD_MUTEX_RECURSIVE -Dpthread_yield=sched_yield" \
		LUA_INCDIR="$(pkg-config --variable=includedir lua$lver)" \
		make --tree="./build" \
		"$_rockname-$pkgver-"*".rockspec"
	done
}

check() {
	local lver; for lver in $_luaversions; do
		msg "Testing for Lua $lver..."
		LUA_PATH="$builddir/build/share/lua/$lver/?.lua;$builddir/tests/?.lua;;" \
		LUA_CPATH="$builddir/build/lib/lua/$lver/?.so;;" \
		lua$lver tests/basic.lua
	done
}

package() {
	mkdir -p "$pkgdir"
}

_subpackage() {
	local lver="${subpkgname:3:3}"
	pkgdesc="$pkgdesc (for Lua $lver)"
	depends="lua$lver"
	install_if="$pkgname=$pkgver-r$pkgrel lua$lver"

	local path; for path in "lib/lua/$lver" "lib/luarocks/rocks-$lver" "share/lua/$lver"; do
		mkdir -p "$subpkgdir/usr/${path%/*}"
		mv "$builddir/build/$path" "$subpkgdir/usr/$path/"
	done
}

sha512sums="
1d5a7594eb321cfaf2d46668ad2a84e74240e261bc9e7e279b51afa2d8f61024f73fa6ba31a9c05d686bde863f817bb8622b0878b0b2a5e18e87e8348e7eec62  lanes-3.17.2.tar.gz
2e4a0439aa750cd87b4df8a5c9c5207a487cbe14dda10eebbe124c00262c075e61ce454219cee1c61c63964ecc58e5503c788d150f7fe322d9a821cba32aa37a  fix-inline.patch
"
