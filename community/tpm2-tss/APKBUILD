# Contributor: Erik Larsson <who+alpine@cnackers.org>
# Contributor: Alexander Sack <asac@pantacor.com>
# Maintainer: Alexander Sack <asac@pantacor.com>
pkgname=tpm2-tss
pkgver=3.2.1
pkgrel=0
pkgdesc="TPM 2.0 TSS"
url="https://github.com/tpm2-software/tpm2-tss/"
pkgusers="tss"
pkggroups="tss"
arch="all"
license="BSD-2-Clause"
makedepends="
	cmocka-dev
	curl-dev
	json-c-dev
	linux-headers
	openssl-dev>3
	perl
	"
_depends_fapi="acl"
subpackages="
	$pkgname-doc
	$pkgname-mu
	$pkgname-sys
	$pkgname-esys
	$pkgname-tcti-device
	$pkgname-tcti-mssim
	$pkgname-tcti-swtpm
	$pkgname-tcti-cmd
	$pkgname-tcti-pcap
	$pkgname-rc
	$pkgname-tctildr
	$pkgname-fapi
	$pkgname-static
	$pkgname-dev
	"
install="tpm2-tss-fapi.pre-install tpm2-tss-fapi.pre-upgrade tpm2-tss-fapi.post-install tpm2-tss-fapi.post-upgrade"
source="
	https://github.com/tpm2-software/tpm2-tss/releases/download/$pkgver/tpm2-tss-$pkgver.tar.gz
	musl-32bit-stat-workaround.patch
	"

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--without-udevrulesdir \
		--with-tctidefaultmodule=device \
		--with-tctidefaultconfig=/dev/tpmrm0 \
		--with-crypto=ossl \
		--enable-unit
	make
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install
	rm -rf "$pkgdir"/etc/tmpfiles.d
	rm -rf "$pkgdir"/etc/sysusers.d
}

mu() {
	pkgdesc="TPM 2.0 Marshaling libraries"

	amove usr/lib/libtss2-mu.so.*
}

sys() {
	pkgdesc="TPM 2.0 System API libraries"

	amove usr/lib/libtss2-sys.so.*
}

esys() {
	pkgdesc="TPM 2.0 Enhanced System API libraries"

	amove usr/lib/libtss2-esys.so.*
}

device() {
	pkgdesc="TPM 2.0 Device TCTI"
	provides="libtss2-tcti"
	provider_priority="100"

	amove usr/lib/libtss2-tcti-device.so.*
}

mssim() {
	pkgdesc="TPM 2.0 Simulator TCTI"
	provides="libtss2-tcti"
	provider_priority="10"

	amove usr/lib/libtss2-tcti-mssim.so.*
}

rc() {
	pkgdesc="TPM 2.0 RC libraries"

	amove usr/lib/libtss2-rc.so.*
}

tctildr() {
	pkgdesc="TPM 2.0 TCTI loader libraries"

	amove usr/lib/libtss2-tctildr.so.*
}

fapi() {
	depends="$_depends_fapi"
	pkgdesc="TPM 2.0 FAPI libraries"

	amove usr/lib/libtss2-fapi.so.* \
		etc/tpm2-tss/fapi-config.json \
		etc/tpm2-tss/fapi-profiles \
		var/lib/tpm2-tss
}

swtpm() {
	pkgdesc="TPM 2.0 SWTPM TCTI"
	provides="libtss2-tcti"
	provider_priority="10"

	amove usr/lib/libtss2-tcti-swtpm.so.*
}

cmd() {
	pkgdesc="TPM 2.0 CMD TCTI"
	provides="libtss2-tcti"
	provider_priority="10"

	amove usr/lib/libtss2-tcti-cmd.so.*
}

pcap() {
	pkgdesc="TPM 2.0 PCAP TCTI"
	provides="libtss2-tcti"
	provider_priority="10"

	amove usr/lib/libtss2-tcti-pcap.so.*
}

sha512sums="
dbe5e29349d78621fcd608d9c75fa58f5e6462264b9654ca85af9f9faafebe1107d9f735a1b6ad4956a089b0dd96cbda3f46364cabd846f9fb29a419b074c78f  tpm2-tss-3.2.1.tar.gz
5177b9a83b27124176d01d2a0213120916af0c3ebb5037990a860199aa5c41baed7d3e2876e1e7e94c4b2eb22a9f9f01bd152e454acbef8bbffad013debd65df  musl-32bit-stat-workaround.patch
"
