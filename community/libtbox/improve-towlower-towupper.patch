https://github.com/xmake-io/xmake/issues/7317
https://github.com/xmake-io/xmake/pull/7318
https://github.com/tboox/tbox/commit/ef851bcb6589b6092f5bd3fca4625631237f9bdd

From ef851bcb6589b6092f5bd3fca4625631237f9bdd Mon Sep 17 00:00:00 2001
From: ruki <waruqi@gmail.com>
Date: Fri, 13 Feb 2026 00:37:30 +0800
Subject: [PATCH] improve towlower and towupper

---
 src/tbox/libc/wctype/towlower.c | 73 +++++++++++++++++++++++++++++++-
 src/tbox/libc/wctype/towupper.c | 75 ++++++++++++++++++++++++++++++++-
 src/tbox/utils/bits.h           | 29 ++++++++++++-
 3 files changed, 174 insertions(+), 3 deletions(-)

diff --git a/src/tbox/libc/wctype/towlower.c b/src/tbox/libc/wctype/towlower.c
index 37a125009..936b1d813 100644
--- a/src/tbox/libc/wctype/towlower.c
+++ b/src/tbox/libc/wctype/towlower.c
@@ -26,11 +26,74 @@
 #include "../libc.h"
 #ifdef TB_CONFIG_OS_WINDOWS
 #   include <windows.h>
+#else
+#   include "../../utils/bits.h"
 #endif
 #ifdef TB_CONFIG_LIBC_HAVE_TOWLOWER
 #   include <wctype.h>
 #endif
 
+/* //////////////////////////////////////////////////////////////////////////////////////
+ * private implementation
+ */
+#ifndef TB_CONFIG_OS_WINDOWS
+static __tb_inline__ tb_bool_t tb_unicode_tolower_try(tb_uint32_t ch, tb_uint32_t* out)
+{
+    // builtin, locale-independent case mapping for some common unicode ranges:
+    // - Basic Latin (ASCII)
+    // - Latin-1 Supplement (partial)
+    // - Latin Extended-A (partial)
+    // - Greek (partial)
+    // - Cyrillic (partial)
+    if (sizeof(tb_wchar_t) == 2 && ch >= 0xd800 && ch <= 0xdfff) return tb_false;
+
+    // Basic Latin (ASCII)
+    if (ch <= 0x7f)
+    {
+        if ((tb_uint32_t)(ch - 0x41) <= (0x5a - 0x41)) *out = ch + 0x20;
+        else *out = ch;
+        return tb_true;
+    }
+
+    // Latin-1 Supplement: U+00C0..U+00D6, U+00D8..U+00DE
+    if ((ch >= 0x00c0 && ch <= 0x00d6) || (ch >= 0x00d8 && ch <= 0x00de)) { *out = ch + 0x20; return tb_true; }
+    // Latin-1 Supplement: U+00E0..U+00F6, U+00F8..U+00FE
+    if ((ch >= 0x00e0 && ch <= 0x00f6) || (ch >= 0x00f8 && ch <= 0x00fe)) { *out = ch; return tb_true; }
+
+    // Latin-1 Supplement: U+0178 <-> U+00FF
+    if (ch == 0x0178) { *out = 0x00ff; return tb_true; }
+    if (ch == 0x00ff) { *out = ch; return tb_true; }
+
+    // Latin Extended Additional: U+1E9E <-> U+00DF
+    if (ch == 0x1e9e) { *out = 0x00df; return tb_true; }
+    if (ch == 0x00df) { *out = ch; return tb_true; }
+
+    // Latin Extended-A: many letters have alternating upper/lower code points
+    if (ch >= 0x0100 && ch <= 0x012f) { *out = (ch & 0x1) ? ch : (ch + 1); return tb_true; }
+    if (ch >= 0x0132 && ch <= 0x0137) { *out = (ch & 0x1) ? ch : (ch + 1); return tb_true; }
+    if (ch >= 0x0139 && ch <= 0x0148) { *out = (ch & 0x1) ? (ch + 1) : ch; return tb_true; }
+    if (ch >= 0x014a && ch <= 0x0177) { *out = (ch & 0x1) ? ch : (ch + 1); return tb_true; }
+    if (ch >= 0x0179 && ch <= 0x017e) { *out = (ch & 0x1) ? (ch + 1) : ch; return tb_true; }
+    // Latin Extended-A: long s (already lowercase)
+    if (ch == 0x017f) { *out = ch; return tb_true; }
+
+    // Greek and Coptic (partial): U+0391..U+03A1, U+03A3..U+03AB
+    if ((ch >= 0x0391 && ch <= 0x03a1) || (ch >= 0x03a3 && ch <= 0x03ab)) { *out = ch + 0x20; return tb_true; }
+    // Greek and Coptic (partial): U+03B1..U+03C1, U+03C3..U+03CB, and U+03C2
+    if ((ch >= 0x03b1 && ch <= 0x03c1) || (ch >= 0x03c3 && ch <= 0x03cb) || ch == 0x03c2) { *out = ch; return tb_true; }
+
+    // Cyrillic (partial): U+0401/U+0451 and U+0410..U+042F
+    if (ch == 0x0401) { *out = 0x0451; return tb_true; }
+    if (ch == 0x0451) { *out = ch; return tb_true; }
+    if (ch >= 0x0402 && ch <= 0x040f) { *out = ch + 0x50; return tb_true; }
+    if (ch >= 0x0452 && ch <= 0x045f) { *out = ch; return tb_true; }
+    if (ch >= 0x0410 && ch <= 0x042f) { *out = ch + 0x20; return tb_true; }
+    if (ch >= 0x0430 && ch <= 0x044f) { *out = ch; return tb_true; }
+
+    return tb_false;
+}
+#endif
+
 /* //////////////////////////////////////////////////////////////////////////////////////
  * interfaces
  */
@@ -38,9 +101,17 @@ tb_wchar_t tb_towlower(tb_wchar_t c)
 {
 #ifdef TB_CONFIG_OS_WINDOWS
     return (tb_wchar_t)(tb_size_t)CharLowerW((LPWSTR)(tb_size_t)c);
-#elif defined(TB_CONFIG_LIBC_HAVE_TOWLOWER)
+#else
+    tb_uint32_t ch = tb_bits_wchar_to_u32_le(c);
+    tb_uint32_t out;
+    if (__tb_likely__(tb_unicode_tolower_try(ch, &out)))
+        return tb_bits_u32_le_to_wchar(out);
+
+#if defined(TB_CONFIG_LIBC_HAVE_TOWLOWER)
+    // fallback to libc: the result may depend on the current locale
     return (tb_wchar_t)towlower((wint_t)c);
 #else
     return tb_tolower(c);
 #endif
+#endif
 }
diff --git a/src/tbox/libc/wctype/towupper.c b/src/tbox/libc/wctype/towupper.c
index d680f0f43..99c26d2b5 100644
--- a/src/tbox/libc/wctype/towupper.c
+++ b/src/tbox/libc/wctype/towupper.c
@@ -26,11 +26,76 @@
 #include "../libc.h"
 #ifdef TB_CONFIG_OS_WINDOWS
 #   include <windows.h>
+#else
+#   include "../../utils/bits.h"
 #endif
 #ifdef TB_CONFIG_LIBC_HAVE_TOWUPPER
 #   include <wctype.h>
 #endif
 
+/* //////////////////////////////////////////////////////////////////////////////////////
+ * private implementation
+ */
+#ifndef TB_CONFIG_OS_WINDOWS
+static __tb_inline__ tb_bool_t tb_unicode_toupper_try(tb_uint32_t ch, tb_uint32_t* out)
+{
+    // builtin, locale-independent case mapping for some common unicode ranges:
+    // - Basic Latin (ASCII)
+    // - Latin-1 Supplement (partial)
+    // - Latin Extended-A (partial)
+    // - Greek (partial)
+    // - Cyrillic (partial)
+    if (sizeof(tb_wchar_t) == 2 && ch >= 0xd800 && ch <= 0xdfff) return tb_false;
+
+    // Basic Latin (ASCII)
+    if (ch <= 0x7f)
+    {
+        if ((tb_uint32_t)(ch - 0x61) <= (0x7a - 0x61)) *out = ch - 0x20;
+        else *out = ch;
+        return tb_true;
+    }
+
+    // Latin-1 Supplement: U+00E0..U+00F6, U+00F8..U+00FE
+    if ((ch >= 0x00e0 && ch <= 0x00f6) || (ch >= 0x00f8 && ch <= 0x00fe)) { *out = ch - 0x20; return tb_true; }
+    // Latin-1 Supplement: U+00C0..U+00D6, U+00D8..U+00DE
+    if ((ch >= 0x00c0 && ch <= 0x00d6) || (ch >= 0x00d8 && ch <= 0x00de)) { *out = ch; return tb_true; }
+
+    // Latin-1 Supplement: U+00FF <-> U+0178
+    if (ch == 0x00ff) { *out = 0x0178; return tb_true; }
+    if (ch == 0x0178) { *out = ch; return tb_true; }
+
+    // Latin Extended Additional: U+00DF <-> U+1E9E
+    if (ch == 0x00df) { *out = 0x1e9e; return tb_true; }
+    if (ch == 0x1e9e) { *out = ch; return tb_true; }
+
+    // Latin Extended-A: many letters have alternating upper/lower code points
+    if (ch >= 0x0100 && ch <= 0x012f) { *out = (ch & 0x1) ? (ch - 1) : ch; return tb_true; }
+    if (ch >= 0x0132 && ch <= 0x0137) { *out = (ch & 0x1) ? (ch - 1) : ch; return tb_true; }
+    if (ch >= 0x0139 && ch <= 0x0148) { *out = (ch & 0x1) ? ch : (ch - 1); return tb_true; }
+    if (ch >= 0x014a && ch <= 0x0177) { *out = (ch & 0x1) ? (ch - 1) : ch; return tb_true; }
+    if (ch >= 0x0179 && ch <= 0x017e) { *out = (ch & 0x1) ? ch : (ch - 1); return tb_true; }
+    // Latin Extended-A: long s -> S
+    if (ch == 0x017f) { *out = 0x0053; return tb_true; }
+
+    // Greek and Coptic (partial): U+03B1..U+03C1, U+03C3..U+03CB
+    if ((ch >= 0x03b1 && ch <= 0x03c1) || (ch >= 0x03c3 && ch <= 0x03cb)) { *out = ch - 0x20; return tb_true; }
+    // Greek and Coptic (partial): U+0391..U+03A1, U+03A3..U+03AB
+    if ((ch >= 0x0391 && ch <= 0x03a1) || (ch >= 0x03a3 && ch <= 0x03ab)) { *out = ch; return tb_true; }
+    // Greek and Coptic: U+03C2 -> U+03A3
+    if (ch == 0x03c2) { *out = 0x03a3; return tb_true; }
+
+    // Cyrillic (partial): U+0401/U+0451 and U+0430..U+044F
+    if (ch == 0x0451) { *out = 0x0401; return tb_true; }
+    if (ch == 0x0401) { *out = ch; return tb_true; }
+    if (ch >= 0x0452 && ch <= 0x045f) { *out = ch - 0x50; return tb_true; }
+    if (ch >= 0x0402 && ch <= 0x040f) { *out = ch; return tb_true; }
+    if (ch >= 0x0430 && ch <= 0x044f) { *out = ch - 0x20; return tb_true; }
+    if (ch >= 0x0410 && ch <= 0x042f) { *out = ch; return tb_true; }
+
+    return tb_false;
+}
+#endif
+
 /* //////////////////////////////////////////////////////////////////////////////////////
  * interfaces
  */
@@ -38,9 +103,17 @@ tb_wchar_t tb_towupper(tb_wchar_t c)
 {
 #ifdef TB_CONFIG_OS_WINDOWS
     return (tb_wchar_t)(tb_size_t)CharUpperW((LPWSTR)(tb_size_t)c);
-#elif defined(TB_CONFIG_LIBC_HAVE_TOWUPPER)
+#else
+    tb_uint32_t ch = tb_bits_wchar_to_u32_le(c);
+    tb_uint32_t out;
+    if (__tb_likely__(tb_unicode_toupper_try(ch, &out)))
+        return tb_bits_u32_le_to_wchar(out);
+
+#if defined(TB_CONFIG_LIBC_HAVE_TOWUPPER)
+    // fallback to libc: the result may depend on the current locale
     return (tb_wchar_t)towupper((wint_t)c);
 #else
     return tb_toupper(c);
 #endif
+#endif
 }
diff --git a/src/tbox/utils/bits.h b/src/tbox/utils/bits.h
index 8a900352f..44aceeac3 100644
--- a/src/tbox/utils/bits.h
+++ b/src/tbox/utils/bits.h
@@ -687,6 +687,34 @@ static __tb_inline__ tb_hize_t tb_bits_swap_u64_inline(tb_hize_t x)
     return r.u64;
 }
 
+static __tb_inline__ tb_uint32_t tb_bits_wchar_to_u32_le(tb_wchar_t c)
+{
+    if (sizeof(tb_wchar_t) == 4)
+        return tb_bits_le_to_ne_u32((tb_uint32_t)c);
+    else return (tb_uint32_t)tb_bits_le_to_ne_u16((tb_uint16_t)c);
+}
+
+static __tb_inline__ tb_uint32_t tb_bits_wchar_to_u32_be(tb_wchar_t c)
+{
+    if (sizeof(tb_wchar_t) == 4)
+        return tb_bits_be_to_ne_u32((tb_uint32_t)c);
+    else return (tb_uint32_t)tb_bits_be_to_ne_u16((tb_uint16_t)c);
+}
+
+static __tb_inline__ tb_wchar_t tb_bits_u32_le_to_wchar(tb_uint32_t ch)
+{
+    if (sizeof(tb_wchar_t) == 4)
+        return (tb_wchar_t)tb_bits_ne_to_le_u32(ch);
+    else return (tb_wchar_t)tb_bits_ne_to_le_u16((tb_uint16_t)ch);
+}
+
+static __tb_inline__ tb_wchar_t tb_bits_u32_be_to_wchar(tb_uint32_t ch)
+{
+    if (sizeof(tb_wchar_t) == 4)
+        return (tb_wchar_t)tb_bits_ne_to_be_u32(ch);
+    else return (tb_wchar_t)tb_bits_ne_to_be_u16((tb_uint16_t)ch);
+}
+
 /* //////////////////////////////////////////////////////////////////////////////////////
  * cl0
  */
@@ -1031,4 +1059,3 @@ static __tb_inline__ tb_void_t tb_bits_set_double_lle_inline(tb_byte_t* p, tb_do
 __tb_extern_c_leave__
 
 #endif
-
