# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer: Carlo Landmeter <clandmeter@gmail.com>
pkgname=lego
pkgver=0.3.1
pkgrel=1
pkgdesc="Let's Encrypt client and ACME library written in Go"
url="https://github.com/xenolf/lego"
arch="all"
license="MIT"
depends="ca-certificates"
depends_dev=""
makedepends="$depends_dev go git libcap"
subpackages=""
source="${pkgname}-${pkgver}.tar.gz::https://github.com/xenolf/$pkgname/archive/v$pkgver.tar.gz
	use-correct-version.patch
	b5d5eee2dd269f88f181d7a437be80194bfd0235.patch
	glide.yaml
	glide.lock
	"

builddir="$srcdir"/github.com/xenolf/lego

prepare() {
	mkdir -p $(dirname $builddir) || return 1
	mv "$srcdir"/$pkgname-$pkgver "$builddir"/ || return 1

	default_prepare || return 1
}

build() {
	export GOPATH="$startdir"
	cd "$builddir" || return 1
	mv "$srcdir"/glide.yaml "$srcdir"/glide.lock .
	glide install --skip-test || return 1
	go build -v -o e${pkgname} || return 1
}

package() {
	cd "$builddir"
	install -Dm755 e${pkgname} \
		"$pkgdir"/usr/bin/lego || return 1
	# allow non root to use priv ports
	setcap cap_net_bind_service=+ep \
		"$pkgdir"/usr/bin/lego || return 1
}

glide_init() {
	# caddy does not handle versioned dependencies.
	# we calculate them with glide and lock them.
	abuild clean deps unpack prepare
	export GOPATH="$startdir"
	cd "$builddir"
	mv glide.yaml glide.yaml.upstream 2>/dev/null
	mv glide.lock glide.lock.upstream 2>/dev/null
	glide init --non-interactive || return 1 # Generate yaml
	glide update || return 1 # Generate lock
	if [ -f glide.yaml.upstream ]; then
		diff -u glide.yaml.upstream glide.yaml > "$startdir"/glide.yaml.patch
	else
		cp glide.yaml "$startdir"
	fi
	if [ -f glide.lock.upstream ]; then
		diff -u glide.lock.upstream glide.lock > "$startdir"/glide.lock.patch
	else
		cp glide.lock "$startdir"
	fi
	cd "$startdir" && abuild checksum clean
}

md5sums="8d79ea6115ec2430e1098ecc6eafddfa  lego-0.3.1.tar.gz
4d2fa7abbc0d13ea7c3c70557da30dfc  use-correct-version.patch
ec144bfd625e0ad1859d96e788965dd1  b5d5eee2dd269f88f181d7a437be80194bfd0235.patch
5b8f132be990e21f186412c65311f19b  glide.yaml
fe00ab338f2a06e4346ffd99052df270  glide.lock"
sha256sums="628a0dfa7c02ba833056ad8077a0e391a6658f03ddeec51d3c9f3f937cb482ab  lego-0.3.1.tar.gz
f6e14ab24e3a8ff55fd51f330fb0ad8d453a52562f8784c2a26d6671765a91b7  use-correct-version.patch
e887ba93c8c4151de253cec5a669fbb0ac29d6e035a58e464e0f6bc10a8713f4  b5d5eee2dd269f88f181d7a437be80194bfd0235.patch
582dfcce324832233a78c6d353eeb36023bf15049326b04365b0a76971aa30e1  glide.yaml
0adaea3b9de5529cdf59fcea94d20fc5c52839e15a6cd30fe8b1272844024796  glide.lock"
sha512sums="e0afa9754b2bc81375a8b259446473ba1ecb73ff575404aaedaa477cd289e67debfc52fd384bee1b356d1a0708fb2ac5c05cbe27b541652ad0d7484ba12a97ea  lego-0.3.1.tar.gz
99f6769da6c9b335a9e23affb7c5546741b6b6265b9a5474adcd31829f10613d12e5bad84a2c74ee74de0d987d234a0403b88b4ec5e385b9f03eecb1d747aa49  use-correct-version.patch
5c24227372e32294c8a38061b1c8c53cb715d24db23bd315efb017fbbc8374cae3010da2d8779bee8c6ebf737a255837264e24cbb4efe03a14597721217fc4f6  b5d5eee2dd269f88f181d7a437be80194bfd0235.patch
76216ac3fea141cf96144cf00502f656c7ac4bd852c17680a6364f17e0d3b7396f5c64c8d078771d54914c3fb1d6b093e65db4536d0a15a23eae09833cc4806f  glide.yaml
96d1cb11b704338771e7aca0da0a2b1e684ba5f927a0d746095160e1d225708099919b3a248b4ca3a3e5b2d75632807c1f08d6aee62c02ea2f7cc97f3710aa02  glide.lock"
