# Maintainer: Peter van Dijk <peter.van.dijk@powerdns.com>
pkgname=dnsdist
pkgver=2.0.2
pkgrel=0
pkgdesc="dnsdist is a highly DNS-, DoS-, and abuse-aware loadbalancer."
url="https://dnsdist.org/"
arch="all"
license="GPL-2.0-only WITH OpenSSL-Exception"
depends="$pkgname-common"
checkdepends="findutils"
makedepends="
	boost-dev
	cargo
	fstrm-dev
	libedit-dev
	libsodium-dev
	lmdb-dev
	lua5.4-dev
	net-snmp-dev
	nghttp2-dev
	openssl-dev
	py3-yaml
	re2-dev
	wslay-dev
	"
pkgusers="dnsdist"
pkggroups="dnsdist"
install="$pkgname-common.pre-install"
subpackages="$pkgname-common::noarch $pkgname-doc $pkgname-common-openrc::noarch"
source="
	https://downloads.powerdns.com/releases/dnsdist-${pkgver//_/-}.tar.xz
	$pkgname.initd
	dolog.patch
	"
builddir="$srcdir/$pkgname-${pkgver//_/-}"

[ "$CARCH" = "ppc64le" ] && options="!check" # failing tests

case "$CARCH" in
ppc64le|riscv64|loongarch64)
	_luajit=OFF
	;;
*)
	makedepends="$makedepends luajit-dev"
	subpackages="$subpackages $pkgname-luajit"
	_luajit=ON
	;;
esac

# secfixes:
#   2.0.1-r0:
#     - CVE-2025-4820
#     - CVE-2025-4821
#     - CVE-2025-7054
#     - CVE-2025-8671
#     - CVE-2025-30187
#   1.9.10-r0:
#     - CVE-2025-30193
#   1.9.9-r0:
#     - CVE-2025-30194
#   1.9.4-r0:
#     - CVE-2024-25581

prepare() {
	default_prepare
	if [ "$_luajit" = "ON" ]; then
		cp -a "$builddir" "$builddir-jit"
	fi
}

_configure() {
	local arg="$1"
	local lua

	if [ "$arg" = '-jit' ]; then
		lua="luajit"
	else
		lua="lua5.4"
	fi

	cd "$builddir$arg"

	./configure \
		--build="$CBUILD" \
		--host="$CHOST" \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--enable-dnscrypt \
		--enable-dns-over-tls \
		--enable-dns-over-https \
		--enable-unit-tests \
		--with-re2 \
		--with-boost=/usr/include \
		--with-net-snmp \
		--with-lua=$lua \
		--enable-yaml
}

build() {
	_configure
	make

	[ -d "$builddir-jit" ] || return 0

	_configure -jit
	make
}

_cat_found_file() {
	local _rc="$?"
	find . -name "$1" -type f -ls -printf '%P {{{\n' -exec cat -v -n '{}' ';' -printf '}}} %P\n'
	return "$_rc"
}

check() {
	make check || _cat_found_file 'test-suite.log'
	./dnsdist --version

	if cd "$builddir-jit"; then
		make check || _cat_found_file 'test-suite.log'
		./dnsdist --version
	fi
}

package() {
	make DESTDIR="$pkgdir" install
}

common() {
	pkgdesc="$pkgname common files"
	depends=""

	mkdir -p "$subpkgdir"/etc
	mv "$pkgdir"/etc/* "$subpkgdir"/etc
}

# the subpkg is dnsdist-common-openrc here
openrc() {
	install_if="$pkgname-common"

	install -m755 -D "$srcdir/$pkgname.initd" \
		"$subpkgdir/etc/init.d/$pkgname"
}

luajit() {
	pkgdesc="$pkgname with luajit bindings"
	depends="$pkgname-common"
	provides="$pkgname=$pkgver-r$pkgrel"

	cd "$builddir-jit"
	make DESTDIR="$subpkgdir" install-exec
	rm "$subpkgdir"/etc/*
}

sha512sums="
7f53d13bb90b7b70da364341e50473b88be0bc9619e3263e352bed75aa57edbc018824439749956281a2c7a5d32c653e7378fe9d3cbc296042fa8120eee75fae  dnsdist-2.0.2.tar.xz
9b72450a9887b4e6de9c964b3e5eb1d97ea2391209582d9bec9766739bbcc0ef309d91972144bb2c62d90099712d6a7b466729cd54389419a46e0fa962192c1a  dnsdist.initd
6b4e9c20e1a3c3e3cd63292e6ecf2fa61c1c6a7fcc6939284fbb803f671bc199d3362b17cd9adbc96dee03087be2c4c2c5f1495b8e2a79d14747815a2e45ba12  dolog.patch
"
