# Contributor: Valery Kartel <valery.kartel@gmail.com>
# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
pkgname=bareos
pkgver=16.2.6
pkgrel=0
pkgdesc="Bareos - Backup Archiving REcovery Open Sourced"
url="http://www.bareos.org"
arch="all"
options="!check"
license="AGPL3"
depends="perl"
makedepends="file libtool libintl libpcap-dev lzo-dev \
	sqlite-dev postgresql-dev libressl-dev mariadb-dev acl-dev \
	qt-dev python2-dev readline-dev ncurses-dev jansson-dev"
install="$pkgname.pre-install $pkgname.post-install"
subpackages="$pkgname-dev $pkgname-doc $pkgname-bat $pkgname-trayicon"
pkgusers=$pkgname
pkggroups=$pkgname
source="$pkgname-$pkgver.tar.gz::https://github.com/$pkgname/$pkgname/archive/Release/$pkgver.tar.gz
	$pkgname-dir.initd
	$pkgname-sd.initd
	$pkgname-fd.initd
	path-mounted.patch"
builddir="$srcdir"/${pkgname}-Release-${pkgver}

prepare() {
	update_config_guess
	default_prepare
}

build() {
	cd "$builddir"
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--with-confdir=/etc/$pkgname \
		--with-archivedir=/var/lib/$pkgname/archive \
		--with-scriptdir=/etc/$pkgname/scripts \
		--with-working-dir=/var/lib/$pkgname \
		--with-plugindir=/usr/lib/$pkgname \
		--with-backenddir=/usr/lib/$pkgname \
		--with-pid-dir=/run \
		--with-logdir=/var/log/$pkgname \
		--with-subsys-dir=/var/lock \
		--enable-bat \
		--enable-smartalloc \
		--enable-largefile \
		--enable-readline \
		--enable-traymonitor \
		--enable-batch-insert \
		--enable-acl \
		--enable-xattr \
		--enable-scsi-crypto \
		--enable-lmdb \
		--enable-ipv6 \
		--enable-dynamic-cats-backends \
		--enable-dynamic-debian-package-list \
		--enable-sql-pooling \
		--enable-includes \
		--disable-conio \
		--disable-nls \
		--disable-rpath \
		--with-postgresql \
		--with-mysql \
		--with-sqlite3 \
		--with-openssl \
		--with-python \
		--without-systemd \
		--with-dir-user=$pkgname \
		--with-dir-group=$pkgname \
		--with-sd-user=$pkgname \
		--with-sd-group=$pkgname \
		--with-fd-user=root \
		--with-fd-group=root
	make
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir" install

	local daemon; for daemon in dir sd fd; do
		install -Dm755 "$srcdir"/$pkgname-$daemon.initd \
			"$pkgdir"/etc/init.d/$pkgname-$daemon
	done

	# Install logrotate script
	install -Dm644 scripts/logrotate "$pkgdir"/etc/logrotate.d/$pkgname

	local dir; for dir in /var/lib/$pkgname /var/lib/$pkgname/archive \
		/etc/$pkgname/scripts/make_catalog_backup* \
		/etc/$pkgname/scripts/mtx-changer*; do
		chown $pkgname:$pkgname "$pkgdir"/$dir || return 1
	done
}

bat() {
	local dir name=${subpkgname#$pkgname-}
	depends="$pkgname"
	pkgdesc="$pkgdesc (qt administration tool)"
	mkdir -p "$subpkgdir"/etc/$pkgname "$subpkgdir"/usr/bin
	for dir in applications pixmaps; do
		mkdir -p "$subpkgdir"/usr/share/$dir
		mv "$pkgdir"/usr/share/$dir/$name.* "$subpkgdir"/usr/share/$dir
	done
	mv "$pkgdir"/etc/$pkgname/$name.* "$subpkgdir"/etc/$pkgname
	mv "$pkgdir"/usr/bin/$name "$subpkgdir"/usr/bin
}

trayicon() {
	depends="$pkgname"
	pkgdesc="$pkgdesc (qt tray monitor)"
	mkdir -p "$subpkgdir"/etc/$pkgname "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/share "$subpkgdir"/usr
	mv "$pkgdir"/etc/xdg "$subpkgdir"/etc
	mv "$pkgdir"/etc/$pkgname/tray-monitor.d "$subpkgdir"/etc/$pkgname
	mv "$pkgdir"/usr/bin/bareos-tray-monitor "$subpkgdir"/usr/bin
}

sha512sums="f379fd1d568260b1ad3c426b7b80b1d33a1b078db1aa03b847a4e1dc262cf0155419f20f7105bc095167bb5e64169d5e6b0bcfa3e3913d5e4b5f8f23f4fde750  bareos-16.2.6.tar.gz
e895b7d7de17a3f7c19dadb0072b0aaecbd9225a071e569b1ab537a3b51dc714a43f2cd044c638151ef5b1d6e9ab533201a15d386b157d1acedbccec1431bce3  bareos-dir.initd
8991b90e4cbfdb8b73b17421b8970788e9d2a669c7ba981dbfa8573bc7b6bcfa174fa38771f6bffaf408efd9f8f544e746458c214a1af0e23917dfb87048467d  bareos-sd.initd
dab8aa37e44743649b7c5ba1e41ee2d020b966481e390005e13af0514ae63e27ba06b59b7c3ceb7bebb81607cd72beffcc3cdea62815387494a2c2e5b03e8dfa  bareos-fd.initd
eac4614c1b29ff0f12061837e425ae495890076021b6d1b0f1beb93501cfb905170342dac5dab69b09f825d5b9416eea25fa02e2174b5a704315c7feb08ff3d3  path-mounted.patch"
