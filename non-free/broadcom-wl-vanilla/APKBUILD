# Contributor: Rohan Hendrik Jotz-Lean <rohan@rohanlean.de>
# Maintainer:

_kflavour='-vanilla'
_kpkgname="linux${_kflavour}"
_kpkgver=4.14.52
_kpkgrel=0

_realpkgname=broadcom-wl
_realpkgver=6.30.223.271
_realpkgrel=0   # bump when increasing _realpkgver, reset when increasing _kpkgver

pkgname="${_realpkgname}${_kflavour}"
pkgver="$_kpkgver"
pkgrel=$(($_kpkgrel + $_realpkgrel))
pkgdesc='Broadcom 802.11 Linux STA wireless driver'
url='https://www.broadcom.com/support/download-search/?pf=Wireless+LAN+Infrastructure'
arch='x86_64'
license='other'

depends="${_kpkgname}=${_kpkgver}-r${_kpkgrel}"
makedepends="${_kpkgname}-dev=${_kpkgver}-r${_kpkgrel}"

source="
	001-null-pointer-fix.patch
	002-rdtscl.patch
	003-linux47.patch
	004-linux48.patch
	005-debian-fix-kernel-warnings.patch
	006-linux411.patch
	007-linux412.patch
	008-linux415.patch
	broadcom-wl.conf
	https://docs.broadcom.com/docs-and-downloads/docs/linux_sta/hybrid-v35_64-nodebug-pcoem-${_realpkgver//./_}.tar.gz
"

builddir="$srcdir/"

prepare() {
	(
	if [ -f "$startdir"/../../main/linux${_kflavour}/APKBUILD ]; then
		. "$startdir"/../../main/linux${_kflavour}/APKBUILD
		if [ "$_kpkgver" != "$pkgver" ]; then
			die "$pkgname: Please update _kpkgver to $pkgver"
		fi
		if [ "$_kpkgrel" != "$pkgrel"; then
			die "$pkgname: Please update _kpkgrel to $pkgrel"
		fi
	fi
	) || return 1

	default_prepare
	sed -i -e '/BRCM_WLAN_IFNAME/s/eth/wlan/' src/wl/sys/wl_linux.c
#	sed -i -e "/EXTRA_LDFLAGS/s|\$(src)/lib|/usr/lib/$pkgname|" Makefile
	sed -i -e "/KBASE/s/\`uname -r\`/${_kpkgver}-${_kpkgrel}${_kflavour}/" Makefile
	sed -n -e '/Copyright/,/SOFTWARE\./{s/^ \* //;p}' src/wl/sys/wl_linux.c
}

build() {
	cd "$builddir"
	make || return 1
}

package() {
	local _drivers="$pkgdir/lib/modules/${_kpkgver}-${_kpkgrel}${_kflavour}/kernel/drivers"
	cd "$builddir"
	install -Dm644 wl.ko "${_drivers}/net/wireless/broadcom/sta/wl.ko"
	install -Dm644 broadcom-wl.conf "$pkgdir/etc/modprobe.d/$pkgname.conf"
	install -Dm644 lib/LICENSE.txt "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}

sha512sums="4403cad0360b01f8e88faccb77e6239865e9cc2b68dac62896153ab37957f1e73e5e4c95d3e81dac334106a2cd4ef0784955a5fefd8abc6e793a68f182bbffe4  001-null-pointer-fix.patch
b483a4fd5fbb5a4697365b6ddcd8034b4d90ddee9bf2aecf003b0fd6838a708d3e84be33b08acdbe165d440480da25fdf0dfff0d2fe12fa2c5271c51d6ac74c0  002-rdtscl.patch
f61ecfb6b8c5a377c7a4da7549c9ec75677782fa2f97e64de0df1259e0ec3b993cfa3eaa4ff50331703ee18ef28f2af0d09839dd3b63ed994e6b29cbfe8ed73f  003-linux47.patch
e5959921b6f0cd5d61d7ed568f549b0920f394458c28257c05064b89d7067ce11c8e44ed0e5a48a65bd041c6193d9ae2d02fca2f5efbfb787d3f9001786a4578  004-linux48.patch
6209a0a5a46a3efcede3cb1e263467173153d779b6267ba4c20f46421a9abd8743a7068527ace350a3da3ef3046b0399e09b37aba917fabe020c8c2600b60fdf  005-debian-fix-kernel-warnings.patch
b7db17e30731a9cbc940b83f7b62f059529cff6c134e47e2176cd7c6fcd8d028334ed4fe1fdce7cf1aef87590f9664b463383ae3302a6e2aabe1baa79fbc5c95  006-linux411.patch
3b73136488daa2d59586bb7ce704fcb73b7a719bf150517beab1f13f7fb9626281e03dd7ffd3557aa894ce806b6ceef678f3f979b11e762890f20e04d19d2e04  007-linux412.patch
2fb5c3eebd48b6099fb87a9fd92545c17b2abf318b040a434c1b0bdd75a7a682b6e7ec9f80245c198f1c306bbaef35a2488123c5ba8764d5a83eb18132c0857b  008-linux415.patch
8ea633992a5ca34b281c04e80962155ea1d2f9e5e403f9d0ba87c3d26296ccaeb1fd7c7e791ac7dd0ca6e31ebbb12982f3311e61418bdda453a861979bf29d4f  broadcom-wl.conf
6855781f7c69a9aecb9461932423688964879d5a4df571f01ae7adaa7bf21a410bef839605d555afb6c8f4eec92fe8510af6cb120930095617ff6cdcccedaf17  hybrid-v35_64-nodebug-pcoem-6_30_223_271.tar.gz"
