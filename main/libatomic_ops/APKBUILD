# Contributor: TBK <alpine@jjtc.eu>
# Contributor: Bart≈Çomiej Piotrowski <bpiotrowski@alpinelinux.org>
# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=libatomic_ops
pkgver=7.10.0
pkgrel=0
pkgdesc="Semi-portable access to hardware provided atomic memory operations"
arch="all"
url="https://github.com/bdwgc/libatomic_ops"
license="GPL-2.0-or-later AND MIT AND Boehm-GC"
makedepends="cmake samurai"
subpackages="$pkgname-static $pkgname-dev $pkgname-doc"
source="https://github.com/bdwgc/libatomic_ops/releases/download/v$pkgver/libatomic_ops-$pkgver.tar.gz"

build() {
	CFLAGS="${CFLAGS//-Os/-O2} -flto=auto" \
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DAO_BUILD_SHARED_LIBS=ON \
		-DBUILD_TESTING="$(want_check && echo ON || echo OFF)"
	cmake --build build

	cmake -B build-static -G Ninja \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DAO_BUILD_SHARED_LIBS=OFF \
		-DBUILD_TESTING=OFF
	cmake --build build-static
}

check() {
	ctest --test-dir build
}

package() {
	DESTDIR="$pkgdir" cmake --install build-static
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
22f6b5253b4756cce1687015849558c3391593b8298bddc8ef1a2c037847f633fe1291c013034b1f720dafd599787d545fba473325561179e9eb1bbcd24eee61  libatomic_ops-7.10.0.tar.gz
"
