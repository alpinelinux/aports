# Contributor: lauren n. liberda <lauren@selfisekai.rocks>
# Maintainer: lauren n. liberda <lauren@selfisekai.rocks>
pkgname=simdutf
pkgver=8.0.0
pkgrel=0
pkgdesc="Unicode validation and transcoding at billions of characters per second"
url="https://simdutf.github.io/simdutf/"
arch="all"
_llvmver=21
makedepends="
	cmake
	samurai
	"
license="Apache-2.0 OR MIT"
subpackages="
	$pkgname-dev
	$pkgname-doc
	fastbase64
	sutf
	"
source="https://github.com/simdutf/simdutf/archive/v$pkgver/simdutf-$pkgver.tar.gz
	"

case "$CARCH" in
	loongarch64)
		# lasx impl fails on gcc with https://gcc.gnu.org/bugzilla/show_bug.cgi?id=65873
		makedepends="$makedepends clang$_llvmver"
		export CC="clang-$_llvmver"
		export CXX="clang++-$_llvmver"
		export CXXFLAGS="$CXXFLAGS -mlasx -mlsx"
		;;
	*) ;;
esac

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		local crossopts="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=ON \
		-DCMAKE_BUILD_TYPE=Release \
		-DSIMDUTF_CXX_STANDARD=20 \
		$crossopts
	cmake --build build
}

check() {
	# check_feature_macros: requires a git checkout
	ctest --test-dir build -E check_feature_macros
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	install -Dm644 LICENSE-MIT -t "$pkgdir"/usr/share/licenses/$pkgname/
}

doc() {
	amove usr/share/licenses
}

fastbase64() {
	amove usr/bin/fastbase64
}

sutf() {
	amove usr/bin/sutf
}

sha512sums="
ee30ac7b7b96dfef2ced3938b1cc8e10cd5ec5b3d35ac9679f30fbb7811bf3f930a31f5b4cf0b4002f27eba84d2e27e7c7bd910d96aa04485588188ad910361d  simdutf-8.0.0.tar.gz
"
