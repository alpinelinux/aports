# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=apk-tools
pkgver=3.0.0_rc8
_commit=2c027261492169783f6aaa2b7731a4e90dc7a5b0
pkgrel=1
pkgdesc="Alpine Package Keeper - package manager for alpine"
arch="all"
url="https://gitlab.alpinelinux.org/alpine/apk-tools"
license="GPL-2.0-only"
subpackages="$pkgname-dbg $pkgname-dev $pkgname-static $pkgname-doc $pkgname-bash-completion $pkgname-zsh-completion libapk"
# Musl 1.2 introduced new ABI for time64 => upgrading apk-tools
# while staying on musl <1.2 causes missing symbols
# starting with musl 1.2.3_git (pre 1.2.3), we added DT_RELR
# it is possible for old systems to upgrade, and apk-tools would upgrade first,
# which would upgrade to a binary that cannot run until musl is upgraded.
# forcing this constraint makes apk upgrade musl as part of the 'critical' transaction,
# and update musl first.
# openssl 3.5(?) introduced new symbols:
# https://gitlab.alpinelinux.org/alpine/aports/-/issues/17199
depends="
	musl>=1.2.3_git20230424
	libcrypto3>=3.5
	libapk=$pkgver-r$pkgrel
	"
_lua="5.3"
makedepends_build="meson openssl-dev>=3.5 lua$_lua lua$_lua-lzlib scdoc"
makedepends_host="
	linux-headers
	openssl-dev
	openssl-libs-static
	zlib-dev
	zlib-static
	zstd-dev
	zstd-static
	"
checkdepends="cmocka-dev"
if [ -z "$BOOTSTRAP" ]; then
	subpackages="$subpackages lua$_lua-apk:luaapk py3-apk:pyapk"
	makedepends_host="$makedepends_host lua$_lua-dev python3-dev"

	# ca-certificates-bundle needed for https certificate validation
	depends="$depends ca-certificates-bundle"
fi
source="https://gitlab.alpinelinux.org/alpine/apk-tools/-/archive/$_commit/apk-tools-v$pkgver.tar.gz
	repo-hash-sha1.patch
	_apk
	ppc64le.patch
	"
builddir="$srcdir/apk-tools-$_commit"

provides="apk-tools3=$pkgver-r$pkgrel"
replaces="apk-tools3"

# secfixes:
#   2.12.6-r0:
#     - CVE-2021-36159
#   2.12.5-r0:
#     - CVE-2021-30139

build() {
	export VERSION=$pkgver-r$pkgrel

	abuild-meson \
		--auto-features=disabled \
		--bindir=/sbin \
		-Darch="$CARCH" \
		-Ddocs=enabled \
		-Dhelp=enabled \
		-Dlua_version=$_lua \
		-Dlua="$([ -z "$BOOTSTRAP" ] && echo enabled || echo disabled)" \
		-Dpython="$([ -z "$BOOTSTRAP" ] && echo enabled || echo disabled)" \
		-Dtests="$(want_check && echo enabled || echo disabled)" \
		output
	ninja -C output

	abuild-meson \
		--auto-features=disabled \
		-Darch="$CARCH" \
		-Dc_link_args="$LDFLAGS -static" \
		-Ddefault_library=static \
		-Dprefer_static=true \
		output-static
	ninja -C output-static src/apk
}

check() {
	meson test --print-errorlogs -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
	install -d "$pkgdir"/lib/apk/db \
		"$pkgdir"/lib/apk/exec \
		"$pkgdir"/etc/apk/keys \
		"$pkgdir"/etc/apk/protected_paths.d

	install -Dm644 "$srcdir"/_apk "$pkgdir"/usr/share/zsh/site-functions/_apk
}

libapk() {
	provides="libapk2=$pkgver-r$pkgrel"
	depends=""
	amove usr/lib/libapk.so.*
}

static() {
	pkgdesc="Alpine Package Keeper - static binary"
	depends=""
	install -Dm755 "$builddir"/output-static/src/apk \
		"$subpkgdir"/sbin/apk.static

	# lets sign the static binary so it can be vefified from distros
	# that does not have apk-tools
	local pubkey="${PACKAGER_PUBKEY:-$PACKAGER_PRIVKEY.pub}"
	local keyname="${pubkey##*/}"
	${CROSS_COMPILE}strip "$subpkgdir"/sbin/apk.static
	openssl dgst -sha1 -sign "$PACKAGER_PRIVKEY" \
		-out "$subpkgdir"/sbin/apk.static.SIGN.RSA."$keyname" \
		"$subpkgdir"/sbin/apk.static
	openssl dgst -sha256 -sign "$PACKAGER_PRIVKEY" \
		-out "$subpkgdir"/sbin/apk.static.SIGN.RSA.sha256."$keyname" \
		"$subpkgdir"/sbin/apk.static
}

luaapk() {
	pkgdesc="Lua module for apk-tools"
	depends=""
	amove usr/lib/lua
}

pyapk() {
	pkgdesc="Python module for apk-tools"
	depends=""
	amove usr/lib/python*
}

sha512sums="
169435c48d88fa1c9e4ccba541720211c954df3070b1a58096d94287b8cd4495b598a037d09ce74101c3b8d9d34d13d78a13247a22528431acaa4813414bae9a  apk-tools-v3.0.0_rc8.tar.gz
458fe877cf8920882fdfced6f9f374f0d986337e2d4e0a20dbda31c3f25741beb7273911f711cc8b28b1706f20d7ae2be671e988c3602867e6f42cc85a5e704d  repo-hash-sha1.patch
993518cafcc5a932c9a418f7aac48012fc48f03c55964ad99d04b034bfa185d550c38dab46f1046adfaa1d65b422b4095b5a54d9a2504dee9278f25e76f9e3ed  _apk
b6214e5b23beba8c9ef9056bc63fe80416a90287ad20558629944247268635322ea9bd851d6583fdd1c0cb3615ee4e5b8b324eeebcc34e16d2d43d6a255f6ce9  ppc64le.patch
"
