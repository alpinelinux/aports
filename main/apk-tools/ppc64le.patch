From 8772f24dd0ffaa02d26c402cbca9c0fe46b56865 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Timo=20Ter=C3=A4s?= <timo.teras@iki.fi>
Date: Thu, 13 Nov 2025 16:15:17 +0200
Subject: [PATCH] test: unit: avoid using constructor function

ppc64le unit tests are failing because of this
---
 test/unit/io_test.c | 12 ++----------
 test/unit/main.c    | 11 +++++++++++
 2 files changed, 13 insertions(+), 10 deletions(-)

diff --git a/test/unit/io_test.c b/test/unit/io_test.c
index ee89f875..78ae7de9 100644
--- a/test/unit/io_test.c
+++ b/test/unit/io_test.c
@@ -1,5 +1,4 @@
 #include <dirent.h>
-#include <dlfcn.h>
 
 #include "apk_test.h"
 #include "apk_io.h"
@@ -8,24 +7,17 @@
 
 #define MOCKFD 9999
 
-static int (*next_openat)(int, const char *, int);
-static int (*next_dup)(int);
-
-static void __attribute((constructor)) resolver(void)
-{
-	next_openat = dlsym(RTLD_NEXT, "openat");
-	next_dup = dlsym(RTLD_NEXT, "dup");
-}
-
 /* assume shared libapk.so, and override the symbols it depends on */
 int openat(int atfd, const char *filename, int flags, ...)
 {
+	extern typeof(openat)* next_openat;
 	if (atfd != MOCKFD) return next_openat(atfd, filename, flags);
 	return MOCKFD;
 }
 
 int dup(int fd)
 {
+	extern typeof(dup)* next_dup;
 	return fd == MOCKFD ? MOCKFD : next_dup(fd);
 }
 
diff --git a/test/unit/main.c b/test/unit/main.c
index 832ab745..ec8cb263 100644
--- a/test/unit/main.c
+++ b/test/unit/main.c
@@ -1,3 +1,4 @@
+#include <dlfcn.h>
 #include <stdio.h>
 #include <signal.h>
 #include <unistd.h>
@@ -6,6 +7,9 @@
 static int num_tests;
 static struct CMUnitTest all_tests[1000];
 
+typeof(openat)* next_openat;
+typeof(dup)* next_dup;
+
 void test_register(const char *name, UnitTestFunction f)
 {
 	all_tests[num_tests++] = (struct CMUnitTest) {
@@ -35,8 +39,15 @@ void assert_output_equal(struct test_out *to, const char *expected_err, const ch
 	assert_string_equal(to->buf_out, expected_out);
 }
 
+static void init_next_funcs(void)
+{
+	next_openat = dlsym(RTLD_NEXT, "openat");
+	next_dup = dlsym(RTLD_NEXT, "dup");
+}
+
 int main(void)
 {
+	init_next_funcs();
 	if (access("test/unit", F_OK) == 0) chdir("test/unit");
 	signal(SIGPIPE, SIG_IGN);
 	return _cmocka_run_group_tests("unit_tests", all_tests, num_tests, NULL, NULL);
-- 
GitLab

