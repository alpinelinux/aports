# Contributor: Leonardo Arena <rnalrd@alpinelinux.org>
# Contributor: Valery Kartel <valery.kartel@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=openssh
pkgver=7.5_p1
pkgrel=6
_pkgver=${pkgver/_/}
pkgdesc="Port of OpenBSD's free SSH release"
url="http://www.openssh.org/portable.html"
arch="all"
license="as-is"
options="suid"
depends=""
makedepends_build="linux-pam-dev"
makedepends_host="libressl-dev zlib-dev linux-headers"
makedepends="$makedepends_build $makedepends_host"
subpackages="$pkgname-doc $pkgname-add:_sub $pkgname-agent:_sub $pkgname-ssh:_sub
	$pkgname-scp:_sub $pkgname-sftp:_sub $pkgname-keygen:_sub $pkgname-keyscan:_sub
	$pkgname-keysign:_sub $pkgname-sftp-server:_sub $pkgname-pkcs11-helper:_sub
	$pkgname-copy-id:_copy:noarch $pkgname-ssh_config:_sub:noarch
	$pkgname-moduli:_sub:noarch $pkgname-clients::noarch $pkgname-utils::noarch
	$pkgname-client::noarch $pkgname-server_config::noarch $pkgname-server
	"
# Add more packages support here e.g. kerberos
[ -z "$BOOTSTRAP" ] && _pkgsupport="pam"
for _flavour in $_pkgsupport; do
	subpackages="$subpackages $pkgname-server-$_flavour:server"
done

source="http://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/$pkgname-$_pkgver.tar.gz
	openssh7.4-peaktput.patch
	openssh7.4-dynwindows.patch
	fix-utmp.patch
	bsd-compatible-realpath.patch
	sshd.initd
	sshd.confd
	sftp-interactive.patch
	openssh-7.5p1-sandbox.patch
	"
builddir="$srcdir"/$pkgname-$_pkgver

# secfixes:
#   7.4_p1:
#     - CVE-2016-10009
#     - CVE-2016-10010
#     - CVE-2016-10011
#     - CVE-2016-10012

# HPN patches are from: http://hpnssh.sourceforge.net/

prepare() {
	cd "$builddir"
	default_prepare
	for _flavour in $_pkgsupport; do
		cp -R "$srcdir"/$pkgname-$_pkgver "$srcdir"/$pkgname-$_pkgver-$_flavour
	done
}

build() {
	cd "$builddir"
	export LD="$CC"
	_configure_vanilla="./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc/ssh \
		--libexecdir=/usr/lib/ssh \
		--mandir=/usr/share/man \
		--with-pid-dir=/run \
		--with-mantype=man \
		--with-ldflags='${LDFLAGS}' \
		--disable-lastlog \
		--disable-strip \
		--disable-wtmp \
		--with-privsep-path=/var/empty \
		--with-xauth=/usr/bin/xauth \
		--with-privsep-user=sshd \
		--with-md5-passwords \
		--with-ssl-engine \
		"
	# now we build "vanilla" openssh
	_configure="$_configure_vanilla"
	for _flavour in $_pkgsupport; do
		_configure="$_configure --without-$_flavour"
	done
	msg "Building openssh..."
	eval "$_configure"
	make

	# now we build other openssh-$_flavour
	_configure="$_configure_vanilla"
	for _flavour in $_pkgsupport; do
		cd "$builddir-$_flavour"
		msg "Building openssh with $_flavour support..."
		eval "$_configure --with-$_flavour"
		make
	done
}

package() {
	depends="$pkgname-clients $pkgname-utils $pkgname-server
		$pkgname-keysign $pkgname-pkcs11-helper $pkgname-sftp-server"
	cd "$builddir"
	make DESTDIR="$pkgdir" install
	install -Dm644 "$builddir"/contrib/ssh-copy-id.1 "$pkgdir"/usr/share/man/man1
}

_sub() {
	local name=${subpkgname#$pkgname-}
	local file=$(find "$pkgdir" -type f -a -name "$name" -o -name "ssh-$name")
	grep -q "/usr/bin/ssh" $file && depends="$depends $pkgname-ssh"
	grep -q "/etc/ssh/moduli" $file && depends="$depends $pkgname-moduli"
	grep -q "/etc/ssh/ssh_config" $file && depends="$depends $pkgname-ssh_config"
	pkgdesc=$(awk -F"S " "/${file##*/}.*\^S/ {print \$2}" "$builddir"/${file##*/}.0)
	file=${file#$pkgdir}
	mkdir -p "$subpkgdir"/${file%/*}
	mv "$pkgdir"/$file "$subpkgdir"/$file
}

_copy() {
	pkgdesc="use locally available keys to authorise logins on a remote machine"
	depends="$pkgname-ssh"
	install -Dm755 "$builddir"/contrib/ssh-copy-id \
		"$subpkgdir"/usr/bin/ssh-copy-id
}

clients() {
	pkgdesc="OpenSSH clients (ssh, scp, sftp)"
	depends="$pkgname-ssh $pkgname-scp $pkgname-sftp"
	mkdir -p "$subpkgdir"
}

utils() {
	pkgdesc="OpenSSH utilities (add, keygen, keyscan, copy-id)"
	depends="$pkgname-add $pkgname-keygen $pkgname-keyscan $pkgname-copy-id"
	mkdir -p "$subpkgdir"
}

client() {
	pkgdesc="OpenSSH compatibility pack ($pkgname-clients + $pkgname-utils)"
	depends="$pkgname-clients $pkgname-utils"
	mkdir -p "$subpkgdir"
}

server_config() {
	pkgdesc="OpenSSH server configuration files"
	depends=""
	mkdir -p "$subpkgdir"/etc/ssh "$subpkgdir"/var/empty
	mv "$pkgdir"/etc/ssh/sshd_config "$subpkgdir"/etc/ssh
	install -Dm755 "$srcdir"/sshd.initd "$subpkgdir"/etc/init.d/sshd
	install -Dm644 "$srcdir"/sshd.confd "$subpkgdir"/etc/conf.d/sshd
}

server() {
	local _flavour=${subpkgname#$pkgname-server}
	pkgdesc="OpenSSH server"
	depends="$pkgname-keygen $pkgname-moduli $pkgname-server_config"
	mkdir -p "$subpkgdir"/usr/sbin
	if [ "$_flavour"  ]; then
		cp "$builddir$_flavour"/sshd "$subpkgdir"/usr/sbin/
		pkgdesc="$pkgdesc with ${_flavour/-/} support"
		replaces="$pkgname-server"
	else
		mv "$pkgdir"/usr/sbin/sshd "$subpkgdir"/usr/sbin/
		rm -fr "$pkgdir"/*
	fi
}

sha512sums="58c542e8a110fb4316a68db94abb663fa1c810becd0638d45281df8aeca62c1f705090437a80e788e6c29121769b72a505feced537d3118c933fde01b5285c81  openssh-7.5p1.tar.gz
398096a89aa104abeff31aa043ac406a6348e0fdd4d313b7888ee0b931d38fd71fc21bceee46145e88f03bc27e00890e068442faee2d33f86cfbc04d58ffa4b6  openssh7.4-peaktput.patch
b9d736eae9b43de91fa3eb277ba8abc6290a8436b0fb00ae3b0f1b2eabba9983e4d2a1e3c68f5514247d0a3f120037f0795fd88fbf302aabd2d1b54a325a04ee  openssh7.4-dynwindows.patch
f35fffcd26635249ce5d820e7b3e406e586f2d2d7f6a045f221e2f9fb53aebc1ab1dd1e603b3389462296ed77921a1d08456e7aaa3825cbed08f405b381a58e1  fix-utmp.patch
f2b8daa537ea3f32754a4485492cc6eb3f40133ed46c0a5a29a89e4bcf8583d82d891d94bf2e5eb1c916fa68ec094abf4e6cd641e9737a6c05053808012b3a73  bsd-compatible-realpath.patch
0fa7cb281381b14b1c50a5f35cd9a8f596040fbbf06250657cfc9a28d98b5bfca9be3122f788ada8db1bfc09a663fa2f09064a57b204951fe8e7fe38b00bb186  sshd.initd
ce0abddbd2004891f88efd8522c4b37a4989290269fab339c0fa9aacc051f7fd3b20813e192e92e0e64315750041cb74012d4321260f4865ff69d7a935b259d4  sshd.confd
c1d09c65dbc347f0904edc30f91aa9a24b0baee50309536182455b544f1e3f85a8cecfa959e32be8b101d8282ef06dde3febbbc3f315489339dcf04155c859a9  sftp-interactive.patch
15c5478bcae56c019a2fbd82ec04808537fd4ba1f1ba4a0a88c0343c16c698c45dbfac59eebc3fcfd3c15b302ebec43e60ffa02442a6c77673b14818ad3f7b60  openssh-7.5p1-sandbox.patch"
