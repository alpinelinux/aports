# Conptributor: Valery Kartel <valery.kartel@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=openssh
pkgver=7.4_p1
pkgrel=2
_pkgver=${pkgver/_/}
pkgdesc="Port of OpenBSD's free SSH release"
url="http://www.openssh.org/portable.html"
arch="all"
license="as-is"
options="suid"
depends="$pkgname-clients $pkgname-utils $pkgname-server
	$pkgname-keysign $pkgname-pkcs11-helper $pkgname-sftp-server
	"
makedepends="libressl-dev linux-headers zlib-dev"
subpackages="$pkgname-doc $pkgname-add:_sub $pkgname-agent:_sub $pkgname-ssh
	$pkgname-scp:_sub $pkgname-sftp:_sub $pkgname-keygen:_sub $pkgname-keyscan:_sub
	$pkgname-keysign $pkgname-sftp-server:_sub $pkgname-pkcs11-helper:_pkcs
	$pkgname-copy-id:_copy:noarch $pkgname-moduli:_sub:noarch $pkgname-server
	$pkgname-clients::noarch $pkgname-utils::noarch $pkgname-client::noarch
	"
source="http://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/$pkgname-$_pkgver.tar.gz
	sshd.initd
	sshd.confd
	fix-utmp.patch
	sftp-interactive.patch
	bsd-compatible-realpath.patch
	openssh7.4-peaktput.patch
	openssh7.4-dynwindows.patch
	"
builddir="$srcdir/$pkgname-$_pkgver"

# secfixes:
#   7.4_p1:
#     - CVE-2016-10009
#     - CVE-2016-10010
#     - CVE-2016-10011
#     - CVE-2016-10012
#       https://bugs.alpinelinux.org/issues/6583

# HPN patches are from: http://www.psc.edu/index.php/hpn-ssh

build() {
	cd "$builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc/ssh \
		--libexecdir=/usr/lib/ssh \
		--mandir=/usr/share/man \
		--with-pid-dir=/run \
		--with-mantype=man \
		--with-ldflags="${LDFLAGS}" \
		--disable-lastlog \
		--disable-strip \
		--disable-wtmp \
		--with-privsep-path=/var/empty \
		--with-xauth=/usr/bin/xauth \
		--with-privsep-user=sshd \
		--with-md5-passwords \
		--with-ssl-engine \
		--without-pam \
		|| return 1
	make || return 1
}

package() {
	make -C "$builddir" DESTDIR="$pkgdir" install || return 1
	install -Dm644 "$builddir"/contrib/ssh-copy-id.1 \
		"$pkgdir"/usr/share/man/man1
}

_sub() {
	depends=
	local name=${subpkgname#$pkgname-}
	local file=$(find "$pkgdir" -type f -a -name "$name" -o -name "ssh-$name")
	grep -q "/usr/bin/ssh" $file && depends="$depends $pkgname-ssh"
	grep -q "/etc/ssh/moduli" $file && depends="$depends $pkgname-moduli"
	pkgdesc=$(awk -F"S " "/${file##*/}.*\^S/ {print \$2}" "$builddir"/${file##*/}.0)
	[ -z "${pkgdesc##OpenSSH*}" ] || pkgdesc="OpenSSH $pkgdesc"
	file=${file#$pkgdir}
	mkdir -p "$subpkgdir"/${file%/*} || return 1
	mv "$pkgdir"/$file "$subpkgdir"/$file || return 1
}

ssh() {
	_sub || return 1
	mkdir -p "$subpkgdir"/etc/ssh || return 1
	mv "$pkgdir"/etc/ssh/ssh_config "$subpkgdir"/etc/ssh
}

keysign() {
	_sub || return 1
	depends="$pkgname-ssh $depends"
}

_copy() {
	pkgdesc="OpenSSH use locally available keys to authorise logins on a remote machine"
	depends="$pkgname-ssh"
	install -Dm755 "$builddir"/contrib/ssh-copy-id \
		"$subpkgdir"/usr/bin/ssh-copy-id
}

_pkcs() {
	_sub || return 1
	depends="$pkgname-agent $depends"
}

clients() {
	pkgdesc="OpenSSH clients (ssh, scp, sftp)"
	depends="$pkgname-ssh $pkgname-scp $pkgname-sftp"
	mkdir -p "$subpkgdir"
}

utils() {
	pkgdesc="OpenSSH utilities (add, agent, keygen, keyscan, copy-id)"
	depends="$pkgname-add $pkgname-agent $pkgname-keygen $pkgname-keyscan $pkgname-copy-id"
	mkdir -p "$subpkgdir"
}

client() {
	pkgdesc="OpenSSH compatibility pack ($pkgname-clients + $pkgname-utils)"
	depends="$pkgname-clients $pkgname-utils"
	mkdir -p "$subpkgdir"
}

server() {
	local name=sshd
	pkgdesc="OpenSSH SSH server"
	depends="$pkgname-keygen $pkgname-moduli"
	provides="$pkgname-$name"

	mkdir -p "$subpkgdir"
	mv "$pkgdir"/* "$subpkgdir"/ || return 1

	install -Dm755 "$srcdir"/$name.initd "$subpkgdir"/etc/init.d/$name || return 1
	install -Dm644 "$srcdir"/$name.confd "$subpkgdir"/etc/conf.d/$name || return 1

	rmdir "$subpkgdir"/usr/bin "$subpkgdir"/usr/lib/ssh "$subpkgdir"/usr/lib || return 1
}

sha512sums="4f3256f461f01366c5d5e0e45285eec65016e2643b3284b407f48f53d81087bf2c1caf7d5f7530d307a15c91c64de91446e1cba948e8fc68f82098290fe3b292  openssh-7.4p1.tar.gz
60fc8bcd675bec9a80dadfd9717a04e5e19870b32b16fbe2935480245ca7c982964506b3ed8db00c66c2a108421b8724bfdab1147679565ddcfb80323c7e8588  sshd.initd
67c03760ff3f483eb929e9e34919d4a0a02acfbef541bad4b66cb6dfa25c7adf25cfd9ff30a3d15f0aff9e7c336e588835518713bb49f5c5cace8fddc65df97c  sshd.confd
f35fffcd26635249ce5d820e7b3e406e586f2d2d7f6a045f221e2f9fb53aebc1ab1dd1e603b3389462296ed77921a1d08456e7aaa3825cbed08f405b381a58e1  fix-utmp.patch
c1d09c65dbc347f0904edc30f91aa9a24b0baee50309536182455b544f1e3f85a8cecfa959e32be8b101d8282ef06dde3febbbc3f315489339dcf04155c859a9  sftp-interactive.patch
f2b8daa537ea3f32754a4485492cc6eb3f40133ed46c0a5a29a89e4bcf8583d82d891d94bf2e5eb1c916fa68ec094abf4e6cd641e9737a6c05053808012b3a73  bsd-compatible-realpath.patch
398096a89aa104abeff31aa043ac406a6348e0fdd4d313b7888ee0b931d38fd71fc21bceee46145e88f03bc27e00890e068442faee2d33f86cfbc04d58ffa4b6  openssh7.4-peaktput.patch
553667e2c9835eac4a864342076d98c130725fec069d925278ecef3abda45ab7c21e03a5caed5d100a462cd65669afa8e670a3081b8f2cb15d5e93027a8bca0d  openssh7.4-dynwindows.patch"
