# Conptributor: Valery Kartel <valery.kartel@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=openssh
pkgver=7.4_p1
pkgrel=2
_pkgver=${pkgver/_/}
pkgdesc="Port of OpenBSD's free SSH release"
url="http://www.openssh.org/portable.html"
arch="all"
license="as-is"
options="suid"
depends="$pkgname-clients $pkgname-utils $pkgname-server
	$pkgname-keysign $pkgname-pkcs11-helper $pkgname-sftp-server
	"
makedepends="libressl-dev linux-headers zlib-dev"
subpackages="$pkgname-doc $pkgname-add:_sub $pkgname-agent:_sub $pkgname-ssh:_sub
	$pkgname-scp:_sub $pkgname-sftp:_sub $pkgname-keygen:_sub $pkgname-keyscan:_sub
	$pkgname-keysign:_sub $pkgname-sftp-server:_sub $pkgname-pkcs11-helper:_sub
	$pkgname-copy-id:_copy:noarch $pkgname-ssh_config:_sub:noarch
	$pkgname-moduli:_sub:noarch $pkgname-clients::noarch $pkgname-utils::noarch
	$pkgname-client::noarch $pkgname-server
	"
source="http://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/$pkgname-$_pkgver.tar.gz
	sshd.initd
	sshd.confd
	fix-utmp.patch
	sftp-interactive.patch
	bsd-compatible-realpath.patch
	"
builddir="$srcdir/$pkgname-$_pkgver"

# secfixes:
#   7.4_p1:
#     - CVE-2016-10009
#     - CVE-2016-10010
#     - CVE-2016-10011
#     - CVE-2016-10012
#       https://bugs.alpinelinux.org/issues/6583

# HPN patches are from: http://www.psc.edu/index.php/hpn-ssh

build() {
	cd "$builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc/ssh \
		--libexecdir=/usr/lib/ssh \
		--mandir=/usr/share/man \
		--with-pid-dir=/run \
		--with-mantype=man \
		--with-ldflags="${LDFLAGS}" \
		--disable-lastlog \
		--disable-strip \
		--disable-wtmp \
		--with-xauth=/usr/bin/xauth \
		--with-privsep-user=sshd \
		--with-md5-passwords \
		--with-ssl-engine \
		--without-pam \
		|| return 1
	make || return 1
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir" install || return 1

	install -Dm644 "$builddir"/contrib/ssh-copy-id.1 \
		"$pkgdir"/usr/share/man/man1 || return 1

	sed -i 's/#UseDNS yes/UseDNS no/' "$pkgdir"/etc/ssh/sshd_config
}

_sub() {
	depends=
	local name=${subpkgname#$pkgname-}
	local file=$(find "$pkgdir" -type f -a -name "$name" -o -name "ssh-$name")
	grep -q "/etc/ssh/moduli" $file && depends="$depends $pkgname-moduli"
	grep -q "/etc/ssh/ssh_config" $file && depends="$depends $pkgname-ssh_config"
	pkgdesc=$(awk -F"S " "/${file##*/}.*\^S/ {print \$2}" "$builddir"/${file##*/}.0)
	file=${file#$pkgdir}
	install -d "$subpkgdir"/${file%/*} || return 1
	mv "$pkgdir"/$file "$subpkgdir"/$file || return 1
}

_copy() {
	pkgdesc="use locally available keys to authorise logins on a remote machine"
	depends="$pkgname-ssh"
	install -Dm755 "$builddir"/contrib/ssh-copy-id \
		"$subpkgdir"/usr/bin/ssh-copy-id
}

clients() {
	pkgdesc="OpenSSH clients (ssh, scp, sftp)"
	depends="$pkgname-ssh $pkgname-scp $pkgname-sftp"
	install -d "$subpkgdir"
}

utils() {
	pkgdesc="OpenSSH utilities (add, keygen, keyscan, copy-id)"
	depends="$pkgname-add $pkgname-keygen $pkgname-keyscan $pkgname-copy-id"
	install -d "$subpkgdir"
}

client() {
	pkgdesc="JUST FOR COMPATIBILITY ($pkgname-clients + $pkgname-utils)"
	depends="$pkgname-clients $pkgname-utils"
	install -d "$subpkgdir"
}

server() {
	local name=sshd
	pkgdesc="OpenSSH SSH server"
	depends="$pkgname-keygen $pkgname-moduli"

	install -d "$subpkgdir"
	mv "$pkgdir"/* "$subpkgdir"/ || return 1

	install -Dm755 "$srcdir"/$name.initd "$subpkgdir"/etc/init.d/$name || return 1
	install -Dm644 "$srcdir"/$name.confd "$subpkgdir"/etc/conf.d/$name || return 1

	rmdir "$subpkgdir"/usr/bin "$subpkgdir"/usr/lib/ssh "$subpkgdir"/usr/lib || return 1
}

sha512sums="4f3256f461f01366c5d5e0e45285eec65016e2643b3284b407f48f53d81087bf2c1caf7d5f7530d307a15c91c64de91446e1cba948e8fc68f82098290fe3b292  openssh-7.4p1.tar.gz
0fa7cb281381b14b1c50a5f35cd9a8f596040fbbf06250657cfc9a28d98b5bfca9be3122f788ada8db1bfc09a663fa2f09064a57b204951fe8e7fe38b00bb186  sshd.initd
ce0abddbd2004891f88efd8522c4b37a4989290269fab339c0fa9aacc051f7fd3b20813e192e92e0e64315750041cb74012d4321260f4865ff69d7a935b259d4  sshd.confd
f35fffcd26635249ce5d820e7b3e406e586f2d2d7f6a045f221e2f9fb53aebc1ab1dd1e603b3389462296ed77921a1d08456e7aaa3825cbed08f405b381a58e1  fix-utmp.patch
c1d09c65dbc347f0904edc30f91aa9a24b0baee50309536182455b544f1e3f85a8cecfa959e32be8b101d8282ef06dde3febbbc3f315489339dcf04155c859a9  sftp-interactive.patch
f2b8daa537ea3f32754a4485492cc6eb3f40133ed46c0a5a29a89e4bcf8583d82d891d94bf2e5eb1c916fa68ec094abf4e6cd641e9737a6c05053808012b3a73  bsd-compatible-realpath.patch"
