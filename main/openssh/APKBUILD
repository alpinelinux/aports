# Contributor: Leonardo Arena <rnalrd@alpinelinux.org>
# Contributor: Valery Kartel <valery.kartel@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=openssh
pkgver=7.6_p1
_myver=${pkgver%_*}${pkgver#*_}
pkgrel=1
pkgdesc="Port of OpenBSD's free SSH release"
url="http://www.openssh.org/portable.html"
arch="all"
license="BSD"
options="suid"
depends=""
makedepends_build="linux-pam-dev"
makedepends_host="libressl-dev zlib-dev linux-headers"
makedepends="$makedepends_build $makedepends_host"
subpackages="$pkgname-doc $pkgname-add:_sub $pkgname-agent:_sub $pkgname-ssh:_sub
	$pkgname-scp:_sub $pkgname-sftp:_sub $pkgname-keygen:_sub $pkgname-keyscan:_sub
	$pkgname-keysign:_sub $pkgname-sftp-server:_sub $pkgname-pkcs11-helper:_sub
	$pkgname-copy-id:_copy:noarch $pkgname-ssh_config:_sub:noarch
	$pkgname-moduli:_sub:noarch $pkgname-clients::noarch $pkgname-utils::noarch
	$pkgname-client::noarch $pkgname-server_config::noarch $pkgname-server
	"
# Add more packages support here e.g. kerberos
_pkgsupport=""
[ -z "$BOOTSTRAP" ] && _pkgsupport="pam"
for _flavour in $_pkgsupport; do
	subpackages="$subpackages $pkgname-server-$_flavour:server"
done

source="http://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/$pkgname-$_myver.tar.gz
	openssh7.4-peaktput.patch
	fix-utmp.patch
	bsd-compatible-realpath.patch
	sshd.initd
	sshd.confd
	sftp-interactive.patch
	"

# secfixes:
#   7.5_p1-r8:
#     - CVE-2017-15906
#   7.4_p1-r0:
#     - CVE-2016-10009
#     - CVE-2016-10010
#     - CVE-2016-10011
#     - CVE-2016-10012

builddir="$srcdir"/$pkgname-$_myver

prepare() {
	cd "$builddir"
	default_prepare
	for _flavour in $_pkgsupport; do
		cp -R "$srcdir"/$pkgname-$_myver "$srcdir"/$pkgname-$_myver-$_flavour
	done
}

build() {
	cd "$builddir"
	export LD="$CC"
	_configure_vanilla="./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc/ssh \
		--libexecdir=/usr/lib/ssh \
		--mandir=/usr/share/man \
		--with-pid-dir=/run \
		--with-mantype=doc \
		--with-ldflags='${LDFLAGS}' \
		--disable-lastlog \
		--disable-strip \
		--disable-wtmp \
		--with-privsep-path=/var/empty \
		--with-xauth=/usr/bin/xauth \
		--with-privsep-user=sshd \
		--with-md5-passwords \
		--with-ssl-engine \
		"
	# now we build "vanilla" openssh
	_configure="$_configure_vanilla"
	for _flavour in $_pkgsupport; do
		_configure="$_configure --without-$_flavour"
	done
	msg "Building openssh..."
	eval "$_configure"
	make

	# now we build other openssh-$_flavour
	_configure="$_configure_vanilla"
	for _flavour in $_pkgsupport; do
		cd "$builddir-$_flavour"
		msg "Building openssh with $_flavour support..."
		eval "$_configure --with-$_flavour"
		make
	done
}

package() {
	depends="$pkgname-clients $pkgname-utils $pkgname-server
		$pkgname-keysign $pkgname-pkcs11-helper $pkgname-sftp-server"
	cd "$builddir"
	make DESTDIR="$pkgdir" install
	install -Dm644 "$builddir"/contrib/ssh-copy-id.1 "$pkgdir"/usr/share/man/man1
}

_sub() {
	local name=${subpkgname#$pkgname-}
	local file=$(find "$pkgdir" -type f -a -name "$name" -o -name "ssh-$name")
	grep -q "/usr/bin/ssh" $file && depends="$depends $pkgname-ssh"
	grep -q "/etc/ssh/moduli" $file && depends="$depends $pkgname-moduli"
	grep -q "/etc/ssh/ssh_config" $file && depends="$depends $pkgname-ssh_config"
	pkgdesc=$(awk -F"S " "/${file##*/}.*\^S/ {print \$2}" "$builddir"/${file##*/}.0)
	file=${file#$pkgdir}
	mkdir -p "$subpkgdir"/${file%/*}
	mv "$pkgdir"/$file "$subpkgdir"/$file
}

_copy() {
	pkgdesc="use locally available keys to authorise logins on a remote machine"
	depends="$pkgname-ssh"
	install -Dm755 "$builddir"/contrib/ssh-copy-id \
		"$subpkgdir"/usr/bin/ssh-copy-id
}

clients() {
	pkgdesc="OpenSSH clients (ssh, scp, sftp)"
	depends="$pkgname-ssh $pkgname-scp $pkgname-sftp"
	mkdir -p "$subpkgdir"
}

utils() {
	pkgdesc="OpenSSH utilities (add, keygen, keyscan, copy-id)"
	depends="$pkgname-add $pkgname-keygen $pkgname-keyscan $pkgname-copy-id"
	mkdir -p "$subpkgdir"
}

client() {
	pkgdesc="OpenSSH compatibility pack ($pkgname-clients + $pkgname-utils)"
	depends="$pkgname-clients $pkgname-utils"
	mkdir -p "$subpkgdir"
}

server_config() {
	pkgdesc="OpenSSH server configuration files"
	depends=""
	mkdir -p "$subpkgdir"/etc/ssh "$subpkgdir"/var/empty
	mv "$pkgdir"/etc/ssh/sshd_config "$subpkgdir"/etc/ssh
	install -Dm755 "$srcdir"/sshd.initd "$subpkgdir"/etc/init.d/sshd
	install -Dm644 "$srcdir"/sshd.confd "$subpkgdir"/etc/conf.d/sshd
}

server() {
	local _flavour=${subpkgname#$pkgname-server}
	pkgdesc="OpenSSH server"
	depends="$pkgname-keygen $pkgname-moduli $pkgname-server_config"
	mkdir -p "$subpkgdir"/usr/sbin
	if [ "$_flavour"  ]; then
		cp "$builddir$_flavour"/sshd "$subpkgdir"/usr/sbin/
		pkgdesc="$pkgdesc with ${_flavour/-/} support"
		replaces="$pkgname-server"
	else
		mv "$pkgdir"/usr/sbin/sshd "$subpkgdir"/usr/sbin/
		rm -fr "$pkgdir"/*
	fi
}

sha512sums="de17fdcb8239401f76740c8d689a8761802f6df94e68d953f3c70b9f4f8bdb403617c48c1d01cc8c368d88e9d50aee540bf03d5a36687dfb39dfd28d73029d72  openssh-7.6p1.tar.gz
398096a89aa104abeff31aa043ac406a6348e0fdd4d313b7888ee0b931d38fd71fc21bceee46145e88f03bc27e00890e068442faee2d33f86cfbc04d58ffa4b6  openssh7.4-peaktput.patch
f35fffcd26635249ce5d820e7b3e406e586f2d2d7f6a045f221e2f9fb53aebc1ab1dd1e603b3389462296ed77921a1d08456e7aaa3825cbed08f405b381a58e1  fix-utmp.patch
f2b8daa537ea3f32754a4485492cc6eb3f40133ed46c0a5a29a89e4bcf8583d82d891d94bf2e5eb1c916fa68ec094abf4e6cd641e9737a6c05053808012b3a73  bsd-compatible-realpath.patch
60fc8bcd675bec9a80dadfd9717a04e5e19870b32b16fbe2935480245ca7c982964506b3ed8db00c66c2a108421b8724bfdab1147679565ddcfb80323c7e8588  sshd.initd
67c03760ff3f483eb929e9e34919d4a0a02acfbef541bad4b66cb6dfa25c7adf25cfd9ff30a3d15f0aff9e7c336e588835518713bb49f5c5cace8fddc65df97c  sshd.confd
c1d09c65dbc347f0904edc30f91aa9a24b0baee50309536182455b544f1e3f85a8cecfa959e32be8b101d8282ef06dde3febbbc3f315489339dcf04155c859a9  sftp-interactive.patch"
