# Contributor: Milan P. StaniÄ‡ <mps@arvanta.net>
# Contributor: Maxim Karasev <begs@disroot.org>
# Maintainer: Antoine Martin (ayakael) <dev@ayakael.net>
pkgname=arm-trusted-firmware
pkgver=2.14.0
pkgrel=0
pkgdesc="ARM Trusted Firmware-A (TF-A)"
url="https://github.com/ARM-software/arm-trusted-firmware"
# no lld on s390x, but it doesn't matter anyway as this is arm firmware
arch="all !s390x"
license="BSD-3-Clause"
makedepends="
	clang
	dtc
	lld
	llvm
	openssl-dev
	"
subpackages="$pkgname-tools"
source="$pkgname-$pkgver.tar.gz::https://github.com/ARM-software/arm-trusted-firmware/archive/refs/tags/v$pkgver.tar.gz
	0001-rk-3399-fix-build-with-alpine.patch
	0002-fiptool-fix-build-on-musl.patch
	0003-define-key-t-as-1.patch
	"
options="!check" # No tests

_plats="
	imx8mq
	rk3328
	rk3399
	rk3568
	rk3588
	sun50i_a64
	sun50i_h6
	sun50i_h616
	"

prepare() {
	default_prepare

	# configure tools
	make -C tools/fiptool BUILD_PLAT=fvp PLAT=fvp
	make -C tools/cert_create BUILD_PLAT=fvp PLAT=fvp
}

build() {
	unset LDFLAGS
	if [ "$CARCH" = "aarch64" ]; then
		for plat in $_plats; do
			case "$plat" in
				sun50i_a64|sun50i_h6)
					local opts="SUNXI_SETUP_REGULATORS=1 SUNXI_AMEND_DTB=1"
					;;
			esac

			msg "Building ATF for $plat (opts='$opts')"
			make E=0 PLAT=$plat bl31 $opts
		done
	fi

	# build tools
	make -C tools/fiptool BUILD_PLAT=fvp PLAT=fvp all
	make -C tools/cert_create BUILD_PLAT=fvp PLAT=fvp all
}

package() {
	install -d "$pkgdir"/usr/share/$pkgname
	if [ "$CARCH" = "aarch64" ]; then
		for plat in $_plats; do
			case $plat in
			rk3*)
				local path="$builddir"/build/$plat/release/bl31/bl31.elf
				;;
			*)
				local path="$builddir"/build/$plat/release/bl31.bin
				;;
			esac
			install -D $path -t "$pkgdir"/usr/share/$pkgname/$plat/
		done
	fi
	install -Dm755 -t "$pkgdir"/usr/bin tools/fiptool/fvp/tools/fiptool/fiptool
	install -Dm755 -t "$pkgdir"/usr/bin tools/cert_create/fvp/tools/cert_create/cert_create
}

tools() {
	pkgdesc="$pkgdesc (tools)"

	amove usr/bin/fiptool
	amove usr/bin/cert_create
}

sha512sums="
5410cd5422d2568f5e2a6fab64588951b274a9696f8f5aeb1a5b4ae37c5b53e09f787008697e7a9a929c54f6673ffb9412b87cb409300ff1b1e691d460eeae08  arm-trusted-firmware-2.14.0.tar.gz
d8e2c0d96faa52c63cdcb3cd890c8480aefd16502232331a79dbcd3847aaedcd4f07f0d6b335505aca360c1055c5caf28f3dc4cad0b3083c0ce8a022235be5a2  0001-rk-3399-fix-build-with-alpine.patch
8860d728baef70abdee808af7fd0a7530d736302edadb5438098bce84e2e6f6b8edf572f4f306afb5edf588492e6243334e7394b9ad64257416ef37037e55558  0002-fiptool-fix-build-on-musl.patch
7758beb7e81c0b8c1ef1f2dcc0c053ebf6fb172beef50a76de0aa7ff9c1e061ceae9bf276ec1c7b265e53a3a274d67d6708713d85cdd585be9649f6b180f08ed  0003-define-key-t-as-1.patch
"
