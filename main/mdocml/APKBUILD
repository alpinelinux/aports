# Maintainer:  Natanael Copa <ncopa@alpinelinux.org>
pkgname=mdocml
_pkgname=mandoc
pkgver=1.14.5
pkgrel=0
pkgdesc="mdoc/man compiler"
url="http://mdocml.bsd.lv/"
arch="all"
license="ISC and BSD-2-Clause and BSD-3-Clause"
makedepends="zlib-dev"
checkdepends="perl"
install="$pkgname.post-deinstall"
triggers="$pkgname-apropos.trigger=/usr/share/man/*"
subpackages="$pkgname-doc $pkgname-dev man::noarch $pkgname-apropos $pkgname-soelim"
source="http://mdocml.bsd.lv/snapshots/$_pkgname-$pkgver.tar.gz
	shared-libmandoc.patch
	outdated-warn-disable.patch
	"

builddir="$srcdir/$_pkgname-$pkgver"
prepare() {
	default_prepare

	cd "$builddir"
	cat >configure.local<<-__EOF__
	PREFIX=/usr
	MANDIR=/usr/share/man
	LIBDIR=/usr/lib
	CFLAGS="$CFLAGS"
	UTF8_LOCALE="en_US.UTF-8"
	MANPATH_DEFAULT="/usr/share/man:/usr/local/man"
	LN="ln -sf"
__EOF__
}

build() {
	cd "$builddir"
	MANPATH_BASE="/usr/share/man" ./configure
	make
}

check() {
	cd "$builddir"
	LD_LIBRARY_PATH="$builddir" make regress
}

package() {
	cd "$builddir"
	make -j1 DESTDIR="$pkgdir" base-install lib-install
}

man() {
	pkgdesc="dummy package for upgrade compatibility.  this can safely be removed"
	depends="mdocml"
	mkdir -p "$subpkgdir"
}

apropos() {
	pkgdesc="makewhatis/whatis and apropos tools and index"
	mkdir -p "$subpkgdir"/usr/sbin "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/apropos \
		"$pkgdir"/usr/bin/whatis \
		"$subpkgdir"/usr/bin/
	mv "$pkgdir"/usr/sbin/makewhatis \
		"$subpkgdir"/usr/sbin/
}

soelim() {
	pkgdesc="so elimination tool"
	depends=""
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/soelim \
		"$subpkgdir"/usr/bin/
}

sha512sums="848f290847f3095757f25647e6d73eb7044018b145bf6f9dc8b5db164b1421911efdc5b3b9022ec3a2c5af9687a84d5acedee810f2bd2f7caaa9242dadb2cc52  mandoc-1.14.5.tar.gz
b1bd2c197584948cc8bab2310e759b8942b9f9479254ffb5a8223cfa6ba03c9e1a4d402c5440b8d9f962be9a020287d3dd8556592c17f2b46f15f405d9d373cb  shared-libmandoc.patch
ced05e8b57fb9705c6d8d8570cd6b06ad187511a4c243ac2dbc34064aa164ca49e0c877160134161dcb98ebd5e61a5c23d5741f03ef95903ff56193dd07f36a1  outdated-warn-disable.patch"
