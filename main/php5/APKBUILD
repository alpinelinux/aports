# Contributor: Valery Kartel <valery.kartel@gmail.com>
# Contributor: Andy Blyler <andy@blyler.cc>
# Contributor: ≈Åukasz Jendrysik <scadu@yandex.com>
# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer: Matt Smith <mcs@darkregion.net>
provides=php
pkgname=php5
pkgver=5.6.29
pkgrel=2
_apiver="20131106"
pkgdesc="The PHP language runtime engine - 5th branch"
url="http://www.php.net/"
arch="all"
license="PHP-3"
options=""
install="$pkgname-common.pre-upgrade $pkgname-common.pre-deinstall"
triggers="$pkgname-common.trigger=/usr/bin"
depends="$pkgname-common"
depends_dev="$pkgname-pear"
_depends_dom="$pkgname-xml"
_depends_imap="--"
_depends_mysql="$pkgname-mysqlnd --"
_depends_mysqlnd="$pkgname-mysqli"
_depends_pdo_dblib="$pkgname-pdo"
_depends_pdo_mysql="$pkgname-pdo"
_depends_pdo_odbc="$pkgname-pdo"
_depends_pdo_pgsql="$pkgname-pdo"
_depends_pdo_sqlite="$pkgname-pdo"
_depends_soap="$pkgname-xml"
_depends_wddx="$pkgname-xml"
_depends_xmlrpc="$pkgname-xml"
_depends_xmlreader="$pkgname-dom $pkgname-xml"
_depends_xmlwriter="$pkgname-dom $pkgname-xml"
_depends_xsl="$pkgname-dom $pkgname-xml"
_prefix_opcache="zend_"
_pkgdesc_opcache="Zend OPcache"
makedepends="autoconf bison re2c apache2-dev libxml2-dev libxslt-dev bzip2-dev zlib-dev
	aspell-dev enchant-dev expat-dev pcre-dev curl-dev gmp-dev icu-dev imap-dev
	libical-dev libressl-dev openldap-dev net-snmp-dev db-dev krb5-dev gdbm-dev sqlite-dev
	freetds-dev mariadb-dev postgresql-dev unixodbc-dev freetype-dev libxpm-dev
	libpng-dev libjpeg-turbo-dev libmcrypt-dev recode-dev
	libedit-dev gettext-dev
	"
source="http://php.net/distributions/php-$pkgver.tar.bz2
	$pkgname-fpm.initd
	$pkgname-fpm.logrotate
	$pkgname-module.conf
	fix-asm-constraints-in-aarch64-multiply-macro.patch
	install-pear.patch
	includedir.patch
	php-fpm.patch
	"
# unimplemented extensions: com_dotnet interbase oci8 pdo_firebird pdo_oci
_extensions="bcmath bz2 calendar ctype curl dba dom enchant exif ftp gd gettext gmp iconv imap intl json
	ldap mbstring mcrypt mssql mysql mysqli mysqlnd odbc opcache openssl pcntl pdo pdo_dblib
	pdo_mysql pdo_odbc pdo_pgsql pdo_sqlite pgsql phar posix pspell recode session shmop snmp
	soap sockets sqlite3 sysvmsg sysvsem sysvshm wddx xml xmlreader xmlrpc xmlwriter xsl zip zlib
	"
for _extension in $_extensions; do
	subpackages="$subpackages $pkgname-$_extension:_extension"
done
subpackages="$pkgname-dev $pkgname-doc $subpackages $pkgname-apache2 $pkgname-phpdbg $pkgname-embed
	$pkgname-litespeed $pkgname-cgi $pkgname-fpm $pkgname-pear::noarch $pkgname-common::noarch"
builddir="$srcdir"/php-$pkgver

prepare() {
	cd "$builddir"
	default_prepare || return 1
	update_config_sub || return 1
	local vapi=$(sed -n '/#define PHP_API_VERSION/{s/.* //;p}' main/php.h)
	if [ "$vapi" != "$_apiver" ]; then
		error "Upstreram API version is now $vapi. Expecting $_apiver"
		return 1
	fi
	autoconf
}

_build() {
	export EXTENSION_DIR=/usr/lib/$pkgname/modules
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--libdir=/usr/lib/$pkgname \
		--datadir=/usr/share/$pkgname \
		--sysconfdir=/etc/$pkgname \
		--localstatedir=/var \
		--with-layout=GNU \
		--with-pic \
		--with-pear=/usr/share/php \
		--with-config-file-path=/etc/$pkgname \
		--with-config-file-scan-dir=/etc/$pkgname/conf.d \
		--disable-rpath \
		--disable-short-tags \
		--with-openssl=shared --with-kerberos --with-system-ciphers \
		--with-pcre-regex --with-pcre-dir \
		--with-zlib=shared --with-zlib-dir \
		--enable-bcmath=shared \
		--with-bz2=shared \
		--enable-calendar=shared \
		--enable-ctype=shared \
		--with-curl=shared \
		--enable-dba=shared --with-gdbm --with-db4 \
		--enable-dom=shared \
		--with-enchant=shared \
		--enable-exif=shared \
		--enable-ftp=shared \
		--with-gd=shared --with-jpeg-dir=shared --with-png-dir=shared --with-xpm-dir=shared \
		--with-freetype-dir=shared --enable-gd-native-ttf --enable-gd-jis-conv \
		--with-gettext=shared \
		--with-gmp=shared \
		--with-iconv=shared \
		--enable-intl=shared --with-icu-dir=/usr \
		--enable-json=shared \
		--enable-libxml=shared --with-libxml-dir=shared --with-libexpat-dir=shared \
		--with-ldap=shared --with-ldap-sasl \
		--enable-mbstring=shared --enable-mbregex \
		--with-mssql=shared \
		--with-mcrypt=shared \
		--with-sqlite3=shared,/usr --with-pdo-sqlite=shared,/usr \
		--with-pdo-dblib=shared \
		--with-mysql=shared,mysqlnd \
		--with-mysqli=shared,/usr/bin/mysql_config \
		--enable-mysqlnd=shared --with-pdo-mysql=shared,/usr/bin/mysql_config --with-mysql-sock=/run/mysqld/mysqld.sock \
		--with-pgsql=shared --with-pdo-pgsql=shared \
		--with-unixODBC=shared,/usr -with-pdo-odbc=shared,unixODBC,/usr \
		--with-dbmaker=shared \
		--enable-opcache=shared \
		--enable-pdo=shared \
		--enable-pcntl=shared \
		--enable-posix=shared \
		--enable-phar=shared \
		--with-pspell=shared \
		--enable-session=shared \
		--enable-shmop=shared \
		--with-snmp=shared \
		--enable-soap=shared \
		--enable-sockets=shared \
		--enable-sysvmsg=shared \
		--enable-sysvsem=shared \
		--enable-sysvshm=shared \
		--enable-xml=shared \
		--enable-xmlreader=shared \
		--enable-xmlwriter=shared \
		--with-xmlrpc=shared \
		--with-xsl=shared \
		--enable-wddx=shared \
		--enable-zip=shared \
		--with-libedit \
		$@ || return 1
	sed -ri "s/^(EXTRA_LDFLAGS[ ]*\=.*)/\1 -lpthread/" Makefile
	make || return 1
}

build() {
	cd "$builddir"
	# build phpdbg
	_build --enable-phpdbg \
		--disable-cgi \
		--disable-cli \
		|| return 1
	# build apache2 module + recode extension
	_build --disable-phpdbg \
		--disable-cgi \
		--disable-cli \
		--with-apxs2 \
		--with-recode=shared \
		|| return 1
	mv libs/lib$pkgname.so sapi/apache2handler/
	# build all other
	_build --disable-phpdbg \
		--enable-fpm \
		--enable-embed \
		--with-litespeed \
		--with-imap=shared --with-imap-ssl \
		|| return 1
}

package() {
	cd "$builddir"
	make -j1 INSTALL_ROOT="$pkgdir" install || return 1
	rm -fr "$pkgdir"/.[[:alpha:]]* "$pkgdir"/var || return 1
	mv "$pkgdir"/usr/share/man/man1/php.1 \
		"$pkgdir"/usr/share/man/man1/$pkgname.1
	mv "$pkgdir"/usr/share/man/man1/php-cgi.1 \
		"$pkgdir"/usr/share/man/man1/$pkgname-cgi.1
	mv "$pkgdir"/usr/share/man/man8/php-fpm.8 \
		"$pkgdir"/usr/share/man/man8/$pkgname-fpm.8
	mv "$pkgdir"/usr/bin/php "$pkgdir"/usr/bin/$pkgname
}

dev() {
	default_dev
	replaces="php7-dev"
	depends="$depends $pkgname-phar"
	mv "$pkgdir"/usr/bin/phpize "$subpkgdir"/usr/bin/${pkgname}ize
	mv "$subpkgdir"/usr/bin/php-config "$subpkgdir"/usr/bin/$pkgname-config
	mv "$pkgdir"/usr/bin/peardev "$pkgdir"/usr/bin/phar* \
		"$subpkgdir"/usr/bin/
	mv "$pkgdir"/usr/lib/$pkgname/build "$subpkgdir"/usr/lib/$pkgname/
	# for compatibility with current builds
	ln -sf /usr/bin/${pkgname}ize "$subpkgdir"/usr/bin/phpize5
	ln -sf /usr/bin/$pkgname-config "$subpkgdir"/usr/bin/php-config5
}

doc() {
	default_doc
	install_if="docs $pkgname-common=$pkgver-r$pkgrel"
	cd "$builddir"
	for file in $(ls CODING_STANDARDS CREDITS EXTENSIONS INSTALL LICENSE NEWS README* UPGRADING*); do
		install -Dm644 $file "$subpkgdir"/usr/share/doc/$pkgname/$file || return 1
	done
}

apache2() {
	provides="php-apache2"
	pkgdesc="$pkgname module for Apache2"
	depends="$pkgname-common apache2"
	install -Dm755 "$builddir"/sapi/apache2handler/lib$pkgname.so \
		"$subpkgdir"/usr/lib/apache2/lib$pkgname.so || return 1
	install -Dm644 "$srcdir"/$pkgname-module.conf \
		"$subpkgdir"/etc/apache2/conf.d/$pkgname-module.conf
}

phpdbg() {
	provides="php-phpdbg"
	pkgdesc="$pkgname interactive debugger"
	depends="$pkgname-common"
	install -Dm755 "$builddir"/sapi/phpdbg/phpdbg \
		 "$subpkgdir"/usr/bin/${pkgname}dbg
}

embed() {
	provides="php-embed"
	pkgdesc="$pkgname embedded library"
	depends="$pkgname-common"
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/lib$pkgname.so "$subpkgdir"/usr/lib/
}

litespeed() {
	provides="php-litespeed"
	pkgdesc="$pkgname litespeed SAPI"
	depends="$pkgname-common"
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/lsphp "$subpkgdir"/usr/bin/ls$pkgname
}

cgi() {
	provides="php-cgi"
	pkgdesc="$pkgname common gateway interface"
	depends="$pkgname-common"
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/php-cgi "$subpkgdir"/usr/bin/$pkgname-cgi
}

fpm() {
	provides="php-fpm"
	pkgdesc="$pkgname FastCGI process manager"
	depends="$pkgname-common"
	mkdir -p "$subpkgdir"/etc/$pkgname \
		"$subpkgdir"/usr/share/$pkgname \
		"$subpkgdir"/var/log/$pkgname
	mv "$pkgdir"/usr/share/$pkgname/fpm "$subpkgdir"/usr/share/$pkgname || return 1
	mv "$pkgdir"/usr/sbin "$subpkgdir"/usr/
	mv "$subpkgdir"/usr/sbin/php-fpm "$subpkgdir"/usr/sbin/$pkgname-fpm || return 1
	mv "$pkgdir"/etc/$pkgname/php-fpm* "$subpkgdir"/etc/$pkgname/ || return 1
	find "$subpkgdir"/etc/$pkgname -name *.default -exec sh -c 'f={}; mv $f ${f%.default}' \;
	install -D -m755 "$srcdir"/$pkgname-fpm.initd "$subpkgdir"/etc/init.d/$pkgname-fpm
	install -D -m644 "$srcdir"/$pkgname-fpm.logrotate "$subpkgdir"/etc/logrotate.d/$pkgname-fpm
}

pear() {
	replaces="php7-pear"
	provides="php-pear"
	pkgdesc="$pkgname extension and application repository"
	depends="$pkgname $pkgname-xml"
	mkdir -p "$subpkgdir"/usr/bin "$subpkgdir"/etc/$pkgname
	mv "$pkgdir"/usr/bin/pecl "$pkgdir"/usr/bin/pear "$subpkgdir"/usr/bin/
	mv "$pkgdir"/etc/$pkgname/pear.conf "$subpkgdir"/etc/$pkgname/ || return 1
	mv "$pkgdir"/usr/share "$subpkgdir"/usr/
	rmdir "$subpkgdir"/usr/share/$pkgname || return 1
}

common() {
	pkgdesc="$pkgname common config"
	depends=
	install -Dm644 "$builddir"/php.ini-production \
		"$subpkgdir"/etc/$pkgname/php.ini || return 1
	# exit with an error if there is any configs
	# or if some modules were not in subpackages
	rmdir "$pkgdir"/usr/lib/$pkgname/modules \
		"$pkgdir"/etc/$pkgname || return 1
	rm -fr "$pkgdir"/etc "$pkgdir"/usr/lib
}

_extension() {
	local extname=${subpkgname#*-}
	provides="php-$extname"
	pkgdesc=$(eval echo \$_pkgdesc_$extname)
	[ ! "$pkgdesc" ] && pkgdesc=$(head -n1 "$builddir"/ext/$extname/CREDITS)
	pkgdesc="$pkgname extension: $pkgdesc"
	depends=$(eval echo \$_depends_$extname)
	local index=$(echo $depends | wc -w)
	depends="${depends%--*}"
	mkdir -p "$subpkgdir"/usr/lib/$pkgname/modules \
		"$subpkgdir"/etc/$pkgname/conf.d
	mv "$pkgdir"/usr/lib/$pkgname/modules/$extname.so \
		"$subpkgdir"/usr/lib/$pkgname/modules/ || return 1
	echo $(eval echo \$_prefix_$extname)extension=$extname.so >\
		"$subpkgdir"/etc/$pkgname/conf.d/$(printf %02d $index)_${extname}.ini
}

md5sums="b2772a0bdada0e20f4e1937f71416bcc  php-5.6.29.tar.bz2
dc797b19dc4bbbd9d879f8311b3fd7b1  php5-fpm.initd
5d858ed3471b3445f422fae87f2b5101  php5-fpm.logrotate
67719f428f44ec004da18705cbabe2ee  php5-module.conf
fa807a684fa853720b7523eb99869b34  fix-asm-constraints-in-aarch64-multiply-macro.patch
483bc0a85c50a9a9aedbe14a19ed4526  install-pear.patch
f216e041b6e10c9881904970b1d19ed2  includedir.patch
f31de64b4d4df9ce768517b6422b0987  php-fpm.patch"
sha256sums="499b844c8aa7be064c111692e51a093ba94e54d2d9abb01e70ea76183a1825bb  php-5.6.29.tar.bz2
e4e341bf2ab7e6a9a7993457c4ff4c7f573357009553027a2c60bc1efa8dcb95  php5-fpm.initd
298708d0f0e4518bcddc287acd204bafa449625c5bf5694d22bab818f714247e  php5-fpm.logrotate
ceec4d5b2a128c6a97e49830af604f0bb555bca1a86a9cd0366b828ba392257f  php5-module.conf
86f4186699f0bc61ce91986fe5efdd7b0da77ff9568c10ba52ca1094da94ed6e  fix-asm-constraints-in-aarch64-multiply-macro.patch
f739ca427a1dd53a388bad0823565299c5d4a5796b1171b892884e4d7d099bab  install-pear.patch
ce8aabb99c75145124193393d8534d2dfec64ba539c31fd58d089b1a6f26e245  includedir.patch
88731a5638bd0acba2ab1cf60f80022cb007a6f5bfd22730a133f3b9aea0f1ad  php-fpm.patch"
sha512sums="305049ab9ece8fd5b61f2b2beeaf8bbe994aa325911d90b5fcf8be1dbc43dcdf2528296aa017b8c73cfc3b4614e306a1741fd7c69f90fb23477ca6bf13c10d44  php-5.6.29.tar.bz2
53a49afe251fb07141a8be53696842db5bd61fa2ab75f3ed213eec03dec37cb4e60ebfe4560fb5b371f2909736f494596828cb191b3b918b180aa9a63366ebb9  php5-fpm.initd
72c19414362d7262e7dfc828dec3814a93f1c0de369c747967b33cfd8b18e2b340232308f3baf20b9458ee62d668963fa31cb2d981d5587da9b7162e3bb1f0fa  php5-fpm.logrotate
895e94c791bd82060ad820fef049d366a09c932097faa6b7b9a2c2e9e00a18cb7c0f9b128679c7659b404379266fd0f95dba5c0333f626194cf60f7bf6044102  php5-module.conf
d93d3fc015580cf5f75c6cbca4cd980e054b61e1068495da81a7e61f1af2c9ae14f09964c04928ad338142de78e4844aed885b1ad1865282072999fb045c8ad7  fix-asm-constraints-in-aarch64-multiply-macro.patch
f1177cbf6b1f44402f421c3d317aab1a2a40d0b1209c11519c1158df337c8945f3a313d689c939768584f3e4edbe52e8bd6103fb6777462326a9d94e8ab1f505  install-pear.patch
8fc56dc52b8eb2c88c69b445dd667ceefc5407017ba323701134bda9cd4f6b154db86442e5285817b5eb9799bf9e9dd11523e75006760fba80b334991d477088  includedir.patch
5d62c12d43595f71a230022c26b96faecbec149926c417bea17a7eb44c4fbff436e907beaf74c356fe301a77fbe2d207697ecdb84a0bddd12f2be8a8d20e648c  php-fpm.patch"
