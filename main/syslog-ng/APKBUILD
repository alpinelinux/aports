# Contributor: jv <jens@eisfair.org>
# Contributor: Adrian Guenter <adrian@gntr.me>
# Maintainer: jv <jens@eisfair.org>
pkgname=syslog-ng
pkgver=3.13.2
pkgrel=0
pkgdesc="Next generation logging daemon"
url="http://www.balabit.com"
arch="all !aarch64"
license="GPL-2.0"
depends=""
depends_dev="glib-dev eventlog-dev pcre-dev libressl-dev python2-dev hiredis-dev json-c-dev"
makedepends="$depends_dev"
install="$pkgname.post-install"
subpackages="$pkgname-json"

source="https://github.com/balabit/syslog-ng/releases/download/syslog-ng-${pkgver}/syslog-ng-${pkgver}.tar.gz
    syslog-ng.logrotate
    syslog-ng.initd
    syslog-ng-destination.std
    syslog-ng-filter.std
    syslog-ng-log.std
    syslog-ng-options.std
    syslog-ng-plugins.std
    syslog-ng-source.std
    libressl-openssl_version_number-fix.patch
    libressl-fips-unsupported.patch
    "

_builddir="$srcdir/${pkgname}-$pkgver"

build() {
    cd "$_builddir"
    ./configure --prefix=/usr \
    --sysconfdir=/etc/syslog-ng \
    --localstatedir=/run \
    --enable-ipv6 \
    --enable-ssl \
    --disable-sql \
    --enable-redis \
    --disable-mongodb \
    --enable-json \
    || return 1
    make || return 1
}

check() {
    cd "$_builddir"
    make check || return 0
}

package() {
    cd "$_builddir"
    make -j1 DESTDIR=${pkgdir} install || return 1
    rm -rf ${pkgdir}/etc/syslog-ng
    rm -rf ${pkgdir}/usr/share
    rm -rf ${pkgdir}/usr/include
    rm -rf ${pkgdir}/usr/lib/pkgconfig
    rm -f  ${pkgdir}/usr/lib/libsyslog-ng.so
    rm -rf ${pkgdir}/usr/lib/$pkgname/libtest
    rm -f  ${pkgdir}/usr/lib/libsyslog-ng.so
    rm -rf ${pkgdir}/run
    install -D -m755 "$srcdir"/$pkgname.initd ${pkgdir}/etc/init.d/$pkgname || return 1
    install -D -m644 "$srcdir"/syslog-ng-destination.std ${pkgdir}/etc/syslog-ng/syslog-ng-destination.std || return 1
    install -D -m644 "$srcdir"/syslog-ng-filter.std ${pkgdir}/etc/syslog-ng/syslog-ng-filter.std || return 1
    install -D -m644 "$srcdir"/syslog-ng-log.std ${pkgdir}/etc/syslog-ng/syslog-ng-log.std || return 1
    install -D -m644 "$srcdir"/syslog-ng-options.std ${pkgdir}/etc/syslog-ng/syslog-ng-options.std || return 1
    install -D -m644 "$srcdir"/syslog-ng-plugins.std ${pkgdir}/etc/syslog-ng/syslog-ng-plugins.std || return 1
    install -D -m644 "$srcdir"/syslog-ng-source.std ${pkgdir}/etc/syslog-ng/syslog-ng-source.std || return 1
    install -D -m644 "$srcdir"/syslog-ng.logrotate ${pkgdir}/etc/logrotate.d/syslog-ng || return 1
}

json() {
    pkgdesc="JSON plugin for syslog-ng"
    mkdir -p "$subpkgdir"/usr/lib/syslog-ng/
    mv "$pkgdir"/usr/lib/syslog-ng/libjson*.so "$subpkgdir"/usr/lib/syslog-ng
}

sha512sums="fd5c6645f1e8e10cba940ea29715f9e7cc286cd49c2f45bde2a447731189d6171ca204aa066ac96dd09246fd7ed1751130d143d807c979518d688e7750490cfe  syslog-ng-3.13.2.tar.gz
a062d1601f5215f60e2fc40c6ca498d768aa97af3647a9468731123a28fdd67962421b4412bfbe08a1123141b730cb78f102230ab72befec05ba7f398b39e27a  syslog-ng.logrotate
454de2d7573132704b3255c7dacdc086143a12b987521df0ff6511ebd46e3b45177e1eb283b0e02daf56adf85c31565462e2f437f84d31913ce9ccfcf039903b  syslog-ng.initd
b51d8b3da9584b6cb5b5c023b5ca1085d8e4c2cfa56f6ed12fe6feb0f33a390b43825aaaf4dd74eb6b7765485fe42f7f21c74380b72de9ed2c7775787ab1e720  syslog-ng-destination.std
e04a70a0b8fc4f40951c9b608b0dede1fa561dd7f58ce8fd8bac70b578b749d15d202973fd9de9fe494656ee138ef5efd32ea6229e6ec0a2f19672dd621acc91  syslog-ng-filter.std
d7864f6666101e0818dd0178a4d1ada2417280de153ff916fe4879348a37b7bfab5936e86629dc52e4edf82fbd601e04d08ed5a2117bcb0470a3d5884add9f55  syslog-ng-log.std
9f4224faf45c73daa54549aebf20e2c45d0bf533a20d2ad97d7258490ce793c8b08cc34cac2a89d185e936515096eb93c793018986c8d21861d88c4b0005d16a  syslog-ng-options.std
9dd65da6a805aa709441ec8080789b2d0aba7a773ed91c807c39d2b0d82dd9cf3ac014f357ec6f45038db8d5c162e04179821437662d7ece35872204fbf44cf6  syslog-ng-plugins.std
42cc7728a182fee30675aefee9055eb14bdfbf2006bcf1c731864221ea494ad82d9ae4417190ff18da4a663fa9d5efcd514b6e64a568e228cfed1fb2abd2b10c  syslog-ng-source.std
322aee0b85443571b83ea0d7a626ae328f92bcc29007781da70ca3150742a1cc717e229c8a00fee549a52691a650583ee376740abf45c051d0add829c7db1611  libressl-openssl_version_number-fix.patch
b485813b893efc2057cd8ac2288dc508fb55c1fc9895598dc9cc2f8f79bd73fc621bae00d80efd3be6bb4c3ac662e8a5d089a3c8e6cde5637022f19bae553dac  libressl-fips-unsupported.patch"
