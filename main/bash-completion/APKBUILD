# Contributor: SÃ¶ren Tempel <soeren+alpine@soeren-tempel.net>
# Contributor: Kiyoshi Aman <kiyoshi.aman@gmail.com>
# Contributor: Eivind Uggedal <eu@eju.no>
# Maintainer: Lucas Ramage <ramage.lucas@openmailbox.org>
pkgname=bash-completion
pkgver=2.9
pkgrel=0
pkgdesc="Command-line tab-completion for bash"
url="https://github.com/scop/bash-completion"
arch="noarch"
license="GPL-2.0-or-later"
depends="bash"
# Tests fail when running with busybox's applets with limited
# command line flags, so we install the more heavyweight utilities.
checkdepends="pytest py-pexpect coreutils sed wget procps
	usbutils psmisc iputils grep less bc"
subpackages="$pkgname-dev"
source="$url/releases/download/$pkgver/$pkgname-$pkgver.tar.xz"
builddir="$srcdir"/$pkgname-$pkgver

prepare() {
	# /usr merge has lead people to use /usr/bin/sh:
	sed -i '1c#!/bin/sh' install-sh
}

build() {
	cd "$builddir"
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc
	make
}

check() {
	cd "$builddir"
	# Don't run tests that are incompatible with the command line
	# flags in musl-utils and busybox:
	for p in iconv ifdown ifup getconf man; do
		rm test/t/test_${p}.py
	done

	# Fails in environments without working IPv6:
	rm test/t/unit/test_unit_ip_addresses.py

	make check
}

package() {
	cd "$builddir"
	make -j1 DESTDIR="$pkgdir" install
}

dev() {
	default_dev

	mkdir -p "$subpkgdir"/usr/share
	mv "$pkgdir"/usr/share/pkgconfig "$pkgdir"/usr/share/cmake \
		"$subpkgdir"/usr/share
}

sha512sums="e864091196d670699bdb2af3fc40464788e79c932fa564afa7ba34a637aa1583db7dbceab0e7ba6718fac99e9fd2dfb03d1ee51d7cf279d925ad63f60401d7d5  bash-completion-2.9.tar.xz"
