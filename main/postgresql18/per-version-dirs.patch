Author: Martin Pitt <mpitt@debian.org>
Description: Use version specific installation directories so that several major versions can be installed in parallel.

 * Install server lib files into /usr/lib/postgresql<version>/
 * Install server related header files into /usr/include/postgresql/<version>/server/
 * Disable PostgreSQL's automagic path mangling and fix libdir for pg_config,
   so that pg_config in /usr/bin and /usr/libexec/postgresql<version> behave
   identically.

Bug-Debian: http://bugs.debian.org/462037
Patch-Source: https://sources.debian.org/src/postgresql-14/14.0-1/debian/patches/50-per-version-dirs.patch

diff --git a/src/Makefile.global.in b/src/Makefile.global.in
index 8b1b357..18dd786 100644
--- a/src/Makefile.global.in
+++ b/src/Makefile.global.in
@@ -129,7 +129,7 @@ libdir := @libdir@
 pkglibdir = $(libdir)
 ifeq "$(findstring pgsql, $(pkglibdir))" ""
 ifeq "$(findstring postgres, $(pkglibdir))" ""
-override pkglibdir := $(pkglibdir)/postgresql
+override pkglibdir := /usr/lib/postgresql@PG_MAJORVERSION@
 endif
 endif
 
@@ -172,7 +172,7 @@ endif # PGXS
 
 # These derived path variables aren't separately configurable.
 
-includedir_server = $(pkgincludedir)/server
+includedir_server = $(pkgincludedir)/@PG_MAJORVERSION@/server
 includedir_internal = $(pkgincludedir)/internal
 pgxsdir = $(pkglibdir)/pgxs
 bitcodedir = $(pkglibdir)/bitcode
diff --git a/src/bin/pg_config/pg_config.c b/src/bin/pg_config/pg_config.c
index 28db024..4b96e65 100644
--- a/src/bin/pg_config/pg_config.c
+++ b/src/bin/pg_config/pg_config.c
@@ -26,6 +26,8 @@
 
 #include "common/config_info.h"
 
+#include "../port/pg_config_paths.h"
+
 static const char *progname;
 
 /*
@@ -148,11 +150,7 @@ main(int argc, char **argv)
 		}
 	}
 
-	if (find_my_exec(argv[0], my_exec_path) < 0)
-	{
-		fprintf(stderr, _("%s: could not find own program executable\n"), progname);
-		exit(1);
-	}
+	snprintf(my_exec_path, sizeof(my_exec_path), "%s/%s", PGBINDIR, progname);
 
 	configdata = get_configdata(my_exec_path, &configdata_len);
 	/* no arguments -> print everything */
diff --git a/src/test/perl/PostgreSQL/Test/Utils.pm b/src/test/perl/PostgreSQL/Test/Utils.pm
index 7d7ca83..a378517 100644
--- a/src/test/perl/PostgreSQL/Test/Utils.pm
+++ b/src/test/perl/PostgreSQL/Test/Utils.pm
@@ -730,6 +730,14 @@ sub scan_server_header
 	  or die "could not execute pg_config";
 	chomp($stdout);
 	$stdout =~ s/\r$//;
+	# XXX-Patched: Alpine's pg_config is not relocatable, manually check for correct location
+	if (-d "../../../tmp_install/usr/include/postgresql") {
+		my $result = IPC::Run::run [ 'pg_config', '--major-version' ], '>',
+		  \$stdout, '2>', \$stderr;
+		chomp($stdout);
+		$stdout =~ s/\r$//;
+		$stdout = "../../../tmp_install/usr/include/postgresql/" . $stdout . "/server";
+	}
 
 	open my $header_h, '<', "$stdout/$header_path" or die "$!";
 
@@ -769,6 +777,10 @@ sub check_pg_config
 	  or die "could not execute pg_config";
 	chomp($stdout);
 	$stdout =~ s/\r$//;
+	# XXX-Patched: Alpine's pg_config is not relocatable, manually check for correct location
+	if (-d "../../../tmp_install/usr/include/postgresql") {
+		$stdout = "../../../tmp_install/usr/include/postgresql";
+	}
 
 	open my $pg_config_h, '<', "$stdout/pg_config.h" or die "$!";
 	my $match = (grep { /^$regexp/ } <$pg_config_h>);
