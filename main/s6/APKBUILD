# Maintainer: Laurent Bercot <ska-devel@skarnet.org>
pkgname=s6
pkgver=2.14.0.1
pkgrel=0
pkgdesc="skarnet.org's small & secure supervision software suite."
url="https://skarnet.org/software/s6/"
arch="all"
license="ISC"
makedepends="skalibs-dev
	execline-dev"
depends="s6-ipcserver
	execline"
options="!check"  # No test suite.
subpackages="$pkgname-ipcserver $pkgname-static $pkgname-libs $pkgname-dev $pkgname-doc $pkgname-openrc"
source="https://skarnet.org/software/s6/s6-$pkgver.tar.gz s6-svscanboot s6.initd"
install="s6.pre-install s6.pre-upgrade"
triggers="s6.trigger=/run/service"

_ipcserver_binaries="usr/bin/s6-ipcserver usr/bin/s6-ipcserver-socketbinder usr/bin/s6-ipcserverd usr/bin/s6-applyuidgid"

build() {
	./configure \
		--prefix=/usr \
		--libexecdir="/usr/libexec/$pkgname" \
		--enable-shared \
		--disable-allstatic \
		--with-pkgconfig \
		--enable-pkgconfig
	make
}

package() {
	make DESTDIR="$pkgdir" install
	install -D -m 0755 "$srcdir/s6-svscanboot" "$pkgdir/usr/libexec/s6/s6-svscanboot"
	install -D -m 0755 "$srcdir/s6.initd" "$pkgdir/etc/init.d/s6"
	install -D -m 0644 COPYING "$pkgdir/usr/share/licenses/$pkgname/COPYING"
	mkdir -p "$pkgdir/usr/share/doc"
	cp -a doc "$pkgdir/usr/share/doc/$pkgname"
}

ipcserver() {
	depends=""
	amove $_ipcserver_binaries
}

sha512sums="
c267285f6018d22018019ed9c0f07576e3bf9274711ed76f0b4da28aee940b3a689fdc281cfa93b0b3b7deacd2a0501e590beb23cab5719b9af30b7126b03a70  s6-2.14.0.1.tar.gz
206cdc275b81e60d8c8b7553ed1ce52ef0a868c853ccbb278e99459a8597fe650d1869973ca0a4526695664f0e853abfdae1a606276ab84db28d33d886f60751  s6-svscanboot
2c968e6238e7be6d351f6073b16e0bcf4c4573f5c14f0cfeddfee29101daf2ac5601dbf6cc108fc600f94eefb41f7fe3bc3c87cf2b3f6a8ee7280a1dc752291d  s6.initd
"
