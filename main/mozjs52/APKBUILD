# Maintainer: Rasmus Thomsen <oss@cogitri.dev>
pkgname=mozjs52
pkgver=52.9.0
_majver=${pkgver%%.*}
pkgrel=0
pkgdesc="standalone mozilla javascript engine"
url="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Releases/38"
arch="all !armhf !armv7 !s390x"
license="MPL-2.0"
depends_dev="icu-dev nspr-dev libffi-dev readline-dev mozjs52"
makedepends="$depends_dev zlib-dev python2 perl sed autoconf2.13 linux-headers"
subpackages="$pkgname-dev"
source="https://ftp.mozilla.org/pub/firefox/releases/${pkgver}esr/source/firefox-${pkgver}esr.source.tar.xz
	add-exposeToActiveJS.patch
	mozjs52-copy-headers.patch
	mozjs52-disable-mozglue.patch
	mozjs52-include-configure-script.patch
	fix-soname-lib.patch"
builddir="$srcdir"/firefox-${pkgver}esr
_builddir="$builddir/js/src"

build() {
	cd "$_builddir"

	# avoid complains about autoconf
	touch configure

	# https://bugzilla.mozilla.org/show_bug.cgi?id=1208526
	sed -e "s|'testPreserveJitCode.cpp',||" \
		-e "s|'testGCAllocator.cpp',||" \
		-i jsapi-tests/moz.build

	export SHELL=/bin/ash
	PYTHON=/usr/bin/python2 ./configure --prefix=/usr \
		--with-system-icu \
		--with-system-nspr \
		--with-system-zlib \
		--with-intl-api \
		--enable-ctypes \
		--enable-shared-js \
		--enable-readline \
		--enable-system-ffi \
		--disable-optimize \
		--disable-jemalloc \
		--enable-pie
	make
}

check() {
	cd "$_builddir"
	dist/bin/jsapi-tests
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install
	rm -f "$pkgdir"/usr/lib/*.ajs
}

sha512sums="bfca42668ca78a12a9fb56368f4aae5334b1f7a71966fbba4c32b9c5e6597aac79a6e340ac3966779d2d5563eb47c054ab33cc40bfb7306172138ccbd3adb2b9  firefox-52.9.0esr.source.tar.xz
7ad9dbd07a74673d0f531c1cf1aad05a169126321007ea231b3a9f090e018e681da0d16a33d662245fd0bb10e8feb2a4a282683d6e9a2307d70fdcfb2a321387  add-exposeToActiveJS.patch
5ade1fcb33ecca920334c1c0b7e0028a7e31fee0e0f27f62eab6f91230fae87056a1589cfa4268cf9693dcc9f3cd7d6106983d3b03db39cb87b909f5d9109170  mozjs52-copy-headers.patch
639bde6a5b92811f246c963ad5335148cd40e94161ecf0e7669e6bc4385b5387ac33a19b94f0870df62ba130f084e2d50393b6ddcaace3bbea73be101b48fe6a  mozjs52-disable-mozglue.patch
2465b1427d5cbf740f50d18d2cd1bef139bb6eab2fdd948afcd0de68ba3af59587c7563561dbe42bf24f5b50bc8be4f835a82b670702bf6e99cdc919cc6f0eaf  mozjs52-include-configure-script.patch
ea12b47851abca2bd475c1a9d3236e1fc924495d027ab25bb29c03fbebf6544e2840cf1a45f21b1f90d36f3fa0f91b8b2bb7a2565ce0d5ac606c96e4ae802a8a  fix-soname-lib.patch"
