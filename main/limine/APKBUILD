# Maintainer: Mintsuki <mintsuki@protonmail.com>
pkgname=limine
pkgver=10.5.0
pkgrel=0
pkgdesc="Advanced, portable, multiprotocol bootloader"
url="https://limine-bootloader.org"
arch="noarch"
license="BSD-2-Clause"
install="
	$pkgname-efi-updater.post-install
	$pkgname-bios-updater.post-install
"
triggers="
	$pkgname-efi-updater.trigger=/usr/share/limine
	$pkgname-bios-updater.trigger=/usr/share/limine
"
makedepends="
	clang
	lld
	llvm
	mtools
	nasm
	"
subpackages="
	$pkgname-doc
	$pkgname-tool::all
	$pkgname-efi-updater:efi_updater
	$pkgname-efi-aarch64:efi_aarch64
	$pkgname-efi-loongarch64:efi_loongarch64
	$pkgname-efi-riscv64:efi_riscv64
	$pkgname-efi-x86:efi_x86
	$pkgname-efi-x86_64:efi_x86_64
	$pkgname-efi-cd:efi_cd
	$pkgname-bios-updater:bios_updater
	$pkgname-bios
	$pkgname-bios-pxe:bios_pxe
	$pkgname-bios-cd:bios_cd
	"
source="https://codeberg.org/Limine/Limine/releases/download/v$pkgver/limine-$pkgver.tar.gz
	limine-efi-updater.sh
	limine-efi-updater.conf
	limine-bios-updater.sh
	limine-bios-updater.conf
	"
options="!check" # no tests in tarball

build() {
	CFLAGS="$CFLAGS -flto=auto" \
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--enable-all
	make
}

package() {
	depends="
		$pkgname-tool
		$pkgname-efi-aarch64
		$pkgname-efi-loongarch64
		$pkgname-efi-riscv64
		$pkgname-efi-x86
		$pkgname-efi-x86_64
		$pkgname-efi-cd
		$pkgname-bios
		$pkgname-bios-pxe
		$pkgname-bios-cd
	"

	make DESTDIR="$pkgdir" install

	install -Dm644 "$srcdir"/limine-efi-updater.conf -t "$pkgdir"/etc/limine/
	install -Dm755 "$srcdir"/limine-efi-updater.sh -t "$pkgdir"/usr/bin/

	install -Dm644 "$srcdir"/limine-bios-updater.conf -t "$pkgdir"/etc/limine/
	install -Dm755 "$srcdir"/limine-bios-updater.sh -t "$pkgdir"/usr/bin/
}

tool() {
	pkgdesc="Limine host tool"

	amove usr/bin/limine
}

bios_cd() {
	pkgdesc="$pkgdesc (BIOS CD binary)"
	depends="$pkgname-bios=$pkgver-r$pkgrel"

	amove usr/share/limine/limine-bios-cd.bin
}

bios_pxe() {
	pkgdesc="$pkgdesc (BIOS PXE executable)"
	depends="$pkgname-bios=$pkgver-r$pkgrel"

	# renamed to be less vague
	provides="$pkgname-pxe=$pkgver-r$pkgrel"
	replaces="$pkgname-pxe"

	amove usr/share/limine/limine-bios-pxe.bin
}

bios() {
	pkgdesc="$pkgdesc (BIOS sys file)"

	# renamed to be less vague
	provides="$pkgname-sys=$pkgver-r$pkgrel"
	replaces="$pkgname-sys"

	amove usr/share/limine/limine-bios.sys
}

bios_updater() {
	pkgdesc="Limine auto-updater for BIOS"

	depends="$pkgname-tool=$pkgver-r$pkgrel $pkgname-bios=$pkgver-r$pkgrel"

	amove etc/limine/limine-bios-updater.conf
	amove usr/bin/limine-bios-updater.sh
}

efi_cd() {
	pkgdesc="$pkgdesc (EFI CD binary)"

	amove usr/share/limine/limine-uefi-cd.bin
}

efi_x86() {
	pkgdesc="$pkgdesc (IA-32 EFI image)"

	# renamed to be less vague
	provides="$pkgname-x86=$pkgver-r$pkgrel"
	replaces="$pkgname-x86"

	amove usr/share/limine/BOOTIA32.EFI
}

efi_x86_64() {
	pkgdesc="$pkgdesc (x86-64 EFI image)"

	# renamed to be less vague
	provides="$pkgname-x86_64=$pkgver-r$pkgrel"
	replaces="$pkgname-x86_64"

	amove usr/share/limine/BOOTX64.EFI
}

efi_aarch64() {
	pkgdesc="$pkgdesc (aarch64 EFI image)"

	# renamed to be less vague
	provides="$pkgname-aarch64=$pkgver-r$pkgrel"
	replaces="$pkgname-aarch64"

	amove usr/share/limine/BOOTAA64.EFI
}

efi_riscv64() {
	pkgdesc="$pkgdesc (riscv64 EFI image)"

	# renamed to be less vague
	provides="$pkgname-riscv64=$pkgver-r$pkgrel"
	replaces="$pkgname-riscv64"

	amove usr/share/limine/BOOTRISCV64.EFI
}

efi_loongarch64() {
	pkgdesc="$pkgdesc (loongarch64 EFI image)"

	# renamed to be less vague
	provides="$pkgname-loongarch64=$pkgver-r$pkgrel"
	replaces="$pkgname-loongarch64"

	amove usr/share/limine/BOOTLOONGARCH64.EFI
}

efi_updater() {
	pkgdesc="Limine auto-updater for EFI payload"

	amove etc/limine/limine-efi-updater.conf
	amove usr/bin/limine-efi-updater.sh
}

sha512sums="
b65e3cbf4fa9567d5da1da9a3f70be0b6407f788710ef1e5a1eeb7f2543d29d6b95fdde19aafaa3e087e0be5ae7de639afa515830d753ee33553fd4d304c8187  limine-10.5.0.tar.gz
cdf0e39ebb4bb4b5e084ab5c2c0fb7c5fa53fb6e8b9e989ab1c6487780e3fdfe7ec9a8a3f537d5dc221743073c8c44ffeb1ff38b3b461b3b01e949c18bf6fdf2  limine-efi-updater.sh
a0d64485021d068629f3a2bd6b8005352779058cbe5d90a9eb52a2e5aee592a82189ff40312bbd7ec11a6c366ec0912ff61854360975f1219487fa05067830c0  limine-efi-updater.conf
55b8944e5753b855142d39de67ed9b6a68119c21f416594751d0a9fa7d758528027a75166c0d3732e58f0641e1dbd79da732e949a571b57b6272b10fdabb7dcd  limine-bios-updater.sh
0602c3ac3ff39d7ba3d4ec2939a3c45e173dbd3e48376704412822d11a6a1ab0f40358b72cf5e9aff1bb1ed14cdf568e2c890f1252bde91886579c4ad53db5dd  limine-bios-updater.conf
"
