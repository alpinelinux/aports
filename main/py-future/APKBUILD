# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Contributor: Orson Teodoro <orsonteodoro@hotmail.com>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>

pkgname=py-future
_pkgname=future
__pkgname=python-future
pkgver=0.16.0
pkgrel=0
pkgdesc="Easy, clean, reliable Python 2/3 compatibility"
url="http://python-future.org/"
arch="noarch"
license="MIT"
depends="py-argparse"
checkdepends="py2-unittest2"
makedepends="python2-dev python3-dev py-setuptools py3-setuptools"
subpackages="py3-$_pkgname:_py3 py2-$_pkgname:_py2 $pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/PythonCharmers/$__pkgname/archive/v$pkgver.tar.gz
	musl-disable-locale-test.patch
	bool-correct-semantics-pass-1.patch
	bool-correct-semantics-pass-2.patch
	test-bool-customized.patch"
builddir="$srcdir/$__pkgname-$pkgver"

_build() {
	local python="$1"
	msg "running build for $python"
	cp -a "$builddir" "${builddir}_${python}"
	cd "${builddir}_${python}"
	$python setup.py build
}

build() {
	_build python2
	_build python3
}

_check() {
	local python="$1"
	msg "running check for $python"
	cd "${builddir}_${python}"
	$python setup.py check
	$python setup.py test
}

check() {
	# run=1077 errors=1 failures=1 
	# fails because musl locale support or 
	# locale.getpreferredencoding(False) returns ANSI in the test
	_check python2 
	#_check python3 # lots of errors ; run=1077 errors=46 failures=0
}

package() {
	cd "$builddir"
	install -d "$pkgdir"/usr/share/doc/$pkgname
	install -t "$pkgdir"/usr/share/doc/$pkgname README.rst
}

_py() {
	local python="$1"
	pkgdesc="$pkgdesc (for $python)"
	depends="$depends $python"
	install_if="$pkgname=$pkgver-r$pkgrel $python"
	cd "${builddir}_${python}"
	$python setup.py install --prefix=/usr --root="$subpkgdir"
	install -Dm0644 LICENSE.txt \
		$pkgdir/usr/share/licenses/$pkgname/LICENSE.txt
}

_py2() {
	depends="${depends//py-/py2-}"
	replaces="$pkgname"
	_py python2
}

_py3() {
	depends="${depends//py-/py3-}"
	_py python3
}

sha512sums="8422e132921d7c0da1f1025ce672ddb301d604bf4629c73634b709a12d77465e941f7365f9e85e870d98718a37988bd928cda7325eb0cc27b1351d23d31a365e  py-future-0.16.0.tar.gz
f0f00c4df93167dc57291253558a5924abe87989b931fd812adff012dfe898cfc9bbf046674f0fdff73be1248e14398961e474ea9a2b827116143158d4885cd5  musl-disable-locale-test.patch
f6be594c497d2529bacfe3d1a5bc9f4985fea008b46e741c3ec6f1e7162720911b9c65302820e7caa7bdf996745195652035179592632c6045699393f5f09a91  bool-correct-semantics-pass-1.patch
bf00f1dc714693c77910c3cb20425c51073b92229850649aa7d3702097b44af95946862ad6ef574bdaaa17e8e1add37e74e01d9c333bd7cd0bcab2afc51d828a  bool-correct-semantics-pass-2.patch
8c0d4b41de71fd48b8935445c79d02316e8c8cf377e6c4fab8a0ff420aa4acc5e2ffc0da14f0d9dff56ebdfd772fd731246b4f10b7ff0bc0343d79778766a958  test-bool-customized.patch"
