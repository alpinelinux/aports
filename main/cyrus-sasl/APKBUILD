# Contributor: Leonardo Arena <rnalrd@alpinelinux.org>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=cyrus-sasl
pkgver=2.1.26
pkgrel=13
pkgdesc="Cyrus Simple Authentication Service Layer (SASL)"
url="https://cyrusimap.org/"
arch="all"
license="custom"
options="!check"  # No test suite.
subpackages="$pkgname-dev $pkgname-doc $pkgname-gssapi $pkgname-gs2
	$pkgname-scram $pkgname-ntlm $pkgname-crammd5 $pkgname-digestmd5
	libsasl $pkgname-openrc"
depends=
makedepends="db-dev libressl-dev heimdal-dev
	autoconf automake libtool"
source="ftp://ftp.cyrusimap.org/$pkgname/$pkgname-$pkgver.tar.gz
	saslauthd.initd
	cyrus-sasl-2.1.25-avoid_pic_overwrite.patch
	cyrus-sasl-2.1.26-size_t.patch
	CVE-2013-4122.patch
	"

# secfixes:
#   2.1.26-r7:
#   - CVE-2013-4122

builddir="$srcdir"/$pkgname-$pkgver
prepare() {
	cd "$builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i;;
		esac
	done

	# the libtool they ship is broken
	sed 's/AM_CONFIG_HEADER/AC_CONFIG_HEADERS/' -i configure.in
	rm -rf config/config.guess config/config.sub config/ltconfig \
		config/ltmain.sh config/libtool.m4 autom4te.cache
	libtoolize -c && aclocal -I config -I cmulocal \
		&& automake -a -c && autoheader && autoconf
}

build() {
	cd "$builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--disable-anon \
		--enable-cram \
		--enable-digest \
		--enable-login \
		--enable-ntlm \
		--disable-otp \
		--enable-plain \
		--with-gss_impl=heimdal \
		--with-devrandom=/dev/urandom \
		--without-ldap \
		--with-saslauthd=/var/run/saslauthd \
		--mandir=/usr/share/man
	# parallell builds is broken
	make -j1
}

package() {
	cd "$srcdir"/cyrus-sasl-$pkgver
	make -j1 DESTDIR="$pkgdir" install
	install -D -m644 COPYING "$pkgdir"/usr/share/licenses/$pkgname/COPYING

	install -Dm755 ../saslauthd.initd "$pkgdir"/etc/init.d/saslauthd
	install -d "$pkgdir"/var/run/saslauthd
}

_plugindir=usr/lib/sasl2
_plugin() {
	depends=
	replaces="libsasl"
	pkgdesc="Cyrus SASL plugin for $1"
	mkdir -p "$subpkgdir"/$_plugindir
	mv "$pkgdir"/$_plugindir/lib${1}.so* "$subpkgdir"/$_plugindir/
}

gssapi() { _plugin gssapiv2; }
gs2() { _plugin gs2; }
scram() { _plugin scram; }
ntlm() { _plugin ntlm; }
crammd5() { _plugin crammd5; }
digestmd5() { _plugin digestmd5; }

libsasl() {
	depends=
	pkgdesc="Cyrus Simple Authentication and Security Layer (SASL) library"
	mkdir -p "$subpkgdir"/usr
	mv "$pkgdir"/usr/lib "$subpkgdir"/usr/
}

