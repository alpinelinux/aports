# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
_flavor=${FLAVOR:-grsec}
_kpkg=linux-$_flavor
_realname=xtables-addons
_name=$_realname-$_flavor

_kver=3.10.40
_kpkgrel=0

_realver=2.3
_mypkgrel=0

# source the kernel version
if [ -f ../linux-$_flavor/APKBUILD ]; then
	. ../linux-$_flavor/APKBUILD
	[ "$_kver" != "$pkgver" ] && die "$_name: Please update _kver to $pkgver"
	[ "$_kpkgrel" != "$pkgrel" ] && die "$_name: Please update _kpkgrel to $pkgrel"
fi

_kernelver=$_kver-r$_kpkgrel
_abi_release=${_kver}-${_kpkgrel}-${_flavor}

pkgname=$_name
pkgver=$_kver
pkgrel=$(($_kpkgrel + $_mypkgrel))
pkgdesc="Iptables extensions kernel modules"
url="http://xtables-addons.sourceforge.net/"
arch="all"
license="GPL"
depends="linux-${_flavor}=${_kernelver}"
makedepends="linux-${_flavor}-dev=${_kernelver} iptables-dev pkgconfig"
install=
install_if="linux-$_flavor=$_kernelver $_realname"
subpackages=
source="http://downloads.sourceforge.net/$_realname/$_realname-$_realver.tar.xz"

_builddir="$srcdir/$_realname-$_realver"

prepare() {
	cd "$_builddir"
	update_config_sub || return 1
}

build() {
	cd "$_builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--with-kbuild=/usr/src/linux-headers-${_abi_release} \
		|| return 1

	cd extensions
	export GCC_SPECS=hardenednopie.specs
	make CC="${CC:-gcc}" modules || return 1
}

package() {
	cd "$_builddir/extensions"
	make DESTDIR="$pkgdir" modules_install
}

md5sums="7d942729c365a549513511061f74c3e3  xtables-addons-2.3.tar.xz"
sha256sums="7ab43981d594131ec8d72d4604c92c25dcf67dd4cae6aabb71113238a27cdff9  xtables-addons-2.3.tar.xz"
sha512sums="08d529f0a2fa96ba715d2142934d6568a3c4f0ddb49f06c3c4d4ac200de0a4d2b59a4007302b557ca21014cbacda104e7781df0d5158e5313a673a928453abcc  xtables-addons-2.3.tar.xz"
