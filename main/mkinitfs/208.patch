From e173a2ba3d8f5b46a1b542cb7440e829fe4a6f69 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Pablo=20Correa=20G=C3=B3mez?=
 <pabloyoyoista@postmarketos.org>
Date: Mon, 20 Oct 2025 17:19:27 +0200
Subject: [PATCH] initramfs-init: make tmpfs sysroot /usr-merge opt-in

---
 initramfs-init.in | 8 ++++++--
 tests/test_env.sh | 2 +-
 2 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/initramfs-init.in b/initramfs-init.in
index 16048e1..da98cc9 100755
--- a/initramfs-init.in
+++ b/initramfs-init.in
@@ -515,6 +515,7 @@ myopts="BOOTIF
 	apkovl
 	autodetect_serial
 	blacklist
+	bootstrap_usr_merged
 	chart
 	cryptdiscards
 	cryptdm
@@ -854,9 +855,12 @@ if [ -n "$KOPT_rootflags" ]; then
 	rootflags="$rootflags,$KOPT_rootflags"
 fi
 
+
 $MOCK mount -t tmpfs -o $rootflags tmpfs $sysroot
-$MOCK mkdir -p "$sysroot"/usr/lib "$sysroot"/usr/bin "$sysroot"/usr/sbin
-$MOCK ln -s usr/bin usr/sbin usr/lib "$sysroot"/
+if [ "$KOPT_bootstrap_usr_merged" = "yes" ]; then
+	$MOCK mkdir -p "$sysroot"/usr/lib "$sysroot"/usr/bin "$sysroot"/usr/sbin
+	$MOCK ln -s usr/bin usr/sbin usr/lib "$sysroot"/
+fi
 
 if [ -z "$KOPT_apkovl" ]; then
 	# Not manually set, use the apkovl found by nlplug
diff --git a/tests/test_env.sh b/tests/test_env.sh
index c556fee..ce98bc7 100644
--- a/tests/test_env.sh
+++ b/tests/test_env.sh
@@ -6,6 +6,7 @@ PATH="$srcdir:$PWD/bin:$PATH"
 
 export ROOT="$PWD"
 export MOCK=echo
+export KOPT_bootstrap_usr_merged="yes"
 
 init_tests() {
 	TESTS=
@@ -21,4 +22,3 @@ atf_init_test_cases() {
 		atf_add_test_case "$t"
 	done
 }
-
-- 
GitLab

