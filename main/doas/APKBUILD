# Maintainer: Drew DeVault <sir@cmpwn.com>
pkgname=doas
pkgver=6.8.2
pkgrel=4
pkgdesc="OpenBSD's temporary privilege escalation tool"
url="https://github.com/Duncaen/OpenDoas"
arch="all"
license="ISC"
makedepends="bison"
subpackages="$pkgname-doc"
install="$pkgname.post-install $pkgname.post-upgrade"
source="$pkgname-$pkgver.tar.gz::https://github.com/Duncaen/OpenDoas/archive/v$pkgver.tar.gz
	configuration-directory.patch
	manpage-example-path.patch
	change-PATH.patch
	"
builddir="$srcdir/OpenDoas-$pkgver"
options="$options suid"

# secfixes:
#   6.8-r1:
#     - CVE-2019-25016

build() {
	./configure \
		--prefix=/usr \
		--without-pam \
		--with-timestamp \
		--with-doas-confdir
	make
}

check() {
	# doas -v returns 1
	./doas -v || test $? = 1
}

package() {
	make install DESTDIR="$pkgdir"
	install -d "$pkgdir"/usr/share/doc/$pkgname
	cat > "$pkgdir"/usr/share/doc/$pkgname/doas.conf.example <<-EOF
	# see doas.conf(5) for configuration details

	# Uncomment to allow group "wheel" to become root
	# permit persist :wheel
	EOF
}

sha512sums="
4a93ff477413c859ba2702e688fa4f83248fff85e61e12336838a1e9aa1a8d9963a9782e4bc5e58e8d04b86c2c8ceb6b235ae9d3b32b3e548a2514a43653137d  doas-6.8.2.tar.gz
1d30ebab975aa51717a46ca4f5c7ed66cb333931587e4cf57ac25c111a62821709e71bfef829d90f6aca04498480965e8d05d0e102e7197b5197e8f8c19a5591  configuration-directory.patch
60efd196595bda2c4f036cd0080a8825a85fedcc7524c917304b342373863213b3c557b4336f1dab760f167fd8cc2a59b2e744d8a47ff8a8acebbe74b1328f4f  manpage-example-path.patch
31a87aced097ea1189c2162172788cd27b82af318db3476e1c143d3c87d99e2aa6350f63b81361d0a54482ba8dd0cfd10928ff6074a4c66248a1ec815a274f68  change-PATH.patch
"
