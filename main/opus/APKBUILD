# Contributor: Carlo Landmeter <clandmeter@alpinelinux.org>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
pkgname=opus
pkgver=1.6.1
pkgrel=0
pkgdesc="Codec designed for interactive speech and audio transmission over the Internet"
url="https://www.opus-codec.org/"
arch="all"
license="BSD-3-Clause"
makedepends="meson"
subpackages="$pkgname-dev $pkgname-doc"
source="https://downloads.xiph.org/releases/opus/opus-$pkgver.tar.gz"

# secfixes:
#   0:
#     - CVE-2022-25345

build() {
	CFLAGS="${CFLAGS/-Os/-O2}" \
	CPPFLAGS="${CPPFLAGS/-Os/-O2}" \
	abuild-meson \
		-Db_lto=true \
		-Dcustom-modes=true \
		-Dextra-programs=enabled \
		-Dtests="$(want_check && echo enabled || echo disabled)" \
		. output
	meson compile -C output
}

check() {
	case "$CARCH" in
	a*)
		# opus:test_opus_api takes a bit longer on arm
		meson test -t1800 --print-errorlogs -C output ;;
	*)
		meson test -t10 --print-errorlogs -C output ;;
	esac

}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
	install -Dm644 COPYING "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

sha512sums="
93742e86b2eb222808a5055e62627d142e6e7347b3d5aebb4d39b45df78ed7d437746c51eb24d724a7c865d064e9d16f4541a4ce6a82fcf7dcc23427d2252e16  opus-1.6.1.tar.gz
"
