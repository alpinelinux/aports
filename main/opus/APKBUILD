# Contributor: Carlo Landmeter <clandmeter@alpinelinux.org>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
pkgname=opus
pkgver=1.4
pkgrel=0
pkgdesc="Codec designed for interactive speech and audio transmission over the Internet"
url="https://www.opus-codec.org/"
arch="all"
license="BSD-3-Clause"
makedepends="meson"
subpackages="$pkgname-dev $pkgname-doc"
source="https://github.com/xiph/opus/releases/download/v$pkgver/opus-$pkgver.tar.gz"

# secfixes:
#   0:
#     - CVE-2022-25345

build() {
	CFLAGS="${CFLAGS/-Os/-O2}" \
	CPPFLAGS="${CPPFLAGS/-Os/-O2}" \
	abuild-meson \
		-Db_lto=true \
		-Dcustom-modes=true \
		-Dtests="$(want_check && echo enabled || echo disabled)" \
		. output
	meson compile -C output
}

check() {
	meson test --no-rebuild --print-errorlogs -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
	install -Dm644 COPYING "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

sha512sums="
1ecd39e0add24de12823bf7c936bb67441228721e2cdae0edbfcf3cee0894bcc6edf2a1d0ca5cdfdad1565803bf39cc4c985ad32710c2a9582f850adeb5ca631  opus-1.4.tar.gz
"
