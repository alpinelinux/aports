# Contributor: Carlo Landmeter <clandmeter@alpinelinux.org>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
pkgname=opus
pkgver=1.6
pkgrel=0
pkgdesc="Codec designed for interactive speech and audio transmission over the Internet"
url="https://www.opus-codec.org/"
arch="all"
license="BSD-3-Clause"
makedepends="meson"
subpackages="$pkgname-dev $pkgname-doc"
source="https://downloads.xiph.org/releases/opus/opus-$pkgver.tar.gz"

# secfixes:
#   0:
#     - CVE-2022-25345

build() {
	CFLAGS="${CFLAGS/-Os/-O2}" \
	CPPFLAGS="${CPPFLAGS/-Os/-O2}" \
	abuild-meson \
		-Db_lto=true \
		-Dcustom-modes=true \
		-Dextra-programs=enabled \
		-Dtests="$(want_check && echo enabled || echo disabled)" \
		. output
	meson compile -C output
}

check() {
	case "$CARCH" in
	a*)
		# opus:test_opus_api takes a bit longer on arm
		meson test -t1800 --print-errorlogs -C output ;;
	*)
		meson test -t10 --print-errorlogs -C output ;;
	esac

}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
	install -Dm644 COPYING "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

sha512sums="
23a71d6ed610d35742c990902eb2c7b17f28fb8d38677193f984e3ad7ed506c816062f241af5d8ab901cc91d0ddb890b774efac3867a7cef2d53d26464ea7df3  opus-1.6.tar.gz
"
