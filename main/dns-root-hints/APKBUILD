# Contributor: Leonardo Arena <rnalrd@alpinelinux.org>
# Contributor: tcely <dns-root-hints+aports@tcely.33mail.com>
# Maintainer: tcely <dns-root-hints+aports@tcely.33mail.com>
pkgname="dns-root-hints"
pkgver="2019073000"
pkgrel=0
pkgdesc="The DNS root hint(s)"
url="https://www.internic.net/domain"
arch="noarch"
license="Public-Domain"
makedepends="curl gnupg"
options="net"
source="
	${pkgname}-${pkgver}.tar.gz::https://github.com/tcely/internic-domain-data/archive/${pkgver}.tar.gz
	verisign-grs-nstld-key.asc
	"
builddir="${srcdir}/internic-domain-data-${pkgver}"

_append_builddir() {
	local arg
	arg="/${1:-build}"

	builddir="${builddir%${arg}}${arg}"

	shift
	if [ "${#}" -gt 0 ]; then
		"${@}" "${builddir}"
	fi
}

prepare() {
	default_prepare

	_append_builddir build mkdir -v
}

_check_sig() {
	local _oldgnupghome rc
	_oldgnupghome="${GNUPGHOME}"
	rc=0

	GNUPGHOME="${srcdir}/.gpg"
	export GNUPGHOME

	install -d -m 0700 "${GNUPGHOME}" || :
	gpg --import "${srcdir}/verisign-grs-nstld-key.asc" || :
	gpg --verify "${_tmp}/named.root.sig" "${_tmp}/named.root" || rc="${?}"

	rm -rf "${GNUPGHOME}"
	GNUPGHOME="${_oldgnupghome}"

	return "${rc}"
}

_copy_from_source_archive() {
	cp -p "${builddir}"/../domain/named.root* .
}

_fetch_from_url() {
	curl -sSRL -z ./named.root -O "${url}/named.root{.sig,}"
}

_gather_named_root_files() {
	local _tmp rc
	_tmp="$(mktemp -d -p .)"
	rc=0

	cd "${_tmp}"
	_copy_from_source_archive
	options_has net && _fetch_from_url
	cd - >/dev/null

	_check_sig && mv -v \
		"${_tmp}/named.root.sig" \
		"${_tmp}/named.root" \
		"${builddir}/" || rc="${?}"

	rm -rvf "${_tmp}"

	return "${rc}"
}

build() {
	cd "${builddir}"
	_append_builddir build cd

	_gather_named_root_files

	sed -e 's/[[:space:]]\+$//' named.root > root-ns.hints
}

check() {
	cd "${builddir}"
	_append_builddir build cd

	local _awkprog
	_awkprog='
		/related version of root zone:/ {
			rootver=$NF;
			if (pkgver != rootver) {
				$1="ERROR:";
				print;
				exit 1;
			};
			printf "OK: %s\n", rootver;
			quit;
		}'
	awk -v pkgver="${pkgver}" "${_awkprog}" named.root
	cmp -s ../domain/named.root.sig named.root.sig
}

package() {
	cd "${builddir}"
	_append_builddir build cd

	install -D -m 644 -o root -g root named.root \
		"${pkgdir}/usr/share/${pkgname}/named.root"
	install -D -m 644 -o root -g root named.root.sig \
		"${pkgdir}/usr/share/${pkgname}/named.root.sig"
	install -D -m 644 -o root -g root "${srcdir}/verisign-grs-nstld-key.asc" \
		"${pkgdir}/usr/share/${pkgname}/verisign-grs-nstld-key.asc"

	# install our cleaned up hints file
	install -D -m 644 -o root -g root root-ns.hints \
		"${pkgdir}/usr/share/${pkgname}/root-ns.hints"

	# compatibility links
	cd "${pkgdir}/usr/share/${pkgname}"
	ln -s named.root named.cache
	ln -s named.root db.cache
}

sha512sums="05a6df33243ff3947a95fbae01b41d4a06944f3e86450fcf4150c35815a7bffc89e87e84fe223bb08685d91d52e86bb782d79eeea55b3b9cd5bbe8dcbb1c49bb  dns-root-hints-2019073000.tar.gz
3ecf5d66e506526ad98ea0b371202f0763b987322bd4407b40fcd95415202bddb18fd06c82eb397566b393e214dc88cb17ec94f3908328e8a55f5f68cc730993  verisign-grs-nstld-key.asc"
