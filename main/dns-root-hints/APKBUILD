# Contributor: Leonardo Arena <rnalrd@alpinelinux.org>
# Contributor: tcely <dnshints-root+aports@tcely.33mail.com>
# Maintainer: tcely <dnshints-root+aports@tcely.33mail.com>
pkgname=dns-root-hints
pkgver=2019031302
pkgrel=1
pkgdesc="The DNS root hint(s)"
url="https://www.internic.net/domain"
arch="noarch"
license="Public-Domain"
makedepends="curl gnupg"
options="net"
source="verisign-grs-nstld-key.asc named.root named.root.sig"
builddir="$srcdir/$pkgname-$pkgver"

_check_sig() {
	local GNUPGHOME="$builddir/.gpg"
	install -d -m 0700 "$GNUPGHOME"
	gpg --import < "$srcdir"/verisign-grs-nstld-key.asc
	gpg --verify "${_tmp}"/named.root.sig "${_tmp}"/named.root
	rm -rf "$GNUPGHOME"
	mv "${_tmp}"/named.root.sig "${_tmp}"/named.root "$builddir"/
}

_fetch_new_version() {
	local _tmp="$(mktemp -d -p .)"
	cd "${_tmp}"
	curl -sSRLO "$url/named.root{.sig,}"
	cd -
	_check_sig
	rm -rf "${_tmp}"
}

build() {
	mkdir -p "$builddir"
	cd "$builddir"

	_fetch_new_version

	sed -e 's/[[:space:]]\+$//' named.root > root-ns.hints
}

check() {
	local _awkprog='
		/related version of root zone:/ {
			rootver=$NF;
			if (pkgver != rootver) {
				$1="ERROR:";
				print;
				exit 1;
			};
			printf "OK: %s\n", rootver;
			quit;
		}'
	awk -v pkgver="$pkgver" "$_awkprog" named.root
}

package() {
	install -D -m 644 -o root -g root named.root \
		"$pkgdir"/usr/share/$pkgname/named.root
	install -D -m 644 -o root -g root named.root.sig \
		"$pkgdir"/usr/share/$pkgname/named.root.sig
	install -D -m 644 -o root -g root "$srcdir"/verisign-grs-nstld-key.asc \
		"$pkgdir"/usr/share/$pkgname/verisign-grs-nstld-key.asc

	# install our cleaned up hints file
	install -D -m 644 -o root -g root root-ns.hints \
		"$pkgdir"/usr/share/$pkgname/root-ns.hints

	# compatibility links
	cd "$pkgdir/usr/share/$pkgname"
	ln -s named.root named.cache
	ln -s named.root db.cache
}

# check new versions of root hints and commit
snapshot() {
	cd "$builddir"

	local _drh_current_ver="$(awk '/related version of root zone:/ { print $NF; quit; }' "$srcdir"/named.root)"

	_fetch_new_version

	local _drh_new_ver="$(awk '/related version of root zone:/ { print $NF; quit; }' named.root)"

	# commit if new version is found
	if [ "$_drh_new_ver" != "$_drh_current_ver" ]; then
		git add named.root named.root.sig
		abump $pkgname-$_drh_new_ver
	fi
}

sha512sums="3ecf5d66e506526ad98ea0b371202f0763b987322bd4407b40fcd95415202bddb18fd06c82eb397566b393e214dc88cb17ec94f3908328e8a55f5f68cc730993  verisign-grs-nstld-key.asc
ad14d7b6c6c52ebdd6c21448aa79d0560701df3b92576fab7ed1611314a5279e317dcfbcb05f2f2cb9d9b0a8932f56e6a03c7a52709fc75929d568267aa64f8b  named.root
774ac61ee930611a1876447c981e20f0340ad25c49703b2d068164a681c3d5bac8f5c8f6fc0a4ba98e04d9aa4b922d4ea8936029cf2336b94e7cd6588ee6ba69  named.root.sig"
