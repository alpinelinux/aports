# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=vsftpd
pkgver=3.0.2
pkgrel=6
pkgdesc="Very secure ftpd"
url="http://vsftpd.beasts.org"
arch="x86_64"
license="GPL2"
depends=""
makedepends="openssl-dev libcap-dev linux-pam-dev"
subpackages="$pkgname-doc"
install="$pkgname.pre-install"
source="https://security.appspot.com/downloads/vsftpd-${pkgver}.tar.gz
	vsftpd-enable-ssl.patch
	vsftpd-gnu-source.patch
	vsftpd.initd
	vsftpd.confd
	wtmpx_file.patch"

_builddir="$srcdir/$pkgname-$pkgver"
prepare() {
	cd $_builddir
	#Enable SSL support
	patch -p0 -i "$srcdir"/vsftpd-enable-ssl.patch || return 1
	#build fix for x86_64
	patch -p1 -i "$srcdir"/vsftpd-gnu-source.patch || return 1
	#musl
	patch -p1 -i "$srcdir"/wtmpx_file.patch || return 1
	# we dont have libnsl
	sed -i -e '/-lnsl/d' vsf_findlibs.sh || return 1
	# Let abuild control stripping
	sed -i '/^LINK[[:space:]]*=[[:space:]]*/ s/-Wl,-s//' Makefile
}

build() {
	cd $_builddir
	make || return 1
}

package() {
	cd "$srcdir/$pkgname-$pkgver"
	install -m755 -D vsftpd "$pkgdir"/usr/sbin/vsftpd
	install -m644 -D vsftpd.8 "$pkgdir"/usr/share/man/man8/vsftpd.8
	install -m644 -D vsftpd.conf.5 "$pkgdir"/usr/share/man/man5/vsftpd.conf.5
	install -m644 -D vsftpd.conf "$pkgdir"/etc/vsftpd/vsftpd.conf
	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
	mkdir -p "$pkgdir"/usr/share/empty
}

md5sums="8b00c749719089401315bd3c44dddbb2  vsftpd-3.0.2.tar.gz
f3cbaf364cd3c46a2a03b00de9d7e184  vsftpd-enable-ssl.patch
f2245efcc271356743805f38d6c5aea3  vsftpd-gnu-source.patch
b48784af42b0f787e55276fc20476aa2  vsftpd.initd
9e495776096c78c3f9d9e6756a8c3003  vsftpd.confd
a8ca7b0680a76bbb79b0fd978a6b5d0f  wtmpx_file.patch"
sha256sums="be46f0e2c5528fe021fafc8dab1ecfea0c1f183063a06977f8537fcd0b195e56  vsftpd-3.0.2.tar.gz
79fa4d1a78d5ec408f02b331c5ecb8dc25f94606f5a9c902624c545154323607  vsftpd-enable-ssl.patch
9ac07b8bf589a5632403c99c95aa2dd01c9c068c36e303868d08f459b17e0c9b  vsftpd-gnu-source.patch
78d79b46017accf34d64f02e22d2f1d7bd58c78d8bc5cb6f692c139d285a562a  vsftpd.initd
5ed45cbe507676fd1252427016047e02b775acfb3dd0f3e44fe61410a8e7a1ba  vsftpd.confd
5ea711e43ae4dff6ca110432dec27af9cbea4b697920ba5ea0a254b2642e3e41  wtmpx_file.patch"
sha512sums="d5b978e07d8b0a623b79a531824666fb9b970ad5989a8c34c21b545b62ba07cde4bfe3d77b40a8b6e92d17890c37cae209231af8f106da3404f6548e217bd023  vsftpd-3.0.2.tar.gz
7968c77d6eb03caa2b085bd09008c2953ec80e2b8ea836a39103bb7c2e54fba1a241607a118ea8a55d718a9efe46c1f017bcc22fce20ebd8f7e9a71e79b583e9  vsftpd-enable-ssl.patch
4fbf8bb953dec220ea5dc2f2ecd1f275dae27b24a06b17f437eea493cd94e05e95fd78910a81e7ebf27b84e60251c4db6780d4741da62ecc056a2f78a5a3c3a6  vsftpd-gnu-source.patch
23c9b66f2463b16d54f9ec5f03134f893692700f269dc9baa57f4659599b2afe04c5b0f302a610deee763656447b50a4ef082fc8551241c399122fc4c1a9431e  vsftpd.initd
7bd138cf66356db55d00796f99b327e9aedf45a48b6fc9b464801fd17a69949ca1296131513c289b0293d27b29c1add08e601068501591108ed7fb13efeeacf3  vsftpd.confd
bb1bcb97df769d658e3d99a1ed1b585250a84ecfb7371adc17dff85732eee0bdc53442725c91e7563dda250d3c0b1cea1f3a5e805f3abc36aa7d27a7ba237742  wtmpx_file.patch"
