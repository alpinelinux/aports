# Contributor: V.Krishn <vkrishn4@gmail.com>
# Contributor: Eivind Uggedal <eu@eju.no>
# Contributor: TBK <alpine@jjtc.eu>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=valkey
pkgver=9.0.0
pkgrel=1
pkgdesc="Open source high-performance key/value datastore (fork of Redis)"
url="https://valkey.io/"
arch="all"
license="BSD-3-Clause AND BSD-2-Clause AND MIT"
pkgusers="valkey"
pkggroups="valkey"
# Bundled libraries (from deps/README.md):
#
# Name           | Version | Customized | License
# ---------------|---------|------------|-------------
# jemalloc       | 5.3.0   | yes        | BSD-2-Clause
# libvalkey      | 0.2.1   | no         | BSD-3-Clause
# linenoise      | 1.0     | no         | BSD-2-Clause
# lua            | 5.1     | yes        | MIT
# hdrhistogram-c | 0.11.9  | yes        | BSD-2-Clause
# fast_float     | ?       | ?          | (MIT OR Apache-2.0 OR BSL-1.0)
makedepends="linux-headers openssl-dev"
checkdepends="tcl procps"
install="
	$pkgname.pre-install
	$pkgname.post-install
	$pkgname-compat.pre-install
	"
subpackages="
	$pkgname-tls
	$pkgname-benchmark
	$pkgname-cli
	$pkgname-compat::noarch
	$pkgname-openrc
	"
source="https://github.com/valkey-io/valkey/archive/$pkgver/valkey-$pkgver.tar.gz
	valkey-loadmod.patch
	valkey.conf.patch
	sentinel.conf.patch
	$pkgname.initd
	$pkgname.confd
	$pkgname-sentinel.initd
	$pkgname-sentinel.confd
	"

# secfixes:
#   8.1.4-r0:
#     - CVE-2025-49844
#     - CVE-2025-46817
#     - CVE-2025-46818
#     - CVE-2025-46819
#   8.1.1-r2:
#     - CVE-2025-32023
#     - CVE-2025-48367
#   8.1.1-r1:
#     - CVE-2025-27151
#   7.2.9-r0:
#     - CVE-2025-21605
#   7.2.8-r0:
#     - CVE-2024-46981
#     - CVE-2024-51741
#   7.2.7-r0:
#     - CVE-2024-31227
#     - CVE-2024-31228
#     - CVE-2024-31449

export CFLAGS="$CFLAGS -DUSE_MALLOC_USABLE_SIZE -O2 -flto=auto"
_make_flags="
	DEBUG=
	OPTIMIZATION=
	V=echo
	USE_JEMALLOC=no
	MALLOC=libc
	BUILD_TLS=module
	PREFIX=/usr
	"
_modules_dir="usr/lib/$pkgname/modules"
_modules_cfgdir="etc/$pkgname/modules"

build() {
	make all $_make_flags
}

check() {
	case "$CARCH" in
		# memory overhead tracking test fails on 32-bit architectures
		armv7|armhf|x86) rm tests/unit/tracking.tcl ;;
	esac

	make test $_make_flags
}

package() {
	make install $_make_flags INSTALL_BIN="$pkgdir/usr/bin"

	install -D -m755 src/valkey-tls.so "$pkgdir/$_modules_dir/tls.so"

	cd "$pkgdir"

	# NOTE: /etc/valkey and /etc/valkey/sentinel.conf must be writable for valkey,
	# otherwise Sentinel fails to start.
	install -d -m 750 -o valkey -g valkey \
		etc/valkey \
		etc/valkey/valkey.d \
		"$_modules_cfgdir" \
		var/lib/valkey \
		var/lib/valkey/sentinel

	install -D -m 640 -o root -g valkey "$builddir"/valkey.conf etc/valkey/valkey.conf
	install -D -m 640 -o valkey -g valkey "$builddir"/sentinel.conf etc/valkey/sentinel.conf

	echo "loadmodule /$_modules_dir/tls.so" > "$_modules_cfgdir"/tls.conf

	install -D -m 755 "$srcdir"/valkey.initd etc/init.d/valkey
	install -D -m 755 "$srcdir"/valkey-sentinel.initd etc/init.d/valkey-sentinel
	install -D -m 644 "$srcdir"/valkey.confd etc/conf.d/valkey
	install -D -m 644 "$srcdir"/valkey-sentinel.confd etc/conf.d/valkey-sentinel

	install -d -m 750 -o valkey -g valkey \
		var/lib/valkey \
		var/lib/valkey/sentinel
}

benchmark() {
	pkgdesc="Valkey benchmarking tool"

	amove usr/bin/valkey-benchmark
}

cli() {
	pkgdesc="Valkey CLI client"

	amove usr/bin/valkey-cli
}

tls() {
	pkgdesc="TLS module for Valkey"
	depends="$pkgname=$pkgver-r$pkgrel"

	amove "$_modules_dir"/tls.so
	amove "$_modules_cfgdir"/tls.conf
}

compat() {
	pkgdesc="Valkey command symlinks and system group for compatibility with redis"
	depends="!redis !redict-compat"

	amove usr/bin/redis-*
	rm "$subpkgdir"/usr/bin/redis-benchmark
}

sha512sums="
387e8ebf26a307940bf0f26eb4ba51f016445a618435f4c61ec4c8b8d4b7e2cbfc7a7e93b6c35b7c6832e3161981b4b2ce0d09bdc1799dbb5271052cf70654e4  valkey-9.0.0.tar.gz
1438969f9b06b367544a1b486a020d1d84737e9272981c69f0cf10b23e12bed08a1c02531477cdc02e9c60c84267559df40ba9957c032caba3d0ae360a8be8d9  valkey-loadmod.patch
c2826266996c8443246da02d4879bfbd74db0a12c1866a9fe2a1020501328b49a6c3485d8a2ceaac99d3a4dd8081126cc2bb1ceaca16e44ba1edd3609dcae6d4  valkey.conf.patch
d0311d2bfade7efbfa2bdcc6c74e8e8a151c09c627e30f5cea1826155dcb4f7ca4c1d35aba26bccec933575fadcbe5785e16b4801058fec73c7de5537ffeb09a  sentinel.conf.patch
605c1f39cf5f206e03d19af54412a66732ad3c65d5cb36e5d6cfb9d28779807d2da9c29d01f07e0ba2956446cb6935b66c92844a74b255b6070870b30d7d45d8  valkey.initd
639a007f7e98cf7614d2afb6e109042883030e0bdf4eaf1dc3df3ecab8043d6be30647e1e46295f783efc7baf42dc420b2e5dcf388913efdc5bdf2cd1e418f9f  valkey.confd
dd407cb4047524114b4814a28993978acbe300989acc466ec3809171bf19a1e0562756f7b5954981a087a37437c2c281e4a3667d361cfa8873d1c20d1b900632  valkey-sentinel.initd
926316561f0802b577caee03e7bccc5538dc8270095df95853549fdd519fac8d0e89bc3e563cdba2d7ec0dfe10db5e50b95859549597beec894c820abfdbecee  valkey-sentinel.confd
"
