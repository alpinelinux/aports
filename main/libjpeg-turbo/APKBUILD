# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=libjpeg-turbo
pkgver=1.5.3
pkgrel=3
# This should be the latest commit on the 1.5.x branch
# See: https://github.com/libjpeg-turbo/libjpeg-turbo/issues/285#issuecomment-423206397
_commit=3f7ffa1749ad9e5e0c29faf09106609903a63865
pkgdesc="accelerated baseline JPEG compression and decompression library"
url="https://libjpeg-turbo.org/"
arch="all"
license="GPL"
depends=""
makedepends="nasm autoconf automake libtool"
replaces="libjpeg"
subpackages="$pkgname-doc $pkgname-dev $pkgname-utils"
source="$pkgname-$pkgver-$_commit.tar.gz::https://github.com/libjpeg-turbo/libjpeg-turbo/archive/${_commit}.tar.gz"
builddir="$srcdir"/libjpeg-turbo-$_commit

# secfixes:
#   1.5.3-r3:
#   - CVE-2018-11813
#   1.5.3-r2:
#   - CVE-2018-1152

prepare() {
	default_prepare
	cd "$builddir"
	autoreconf -fiv
}

build() {
	cd "$builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var \
		--with-jpeg8
	make
}

check() {
	cd "$builddir"
	make test
}

package() {
	cd "$builddir"
	make -j1 DESTDIR="$pkgdir" docdir=/usr/share/doc/$pkgname \
		install
}

utils() {
	pkgdesc="Utilities for manipulating JPEG images"
	replaces="jpeg"
	mkdir -p "$subpkgdir"/usr
	mv "$pkgdir"/usr/bin "$subpkgdir"/usr/
}

doc() {
	default_doc
	replaces="jpeg-doc"
}

dev() {
	default_dev
	replaces="jpeg-dev"
}

sha512sums="9d4dca769c5fd203193cb28ac7acc36aefa939dac26cdce65c136b68b03ad76a0a4d5ac480745fd89b5e7bfdebe232a552de636059374eb2109337fcb6ed0456  libjpeg-turbo-1.5.3-3f7ffa1749ad9e5e0c29faf09106609903a63865.tar.gz"
