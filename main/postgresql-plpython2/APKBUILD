# Maintainer: G.J.R. Timmer <gjr.timmer@gmail.com>
pkgname=postgresql-plpython2
pkgver=9.6.1
pkgrel=1
pkgdesc="PL/Python2 language extension for PostgreSQL"
url="http://www.postgresql.org/"
arch="all"
license="BSD"
depends="postgresql"
install=""
pkgusers="postgres"
pkggroups="postgres"
depends_dev="libressl-dev"
makedepends="$depends_dev libedit-dev zlib-dev libxml2-dev util-linux-dev
	openldap-dev python2-dev"
subpackages="$pkgname-dev $pkgname-contrib"
patches=""
source="ftp://ftp.postgresql.org/pub/source/v$pkgver/postgresql-$pkgver.tar.bz2"
builddir="$srcdir/postgresql-$pkgver"

prepare() {
	default_prepare || return 1
	cd "$builddir"

	# sanity check of conf.d
	(
		. "$srcdir"/postgresql.confd
		_datadir=/var/lib/postgresql/${pkgver%.*}/data
		if [ "$_datadir" != "$PGDATA" ]; then
			die "PGDATA is $PGDATA while $_datadir is expected"
		fi
	) || return 1
}

build() {
	cd "$builddir"

	# Compile PostgreSQL with Python2 support
	PYTHON=/usr/bin/python2 ./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--mandir=/usr/share/man \
		--with-ldap \
		--with-libedit-preferred \
		--with-libxml \
		--with-openssl \
		--with-uuid=e2fs \
		--disable-rpath \
		--with-python \
		|| return 1

	make world || return 1
}

package() {
	cd "$builddir/src/pl/plpython"
	
	make DESTDIR="$pkgdir" install || return 1
}

dev() {
	default_dev || return 1
}

contrib() {
	depends=""
	pkgdesc="PL/Python extension modules distributed with PostgreSQL"

	cd "$builddir"
	make DESTDIR="$subpkgdir" -C contrib/hstore_plpython install || return 1
	make DESTDIR="$subpkgdir" -C contrib/ltree_plpython install || return 1
}

md5sums="92ae6d7cdf18e648b3c22d0aa015565d  postgresql-9.6.1.tar.bz2"
sha256sums="e5101e0a49141fc12a7018c6dad594694d3a3325f5ab71e93e0e51bd94e51fcd  postgresql-9.6.1.tar.bz2"
sha512sums="f27af67f9a96f6327150330bf091a803e10eabbac4e488cf5e4d72907e2eb1dbde7282fe0b89fd75711fd8bdcdb3688b5a9eac1e4d6871f4e8681c9c8b0e7c45  postgresql-9.6.1.tar.bz2"
