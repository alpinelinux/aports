# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=dash
pkgver=0.5.13.1
pkgrel=1
pkgdesc="Small and fast POSIX-compliant shell"
url="http://gondor.apana.org.au/~herbert/dash/"
arch="all"
license="BSD-3-Clause AND GPL-2.0-or-later"
# Ensure add-shell is available in post-install on rootfs creation
depends="busybox"
# needs 'nl' utility from coreutils
makedepends="coreutils"
install="$pkgname.post-install $pkgname.post-upgrade $pkgname.pre-deinstall"
subpackages="$pkgname-dbg $pkgname-doc $pkgname-binsh::noarch"
source="http://gondor.apana.org.au/~herbert/dash/files/dash-$pkgver.tar.gz
	shell-Fix-unsigned-char-promotion-and-truncation.patch
	expand-fix-armv7-SIGBUS.patch
	"

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var
	make
}

check() {
	./src/dash -c 'echo ok'
}

package() {
	make DESTDIR="$pkgdir" install
}

binsh() {
	pkgdesc="dash as /bin/sh"
	provides="/bin/sh"
	provider_priority=60  # lower (other provider is busybox-binsh, yash-binsh)
	# Scripts assume busybox tools are available when depending on /bin/sh
	depends="busybox"

	mkdir -p "$subpkgdir"/bin
	ln -s /usr/bin/dash "$subpkgdir"/bin/sh
}

sha512sums="
6b3d67f76e74853349fe99121b2ee96d32da9863042744e03984eb6a01bf437eee2f2e81fbdd0436090abfecacc2f5589960820c3d0d5f3dd580948d38d5dc1d  dash-0.5.13.1.tar.gz
5ce11f8891730d5021cc8325cba3307e3f3a152234326376bc7bbb97757bb9e8806d3fdf63280768f9c27533672e72e680ac1a8efccc06b7b4a9478afc3d8c3b  shell-Fix-unsigned-char-promotion-and-truncation.patch
e5c47d6f464f8959a7b6e9e54a0f50bf12511691dc5bc528c980c4f680d245d8fc5cab83503febee6763984c45f22e3dbb6deb568c5ee5f28efd8faa68ff1259  expand-fix-armv7-SIGBUS.patch
"
