# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=quickjs-ng
pkgver=0.11.0
pkgrel=0
pkgdesc="Embeddable JavaScript engine in C (NG fork)"
url="https://quickjs-ng.github.io/quickjs/"
arch="all"
license="MIT"
makedepends="muon"
subpackages="
	$pkgname-doc
	$pkgname-libs
	$pkgname-libs-static
	$pkgname-dev
	"
_test262=a5e69a1534de88d1eb29b76657d84c8541b72df7
source="https://github.com/quickjs-ng/quickjs/archive/refs/tags/v$pkgver/quickjs-ng-$pkgver.tar.gz
	https://github.com/tc39/test262/archive/$_test262/test262-$_test262.tar.gz
	fix-tests.patch
	"
builddir="$srcdir/quickjs-$pkgver"

prepare() {
	default_prepare

	rmdir -v test262
	mv -v "$srcdir"/test262-$_test262 test262
}

build() {
	abuild-muon \
		-Ddefault_library=both \
		-Dtests="$(want_check && echo enabled || echo disabled)" \
		output .
	ninja -C output
}

check() {
	# Allow fail: tests pass in loongarch64 CI, but fail on the builder
	muon -C output test -j "${JOBS:-0}" -R -d dots \
		|| [ "$CARCH" = "loongarch64" ]

	case "$CARCH" in
	*64*)
		local i; for i in $(seq 0 3); do
			[ $i -eq 0 ] || msg "Retrying ($i/3)..."
			./output/run-test262 -c test262.conf && return 0
			sleep 1
		done
		return 1
		;;
	esac
}

package() {
	DESTDIR="$pkgdir" muon -C output install

	cd "$pkgdir"
	mkdir -p usr/share/licenses/$pkgname/
	mv -v usr/share/doc/$pkgname/LICENSE usr/share/licenses/$pkgname/
}

sha512sums="
c8b1920bab954f5fa891956f330875478e5b17161d24f8b96db05108d61354dab0621f2a36c5ae421ffbfb9817d90c7a62fe1bd4f84ad149dd2d569c356a2788  quickjs-ng-0.11.0.tar.gz
4f9ff18a77576f1750cfe0be07ed74ad09873fbb60c061dc0c711f6bb385b66130892ce7cb5a4dd066974e21b4117a8a60ba9a27a80b1498563c27a26f96c999  test262-a5e69a1534de88d1eb29b76657d84c8541b72df7.tar.gz
9c98df4edc975bdd207aeca60505fdaf6bc8824471a287da3e4891e9e29b7caf89546135209779b98572a7754be2803562ef297522ec4fa8f7985f6d33d39b37  fix-tests.patch
"
