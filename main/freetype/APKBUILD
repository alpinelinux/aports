# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer: Carlo Landmeter <clandmeter@gmail.com>
pkgname=freetype
pkgver=2.5.5
pkgrel=1
pkgdesc="TrueType font rendering library"
url="http://freetype.sourceforge.net"
arch="all"
license="GPL"
depends=
depends_dev="zlib-dev libpng-dev"
makedepends="$depends_dev"
subpackages="$pkgname-dev"
source="http://downloads.sourceforge.net/$pkgname/$pkgname-$pkgver.tar.gz
	20-enable-spr.patch
	30-enable-valid.patch
	40-memcpy-fix.patch
	CVE-2016-10244.patch
	CVE-2017-8105.patch
	CVE-2017-8287.patch
	"

# secfixes:
#   2.5.5-r1:
#     - CVE-2016-10244
#     - CVE-2017-8105
#     - CVE-2017-8287

_builddir="$srcdir/$pkgname-$pkgver"

prepare() {
	cd "$_builddir"
        for i in "$srcdir"/*.patch; do
                msg "Applying ${i}"
                patch -p0 -i $i || return 1
        done
}

build() {
	cd "$_builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--disable-static \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make -j1 DESTDIR="$pkgdir" install || return 1
	rm "$pkgdir"/usr/lib/*.la || return 1

	# for compat. This should be removed once all apps are properly using
	# pkg-config
	ln -s freetype2 "$pkgdir"/usr/include/freetype
}

md5sums="7448edfbd40c7aa5088684b0a3edb2b8  freetype-2.5.5.tar.gz
605e03a5d95b858f566cadca1dbd316b  20-enable-spr.patch
3f6c5739843dcbc110ee0f243c4f6bdb  30-enable-valid.patch
bd2d808a0c00dcf9f1d1c0a9a8227ad9  40-memcpy-fix.patch
0bb752550d20a3bee72f737ad479991a  CVE-2016-10244.patch
478ff673ef99f69bcc4fa0957b606cf3  CVE-2017-8105.patch
a45568a4c33ed3768e73ab7951ef2bf8  CVE-2017-8287.patch"
sha256sums="5d03dd76c2171a7601e9ce10551d52d4471cf92cd205948e60289251daddffa8  freetype-2.5.5.tar.gz
9ec2c8c126fa9bda4eaec779ae6234f094f8a8d85d20f947e910716df9d703ca  20-enable-spr.patch
5f1b3b767dc1fdb1fcd3963399ac3c2263d07fe3f1f14f677d08cd0d2161ae5c  30-enable-valid.patch
574c265c7a7032c5afb32a9807e5d04354ad0def656194cfcfff1ccca6a5540e  40-memcpy-fix.patch
9ad660d70077c167a41da007056eada3fd9dab3ba802e14d5b46426e5ded6692  CVE-2016-10244.patch
173689b597571f05a1187bc92a400d6bc838a693301011544be982952dc80904  CVE-2017-8105.patch
235c3946ad3bbd11685cb6511be46e84adeaf52c23511863e9aa715a5369a8a2  CVE-2017-8287.patch"
sha512sums="1c8812252d748c6ccc5f6002b57c8a7cb0f08fe15e3c700ac8b2714c7648d756cd4af4207a765cf0d320509be6d09c74239d69e9ca6a05bb15ca6a475cf96ce3  freetype-2.5.5.tar.gz
bd30f76003ae4e7fd324fdbdbc70f930bda418ae819e7c611c90cb2d8299dca5995edb543c7991121c3990fab6ffff03a183a08c1975d083009f7272586fc266  20-enable-spr.patch
fdfa3c633a32bd9142f62454e12dd92442e8e02831fd34aca348aec6d00e7813130fbf267a7f4048a272596a478cfe3064df0ee9f9c06531378710f41bc2e40f  30-enable-valid.patch
1553f7f0514238012e300bc8d0b1e260145db17fb56f13e4aa667435e98c3749c00e150caa0e318289b84bca33b9a06a68b8342575e10ac3bf5af3d5cc861537  40-memcpy-fix.patch
64f7ca7b84d8ddf881beed097911f52f704539f872c67c2490d42ab44c879d973a8d7bd290fe841248998d2fade5ab4a71a725148f91deb624135552437a1162  CVE-2016-10244.patch
8992af56a71329f67f0bd445ef2b1d5e10f2ac5281c449ccbf0dbc826027ba8c828c05dbe5aee2e5a7d6b8cd8443192268a4177759c9158c0008d546c6dd9093  CVE-2017-8105.patch
703e345868d0a391645227918fa49ba1e2e1f0009c5f80e8177b9c0468b8c9ae8d47da1bb65a103133e221946556aa49fa24ea0cb1cc270331f7c4954c8b95bd  CVE-2017-8287.patch"
