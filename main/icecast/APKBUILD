# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>

pkgname=icecast
pkgver=2.5.0
pkgrel=0
pkgdesc="Open source media server"
url="https://icecast.org/"
arch="all"
license="GPL-2.0-only"
install="$pkgname.pre-install"
pkgusers="icecast"
pkggroups="icecast"
makedepends="libxslt-dev libxml2-dev libogg-dev libvorbis-dev libtheora-dev
openssl-dev curl-dev libigloo-dev rhash-dev"
subpackages="$pkgname-doc $pkgname-openrc"
source="https://downloads.xiph.org/releases/icecast/icecast-$pkgver.tar.gz
conf-change-owner.patch
disable-failing-test.patch
icecast.initd"

# secfixes:
#   2.4.4-r0:
#     - CVE-2018-18820

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--localstatedir=/var \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--with-curl
	make
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install
	install -Dm755 "$srcdir"/icecast.initd "$pkgdir"/etc/init.d/icecast
}

sha512sums="
d92ce5d8ae1cd011eaa8c7424adea744f35e5c2d3e8244d362743be1c6bbc8fc44d76d7a212cf1eebe79da9b7d83b2ed5ab8659fb97929af316674b5ddf590b5  icecast-2.5.0.tar.gz
e4b0fd37900f9910a133e98547c364ec11068a35a6222fdd951d59e2e874829c7d9328d0695898456ec27e6c9f308b2ad5859e850bd5226e4ff4c4d8ac5b0d8c  conf-change-owner.patch
1465791ce1032982bb78ea8e2b856647041ff12ffa2beffe0c9c1981511fd4ad4e4e8cf47ac1f3d93f703864c493b628225fe47b8d95b3150ede1eb238ac7c92  disable-failing-test.patch
56b71344cf72e15df2e24fda1c745365a67ebc2f3d167c75ca7ac00e40fc81bc8fb0b787d0feafee130718ce09013a11a150ce0efd359cf8b8ec0b003d17e7b4  icecast.initd
"
