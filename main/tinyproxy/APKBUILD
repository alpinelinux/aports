# Contributor: Michael Mason <ms13sp@gmail.com>
# Maintainer: Michael Mason <ms13sp@gmail.com>
pkgname=tinyproxy
pkgver=1.10.0
pkgrel=1
pkgdesc="Lightweight HTTP proxy"
pkgusers="tinyproxy"
pkggroups="tinyproxy"
url="https://www.banu.com/tinyproxy/"
arch="all"
license="GPL-2.0-or-later"
depends=
makedepends="asciidoc"
install="tinyproxy.pre-install"
subpackages="$pkgname-doc"
source="https://github.com/$pkgname/$pkgname/releases/download/$pkgver/$pkgname-$pkgver.tar.gz
	tinyproxy.initd"

_builddir="$srcdir/$pkgname-$pkgver"
prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done

	# set default user to tinyproxy:tinyproxy and correct pidfile
	sed -i -e 's:^User.*:User tinyproxy:' \
		-e 's:^Group.*:Group tinyproxy:' \
		-e 's:^PidFile.*:PidFile "/var/run/tinyproxy/tinyproxy.pid":' \
		etc/tinyproxy.conf.in
}

build() {
	cd "$_builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--localstatedir=/var \
		--sysconfdir=/etc \
		--disable-dependency-tracking \
		--enable-reverse \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	install -d -D -o tinyproxy -g tinyproxy "$pkgdir"/var/run/tinyproxy
	install -d -D -o tinyproxy -g tinyproxy "$pkgdir"/var/log/tinyproxy
	install -Dm755 "$srcdir"/tinyproxy.initd "$pkgdir"/etc/init.d/tinyproxy
}

sha512sums="53187adef865672a6c29f126189cf896bd02f8b0789ee2ee00b82d93b952c70dacdd2c82b0845392e518560e75e6ee107ce7662d1ec71108f293ba1d7de6aa2a  tinyproxy-1.10.0.tar.gz
7ef08d290acec161d0c2257885c10bc5c827a72bcc67d842c4a0396d114d1f6acabd40643e051f4c233798b449046e8c8a449ebe404f9ac4c93238adbff7909b  tinyproxy.initd"
