# Contributor: ≈Åukasz Jendrysik <scadu@yandex.com>
# Contributor: William Pitcock <nenolod@dereferenced.org>
# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=lxc
pkgver=3.1.0
_pkgver=${pkgver/_rc/.rc}
pkgrel=3
pkgdesc="Userspace interface for the Linux kernel containment features"
url="https://linuxcontainers.org/lxc/"
arch="all"
license="GPL"
makedepends="
	libcap-dev
	libseccomp-dev
	linux-pam-dev
	linux-headers
	bsd-compat-headers
	docbook2x
	
	automake
	autoconf
	libtool
	"

options="suid"
subpackages="
	$pkgname-dev
	$pkgname-doc
	$pkgname-openrc
	$pkgname-lvm::noarch
	$pkgname-libs
	$pkgname-bridge::noarch
	$pkgname-bash-completion:bashcomp:noarch
	$pkgname-pam
	$pkgname-download:_download:noarch
	$pkgname-templates-oci:templates_oci:noarch
	$pkgname-templates::noarch
	"

source="
	https://linuxcontainers.org/downloads/lxc/lxc-$_pkgver.tar.gz

	lxc.initd
	lxc.confd
	6400238d08cdf1ca20d49bafb85f4e224348bf9d.patch
	d3a9befc86113228f77c89030336faa84a5557c0.patch
	0c816b346788afa9d601766e31544fdcce67d780.patch
	7a80606d7b3e31516d3cb223c899be25e67cbc0d.patch
	cee55b59cd0f7446bae25d02bcd23805ce43aaa4.patch
	c74da4abd20ede6a30c358dc275ba43b1d12e8d5.patch
	memory_utils_h.patch
	"
builddir="$srcdir/lxc-$_pkgver"

# secfixes:
#   3.1.0-r1:
#   - CVE-2019-5736
#   2.1.1-r9:
#   - CVE-2018-6556
#

_tmpldir="usr/share/lxc/templates"

build() {
	cd "$builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--disable-apparmor \
		--enable-pam \
		--with-distro=alpine \
		--disable-werror \
		--enable-doc
	make
}

check() {
	cd "$builddir"
	make check
}

package() {
	cd "$builddir"

	make DESTDIR="$pkgdir" install

	install -Dm755 "$srcdir"/lxc.initd "$pkgdir"/etc/init.d/lxc
	install -Dm644 "$srcdir"/lxc.confd "$pkgdir"/etc/conf.d/lxc
	install -d "$pkgdir"/var/lib/lxc

	# Remove useless config for SysVinit.
	rm -r "$pkgdir"/etc/default
}

lvm() {
	pkgdesc="LVM support for LXC"
	depends="$pkgname=$pkgver-r$pkgrel lvm2 util-linux"
	install_if="$pkgname=$pkgver-r$pkgrel lvm2"
	mkdir "$subpkgdir"
}

_py3() {
	pkgdesc="Python3 module for LXC"
	depends="python3"
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/python3.* "$subpkgdir"/usr/lib
}

_download() {
	pkgdesc="LXC container image downloader template"
	depends="$pkgname gnupg1 tar xz wget"

	mkdir -p "$subpkgdir"/$_tmpldir
	mv "$pkgdir"/$_tmpldir/lxc-download "$subpkgdir"/$_tmpldir/
}

templates() {
	pkgdesc="Templates for LXC (except alpine and download)"
	depends="tar"
	mkdir -p "$subpkgdir"/$_tmpldir
	mv "$pkgdir"/$_tmpldir/* "$subpkgdir"/$_tmpldir/
}

templates_oci() {
	pkgdesc="OCI Template for LXC"
	depends="bash jq"
	mkdir -p "$subpkgdir"/usr/share/lxc/templates
	mv "$pkgdir"/usr/share/lxc/templates/lxc-oci \
		"$subpkgdir"/usr/share/lxc/templates/
}

pam() {
	pkgdesc="PAM module for LXC"
	mkdir -p "$subpkgdir"/lib/security
	mv "$pkgdir"/lib/security/pam_cgfs.so "$subpkgdir"/lib/security/
}

dev() {
	default_dev
	# fix abuild smartness
	mv "$subpkgdir"/usr/bin/lxc-config "$pkgdir"/usr/bin/
	mv "$subpkgdir"/usr/bin/lxc-update-config "$pkgdir"/usr/bin/
}

bridge() {
	depends="dnsmasq"
	pkgdesc="Bridge interface for LXC with dhcp"
	mkdir -p "$subpkgdir"/etc/conf.d \
		"$subpkgdir"/etc/init.d \
		"$subpkgdir"/etc/lxc

	ln -s dnsmasq "$subpkgdir"/etc/init.d/dnsmasq.lxcbr0
	cat >>"$subpkgdir"/etc/conf.d/dnsmasq.lxcbr0 <<- EOF
		rc_before="lxc"
		BRIDGE_ADDR="10.0.3.1"
		BRIDGE_NETMASK="255.255.255.0"
		BRIDGE_NETWORK="10.0.3.0/24"
		BRIDGE_DHCP_RANGE="10.0.3.2,10.0.3.254"
		BRIDGE_DHCP_MAX="253"
		BRIDGE_MAC="00:16:3e:00:00:00"
		DNSMASQ_CONFFILE="/etc/lxc/dnsmasq.conf"
	EOF
	cat >>"$subpkgdir"/etc/lxc/dnsmasq.conf <<- EOF
		#dhcp-host=somehost,10.0.3.3
		#dhcp-host=otherhost,10.0.3.4
	EOF
}

bashcomp() {
	depends=""
	pkgdesc="Bash completions for $pkgname"
	install_if="$pkgname=$pkgver-r$pkgrel bash-completion"
	mkdir -p "$subpkgdir"/usr/share/bash-completion/completions
	mv "$pkgdir"/etc/bash_completion.d/$pkgname "$subpkgdir"/usr/share/bash-completion/completions
	rmdir "$pkgdir"/etc/bash_completion.d
}

sha512sums="706cee9bc8ac57300574b59d728437e41baa4eb16c68f8548142e53b4e13679ef6698df30a4fbf8617e4f07338f898464e9f818e80d32648fe9717370dcbbb20  lxc-3.1.0.tar.gz
b74ffe7c3e8f193265a90ffeb6e5743b1212bc1416b898e5a7e59ddd7f06fc77dc34e2dcbb3614038ac6222a95e2b9beb9f03ab734c991837203ab626b1b091f  lxc.initd
91de43db5369a9e10102933514d674e9c875218a1ff2910dd882e5b9c308f9e430deacb13d1d7e0b2ed1ef682d0bb035aa6f8a6738f54fa2ca3a05acce04e467  lxc.confd
c06f7390cc9814299bf94f2e5937b8adf1963b8c83a667d0ee189f2864cdab159ad053b3c5099c39643fb9664f2674060fa241760df017643f93353a52a65a86  6400238d08cdf1ca20d49bafb85f4e224348bf9d.patch
3acc12e24f110a5bfb6e8cc459ac2e2da2c74c5b57bbcf405e4cf1ca04260339705eff07e331b0137b699b98d7e5ad5c903ca09e700fedde3de8b7b0862a6d8e  d3a9befc86113228f77c89030336faa84a5557c0.patch
401c70ad55b846f68e9937a21fc0030aa0aa7efb09dc504712efd7697155f4858560cbd62faf1a0ec3e9dfd75933b568280ed46324dd8a4754a00bfd5df393fd  0c816b346788afa9d601766e31544fdcce67d780.patch
83ab8503380ed0bf931e465a48facffd3f112b8d60afc82d82207262a38807ea66d5f16ac6030cf22230bb92eb3577b0582802421393efe79a56dcf51adaabfb  7a80606d7b3e31516d3cb223c899be25e67cbc0d.patch
c102c4cadbd7146793a71840a1310ec7ede38517f29a5369e5fe0a6ac21b2a8801ea40cc0194ef782c5ed65438238bcc94ca116b435e65d78ce630cc61aba09f  cee55b59cd0f7446bae25d02bcd23805ce43aaa4.patch
c5b480cccea46633cd9d8e0e4207ed3835672cca44da4c8e4a34da21f1861c3798e382d47d70479c5669f98dbd3b1074339443a6db0e1422fdfeb079291f09b4  c74da4abd20ede6a30c358dc275ba43b1d12e8d5.patch
ac841dc6328f2345f4174f983fed9f1abb94fced1cf75259a122d5d56afb6ae4e1f57d6cf6612a6e7e4d97f7992abe20df8f0fae006275d6716920ae2e3eb89c  memory_utils_h.patch"
