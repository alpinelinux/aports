# Contributor: Francisco Guerreiro <francisg@fnop.net>
# Contributor: ≈Åukasz Jendrysik <scadu@yandex.com>
# Contributor: Cameron Banta <cbanta@gmail.com>
# Contributor: Ashley Sommer <ashleysommer@gmail.com>
# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=rsyslog
pkgver=8.2512.0
pkgrel=2
pkgdesc="Enhanced multi-threaded syslogd with database support and more"
url="https://www.rsyslog.com/"
arch="all"
license="Apache-2.0 AND GPL-3.0-or-later AND LGPL-3.0-or-later"
options="!check"
makedepends="
	autoconf
	automake
	bsd-compat-headers
	byacc
	curl-dev
	czmq-dev
	flex
	gnutls-dev
	hiredis-dev
	krb5-dev
	libcap-ng-dev
	libdbi-dev
	libestr-dev
	libfastjson-dev
	libgcrypt-dev
	liblogging-dev
	liblognorm-dev
	libmaxminddb-dev
	libnet-dev
	libpcap-dev
	libpq-dev
	librelp-dev
	libtool
	linux-headers
	mariadb-connector-c-dev
	net-snmp-dev
	openssl-dev
	py3-docutils
	rabbitmq-c-dev
	util-linux-dev
	zlib-dev
	"
install="$pkgname.post-upgrade"
subpackages="$pkgname-doc $pkgname-dbg $pkgname-openrc"
source="$pkgname-$pkgver.tar.gz::https://github.com/rsyslog/rsyslog/archive/v$pkgver.tar.gz
	tcpsrv-restore-default-stack-size.patch
	$pkgname.initd
	$pkgname.logrotate
	$pkgname.conf
	"

# <subpackage>[:<module>...]
_plugins="
	cisco:pmcisconames:pmciscoios
	clickhouse:omclickhouse
	crypto:lmcry_gcry
	dtls:imdtls:omdtls
	elasticsearch:omelasticsearch
	gnutls:lmnsd_gtls
	gssapi:lmgssutil:imgssapi:omgssapi
	hiredis:omhiredis
	http:omhttp:fmhttp
	imdocker
	impcap
	libdbi:omlibdbi
	mmaitag
	mmanon
	mmaudit
	mmcount
	mmdblookup
	mmfields
	mmjsonparse
	mmkubernetes
	mmnormalize
	mmpstrucdata
	mmrm1stspace
	mmsequence
	mmsnmptrapd
	mmtaghostname
	mmutf8fix
	mysql:ommysql
	openssl:lmnsd_ossl
	pgsql:ompgsql
	prog:improg:omprog
	pmaixforwardedfrom
	pmlastmsg
	pmnormalize
	pmsnare
	rabbitmq:omrabbitmq
	relp:imrelp:omrelp
	snmp:omsnmp
	testing:omtesting
	udpspoof:omudpspoof
	uxsock:omuxsock
	zmq:imczmq:omczmq
	zstd:lmzstdw
	"
for _i in $_plugins; do
	subpackages="$subpackages $pkgname-${_i%%:*}:_plugin"
done

# secfixes:
#   8.2204.1-r0:
#     - CVE-2022-24903
#   8.1908.0-r1:
#     - CVE-2019-17040
#     - CVE-2019-17041
#     - CVE-2019-17042

prepare() {
	default_prepare
	autoreconf -fi
}

build() {
	CFLAGS="$CFLAGS -flto=auto" \
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		\
		--disable-rfc3195 \
		--enable-largefile \
		--enable-libcap-ng \
		--enable-gssapi-krb5 \
		--enable-kmsg \
		--enable-mysql \
		--enable-pgsql \
		--enable-libdbi \
		--enable-snmp \
		--enable-elasticsearch \
		--enable-clickhouse \
		--enable-omhttp \
		--enable-openssl \
		--enable-gnutls \
		--enable-libzstd \
		--enable-mail \
		--disable-imdiag \
		--enable-mmnormalize \
		--enable-mmjsonparse \
		--enable-mmjsontransform \
		--enable-mmaudit \
		--enable-mmanon \
		--enable-mmrm1stspace \
		--enable-mmutf8fix \
		--enable-mmcount \
		--enable-mmsequence \
		--enable-mmdblookup \
		--enable-mmfields \
		--enable-mmpstrucdata \
		--enable-mmaitag \
		--enable-relp \
		--enable-imfile \
		--enable-imdocker \
		--enable-improg \
		--enable-imptcp \
		--enable-impstats \
		--enable-impcap \
		--enable-omprog \
		--enable-omudpspoof \
		--enable-omstdout \
		--enable-pmcisconames \
		--enable-pmciscoios \
		--enable-pmlastmsg \
		--enable-pmnormalize \
		--enable-pmaixforwardedfrom \
		--enable-pmsnare \
		--enable-omruleset \
		--enable-omuxsock \
		--enable-mmsnmptrapd \
		--enable-imdtls \
		--enable-omdtls \
		--enable-imczmq \
		--enable-omczmq \
		--enable-omrabbitmq \
		--enable-omhiredis \
		--enable-mmkubernetes \
		--enable-mmtaghostname
	make
}

package() {
	make DESTDIR="$pkgdir" install

	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.logrotate "$pkgdir"/etc/logrotate.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.conf "$pkgdir"/etc/$pkgname.conf

	install -m755 -d "$pkgdir"/etc/rsyslog.d
	install -m700 -d "$pkgdir"/var/lib/rsyslog
}

_plugin() {
	local name="${subpkgname#"$pkgname"-}"
	pkgdesc="$name support for $pkgname"
	depends="$pkgname=$pkgver-r$pkgrel"

	case "$name" in
	openssl)
		provides="rsyslog-tls=$pkgver-r$pkgrel"
		install_if="$pkgname=$pkgver-r$pkgrel libssl3" ;;
	zstd)
		install_if="$pkgname=$pkgver-r$pkgrel zstd-libs" ;;
	esac

	local libnames=$(printf '%s\n' $_plugins | grep "^$name:" | cut -d: -f2- | tr : ' ')
	local libname

	for libname in ${libnames:-$name}; do
		mkdir -p "$subpkgdir"/usr/lib/rsyslog/
		mv "$pkgdir"/usr/lib/rsyslog/$libname.so "$subpkgdir"/usr/lib/rsyslog/
	done

	# Allow people to find plugins by their full name (including prefix;
	# mm, om, im, ...).
	for libname in $libnames; do
		provides="$provides $pkgname-$libname=$pkgver-r$pkgrel"
	done
}

sha512sums="
433ab02031a568ff9612845256083d00db55289f9af0aae502ed486328f3739f380381a6e69b899af2430c0cb99623cef77edb15bb692e94c245a120f0f2bd36  rsyslog-8.2512.0.tar.gz
034c54e4a751996437e539b01651337d3e08cf7648adb0b3ab89c6c3a0c158411ccccbac6dc9c8e34f76e9a72c2b9564a3e335a6d3b65a09c57a6553afb97066  tcpsrv-restore-default-stack-size.patch
9365f2c7e4d62d9b402f40da346778e658b43ad1ad234373316ce0782d23fb5ed642d99d5920132ba854d9a28b7944d5d9d5da12b7ce1e6fe7df5b2f934a9e7e  rsyslog.initd
1c3040cbcfd3009d6088dea4c8b9532c4e0783543e20ab5764221ef6ead21ca65be7c9c328b5a436ae503a2118a7448951875cc56607a14abc4753b0debbc6c5  rsyslog.logrotate
f86b006daaa8f6102692e00233409a487b2044d0f0e7509e6680ac163d90d885f7b833e24bc50e9dbef10fa4b4b610216aa1b16bb10ea4e7c3a66fc55b154a90  rsyslog.conf
"
