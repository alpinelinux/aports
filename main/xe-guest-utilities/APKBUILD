# Contributor: Cedric Schieli <cschieli@gmail.com>
# Maintainer: Cedric Schieli <cschieli@gmail.com>
pkgname=xe-guest-utilities
_major=5.5.0
_minor=458
pkgver=6.1.0
pkgrel=2
pkgdesc="XenServer guest tools"
url="http://www.citrix.com"
arch="x86 x86_64"
license="GPL"
depends=
makedepends=
install=
subpackages=
source="http://updates.vmd.citrix.com/XenServer/${_major}/debian/pool/main/x/${pkgname}/${pkgname}_${_major}-${_minor}.tar.gz
	$pkgname.initd
	no_bash_dependency.patch
	identify_alpine.patch
	fix_cflags.patch
	no_hard_links.patch
	"

builddir="$srcdir"/$pkgname-$_major

prepare() {
	cd "$builddir"

	msg "Unpacking xenstore-sources..."
	tar xjf xenstore-sources.tar.bz2

	for i in ../*.diff ../*.patch; do
		[ -f $i ] || continue
		msg "Applying $i..."
		patch -s -p1 -N < $i
	done

	ln -s ../../xen/include/public uclibc-sources/tools/xenstore/xen
	sed -i -e 's/-Werror//' uclibc-sources/tools/xenstore/Makefile
}

build() {
	cd "$builddir"/uclibc-sources/tools/xenstore
	make XENSTORE_STATIC_CLIENTS=y clients
}

package() {
	cd "$builddir"
	install -m755 -D "$builddir"/xe-linux-distribution "$pkgdir"/usr/sbin/xe-linux-distribution
	install -m755 -D "$builddir"/xe-update-guest-attrs "$pkgdir"/usr/sbin/xe-update-guest-attrs
	install -m755 -D "$builddir"/xe-daemon "$pkgdir"/usr/sbin/xe-daemon
	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	cd uclibc-sources/tools/xenstore
	make DESTDIR="$pkgdir" client-install
}

sha512sums="773dfd902166143d2fb0106312704dc516a34f6026d566f4d5b9e855bce0365288a98cad61c336aa26a639559f69a28038bc5c18379206006d11a3f10c8d3950  xe-guest-utilities_5.5.0-458.tar.gz
3e898b473f6e71ecc5b820717df0a460b31756b68f4bb9bf454df39f430e64ca5e33582c03bfea044d93f49937883fe9b6807c31dee72307750de670bfca8bcd  xe-guest-utilities.initd
8823cccdcef84f8632a528a77fa338e71cfc098f05a2e8d858f335bbaa21c2eddc40696c5d526e2a7f86a2225e23a63df83274cbeb755a9626036724e9855724  no_bash_dependency.patch
94d0d3c6f082dc76e7a76b48d1ecfff7d38ba6da344d1fdfa94c7a8f6c23ca726bccc7b1c8934f41ab06bb9a6b8582aec7448a99d17598b19dc8f3a73f1cd08a  identify_alpine.patch
0fc0bbff8f6b165f9ac9b89cccda5fbc46e37a20342028a770c43aa893c8c4dc2dbeddae7c005d13f500d96d12172176202298d1933094671323dc6f71732435  fix_cflags.patch
7245a92f8af446ec77eabed8a022c61f0c4874cc2dc569ef3ff944b6b398ac42ab284822c5f4886eb4a9a461f1ae2b02eb6c58560eb50af7616c92583d1612fc  no_hard_links.patch"
