# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>
pkgname=libvirt
pkgver=1.1.4
_ver="${pkgver/_rc/-rc}"
pkgrel=2
pkgdesc="A virtualization API for several hypervisor and container systems"
url="http://libvirt.org/"
arch="all"
license="LGPL"
_daemon_deps="bridge-utils dmidecode iptables"
_client_deps="pm-utils gnutls-utils netcat-openbsd"
depends=""
makedepends="augeas-dev bridge-utils cyrus-sasl-dev device-mapper
	e2fsprogs-dev gnutls-dev libcap-ng-dev libgpg-error-dev
	netcf-dev libnl-dev libxml2-dev libxslt-dev libtasn1-dev
	lvm2-dev lxc-dev gnutls-dev libgcrypt-dev parted-dev perl pkgconfig
	udev-dev zlib-dev yajl-dev libpcap-dev curl-dev libpciaccess-dev
	polkit-dev readline-dev
	$_daemon_deps $_client_deps
	"
install="$pkgname.post-install"
subpackages="$pkgname-dev $pkgname-doc $pkgname-client $pkgname-daemon
	$pkgname-lang py-$pkgname:_py
	$pkgname-lxc $pkgname-qemu $pkgname-uml $pkgname-vbox"
source="http://libvirt.org/sources/$pkgname-$pkgver.tar.gz
	libvirt.confd
	libvirt.initd
	uclibc-physmem.patch
	CVE-2013-6458_1.patch
	CVE-2013-6458_2.patch
	CVE-2013-6458_3.patch
	CVE-2013-6458_4.patch
	CVE-2014-1447_1.patch
	CVE-2014-1447_2.patch
	"

if [ "$CARCH" = "x86_64" ]; then
	subpackages="$subpackages $pkgname-xen"
	makedepends="$makedepends xen-dev"
fi
subpackages="$subpackages $pkgname-common-drivers:_common_drivers"

_builddir="$srcdir"/$pkgname-$pkgver

prepare() {
        cd "$_builddir" || return 1
        for patch in $source; do
                case $patch in
                # we concider patches with uclibc in its name
                # only usefull on uclibc install
                *uclibc*.patch)
                        if [ "$ALPINE_LIBC" != "eglibc" ]; then
                                msg "Applying patch $patch"
                                patch -p1 -i "$srcdir"/$patch || return 1
                        fi
                        ;;
                *.patch)
                        msg "Applying patch $patch"
                        patch -p1 -i "$srcdir"/$patch || return 1
                        ;;
                esac
        done
}

build() {
	cd "$_builddir"
	export LDFLAGS="$LDFLAGS -lm"
	local _xen_opt=
	if [ "$CARCH" = x86_64 ]; then
		_xen_opt="--with-libxl"
	fi
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--libexec=/usr/lib/"$pkgname" \
		$_xen_opt \
		--with-polkit \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	find "$pkgdir" -name '*.la' -delete
	install -D -m755 $srcdir/$pkgname.initd $pkgdir/etc/init.d/libvirtd
	install -D -m755 $srcdir/$pkgname.confd $pkgdir/etc/conf.d/libvirtd
}

dev() {
	default_dev
	mkdir -p "$subpkgdir"/usr/share/libvirt
	mv "$pkgdir"/usr/share/libvirt/api \
		"$subpkgdir"/usr/share/libvirt/
}

daemon() {
	cd "$_builddir"
	pkgdesc="libvirt daemon package"
	depends="libvirt-client $_daemon_deps"
	replaces="libvirt"
	mkdir -p "$subpkgdir"/etc/$pkgname \
	 "$subpkgdir"/etc/logrotate.d \
	 "$subpkgdir"/usr/sbin
	mv "$pkgdir"/etc/init.d "$subpkgdir"/etc
	mv "$pkgdir"/etc/conf.d "$subpkgdir"/etc
	mv "$pkgdir"/etc/$pkgname/libvirtd.conf "$subpkgdir"/etc/libvirt/
	mv "$pkgdir"/usr/sbin/libvirtd "$subpkgdir"/usr/sbin/
	mv "$pkgdir"/etc/logrotate.d/libvirtd "$subpkgdir"/etc/logrotate.d/
}

client() {
	cd "$_builddir"
	pkgdesc="libvirt client package"
	depends="libvirt $_client_deps"
	replaces="libvirt"
	mkdir -p "$subpkgdir"/etc/$pkgname "$subpkgdir"/usr/bin \
		"$subpkgdir"/usr/lib
	mv "$pkgdir"/etc/$pkgname/$pkgname.conf "$subpkgdir"/etc/libvirt/
	mv "$pkgdir"/usr/bin/* "$subpkgdir"/usr/bin/
	mv "$pkgdir"/usr/lib/lib*.so.* "$subpkgdir"/usr/lib/ || return 1
}

_py() {
	pkgdesc="Python bindings to libvirt"
	replaces="libvirt"
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/python* "$subpkgdir"/usr/lib/
}

_mv_driver() {
	local _name="$1" _drivers="$2" _pkg="$3"
	pkgdesc="$_name driver for libvirt"
	depends="$pkgname-daemon=$pkgver-r$pkgrel
		$pkgname-common-drivers=$pkgver-r$pkgrel"
	replaces="libvirt"
	if [ -n "$_pkg" ]; then
		install_if="$pkgname-daemon=$pkgver-r$pkgrel $_pkg"
	else
		install_if=
	fi
	local _dir=/usr/lib/libvirt/connection-driver
	mkdir -p "$subpkgdir"/$_dir \
		"$subpkgdir"/etc/libvirt \
		"$subpkgdir"/etc/logrotate.d
	local _d
	cd "$pkgdir"
	for _d in $_drivers; do
		find * -name "*$_d[.-]*" -o -name "*$_d" | while read _f; do
			mkdir -p "$subpkgdir"/${_f%/*}
			mv "$pkgdir"/$_f "$subpkgdir"/$_f || return 1
		done
	done
}

qemu() { _mv_driver "QEMU" qemu qemu; }
xen() { _mv_driver "XEN" "libxl xen" xen; }
lxc() { _mv_driver "LXC" lxc lxc; }
uml() { _mv_driver "UML" uml; }
vbox() { _mv_driver "VirtualBox" vbox; }

_common_drivers() {
	pkgdesc="Common libvirt daemon drivers"
	replaces="libvirt"
	mkdir -p "$subpkgdir"/usr/lib/libvirt \
		"$subpkgdir"/etc/libvirt/nwfilter
	mv "$pkgdir"/usr/lib/libvirt/connection-driver \
		"$subpkgdir"/usr/lib/libvirt/
	mv "$pkgdir"/etc/libvirt/nwfilter \
		"$subpkgdir"/etc/libvirt/
}

md5sums="0b21e97ad5d3c27d18806896e16ef82b  libvirt-1.1.4.tar.gz
1c84a7baeafe0a7f4e9d7ae5180311b7  libvirt.confd
d897df38c7e7fa1a297aa551108633c9  libvirt.initd
df9cbfaf8a6e520a4822914a300add4d  uclibc-physmem.patch
c553f1262e82ceaf65fb326c18a38fd3  CVE-2013-6458_1.patch
42c528e2609a6161fe9ca407a34a1a0b  CVE-2013-6458_2.patch
2f6d80c57f1e3d47d58dc10eee073f4b  CVE-2013-6458_3.patch
6ea1ef3d176cbea184470eb1cf90d312  CVE-2013-6458_4.patch
478b29fb900f1029c788df778c34d76f  CVE-2014-1447_1.patch
a8c3311052ceaf1ace02015fe4b6fa8c  CVE-2014-1447_2.patch"
sha256sums="5910f5cf607a50c606d959e6b1e5d6e67966b7aa7324982afd7f85d9c24bd98f  libvirt-1.1.4.tar.gz
851ab3f9678f0fa9c3ee03f7fc7bd00c4ee86d5f0777eecf9eb1ffe3243adfd1  libvirt.confd
e9fad203434ffaa6afe524e42a9fb6594edad61cb02b1ca60a68d1a7fe0c31ab  libvirt.initd
807005a8669b7396c9af43ddb2534bb0f073f1e97a5c8b1d9eefc1949f3c2df8  uclibc-physmem.patch
3a2a0fc3ec7e78677f6c76c4178c05c76e056e21642cb52580aaa2c785aeb6f3  CVE-2013-6458_1.patch
4f290a3016edc07c0870747035e1bf8bf7d72d0072ced3979659cddadc9ea41a  CVE-2013-6458_2.patch
8c8c7b4e41c46593064192e35fa5391c25d99166f18f000a55c5baf74e031e36  CVE-2013-6458_3.patch
26a999baa8640f9c03be0fa7842004421211b7be1309a3769695ea0a670369a0  CVE-2013-6458_4.patch
2d565d00b0090829e3c80aa8cf49f33457da2c286438a8db3609bbf9b831604d  CVE-2014-1447_1.patch
5ff1b38de2dccb8c8ecd7a80de21b45e2ea8276f3a7f50634433714b636df45c  CVE-2014-1447_2.patch"
sha512sums="64455585b8d7e5c0f701e9803ae00d277ee27f9bec92b9890e487cd0298f5f8ff9075d0b2bc81be67e8d8e03bfe58eb2e4fd6292439acd9d22a3f3e7f5b87efc  libvirt-1.1.4.tar.gz
9aba6ab73219a635c64a340ee8887356e644445c9128734cbce73f5d54778378da2f10a190365ad88a7db8bc95b1fb17f0c6ca41fc41bb786c09e1afe84d65dc  libvirt.confd
f48c97f93ef4509a86eda6200b3aae5b2c0c6263403bde933b770fd62240dca27bc439bd29b440ea6a47c8337f8b4511230ed915cb5ff54d9a1cf311863f6fa1  libvirt.initd
4c885e72dcb11f8523a267917315d4874812eee289fb00075334c1728d0da9bd0e5db6c52d6e3c39bd3fe66d5ccadf9e26ec9dcaa855397e211b9bd1173ac72d  uclibc-physmem.patch
d6584f20beab27329a873c61ffacc15592b1c382e363eb7975926707b89973f6594650a69e8f5986fde42b14d3bb4396f1668c6393e7dc1187113bad8ed01aa2  CVE-2013-6458_1.patch
ff84d2c7ab2f4b67a4fc22c3159dc4620bec05c4b47289f7ea9a235253873c9d99ab9f1f8a29918e6bba23c4311546d2a5ab80c34566e6fd943828fd962ba98f  CVE-2013-6458_2.patch
e2fc3481efa2c0260bffd4df23c6dddf6024e088d606bf1e307d91b5b25f3a1ae6addc8be869eb83d5717ecffeebb2bfe975420e6d1fbb51474c9022058f76e6  CVE-2013-6458_3.patch
9d8e734d60c179133c16729ff6535c1b761e7c447863d884cd9b20266bb15a2c3371b6e90206d8bae1cb7e00c464f863d9023748bf210f4624ce0f3769a9c928  CVE-2013-6458_4.patch
36c8da3138db811d6fcc21aef2744f8a0a7c753f21f66b054fae01de81bafcf5cd7bce6b3cc0e647b7e701c009db2ab13369f508d7f4cb5960d75100fe5bd529  CVE-2014-1447_1.patch
188e23b6e08609eb4e0a6c4fffd0cf5743df06520c06473c197585f9e50c76f052da01fb0d033cd1f585704ce74af017b4d96716469c4fa2c44e5e8a7d08968b  CVE-2014-1447_2.patch"
