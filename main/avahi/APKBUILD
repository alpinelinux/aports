# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=avahi
pkgver=0.7
pkgrel=2
pkgdesc="A multicast/unicast DNS-SD framework"
url="https://www.avahi.org/"
arch="all"
license="LGPL-2.0-or-later"
pkgusers="avahi"
pkggroups="avahi"
depends_dev="gdbm-dev"
makedepends="py-dbus-dev intltool py-gobject3-dev gobject-introspection-dev expat-dev
	libdaemon-dev glib-dev dbus-dev libcap-dev gettext-dev autoconf automake
	libtool gdbm-dev py3-gdbm gtk+3.0-dev"
install="$pkgname.pre-install"
subpackages="$pkgname-dev $pkgname-doc $pkgname-tools $pkgname-glib
	$pkgname-libs $pkgname-compat-howl:howl $pkgname-compat-libdns_sd:lidns_sd
	$pkgname-lang $pkgname-openrc py3-avahi:_py3:noarch
	$pkgname-ui $pkgname-ui-tools:ui_tools $pkgname-ui-gtk3:ui_gtk3"
source="$pkgname-$pkgver.tar.gz::https://github.com/lathiat/avahi/archive/v$pkgver.tar.gz
	gnome-nettool.png
	python3-support.patch
	"

prepare() {
	default_prepare

	cd "$builddir"
	NOCONFIGURE=1 ./autogen.sh
}

build() {
	cd "$builddir"

	# we dont build autoipd since dhcpcd does same job
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--disable-autoipd \
		--disable-qt3 \
		--disable-qt4 \
		--disable-gtk \
		--enable-gtk3 \
		--disable-mono \
		--disable-monodoc \
		--disable-doxygen-doc \
		--disable-pygtk \
		--disable-manpages \
		--enable-compat-libdns_sd \
		--enable-compat-howl \
		--enable-python \
		--enable-shared \
		--disable-static \
		--with-distro="gentoo"
	make
}

check() {
	cd "$builddir"
	make check
}

package() {
	cd "$builddir"

	make DESTDIR="$pkgdir" install

	install -d -o avahi -g avahi "$pkgdir"/var/run/avahi-daemon

	ln -s avahi-compat-howl.pc "$pkgdir"/usr/lib/pkgconfig/howl.pc
	ln -s avahi-compat-libdns_sd.pc "$pkgdir"/usr/lib/pkgconfig/libdns_sd.pc
	ln -s avahi-compat-libdns_sd/dns_sd.h "$pkgdir"/usr/include/

	cd "$builddir"/avahi-ui
	DESTDIR="$pkgdir" make install

}

tools() {
	pkgdesc="Command line tools for mDNS browsing and publishing"

	mkdir -p "$subpkgdir"/usr/bin
	cd "$pkgdir"/usr/bin
	mv avahi-browse* avahi-publish* avahi-resolve* avahi-set* \
		"$subpkgdir"/usr/bin/
}

glib() {
	pkgdesc="Glib libraries and GObject wrapper for avahi"

	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libavahi-glib.so.* \
		"$pkgdir"/usr/lib/libavahi-gobject.so.* \
		"$subpkgdir"/usr/lib/
}

libs() {
	pkgdesc="Libraries for avahi run-time use"

	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libavahi-common.so.* \
		"$pkgdir"/usr/lib/libavahi-client.so.* \
		"$subpkgdir"/usr/lib/
}


howl() {
	pkgdesc="Libraries for howl compatibility"

	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libhowl.so.* \
		"$subpkgdir"/usr/lib/
}

lidns_sd() {
	pkgdesc="Libraries for Apple Bonjour mDNSResponder compatibility"

	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libdns_sd.so.* \
		"$subpkgdir"/usr/lib/
}

_py3() {
	pkgdesc="Python 3 bindings for avahi"
	depends="$pkgname=$pkgver-r$pkgrel python3"
	provides="py-avahi=$pkgver-r$pkgrel"  # for backward compatibility
	replaces="py-avahi"  # for backward compatibility

	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/python3.* "$subpkgdir"/usr/lib/
}

ui() {
	pkgdesc="GTK user interface library for Avahi"

	mkdir -p "$subpkgdir"/usr/share/applications
	mv "$pkgdir"/usr/share/applications/* \
		"$subpkgdir"/usr/share/applications/

}

ui_tools() {
	pkgdesc="UI tools for mDNS browsing"
	depends="py3-avahi py3-dbus py3-gobject3 py3-gdbm"

	mkdir -p "$subpkgdir"/usr/bin "$subpkgdir"/usr/share/avahi/interfaces

	mv \
		"$pkgdir"/usr/bin/avahi-bookmarks \
		"$pkgdir"/usr/bin/avahi-discover \
		"$pkgdir"/usr/bin/b* \
		"$subpkgdir"/usr/bin/
	mv "$pkgdir"/usr/share/avahi/interfaces/avahi-discover.ui \
		"$subpkgdir"/usr/share/avahi/interfaces/
	install -D -m 644 "$srcdir"/gnome-nettool.png \
		"$subpkgdir"/usr/share/pixmaps/gnome-nettool.png

}

ui_gtk3() {
	pkgdesc="GTK3 user interface library for Avahi"
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libavahi-ui-gtk3.so.* \
		"$subpkgdir"/usr/lib/
}

sha512sums="61f656da7614d8cca1862180038f571db3474c84f05db4d3509f614cdbf8b1a1047661b7e24d63682d5b48ed1bfa1b08b3c9e6dbe9222bcd62d99bc168a11abe  avahi-0.7.tar.gz
d8e92fcdd82759f8de536ebfa356fe208c27b2d998ce5bb51d585dffc163dc16228be4a7108644fe1a11defbe750244bc8105a430b1397297cdef4cb83ab0db5  gnome-nettool.png
7b287062d605c0dd0c5a0a78ccc072ea31d2a4d158a804133e5ea8056a8f1eecf7f4833d2078c2349e01f0e97d269efb944c883a543f8f4fc3f5d538bc2c0cbe  python3-support.patch"
