# Contributor: Marian Buschsieweke <marian.buschsieweke@posteo.net>
# Maintainer: macmpi <spam@ipik.org>
pkgname=raspberrypi-bootloader
# To match Alpine kernel schedule, use master branch commit id rather than older stable tagged releases
# Keep by-the-date release numbering for consistency
# To avoid unnecessary pkg bumps & update just pick commit of latest *.dat, *.elf, bootcode.bin files changes
_commit=30b27d51a2829ef1429618cf34e0dbead7da67da
pkgver=1.20251208
pkgrel=0
pkgdesc="Bootloader files for the Raspberry Pi"
url="https://github.com/raspberrypi/rpi-firmware"
arch="armhf armv7 aarch64"
license="custom"
triggers="raspberrypi-bootloader-common.trigger=/boot"
options="!check !strip !tracedeps !spdx"
source="$pkgname-$pkgver.tar.gz::https://github.com/raspberrypi/rpi-firmware/archive/$_commit.tar.gz
	update-raspberrypi-bootloader"
subpackages="$pkgname-common $pkgname-experimental $pkgname-debug $pkgname-cutdown $pkgname-doc"
depends="$pkgname-common=$pkgver-r$pkgrel"

builddir="$srcdir/rpi-firmware-$_commit"

package() {
	local fw; for fw in bootcode.bin fixup.dat fixup4.dat start.elf start4.elf; do
		install -D "$builddir"/$fw \
			"$pkgdir"/boot/$fw
	done
	install -Dm 644 "$builddir"/LICENCE.broadcom \
		"$pkgdir"/usr/share/licenses/$pkgname/COPYING
	install -D -m755 "$srcdir"/update-raspberrypi-bootloader \
		"$pkgdir"/usr/sbin/update-raspberrypi-bootloader
}

common() {
	pkgdesc="Common files used by Raspberry Pi bootloaders"
	depends=
	amove boot/bootcode.bin \
		usr/sbin/update-raspberrypi-bootloader
}

experimental() {
	pkgdesc="Experimental firmware with additional codecs"
	depends="$pkgname-common=$pkgver-r$pkgrel"
	local fw; for fw in start_x.elf start4x.elf fixup_x.dat fixup4x.dat; do
		install -D "$builddir"/$fw \
				"$subpkgdir"/boot/$fw
	done
}

debug() {
	pkgdesc="Debug firmware"
	depends="$pkgname-common=$pkgver-r$pkgrel"
	local fw; for fw in start_db.elf start4db.elf fixup_db.dat fixup4db.dat; do
		install -D "$builddir"/$fw \
			"$subpkgdir"/boot/$fw
	done
}

cutdown() {
	pkgdesc="Cut-down firmware for lower memory settings"
	depends="$pkgname-common=$pkgver-r$pkgrel"
	local fw; for fw in start_cd.elf start4cd.elf fixup_cd.dat fixup4cd.dat; do
		install -D "$builddir"/$fw \
			"$subpkgdir"/boot/$fw
	done
}

sha512sums="
f46c37c15d9e92bea6c099aa46c38b50f9c485ac2a1eb99981605eafc46d562caadfa3c701477e061e3a5e9ed655d997ba2d7cc4df4e85d29dc5a8a39897e022  raspberrypi-bootloader-1.20251208.tar.gz
42a864c4b4b1c1090f0a8aa802c7e49a11dd17603f3ee3b1e75bd8b4174b22b1f0111ede748010df7554a35d548e729a57678725d38de5dd659a446aa24cfc09  update-raspberrypi-bootloader
"
