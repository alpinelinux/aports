# Maintainer: Tuan Hoang <tmhoang@linux.ibm.com>
pkgname=s390-tools
pkgver=2.39.0
pkgrel=0
pkgdesc="Tools for use with the s390 Linux kernel and device drivers"
url="https://github.com/ibm-s390-tools/s390-tools"
arch="all"
license="MIT"
options="!check" # No test suite
depends="bash"
makedepends="linux-headers zlib-dev fuse3-dev ncurses-dev openssl-dev>3 libxml2-dev
	cryptsetup-dev json-c-dev net-snmp-dev curl-dev liblockfile-dev"
subpackages="$pkgname-doc"
case $CARCH in
	s390x)
		triggers="$pkgname.trigger=/boot"
		subpackages="$subpackages $pkgname-dbg $pkgname-udev"
		;;
	*) options="$options !archcheck" ;;
esac
source="$pkgname-$pkgver.tar.gz::https://github.com/ibm-s390-tools/s390-tools/archive/v$pkgver.tar.gz
	0002-musl-fixes.patch
	0004-missing-time-header.patch
	0006-define-path-mounted.patch
	0008-iucvterm-no-nls.patch
	0011-tools-Fix-compilation-with-musl-and-gcc-14.patch
	0200-dasdinfo-gnu-ext-hack.patch
	0300-disable-program-using-gnu-ext.patch
	0400-busybox-compat.patch
	0500-remove-lib64.patch
	iucvterm-gettext.patch
	netboot-everywhere.patch
	no-execinfo.patch

	argz.c
	argz.h
	"

_make() {
	make CPPFLAGS="$CPPFLAGS -D_GNU_SOURCE" \
		CFLAGS="$CFLAGS -D_GNU_SOURCE -D_LARGEFILE64_SOURCE" \
		HAVE_CARGO=0 \
		HAVE_GLIB=0 \
		HAVE_GLIB2=0 \
		HAVE_PFM=0 \
		HAVE_LIBUDEV=0 \
		HAVE_SYSTEMD=0 \
		HAVE_LIBNL3=0 \
		DISTRELEASE="Alpine" \
		"$@"
}

build() {
	cp "$srcdir"/argz.h "$builddir"/include/argz.h
	cp "$srcdir"/argz.c "$builddir"/libutil/argz.c
	_make V=1
}

package() {
	_make DESTDIR="$pkgdir" install
	mkdir -p "$pkgdir"/sbin
	ln -s ../usr/share/s390-tools/netboot/mk-s390image "$pkgdir"/usr/bin/mk-s390image
}

sha512sums="
ee9447f28f0cc43b4eba8110879174372a4ed85e2e53c3500e02723275c0aee01fd4913558ef3eaa62be40a0f5e634c3eb59587150e809fe14e8b4794e340ac7  s390-tools-2.39.0.tar.gz
ef7485e97670d10553c44838000f3f7fa62926bfc55088f702c860ae86dfb726ffd304f78cf1dc138e46c74a58babc07298da8806eafab39100b594ff1467c17  0002-musl-fixes.patch
6e0f8d999eef08677e9f80d1a07e01556474723b9b00435d463428eee22babe4489257ad5c8fffb650bd0fd5714cdac01dc926e1402f9741fc1327d177ece897  0004-missing-time-header.patch
e41548d83d53e4371afcee3601505520506d05b932aeb91f1ca86e589c010fa5d22777d4617c1e25adfc04fbcf45289cf65a8100108c878323e125e312579220  0006-define-path-mounted.patch
bdbeb6f3873ede82487c7e4fcac84aa2bf8a922991ec32d029a64cd7142625f5a99920db0f1b6935805d7371ae5a7640c5ea577969937dd96c4f4f996b909ac3  0008-iucvterm-no-nls.patch
f9cbf044e3a69bd170e1cd12c13414f7c8ded76fee24459a3a2b3a74c8e8703eeff6449789698e0e17f40f437e12b30e495c31fa1ad8a42129fadb98b7509c71  0011-tools-Fix-compilation-with-musl-and-gcc-14.patch
b3016f499637f13327a4129e62caf56a4e4e3b991e0459f89b8b3db84a05034509fbc6f0607274c0921a808f494d4eae0b85c74be8ca06d4f6d812f435a313ef  0200-dasdinfo-gnu-ext-hack.patch
3e593227ed1edff934a14f05eb856485c9ab12747c4428f786e3c1d2fcdcbe4fdb3f02d1051291bd897447ab23fa540050e411d85de7c91492e0dbe0cf8ea21f  0300-disable-program-using-gnu-ext.patch
699ab3381f23c70bc3c7a89f11475046faf794747ae52a245edd9276e37721b3f93d457e3583649e397860c79c2bec8130eda5517d7342e4901e192406aa97b8  0400-busybox-compat.patch
6923aeb898c6d24cd1f67cdbd303bc22d580aa1496ad900da550601bec04ad1dff87aa9da779f697cd0a6e5c82ec58c6514227df02789a0186a7f8fd7d393918  0500-remove-lib64.patch
c3746ea9e5c638a7adc51bfd8ffebc34f2be45d8d816e9f5711ba8f238fe028f711c91c6732a08a8088e32261f769e2e41a079997295e146082212b8fa84a246  iucvterm-gettext.patch
396d61d3972977d01cea19b25ed10156b05811e2fb2393d37cf1cf1fc683682a01f5e5bb8cd8614e530188bad1cbd49debbd5b48eec60b7e4bd439878742f5ec  netboot-everywhere.patch
797ea51f24b2bb0ff0e14a5626d8b13d5ed93f083f7c3366d2e7b6be7102fc5f092c241686e6f5738ee0096d389e0d1490ebc87402541cba83b92c8059cacbdc  no-execinfo.patch
2e573314d4c4ed90b61da28de22ae8e2f68ced5489f7e5e0b30f51b776efaf40c1f781d3b485418572d8f33a169fa6946b7358cbd4a7de5a3724b20ed622262b  argz.c
50bd5c0f555963dadbfaa72df5bf0801a48743d6d0feddb6ebfa4ffa410196216c1860d3a577361e035169fea4217aef3f04d69394c59db65b60c5ea29eba8cb  argz.h
"
