# Contributor: Cameron <cbanta@gmail.com>
# Maintainer: Cameron <cbanta@gmail.com>
pkgname="pgpool"
_opkgname="${pkgname}-II"
pkgver=3.7.2
pkgrel=1
pkgdesc="A connection pooling/replication server for PostgreSQL"
url="http://www.pgpool.net"
arch="all"
license="BSD"
depends="$pkgname-common !$pkgname-memcached"
depends_dev="libmemcached-dev libressl-dev postgresql-dev"
makedepends="$depends_dev linux-headers"
subpackages="${pkgname}-dev $pkgname-openrc::noarch $pkgname-bins $pkgname-libs $pkgname-common::noarch $pkgname-memcached"
source="${pkgname}-${pkgver}.tar.gz::http://www.pgpool.net/download.php?f=${_opkgname}-${pkgver}.tar.gz
	tools-scripts-are-no-longer-sym-links.patch
	${pkgname}.initd"

builddir="${srcdir}/${_opkgname}-${pkgver}"

prepare() {
	default_prepare

	cd "$builddir"
	update_config_sub
}

_configure() {
	./configure \
		--build="$CBUILD" \
		--host="$CHOST" \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--with-openssl "$@"
}

build() {
	cd "$builddir"

	_configure --with-memcached=/usr
	make
	mv "src/$pkgname" "$pkgname-memcached"
	make clean

	_configure
	make
}

check() {
	cd "$builddir"

	make check

	./src/$pkgname --version
	./$pkgname-memcached --version
}

package() {
	cd "$builddir"

	make DESTDIR="$pkgdir" install

	install -m755 -D "${srcdir}/${pkgname}.initd" "${pkgdir}/etc/init.d/${pkgname}"

	#move the standard pgpool binary out of the way
	mv $pkgdir/usr/bin/$pkgname $builddir/$pkgname
}

bins() {
	pkgdesc="$pkgname binaries"
	depends=""

	mkdir -p $subpkgdir/usr
	mv $pkgdir/usr/bin $subpkgdir/usr/
}

common() {
	pkgdesc="$pkgname common files"
	depends="$pkgname-bins"

	mkdir -p $subpkgdir
	mv $pkgdir/* $subpkgdir/
}

libs() {
	pkgdesc="$pkgname libraries"
	depends=""

	mkdir -p $subpkgdir/usr
	mv $pkgdir/usr/lib $subpkgdir/usr/
}

memcached() {
	pkgdesc="$pkgname with memcached support"
	depends="$pkgname-common !$pkgname"

	install -m755 -D "$builddir/$pkgname-memcached" "$subpkgdir/usr/bin/$pkgname"

	# put the standard pgpool binary back
	mkdir -p $pkgdir/usr/bin
	mv $builddir/$pkgname $pkgdir/usr/bin/$pkgname
}

sha512sums="adafa9535854268887f9a57ba461d65c4f1ab2fea2e6cc663645be0c3bf9b58a9fff043fcb45e38b7d37fcfcfa08bb826fd8b5b3480f10210c3a47c42eb5674d  pgpool-3.7.2.tar.gz
1c0c8039d7c449ff1c11a1017872a16663a03ab8ecc124d6cca741848a0b72501d91988e6605dbbe2c374c3dda7736b0dd317fb15d234f63c080ea1843d9fc23  tools-scripts-are-no-longer-sym-links.patch
de36d7aab6806f1e303901ac80284bb9861edaf9b682901db9f1ead3843ba8cb528c814e5dabfc2c450ebed6450daf3fff14166d08a530e1c44a29e4d4e29a2c  pgpool.initd"
