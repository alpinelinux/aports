# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=openrc
pkgver=0.14
_ver=${pkgver/_git*/}
pkgrel=2
pkgdesc="OpenRC manages the services, startup and shutdown of a host"
url="http://git.overlays.gentoo.org/gitweb/?p=proj/openrc.git"
arch="all"
license='BSD-2'
depends=""
makedepends="bsd-compat-headers"
subpackages="$pkgname-doc $pkgname-dev"
install="$pkgname.post-install $pkgname.post-upgrade"
source="openrc-$pkgver.tar.gz::https://github.com/OpenRC/openrc/archive/$pkgver.tar.gz
	openrc-0.4.3-mkmntdirs.patch

	0001-Force-root-be-rw-before-localmount.patch
	0001-sysctl.Linux.in-fix-for-busybox-sysctl.patch
	swap-umount-tmpfs.patch
	swap-ifexists.patch
	hide-migrate-to-run-error.patch

	hostname.initd
	hwdrivers.initd
	keymaps.initd
	modules.initd
	modloop.initd
	networking.initd
	modloop.confd
	"

_builddir="$srcdir/$pkgname-$_ver"
prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1
		esac
	done
	sed -i -e '/^sed/d' pkgconfig/Makefile
}

build() {
	cd "$_builddir"
	make LIBEXECDIR=/lib/rc || return 1
}

package() {
	cd "$_builddir"
	make LIBEXECDIR=/lib/rc DESTDIR="$pkgdir/" install

	# we cannot have anything turned on by default
	rm -f "$pkgdir"/etc/runlevels/*/*

	# we still use our ifup/ifdown based net config
	rm -f "$pkgdir"/etc/conf.d/network "$pkgdir"/etc/init.d/network

	# we override some of the scripts
	for i in "$srcdir"/*.initd; do
		j=${i##*/}
		install -Dm755 $i "$pkgdir"/etc/init.d/${j%.initd}
	done
	
	install -D -m644 "$srcdir"/modloop.confd "$pkgdir"/etc/conf.d/modloop
	install -d "$pkgdir"/etc/local.d "$pkgdir"/run
}

md5sums="9cf465c6013bf95ae003bc4a9d11aed4  openrc-0.14.tar.gz
8c2c1c2ee0509b63966b7187a2079f4b  openrc-0.4.3-mkmntdirs.patch
4fd036ff07ed9ad7fb76af6a3ffc0695  0001-Force-root-be-rw-before-localmount.patch
09df9c2a6fbf3e18586c3737cd481e67  0001-sysctl.Linux.in-fix-for-busybox-sysctl.patch
c2af5e52da614a6cef02d1e4d537e360  swap-umount-tmpfs.patch
1c426b84d13a725ad493647b5253f239  swap-ifexists.patch
679c559aa54f9e855cd735866eeaaad6  hide-migrate-to-run-error.patch
2c9cf86959b9e51e662036b4e716617e  hostname.initd
bc3537cff5e623a0a2731bf5a27602d3  hwdrivers.initd
db9b69807cef50beb26b0e4867007394  keymaps.initd
3190533677d622eeb3e6ced4a17bd783  modules.initd
094d5354b06c0ef37abbcfa4c8ee1447  modloop.initd
8e03292b9d1c640698a8f836138f284b  networking.initd
c1ec888202d868710b5749f7b217d1e3  modloop.confd"
sha256sums="fbc1a88ac53e01681a8945dccc16a71c86550a741e8f32fd3e75ba46512653f3  openrc-0.14.tar.gz
c807aed11d7eb42de5c421a6d117532f6215697f159f40cb3404bdc80270bee1  openrc-0.4.3-mkmntdirs.patch
e869e2076c10a7134f5d9e4ae4a5d09ca35c6333d400556f1e329170d2e58066  0001-Force-root-be-rw-before-localmount.patch
8125caab3798d97acfae678ab81085ac247d570e471238c0cfc5b08a84cb61bd  0001-sysctl.Linux.in-fix-for-busybox-sysctl.patch
84d67ed2cf050e20f52d4ea048e7452e78356ba02b396d8c064a4458c0811ea4  swap-umount-tmpfs.patch
8978b00492d90b573f5254cc394582e8f1a5cd8b4d6c928fa0a9a022dd17fe9c  swap-ifexists.patch
786580df90a5a75087e5adfd395d160dee2df4b994e0938e8524198aeaf2d774  hide-migrate-to-run-error.patch
e23db45e9399dab96d6c922af6c0cd6c243bbcc43756c845b70a9c7222a96313  hostname.initd
5ea3067466c9d2f034cbc77fcfa398bd055693ce4c46a06fc3e7a5797b9207c5  hwdrivers.initd
5fa99516604f44a2d4de717ea0b86f7d8b03c72b484929f3953c19b91e2d6c72  keymaps.initd
1701490c50be0e367dba05664be5a69a51e60ea8b4cf57703e9859a0c1ce12f6  modules.initd
eff2d8609c1aed248945207562db80e107caf1646485556c4dac8e4c8a3c4e8e  modloop.initd
80b65bbf89d426b2f1bec5a4d75cadbc102e4484220c6b98d1258a0e90ccb280  networking.initd
a5a0316cd59f5401b1d789bb466c98186201277ba6f014017b14965fcc10c254  modloop.confd"
sha512sums="5d2eb8a81fa243b0d1fc6c6a3026461752bf491ba5aa2155b182d3249d98fb3729630ccaaa811402d7f5eaaf08399304357c4011d6523cac0cf69e1d10a02274  openrc-0.14.tar.gz
eee27fbf72776fb70d3aa6c6464180731d522191e5755aa431ab09ea11dd11bf001a95618adcaa5ccc08455268003ca2917b2bff31adc9894214221c469a97db  openrc-0.4.3-mkmntdirs.patch
51c77be5ab726d50ef1d0b9dab644edef1ff739e855e3a12ab27beada8911998e0c6a7491eb92df621dcdb633b672d933a4edc00115ec43bdf1271105239ebb7  0001-Force-root-be-rw-before-localmount.patch
ce9c2cc211a391f20702dbc51fe0cf3c979cb25f5d6d3bdf2ebbaf1c5fd6d39d102a7a37effa751c02a865f91e316672819e0a4c1cd76e0524a7a2a7e2b9a1f6  0001-sysctl.Linux.in-fix-for-busybox-sysctl.patch
8fd442d372401740b1c523367c928f49efa8179604aac2b517cdc4264daf303056d5a5e0a2c996db5e6ef9b7cdd0619a16cfabc15c3399e322384844e2a36542  swap-umount-tmpfs.patch
c5b8806c693b0ea48ff87e0e3669304f5c2f95954ad54814889047a933f367081a8c8d3bb771dd1ed6c3bc845df894232bd6b662066d09eba3abf3964187d1d1  swap-ifexists.patch
750e3305913d3f6fa6baa0b34b851fe17aacb922e864b95ec9b4b451e8e3c16d0c10686a12f4c7cb9b5d05894e1d89b0dac3beed19b1223d3fbc672f25769145  hide-migrate-to-run-error.patch
a6e2b44dd548a2470971a44b61ddaaec037438050fe3411b4ea3fe5d36e9ad4cf5b5e226f8d4aacb8f3a4535bb3f2090608275abd76a30de33eb3fadaefad5fd  hostname.initd
91dcb2786a7c02109959adc7d60df7a159d567ef93ff405b807b8060d51c1f88d58eacfb6ab4872f1c71f6024ade03d7f0f3e094360e0322d26102812ff00500  hwdrivers.initd
5cd8b54acfd75663a8246560526d5959fe45ff88ca7da66a392fab70fdb12ae0e4114582391d5498f230d9a97b5a1e7789c4720674243b17ceaf760bf34abc75  keymaps.initd
e26141643cfebaf49cfbddecac7a1d17c830816eff61827c64930c8cc4a87c3b9323bbecaa3c602646f147679da1b6cb00f0d22491477d7b3ca02f3a9b717c96  modules.initd
8947b4b14dd7709a7b4f7ee6b11b768614743cf646f4e8a40bc84ace7997f9daa6d503542e45599edfcd18af9366026a46f4180517949c9bad402b7b9cb167be  modloop.initd
ffbf547280cdd53c6ba842ffc31ab7a9a0153ddcc4e29043d2cbccf709745a8c1080636ec569e7e2769eff787c8f02fdff7e754dfb15698301b2d7e654b323ac  networking.initd
aa702a7da8e6c0e5d8738febaf6b4e4cb021b30ce5c1809b530abf2b36739079446b16fc054740da8d86ed099942cf5deed6597cedb64c058f3def587a8b4689  modloop.confd"
