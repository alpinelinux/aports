# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=lm_sensors
pkgver=3.4.0
pkgrel=6
pkgdesc="Collection of user space tools for general SMBus access and hardware monitoring."
url="http://www.lm-sensors.org/"
arch="all"
options="!check"  # No test suite.
license="LGPL-2.1+, GPL-2.0+"  # libs are LGPL, binaries are GPL
depends="bash sysfsutils"
makedepends="perl rrdtool-dev bison flex"
subpackages="$pkgname-dev $pkgname-doc $pkgname-detect $pkgname-sensord
	$pkgname-sensord-openrc:sensord_openrc"
#install=sensors.install

# 2015-11-11 (bpiotrowski): upstream website is down, Fedora mirrored the file
#source="http://dl.lm-sensors.org/lm-sensors/releases/$pkgname-$pkgver.tar.bz2
source="http://pkgs.fedoraproject.org/repo/pkgs/lm_sensors/lm_sensors-3.4.0.tar.bz2/c03675ae9d43d60322110c679416901a/lm_sensors-3.4.0.tar.bz2
	sensors-detect-alpine.patch
	musl-fix-includes.patch
	fancontrol.initd
	sensord.confd
	sensord.initd
	"

prepare() {
	cd "$builddir"
	sed -i -e 's:^# \(PROG_EXTRA\):\1:' Makefile
	# Respect LDFLAGS
	sed -i -e 's/\$(LIBDIR)$/\$(LIBDIR) \$(LDFLAGS)/g' Makefile
	sed -i -e 's/\$(LIBSHSONAME) -o/$(LIBSHSONAME) \$(LDFLAGS) -o/g' \
		lib/Module.mk

	# do not check for libiconv in ldconfig cache
	sed -i -e 's/^LIBICONV.*/LIBICONV ?=/' prog/sensors/Module.mk

	default_prepare
}

build() {
	cd "$builddir"
	export CFLAGS="$CFLAGS -fno-stack-protector"
	make PREFIX=/usr user
}

package() {
	cd "$builddir"
	make PROG_EXTRA:=sensord user_install \
		PREFIX=/usr \
		MANDIR=/usr/share/man \
		DESTDIR="$pkgdir"

	cd "$srcdir"
	install -Dm755 fancontrol.initd "$pkgdir"/etc/init.d/fancontrol
}

detect() {
	depends="perl"
	pkgdesc="Detection/migration scripts for lm_sensors"
	mkdir -p "$subpkgdir"/usr/bin "$subpkgdir"/usr/sbin
	cd "$pkgdir"
	mv usr/bin/sensors-conf-convert "$subpkgdir"/usr/bin/
	mv usr/sbin/sensors-detect "$subpkgdir"/usr/bin/
}

sensord() {
	pkgdesc="sensord daemon"
	cd "$builddir"
	mkdir -p "$subpkgdir"/usr/sbin
	mv "$pkgdir"/usr/sbin/sensord "$subpkgdir"/usr/sbin/sensord
}

sensord_openrc() {
	pkgdesc="sensord daemon (OpenRC init scripts)"
	install_if="$pkgname-sensord=$pkgver-r$pkgrel openrc"
	install -Dm755 "$srcdir"/sensord.initd "$subpkgdir"/etc/init.d/sensord
	install -Dm755 "$srcdir"/sensord.confd "$subpkgdir"/etc/conf.d/sensord
}

sha512sums="993064bd14b855c1ae8c057e89313df5b3d5efe441fb2e8c3e508f42bb15658564df2563fac8fabbdb0d650dfdbc694037736c748d45cb9d85dfb8fb5a3d1ea9  lm_sensors-3.4.0.tar.bz2
794cf2aaa2a9e809c6b67f4c888a89064bba3e5b9333a9f0101a92372c25012e506fa48e86523f57cf30e5c2a808bc38058fd8640c870ea6b48faab44794cfbb  sensors-detect-alpine.patch
333751cb580c94f2d32ef5520d2f2acc0ef7e1cd4a6390ea75cae4c755fbdfcade1805c979ba3319905f1267bdc120a6746e6f70d89e0c72a8c2faefd34a9e79  musl-fix-includes.patch
04756c3844033dc7897e1348181140a43f8470c1bb863f1524b21bbe6be2f13fbf17ac3a68270c96a70d8c148124fea569d1ef75619bbe383e15ec705ea18b21  fancontrol.initd
a77d81ab7ded085ba19e4c637e93268f889ccb8ce9e008a210ae135cb6e2140be07e5d455cf7fcc1084fd57cfbfb3f2bb37207123aebe9566f78b5183806fd7d  sensord.confd
9a19874c158e82ab076ed5fb96a40d4bfb4957bfd5a2ce66aa207c06e577bc1b048336c0046a9f856f6d00dc10e68a0dc9726f6e726a8f7bfd50c4043ee1e26a  sensord.initd"
