# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=augeas
pkgver=1.14.1
pkgrel=0
pkgdesc="A configuration editing tool"
url="http://augeas.net"
arch="all"
license="LGPL-2.1-or-later"
makedepends="autoconf automake libxml2-dev~2.13 readline-dev libtool"
subpackages="$pkgname-static $pkgname-dev $pkgname-doc $pkgname-tests::noarch $pkgname-libs"
source="https://github.com/hercules-team/augeas/releases/download/release-$pkgver/augeas-$pkgver.tar.gz
	fix-test.patch
	replace-bash-in-tests.patch
	acf.aug
	awall.aug
	"

prepare() {
	default_prepare
	autoreconf -f -i
}

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--enable-static \
		--enable-shared \
		--disable-gnulib-tests
	make
	make tests
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install
	rm -rf "$pkgdir"/usr/lib/charset.alias
	# Upstream packaging mistake, this should never have been installed
	rm -f "$pkgdir"/usr/bin/dump

	local lens
	for lens in acf awall; do
		install -m 644 "$srcdir"/$lens.aug "$pkgdir"/usr/share/augeas/lenses
	done
}

tests() {
	pkgdesc="Tests for Augeas lenses"

	mkdir -p "$subpkgdir"/usr/share/augeas/lenses/dist/
	mv "$pkgdir"/usr/share/augeas/lenses/dist/tests \
		"$subpkgdir"/usr/share/augeas/lenses/dist/
}

libs() {
	pkgdesc="Libraries for augeas"
	replaces="augeas"

	mkdir -p "$subpkgdir"/usr/ "$subpkgdir"/usr/share/augeas/
	mv "$pkgdir"/usr/lib "$subpkgdir"/usr/
	mv "$pkgdir"/usr/share/augeas/lenses \
		"$subpkgdir"/usr/share/augeas/
}

static() {
	pkgdesc="Static libraries for Augeas"

	mkdir -p "$subpkgdir"/usr/lib/
	mv "$pkgdir"/usr/lib/*.a "$subpkgdir"/usr/lib/
}

sha512sums="
fddb2e243f979e71fc09f9d45d569d6307b35485b2d885bf7bcbc032ba5617fe7ab2071a041422c3efe2dd62eda74aba41016d248c0636e947d4f1c9144375aa  augeas-1.14.1.tar.gz
9768878b2f8710436ef1eba7868c22b5eff1d2d549434bf76aced72ebdb4af4f769ea638dedf42ac9b617aaa53d1a767ed6b18868dd0bb3cf72cb3889f6d933a  fix-test.patch
899ec41a391a9910ffc778f40689e9751d362af7cb2a0c493d3712b8ae55de42203c7ff86d0229d95a1ad4b9271d2c9c7baf854f6655d44f1cc66f8f24b0ed7a  replace-bash-in-tests.patch
74d728abdf4d3eebdeb3823c1d2588c214fd52734c8855fe3ddbfb6465d31c88d093df356e42effdd3dbdff1a62c52894c7aa840bd6ea8df4995c4f3aa53e919  acf.aug
fe83e70ddeced87fea4c4dbdfb90b7497bc5fd01b6b097f0f49c52894b4dc1d93cf217ae7aa98abeaba0a9f8e8e18a1d426b6c203b318afde9cd5164cbe604b1  awall.aug
"
