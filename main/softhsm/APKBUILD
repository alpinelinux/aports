# Contributor: Frank Felhoffer <silveraid@hackme.ca>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=softhsm
pkgver=2.7.0
pkgrel=0
pkgdesc="cryptographic store accessible through a PKCS #11"
url="https://github.com/softhsm/SoftHSMv2"
arch="all"
license="BSD-2-Clause"
depends="sqlite"
checkdepends="cppunit-dev"
makedepends="
	autoconf
	automake
	libtool
	openssl-dev
	p11-kit-dev
	sqlite-dev
	"
subpackages="$pkgname-doc $pkgname-static"
source="softhsm-$pkgver.tar.gz::https://github.com/softhsm/SoftHSMv2/archive/refs/tags/$pkgver.tar.gz"
options="!check"  # hangs on the builders
builddir="$srcdir/SoftHSMv2-$pkgver"

prepare() {
	default_prepare
	autoreconf -vif
}

build() {
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--with-crypto-backend=openssl \
		--with-openssl=/usr \
		--with-sqlite3=/usr \
		--with-objectstore-backend-db
	make
}

check() {
	make check
	ldd src/lib/.libs/libsofthsm2.so
}

package() {
	make -j1 DESTDIR="$pkgdir/" install
}

sha512sums="
8f24d513cbc4bebe9e244dc1231409cd42ee38de3e1ad72f98e74231a5efdeb0bd9b08197ba7885318bc3d44ebd4c7afb36ca2e236875031147fba118278f277  softhsm-2.7.0.tar.gz
"
