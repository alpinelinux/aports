# Maintainer: Patrycja Rosa <alpine@ptrcnull.me>
pkgname=libclc
pkgver=21.1.8
pkgrel=0
# NOTE: Upgrade together with the whole LLVM suite.
_llvmver=${pkgver%%.*}
pkgdesc="Open source implementation of the library requirements of the OpenCL C programming language"
url="https://libclc.llvm.org/"
arch="all"
license="Apache-2.0 WITH LLVM-exception"
depends_dev="$pkgname=$pkgver-r$pkgrel"
makedepends="
	clang$_llvmver
	cmake
	llvm$_llvmver-dev
	llvm$_llvmver-static
	llvm$_llvmver-gtest
	python3
	samurai
	spirv-llvm-translator-dev
	"
checkdepends="llvm$_llvmver-test-utils"
subpackages="$pkgname-dev"
source="https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/libclc-$pkgver.src.tar.xz
	https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/cmake-$pkgver.src.tar.xz
	"
builddir="$srcdir/libclc-$pkgver.src"

build() {
	CC=clang-$_llvmver \
	CXX=clang++-$_llvmver \
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DLIBCLC_TARGETS_TO_BUILD="amdgcn--;amdgcn--amdhsa;amdgcn-mesa-mesa3d;r600--;nvptx--;nvptx64--;nvptx--nvidiacl;nvptx64--nvidiacl;spirv-mesa3d-;spirv64-mesa3d-" \
		-DLLVM_CONFIG="llvm-config-$_llvmver" \
		-DLLVM_SPIRV=/usr/bin/llvm-spirv \
		-DCMAKE_MODULE_PATH="$srcdir/cmake-$pkgver.src/Modules"
	cmake --build build
}

check() {
	cmake --build build --target test
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
920302f31833386cf7ebe995fc5578a764c99a6432ea58d94b55e84b7c0304275010d757a5c1cea76ee5cd73564bf4737960ab249995c5021b3dc4cc4c255922  libclc-21.1.8.src.tar.xz
7b2a8c1792f0f2c2efb9f5813bc6acd287e782eac0438e9303791f7ceefe75fb6a49c55ea2e1a3d741b2ee935023f9273c79f9d7321250b5e659d14a05ef9e63  cmake-21.1.8.src.tar.xz
"
