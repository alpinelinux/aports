# Maintainer: stef <l0ls0fo2i@ctrlc.hu>
# Contributor: Timo Ter√§s <timo.teras@iki.fi>

pkgname=emacs
pkgver=25.1
pkgrel=0
pkgdesc="The extensible, customizable, self-documenting real-time display editor"
arch="x86_64"
url="http://www.gnu.org/software/emacs/emacs.html"
license="GPL3"
depends="hicolor-icon-theme desktop-file-utils"
makedepends="autoconf automake linux-headers paxmark
	librsvg-dev giflib-dev libxpm-dev gtk+2.0-dev gconf-dev alsa-lib-dev
	imagemagick-dev glib-dev fontconfig-dev libpng-dev
	libxml2-dev pango-dev tiff-dev libjpeg-turbo-dev ncurses-dev
	ncurses-libs gnutls-dev libxaw-dev webkit2gtk-dev"
subpackages="$pkgname-doc $pkgname-nox $pkgname-x11 $pkgname-gtk2"
source="ftp://ftp.gnu.org/gnu/emacs/emacs-$pkgver.tar.xz
        gamedir.patch
        noaslr-dump.patch
        musl.patch"

_builddir="$srcdir/emacs-$pkgver"
prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build_x11() {
	cd "$_builddir/x11"
	./autogen.sh || return 1
	CFLAGS=-fno-pie \
	LDFLAGS=-no-pie \
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--libexecdir=/usr/lib \
		--localstatedir=/var \
		--without-makeinfo \
		--with-gameuser=:games \
      --with-x-toolkit=athena \
      --without-toolkit-scroll-bars \
		--without-dbus \
		--with-xft \
		--with-jpeg=yes \
		--with-tiff=yes \
		|| return 1
	make
}

build_gtk2() {
	cd "$_builddir/gtk2"
	./autogen.sh || return 1
	CFLAGS=-fno-pie \
	LDFLAGS=-no-pie \
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--libexecdir=/usr/lib \
		--localstatedir=/var \
		--without-makeinfo \
		--with-gameuser=:games \
		--with-x-toolkit=gtk2 \
		--with-xft \
		--with-jpeg=yes \
		--with-tiff=no \
		|| return 1
	make
}

build_nox() {
	cd "$_builddir/nox"
	./autogen.sh || return 1
	CFLAGS=-fno-pie \
	LDFLAGS=-no-pie \
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--libexecdir=/usr/lib \
		--localstatedir=/var \
		--without-makeinfo \
		--with-gameuser=:games \
		--without-sound \
		--without-x \
		--without-file-notification \
		|| return 1
	make
}

build() {
	cd "$_builddir"
	[[ -d nox ]] || {
      mkdir -p nox
	   mv * nox || true
	   cp -a nox gtk2
	   cp -a nox x11
   }
   build_nox
   build_x11
   build_gtk2
}

package() {
   mkdir -p "$pkgdir" && return 0
}

doc() {
   mkdir -p "$subpkgdir"
	cd "$_builddir/gtk2"
	make DESTDIR="$subpkgdir" install
	# remove conflict with ctags package
	mv "$subpkgdir"/usr/share/man/man1/ctags.1.gz "$subpkgdir"/usr/share/man/man1/ctags.emacs.1.gz
   # only keep info and man directories, all other is in the specific package
   rm -rf "$subpkgdir"/usr/bin
   rm -rf "$subpkgdir"/usr/bin
   rm -rf "$subpkgdir"/usr/lib
   rm -rf "$subpkgdir"/usr/share/appdata
   rm -rf "$subpkgdir"/usr/share/applications
   rm -rf "$subpkgdir"/usr/share/emacs
   rm -rf "$subpkgdir"/usr/share/icons
   rm -rf "$subpkgdir"/var
}

_subpackage() {
	cd "$_builddir/$1"
	make DESTDIR="$subpkgdir" install

	# remove conflict with ctags package
	mv "$subpkgdir"/usr/bin/ctags "$subpkgdir"/usr/bin/ctags.emacs
	rm -rf "$subpkgdir"/usr/share/info
	rm -rf "$subpkgdir"/usr/share/man

	# fix user/root permissions on usr/share files
	find "$subpkgdir"/usr/share/emacs/ -exec chown root:root {} \;
	find "$subpkgdir"/usr/lib -perm -g+s,g+x ! -type d -exec chmod g-s {} \;
	# fix perms on /var/games
	chmod 775 "$subpkgdir"/var/games
	chmod 775 "$subpkgdir"/var/games/emacs
	chmod 664 "$subpkgdir"/var/games/emacs/*
	chown -R root:games "$subpkgdir"/var/games
}

nox() {
   pkgdesc+=" - without X11"
	depends="!emacs-x11 !emacs-gtk2"
   _subpackage nox
}

x11() {
   pkgdesc+=" - with X11"
	depends="!emacs-nox !emacs-gtk2"
   _subpackage x11
}

gtk2() {
   pkgdesc+=" - with GTK2"
	depends="!emacs-nox !emacs-x11"
   _subpackage gtk2
}

md5sums="4f3d42fb22823a659e16bfa89078a74c  emacs-25.1.tar.xz
82a3275fba6535e129c08b6941caf028  gamedir.patch
0decc074823fc66f155dd9559420be3d  noaslr-dump.patch
d753f727439ba68ae848a72535b021a4  musl.patch"
sha256sums="19f2798ee3bc26c95dca3303e7ab141e7ad65d6ea2b6945eeba4dbea7df48f33  emacs-25.1.tar.xz
38b3cdf3736b200d033d9e6e9188bcaaf819bf7b47b3231a533cca370f945ee3  gamedir.patch
2af8d971caa73843fd1f6793dbc9b0fb701186dcb01845eac3c68373f4a570d1  noaslr-dump.patch
c6b6037fcc0abe3c973e9200ba6b9ad8e313b6bbd47a5d74a835892f0338c045  musl.patch"
sha512sums="67442b9027869c44430e1d4c3e92e74601e667c9aef7e3da16f20a562b5e3fa8c64efdd4b4055919550523093d32eac73c094b644f6573fed41b4e0938668922  emacs-25.1.tar.xz
7bd0acd610c07cb0cee2ceec8770c51b97e05a69c8c32e771f6ced83c1906bd87af842939a294a16757a4ad24e052228068944efa5adfc47776ca28b8da3555a  gamedir.patch
c04213a271008f7413677c95442188d744736abd28994aac616ac2e35924ca2a1c5cb55b95072e0011e891f1db054f07960b1753167f50c2e6d80d7c5b33e338  noaslr-dump.patch
c02bea143a221bc186e44f7eb12edb93d3d7564a39db656c888930ad69a6d40c86918bbe12acd2dbff19ff88a67a06a65e68467def8aa443e52d3b149d8ba2f2  musl.patch"
