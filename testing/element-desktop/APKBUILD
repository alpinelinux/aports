# Contributor: lauren n. liberda <lauren@selfisekai.rocks>
maintainer="lauren n. liberda <lauren@selfisekai.rocks>"
pkgname=element-desktop
pkgver=1.12.8
pkgrel=0
pkgdesc="Secure and independent communication, connected via Matrix"
url="https://element.io/"
arch="aarch64 x86_64" # same as electron
license="GPL-3.0-only"
_electronver=39
depends="
	electron~$_electronver
	font-inconsolata
	font-inter
	font-nunito
	font-opensans
	font-twemoji
	"
makedepends="
	cargo
	electron-dev~$_electronver
	electron-tasje
	jq
	libsecret-dev
	nodejs
	npm
	python3
	py3-setuptools
	sqlcipher-dev
	yarn
	"
source="
	https://github.com/vector-im/element-desktop/archive/refs/tags/v$pkgver/element-desktop-$pkgver.tar.gz
	https://github.com/vector-im/element-web/archive/refs/tags/v$pkgver/element-web-$pkgver.tar.gz

	add-alpine-targets.patch
	use-system-headers.patch
	tasje-fixes.patch
	no-source-maps.patch.web
	use-system-fonts.patch.web
	rollup-wasm.patch.web

	element-desktop
	"
options="net !check" # broken
# Avoid conflicting providers
sonameprefix="$pkgname:"

# secfixes:
#   1.11.30-r0:
#     - CVE-2023-30609
#   1.11.26-r0:
#     - CVE-2023-28103
#     - CVE-2023-28427
#   1.11.7-r0:
#     - CVE-2022-39249
#     - CVE-2022-39250
#     - CVE-2022-39251
#     - CVE-2022-39236
#   1.11.4-r0:
#     - CVE-2022-36059
#     - CVE-2022-36060

# used by buildscripts (at least web's webpack)
export VERSION=$pkgver

export CARGO_PROFILE_RELEASE_OPT_LEVEL=2
export CARGO_PROFILE_RELEASE_STRIP="symbols"
export NODE_OPTIONS="--openssl-legacy-provider"

prepare() {
	default_prepare

	msg "Applying more patches"
	for x in $source; do
		case "$x" in
		*.patch.web)
			msg "$x"
			patch -p1 -i "$srcdir"/$x -d "$srcdir"/element-web-$pkgver
			;;
		esac
	done

	rm -rf res/fonts

	(
		cd "$srcdir"/element-web-$pkgver

		msg "Fetch element-web dependencies"
		yarn install --frozen-lockfile --ignore-scripts --ignore-engines
		jq '.show_labs_settings = true' < config.sample.json > config.json
	)
	# install script
	(
		cd "$srcdir"/element-web-$pkgver/packages/shared-components
		yarn install --frozen-lockfile --ignore-scripts
	)
	# postinstall
	(
		cd "$srcdir"/element-web-$pkgver
		yarn run patch-package
	)

	ln -s "$srcdir"/element-web-$pkgver/webapp webapp

	msg "Fetch element-desktop dependencies"
	yarn install --frozen-lockfile --ignore-scripts
	yarn run patch-package
}

build() {
	(
		cd "$srcdir"/element-web-$pkgver/packages/shared-components
		yarn run patch-package
	)
	(
		cd "$srcdir"/element-web-$pkgver
		NODE_ENV=production yarn build:res
	)
	(
		cd "$srcdir"/element-web-$pkgver/packages/shared-components
		NODE_ENV=production node scripts/gatherTranslationKeys.ts
		NODE_ENV=production yarn run vite build
	)
	(
		cd "$srcdir"/element-web-$pkgver

		msg "Build element-web"
		NODE_ENV=production yarn build
	)

	msg "Build element-desktop"

	yarn asar-webapp

	# add "optional" native dependencies
	# hak stands for hack
	yarn run hak --target "$(uname -m)-alpine-linux-musl"

	yarn build:ts

	yarn build:res

	yarn install --frozen-lockfile --ignore-scripts --production

	tasje -c electron-builder.ts pack
}

check() {
	(
		cd "$srcdir"/element-web-$pkgver

		yarn test
	)
}

package() {
	local resources="dist/resources"

	install -Dm644 $resources/app.asar "$pkgdir"/usr/lib/element-desktop/app.asar
	install -Dm644 webapp.asar "$pkgdir"/usr/lib/element-desktop/webapp.asar

	install -Dm644 $resources/build/icon.png "$pkgdir"/usr/lib/element-desktop/build/icon.png

	install -Dm755 "$srcdir"/$pkgname "$pkgdir"/usr/bin/$pkgname

	install -Dm644 dist/$pkgname.desktop "$pkgdir"/usr/share/applications/$pkgname.desktop
	while read -r size; do
		install -Dm644 dist/icons/$size.png "$pkgdir"/usr/share/icons/hicolor/$size/apps/$pkgname.png
	done < dist/icons/size-list
}

sha512sums="
e5cacd02e8cfe7f8bbe146de6a6fe5db2383dbe32c5ba2b1f606b67157958f25d0eaabd53bcb28533efc7d76375399577bfc89db2aa5002cbf8b059d7271e7c0  element-desktop-1.12.8.tar.gz
c3920a84d144094f6a10b57ce00119b63772d9dc67a921c5cb94dc033680b5ad28304b049785f73169ec8fb478db9cc713a2bd66c896ed4a1ce6c977012d858d  element-web-1.12.8.tar.gz
4747893ed3e43d3074e9afe1cdd668a6be0de073d439205fe8c38c5e0f4091cc76e3cd15d98818bea5139add29501d8d07e83c58e9da230a4ce5bb538d388f80  add-alpine-targets.patch
755b17f7b828eb6920c06a6950ad4e14c32c99d22e9c05fcef7a081b5d2034adb03db3958aa5209c99fb7201f4d888c2383fc9864c5e743dd33f8b5c4925acd7  use-system-headers.patch
3dce5d3fe48b8f76e1e53c28090737a191f581ca2ad3d5a217d1f295a2667a0e4c9c5edab73f902dbf85e9342711d68d42f21d09c8cb4de31f95451f02eea41d  tasje-fixes.patch
ec635fde026f7fce8e8cc57960b5b9dcec4418416d4867ed47711422d48f068bb58a3c9ceb7715efc9c177beca3788da6b0babc9b689ea8c0724a0395f2b85f8  no-source-maps.patch.web
378a70e87e325091ac4770153d7eeba82684f4670797e6a73c4b623d8450ea7852e9fd28ac177e6b282e085b2940b43c68554a1466270ff9925e0c2e7aacfd51  use-system-fonts.patch.web
b1d2ae29325d945435ad7477b0f351d99503e5e2119e67674dfb69a51afb7297f707ce7f1b4404f31d84d9e9617ab08656c5d9692ed8412d6eef44e6ffb2c3b2  rollup-wasm.patch.web
afc588311dc3b566a754e3e7fe6b37b99a06d47b8bbce0ed9acca8ef308fdab0bd1d41b406199e5cbdd86bdce695ff847cd8668857a235cbdc292ad8b899c063  element-desktop
"
