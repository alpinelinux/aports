# Contributor: Lazy Walker <lazywalkerz@gmail.com>
# Maintainer: Lazy Walker <lazywalkerz@gmail.com>
pkgname=rgrc
pkgver=0.6.7
pkgrel=0
pkgdesc="Rusty Generic Colouriser - like grc but faster"
url="https://github.com/lazywalker/rgrc"
arch="all"
license="MIT"
options="net"
makedepends="cargo cargo-auditable"
subpackages="
	$pkgname-doc
	$pkgname-bash-completion
	$pkgname-fish-completion
	$pkgname-zsh-completion
	$pkgname-validator
"
source="https://github.com/lazywalker/rgrc/archive/v$pkgver/rgrc-$pkgver.tar.gz"

prepare() {
	default_prepare

	cargo fetch --target="$CHOST" --locked
}

build() {
	cargo auditable build --frozen --release --no-default-features

	local i; for i in bash fish zsh; do
		./target/release/rgrc --completions $i > target/$pkgname.$i
	done

	target/release/rgrc --all-aliases > target/rgrc.sh
	sed -E -i "s|/[^']*/rgrc|/usr/bin/rgrc|g" target/rgrc.sh
}

check() {
	cargo test --frozen
}

package() {
	install -Dm 0755 target/release/rgrc -t "$pkgdir"/usr/bin/
	install -Dm 0755 target/release/rgrv -t "$pkgdir"/usr/bin/
	install -Dm 0644 etc/rgrc.conf -t "$pkgdir"/etc/
	install -Dm 0755 target/rgrc.sh -t "$pkgdir"/etc/profile.d/
	install -Dm 0644 share/conf.* -t "$pkgdir"/usr/share/"$pkgname"/

	install -Dm 0644 doc/rgrc.1 -t "$pkgdir"/usr/share/man/man1/
	install -Dm 0644 LICENSE -t "$pkgdir"/usr/share/licenses/"$pkgname"/

	install -D -m644 target/$pkgname.bash "$pkgdir"/usr/share/bash-completion/completions/$pkgname
	install -D -m644 target/$pkgname.fish "$pkgdir"/usr/share/fish/vendor_completions.d/$pkgname.fish
	install -D -m644 target/$pkgname.zsh "$pkgdir"/usr/share/zsh/site-functions/_$pkgname
}

validator() {
	pkgdesc="$pkgname Configuration Validator"
	depends="$pkgname=$pkgver-r$pkgrel"

	amove usr/bin/rgrv
}

sha512sums="
5daf1f64f083e27e40ba950ae78393c6b488ad1c44c2ea7e5703836b146c080ca9c9781a806295fa736edbc4addde66d0bc3660416098f6c2592e19e4a84d73d  rgrc-0.6.7.tar.gz
"
