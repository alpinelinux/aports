# Contributor: Lazy Walker <lazywalkerz@gmail.com>
# Maintainer: Lazy Walker <lazywalkerz@gmail.com>
pkgname=rgrc
pkgver=0.6.8
pkgrel=0
pkgdesc="Rusty Generic Colouriser - like grc but faster"
url="https://github.com/lazywalker/rgrc"
arch="all"
license="MIT"
options="net"
makedepends="cargo cargo-auditable"
subpackages="
	$pkgname-doc
	$pkgname-bash-completion
	$pkgname-fish-completion
	$pkgname-zsh-completion
	$pkgname-validator
"
source="https://github.com/lazywalker/rgrc/archive/v$pkgver/rgrc-$pkgver.tar.gz"

prepare() {
	default_prepare

	cargo fetch --target="$CHOST" --locked
}

build() {
	cargo auditable build --frozen --release --no-default-features

	local i; for i in bash fish zsh; do
		./target/release/rgrc --completions $i > target/$pkgname.$i
	done

	target/release/rgrc --all-aliases > target/rgrc.sh
	sed -E -i "s|/[^']*/rgrc|/usr/bin/rgrc|g" target/rgrc.sh
}

check() {
	cargo test --frozen
}

package() {
	install -Dm 0755 target/release/rgrc -t "$pkgdir"/usr/bin/
	install -Dm 0755 target/release/rgrv -t "$pkgdir"/usr/bin/
	install -Dm 0644 etc/rgrc.conf -t "$pkgdir"/etc/
	install -Dm 0755 target/rgrc.sh -t "$pkgdir"/etc/profile.d/
	install -Dm 0644 share/conf.* -t "$pkgdir"/usr/share/"$pkgname"/

	install -Dm 0644 doc/rgrc.1 -t "$pkgdir"/usr/share/man/man1/
	install -Dm 0644 LICENSE -t "$pkgdir"/usr/share/licenses/"$pkgname"/

	install -D -m644 target/$pkgname.bash "$pkgdir"/usr/share/bash-completion/completions/$pkgname
	install -D -m644 target/$pkgname.fish "$pkgdir"/usr/share/fish/vendor_completions.d/$pkgname.fish
	install -D -m644 target/$pkgname.zsh "$pkgdir"/usr/share/zsh/site-functions/_$pkgname
}

validator() {
	pkgdesc="$pkgname Configuration Validator"
	depends="$pkgname=$pkgver-r$pkgrel"

	amove usr/bin/rgrv
}

sha512sums="
8eea80eb16d9ad2cc8893e87fa8d259bb63de9dd3011c96bc3b9b4fd2e313aa9bd4d2dbe0d7f4b592d6ed694c7720213dd0b5bc31a0a213f13ef0459bee3f045  rgrc-0.6.8.tar.gz
"
