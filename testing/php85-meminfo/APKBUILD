# Contributor: Andy Postnikov <apostnikov@gmail.com>
# Maintainer: Andy Postnikov <apostnikov@gmail.com>
pkgname=php85-meminfo
_extname=meminfo
pkgver=2.0.0_git20220525
_commit=0ab7f5aea96c4dafce27c7e215b4907db2a2f493
pkgrel=0
pkgdesc="Extension to get insight about memory usage for PHP 8.5"
url="https://github.com/BitOne/php-meminfo"
arch="all"
license="MIT"
_phpv=85
_php=php$_phpv
depends="$_php-common"
_clang_ver=21
makedepends="$_php-dev $_php-apcu clang$_clang_ver"
source="php-$_extname-$pkgver.tar.gz::https://github.com/BitOne/php-meminfo/archive/$_commit.tar.gz
	fix-build.patch
	fix-clang.patch
	"
builddir="$srcdir/php-$_extname-$_commit/extension"

build() {
	phpize$_phpv
	CC=clang-$_clang_ver CXX=clang++-$_clang_ver \
	./configure \
		--prefix=/usr \
		--with-php-config=php-config$_phpv
	make
}

check() {
	local _modules=/usr/lib/$_php/modules
	make NO_INTERACTION=1 REPORT_EXIT_STATUS=1 test \
		SKIP_ONLINE_TESTS=1 PHP_TEST_SHARED_EXTENSIONS=" \
		-d extension=$_modules/apcu.so \
		-d extension=modules/$_extname.so" TESTS=--show-diff
	$_php -d extension=modules/$_extname.so --ri $_extname
}

package() {
	make INSTALL_ROOT="$pkgdir"/ install
	local confdir="$pkgdir"/etc/$_php/conf.d
	install -d $confdir
	echo "extension=$_extname" > $confdir/50_$_extname.ini
}

sha512sums="
5eb464daa691cc8310e2b1828a2651b2321ca4cd69d55b09f674587bf344c84c0f988d7a9b645e60a702cf5ef0083905942a2ce95fae3657ab85579021230537  php-meminfo-2.0.0_git20220525.tar.gz
d5c27c02accaee169d7e778024ad8cee81214957ca2dc81d9919889174f7a5ae5531cdf7ac7f3c8e1c6a8621007b37f8f580b52770d7893da8be3e2b2ac3e320  fix-build.patch
6d419ccb60b6cdc5c9a3b9c1bf63bf1b2053396c15529bbd1398bc77d52654673a35269b7714655d943b08906c865dcc156e8a68884ce45f4d86be91bb3523c5  fix-clang.patch
"
