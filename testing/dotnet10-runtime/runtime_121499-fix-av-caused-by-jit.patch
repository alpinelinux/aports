From d8c1745c6ab7a28c03e799df7f04401ae7312582 Mon Sep 17 00:00:00 2001
From: "github-actions[bot]"
 <41898282+github-actions[bot]@users.noreply.github.com>
Date: Wed, 12 Nov 2025 11:46:21 +0000
Subject: [PATCH] [release/10.0] JIT: fix AV caused by JIT (#121499)

Backport of #120575 to release/10.0

/cc @AndyAyersMS

## Customer Impact

- [x] Customer reported
- [ ] Found internally

Reported by customer in https://github.com/dotnet/runtime/issues/120522

## Regression

- [ ] Yes
- [x] No

Similar problem exists in .NET 8 and .NET 9. I intend to backport this
fix there if we fix this in .NET 10.

## Testing

Verified on the test case from the issue.

## Risk

Low. The JIT special cases return type deductions for `Array.Clone`, and
this issue only triggers if the argument to `Array.Clone` is a byref.
The fix is a bit more general but is mainly defensive, handling cases
where return type deductions fail.

Co-authored-by: Andy Ayers <andya@microsoft.com>
---
 src/coreclr/jit/fginline.cpp                  | 19 +++++-----
 src/coreclr/jit/importercalls.cpp             |  4 ++
 .../JitBlue/Runtime_120522/Runtime_120522.cs  | 38 +++++++++++++++++++
 .../Runtime_120522/Runtime_120522.csproj      |  9 +++++
 4 files changed, 61 insertions(+), 9 deletions(-)
 create mode 100644 src/tests/JIT/Regression/JitBlue/Runtime_120522/Runtime_120522.cs
 create mode 100644 src/tests/JIT/Regression/JitBlue/Runtime_120522/Runtime_120522.csproj

diff --git a/src/runtime/src/coreclr/jit/fginline.cpp b/src/runtime/src/coreclr/jit/fginline.cpp
index 67773bbe865762..bd3b3c84e2c90f 100644
--- a/src/runtime/src/coreclr/jit/fginline.cpp
+++ b/src/runtime/src/coreclr/jit/fginline.cpp
@@ -701,20 +701,21 @@ class SubstitutePlaceholdersAndDevirtualizeWalker : public GenTreeVisitor<Substi
             // we may be able to sharpen the type for the local.
             if (tree->TypeIs(TYP_REF))
             {
-                LclVarDsc* lcl = m_compiler->lvaGetDesc(lclNum);
+                LclVarDsc* const lcl = m_compiler->lvaGetDesc(lclNum);
 
                 if (lcl->lvSingleDef)
                 {
-                    bool                 isExact;
-                    bool                 isNonNull;
-                    CORINFO_CLASS_HANDLE newClass = m_compiler->gtGetClassHandle(value, &isExact, &isNonNull);
-
-                    if (newClass != NO_CLASS_HANDLE)
+                    if (lcl->lvClassHnd == NO_CLASS_HANDLE)
+                    {
+                        m_compiler->lvaSetClass(lclNum, value);
+                    }
+                    else
                     {
-                        m_compiler->lvaUpdateClass(lclNum, newClass, isExact);
-                        m_madeChanges                    = true;
-                        m_compiler->hasUpdatedTypeLocals = true;
+                        m_compiler->lvaUpdateClass(lclNum, value);
                     }
+
+                    m_madeChanges                    = true;
+                    m_compiler->hasUpdatedTypeLocals = true;
                 }
             }
 
diff --git a/src/runtime/src/coreclr/jit/importercalls.cpp b/src/runtime/src/coreclr/jit/importercalls.cpp
index 7db020168b0abb..838d7ca6de0b65 100644
--- a/src/runtime/src/coreclr/jit/importercalls.cpp
+++ b/src/runtime/src/coreclr/jit/importercalls.cpp
@@ -6962,6 +6962,10 @@ class SpillRetExprHelper
             {
                 comp->lvaSetClass(tmp, retClsHnd, isExact);
             }
+            else
+            {
+                JITDUMP("Could not deduce class from [%06u]", comp->dspTreeID(retExpr));
+            }
         }
     }
 
diff --git a/src/runtime/src/tests/JIT/Regression/JitBlue/Runtime_120522/Runtime_120522.cs b/src/runtime/src/tests/JIT/Regression/JitBlue/Runtime_120522/Runtime_120522.cs
new file mode 100644
index 00000000000000..155b2f164b19f5
--- /dev/null
+++ b/src/runtime/src/tests/JIT/Regression/JitBlue/Runtime_120522/Runtime_120522.cs
@@ -0,0 +1,38 @@
+// Licensed to the .NET Foundation under one or more agreements.
+// The .NET Foundation licenses this file to you under the MIT license.
+
+using System;
+using System.Runtime.CompilerServices;
+using System.Threading;
+using Xunit;
+
+public class Runtime_120522
+{
+    static System.Collections.ArrayList array = [];
+
+    static void Problem(ref object[]? a)
+    {
+        a = new object[1];
+        array.Add(a.Clone());
+    }
+
+    [Fact]
+    [MethodImpl(MethodImplOptions.NoOptimization)]
+    public static int Test()
+    {
+        int i = 0;
+        while (i < 200_000)
+        {
+            object[]? a = null;
+            Problem(ref a);
+            i++;
+
+            if (i % 10_000 == 0)
+            {
+                Thread.Sleep(200);
+            }
+        }
+        
+        return i / 2000;
+    }
+}
diff --git a/src/runtime/src/tests/JIT/Regression/JitBlue/Runtime_120522/Runtime_120522.csproj b/src/runtime/src/tests/JIT/Regression/JitBlue/Runtime_120522/Runtime_120522.csproj
new file mode 100644
index 00000000000000..501217e4d86892
--- /dev/null
+++ b/src/runtime/src/tests/JIT/Regression/JitBlue/Runtime_120522/Runtime_120522.csproj
@@ -0,0 +1,9 @@
+<Project Sdk="Microsoft.NET.Sdk">
+  <PropertyGroup>
+    <DebugType>None</DebugType>
+    <Optimize>True</Optimize>
+  </PropertyGroup>
+  <ItemGroup>
+    <Compile Include="$(MSBuildProjectName).cs" />
+  </ItemGroup>
+</Project>
