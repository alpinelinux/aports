# Maintainer: Willow Barraco <contact@willowbarraco.fr>
pkgname=unbound-hosts
pkgver=3.16.57
pkgrel=0
pkgdesc="Unbound hosts configs to ad-block well-curated sources"
url="https://github.com/StevenBlack/hosts"
arch="noarch"
license="MIT"
options="!check" # No tests
_alternates="
	$pkgname-fakenews:alternate
	$pkgname-gambling:alternate
	$pkgname-porn:alternate
	$pkgname-social:alternate
"
subpackages="
	$_alternates
	$pkgname-doc
"
source="$pkgname-$pkgver.tar.gz::https://github.com/StevenBlack/hosts/archive/refs/tags/$pkgver.tar.gz"
builddir="$srcdir/hosts-$pkgver"

build() {
	_build_file < hosts > hosts.unbound
	for subpackage in $_alternates; do
		_subpkgname="${subpackage%:alternate}"
		_build_file < "alternates/${_subpkgname#"$pkgname"-}-only/hosts" > "${_subpkgname#"$pkgname"-}.unbound"
	done
}

package() {
	install -Dm644 hosts.unbound "$pkgdir/etc/unbound/unbound.conf.d/50-hosts.conf"
	install -Dm644 license.txt "$pkgdir/usr/share/doc/$pkgname/LICENSE"
	for subpackage in $_alternates; do
		_subpkgname="${subpackage%:alternate}"
		install -Dm644 "${_subpkgname#"$pkgname"-}.unbound" "$pkgdir/etc/unbound/unbound.conf.d/50-hosts-${_subpkgname#"$pkgname"-}.conf"
	done
}

alternate() {
	depends="unbound"
	amove "etc/unbound/unbound.conf.d/50-hosts-${subpkgname#"$pkgname"-}.conf"
}

_build_file() {
	echo "server:"
	grep ^0.0.0.0 - | \
		sed 's/ #.*$//;
		s/^0.0.0.0 \(.*\)/local-zone: "\1" refuse/'
}

sha512sums="
e7859ae721c7656e1ee0f5dac86be67440877ae32fb4ca19c88ba7543de75a62cfb98fcda7313644d77196de63bf23888a79ea0c076cfdb5e80a88504b97fa52  unbound-hosts-3.16.57.tar.gz
"
