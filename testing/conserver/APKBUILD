# Contributor: Henrik Riomar <henrik.riomar@gmail.com>
# Maintainer: Henrik Riomar <henrik.riomar@gmail.com>
pkgname=conserver
pkgver=8.2.7
pkgrel=0
pkgdesc="Serial console remote sharing and logging daemon"
url="https://www.conserver.com"
arch="all"
license="BSD-3-Clause AND BSD-4-Clause"
options="!check"
checkdepends="bash"
subpackages="$pkgname-doc $pkgname-openrc"

# conserver.cf is from Debian
source="https://github.com/bstansell/conserver/releases/download/v$pkgver/conserver-$pkgver.tar.gz
	conserver.cf
	conserver.initd
	Don-t-reference-true.patch
	"

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc/$pkgname \
		--mandir=/usr/share/man \
		--with-pidfile=/run/$pkgname.pid \
		--with-logfile=/var/log/$pkgname.log \
		--with-port=782
	make
}

check() {
	make -j1 test
}

package() {
	make DESTDIR="$pkgdir" install

	install -Dm755 "$srcdir"/conserver.initd "$pkgdir"/etc/init.d/$pkgname
	install -Dm644 "$srcdir"/conserver.cf "$pkgdir"/etc/conserver/$pkgname.cf

	# console log directory
	install -dm770 "$pkgdir"/var/log/$pkgname

	# Move examples to -doc subpackage.
	mkdir -p "$pkgdir"/usr/share/doc/$pkgname
	rm $pkgdir/usr/share/examples/$pkgname/conserver.rc
	mv $pkgdir/usr/share/examples/$pkgname $pkgdir/usr/share/doc/$pkgname/examples
	rmdir $pkgdir/usr/share/examples
}

sha512sums="
b9a63061c149d7c400ba28fbeb290572e3893cb56d3abcfd2d32fdda3e35bdb5f7fba4ba742aed2ad945749ee54a36e21ab1af096428113eb242d3a1a946b353  conserver-8.2.7.tar.gz
3d531e7e41ef25a69a9ce06cd4f885da6bf7e10c8a277b8350ef31813710dfd1d04a6f1d1cb5b4d4c8470910d4badbbd684ae8aa6e1b71451f3e5175037be16c  conserver.cf
32d4e6f0572eb01462bd2c4e1f6642c59a947e6b22125ae0067f084c14cb0e5761c03837c6e8c45180b3af748afe86fc9ce9f599c37efca920983217968c23d3  conserver.initd
c127a2032a212575b2e58bcb176211585366f29cf5dceeeda99ae6de5bf74eaf5f550f47d13c2ba43b78087f21973598a7010ede9b852cf0102730fbd45171bc  Don-t-reference-true.patch
"
