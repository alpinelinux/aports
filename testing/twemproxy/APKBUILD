# Maintainer: Yagnesh Mistry <ysh@live.in>

pkgname=twemproxy
akaname=nutcracker
pkgver=0.4.1
pkgrel=0
pkgdesc="A fast, light-weight proxy for memcached and redis"
url="https://github.com/twitter/twemproxy"
arch="all"
license="Apache-2.0"
depends=""
depends_dev=""
makedepends="automake autoconf libtool yaml-dev"
subpackages="$pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/twitter/twemproxy/archive/v$pkgver.tar.gz
	nutcracker.initd
	nutcracker.confd
	use-system-libyaml.patch
	"

builddir="$srcdir"/$pkgname-$pkgver
_logdir=/var/log/$akaname
_rundir=/var/run/$akaname

prepare() {
	local i
	cd "$builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i;;
		esac
	done
}

build() {
	cd "$builddir"
	autoreconf -vif
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr
	make
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir" install
	install -m644 -D "$srcdir"/$pkgname-$pkgver/conf/nutcracker.yml \
		"$pkgdir"/etc/$akaname/nutcracker.yml
        install -m644 -D "$srcdir"/$pkgname-$pkgver/conf/nutcracker.leaf.yml \
		"$pkgdir"/etc/$akaname/nutcracker.leaf.yml
        install -m644 -D "$srcdir"/$pkgname-$pkgver/conf/nutcracker.root.yml \
		"$pkgdir"/etc/$akaname/nutcracker.root.yml
	install -m755 -D "$srcdir"/$akaname.initd \
		"$pkgdir"/etc/init.d/$akaname
	install -m644 -D "$srcdir"/$akaname.confd \
		"$pkgdir"/etc/conf.d/$akaname

	install -m0755 -d "$pkgdir"/$_rundir
	install -m0755 -d "$pkgdir"/$_logdir

	_docs="README.md NOTICE ChangeLog"
	for _doc in $_docs; do
		install -m644 -D "$srcdir"/$pkgname-$pkgver/$_doc \
			"$pkgdir"/usr/share/doc/$akaname/$_doc
	done

	install -m644 -D "$srcdir"/$pkgname-$pkgver/LICENSE \
		"$pkgdir"/usr/share/licenses/$akaname/LICENSE

}

sha512sums="581fae1d12feb983ed25b22cd6f597fd28b7070906ac29d3990669ae5c626a468914021cee152a6a2299a2838c838ad907e4c911b911ef04166ac7bbb2982da1  twemproxy-0.4.1.tar.gz
56bc051eac972cc1e4cfb334673f8e4c8a5f0855fb4f0b66e05a148855dae34870d949a5d19c111d072a0405b2014a334151ad9414a40fdc67e559ff37d68093  nutcracker.initd
e69e6d7b48a360b8b7b7ec7d7d46e2c736c4e30e6d6a22ed5b01d64ccb3ec701537545b2b6e5c1cbf2ba9f657f86e7a94686e3dc8a43dcba9688695717d62f12  nutcracker.confd
beadf407de53378bfe0ee12bbdf2315bde220a322aa13fc1993b487e1503f8825280408c500c902db683ee35b255e304acfe2cb011a6e9ffe02cdbfcfb1d2bf5  use-system-libyaml.patch"
