# Contributor: Mark Riedesel <mark@klowner.com>
# Maintainer: Mark Riedesel <mark@klowner.com>
pkgname=openimageio
pkgver=1.6.14
pkgrel=0
pkgdesc="Image i/o library supporting a multitude of image formats"
url="https://sites.google.com/site/openimageio/"
arch="all"
license="BSD"
depends=""
makedepends="cmake giflib-dev zlib-dev boost-dev jpeg-dev libpng-dev tiff-dev
	glew-dev python-dev>=2.6 python3-dev openexr-dev ffmpeg2.8-dev libraw-dev libwebp-dev freetype-dev
	qt-dev mesa-dev openssl-dev jasper-dev opencolorio-dev"
install=""
subpackages="py2-$pkgname:_python py3-$pkgname:_python $pkgname-dev $pkgname-doc $pkgname-tools"
source="$pkgname-$pkgver.tar.gz::https://github.com/OpenImageIO/oiio/archive/Release-${pkgver}.tar.gz
	nocpp-error.patch"

builddir="$srcdir"/oiio-Release-$pkgver

build() {
	local py2path=$(python2 -c 'import site; print(site.getsitepackages()[0])')
	local py3path=$(python3 -c 'import site; print(site.getsitepackages()[0])')

	cd "$builddir"
	mkdir build && cd build
	cmake .. \
		-DUSE_OPENSSL=ON \
		-DUSE_PYTHON=ON \
		-DUSE_PYTHON3=ON \
		-DUSE_NUKE=OFF \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DPYLIB_INSTALL_DIR=$py2path \
		-DPYLIB3_INSTALL_DIR=$py3path \
		-DOIIO_BUILD_TESTS=OFF \
		-DOIIO_BUILD_TOOLS=ON \
		|| return 1
	make
}

package() {
	cd "$builddir"/build
	make DESTDIR="$pkgdir" install || return 1
	rm -rf "$pkgdir"/usr/share/fonts*
}

tools() {
	pkgdesc="Tools for manipulating a multitude of image formats"
	mkdir -p "$subpkgdir"/usr
	mv "$pkgdir"/usr/bin "$subpkgdir"/usr/
}

_python() {
	local pyver=${subpkgname:2:1}
	local pypath=$(python$pyver -c 'import site; print(site.getsitepackages()[0])')
	pkgdesc="Python $pyver bindings for OpenImageIO image i/o library"
	depends="python$pyver"
	mkdir -p "$subpkgdir"$pypath
	mv "$pkgdir"$pypath/* "$subpkgdir"$pypath/
}

md5sums="cd8af592f3c4223b3ac0d67d116beda9  openimageio-1.6.14.tar.gz
d8e50591ad22e5cf924e8b99a824f83c  nocpp-error.patch"
sha256sums="40a477a88426838d8ac8a2303b92861e39665ca4b00d4f4e40a31143c7ba2097  openimageio-1.6.14.tar.gz
217eec2044a1c4005964121bcbeedb8fd5a742fb8e6ce6c2087cc3001c73c974  nocpp-error.patch"
sha512sums="2f4f219e7fa372fe6e41dfb4d4938ee990f99c1788856adfdd4e752393bd6f0d6928f72162d6147bcbe02df705fe96078ec790c7886f8513c82257e6264309e5  openimageio-1.6.14.tar.gz
43d25e57145dc589821a11a08d3137649ea468e65fe617e642c72d64a3cb22d42b6204547290210afd836f9035a8a3fb337fe6825d6ad4127c130e1ecf3f87a9  nocpp-error.patch"
