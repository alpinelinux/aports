maintainer="Achill Gilgenast <achill@achill.org>"
pkgname=mautrix-linkedin
pkgver=0.2511.0
pkgrel=1
pkgdesc="Matrix-Linkedin puppeting bridge"
url="https://docs.mau.fi/bridges/go/linkedin/"
arch="all"
license="AGPL-3.0-or-later"
makedepends="
	go
	olm-dev
	sqlite-dev
	"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc $pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/mautrix/linkedin/archive/v$pkgver.tar.gz
	mautrix-linkedin.initd
	mautrix-linkedin.confd
	"
builddir="$srcdir/linkedin-$pkgver"
options="net" # go

export GOFLAGS="$GOFLAGS -tags=libsqlite3"

build() {
	export CGO_CFLAGS="$CFLAGS"
	export CGO_LDFLAGS="$LDFLAGS"

	go build \
		-ldflags "-X main.Tag=$pkgver -X 'main.BuildTime=$(date -d @"$SOURCE_DATE_EPOCH" '+%b %_d %Y, %H:%M:%S')'" \
		./cmd/mautrix-linkedin

	./mautrix-linkedin -e
}

check() {
	go test -v ./...
}

package() {
	install -Dm755 mautrix-linkedin \
		-t "$pkgdir"/usr/bin/
	install -Dm644 config.yaml \
		-t "$pkgdir"/etc/mautrix-linkedin/

	install -Dm755 "$srcdir"/mautrix-linkedin.initd \
		"$pkgdir"/etc/init.d/mautrix-linkedin
	install -Dm644 "$srcdir"/mautrix-linkedin.confd \
		"$pkgdir"/etc/conf.d/mautrix-linkedin

	install -Dm644 LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}


sha512sums="
27a58ec108f1f486676de095467fe4fc0a852e7a39d32c29467dc5eea899a90c551db0a61e3d3a1a768fe036ca511c59f6184623c9c7de0caec7917ad58f38f6  mautrix-linkedin-0.2511.0.tar.gz
8dbefc55535ad17dc4ae332c765a1c139cf8db5fb8bbc7fed0f5b4eaf910d90fa65d30ff3d05cda58f0f4e394db2b2219a7cb2fa35771fbcabc97719a7959af8  mautrix-linkedin.initd
397c9d8f5354451dbc5f440e561e4c80c7681ce899f1a05f7583a41ff2976e1d512045babe355b69503d1fa1788caff74dc77e42dc340bca4e0a9221a14e9fdf  mautrix-linkedin.confd
"
