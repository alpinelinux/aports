# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>
pkgname=mongo-c-driver
pkgver=1.14.0
pkgrel=0
pkgdesc="Client library written in C for MongoDB"
url="https://github.com/mongodb/mongo-c-driver"
arch="all"
license="Apache-2.0"
makedepends="openssl-dev snappy-dev zlib-dev libtool py3-sphinx cmake"
subpackages="$pkgname-static $pkgname-dev $pkgname-doc libbson"
source="https://github.com/mongodb/$pkgname/releases/download/$pkgver/$pkgname-$pkgver.tar.gz"
builddir="$srcdir/$pkgname-$pkgver"

build() {
	mkdir -p "$srcdir"/build
	cd "$srcdir"/build
	cmake \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DENABLE_BSON:STRING=ON \
		-DENABLE_MONGOC:BOOL=ON \
		-DENABLE_SSL:STRING=OPENSSL \
		-DENABLE_AUTOMATIC_INIT_AND_CLEANUP:BOOL=OFF \
		-DENABLE_MAN_PAGES:BOOL=ON \
		-DENABLE_TESTS:BOOL=ON \
		-DENABLE_EXAMPLES:BOOL=OFF \
		-DSPHINX_EXECUTABLE:STRING=/usr/bin/sphinx-build-3 \
		-DCMAKE_SKIP_RPATH=ON \
		"$builddir"
	make
}

check() {
	cd "$srcdir"/build
	export MONGOC_TEST_SKIP_MOCK=on
	export MONGOC_TEST_SKIP_SLOW=on
	export MONGOC_TEST_SKIP_LIVE=on
	make check
}

package() {
	cd "$srcdir"/build
	make DESTDIR="$pkgdir" install

	# removes COPYING, NEWS, README, uninstall script
	rm -rf "$pkgdir/usr/share/mongo-c-driver"
}

libbson() {
	pkgdesc="Building, parsing, and iterating BSON documents"
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libbson-* "$subpkgdir"/usr/lib/
}

sha512sums="99ca4001341d044a8ffc02a5d7175d40f8a998bdaad15a668a7db0558fa616ec18152faeda6da7f28b34c5d2cf4b649180c9390d2229e1342b6c4f6742816994  mongo-c-driver-1.14.0.tar.gz"
