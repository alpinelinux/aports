# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>
pkgname="mongo-c-driver"
pkgver="1.14.0"
pkgrel=1
pkgdesc="Client library written in C for MongoDB"
url="https://github.com/mongodb/mongo-c-driver"
arch="all"
license="Apache-2.0"
depends_dev="${pkgname} cyrus-sasl-dev icu-dev openssl-dev" 
makedepends="${depends_dev} cmake py3-sphinx"
subpackages="${pkgname}-libs-static ${pkgname}-libs ${pkgname}-dev ${pkgname}-doc"
source="${pkgname}-${pkgver}.tar.gz::https://github.com/mongodb/${pkgname}/archive/${pkgver}.tar.gz"

build() {
	cmake \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX:PATH=/usr \
		-DCMAKE_INSTALL_LIBDIR:PATH=lib \
		-DENABLE_BSON:STRING=ON \
		-DENABLE_MONGOC:BOOL=ON \
		-DENABLE_SSL:STRING=OPENSSL \
		-DENABLE_AUTOMATIC_INIT_AND_CLEANUP:BOOL=OFF \
		-DENABLE_MAN_PAGES:BOOL=ON \
		-DENABLE_TESTS:BOOL=ON \
		-DENABLE_EXAMPLES:BOOL=OFF \
		-DSPHINX_EXECUTABLE:STRING=/usr/bin/sphinx-build-3 \
		-DCMAKE_SKIP_RPATH:BOOL=ON \
		-DENABLE_SHM_COUNTERS:BOOL=ON \
		-DENABLE_SASL:STRING=CYRUS \
		-DENABLE_ICU:STRING=ON \
		-DENABLE_CRYPTO_SYSTEM_PROFILE:BOOL=ON \
		-DENABLE_UNINSTALL:BOOL=OFF \
		-DBUILD_VERSION:STRING=${pkgver} \
		.
	make
}

check() {
	export MONGOC_TEST_SKIP_MOCK=on
	export MONGOC_TEST_SKIP_SLOW=on
	export MONGOC_TEST_SKIP_LIVE=on
	make check
}

package() {
	make DESTDIR="${pkgdir}" install
	mkdir "${pkgdir}/usr/share/doc"
	mv "${pkgdir}/usr/share/${pkgname}" "${pkgdir}/usr/share/doc"
}

dev() {
    default_dev

    # remove empty /usr/lib
    rmdir "${pkgdir}/usr/lib"
}

sha512sums="bf2bb835543dd2a445aac6cafa7bbbf90921ec41014534779924a5eb7cbd9fd532acd8146ce81dfcf1bcac33a78d8fce22b962ed7f776449e4357eccab8d6110  mongo-c-driver-1.14.0.tar.gz"
