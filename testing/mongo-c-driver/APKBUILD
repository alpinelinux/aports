# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>
pkgname=mongo-c-driver
pkgver=1.13.0
pkgrel=0
pkgdesc="Client library written in C for MongoDB"
url="https://github.com/mongodb/mongo-c-driver"
arch="all !x86 !armhf !armv7" # testsuite fails on x86 and armhf
license="Apache-2.0"
depends_dev="libressl-dev snappy-dev zlib-dev"
makedepends="$depends_dev cmake libtool py3-sphinx"
subpackages="$pkgname-dev $pkgname-doc"
source="https://github.com/mongodb/$pkgname/releases/download/$pkgver/$pkgname-$pkgver.tar.gz
	remove-uninstall.patch
	"
builddir="$srcdir/$pkgname-$pkgver"

case "$CARCH" in
	# FIXME: Tests hang on aarch64.
	aarch64) options="!check";;
esac

build() {
	cd "$builddir"
	mkdir -p cmake-build
	cd cmake-build
	cmake \
		-DENABLE_AUTOMATIC_INIT_AND_CLEANUP=OFF \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DENABLE_SSL=LIBRESSL \
		-DSPHINX_EXECUTABLE=/usr/bin/sphinx-build-3 \
		-DENABLE_MAN_PAGES=ON \
		-DENABLE_TESTS=ON \
		-DENABLE_BSON=AUTO \
		-DENABLE_ZLIB=SYSTEM \
		-DENABLE_EXAMPLES=OFF \
		..
}

check() {
	cd "$builddir"/cmake-build
	MONGOC_TEST_SKIP_LIVE=on make check
}

package() {
	cd "$builddir"/cmake-build
	make DESTDIR="$pkgdir" install
}

sha512sums="01b17857a1cb843b133975594772c094edecb6c149d8628eaa42de1855152185114186d0e8d829e99c9106c133018b1242e34e3ac511a36b2b7a38baea5f5aba  mongo-c-driver-1.13.0.tar.gz
736f6cf8fe4be752a8f01e11c7bac1103d57f07f482510a0db03d11fca7336adb0fc8359a8c45086b8fff90ca4af4dae9135efba1784cb84d652b0fe0f779b11  remove-uninstall.patch"
