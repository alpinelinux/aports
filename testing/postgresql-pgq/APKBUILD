# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=postgresql-pgq
pkgver=3.5.1
pkgrel=0
pkgdesc="Generic Queue for PostgreSQL"
url="https://github.com/pgq/pgq"
arch="all"
license="ISC"
makedepends="
	postgresql-dev
	python3
	"
subpackages="$pkgname-bitcode"
source="https://github.com/pgq/pgq/archive/v$pkgver/pgq-$pkgver.tar.gz"
builddir="$srcdir/pgq-$pkgver"
options="!check"  # tests require running PostgreSQL

build() {
	make USE_PGXS=1
}

package() {
	_pgver=$(pg_config --major-version)
	depends="postgresql$_pgver"

	make USE_PGXS=1 DESTDIR="$pkgdir" install
}

bitcode() {
	_pgver=$(pg_config --major-version)
	pkgdesc="$pkgdesc (bitcode for JIT)"
	depends="$pkgname=$pkgver-r$pkgrel"
	install_if="postgresql$_pgver-jit $pkgname=$pkgver-r$pkgrel"

	amove usr/lib/postgresql*/bitcode
}

sha512sums="
ed07d5d2d87a952eb842057cb42c542997389a9b11542a0aab93e7540798dc2922197bcf809155caab4054643e1a008271dd32d46144fb4c859cb85adb00cdcb  pgq-3.5.1.tar.gz
"
