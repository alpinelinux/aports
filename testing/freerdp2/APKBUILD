# Maintainer: Valery Kartel <valery.kartel@gmail.com>
# Contributor: Valery Kartel <valery.kartel@gmail.com>
pkgname=freerdp2
_pkgname=FreeRDP
pkgver=2.0.0_rc0
_pkgver=${pkgver/_rc/-rc}
pkgrel=0
pkgdesc="A Remote Desktop Protocol Implementation"
url="http://www.freerdp.com/"
arch="all"
options="!check"
license="ASL-2.0"
depends=""
makedepends="cmake linux-headers alsa-lib-dev cups-dev eudev-dev gsm-dev
	gst-plugins-base-dev ffmpeg-dev libjpeg-turbo-dev libressl-dev libusb-dev
	libx11-dev libxcursor-dev libxdamage-dev libxext-dev libxfixes-dev libxi-dev libxinerama-dev
	libxkbfile-dev libxml2-dev libxrandr-dev libxrender-dev libxtst-dev libxv-dev
	pulseaudio-dev wayland-dev
	"
subpackages="$pkgname-dev $pkgname-doc $pkgname-shadow-cli:_shadow $pkgname-winpr-tools:_winpr
	$pkgname-channels $pkgname-libs-shadow:_libs $pkgname-libs-client:_libs
	$pkgname-libs-server:_libs $pkgname-libs-winpr:_libs $pkgname-libs"
source="$pkgname-$pkgver.tar.gz::https://github.com/$_pkgname/$_pkgname/archive/$_pkgver.tar.gz
	libressl.patch
	"
builddir="$srcdir/$_pkgname-$_pkgver"

# secfixes:
#   2.0.0-r0:
#     - CVE-2017-2834
#     - CVE-2017-2835

build() {
	cd "$builddir"
	cmake -DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DWITH_LIBSYSTEMD=OFF \
		-DWITH_ALSA=ON \
		-DWITH_CUPS=ON \
		-DWITH_CHANNELS=ON -DBUILTIN_CHANNELS=OFF \
		-DWITH_DIRECTFB=OFF \
		-DWITH_FFMPEG=ON \
		-DWITH_GSM=ON \
		-DWITH_GSTREAMER_0_1=OFF \
		-DWITH_GSTREAMER_1_0=ON -DGSTREAMER_1_0_INCLUDE_DIRS=/usr/include/gstreamer-1.0 \
		-DWITH_JPEG=ON \
		-DWITH_OPENSSL=ON \
		-DWITH_PCSC=OFF \
		-DWITH_PULSE=ON \
		-DWITH_WAYLAND=ON \
		-DWITH_SERVER=ON \
		-DWITH_CLIENT=ON \
		-DWITH_X11=ON \
		-DWITH_XCURSOR=ON \
		-DWITH_XEXT=ON \
		-DWITH_XKBFILE=ON \
		-DWITH_XI=ON \
		-DWITH_XINERAMA=ON \
		-DWITH_XRENDER=ON \
		-DWITH_XV=ON \
		-DWITH_ZLIB=ON
	make
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir" install
}

libs() {
	default_libs
	rmdir "$pkgdir"/usr/lib
}

channels() {
	pkgdesc="$pkgdesc (virtual channel extensions)"
	mkdir -p "$subpkgdir"/usr/lib || return 1
	mv "$pkgdir"/usr/lib/freerdp2 \
		"$subpkgdir"/usr/lib
}

_shadow() {
	pkgdesc="$_pkgname utility for sharing a X display via RDP"
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/freerdp-shadow-cli \
		"$subpkgdir"/usr/bin
}

_winpr() {
	pkgdesc="$_pkgname Windows Portable Runtime tools"
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/winpr-* \
		"$subpkgdir"/usr/bin
}

_libs() {
	local name=${subpkgname#$pkgname-libs-}
	pkgdesc="$pkgdesc ($name libraries)"
	cd "$pkgdir"
	local file; for file in $(find ./usr/lib -name "*$name*"); do
		mkdir -p "$subpkgdir"/${file%/*}
		mv "$pkgdir"/$file "$subpkgdir"/$file
	done
}

sha512sums="9bc9ee976c73f274a4258613409e242088bd077bcd1cc43f7941170374fc0f9deda7f2f7644506d0cdc2e029b6037abb21d848810dcce6aefa3c5f1642f19cb3  freerdp2-2.0.0_rc0.tar.gz
c33fb44b1df82fafbfed7e8585539eb541b56cb461e83af74fde4fe292e2a6d18faa02c9ad812942dc318dad38b8fceae3ac02c28109988dbfbcbbcb950eeb5c  libressl.patch"
