# Contributor: Bart≈Çomiej Piotrowski <bpiotrowski@alpinelinux.org>
# Contributor: Andriy Kushnir <me@orhideous.name>
# Maintainer: Andriy Kushnir <me@orhideous.name>

pkgname=xtrabackup
pkgver=2.4.5
pkgrel=0
pkgdesc='MySQL non-blocking backup solution for InnoDB and XtraDB data'
arch=all
url='http://www.percona.com/software/percona-xtrabackup/'
license='GPL'
depends='
  libaio
  libcurl
  libev
  libgcc
  libgcrypt
  libstdc++
  musl
  zlib
'
makedepends='
  bash
  bison
  cmake
  flex
  vim
  ncurses-dev
  curl-dev
  libev-dev
  libaio-dev
  libgcrypt-dev
  zlib-dev
'
source="
  https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-$pkgver/source/tarball/percona-xtrabackup-$pkgver.tar.gz
  sigevent_musl.patch
"

prepare() {
  cd "$srcdir"/percona-xtrabackup-$pkgver
  for i in $source; do
    case $i in
      *.patch)
        msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
    esac
  done
}

build() {
  cd "$srcdir"/percona-xtrabackup-$pkgver

  export CFLAGS="-DSIGEV_THREAD_ID=4"
  cmake -DBUILD_CONFIG=xtrabackup_release -DWITH_MAN_PAGES=OFF -DDOWNLOAD_BOOST=1 -DWITH_BOOST=/tmp/boost_59

  make xtrabackup
  make xbcrypt
  make xbstream
  make xbcloud
}

package() {
  cd "$srcdir"/percona-xtrabackup-$pkgver/storage/innobase/xtrabackup

  install -D src/xtrabackup "$pkgdir"/usr/bin/xtrabackup
  install -D src/xbcrypt "$pkgdir"/usr/bin/xbcrypt
  install -D src/xbstream "$pkgdir"/usr/bin/xbstream
  install -D src/xbcloud "$pkgdir"/usr/bin/xbcloud

  ln -s /usr/bin/xtrabackup "$pkgdir"/usr/bin/innobackupex
}

md5sums="6fced63e74e4a55466702e183e776bab  percona-xtrabackup-2.4.5.tar.gz
76584cd64e35bfec450f6acf7a941050  sigevent_musl.patch"
sha256sums="1c8c457e1912525f6c3079a8c5b2948dbcf693d2b86c8f57d13b4a446cec2036  percona-xtrabackup-2.4.5.tar.gz
d7fb2bf47ddba69919fa0e8167bfd42ba4b742e78f8cfa9bb095413616a07840  sigevent_musl.patch"
sha512sums="07d93ea7de987a06687cc772b32dff13e75e34061163bf990abe640015f765d9fe4deb6d78ddb91a667ddb312448400a5e7e1114cf955837584b5fd16821c66b  percona-xtrabackup-2.4.5.tar.gz
8f76b6307d35abdbde0a0e02b3e290c10857afd3779f0bb6bca89ccbbbe4afa16312ad3fa15659ba94170f961c76c84a742afe259d836e6c3ef5e383f2f870b7  sigevent_musl.patch"
