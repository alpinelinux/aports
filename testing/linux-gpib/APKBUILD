# Contributor: Robert Eckelmann <longnoserob@gmail.com>
# Maintainer: Robert Eckelmann <longnoserob@gmail.com>
pkgname=linux-gpib
pkgver=4.3.7
pkgrel=0
pkgdesc="Linux GPIB userland applications"
url="https://sourceforge.net/projects/linux-gpib"
arch="all"
license="GPL-2.0-only"
depends="
	fxload
	python3
	py3-setuptools
	"
makedepends="docbook-xml linux-headers pkgconf python3-dev py3-setuptools"
subpackages="$pkgname-dev $pkgname-doc $pkgname-udev"
install="linux-gpib.post-install linux-gpib.post-upgrade"
source="https://downloads.sourceforge.net/linux-gpib/linux-gpib-$pkgver.tar.gz
	0000-ptread.patch
	0002-usb-fxloader.patch
	"

# We are only-interested in the user part, as kernels >6.13 have the GPIB drivers included
builddir="$srcdir/$pkgname-user-$pkgver"

# As the source archive contains two sub-archives, we need to over-ride the defaul unpack() here:
unpack() {
	default_unpack
	tar -xzf "$srcdir/$pkgname-$pkgver/$pkgname-user-$pkgver".tar.gz -C "$srcdir"
}


build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--datadir=/usr/lib/firmware \
		--localstatedir=/var \
		--disable-guile-binding \
		--disable-perl-binding \
		--disable-php-binding \
		--disable-tcl-binding \
		--enable-documentation
	make
}

check() {
	make check
}

doc() {
	_docs="gpib_version.txt linux-gpib.pdf linux-gpib.sgml"
	for _doc in $_docs; do
		install -Dm644 "$srcdir"/$pkgname-user-$pkgver/doc/$_doc \
			"$subpkgdir"/usr/share/doc/$pkgname/$_doc
	done
}

package() {
	make DESTDIR="$pkgdir" install
}

sha512sums="
a0783cf54f37132b6f608f555d453be3c1da693e4bddff9e87b40c0ba034a44ac640c87f96d187cf6f98501177f09fec04e7380512bcbb7fc8d0d4652b3be7ad  linux-gpib-4.3.7.tar.gz
cf5425194921ecd12c19d8774a2d5b058e4e467dea77f569fcec3b655be27efeb4dad776926e56c6caefca24b245224d2567e9b0c89a618ffd312b7779da0f26  0000-ptread.patch
12413895ba25b222cbaa3ea44c28be9830c3b6961754df00b303d5b691b826c4ad78c2cabcf89f31fc3e795f5748b8e679dcc1cb88e924d914483a6aad80611a  0002-usb-fxloader.patch
"
