# Contributor: Andrey L <innerspacepilot@gmx.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=kodi-rpi
pkgver=18.2
_realname=Leia
pkgrel=0
pkgdesc="A software media player and entertainment hub for digital media"
url="http://kodi.tv"
arch="armv7"
license="GPL"
depends="raspberrypi raspberrypi-libs tzdata"
depends_dev="lzo-dev curl-dev mariadb-connector-c-dev libjpeg-turbo-dev libpng-dev sqlite-dev giflib-dev avahi-dev
	alsa-lib-dev pulseaudio-dev bluez-dev libbluray-dev libcap-dev rapidjson-dev taglib-dev ffmpeg-dev tinyxml-dev
	libmicrohttpd-dev samba-dev lcms2-dev dbus-dev libnfs-dev python2-dev libxml2-dev libass-dev libcdio-dev
	libxslt-dev libplist-dev raspberrypi-dev libinput-dev libxkbcommon-dev libcec-dev libdvdread-dev libunistring-dev"
makedepends="$depends_dev automake autoconf m4 libtool swig findutils ghostscript groff
	boost-thread zip gperf cmake coreutils nasm tar	git bash ccache"
subpackages="$pkgname-dev $pkgname-doc $pkgname-dbg"
replaces="xbmc"
#options="ldpath-recursive"
source="https://github.com/xbmc/xbmc/archive/$pkgver-$_realname.tar.gz
	0000-fortify-source-fix.patch
	0001-fix-fileemu.patch
	0002-fix-musl.patch
	0003-cmake-mmal.patch
	"
builddir="$srcdir/xbmc-$pkgver-$_realname"

prepare() {
	default_prepare
	mkdir -p "build/build/swig"
	cp -r ../../files/swig.nojava-$pkgver/* "build/build/swig"
	cp ../../files/CMakeCache.txt.nojava "build/CMakeCache.txt"
	cd build
	cmake -DCORE_PLATFORM_NAME=rbpi\
		-DENABLE_OPENGL=OFF \
		-DENABLE_OPENGLES=ON \
		-DENABLE_INTERNAL_FLATBUFFERS=ON \
		-DENABLE_INTERNAL_CROSSGUID=ON \
		-DENABLE_INTERNAL_FMT=ON \
		-DENABLE_INTERNAL_FSTRCMP=ON \
		-DWITH_FFMPEG=/usr \
		-DCMAKE_PREFIX_PATH=/opt/kodi \
		-DCMAKE_FRAMEWORK_PATH=/opt/vc \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DENABLE_LDGOLD=Off \
		-DWITH_CPU=cortex-a7 \
		-DCMAKE_CXX_FLAGS=-DGLX_GLXEXT_LEGACY \
		-DCMAKE_C_FLAGS=-DGLX_GLXEXT_LEGACY \
		-DCMAKE_INSTALL_RPATH=/opt/vc/lib \
		..
}

build() {
	cd "$builddir/build"
	make || true
	# First make fails if run with -j more than 1
	make
}

check() {
	test -f "$builddir/build/kodi-rbpi"
}

package() {
	cd "$builddir/build"
	make DESTDIR="$pkgdir" install
}

sha512sums="7b63dc9c082f538690d28dd6da10999888af2b9de2e532bca54420753f64238f42e1c2aa0f7481c823e544260a1e4d68e1ba50f84db53307d08f0749992dff2f  18.2-Leia.tar.gz
e8ebff78d5dbb925d25e999cd58d578345f6d30962699a0b18347a1364d90374fbfc92dc919910baf05ea464331d575557dd2cd4411eaa6b753e8ecafad09676  0000-fortify-source-fix.patch
3cba239bb7c5403e94bd8f7968878d88b9250a25347e97b655c6523348610a1237c2adbbe4953170ab2350c3b06ad7024675b9c70f56046d154e2c5dba919ac6  0001-fix-fileemu.patch
60e616f5ad11edaad568c372d22b7e3596da8a52b521ad39c3370721aeae612830db4da138890462fc364a5e530dbd0345732fe360bcc09e0e0d5001b2eb206c  0002-fix-musl.patch
31bf2904b9913acf06e260244c2afa8b50f4177a57078ee7ebbfaaa91c5a72a18aaa0d13cabfca3879bed533786dbf3beae72d0d5ff567ae57942d1cf8a39de8  0003-cmake-mmal.patch"
