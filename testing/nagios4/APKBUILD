# Contributor: Valery Kartel <valery.kartel@gmail.com>
# Maintainer: Valery Kartel <valery.kartel@gmail.com>
pkgname=nagios4
pkgver=4.4.1
pkgrel=0
_pkgreal=nagios
_pkgdesc="Nagios Core 4"
pkgdesc="$_pkgdesc - The Industry Standard In IT Infrastructure Monitoring"
url="https://www.nagios.org/"
arch="all"
options="!check" # test-suite does not compiled
license="GPL-2.0"
install="$pkgname.pre-install"
replaces="$_pkgreal"
makedepends="gd-dev libjpeg-turbo-dev libpng-dev mailx perl-dev perl-net-snmp procps unzip"
subpackages="$pkgname-apache2 $pkgname-convertcfg $pkgname-nagiostats $pkgname-openrc
	$pkgname-eventhandlers::noarch $pkgname-default::noarch $pkgname-worker-ping:_ping
	"
source="https://assets.nagios.com/downloads/nagioscore/releases/$_pkgreal-$pkgver.tar.gz
	htpasswd.users
	nagios-cgi.conf
	traceroute.patch
	"
pkgusers="$_pkgreal apache"
pkggroups="$_pkgreal apache"
builddir="$srcdir/$_pkgreal-$pkgver"

prepare() {
	cd "$builddir"
	default_prepare
	update_config_sub
	local file; for file in $(find contrib/eventhandlers -type f); do
		sed -i "$file" -e "s:/bin/mail:/usr/bin/mail:g" \
		-e "s:/usr/local/nagios/etc:/etc/$_pkgreal:g" \
		-e "s:/usr/local/nagios/var:/var/$_pkgreal:g" \
		-e "s:/usr/local/nagios/libexec:/usr/lib/$_pkgreal:g"
	done
}

build() {
	cd "$builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--bindir=/usr/sbin \
		--sysconfdir=/etc/$_pkgreal \
		--datadir=/usr/share/$_pkgreal \
		--sbindir=/usr/lib/$_pkgreal/cgi \
		--libexecdir=/usr/lib/$_pkgreal/plugins \
		--localstatedir=/var/$_pkgreal \
		--with-nagios-user=$_pkgreal \
		--with-nagios-group=$_pkgreal \
		--with-command-user=$_pkgreal \
		--with-command-group="apache" \
		--with-template-objects \
		--with-template-extinfo \
		--enable-event-broker \
		--with-perlcache
	make all
	make -C contrib
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir" install install-config install-commandmode
	make DESTDIR="$pkgdir" install -C contrib
	install -Dm755 startup/openrc-init "$pkgdir"/etc/init.d/$_pkgreal
}

apache2() {
	replaces=
	depends="$pkgname php7-apache2"
	pkgdesc="$_pkgdesc - Apache2 Integration"
	mkdir -p "$subpkgdir"/etc/$_pkgreal "$subpkgdir"/usr/lib/$_pkgreal
	mv "$pkgdir"/usr/lib/$_pkgreal/cgi "$subpkgdir"/usr/lib/$_pkgreal
	mv "$pkgdir"/etc/$_pkgreal/cgi.cfg "$subpkgdir"/etc/$_pkgreal
	mv "$pkgdir"/usr/share "$subpkgdir"/usr
	install -Dm644 "$builddir"/sample-config/httpd.conf \
		"$subpkgdir"/etc/apache2/conf.d/nagios.conf
	install -Dm644 "$srcdir"/nagios-cgi.conf \
		"$subpkgdir"/etc/apache2/conf.d/nagios-cgi.conf
	install -Dm644 -g $_pkgreal /dev/null "$subpkgdir"/etc/$_pkgreal/traceroute.cfg
	install -Dm640 -o $_pkgreal -g apache "$srcdir"/htpasswd.users "$subpkgdir"/etc/$_pkgreal/htpasswd.users
	rm -fr "$pkgdir"/usr/lib
}

convertcfg() {
	replaces=
	depends="$pkgname"
	pkgdesc="$_pkgdesc - Config File Converter"
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/sbin/convertcfg "$subpkgdir"/usr/bin
}

eventhandlers() {
	replaces=
	depends="mailx $pkgname-apache2"
	pkgdesc="$_pkgdesc - Event Handlers"
	mkdir -p "$subpkgdir"/usr/lib/$_pkgreal/eventhandlers
	cp -a "$builddir"/contrib/eventhandlers/* \
		"$subpkgdir"/usr/lib/$_pkgreal/eventhandlers
}

nagiostats() {
	replaces=
	depends="$pkgname"
	pkgdesc="$_pkgdesc - Stats Utility"
	mkdir -p "$subpkgdir"/usr/sbin
	mv "$pkgdir"/usr/sbin/nagiostats "$subpkgdir"/usr/sbin
	install -Dm644 "$builddir"/sample-config/mrtg.cfg \
		"$subpkgdir"/etc/$_pkgreal/mrtg.cfg
}

default() {
	replaces=
	pkgdesc="$_pkgdesc - Minimal set of packages to run with default config"
	local _p=$_pkgreal-plugins
	depends="$pkgname mailx $_p-disk $_p-load $_p-http $_p-ping $_p-procs $_p-swap $_p-ssh $_p-users"
	mkdir -p "$subpkgdir"
}

_ping() {
	replaces=
	depends="$pkgname"
	pkgdesc="$_pkgdesc - Worker to handle ping check"
	mkdir -p "$subpkgdir"/usr/lib/$_pkgreal/workers
	cp "$builddir"/worker/ping/worker-ping "$subpkgdir"/usr/lib/$_pkgreal/workers/ping
}

sha512sums="d84f22a8fd21a573b4162f232c3a6bb2ba0b7d3a470e5fd80183a1862d2ae666956cfc2dd4c7fe6319ee7ccedb9f8a6920ba39a6b499ed9ff5b8be60a9779fa9  nagios-4.4.1.tar.gz
dfd6dfbfce493cd18e9287fec9fb3f454a3be58fa6bfb715bb828b8d3581e0222b87e8410c7f47765e6798fbad829ea7d59dc59decb9585446cf241837955fa2  htpasswd.users
d33c59dce02bf13a82737e4c99aa360674cf6af326d28e146c7bb21050ce9705735764bf1ca94edee7dd111ce74253d480f6513d98e186b3147b7722c9b04b31  nagios-cgi.conf
fc8570dfbb94548ef3c887a7e3a67da97da746278927450d0528643183afca940cf58c38664b18cc600c063f781f8f32db0e31e4748eb138bde816fc27304a60  traceroute.patch"
