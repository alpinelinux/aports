# Maintainer: Joseph Benden <joe@benden.us>
# Contributor: Joseph Benden <joe@benden.us>

# TODO: Create initd for VBoxAutostart.
# TODO: Create initd for VBoxBalloonCtrl
# TODO: Have a vbox initd ensure that all VMs are stopped when shutting down computer?

# NOTE: These *MUST* remain in sync with main/linux-vanilla!
_ver=6.0.8
_kver=4.19.58
_krel=0

pkgname=virtualbox
pkgver=6.0.8
pkgrel=0
pkgdesc="General-purpose full virtualizer for x86 hardware"
arch='x86_64'
url='https://virtualbox.org/'
license="GPL-2.0-only AND custom"
options="!check suid ldpath-recursive"
install="$pkgname.pre-install $pkgname.pre-deinstall"
subpackages="
	$pkgname-doc
	$pkgname-ext-vnc:ext_vnc:noarch
	$pkgname-guest-modules:guest_modules
	$pkgname-guest-utils-nox:guest_utils_nox
	$pkgname-guest-utils:guest_utils
	$pkgname-host-modules:host_modules
	$pkgname-openrc
	$pkgname-sdk:sdk:noarch
	"
replaces="virtualbox-guest-additions virtualbox-guest-modules-virt virtualbox-guest-modules-vanilla"
conflicts="virtualbox-guest-additions virtualbox-guest-modules-virt virtualbox-guest-modules-vanilla"
depends="
	linux-pam
	"
makedepends="
	alsa-lib-dev
	bsd-compat-headers
	cdrkit
	curl
	curl-dev
	device-mapper
	docbook-xml
	docbook-xsl
	git
	glu-dev
	gsoap
	gsoap-dev
	iasl
	kbuild
	libcap-dev
	libidl-dev
	libvncserver-dev
	libvpx-dev
	libxcomposite-dev
	libxcursor-dev
	libxinerama-dev
	libxml2-dev
	libxmu-dev
	libxrandr-dev
	libxslt-dev
	libxt-dev
	libxtst-dev
	linux-headers
	linux-pam-dev
	linux-vanilla-dev=$_kver-r$_krel
	lvm2-dev
	mesa-dev
	musl-dev
	nasm
	openjdk8
	openssl-dev
	opus-dev
	pulseaudio-dev
	python3-dev
	qt5-qtbase-dev
	qt5-qttools-dev
	qt5-qtx11extras-dev
	sdl-dev
	sdl_image-dev
	sed
	texlive
	texlive-full
	vde2-dev
	xorg-server-dev
	xorgproto
	yasm
	zlib-dev
	"
source="https://download.virtualbox.org/virtualbox/$pkgver/VirtualBox-$pkgver.tar.bz2
	futimens.patch
	musl-fix-headers.patch
	musl-no-glibc.patch
	musl-fix-stat-nsec.patch
	musl-sched_yield.patch
	musl-off_t.patch
	glibc-symvers.patch
	VBoxClient.patch
	musl-fix-dlmopen.patch
	musl-fix-syslimits-h.patch
	musl-fix-types-h.patch
	musl-fix-posix-source.patch
	musl-fix-in6_pktinfo.patch
	musl-fix-inotify-flexarray.patch
	musl-missing-getprotobyname_r.patch
	002-dri-driver-path.patch
	005-gsoap-build.patch
	006-rdesktop-vrdp-keymap-path.patch
	011-python-3-7.patch
	101-vboxsf-automount.patch
	60-vboxdrv.rules
	60-vboxguest.rules
	mount.vboxsf
	virtualbox-localconfig
	vboxweb.initd
	virtualbox-guest-utils.initd
	virtualbox-guest-utils-nox.initd
	"
# help our shared-object scanner to find the libs
ldpath="/usr/lib/virtualbox"

builddir="$srcdir"/VirtualBox-$_ver

prepare() {
	default_prepare
	rm -rf $builddir/kBuild/bin $builddir/tools # use our packaged kbuild
	cp $srcdir/$pkgname-localconfig LocalConfig.kmk
}

build() {
	export JAVA_HOME=/usr/lib/jvm/default-jvm
	export PATH="$JAVA_HOME/bin:$PATH"

	echo "VBOX_GCC_OPT=$CXXFLAGS" >> LocalConfig.kmk
	echo "VBOX_JAVA_HOME = ${JAVA_HOME}" >> LocalConfig.kmk

	./configure \
		--disable-vmmraw \
		--enable-webservice \
		--enable-vde \
		--enable-vnc \
		--enable-qt5 \
		--with-makeself=/bin/echo
	# fake makeself binary to compile without nofatal
	# makeself is used by linux installer, we don't need it.
	source ./env.sh
	kmk # KBUILD_VERBOSE=2

	echo "==> Building Host Kernel Modules"
	cd "out/linux.$BUILD_PLATFORM_ARCH/release/bin/src"
	make # KBUILD_VERBOSE=2
	cd "$builddir"

	echo "==> Building Guest Kernel Modules"
	cd "out/linux.$BUILD_PLATFORM_ARCH/release/bin/additions/src"
	make # KBUILD_VERBOSE=2
	cd "$builddir"

	echo "==> Building rdesktop-vrdp"
	kmk -C src/VBox/RDP/client-1.8.4 # KBUILD_VERBOSE=2

	echo "==> Building VNC extension pack"
	kmk -C src/VBox/ExtPacks/VNC packing # KBUILD_VERBOSE=2
}

package() {
	depends="VIRTUALBOX-HOST-MODULES"

	source ./env.sh
	cd "out/linux.$BUILD_PLATFORM_ARCH/release/bin"

	# binaries
	install -v -Dm755 VBox.sh "$pkgdir/usr/bin/VBox"
	for i in VBoxAutostart VBoxBugReport VBoxCpuReport VBoxHeadless \
			VBoxManage VBoxSDL VirtualBox vboxwebsrv \
			VBoxBalloonCtrl VBoxVRDP VirtualBoxVM; do
		ln -sf VBox "$pkgdir/usr/bin/$i"
	done
	install -m0755 VBoxTunctl "$pkgdir/usr/bin"
	install -m0755 VBoxVolInfo "$pkgdir/usr/bin"
	install -m0755 rdesktop-vrdp "$pkgdir/usr/bin"

	# libraries
	install -dm0755 "$pkgdir/usr/lib/virtualbox"
	install -m0755 *.so "$pkgdir/usr/lib/virtualbox"
	install -m0644 *.r0 VBoxEFI*.fd "$pkgdir/usr/lib/virtualbox"

	# setuid root binaries
	install -m4755 VBoxSDL VirtualBoxVM VBoxHeadless VBoxNetDHCP \
		VBoxNetAdpCtl VBoxNetNAT -t "$pkgdir/usr/lib/virtualbox"
	install -m4755 VBoxVolInfo -t "$pkgdir/usr/lib/virtualbox"

    	# other binaries
	install -m0755 VirtualBox VBoxAutostart VBoxBugReport VBoxCpuReport \
		VBoxManage VBoxSVC VBoxExtPackHelperApp VBoxXPCOMIPCD \
		VBoxTestOGL VBoxBalloonCtrl VBoxTunctl VBoxVMMPreload \
		vboxwebsrv webtest -t "$pkgdir/usr/lib/virtualbox"

	# components
	install -dm0755 "$pkgdir/usr/lib/virtualbox/components"
	install -m0755 components/* -t "$pkgdir/usr/lib/virtualbox/components"

	# extensions packs
	install -dm0755 "$pkgdir/usr/lib/virtualbox/ExtensionPacks"

	install -dm0755 "$pkgdir/usr/share/virtualbox/UnattendedTemplates"
	install -m0755 UnattendedTemplates/* -t "$pkgdir/usr/share/virtualbox/UnattendedTemplates"

	# languages
	install -dm0755 "$pkgdir/usr/share/virtualbox/nls"
	install -m0755 nls/*.qm -t "$pkgdir/usr/share/virtualbox/nls"

	# rdesktop keymaps
	install -dm0755 "$pkgdir/usr/share/virtualbox/rdesktop-vrdp-keymaps"
	install -m0644 rdesktop-vrdp-keymaps/* "$pkgdir/usr/share/virtualbox/rdesktop-vrdp-keymaps"

	# useless scripts
	install -m0755 VBoxCreateUSBNode.sh VBoxSysInfo.sh -t "$pkgdir/usr/share/virtualbox"

	# icons
	install -Dm0644 VBox.png "$pkgdir/usr/share/pixmaps/VBox.png"

	cd icons
	for i in *; do
		install -d "$pkgdir/usr/share/icons/hicolor/$i/mimetypes"
		cp $i/* "$pkgdir/usr/share/icons/hicolor/$i/mimetypes"
	done
	cd ..

	# desktop
	install -Dm0644 virtualbox.desktop "$pkgdir/usr/share/applications/virtualbox.desktop"
	install -Dm0644 virtualbox.xml "$pkgdir/usr/share/mime/packages/virtualbox.xml"

	# install configuration
	install -dm0755 "$pkgdir/etc/vbox"
	echo 'INSTALL_DIR=/usr/lib/virtualbox' > "$pkgdir/etc/vbox/vbox.cfg"

	# back to srcdir
	cd "$srcdir"

	# licence
	install -Dm0644 VirtualBox-$_ver/COPYING "$pkgdir/usr/share/licenses/$pkgname/LICENSE"

	# install openrc stuff
	install -Dm0644 60-vboxdrv.rules "$pkgdir/usr/lib/udev/rules.d/60-vboxdrv.rules"
	install -v -Dm755 "$srcdir"/vboxweb.initd "$pkgdir"/etc/init.d/vboxweb
}

sdk() {
	pkgdesc="VirtualBox Software Developer Kit (SDK)"
	depends="
		openjdk8-jre-base
		python3
		virtualbox
		"

	cd "$builddir"
	source ./env.sh
	cd "out/linux.$BUILD_PLATFORM_ARCH/release/bin"

	# sdk
	install -Dm0755 vboxshell.py "$subpkgdir/usr/lib/virtualbox/vboxshell.py"
	cd sdk/installer
	VBOX_INSTALL_PATH="/usr/lib/virtualbox" python3 vboxapisetup.py install --root "$subpkgdir"
	cd ../..
	cp -r sdk "$subpkgdir/usr/lib/virtualbox"
	rm -r "$subpkgdir/usr/lib/virtualbox/sdk/installer"

	# licence
	install -Dm0644 "$srcdir/VirtualBox-$_ver/COPYING" \
		"$subpkgdir/usr/share/licenses/$subpkgname/LICENSE"
}

host_modules() {
	pkgver="$_ver-$_kver-r$_krel-vanilla"
	pkgdesc="VirtualBox Host kernel modules"
	depends="virtualbox linux-vanilla=$_kver-r$_krel"
	provides="VIRTUALBOX-HOST-MODULES"
	install="
		virtualbox-host-modules.post-install
		virtualbox-host-modules.pre-deinstall
		virtualbox-host-modules.pre-install
		"

	cd "$builddir"
	source ./env.sh
	cd "out/linux.$BUILD_PLATFORM_ARCH/release/bin/src"
	make KBUILD_VERBOSE=2 INSTALL_MOD_PATH="$subpkgdir" install
	cd "$builddir/out/linux.$BUILD_PLATFORM_ARCH/release/bin"

	# licence
	install -Dm0644 "$srcdir/VirtualBox-$_ver/COPYING" \
		"$subpkgdir/usr/share/licenses/$subpkgname/LICENSE"

	# module loading
	local _p="$subpkgdir/usr/lib/modules-load.d/$subpkgname.conf"
	install -Dm0644 /dev/null "$_p"
	printf "vboxdrv\nvboxpci\nvboxnetadp\nvboxnetflt\n" > "$_p"
}

guest_modules() {
	pkgver="$_ver-$_kver-r$_krel-vanilla"
	pkgdesc="VirtualBox Guest kernel modules"
	depends="linux-vanilla=$_kver-r$_krel"
	provides="VIRTUALBOX-GUEST-MODULES"
	install="
		virtualbox-guest-modules.post-install
		virtualbox-guest-modules.pre-deinstall
		virtualbox-guest-modules.pre-install
		"

	cd "$builddir"
	source ./env.sh
	cd "out/linux.$BUILD_PLATFORM_ARCH/release/bin/additions/src"
	make KBUILD_VERBOSE=2 INSTALL_MOD_PATH="$subpkgdir" install
	cd "$builddir/out/linux.$BUILD_PLATFORM_ARCH/release/bin"

	# licence
	install -Dm0644 "$srcdir/VirtualBox-$_ver/COPYING" \
		"$subpkgdir/usr/share/licenses/$subpkgname/LICENSE"

	# module loading
	local _p="$subpkgdir/usr/lib/modules-load.d/$subpkgname.conf"
	install -Dm0644 /dev/null "$_p"
	printf "vboxguest\nvboxsf\nvboxvideo\n" > "$_p"
}

guest_utils() {
	pkgdesc="VirtualBox Guest userspace utilities"
	depends="pam VIRTUALBOX-GUEST-MODULES"
	conflicts='virtualbox-guest-utils-nox'

	cd "$builddir"
	source ./env.sh
	cd "out/linux.$BUILD_PLATFORM_ARCH/release/bin/additions"

	install -d "$subpkgdir/usr/bin"
	install -m0755 VBoxClient VBoxControl VBoxService "$subpkgdir/usr/bin"
	install -m0755 "$srcdir/mount.vboxsf" "$subpkgdir/usr/sbin"
	install -Dm0755 mount.vboxsf "$subpkgdir/usr/lib/virtualbox/mount.vboxsf"
	install -m0755 -D "$srcdir"/VirtualBox-$_ver/src/VBox/Additions/x11/Installer/98vboxadd-xclient \
		"$subpkgdir"/usr/bin/VBoxClient-all
	install -m0644 -D "$srcdir"/VirtualBox-$_ver/src/VBox/Additions/x11/Installer/vboxclient.desktop \
		"$subpkgdir"/etc/xdg/autostart/vboxclient.desktop
	install -d "$subpkgdir/usr/lib/xorg/modules/dri"
	install -m0755 VBoxOGL*.so "$subpkgdir/usr/lib"
	ln -s /usr/lib/VBoxOGL.so "$subpkgdir/usr/lib/xorg/modules/dri/vboxvideo_dri.so"
	install -m0755 -D pam_vbox.so "$subpkgdir/usr/lib/security/pam_vbox.so"

	cd "$srcdir"

	# openrc stuff
	install -Dm0644 60-vboxguest.rules "$subpkgdir/usr/lib/udev/rules.d/60-vboxguest.rules"
	install -v -Dm755 "$srcdir"/$pkgname-guest-utils.initd \
		"$subpkgdir"/etc/init.d/$pkgname-guest-utils

	# licence
	install -Dm0644 VirtualBox-$_ver/COPYING \
		"$subpkgdir/usr/share/licenses/$subpkgname/LICENSE"
}

guest_utils_nox() {
	pkgdesc='VirtualBox Guest userspace utilities without X support'
	depends='pam VIRTUALBOX-GUEST-MODULES'
	conflicts='virtualbox-guest-utils'

	cd "$builddir"
	source "./env.sh"
	cd "out/linux.$BUILD_PLATFORM_ARCH/release/bin/additions"

	install -d "$subpkgdir/usr/bin"
	install -m0755 VBoxControl VBoxService "$subpkgdir/usr/bin"
	install -m0755 "$srcdir/mount.vboxsf" "$subpkgdir/usr/sbin"
	install -Dm0755 mount.vboxsf "$subpkgdir/usr/lib/virtualbox/mount.vboxsf"
	install -m0755 -D pam_vbox.so "$subpkgdir/usr/lib/security/pam_vbox.so"
	cd "$srcdir"

	# openrc stuff
	install -Dm0644 60-vboxguest.rules "$subpkgdir/usr/lib/udev/rules.d/60-vboxguest.rules"
	install -v -Dm755 "$srcdir"/$pkgname-guest-utils-nox.initd \
		"$subpkgdir"/etc/init.d/$pkgname-guest-utils

	# licence
	install -Dm0644 "$srcdir/VirtualBox-$_ver/COPYING" \
		"$subpkgdir/usr/share/licenses/$subpkgname/LICENSE"
}

ext_vnc() {
	pkgdesc='VirtualBox VNC extension pack'
	depends='virtualbox libvncserver'
	install="virtualbox-ext-vnc.post-install virtualbox-ext-vnc.pre-deinstall"

	cd "$builddir"
	source "./env.sh"
	cd "out/linux.$BUILD_PLATFORM_ARCH/release/packages"

	install -Dm0644 VNC-*.vbox-extpack \
		"$subpkgdir/usr/share/virtualbox/extensions/VNC-${_ver}.vbox-extpack"

	# licence
	install -Dm0644 "$srcdir/VirtualBox-$_ver/COPYING" \
		"$subpkgdir/usr/share/licenses/$subpkgname/LICENSE"
}

sha512sums="df18d5df2c82761b8a77e509b2873cdeaa46d11bc50ca166af1e6c30d3042b0cf5640957b1d411333f5bd5be3f03f382550f1afaecf0651d847bc88c95863d83  VirtualBox-6.0.8.tar.bz2
f0c6d09319d9f2c24eba0190252a6b1f3753651a0c91b233d912f2dc1c63d80f15ffe7da9de97b439d5151f785a885b4ae8a9eee6d64a6c1d6dea906ff1a49c6  futimens.patch
207fe28e4f95c4d352fc64bd477985db49581c7192d43aaea865a77747490471db123ea0a5ee313af5ef1d7e4098ffeaaba907ae157822c2d2a1b0a9cc8bcaf3  musl-fix-headers.patch
e656752f516f301f35b74e04fe71680da7ef304da4a691c152d8debda761d210797c67ecdbaddd72917fa2957ae754751565c456c4f0997bd7fbbded7a64fe73  musl-no-glibc.patch
878d8d4cd69db2ff288895196e98a133a0f5a744bbeaa8b5d74e11b1b4c00cb0e3631a9c023c34c0084f05f9449f22945b7fc62159e5c3ae19761e2bab2baecf  musl-fix-stat-nsec.patch
6ee427929c3744724fcaf066faf4b080d4989727ff3b76607a88cf1b6e186c8ad96248f2091fcaf6f8e4de5f0523005cd7885f539407faa4236743c631ea3ecb  musl-sched_yield.patch
11e68531787d944aaa94dc739c321cc88f53d18baf438c9c7758853f90f0ed999ab82e60ae229783ede8e7b1b7d1669adaa0b05053b982b6a29479b78616ec98  musl-off_t.patch
8215ff303be7b8c17aeea3cac120845993745bbec190111c1d85f930a8b7833066314db58eecd146c43614d497fd168e20c509281bfd0a0fbe18b19baec94540  glibc-symvers.patch
44cce08d2b719370f4a0001a63976e3d9a22ff238b37eb892118b21ccf155398628487a82d928eb0316f5f660894ec69258c279ba071af9c8f857d52a5ddbb14  VBoxClient.patch
7a62faf1231c5a58174c0984b1df0ae65ac019718c81e191f5a362929d2ad420b204a9ae8a270e28e045a5fab9ad6140f10e2a87444060bd01cf1a6f08f8bcc6  musl-fix-dlmopen.patch
2a67301e86553aec4a9392f8de2c0cf8136c48232823ceb13f03b3e2b588b71b438b333f7c14f4d09af094721227e582903e330cba05fabd0beaa8f74f2630ce  musl-fix-syslimits-h.patch
bae27d1877cc04d28eb0ec57e05736b91a2388d7b8116b5618265fad6864449dcf940e880756c3271de987ae07af37dc15d83888fb4ed6a236001a9128fe0f9b  musl-fix-types-h.patch
dbe1e714e16a9979dfb190ca234d0c8d6b7447bb154d7c14d5467015ffca38c3653f7967f35df8a869b63ee4bfc483bd151c83ec995342f9b362261ea9b661aa  musl-fix-posix-source.patch
668d3787ff10d5ecddb29d1deaaeff6fd487d79ea5f105b82fe2876af9c4514c8ded85f2f962143534a88404e2982a20bede71e3dc5879f8d580af60ae374f56  musl-fix-in6_pktinfo.patch
0bc0454fd2f369f6a08503939b59183dac8915534e9c57867670592aad6e30c726631f0e35b71dfd7c35f618316d833613feddee6432643a9805d0b7137f203b  musl-fix-inotify-flexarray.patch
9b8e9e29a05e2b7ebbd09e652369f8c84107cf154a3a89de12dba55a1590e914878cc5e9888ee700a2d648abd90b580650932beea85df19f6425b228ad4b016e  musl-missing-getprotobyname_r.patch
4662cd7d3410ad8fb3ed127513d7f6315aff47b3f0d6e77564c4fa0c7f28358bb2902a7c97bc29aeaea1efe67b288ed939eb461a787cd137ddc6d8fc0ea43903  002-dri-driver-path.patch
8ac2b63c7733b9f68e768364d18817566f903e4162b9c1985f6e1e355a1c9781d5cb6c8b0fd645b31b6783ab78b60ebb660993cdb7ae647d1a612e06643fb93e  005-gsoap-build.patch
8297f1a3cc50e83622a80cfd198ecfcb3ce8991f4a55f970c42cc1722c75469ee67fa2295404a9564118a9813f258755489ec0a2bf0f35b0c1a63cdfd1286b7d  006-rdesktop-vrdp-keymap-path.patch
a4fb4bd83ec98f2e369999a7ba4b568dc9c0755fe05608f96ab62f71fb19ab9c25a2dcae42eb13ea26b03ca3768358cf9c83e2741e55d01e3dee9634d927f6dd  011-python-3-7.patch
dc3b406e665d4a08fca8c53b06c26a34f032f2e952004558dd7e00cd49c19de9385740ae5d0e3335b57b7b60f121656d2f279ddf2d418207e936822564f54e5f  101-vboxsf-automount.patch
3a9fddb721dd7445def899a90ab25e45a07c0c069537a02a180443f9e5bfbed7a500c9b46e64a76cf06819f15474c5d241fb8d47eb6a72597f97237877ab8ca5  60-vboxdrv.rules
2e0a925a2bd13bf4e224ddbf1923effdfe673081e165927e9fc2a75550a2231f5262df26585d9efed79da3adff295cb631dd16831a4ece0ddea6d3b494809707  60-vboxguest.rules
9bfe33fe64bfa8b3db8ce5eab23972f4a7d8a86be141768678f41588e638f71f1dcf808c67dc2e210ffd38b690a036a6ef730e8d0be4cf3203bc72a318c66815  mount.vboxsf
c7bd90f5a449bdca12f708d95e195e877f9b9e15a267a83ad1a7fbc485fd59c53e358a152171736ad60e77ccf2e91f076da3948bbb3d1a8395b329884af1bc53  virtualbox-localconfig
e0c7a0a82415e004ef4005fc0043a164c0378906bb81fd08d0cc2d41591da57f8c6e7a9076b59047c29e9a87b8f33f1e4905fc09d24a14c0bbd5b3d71f434b36  vboxweb.initd
5a5355c635e670d3c1edc40bb52ab1f284dd6b25d6cfc3d4ab0cdfaebf43564364012fb199f008c110d069854d52b13ff7fe4b9dc198b89a30b3065d79e1e057  virtualbox-guest-utils.initd
0d315d02077c0744e4393f23711bcd3b1368f224dbeaaffaf2f6c7dfc3c837aaa64bf8d04bc134d9f073306dfaf573503672a323b501345e51c8d930e075a7ae  virtualbox-guest-utils-nox.initd"
