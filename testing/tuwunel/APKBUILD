maintainer="Strange Person <_strangeperson@disroot.org>"
pkgname=tuwunel
pkgver=1.4.9
pkgrel=0
pkgdesc="Featureful Matrix homeserver"
url="https://github.com/matrix-construct/tuwunel/"
# armhf, armv7, riscv64: rustc-LLVM ERROR: out of memory
# x86: fails tests due to SIGABRT
arch="all !armhf !armv7 !riscv64 !x86"
license="Apache-2.0"
makedepends="
	linux-headers
	clang21-dev
	liburing-dev
	cmake
	samurai
	cargo-auditable
"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/matrix-construct/tuwunel/archive/refs/tags/v$pkgver.tar.gz
	tuwunel.initd
	tuwunel.confd
"

prepare() {
	default_prepare

	cargo fetch --target="$CHOST" --locked
}

build() {
	cargo auditable build --release --all-features --frozen
}

check() {
	export TUWUNEL_DATABASE_PATH=/tmp/tuwunel-smoketest.db

	cargo test --all-features --frozen
}

package() {
	install -m755 -D target/release/$pkgname "$pkgdir"/usr/bin/$pkgname

	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
	install -m644 -D "$builddir"/$pkgname-example.toml -t "$pkgdir"/etc/$pkgname/
}

sha512sums="
7f14440c19b19cfac82504f5bf56897766948f36ef7b115a26d3875cf04a05e6dfa1c45e3f4b517cc0f8c187aba8f0542fb72afda58d89ad658f99fa0ab99d77  tuwunel-1.4.9.tar.gz
ed58a4ebd8de7673feb59a9ab42bd60d1ae5f77ff66dfa256c43f482d025e28f9ac856cf9888ae0bdebe6c5b62af16b1700f4fb084e80593e88ba0270246a755  tuwunel.initd
c30d29f591503955b404ac891345d16ff3dab81df6f77043ea2d1dd68b8fd5b560ca1cb0884f1cabe80215080e93e3b215d0f89975b0162c31dfa8343c749a73  tuwunel.confd
"
