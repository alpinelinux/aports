maintainer="Strange Person <_strangeperson@disroot.org>"
pkgname=tuwunel
pkgver=1.4.8
pkgrel=0
pkgdesc="Featureful Matrix homeserver"
url="https://github.com/matrix-construct/tuwunel/"
# does not compile for the excluded architectures:
# rustc-LLVM ERROR: out of memory
arch="all !armhf !armv7 !riscv64"
license="Apache-2.0"
makedepends="
	linux-headers
	clang21-dev
	liburing-dev
	cmake
	samurai
	cargo-auditable
"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/matrix-construct/tuwunel/archive/refs/tags/v$pkgver.tar.gz
	tuwunel.initd
	tuwunel.confd
"

prepare() {
	default_prepare
	
	cargo fetch --target="$CHOST" --locked
}

build() {
	cargo auditable build --release --all-features --frozen
}

check() {
	export TUWUNEL_DATABASE_PATH=/tmp/tuwunel-smoketest.db

	cargo test --all-features --frozen
}

package() {
	install -m755 -D target/release/$pkgname "$pkgdir"/usr/bin/$pkgname

	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
	install -m644 -D "$builddir"/$pkgname-example.toml -t "$pkgdir"/etc/$pkgname/
}

sha512sums="
6f139cf924c6baec88524772ca690478c98627ca00cd36febe2d552596c7c8dc270f724ed4aeea8a6c834ef0bab9d5d9c9699fc7d60fd0809aba7e3260b771fc  tuwunel-1.4.8.tar.gz
ed58a4ebd8de7673feb59a9ab42bd60d1ae5f77ff66dfa256c43f482d025e28f9ac856cf9888ae0bdebe6c5b62af16b1700f4fb084e80593e88ba0270246a755  tuwunel.initd
c30d29f591503955b404ac891345d16ff3dab81df6f77043ea2d1dd68b8fd5b560ca1cb0884f1cabe80215080e93e3b215d0f89975b0162c31dfa8343c749a73  tuwunel.confd
"
