# Contributor: Eric Molitor <eric@molitor.org>
# Contributor: Bart≈Çomiej Piotrowski <bpiotrowski@alpinelinux.org>
# Maintainer: Eric Moltior <eric@molitor.org>
pkgname=lldb
# Note: Update together with llvm.
pkgver=7.0.1
pkgrel=0
_vermajor=${pkgver%%.*}
pkgdesc="Next generation, high-performance debugger"
arch="all"
url="https://llvm.org/"
license="UOI-NCSA"
makedepends="
	clang-dev>=$_vermajor
	clang-static>=$_vermajor
	cmake
	doxygen
	libedit-dev
	libffi-dev
	libxml2-dev
	linux-headers
	llvm-dev>=$_vermajor
	llvm-static>=$_vermajor
	ncurses-dev
	ninja
	python2
	python2-dev
	swig
	"
subpackages="$pkgname-dev py2-$pkgname:py2"
source="https://llvm.org/releases/$pkgver/$pkgname-$pkgver.src.tar.xz
	10-cmake-include-ClangConfig.patch"

builddir="$srcdir/$pkgname-$pkgver.src"

build() {
	mkdir -p "$builddir"/build
	cd "$builddir"/build

	CC=clang CXX=clang++ cmake .. -G Ninja -Wno-dev \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DCMAKE_C_FLAGS_MINSIZEREL_INIT="$CFLAGS" \
		-DCMAKE_CXX_FLAGS_MINSIZEREL_INIT="$CXXFLAGS" \
		-DCMAKE_EXE_LINKER_FLAGS_MINSIZEREL_INIT="$LDFLAGS" \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DPYTHON_EXECUTABLE=/usr/bin/python2 \
		-DLLVM_LINK_LLVM_DYLIB=ON 
	ninja
}

package() {
	cd "$builddir"/build

	DESTDIR="$pkgdir" ninja install
}

py2() {
       pkgdesc="Python module for LLDB"
       depends="$pkgname py2-six"
       replaces="py-lldb"
       local sitedir="usr/lib/python2.7/site-packages"

       mkdir -p "$subpkgdir"/$sitedir
       cd "$subpkgdir"

       mv "$pkgdir"/$sitedir ${sitedir%/*}/
       rmdir "$pkgdir"/${sitedir%/*}

       # Move binary lib to the module's directory.
       mv $sitedir/readline.so $sitedir/lldb/

       # Remove bundled module.
       rm $sitedir/six.py

       python2 -m compileall -fqd /$sitedir $sitedir
}

sha512sums="7e98c3148ac34b42404e5aaaff91728d19e9062110a333f0bc7a62ec324fbb6d033ea44b56e144dc1e94febb2107cfb33c71bb3602c2168a6270dd807a2cc5ff  lldb-7.0.1.src.tar.xz
bb6208994c964f6b59b9f0c956b92dec16c071696d8e29099f224479e49f28772f188acb8c5a370da916fb3bef73df97a7ff8c6fb61e4b8c52f993d4c087ff78  10-cmake-include-ClangConfig.patch"
