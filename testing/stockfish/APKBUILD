# Contributor: Prokop Randáček <prokop@rdck.dev>
# Maintainer: Prokop Randáček <prokop@rdck.dev>
pkgname=stockfish
pkgver=18
# See src/evaluate.h for these vars
_nnue_big="c288c895ea92"
_nnue_small="37f18f62d772"
pkgrel=0
pkgdesc="Strong chess engine"
url="https://stockfishchess.org/"
# s390x: doesn't build
# riscv64: intermittent test failures
arch="all !riscv64 !s390x"
license="GPL-3.0-only"
checkdepends="
	bash
	expect
	python3
	py3-requests
	"

# valgrind not available on armhf and loongarch64
case "$CARCH" in
	armhf|loongarch64) ;;
	*) checkdepends="$checkdepends valgrind" ;;
esac

source="$pkgname-$pkgver.tar.gz::https://github.com/official-stockfish/Stockfish/archive/refs/tags/sf_$pkgver.tar.gz
	https://tests.stockfishchess.org/api/nn/nn-$_nnue_big.nnue
	https://tests.stockfishchess.org/api/nn/nn-$_nnue_small.nnue
	no-lto.patch
	"
builddir="$srcdir/Stockfish-sf_$pkgver/src"

prepare() {
	default_prepare

	ln -sfv "$srcdir"/nn-$_nnue_big.nnue "$builddir"/
	ln -sfv "$srcdir"/nn-$_nnue_small.nnue "$builddir"/
}

build() {
	export CXXFLAGS="$CXXFLAGS -O2"
	export CPPFLAGS="$CPPFLAGS -O2"

	local arch
	case "$CARCH" in
	x86_64) arch=x86-64 ;;
	x86) arch=x86-32 ;;
	aarch64) arch=armv8 ;;
	armhf) arch=armv7 ;;
	armv7) arch=armv7 ;;
	loongarch64) arch=loongarch64 ;;
	ppc64le) arch=ppc-64 ;;
	riscv64) arch=riscv64 ;;
	*) die "Unable to determine architecture from CARCH=$CARCH" ;;
	esac

	make ARCH="$arch" profile-build
}

check() {
	# valgrind not available on armhf and loongarch64
	# valgrind tests fail on riscv64 and armv7
	case "$CARCH" in
		armhf|armv7|loongarch64|riscv64) ;;
		*)
			python3 ../tests/instrumented.py --valgrind ./stockfish
			python3 ../tests/instrumented.py --valgrind-thread ./stockfish
			;;
	esac

	# requires building with sanitizers
	# python3 ../tests/instrumented.py --sanitizer-undefined ./stockfish
	# python3 ../tests/instrumented.py --sanitizer-thread ./stockfish
	python3 ../tests/instrumented.py --none ./stockfish
	../tests/perft.sh
	../tests/reprosearch.sh
}

package() {
	install -Dm755 stockfish "$pkgdir"/usr/bin/stockfish
}

sha512sums="
e3a03f01c27632abc540a49e0314cbb2597b260a6fd21d80a378e515dbb58e3fa067586d9c21124519de9ebfa9023f69269da720cd048f941d9c255319beea7c  stockfish-18.tar.gz
9568d21d7b229ec9c8ee97363e94560858f3f44f4c6647ec11770f617b4a3b03cbcfa445c407f52a6104f281d43e19e0f461cc13c875218b543860ebc8411622  nn-c288c895ea92.nnue
bf4d01f8cbff94dbff484636dd0351cd66f37eeaea7b7dbe16a3bfe231ae78cfabdeed040b789b64049c6063ef0dca21e4a4f332b99e49a52993e8595e372839  nn-37f18f62d772.nnue
eb26852585faa5d8fae5f9a663a87a819aa47d70683c1ba75f5e13a328b78677472990471bfd03b935b52c02fe34bbf6e52d691c98bc36ff3dec6fa2e2491d27  no-lto.patch
"
