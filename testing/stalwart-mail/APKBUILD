# Contributor: Carlo Landmeter <clandmeter@alpinelinux.org>
maintainer="Matthias Ahouansou <matthias@ahouansou.cz>"
pkgname=stalwart-mail
pkgver=0.14.1
_nixver=0.30.1
pkgrel=0
pkgdesc="Secure & Modern All-in-One Mail Server"
url="https://github.com/stalwartlabs/stalwart"
arch="all"
license="AGPL-3.0-or-later"
makedepends="
	cargo
	cargo-auditable
	clang19-dev
	linux-headers
	protoc
	rocksdb-dev
	"
install="$pkgname.pre-install"
pkgusers="stalwart"
pkggroups="stalwart"
subpackages="$pkgname-openrc stalwart-cli:cli"
source="
	https://github.com/stalwartlabs/stalwart/archive/v$pkgver/stalwart-$pkgver.tar.gz
	nix-$_nixver.tar.gz::https://github.com/nix-rust/nix/archive/refs/tags/v$_nixver.tar.gz
	nix-s390x.patch
	$pkgname.initd
	$pkgname.confd
	"
builddir="$srcdir/stalwart-$pkgver"
options="net" # cargo crates

# To prevent OOM on armv7 and armhf
export CARGO_PROFILE_RELEASE_LTO="false"

# link against system rocksdb
export ROCKSDB_LIB_DIR="/usr/lib/"

prepare() {
	mv "$srcdir/nix-$_nixver" vendored-nix

	default_prepare
	cargo fetch --target="$CTARGET" --locked
}

build() {
	case "$CARCH" in
		arm*) export JEMALLOC_SYS_WITH_LG_PAGE=16;;
	esac
	cargo auditable build --frozen --release -p stalwart -p stalwart-cli
}

check() {
	# https://github.com/RustCrypto/elliptic-curves/issues/1097
	export RUST_MIN_STACK="4194304"
	cargo test --frozen -p stalwart -p stalwart-cli
}

cli() {
	pkgdesc="$pkgdesc (cli tool)"
	install -Dm 755 "$builddir"/target/release/stalwart-cli \
		"$subpkgdir"/usr/bin/stalwart-cli
}

package() {
	install -Dm 755 "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -Dm 644 "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname
	install -Dm 755 "$builddir"/target/release/stalwart \
		"$pkgdir"/usr/bin/stalwart
}

sha512sums="
844db6c54a4b5d20facc97a675ec7ff3a565bb0936e53e6f14661bdfd4dc248879657f0d71e842aa8f0d569af014261111c210a4267cc4102bb02dd61ae3a686  stalwart-0.14.1.tar.gz
94f5a72f099fbe488b2f09a9bbe33d63ad08308ee3c12999b8ad0743a3d9567b759799a32120575abdfb1ab6891cf83951acf7145408b27d3368b5c0f1e35d0a  nix-0.30.1.tar.gz
164f7cf2a5af19ac7abb824bc8639b643b05bd6a14f4121c00e2bdbd15cd44a5fe9f00198237ff67260950c2877defc42e6058333f1b418a00b10afe49843bc5  nix-s390x.patch
de1bd0a938f8e4ac14e03717e72a9bee9b7630f1d124138afb6ec83b5832c30e5b4406a8f7575ae3dd83a8f6019bd8ef53cc80af4b9713cdbc03eacc887a5ec9  stalwart-mail.initd
d61a79d874424c32916758d576861c00208233229b6c7e39302ed55d242a96571c41d8adccc9575dbe5524695bb9b18da46def16f6d57f2877470441d458498e  stalwart-mail.confd
"
