# Contributor: Carlo Landmeter <clandmeter@alpinelinux.org>
maintainer="Matthias Ahouansou <matthias@ahouansou.cz>"
pkgname=stalwart-mail
pkgver=0.15.5
_nixver=0.30.1
pkgrel=0
pkgdesc="Secure & Modern All-in-One Mail Server"
url="https://github.com/stalwartlabs/stalwart"
# rust 1.93, not architecture specific,
# see https://github.com/stalwartlabs/sieve/issues/14
arch="all !riscv64"
license="AGPL-3.0-or-later"
makedepends="
	cargo
	cargo-auditable
	clang19-dev
	linux-headers
	protoc
	rocksdb-dev
	"
install="$pkgname.pre-install"
pkgusers="stalwart"
pkggroups="stalwart"
subpackages="$pkgname-openrc stalwart-cli:cli"
source="
	https://github.com/stalwartlabs/stalwart/archive/v$pkgver/stalwart-$pkgver.tar.gz
	nix-$_nixver.tar.gz::https://github.com/nix-rust/nix/archive/refs/tags/v$_nixver.tar.gz
	nix-s390x.patch
	$pkgname.initd
	$pkgname.confd
	"
builddir="$srcdir/stalwart-$pkgver"
options="net" # cargo crates

# To prevent OOM on armv7 and armhf
export CARGO_PROFILE_RELEASE_LTO="false"

# link against system rocksdb
export ROCKSDB_LIB_DIR="/usr/lib/"

prepare() {
	mv "$srcdir/nix-$_nixver" vendored-nix

	default_prepare
	cargo fetch --target="$CTARGET" --locked
}

build() {
	case "$CARCH" in
		arm*) export JEMALLOC_SYS_WITH_LG_PAGE=16;;
	esac
	cargo auditable build --frozen --release --no-default-features -F rocks,sqlite,postgres,s3,redis -p stalwart -p stalwart-cli
}

check() {
	# https://github.com/RustCrypto/elliptic-curves/issues/1097
	export RUST_MIN_STACK="4194304"
	cargo test --frozen -p stalwart -p stalwart-cli
}

cli() {
	pkgdesc="$pkgdesc (cli tool)"
	install -Dm 755 "$builddir"/target/release/stalwart-cli \
		"$subpkgdir"/usr/bin/stalwart-cli
}

package() {
	install -Dm 755 "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -Dm 644 "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname
	install -Dm 755 "$builddir"/target/release/stalwart \
		"$pkgdir"/usr/bin/stalwart
}

sha512sums="
d174887bbb5b00cf363557c704c7ef4137db10e249952102df3de9a0183c78120a1a113c83104c2a7b07fc18a9a18a0e2ce5b2ce0dcc16607444a775cd862777  stalwart-0.15.5.tar.gz
94f5a72f099fbe488b2f09a9bbe33d63ad08308ee3c12999b8ad0743a3d9567b759799a32120575abdfb1ab6891cf83951acf7145408b27d3368b5c0f1e35d0a  nix-0.30.1.tar.gz
164f7cf2a5af19ac7abb824bc8639b643b05bd6a14f4121c00e2bdbd15cd44a5fe9f00198237ff67260950c2877defc42e6058333f1b418a00b10afe49843bc5  nix-s390x.patch
0e46afaae1315b04b67799fca33558b2840f13e73a49f6c8873dc2d615535fead4f3fd74f9e6e65c3ac5978913410895edd4baa6b10694a94d21d3827717d9fc  stalwart-mail.initd
d61a79d874424c32916758d576861c00208233229b6c7e39302ed55d242a96571c41d8adccc9575dbe5524695bb9b18da46def16f6d57f2877470441d458498e  stalwart-mail.confd
"
