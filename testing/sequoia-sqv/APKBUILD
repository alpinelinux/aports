# Contributor: tcely <sequoia-sqv+aports@tcely.33mail.com>
# Maintainer: tcely <sequoia-sqv+aports@tcely.33mail.com>
_project="sequoia"
pkgname="${_project}-sqv"
pkgver="0.4.1"
pkgrel=0
pkgdesc="A simple signature verification program"
url="https://sequoia-pgp.org/"
arch="x86_64" # limited by cargo
license="GPL-3.0-or-later"
depends=""
makedepends="capnproto-dev cargo clang-dev nettle-dev openssl-dev
	py3-cffi py3-pytest py3-setuptools python3-dev sqlite-dev"
install=""
subpackages=""
source="https://gitlab.com/${_project}-pgp/${_project}/-/archive/v${pkgver}/${_project}-v${pkgver}.tar.gz
	Cargo.lock
	"
builddir="$srcdir/${_project}-v${pkgver}"

_cargo_env() {
	cd "$builddir"

	CARGO_TARGET_DIR="$PWD/target"
	export CARGO_TARGET_DIR

	SQV="$CARGO_TARGET_DIR/release/sqv"
	export SQV
}

build() {
	_cargo_env

	sed -i -e '/^version =/s/=.*$/= "'"$pkgver"'"/' sqv/Cargo.toml
	install -m 00644 "$srcdir/Cargo.lock" "$builddir/Cargo.lock"

	make -C sqv build-release CARGO_FLAGS='--locked'
}

check() {
	_cargo_env

	cd sqv && cargo test --locked --release --package "$pkgname"

	"$SQV" --version
}

package() {
	_cargo_env

	make DESTDIR="$pkgdir" -C sqv install
}

sha512sums="44f4bfda6b59e8110eb283a6630c3c2d10f11dd1f061c632e66e13fb5d644a8991414743dc64235263379d518ce99c55a0dfacf74b957be10a038d0b37f021fb  sequoia-v0.4.1.tar.gz
6910c1939e976a9dd6debdd8148ede74c96221c814928871e6245fa664dafd0faeb40320ed65b651bb84003f13e13f47aeb9a05674f330f7bc644f283aaf76e5  Cargo.lock"
