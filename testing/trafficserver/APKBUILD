# Contributor: tcely <trafficserver+aports@tcely.33mail.com>
# Maintainer: tcely <trafficserver+aports@tcely.33mail.com>
_upstream="trafficserver"
pkgname="${_upstream}"
pkgver="8.0.5"
pkgrel=0
pkgdesc="high-performance building block for cloud services"
url="https://trafficserver.apache.org"
arch="x86_64" # 32-bit NOT supported
license="Apache-2.0"
options=""
pkgusers="trafsrvr"
pkggroups="trafsrvr"
depends=""
depends_dev="
	${pkgname}=${pkgver}-r${pkgrel}
	${pkgname}-perl=${pkgver}-r${pkgrel}
	bash
	curl-dev
	expat-dev
	hwloc-dev
	libexecinfo-dev
	linux-headers
	ncurses-dev
	openssl-dev
	pcre-dev
	tcl-dev
	xz-dev
	zlib-dev
	"
depends_perl="perl"
depends_static="${pkgname}-dev"
checkdepends="findutils"
makedepends="${depends_dev} autoconf automake perl python3"
install="${pkgname}.pre-install"
subpackages="
	${pkgname}-libs-static
	${pkgname}-libs
	${pkgname}-dev
	${pkgname}-doc
	${pkgname}-perl
	"
source="
	https://archive.apache.org/dist/${_upstream}/${_upstream}-${pkgver}.tar.bz2
	${pkgname}-GPGKEYS::https://archive.apache.org/dist/${_upstream}/KEYS
	trafficserver-ink_hrtime.patch
	trafficserver-musl-errno.patch
	trafficserver-pthread_getname_np.patch
	trafficserver-python3.patch
	trafficserver-sed-regex-fix.patch
	"
builddir="${srcdir}/${_upstream}-${pkgver}"

prepare() {
	default_prepare
	cd "${builddir}"

	autoreconf --verbose
}

build() {
# Fixed sed regex, so layout should handle these.
# Kept for easy reference if the layout breaks again.
#		--datadir="/usr/share/${_upstream}" \
#		--docdir="/usr/share/doc/${_upstream}" \
#		--includedir="/usr/include/${_upstream}" \
#		--libexecdir="/usr/libexec/${_upstream}" \

	./configure \
		--build="${CBUILD}" \
		--host="${CHOST}" \
		--prefix=/usr \
		--sysconfdir="/etc/${_upstream}" \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--with-user="${pkgusers%% *}" \
		--with-group="${pkggroups%% *}" \
		--enable-layout=GNU \
		--enable-hardening \
		--enable-static \
		--enable-wccp \
		--disable-unwind

	make
}

check() {
	local rc
	rc=0

	make check || {
		rc="${?}"
		find . -name 'test-suite.log' -type f -ls -printf '%P {{{\n' -exec cat -v -n '{}' ';' -printf '}}} %P\n'
	}

	return "${rc}"
}

package() {
	make DESTDIR="${pkgdir}" install

	cd "${pkgdir}"
	rm -v ./usr/bin/"${_upstream}" # unsupported OS
	find ./var -depth -type d -exec rmdir -v '{}' '+'
}

libs() {
	default_libs

	mkdir -p "${subpkgdir}"/usr/lib
	mv "${pkgdir}"/usr/lib/*.la \
		"${subpkgdir}"/usr/lib/
}

dev() {
	default_dev

	mkdir -p "${subpkgdir}"/usr/bin
	mv "${pkgdir}"/usr/bin/tsxs \
		"${subpkgdir}"/usr/bin/
}

doc() {
	default_doc

	cd "${pkgdir}"
	find ./usr/share -depth -type d -exec rmdir -v '{}' '+'
}

perl() {
	depends="${depends_perl}"
	install_if="${pkgname} perl"

	mkdir -p "${subpkgdir}"/usr/bin
	mv "${pkgdir}"/usr/bin/tspush \
		"${subpkgdir}"/usr/bin/

	mkdir -p "${subpkgdir}"/usr/lib
	mv "${pkgdir}"/usr/lib/perl* \
		"${subpkgdir}"/usr/lib/

	cd "${pkgdir}"
	find ./usr/lib -depth -type d -exec rmdir -v '{}' '+'
}

gpg_signature_extensions="asc"
gpgfingerprints="
	7AB1 5E5F DE19 55A5 0DA9  8605 533D EF15 5D7B BC5A
	32C4 0F5E 8875 D038 FF9C  F32B 080B 7012 2392 F5F3
	good:B280 1FF9 D757 E7C4 6D89  0C6C 4D15 4110 B845 08EC
	8716 7A9F 989B ABD5 100F  4008 F266 55D6 2998 1641
	5DA9 0733 1A7F D64A DE9B  6501 1AEC CE28 DAE1 FE2B
	F918 A5D2 EDDF 5F7C 6AB6  7CB4 71C5 6709 1DE0 0649
	"

sha512sums="cd2952d40a2352a9abeb96ac061136b79a689a7f86618f32e468a415f3b50ab5d7e528b2b2b67c9cf19c03ae566f48b719e6cc2a6701ccc1ae3718151ea1afc4  trafficserver-8.0.5.tar.bz2
b43cd2da9894df8c8f4caad7c4c3a095303ab2f45f80815902505fa35c25f600d8a7a09f7ed659408bc3ccea0697c53debcc0d7b3ed14a4401383371f604e81b  trafficserver-GPGKEYS
ba5e38172b7f0f98dece0fe740a3a36638f45d5b90698940e5da1d8fc7214587b084236f8fa581da12655511dc77955189b0cfc963750bcf6f6b1ada4c741b99  trafficserver-ink_hrtime.patch
482c1a048005554f13eb886cf702aa7764ade1233b0df6668d0d62bd7bae985cd7a1ad3eacc049421dbdf192f95a92335a5ccb96fdaf1c1826d221ee552f53bb  trafficserver-musl-errno.patch
6fdc30ae8c09ed80d5d048901f045ec8bad6a3787b7b3feabeb94e60f018ce57fc385bb86e2ff0521fd715f1574c1516e7c1f4197ec1a978e40a27c769e7f1ec  trafficserver-pthread_getname_np.patch
c2c5cc7f6d442c2d4cc1b29465e9a45c4432b8eed70bc382bfd2ab2e77ea5a1531a847a6ea7c2e7f3fa1b4ed2ed0f2577e42409d77eaf8fb0ce2f2457f3e0e9a  trafficserver-python3.patch
17d56a22a8c29b5f000390462f42e645f4595ea2eb7b7820079ebd13ba866264e5dde6a21ce8609d2331a7e2d9a9ea10e09759fa964a2a45553bfbdedb2db1ee  trafficserver-sed-regex-fix.patch"
