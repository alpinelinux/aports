# Contributor: kpcyrd <git@rxv.cc>
# Maintainer: kpcyrd <git@rxv.cc>
pkgname=meek
pkgver=0.30
pkgrel=0
pkgdesc="A pluggable transport proxy written in Go"
url="https://trac.torproject.org/projects/tor/wiki/doc/meek"
arch="all"
license="CC0-1.0"
depends="ca-certificates"
makedepends="glide go libcap"
subpackages="$pkgname-doc"
# no test suite available
options="!check"
source="$pkgname-$pkgver.tar.gz::https://gitweb.torproject.org/pluggable-transports/$pkgname.git/snapshot/$pkgname-$pkgver.tar.gz
	glide.lock
	glide.yaml
	"
builddir="$srcdir/$pkgname-$pkgver"

prepare() {
	export GOPATH="$startdir"
	cd "$builddir"
	cp "$srcdir"/glide.yaml "$srcdir"/glide.lock .
	glide install --skip-test
	default_prepare
}

build() {
	export GOPATH="$startdir"
	cd "$builddir"
	go build -v -ldflags "-s -w" \
		-o meek-client/meek-client ./meek-client/...
	go build -v -ldflags "-s -w" \
		-o meek-server/meek-server ./meek-server/...
}

package() {
	cd "$builddir"
	install -Dm 755 meek-client/meek-client "$pkgdir/usr/bin/meek-client"
	install -Dm 755 meek-server/meek-server "$pkgdir/usr/bin/meek-server"
	setcap 'cap_net_bind_service=+ep' "$pkgdir/usr/bin/meek-server"

	mkdir -p "$pkgdir/usr/share/man/man1"
	install -Dm644 doc/*.1 -t "$pkgdir/usr/share/man/man1"
	install -Dm644 COPYING "$pkgdir/usr/share/licenses/$pkgname/COPYING"

	install -Dm644 README "$pkgdir/usr/share/doc/$pkgname/README"
	install -Dm644 meek-client/torrc "$pkgdir/usr/share/doc/$pkgname/torrc.meek-client"
	install -Dm644 meek-server/torrc "$pkgdir/usr/share/doc/$pkgname/torrc.meek-server"
}

glide_init() {
	abuild clean deps unpack prepare
	cd "$builddir"
	export GOPATH="$startdir"
	rm -f glide.yaml glide.lock
	glide init --non-interactive
	glide update
	cp glide.yaml glide.lock "$startdir"
	cd "$startdir" && abuild checksum clean
}

sha512sums="5dd989d6800f4aaca9e5f66acf325afbb4fea70a8347a1fdff77381b28d5b9762f9d7a45b4375086d9167e1a407e53aa1d1b3203eaa09e3f8e36f2a9805dcc3d  meek-0.30.tar.gz
dc2c87fd248e3b6c7ce4e2b85cc4c1054373022f47f7b5bf54c30e0e5c35e9f9ed76ab85ac6034bbd92a562829a47f39adf40650ed75a3c2057ff924e9df97f2  glide.lock
fc468edcb8c38ad422be4b204c9ae1d0aff5817b442979330038789cbbe816f70ada8ccd107b88635da2c6ff3a1d62b3f28026cf3022edacf705359a06a077f7  glide.yaml"
