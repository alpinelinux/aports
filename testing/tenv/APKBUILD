# Contributor: Alexander Sharov <kvendingoldo@gmail.com>
# Maintainer: Alexander Sharov <kvendingoldo@gmail.com>
pkgname=tenv
pkgver=4.9.0
pkgrel=1
pkgdesc="OpenTofu, Terraform, Terragrunt, and Atmos version manager"
license="Apache-2.0"
arch="all"
url="https://github.com/tofuutils/tenv"
source="tenv-$pkgver.tar.gz::https://github.com/tofuutils/tenv/archive/v$pkgver.tar.gz"
options="net"
depends="cosign !terraform !tofu !terragrunt !atmos"
makedepends="go cosign"

subpackages="
	$pkgname-bash-completion
	$pkgname-fish-completion
	$pkgname-zsh-completion
	"

export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

build() {
	local i
	mkdir build
	for i in tenv terraform terragrunt tf tofu atmos; do
		go build -ldflags "-s -w -X main.version=v$pkgver" -o build/$i ./cmd/$i
	done

	for i in bash fish zsh; do
		./build/tenv completion $i > ./tenv.$i
	done
}

check() {
	make test
}

package() {
	install -Dm755 -t "$pkgdir"/usr/bin build/*

	install -Dm644 ./tenv.bash $pkgdir/usr/share/bash-completion/completions/tenv
	install -Dm644 ./tenv.fish $pkgdir/usr/share/fish/vendor_completions.d/tenv.fish
	install -Dm644 ./tenv.zsh $pkgdir/usr/share/zsh/site-functions/tenv
}

sha512sums="
abe18c967059da52ca9cc2abab7b0e2710b1fc1049ad357409f13550a559e6b0a7e21f341cb6a8a2e79cb7cc833abe6b17baf8dd3397cccbe609c6e6437f957a  tenv-4.9.0.tar.gz
"
