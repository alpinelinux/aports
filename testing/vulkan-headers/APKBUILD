# Contributor: Mark Riedesel <mark@klowner.com>
# Maintainer: Mark Riedesel <mark@klowner.com>
pkgbase=vulkan
pkgname=$pkgbase-headers
pkgver=1.0.34
pkgrel=0
pkgdesc="Vulkan development headers"
url="https://www.khronos.org/vulkan/"
arch="noarch"
license="custom"
depends=""
makedepends="asciidoc tinyxml2-dev gcc sed python3"
install=""
subpackages="$pkgbase-doc $pkgbase-html-doc:_htmldoc"
archive_name="Vulkan-Docs"
source="$pkgname-$pkgver.tar.gz::https://github.com/KhronosGroup/Vulkan-Docs/archive/v${pkgver}-core.tar.gz
	https://raw.githubusercontent.com/KhronosGroup/Vulkan-Hpp/master/VulkanHppGenerator.cpp"
builddir="$srcdir/${archive_name}-${pkgver}-core"

build() {
	# Generate headers
	g++ VulkanHppGenerator.cpp -DVK_SPEC="\"vk.xml\"" -DVULKAN_HPP="\"vulkan.hpp\"" \
		-I/usr/include/tinyxml2 -ltinyxml2 -o VulkanHppGenerator

	./VulkanHppGenerator ${builddir}/src/spec/vk.xml

	cd "$builddir"/doc/specs/vulkan

	# Broken, see https://github.com/KhronosGroup/Vulkan-Docs/issues/367
	LANG="en_US.UTF8" make manpages
	LANG="en_US.UTF8" make manpages
	./makeKHR chunked

	# Compress manpages
	find "$builddir"/out/1.0/man/3/*.3 -exec gzip {} \;
}

package() {
	cd "$builddir"

	mkdir -p \
		"$pkgdir"/usr/include/vulkan \
		"$pkgdir"/usr/share/vulkan \
		"$pkgdir"/usr/share/licenses/vulkan

	mv src/vulkan/vk_platform.h "$pkgdir"/usr/include/vulkan/
	mv src/vulkan/vulkan.h "$pkgdir"/usr/include/vulkan/
	mv src/spec/vk.xml "$pkgdir"/usr/share/vulkan/

	cp doc/specs/vulkan/copyright-ccby.txt "$pkgdir"/usr/share/licenses/vulkan/
	cp doc/specs/vulkan/copyright-spec.txt "$pkgdir"/usr/share/licenses/vulkan/
}

_htmldoc() {
	pkgdesc="Vulkan html documentation"
	cd "$builddir"

	mkdir -p "$subpkgdir"/usr/share/doc/vulkan
	mv -v out/1.0/chunked/* "$subpkgdir"/usr/share/doc/vulkan
}

doc() {
	pkgdesc="Vulkan man pages"
	cd "$builddir"

	mkdir -p "$subpkgdir"/usr/share/man/man3
	mv out/1.0/man/3/*.3.gz "$subpkgdir"/usr/share/man/man3/
}

md5sums="4042f31dc6bc171a2204ca51d9f75571  vulkan-headers-1.0.34.tar.gz
6f3721315eca039b8179c1689e78323f  VulkanHppGenerator.cpp"
sha256sums="6e255f256f41bfea3c8201eb0042b672577f885b03e566e22b83e30f1396843b  vulkan-headers-1.0.34.tar.gz
13b80a85ebdedc3d398d3a2b7bb3c3ad5bd00e7742be4afc3ba8cb3a20a438ab  VulkanHppGenerator.cpp"
sha512sums="2820a98e6dda00fda84d8e306105a97a7b3a5ae53be708be3141802631ebd39c71ba8904f877c1912874f8739fdefe73d232cc288a8d48c4de1f8120f5442e99  vulkan-headers-1.0.34.tar.gz
ae2c8fe8af348322c5878b24d3e1199f83a50f507c7627396622af0dd1603d5eabe275b65ce32fd3544fb4e327ec2fbcccc3db73061d4dc435b66825b6ce3a48  VulkanHppGenerator.cpp"
