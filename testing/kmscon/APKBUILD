# Contributor: Patrycja Rosa <alpine@ptrcnull.me>
# Maintainer: Patrycja Rosa <alpine@ptrcnull.me>
pkgname=kmscon
pkgver=9.2.1
pkgrel=1
pkgdesc="Simple terminal emulator based on linux kernel mode setting"
url="https://github.com/kmscon/kmscon"
# ppc64le: FTBFS: compiled for a big endian system and target is little endian
arch="all !ppc64le"
license="MIT AND LGPL-2.1-or-later AND ( OFL-1.1 AND GPL-2.0-or-later WITH Font-exception-2.0 ) AND MIT AND BSD-2-Clause AND custom"
makedepends="
	eudev-dev
	libdrm-dev
	libtsm-dev
	libxkbcommon-dev
	mesa-dev
	meson
	pango-dev
	"
checkdepends="mesa-dri-gallium xvfb-run"
subpackages="$pkgname-doc $pkgname-openrc $pkgname-systemd"
source="$pkgname-$pkgver.tar.gz::https://github.com/kmscon/kmscon/archive/refs/tags/v$pkgver.tar.gz
	kmsconvt.initd
	"
# requires opening raw tty
options="!spdx !check"

build() {
	abuild-meson \
		-Db_lto=true \
		-Dtests="$(want_check && echo true || echo false)" \
		. output

	meson compile -C output
}

check() {
	xvfb-run -a meson test --print-errorlogs -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output

	install -Dm755 "$srcdir"/kmsconvt.initd "$pkgdir"/etc/init.d/kmsconvt
}

sha512sums="
927158f18ff3adaa794dcdf14ad98d4fac977b90d647a45408738a4a3e0c1e5e843cb63bcf1186f05559513af32321831bd9796cadf7a7a0fe9bb842c5ce2180  kmscon-9.2.1.tar.gz
45ed47dcec4a257d8257389b83df0a82c38c33ba7dec6c0f13eb381cbc7acb1854df4b2d0ffeb4a2469f9c8cf90b0e870d8f1d5eb1c87a4e92025d8f1c0ea287  kmsconvt.initd
"
