# Contributor: Leonardo Arena <rnalrd@alpinelinux.org>
# Maintainer:
pkgname=homer-api
pkgver=5.0.6
pkgrel=5
pkgdesc="HOMER API"
url="https://github.com/sipcapture/homer-api"
arch="noarch"
license="GPL"
depends="homer-db php5-pdo_mysql"
depends_dev=
makedepends="$depends_dev"
install=
subpackages="$pkgname-doc homer-db"
source="$pkgname-$pkgver.tar.gz::https://github.com/sipcapture/homer-api/archive/$pkgver.tar.gz
        homer_db_init
        rotation-ini-path.patch"
builddir="$srcdir"/$pkgname-$pkgver

build() {
	return 0
}

package() {
	cd "$builddir"
	local file
	local appdir=$pkgdir/usr/share/webapps/homer

	mkdir -p "$appdir" \
		"$pkgdir"/etc/homer \
		"$pkgdir"/usr/share/doc/homer-api

	mv api "$appdir"

	for file in configuration preferences; do
		mv "$appdir"/api/${file}_example.php "$pkgdir"/etc/homer/$file.php
		ln -s /etc/homer/$file.php "$appdir"/api
	done

	cp -R examples "$pkgdir"/usr/share/doc/homer-api
}

db() {
	depends="mariadb-client perl perl-dbi perl-dbd-mysql"

	cd "$builddir"
	mkdir -p \
		"$subpkgdir"/etc/periodic/daily \
		"$subpkgdir"/usr/share/homer-db

	install -D -m 644 scripts/rotation.ini \
		"$subpkgdir"/etc/homer/rotation.ini
	cp -p sql/* "$subpkgdir"/usr/share/homer-db

	install -D "$srcdir"/homer_db_init "$subpkgdir"/usr/bin/homer_db_init
	cp -p scripts/homer_* "$subpkgdir"/usr/bin
	ln -s /usr/bin/homer_rotate "$subpkgdir"/etc/periodic/daily
}

sha512sums="620185c19bd348ba68bad3a1992b7d673d29dcfb8a0aeea437a2d31e90f0a21cf6f46a43f0041a583a14d9403e1d8574c6040da1dba397ec2d955b8aba9010d8  homer-api-5.0.6.tar.gz
25c92652f63c9a7864ab42a690672369ef16bae71b32c7702c4100e6a067c989573959889beca674825e89cf48b2e8cbf16aacad03728ef3d1c43a788a73f84a  homer_db_init
b7a072cee1d64ec712fb4e9b7ac4191581f9babaf92c3088b8c6bbcc6e72d3f588015894835d7cdab281ba6963dcb15e8f9197fc9ee138cb329104beac5654e7  rotation-ini-path.patch"
