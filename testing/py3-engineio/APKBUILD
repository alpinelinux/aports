maintainer="Hugo Osvaldo Barrera <hugo@whynothugo.nl>"
pkgname=py3-engineio
_pkgname=python-engineio
pkgver=4.12.3
pkgrel=0
pkgdesc="Engine.IO server and client"
url="https://github.com/miguelgrinberg/python-engineio"
# riscv64: py3-eventlet
arch="noarch !riscv64"
license="MIT"
depends="
	py3-requests
	py3-simple-websocket
	py3-websocket-client
"
makedepends="
	py3-gpep517
	py3-setuptools
	py3-sphinx
	py3-wheel
"
checkdepends="
	py3-aiohttp
	py3-eventlet
	py3-gevent
	py3-gevent-websocket
	py3-pytest
	py3-pytest-asyncio
	py3-tornado
"
subpackages="$pkgname-pyc $pkgname-doc"
source="$pkgname-$pkgver.tar.gz::$url/archive/refs/tags/v$pkgver.tar.gz"
builddir="$srcdir/$_pkgname-$pkgver"

build() {
	gpep517 build-wheel --wheel-dir dist --output-fd 3 3>&1
	PYTHONPATH="$PWD/src" make -j1 -C docs man text SPHINXBUILD=sphinx-build
}

check() {
	python3 -m venv --system-site-packages test-env
	test-env/bin/python -m installer dist/*.whl
	test-env/bin/python -m pytest \
		--deselect tests/common/test_server.py::TestServer::test_async_mode_eventlet
}

package() {
	python3 -m installer --destdir="$pkgdir" dist/*.whl
	install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
	install -Dm644 docs/_build/text/*.txt "$pkgdir/usr/share/doc/$pkgname/"
	install -Dm644 docs/_build/man/python-engineio.1 \
		"$pkgdir/usr/share/man/man1/$pkgname.1"
	install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}

sha512sums="
db394dd8e08402b021d46721ddc321b87b0127986b6561b698098c7979d39f68ee08219e4b3c679e69e16678fb89ec3ad63ac127b1b0e4cd2e6edf2f4ce18053  py3-engineio-4.12.3.tar.gz
"
