# Maintainer: Ariadne Conill <ariadne@dereferenced.org>
pkgname=uclient
pkgver=20251003
pkgrel=0
pkgdesc="ustream-based HTTP client library"
url="https://git.openwrt.org/project/uclient.git"
arch="all"
license="ISC"
depends_dev="libubox-dev ustream-ssl-dev"
makedepends="cmake samurai ucode-dev zstd $depends_dev"
subpackages="$pkgname-dev $pkgname-fetch:_fetch"
_owrtgit=dc909ca7
_owrtver="${pkgver:0:4}.${pkgver:4:2}.${pkgver:6:2}~$_owrtgit"
source="https://sources.openwrt.org/uclient-$_owrtver.tar.zst"
builddir="$srcdir/uclient-$_owrtver"

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		CMAKE_CROSSOPTS="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=True \
		-DCMAKE_BUILD_TYPE=None \
		$CMAKE_CROSSOPTS .
	cmake --build build
}

check() {
	cd build
	ctest
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

_fetch() {
	amove usr/bin/uclient-fetch
}

sha512sums="
68f126b1225ac52acbdbf426f18547311722c1698ad09a7c88bc6866a2050e3cdb011fada41e6546e30b9a0bce300ea556733c56fa72e289a23b63e4e97a3c9b  uclient-2025.10.03~dc909ca7.tar.zst
"
