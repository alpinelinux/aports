# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=sbcl-loongarch
pkgver=2.6.0_git20260120
_gitrev=2e0b93ae5ce33aad132663315bb3101257e9610d
pkgrel=0
_bootrev=2e0b93ae5ce33aad132663315bb3101257e9610d
pkgdesc="Steel Bank Common Lisp (for bootstrapping Loongarch)"
url="https://www.sbcl.org/"
arch="loongarch64"
license="custom"
makedepends="linux-headers"
source="https://github.com/sbcl/sbcl/archive/$_gitrev/sbcl-$_gitrev.tar.gz
	https://dev.alpinelinux.org/archive/sbcl-loongarch/sbcl-$_bootrev-loongarch64-linux-musl-binary.tgz
	sigcontext.patch
	"
builddir="$srcdir/sbcl-$_gitrev"
options="!check" # stage0 compiler

: "${SBCL_SELF_HOST:=true}"
if $SBCL_SELF_HOST; then
	_bootstrap_cl="sbcl --xc-host=$srcdir/bootsbcl/bin/sbcl"
else
	makedepends="$makedepends ecl-dev"
	_bootstrap_cl="ecl"
fi

prepare() {
	default_prepare

	if [ ! -f "version.lisp-expr" ]; then
		echo "\"${pkgver%%_git*}\"" > version.lisp-expr
	fi
}

build() {
	# sb-simd is only built on x86_64 for now,
	# and is not needed for bootstrapping sbcl.
	./make.sh $_bootstrap_cl \
		--prefix=/usr \
		--without-sb-simd
}

package() {
	# omit docs for stage0 compiler
	BUILD_ROOT="$pkgdir" \
	MAN_DIR="/.omit" \
	INFO_DIR="/.omit" \
	DOC_DIR="/.omit" \
		./install.sh

	rm -rv "$pkgdir"/.omit
}

create_binary() {
	local pkgdir=$(mktemp -dup "$tmpdir")
	(cd "$builddir"; package)

	(
		cat <<-'EOF'
			bin/sbcl
			lib/sbcl/sbcl.core
		EOF
	) | tar -C "$pkgdir"/usr \
		-zcf "sbcl-$_gitrev-$CARCH-linux-musl-binary.tgz" \
		--transform 's|^|bootsbcl/|' \
		--numeric-owner --owner=0 --group=0 -T -
}

sha512sums="
1b6a0e169395fac8564c25475a0c8471a7669ee438fca8dcbe04d6e98d6339f918e2379419666bf4fdf0b26802ee2e951145bc69b1d5b84b3c90e4c283716ffb  sbcl-2e0b93ae5ce33aad132663315bb3101257e9610d.tar.gz
fc686b9d7e64dedd642d1cfa467c0bc578900b8dc0d6774ec5288858b5493ffea6e3b6f284123fa4dc668875236cfde42986b326fc5889edc34cdafbd2ee4e94  sbcl-2e0b93ae5ce33aad132663315bb3101257e9610d-loongarch64-linux-musl-binary.tgz
36c5efafcd15a4d05423b41204928f7e8c89378361c2a6fa8e1b59fa361296aa153c26b9245fd68da95b9851b2c1ec93ce390736ff30a29c2cc60dc737252096  sigcontext.patch
"
