maintainer="Lauri Tirkkonen <lauri@hacktheplanet.fi>"
pkgname=kubectl-cnpg
pkgver=1.28.1
pkgrel=0
pkgdesc="kubectl plugin for cloudnative-pg"
url="https://github.com/cloudnative-pg/cloudnative-pg"
# armhf: no kubectl
arch="all !armhf"
license="Apache-2.0"
depends="kubectl"
makedepends="go"
source="https://github.com/cloudnative-pg/cloudnative-pg/archive/refs/tags/v$pkgver/cloudnative-pg-$pkgver.tar.gz"
builddir="$srcdir/cloudnative-pg-$pkgver"
options="net"

build() {
	go build -v ./cmd/kubectl-cnpg
}

check() {
	# TestPlugin requires a working kube apiserver to test against, either
	# one that exists or one that is bootstrapped via the test code using
	# kubebuilder. we don't have a kubebuilder package, so skip TestPlugin
	# for now.
	KUBECONFIG=/dev/null go test -v \
		-skip TestPlugin \
		./cmd/kubectl-cnpg/... ./internal/cmd/plugin/...
}

package() {
	install -Dm755 kubectl-cnpg "$pkgdir"/usr/bin/kubectl-cnpg
}

sha512sums="
051dcb3a64f58709b537bb20cfb9b169967cae69c038567c5c809916273732d3ab0faa62fdef8d74a8cc6f716162dc2e6494c243a3177e27d4e4468841fe7509  cloudnative-pg-1.28.1.tar.gz
"
