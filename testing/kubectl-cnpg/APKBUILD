maintainer="Lauri Tirkkonen <lauri@hacktheplanet.fi>"
pkgname=kubectl-cnpg
pkgver=1.28.0
pkgrel=0
pkgdesc="kubectl plugin for cloudnative-pg"
url="https://github.com/cloudnative-pg/cloudnative-pg"
# armhf: no kubectl
arch="all !armhf"
license="Apache-2.0"
depends="kubectl"
makedepends="go"
source="https://github.com/cloudnative-pg/cloudnative-pg/archive/refs/tags/v$pkgver/cloudnative-pg-$pkgver.tar.gz"
builddir="$srcdir/cloudnative-pg-$pkgver"
options="net"

build() {
	go build -v ./cmd/kubectl-cnpg
}

check() {
	# TestPlugin requires a working kube apiserver to test against, either
	# one that exists or one that is bootstrapped via the test code using
	# kubebuilder. we don't have a kubebuilder package, so skip TestPlugin
	# for now.
	KUBECONFIG=/dev/null go test -v \
		-skip TestPlugin \
		./cmd/kubectl-cnpg/... ./internal/cmd/plugin/...
}

package() {
	install -Dm755 kubectl-cnpg "$pkgdir"/usr/bin/kubectl-cnpg
}

sha512sums="
c18d1d694dc019ae294ab6a9994a2f7ad6e29e83b041e3db7f9904fea09db3d339fd5dedd555c18fb6c5008576bfed4fa2c1db8b9142b56239105ef21916fa23  cloudnative-pg-1.28.0.tar.gz
"
