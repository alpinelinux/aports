# Contributor: Dmitry Zakharchenko <dmitz@disroot.org>
maintainer="Leon White <badfunkstripe@gmail.com>"
pkgname=subliminal
pkgver=2.4.0
pkgrel=0
pkgdesc="Python library and CLI tool for searching and downloading subtitles"
url="https://github.com/Diaoul/subliminal"
arch="noarch"
license="MIT"
depends="
		py3-babelfish
		py3-beautifulsoup4
		py3-chardet
		py3-click
		py3-click-option-group
		py3-colorama
		py3-defusedxml
		py3-dogpile.cache
		py3-enzyme
		py3-guessit
		py3-knowit
		py3-platformdirs
		py3-pysubs2
		py3-rarfile
		py3-requests
		py3-setuptools
		py3-srt
		py3-stevedore
		py3-tomli
		py3-tomlkit
		"
makedepends="
	py3-gpep517
	py3-hatch-vcs
	py3-hatchling
	py3-setuptools
	"
checkdepends="
	libarchive-tools
	py3-pytest
	py3-pytest-runner
	py3-sympy
	py3-vcrpy
	python3-dev
	"
subpackages="$pkgname-pyc"
source="$pkgname-$pkgver.tar.gz::https://github.com/Diaoul/subliminal/archive/$pkgver.tar.gz
	https://downloads.sourceforge.net/project/matroska/test_files/matroska_test_w1_1.zip
	s390x-utf-16.patch
	"

prepare() {
	default_prepare
	mkdir -p "$builddir"/tests/data/mkv
	mv "$srcdir"/test*.mkv "$builddir"/tests/data/mkv
}

build() {
	export SETUPTOOLS_SCM_PRETEND_VERSION=$pkgver
	gpep517 build-wheel \
		--wheel-dir .dist \
		--output-fd 3 3>&1 >&2
}

check() {
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	gpep517 install-wheel --destdir .testenv --prefix '' .dist/*.whl
	# unrar not available
	.testenv/bin/python3 -m pytest \
		--deselect tests/test_archives.py::test_scan_archive_with_no_video
}

package() {
	gpep517 install-wheel --destdir "$pkgdir" \
		.dist/*.whl
}

sha512sums="
f3555bb8ea8dac57663bef6170869040abbfaa191ea335804633d21618044810af9983241ff69fd2a5eb7ebe5acfbada99235ea0e71e883349de4b938f0e2fc7  subliminal-2.4.0.tar.gz
f170a8e83dab15228f992b3692330163da2402b8e436c7fa195ac1ecc06cf1eaf1a48d8c99a85c031122c158c2d4006023aae75d5b7805385ba25a6d601cb78f  matroska_test_w1_1.zip
904c1a8a52db60e2919ee4a7a5d2350f7d1bef2c0b8457e4ccd5e971ccf96c17f7afc25f6df69931546e893febbaf13393d727afa62e6dfd919387616f9822e3  s390x-utf-16.patch
"
