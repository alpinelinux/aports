# Contributor: Holger Jaekel <holger.jaekel@gmx.de>
# Maintainer: Holger Jaekel <holger.jaekel@gmx.de>
pkgname=openjdk10
_majorver=10
_minorver=0
_securityver=2
_updatever=13
pkgver=${_majorver}.${_minorver}.${_securityver}.u${_updatever}
_hg_tag=jdk-${_majorver}.${_minorver}.${_securityver}+${_updatever}
pkgrel=0
pkgdesc="OpenJDK Java ${_majorver} environment"
url="http://openjdk.java.net/"
arch="all"
license="GPLv2+CE"
depends="$pkgname-headless"
depends_dev=""
makedepends="
	$depends_dev
	alsa-lib-dev
	autoconf
	bash
	cups-dev
	fontconfig-dev
	giflib-dev
	graphviz
	grep
	lcms2-dev
	libexecinfo-dev
	libjpeg-turbo-dev
	libpng-dev
	libx11-dev
	libxext-dev
	libxrender-dev
	libxt-dev
	libxtst-dev
	linux-headers
	openjdk9-dev
	unzip
	zip
	zlib-dev
	"

case $CARCH in
x86)	_jarch=i386;;
x86_64)	_jarch=amd64;;
arm*)	_jarch=aarch32;;
*)	_jarch="$CARCH";;
esac

_java_home="/usr/lib/jvm/java-${_majorver}-openjdk"
_jrelib="$_java_home/jre/lib/$_jarch"

install=""
subpackages="
	$pkgname-jmods
	$pkgname-headless
	$pkgname-dev
	$pkgname-examples:examples:noarch
	$pkgname-doc
	$pkgname-src:src:noarch
	"
source="
	http://hg.openjdk.java.net/jdk-updates/jdk${_majorver}u/archive/${_hg_tag}.tar.bz2
	10-portola.patch

	TestCryptoLevel.java
	TestECDSA.java
	"
builddir="$srcdir/jdk${_majorver}u-${_hg_tag}"
_jdkrelease="$builddir/build/linux-${CARCH}-normal-server-release/images/jdk"
_docsrelease="$builddir/build/linux-${CARCH}-normal-server-release/images/docs"

build() {
	cd "$builddir"
	NUM_PROC_OPT=''
	MAKEFLAG_J=$(echo ${MAKEFLAGS} | sed -En 's/.*-j([0-9]+).*/\1/p')
	if [ -n "${MAKEFLAG_J}" ]; then
		# http://hg.openjdk.java.net/jdk10/jdk10/file/85e6cb013b98/make/InitSupport.gmk#l105
		echo "Removing '-j${MAKEFLAG_J}' from MAKEFLAGS to prevent build fail. Passing it directly to ./configure."
		export MAKEFLAGS=${MAKEFLAGS/-j${MAKEFLAG_J}/}
		NUM_PROC_OPT="--with-num-cores=${MAKEFLAG_J}"
	fi

	# CFLAGS, CXXFLAGS and LDFLAGS are ignored as shown by a warning
	# in the output of ./configure unless used like such:
	#  --with-extra-cflags="${CFLAGS}"
	#  --with-extra-cxxflags="${CXXFLAGS}"
	#  --with-extra-ldflags="${LDFLAGS}"
	# See also paragraph "Configure Control Variables from "jdk${_majorver}-${_hg_tag}/common/doc/building.md
	_CFLAGS="$CFLAGS"
	_CXXFLAGS="$CXXFLAGS"
	_LDFLAGS="$LDFLAGS"
	unset CFLAGS
	unset CXXFLAGS
	unset LDFLAGS
	unset MAKEFLAGS

	bash configure \
		--with-version-build="${_updatever}" \
		--with-version-pre="" \
		--with-version-opt="" \
		--with-stdc++lib=dynamic \
		--with-extra-cflags="${_CFLAGS}" \
		--with-extra-cxxflags="${_CXXFLAGS}" \
		--with-extra-ldflags="${_LDFLAGS}" \
		--with-libjpeg=system \
		--with-giflib=system \
		--with-libpng=system \
		--with-lcms=system \
		--with-zlib=system \
		--with-native-debug-symbols=none \
		--enable-unlimited-crypto \
		--disable-warnings-as-errors \
		--with-extra-cflags="${_CFLAGS}" \
		--with-extra-cxxflags="${_CXXFLAGS}" \
		--with-extra-ldflags="${_LDFLAGS}" \
		--with-jvm-variants=server \
		${NUM_PROC_OPT}
	make images docs
}

# TODO: As long as the JTReg package is not available, we cannot execute the regression tests.
check() {
	cd "$_jdkrelease"

	./bin/java --version | grep "${_majorver}.${_minorver}.${_securityver}+${_updatever}"

	# Check unlimited policy has been used
	./bin/javac -d . $srcdir/TestCryptoLevel.java
	./bin/java -cp . --add-opens java.base/javax.crypto=ALL-UNNAMED TestCryptoLevel

	# Check ECC is working
	./bin/javac -d . $srcdir/TestECDSA.java
	./bin/java -cp . TestECDSA

	# Check src.zip has all sources. See RHBZ#1130490
	./bin/jar -tf ./lib/src.zip | grep 'sun.misc.Unsafe'

	# Check class files include useful debugging information
	./bin/javap -l java.lang.Object | grep "Compiled from"
	./bin/javap -l java.lang.Object | grep LineNumberTable
	./bin/javap -l java.lang.Object | grep LocalVariableTable

	# Check generated class files include useful debugging information
	./bin/javap -l java.nio.ByteBuffer | grep "Compiled from"
	./bin/javap -l java.nio.ByteBuffer | grep LineNumberTable
	./bin/javap -l java.nio.ByteBuffer | grep LocalVariableTable

}

package() {
	local file dir
	for file in lib/libawt_xawt.so \
		lib/libjawt.so \
		lib/libsplashscreen.so; do

		dir=${file%/*}
		mkdir -p "$pkgdir/$_java_home/$dir"
		mv "$_jdkrelease/$file" "$pkgdir/$_java_home/$dir"
	done



	local file dir
	for file in api \
				resources \
				specs \
				index.html; do

		dir=${file%/*}
		mkdir -p "$pkgdir/usr/share/doc/java-${_majorver}-openjdk/javadoc/$dir"
		mv "$_docsrelease/"$file "$pkgdir/usr/share/doc/java-${_majorver}-openjdk/javadoc/$dir"
	done

	for file in 16 \
				24 \
				32 \
				48; do

		dir=${file%/*}
		mkdir -p "$pkgdir/usr/share/icons/hicolor/${file}x${file}/apps"
		mv "$builddir"/src/java.desktop/unix/classes/sun/awt/X11/java-icon${file}.png "$pkgdir/usr/share/icons/hicolor/${file}x${file}/apps/java-${_majorver}openjdk.png"
	done

	mkdir -p "$pkgdir/usr/share/licenses/java-${_majorver}-openjdk"
	mv "$_jdkrelease/legal/"* "$pkgdir/usr/share/licenses/java-${_majorver}-openjdk/"

	mkdir -p "$pkgdir/usr/share/man/"
	mv "$_jdkrelease/man/man1" "$pkgdir/usr/share/man/"
}

jmods() {
	pkgdesc="JMods for OpenJDK ${_majorver}"

	local file dir
	for file in jmods/*.jmod; do

		dir=${file%/*}
		mkdir -p "$subpkgdir/$_java_home/$dir"
		mv "$_jdkrelease/"$file "$subpkgdir/$_java_home/$dir"
	done
}

headless() {
	pkgdesc="OpenJDK ${_majorver} Headless Runtime Environment"
	install="openjdk10-headless.post-install openjdk10-headless.post-upgrade"

	local file dir
	for file in lib/server/* \
				lib/jli/* \
				lib/classlist \
				lib/jexec \
				lib/jrt-fs.jar \
				lib/jvm.cfg \
				lib/*.so \
				lib/modules \
				lib/psfont.properties.ja \
				lib/psfontj2d.properties \
				lib/tzdb.dat \
				bin/java \
				bin/jjs \
				bin/keytool \
				bin/pack200 \
				bin/rmid \
				bin/rmiregistry \
				bin/unpack200; do

		dir=${file%/*}
		mkdir -p "$subpkgdir/$_java_home/$dir"
		mv "$_jdkrelease/"$file "$subpkgdir/$_java_home/$dir"
	done
	mkdir -p "$subpkgdir/etc/java/java-${_majorver}-openjdk"
	mv "$_jdkrelease/conf" "$subpkgdir/etc/java/java-${_majorver}-openjdk/"
	ln -sf /etc/java/java-${_majorver}-openjdk/conf "$subpkgdir/$_java_home/conf"
}

dev() {
	pkgdesc="OpenJDK ${_majorver} development tools"
	depends="$pkgname-headless"

	local file dir
	for file in include/*.h \
				include/linux/*.h \
				lib/ct.sym \
				bin/jaotc \
				bin/jar \
				bin/jarsigner \
				bin/javac \
				bin/javadoc \
				bin/javap \
				bin/jcmd \
				bin/jconsole \
				bin/jdb \
				bin/jdeprscan \
				bin/jdeps \
				bin/jhsdb \
				bin/jimage \
				bin/jinfo \
				bin/jlink \
				bin/jmap \
				bin/jmod \
				bin/jps \
				bin/jrunscript \
				bin/jshell \
				bin/jstack \
				bin/jstat \
				bin/jstatd \
				bin/rmic \
				bin/serialver; do

		dir=${file%/*}
		mkdir -p "$subpkgdir/$_java_home/$dir"
		mv "$_jdkrelease/"$file "$subpkgdir/$_java_home/$dir"
	done
}

examples() {
	pkgdesc="OpenJDK ${_majorver} examples"
	depends="$pkgname-headless"

	mkdir -p "$subpkgdir/$_java_home/"
	mv "$_jdkrelease/demo" "$subpkgdir/$_java_home/"
	mv "$builddir/src/sample" "$subpkgdir/$_java_home/"
}

src() {
	pkgdesc="OpenJDK ${_majorver} Source Bundle"
	depends="$pkgname-headless"

	mkdir -p "$subpkgdir/$_java_home/lib"
	mv "$_jdkrelease/lib/src.zip" "$subpkgdir/$_java_home/lib"
}
sha512sums="7491da11d5e0013db75d33e09be7a91ac0dbcde6282541a39fe471fd5368d49b15403bc7508b330ca60210b3ca02730743ba280657283a231853f6882a3ca74d  jdk-10.0.2+13.tar.bz2
20d2431ab6aee9ca13e6a349e2e147cbc1d83a631e2ff210999234a26516a3c5b84b21dfd2e02f7a4709611f9358661488d54a7ef60e2723940bc32fc9591778  10-portola.patch
b02dff8d549f88317bb4c741a9e269e8d59eef990197d085388fc49c7423a4eb9367dbe1e02bffb10e7862f5980301eb58d4494e177d0e8f60af6b05c7fbbe60  TestCryptoLevel.java
27e91edef89d26c0c5b9a813e2045f8d2b348745a506ae37b34b660fa7093da9a4e0e676ea41dc4a5c901bce02e5304d95e90f68d6c99cbf461b2da40a7a9853  TestECDSA.java"
