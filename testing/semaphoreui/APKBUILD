# Contributor: Guy Godfroy <guy.godfroy@gugod.fr>
# Maintainer: Guy Godfroy <guy.godfroy@gugod.fr>
pkgname=semaphoreui
_pkgname=semaphore
pkgver=2.16.37
pkgrel=1
pkgdesc="Modern UI and powerful API for Ansible, Terraform/OpenTofu/Terragrunt, PowerShell and other DevOps tools"
url="https://semaphoreui.com"
arch="all"
license="MIT"
makedepends="go npm"
install="$pkgname.pre-install"
source="$_pkgname-$pkgver.tar.gz::https://github.com/semaphoreui/semaphore/archive/refs/tags/v$pkgver.tar.gz
	semaphoreui.initd
	semaphoreui.confd
	"
options="net" #go and npm deps
subpackages="$pkgname-openrc $pkgname-doc $pkgname-bash-completion $pkgname-zsh-completion $pkgname-fish-completion"
builddir="$srcdir/$_pkgname-$pkgver"

build() {
	cd web
	npm ci
	export VUE_APP_BUILD_TYPE=prod
	npm run build

	cd ..
	local ldflags="-s -w \
		-X github.com/semaphoreui/semaphore/util.Ver=$pkgver \
		-X github.com/semaphoreui/semaphore/util.Date=$(date -u "+%Y-%m-%dT%H:%M:%SZ" ${SOURCE_DATE_EPOCH:+-d @$SOURCE_DATE_EPOCH})"
	go build -v -o bin/semaphore -tags "netgo" -ldflags "$ldflags" ./cli
	./bin/semaphore completion bash > completion.bash
	./bin/semaphore completion zsh > completion.zsh
	./bin/semaphore completion fish > completion.fish
}

check() {
	go test ./...
}

package() {
	install -m755 -D bin/semaphore \
		"$pkgdir"/usr/bin/semaphore
	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname
	install -m644 -D completion.bash \
		"$pkgdir"/usr/share/bash-completion/completions/semaphore
	install -m644 -D completion.zsh \
		"$pkgdir"/usr/share/zsh/site-functions/_semaphore
	install -m644 -D completion.fish \
		"$pkgdir"/usr/share/fish/vendor_completions.d/semaphore.fish
	install -m644 -D LICENSE \
		"$pkgdir"/usr/share/licenses/$pkgname/LICENSE

}

sha512sums="
b973e41f65c589282ad6d977aeb32f1a118d276a10fb6efb406906dae92a8f93aabdcb6effecc58bfac2721d5a887f0b4a0db48345988fc5621a09d951a04f10  semaphore-2.16.37.tar.gz
18750b04053c01a356e2403b51945ea33163230e634abd5e5233b3b4eb03096beae2585d84873545f2304d0797a8afe08c558f9b939f523595413d7ddbc21c11  semaphoreui.initd
28cba96fe0477bf7bf95a51a47b5b9ed385a1afefcccc90b95fe3a5ad35779d4dd663820a016eef5a2051e779ca71bd428b373bbf49a3a619b3f484a16d716a9  semaphoreui.confd
"
