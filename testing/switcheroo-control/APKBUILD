maintainer="Achill Gilgenast <achill@achill.org>"
pkgname=switcheroo-control
pkgver=3.0
pkgrel=0
pkgdesc="D-Bus service to check the availability of dual-GPU"
url="https://gitlab.freedesktop.org/hadess/switcheroo-control"
arch="all !s390x" # test fail
license="GPL-3.0-or-later"
makedepends="
	eudev-dev
	glib-dev
	gtk-doc
	libdrm-dev
	libgudev-dev
	meson
	"
checkdepends="
	python3
	py3-dbus
	py3-dbusmock
	umockdev-dev
	"
subpackages="
	$pkgname-doc
	$pkgname-systemd
	$pkgname-udev
	"
source="https://gitlab.freedesktop.org/hadess/switcheroo-control/-/archive/$pkgver/switcheroo-control-$pkgver.tar.gz"

build() {
	abuild-meson \
		-Dlibdrm=enabled \
		-Dlibdrm_amdgpu=enabled \
		-Dlibdrm_nouveau=enabled \
		-Ddrm_xe=disabled \
		-Dgtk_doc=true \
		-Dsystemdsystemunitdir=/usr/lib/systemd/system/ \
		-Dtests=$(want_check && echo true || echo false) \
		output .
	meson compile -C output
}

check() {
	meson test --print-errorlogs -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
}

sha512sums="
24bc06d7efcd666f1f75ba605253d8ce3e65bf0d77abdb16f8866e1ceb74b4b34e1d8858009aca2aee8ac66a70388b61cf836524c8abd363fe5ec0f2141966e6  switcheroo-control-3.0.tar.gz
"
