# Contributor: Oleg Titov <oleg.titov@gmail.com>
# Maintainer: Oleg Titov <oleg.titov@gmail.com>
pkgname=ton-node
pkgver=0.0.1
pkgrel=0
pkgdesc="Telegram Open Network (TON) full node and validator"
url="https://test.ton.org/"
arch="x86_64"
license="LGPL-2.0-or-later"
options="!check" # No test suite from upstream
makedepends="cmake gperf libmicrohttpd-dev linux-headers openssl-dev readline-dev zlib-dev"
subpackages="$pkgname-doc $pkgname-dev"
source="$pkgname-$pkgver.tar.xz::https://test.ton.org/ton-blockchain-full.tar.xz
	https://test.ton.org/ton-global.config.json"
builddir="$srcdir/$pkgname"

prepare() {
	# Fixup to make make install work
	touch $builddir/tonlib/TonlibConfig.cmake
}

build() {
	mkdir build
	cd build
	cmake -DMAKE_INSTALL_PREFIX=/usr ..
	make
}

package() {
	cd $builddir/build
	make DESTDIR=$pkgdir install

	mkdir $pkgdir/usr/bin
	rm -rf CMakeFiles
	local i
	for i in $(find . -executable -type f); do
		cp $i $pkgdir/usr/bin
	done
	rm -rf $pkgdir/usb/bin/libtonlibjson.so.0.5

	install -Dm644 $srcdir/ton-global.config.json \
		$pkgdir/etc/ton-global.config.json

	mkdir -p $pkgdir/var/ton-work

	cd $builddir/doc
	install -Dm644 -t $pkgdir/usr/share/doc/$pkgname FullNode-HOWTO
	install -Dm644 -t $pkgdir/usr/share/doc/$pkgname LiteClient-HOWTO
	install -Dm644 -t $pkgdir/usr/share/doc/$pkgname Validator-HOWTO
}
sha512sums="44b964173f4cc974a4fd9140a298c76dac09bee794fbe4ad874f3963e834929b7219387cdcd4dd7f23c5b88a9e3fb9cb0d82572d5e3741b082f83fd81a8080d7  ton-node-0.0.1.tar.xz
22c481c4cac05c7f74bf2092bd437f3807fdada97caae7d751f922f5164d06d7d4d81c32f1a8d73d2728bfb670b44664378a89646dce51ffa434763ab702c8a2  ton-global.config.json"
