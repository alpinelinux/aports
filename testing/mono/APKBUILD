# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer:
pkgname=mono
pkgver=4.8.1.0
pkgrel=0
pkgdesc="Free implementation of the .NET platform including runtime and compiler"
url="http://www.mono-project.com/"
arch="x86_64 x86"
license="GPL"
depends="python2"
depends_dev="zlib-dev libgdiplus-dev"
makedepends="$depends_dev python2 linux-headers paxmark autoconf automake libtool cmake"
install=""
subpackages="$pkgname-dev $pkgname-doc $pkgname-lang"
source="http://download.mono-project.com/sources/mono/mono-${pkgver/_/~}.tar.bz2"

_builddir="$srcdir"/mono-${pkgver%.*}

prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
	# set the minimum arch for x86 to prevent atomic linker errors
	[ "$CARCH" = "x86" ] && export CFLAGS="$CFLAGS -march=i586 -mtune=generic"
	# autogen to fix supplied configure linker issues with make install
	./autogen.sh \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var \
		--disable-boehm \
		--enable-parallel-mark \
		--with-mcs-docs=no \
		--without-sigaltstack \
		|| return 1
	make get-monolite-latest
	# dirty hack to set paxmark on grsec kernels
	make || paxmark -mr mono/mini/mono-sgen && make || return 1
}

package() {
	cd "$_builddir"
	make -j1 DESTDIR="$pkgdir" install || return 1
	# mark all bins
	scanelf --nobanner "$pkgdir"/usr/bin/* | awk '{print $2}' \
		| xargs paxmark -mr
}

md5sums="715e7003221c1965eded65aa11c9a90e  mono-4.8.1.0.tar.bz2"
sha256sums="18cb38a670e51609c36c687ed90ad42cfedabeffd0a2dc5f7f0c46249eb8dbef  mono-4.8.1.0.tar.bz2"
sha512sums="98746f95c9f16eeef5505ca29e69ad84ea97bad7bd268ef13e87aeb1415ed54922a97dd42f6bc3b1af4e1c76ed6355e637645eaece38f5d6ede71cee7f502216  mono-4.8.1.0.tar.bz2"
