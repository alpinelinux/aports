# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Contributor: Dahlia <dahlia.alpine@fastmail.com>
# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
pkgname=barman
pkgver=3.17.0
pkgrel=0
pkgdesc="Backup and recovery manager for PostgreSQL"
url="https://pgbarman.org"
arch="noarch"
license="GPL-3.0-or-later"
depends="
	postgresql-client
	py3-argcomplete
	py3-boto3
	py3-dateutil
	py3-psycopg2
	py3-setuptools
	python3
	rsync
"
makedepends="py3-gpep517 py3-wheel"
subpackages="$pkgname-doc $pkgname-bash-completion $pkgname-pyc"
pkgusers="barman"
pkggroups="barman"
install="$pkgname.pre-install"
checkdepends="py3-pytest-timeout py3-mock py3-pytest-runner py3-pip py3-mock"
source="$pkgname-$pkgver.tar.gz::https://github.com/EnterpriseDB/barman/archive/refs/tags/release/$pkgver.tar.gz"
builddir="$srcdir/$pkgname-release-$pkgver"

build() {
	gpep517 build-wheel \
		--wheel-dir .dist \
		--output-fd 3 3>&1 >&2
}

check() {
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer .dist/*.whl
	.testenv/bin/python3 -m pytest \
		tests/test_backup.py \
		tests/test_cli.py \
		tests/test_encryption.py \
	;
}

package() {
	python3 -m installer -d "$pkgdir" .dist/*.whl

	install -Dm0644 ./scripts/barman.bash_completion \
		"$pkgdir"/usr/share/bash-completion/completions/$pkgname
	install -d -o $pkgusers -g $pkggroups -m 755 "$pkgdir"/var/log/$pkgname

	cd docs
	install -Dm0644 barman.conf -t  "$pkgdir/etc"
}

sha512sums="
cc714bde10cd4eb303ddbb99eb302a3cfaf7b27d303c49f652094da0832b4efd1c50006d76735f2d54895b529afc41925882660d2d3b88f880e417793c58eb99  barman-3.17.0.tar.gz
"
