# Contributor: tcely <rclone+aports@tcely.33mail.com>
# Maintainer: Chloe Kudryavtsev <toast@toastin.space>
pkgname="rclone"
_pkgname="${pkgname}"
pkgver="1.48.0"
pkgrel=0
pkgdesc="Rsync for cloud storage"
url="https://rclone.org/"
arch="all"
license="MIT"
options="net"
depends=""
makedepends="bash git go perl"
install=""
subpackages="$pkgname-doc"

gpg_signature_extensions="."
gpgfingerprints="good:FBF7 37EC E9F8 AB18 604B  D2AC 9393 5E02 FF3B 54FA"
gpgsource="${pkgname}-${pkgver}-sha256sums::https://downloads.rclone.org/v${pkgver}/SHA256SUMS"
source="https://downloads.rclone.org/v${pkgver}/${_pkgname}-v${pkgver}.tar.gz $gpgsource"

builddir="${srcdir}/${_pkgname}-v${pkgver}"

export GOPATH="${srcdir}/go"
export CGO_ENABLED=0

sanitycheck() {
	test -z "$sha512sums" && local source=
	default_sanitycheck
}

build() {
	make rclone
}

check() {
	make quicktest
}

package() {
	make DESTDIR="${pkgdir}" install
	install -Dm644 \
		-t "${pkgdir}/usr/share/man/man1" \
		"${builddir}/${_pkgname}.1"
}

cleanup_srcdir() {
	go clean -modcache
	default_cleanup_srcdir
}

verify() {
	local verified gpgverified

	verified=false
	gpgverified=false
	if is_function gpg_verify && gpg_verify; then
		gpgverified=true
	fi
	local srcfile
	srcfile="$(set -- ${source}; filename_from_uri "${1}")"

	local algo
	for algo in sha512 sha256 sha1 md5; do
		local sums=
		eval sums=\"\$${algo}sums\"
		if $gpgverified; then
			local filename uri
			for uri in ${gpgsource}; do
				filename=
				case "${uri}" in
					*-${algo}sums::*)
						filename="$(filename_from_uri "${uri}")"
						sums="$(cd "${srcdir}" && ${algo}sum "${filename}")"
						local sum sumfilename
						while read -r sum sumfilename; do
							if [ "${srcfile}" = "${sumfilename}" ]; then
								sums="$([ -n "${sums}" ] && printf -- '%s\n' "${sums}";
									printf -- '%s  %s\n' "${sum}" "${srcfile}")"
								break
							fi
							sum="$t"
						done < "${srcdir}/${filename}"
					;;
				esac
			done
		fi
		if [ -z "$sums" ] || [ -z "$source" ]; then
			continue
		fi
		sumcheck "$algo" "$sums" || return 1
		verified=true
		break
	done
	if [ -n "$source" ] && ! $verified; then
		die "Use 'abuild checksum' to generate/update the checksum(s)"
	fi
	return 0
}

sha512sums="d9b8d23192d4cc570b8525e82b33887ffd66fd30a0060b3a65a2dcd2d056fcdd748323cf7537aa80e659c40ce842916665ae23d360d265eda663ba3580fe52a9  rclone-v1.48.0.tar.gz
449e19e890fe667e01a500b22ed278f223d54d2c0e84ad2600b3cc62abb56332e6dc79b988fb81220582dff877382946930a3c8511d531b20f22b519cf89ec20  rclone-1.48.0-sha256sums"

