# Contributor: tcely <rclone+aports@tcely.33mail.com>
# Maintainer: Chloe Kudryavtsev <toast@toastin.space>
pkgname="rclone"
_pkgname="${pkgname}"
pkgver="1.47.0"
pkgrel=0
pkgdesc="Rsync for cloud storage"
url="https://rclone.org/"
arch="all"
license="MIT"
options="net"
depends=""
makedepends="bash git go perl"
install=""
subpackages=""

gpg_signature_extensions="."
gpgfingerprints="good:FBF7 37EC E9F8 AB18 604B  D2AC 9393 5E02 FF3B 54FA"
gpgsource="${pkgname}-${pkgver}-sha256sums::https://downloads.rclone.org/v${pkgver}/SHA256SUMS"
source="https://downloads.rclone.org/v${pkgver}/${_pkgname}-v${pkgver}.tar.gz $gpgsource"

builddir="${srcdir}/${_pkgname}-v${pkgver}"

export GOPATH="${srcdir}/go"
export CGO_ENABLED=0

sanitycheck() {
	test -z "$sha512sums" && local source=
	default_sanitycheck
}

build() {
	make rclone
}

check() {
	make quicktest
}

package() {
	make DESTDIR="${pkgdir}" install
}

cleanup_srcdir() {
	go clean -modcache
	default_cleanup_srcdir
}

verify() {
	local verified gpgverified

	verified=false
	gpgverified=false
	if is_function gpg_verify && gpg_verify; then
		gpgverified=true
	fi
	local srcfile
	srcfile="$(set -- ${source}; filename_from_uri "${1}")"

	local algo
	for algo in sha512 sha256 sha1 md5; do
		local sums=
		eval sums=\"\$${algo}sums\"
		if $gpgverified; then
			local filename uri
			for uri in ${gpgsource}; do
				filename=
				case "${uri}" in
					*-${algo}sums::*)
						filename="$(filename_from_uri "${uri}")"
						sums="$(cd "${srcdir}" && ${algo}sum "${filename}")"
						local sum sumfilename
						while read -r sum sumfilename; do
							if [ "${srcfile}" = "${sumfilename}" ]; then
								sums="$([ -n "${sums}" ] && printf -- '%s\n' "${sums}";
									printf -- '%s  %s\n' "${sum}" "${srcfile}")"
								break
							fi
							sum="$t"
						done < "${srcdir}/${filename}"
					;;
				esac
			done
		fi
		if [ -z "$sums" ] || [ -z "$source" ]; then
			continue
		fi
		sumcheck "$algo" "$sums" || return 1
		verified=true
		break
	done
	if [ -n "$source" ] && ! $verified; then
		die "Use 'abuild checksum' to generate/update the checksum(s)"
	fi
	return 0
}

sha512sums="e235954663e0c6d4d70a071b1f244e2e82490a9ac74141f7301d3a95795b9f97e5f84571da405640302cf1280e2070dfe1b6df0c00abda0122b2c7988998f711  rclone-v1.47.0.tar.gz
840afda7a0823b54db1a49144587efa89d1db71d039554ddb4d1a0f13ccc2d082f04dc2f5c01913071d5ef56bbc57ad441272e4645c076e1aa548dbfe622738b  rclone-1.47.0-sha256sums"

