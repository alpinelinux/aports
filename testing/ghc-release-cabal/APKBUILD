# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=ghc-release-cabal
pkgver=3.17.0.0_pre20251116
_gitrev=2b4cccb4c3a26d3f07c0dec487a2993f233105da
pkgrel=0
_self_hosting=true
_bootstrapcabal=3.16.0.0
pkgdesc="Haskell Cabal package manager built with the ghc-release aport"
url="https://haskell.org/cabal"
arch="aarch64 loongarch64 ppc64le riscv64 x86_64" # ghc-release
license="BSD-3-Clause"
depends="curl"
makedepends_build="ghc-release"
makedepends_host="
	gmp-dev
	libffi-dev
	musl-dev
	zlib-dev
	"
subpackages="$pkgname-doc"
source="https://github.com/haskell/cabal/archive/$_gitrev/cabal-$_gitrev.tar.gz
	https://downloads.haskell.org/cabal/cabal-install-$_bootstrapcabal/cabal-install-$_bootstrapcabal-x86_64-linux-alpine3_20.tar.xz
	cabal.project.freeze
	"
builddir="$srcdir/cabal-$_gitrev"
options="net !check"

provides="$pkgname-bootstrap=$pkgver-r$pkgrel"

_cabal_jobs=${JOBS:-1}
_ghc_jobs=$((_cabal_jobs / 3 + 1))
if $_self_hosting; then
	makedepends_build="$makedepends_build $pkgname-bootstrap"
else
	makedepends_build="$makedepends_build qemu-x86_64"
	if [ "$CBUILD_ARCH" != "x86_64" ]; then
		# avoid cabal child processes that do not run under qemu-user
		_cabal_jobs=1
		_ghc_jobs=${JOBS:-1}
	fi
	export PATH="$tmpdir/bin:$PATH"
fi

# Directory where cabal files are stored.
export CABAL_DIR="${CABAL_DIR:-"$tmpdir/cabal"}"

_maybe_wrap_cabal() {
	$_self_hosting && return 0

	mkdir -p "$tmpdir"/bin
	cat > "$tmpdir"/bin/cabal <<-EOF
		#!/bin/sh
		exec qemu-x86_64 "$srcdir/cabal" "\$@"
	EOF
	chmod +x "$tmpdir"/bin/cabal
}

cabal_update() {
	local repo="hackage.haskell.org"

	[ -d "$builddir" ] || abuild unpack
	_maybe_wrap_cabal

	# Default config uses HTTP, change it to HTTPS.
	[ -f "$CABAL_DIR"/config ] || {
		cabal user-config init
		cabal user-config update -a \
			"repository $repo {url: https://$repo/}"
	}

	cd "$startdir"
	msg "Freezing $pkgname dependencies"

	# Resolve deps and generate fresh cabal.project.freeze with version constraints.
	(
		cd "$builddir" || {
			error 'Is $builddir set correctly?'
			return 1
		}
		cabal v2-update
		cabal v2-freeze --shadow-installed-packages

		mv -v cabal.project.freeze "$startdir"/
	)

	if ! abuild checksum; then
		die "Failed to update checksum, run 'abuild checksum' manually"
	fi
}

prepare() {
	default_prepare
	_maybe_wrap_cabal

	ln -svf "$srcdir"/cabal.project.freeze "$builddir"/
}

build() {
	cabal v2-update
	cabal v2-build cabal-install:exes \
		--jobs=$_cabal_jobs \
		--prefix=/usr \
		--docdir=/usr/share/doc/$pkgname \
		--sysconfdir=/etc \
		--ghc-options="-j$_ghc_jobs -H64m -fignore-asserts"
}

package() {
	install -Dvm644 LICENSE -t "$pkgdir"/usr/share/licenses/$pkgname/

	cd dist-newstyle/build/*-linux/ghc-*/cabal-install-${pkgver%%_*}/x/cabal/build/cabal
	install -Dvm755 cabal -t "$pkgdir"/usr/bin/

	mkdir -p "$pkgdir"/usr/share/man/man1
	./cabal man --raw > "$pkgdir"/usr/share/man/man1/cabal.1
}

sha512sums="
6bfb1c8995cd600e16523ac7c6696790327e75a03f626cb29a0d295c8a272e87845aa35ed98d73a533741c19afdd983d67fc99650812eb5170b0849f2f5436c9  cabal-2b4cccb4c3a26d3f07c0dec487a2993f233105da.tar.gz
f568fafae325962c83cb8b8e23d04f26dd1e9ca6352d652b301c7877dcfd729642354fedb8c42cb594f485bb5fa11c88817fc6ed4db62dfe6a0ccd9224f69438  cabal-install-3.16.0.0-x86_64-linux-alpine3_20.tar.xz
c2963b936f48cd13e7501265728fedeea7b351383612b3962469e8f8d0c9eb156a485c58e8126fb67ea4adb0cabd578a7077bdd1e456070f05ceb6736902f0a3  cabal.project.freeze
"
