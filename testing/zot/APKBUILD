maintainer="Hoang Nguyen <folliekazetani@protonmail.com>"
pkgname=zot
pkgver=2.1.14
_zui_commit=4d28d8813d5c9dc082480cba8ca04de2c5644df7
pkgrel=0
pkgdesc="Vendor-neutral OCI-native container image registry"
url="https://zotregistry.dev/"
# 32bit: tests fail to build && https://github.com/distribution/distribution/pull/4642
arch="all !x86 !armhf !armv7"
license="Apache-2.0"
makedepends="go linux-headers npm nodejs rollup"
checkdepends="openssl"
subpackages="
	$pkgname-doc
	$pkgname-openrc
	$pkgname-cli:_cli
	$pkgname-exporter:_exporter
	$pkgname-cli-bash-completion:_bashcomp:noarch
	$pkgname-cli-fish-completion:_fishcomp:noarch
	$pkgname-cli-zsh-completion:_zshcomp:noarch
	"
install="$pkgname.pre-install"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/project-zot/zot/archive/refs/tags/v$pkgver.tar.gz
	zui-$_zui_commit.tar.gz::https://github.com/project-zot/zui/archive/$_zui_commit.tar.gz
	zot.initd
	zot.confd
	"
options="net" # download Go modules

# The project uses encoding/json/v2
# XXX: remove when the package comes out of experimental status
export GOEXPERIMENT=jsonv2

prepare() {
	default_prepare

	cd "$srcdir"/zui-$_zui_commit
	npm install --no-progress
	rm -r node_modules/rollup
	ln -s /usr/share/node_modules/rollup node_modules/rollup
}

build() {
	cd "$srcdir"/zui-$_zui_commit
	npm run build
	cp -r build "$builddir"/pkg/extensions/

	cd "$builddir"
	local _extensions="sync,search,scrub,metrics,lint,ui,mgmt,profile,userprefs,imagetrust,events"
	local _goldflags="
	-X zotregistry.dev/zot/pkg/api/config.ReleaseTag=v$pkgver
	-X zotregistry.dev/zot/pkg/api/config.Commit=AlpineLinux
	-X zotregistry.dev/zot/pkg/api/config.BinaryType=${_extensions//,/-}
	-X zotregistry.dev/zot/pkg/api/config.GoVersion=$(go env GOVERSION)
	"

	for binary in zot zb zli; do
		go build -v \
			-ldflags "$_goldflags" \
			-tags "$_extensions" \
			./cmd/$binary
	done
	go build -v ./cmd/zxp

	# Only generate shell completions for the CLI client
	for shell in bash fish zsh; do
		./zli completion $shell > zli.$shell
	done
}

check() {
	# A small part of 'make test/data'
	mkdir -p test/data/noidentity
	cd test/data
	sh ../scripts/gen_certs.sh
	cd noidentity
	sh ../../scripts/gen_nameless_certs.sh

	# Skip tests requiring static container image tarballs (pulled via skopeo) in $builddir/test/data/
	# Skip TestHTPasswdWatcherOriginal failing for riscv64
	# Skip TestInjectUploadImageWithBasicAuth which passes CI but fails on aarch64 builder
	# despite increasing ulimit: failed to create htpasswd watcher, error: too many files
	cd "$builddir"
	go test \
		-skip 'TestGarbageCollectForImageStore|TestImageBuilder|TestPredefinedImages|TestInjectUploadImageWithBasicAuth|TestHTPasswdWatcherOriginal' \
		./...
}

package() {
	install -Dm755 zot -t "$pkgdir"/usr/bin/

	install -Dm644 examples/config-*.json -t "$pkgdir"/usr/share/doc/zot/examples/

	install -Dm755 "$srcdir"/zot.initd "$pkgdir"/etc/init.d/zot
	install -Dm644 "$srcdir"/zot.confd "$pkgdir"/etc/conf.d/zot
}

_cli() {
	pkgdesc="$pkgdesc - CLI tools"
	install -Dm755 "$builddir"/zli "$builddir"/zb -t "$subpkgdir"/usr/bin/
}

_exporter() {
	pkgdesc="$pkgdesc - metrics exporter"
	install -Dm755 "$builddir"/zxp -t "$subpkgdir"/usr/bin/
}

_bashcomp() {
	pkgdesc="Bash completions for $pkgname-cli"
	install_if="bash-completion $pkgname-cli=$pkgver-r$pkgrel"
	install -Dm644 "$builddir"/zli.bash \
		"$subpkgdir"/usr/share/bash-completion/completions/zli
}

_fishcomp() {
	pkgdesc="Fish completions for $pkgname-cli"
	install_if="fish $pkgname-cli=$pkgver-r$pkgrel"
	install -Dm644 "$builddir"/zli.fish \
		"$subpkgdir"/usr/share/fish/vendor_completions.d/zli.fish
}

_zshcomp() {
	pkgdesc="Zsh completions for $pkgname-cli"
	install_if="zsh $pkgname-cli=$pkgver-r$pkgrel"
	install -Dm644 "$builddir"/zli.zsh \
		"$subpkgdir"/usr/share/zsh/site-functions/_zli
}

sha512sums="
ef7d0a112243e555c0f8186506bc9235a7ec865d784c461666bcec4b74de287ef9f3715519a65c11145244ac8c5b783cf91806527287b0a7afbab4fc956393bf  zot-2.1.14.tar.gz
cf885bbcb925ac8b86363e9e7795d63e03f15665a03a9971b9e218dab0c4bc995c4d7d037f236df538dbf1b1dd334e6d5286c0c3da20f87f7856043a84dd1db2  zui-4d28d8813d5c9dc082480cba8ca04de2c5644df7.tar.gz
86dfa273e97110b703fbc368757520ef6169dead185ff54b5b8ba45e764949bc3a21a51d53a1605d7163faef8c83c066e688577f5315b8c0afb09f69a2bbe3bb  zot.initd
b128ecaf3e35cfdab8069da9a8267a9faed50b892ae07b6a4a22a4108236d6cdbc10cc4cf0105c728e9e6da6ac773f56d1dd84de1ba4463110058b6c2f190b30  zot.confd
"
