# Contributor: Aaron Hurt <ahurt@ena.com>
# Maintainer: Aaron Hurt <ahurt@ena.com>
pkgname=gearmand
pkgver="1.1.12"
pkgrel=2
pkgdesc="Gearman job server and client"
url="http://gearman.org"
arch="all"
license="BSD"
makedepends="boost-dev gperf libevent-dev util-linux-dev
	hiredis-dev openssl-dev sqlite-dev libmemcached-dev"
install="$pkgname.pre-install $pkgname.post-deinstall"
subpackages="$pkgname-doc gearman-libs:gearman_libs gearman-dev:gearman_dev"
source="https://launchpad.net/${pkgname}/1.2/${pkgver}/+download/${pkgname}-${pkgver}.tar.gz
	libtest-cmdline.cc.patch
	libhashkit-common.h.patch
	$pkgname.initd
	$pkgname.confd"

builddir="$srcdir/$pkgname-$pkgver"
build() {
	cd "$builddir"
	## configure with only the most commonly used persistence backends
	## we are explicitly disabling tokyo cabinet and pgsql to reduce
	## dependencies and overall package size
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--with-mysql=no \
		--with-postgresql=no \
		--disable-libpq \
		--disable-libtokyocabinet \
		--disable-libdrizzle \
		--enable-ssl \
		--enable-hiredis \
		--enable-jobserver=no \
		|| return 1
	make || return 1
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir" install || return 1
	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname || return 1
	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname || return 1
}

gearman_libs() {
	pkgdesc="gearman C client library"

	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libgearman.so* "$subpkgdir"/usr/lib/
}

gearman_dev() {
	default_dev
	pkgdesc="libgearman development files"
}

md5sums="99dd0be85b181eccf7fb1ca3c2a28a9f  gearmand-1.1.12.tar.gz
3973b88414bdfc06ec5883bab9f837c3  libtest-cmdline.cc.patch
b0f59776f3d6c18bc7591472a1987b86  libhashkit-common.h.patch
ec4c6478e3f0318b9e1bf770a51b0065  gearmand.initd
9f79358567f822307f022001372a075c  gearmand.confd"
sha256sums="973d7a3523141a84c7b757c6f243febbc89a3631e919b532c056c814d8738acb  gearmand-1.1.12.tar.gz
9e640a145b445d765065e662d5301450a42c321913b3a44a26ecd148e0106350  libtest-cmdline.cc.patch
85cbf923754dd2f95f7e9af5d70d07a13e0a092b9e3a4bafecfd790de362f83f  libhashkit-common.h.patch
6bd924c6136ffeff016b355559ade1763a36e9166426ed83b11703ad406ee061  gearmand.initd
dc84fd32db3310a1d8b9250e9d5a64cf13bbc67c29e8e1f30ed202b5109a629e  gearmand.confd"
sha512sums="51d1596761c3f3ff3213edb64054fd9942b109383a51e998ff096ea972966dad1780a11814a3d37d4e8396365f402e3e3c9f759502dc3b6da25ea41936204e28  gearmand-1.1.12.tar.gz
2e333ca902b3cedb7057cda5ab75fd40c3b86a6e3eb3249c0f860388db9ccc7f603d71c047e6c3d7b7750b00e71f25c5a7434751af577443fa393a5396aedcfb  libtest-cmdline.cc.patch
d962c1724aaea22f457b9a33b017cbcf69b49c6d90c6a0a1b41d9e5be996efafb530dec0cd0f2516998e3cdc5015270a4b3a60fbee4b7a2c5b8d7195ad3b0f6a  libhashkit-common.h.patch
4cedb9000f70fbb6caf45f21e891d841e0823f068cc805ad8d8d93ec648e8f46e15d0e05bbeb7e1f7f5ea64a58661eecca9b5a982c456b8fea034d3f985f5120  gearmand.initd
384b1765defe597ca9cc96593662eab1baf6a677d5c9ac9c02bfe7d4b3c19170893d3094ec7a11e8240a27a72e33f40c15fb23f71a1205ea239caee8953b77f4  gearmand.confd"
