# Contributor: Aaron Hurt <ahurt@ena.com>
# Maintainer: Aaron Hurt <ahurt@ena.com>
pkgname=gearmand
pkgver="1.1.12"
pkgrel=2
pkgdesc="Gearman job server and client"
url="http://gearman.org"
arch="all"
license="BSD"
depends="libgearman"
depends_dev="boost-dev gperf libevent-dev util-linux-dev mariadb-dev
	hiredis-dev openssl-dev sqlite-dev libmemcached-dev"
makedepends="$depends_dev"
install="$pkgname.pre-install $pkgname.post-deinstall"
subpackages="$pkgname-doc libgearman libgearman-dev"
source="https://launchpad.net/${pkgname}/1.2/${pkgver}/+download/${pkgname}-${pkgver}.tar.gz
	libtest-cmdline.cc.patch
	$pkgname.initd
	$pkgname.confd"

_builddir="$srcdir/$pkgname-$pkgver"
prepare() {
	local i
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
}

build() {
	cd "$_builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--disable-libpq \
		--disable-libtokyocabinet \
		--disable-libdrizzle \
		--enable-ssl \
		--enable-hiredis \
		--enable-jobserver=no \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1

	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname || return 1
	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname || return 1
}

libgearman() {
	pkgdesc="gearman C client library"

	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libgearman.so* "$subpkgdir"/usr/lib/
}

dev() {
	default_dev
	depends="libgearman"
	pkgdesc="libgearman development files"
}

md5sums="99dd0be85b181eccf7fb1ca3c2a28a9f  gearmand-1.1.12.tar.gz
3973b88414bdfc06ec5883bab9f837c3  libtest-cmdline.cc.patch
b12060f98a25bfcb43b31eca7498d2b0  gearmand.initd
9f79358567f822307f022001372a075c  gearmand.confd"
sha256sums="973d7a3523141a84c7b757c6f243febbc89a3631e919b532c056c814d8738acb  gearmand-1.1.12.tar.gz
9e640a145b445d765065e662d5301450a42c321913b3a44a26ecd148e0106350  libtest-cmdline.cc.patch
24e06809832cad4785a7aacee3c232c7f77e6b178e5d3863219a7f54fcec1f0c  gearmand.initd
dc84fd32db3310a1d8b9250e9d5a64cf13bbc67c29e8e1f30ed202b5109a629e  gearmand.confd"
sha512sums="51d1596761c3f3ff3213edb64054fd9942b109383a51e998ff096ea972966dad1780a11814a3d37d4e8396365f402e3e3c9f759502dc3b6da25ea41936204e28  gearmand-1.1.12.tar.gz
2e333ca902b3cedb7057cda5ab75fd40c3b86a6e3eb3249c0f860388db9ccc7f603d71c047e6c3d7b7750b00e71f25c5a7434751af577443fa393a5396aedcfb  libtest-cmdline.cc.patch
7ac61fb4ffab2dbc20ccbbd9af9f1ff808f05623923b96368e1a84bcb32de258e3dcd800d4ef4e0e55029c0c9cc38c6857cbe999e7bda351d672622b5efb5071  gearmand.initd
384b1765defe597ca9cc96593662eab1baf6a677d5c9ac9c02bfe7d4b3c19170893d3094ec7a11e8240a27a72e33f40c15fb23f71a1205ea239caee8953b77f4  gearmand.confd"
