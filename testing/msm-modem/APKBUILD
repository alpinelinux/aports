maintainer="Achill Gilgenast <achill@achill.org>"
pkgname=msm-modem
pkgver=13
pkgrel=0
pkgdesc="Common support for Qualcomm MSM modems"
url="https://gitlab.postmarketos.org/postmarketOS/msm-modem#"
arch="noarch"
license="GPL-3.0-or-later"
depends="$pkgname-uim-selection"
makedepends="meson"
subpackages="
	$pkgname-downstream::all
	$pkgname-downstream-openrc:downstream_openrc
	$pkgname-downstream-udev:downstream_udev
	$pkgname-uim-selection:uim_selection
	$pkgname-uim-selection-openrc:uim_selection_openrc
	$pkgname-uim-selection-systemd:uim_selection_systemd
	$pkgname-wwan-port:wwan_port
	$pkgname-wwan-port-openrc:wwan_port_openrc
	$pkgname-wwan-port-systemd:wwan_port_systemd
"
source="https://gitlab.postmarketos.org/postmarketOS/msm-modem/-/archive/$pkgver/msm-modem-$pkgver.tar.gz"

build() {
	abuild-meson \
		-Ddownstream=true \
		-Dwwan-port=true \
		output .
	meson compile -C output
}

check() {
	meson test --print-errorlogs -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
}

downstream() {
	pkgdesc="$pkgdesc (downstream)"
	depends="libqipcrtr4msmipc libsmdpkt_wrapper"

	amove usr/libexec/keepfileopen
}

downstream_openrc() {
	pkgdesc="$pkgdesc (downstream, OpenRC init scripts)"
	install_if="openrc ${subpkgname%-openrc}=$pkgver-r$pkgrel"
	depends=

	amove etc/init.d/msm-modem-downstream
}

downstream_udev() {
	pkgdesc="$pkgdesc (downstream, udev rules)"
	install_if="udev ${subpkgname%-udev}=$pkgver-r$pkgrel"
	depends=

	amove usr/lib/udev/rules.d/55-msm-modem-downstream.rules
}

uim_selection() {
	pkgdesc="$pkgdesc (UIM selection)"
	depends="rmtfs libqmi qmi-utils"

	amove usr/libexec/msm-modem-uim-selection
}

uim_selection_openrc() {
	pkgdesc="$pkgdesc (UIM selection, OpenRC init scripts)"
	install_if="openrc ${subpkgname%-openrc}=$pkgver-r$pkgrel"
	depends=

	amove etc/conf.d/msm-modem-uim-selection
	amove etc/init.d/msm-modem-uim-selection
}

uim_selection_systemd() {
	pkgdesc="$pkgdesc (UIM selection, systemd files)"
	install_if="systemd ${subpkgname%-systemd}=$pkgver-r$pkgrel"
	depends=

	amove usr/lib/systemd/system/msm-modem-uim-selection.service
	amove usr/lib/systemd/system/rmtfs.service.d/msm-modem-uim-selection.override.conf
}

wwan_port() {
	pkgdesc="$pkgdesc (Open WWAN port)"
	depends="rmtfs"

	amove usr/libexec/msm-modem-wwan-port
}

wwan_port_openrc() {
	pkgdesc="$pkgdesc (Open WWAN port, OpenRC init scripts)"
	install_if="openrc ${subpkgname%-openrc}=$pkgver-r$pkgrel"
	depends=

	amove etc/init.d/msm-modem-wwan-port
}

wwan_port_systemd() {
	pkgdesc="$pkgdesc (Open WWAN port, systemd files)"
	install_if="systemd ${subpkgname%-systemd}=$pkgver-r$pkgrel"
	depends=

	amove usr/lib/systemd/system/msm-modem-wwan-port.service
}

sha512sums="
f293d63f3e770618d6c5218b41e2c97d6446cdb745e0b531c816a0d1513486ac29106bbad8d027e5949bb9d4e1b4b27d14572b48c23967e2a0f0bcb24244e0bc  msm-modem-13.tar.gz
"
