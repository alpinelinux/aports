# Contributor: Leonardo Arena <rnalrd@alpinelinux.org>
# Contributor: Francesco Colista <fcolista@alpinelinux.org>
# Contributor: Stefan Wagner <stw@bit-strickerei.de>
# Maintainer: John Regan <john@jrjrtech.com>
pkgname=ejabberd
pkgver=18.03
pkgrel=0
pkgdesc="An erlang jabber server"
url="https://www.ejabberd.im/"
arch="all"
license="GPL-2.0-or-later"
_lager=3.4.2
_p1_utils=1.0.11
_cache_tab=1.0.13
_fast_tls=1.0.21
_stringprep=1.0.11
_fast_xml=1.1.29
_xmpp=1.1.20
_fast_yaml=1.0.13
_jiffy=0.14.8
_p1_oauth2=0.6.2
_jose=1.8.4
_eimp=1.0.3
_ezlib=1.0.4
_iconv=1.0.7
_goldrush=0.1.9
_base64url=1.0
_erl_deps="erlang-asn1 erlang-crypto erlang-eldap erlang-inets erlang-mnesia
	erlang-public-key erlang-sasl erlang-ssl erlang-syntax-tools erlang-os-mon
	"
_erl_make_deps="erlang-eunit erlang-parsetools"
depends="erlang util-linux yaml $_erl_deps"
depends_dev="erlang-dev expat-dev openssl-dev zlib-dev heimdal-dev yaml-dev git"
makedepends="$depends_dev $_erl_deps $_erl_make_deps automake autoconf gd-dev
	libjpeg-turbo-dev libpng-dev libwebp-dev"
pkgusers="ejabberd"
pkggroups="ejabberd"
install="$pkgname.pre-install"
subpackages="$pkgname-dev $pkgname-doc $pkgname-openrc"
source="$pkgname-$pkgver.tar.gz::https://github.com/processone/$pkgname/archive/$pkgver.tar.gz
	lager-$_lager.tar.gz::https://github.com/erlang-lager/lager/archive/$_lager.tar.gz
	p1_utils-$_p1_utils.tar.gz::https://github.com/processone/p1_utils/archive/$_p1_utils.tar.gz
	cache_tab-$_cache_tab.tar.gz::https://github.com/processone/cache_tab/archive/$_cache_tab.tar.gz
	fast_tls-$_fast_tls.tar.gz::https://github.com/processone/fast_tls/archive/$_fast_tls.tar.gz
	stringprep-$_stringprep.tar.gz::https://github.com/processone/stringprep/archive/$_stringprep.tar.gz
	fast_xml-$_fast_xml.tar.gz::https://github.com/processone/fast_xml/archive/$_fast_xml.tar.gz
	xmpp-$_xmpp.tar.gz::https://github.com/processone/xmpp/archive/$_xmpp.tar.gz
	fast_yaml-$_fast_yaml.tar.gz::https://github.com/processone/fast_yaml/archive/$_fast_yaml.tar.gz
	jiffy-$_jiffy.tar.gz::https://github.com/davisp/jiffy/archive/$_jiffy.tar.gz
	p1_oauth2-$_p1_oauth2.tar.gz::https://github.com/processone/p1_oauth2/archive/$_p1_oauth2.tar.gz
	erlang-jose-$_jose.tar.gz::https://github.com/potatosalad/erlang-jose/archive/$_jose.tar.gz
	eimp-$_eimp.tar.gz::https://github.com/processone/eimp/archive/$_eimp.tar.gz
	ezlib-$_ezlib.tar.gz::https://github.com/processone/ezlib/archive/$_ezlib.tar.gz
	iconv-$_iconv.tar.gz::https://github.com/processone/iconv/archive/$_iconv.tar.gz
	goldrush-$_goldrush.tar.gz::https://github.com/DeadZen/goldrush/archive/$_goldrush.tar.gz
	base64url-$_base64url.tar.gz::https://github.com/dvv/base64url/archive/v$_base64url.tar.gz
	ejabberd.initd
	ejabberd.logrotate
	ejabberd.confd
	"

builddir="$srcdir"/$pkgname-$pkgver

prepare() {
	cd "$builddir"
	mkdir deps
	mv "$srcdir"/lager-$_lager "$builddir"/deps/lager
	mv "$srcdir"/p1_utils-$_p1_utils "$builddir"/deps/p1_utils
	mv "$srcdir"/cache_tab-$_cache_tab "$builddir"/deps/cache_tab
	mv "$srcdir"/fast_tls-$_fast_tls "$builddir"/deps/fast_tls
	mv "$srcdir"/stringprep-$_stringprep "$builddir"/deps/stringprep
	mv "$srcdir"/fast_xml-$_fast_xml "$builddir"/deps/fast_xml
	mv "$srcdir"/xmpp-$_xmpp "$builddir"/deps/xmpp
	mv "$srcdir"/fast_yaml-$_fast_yaml "$builddir"/deps/fast_yaml
	mv "$srcdir"/jiffy-$_jiffy "$builddir"/deps/jiffy
	mv "$srcdir"/p1_oauth2-$_p1_oauth2 "$builddir"/deps/p1_oauth2
	mv "$srcdir"/erlang-jose-$_jose "$builddir"/deps/jose
	mv "$srcdir"/eimp-$_eimp "$builddir"/deps/eimp
	mv "$srcdir"/ezlib-$_ezlib "$builddir"/deps/ezlib
	mv "$srcdir"/iconv-$_iconv "$builddir"/deps/iconv
	mv "$srcdir"/goldrush-$_goldrush "$builddir"/deps/goldrush
	mv "$srcdir"/base64url-$_base64url "$builddir"/deps/base64url
	default_prepare
}

build() {
	cd "$builddir"
	./autogen.sh
	./configure --prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info
	make
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir" install || return 1

	install -d ${pkgdir}/var/spool/$pkgname
	install -d ${pkgdir}/var/lib/$pkgname
	install -D -m0644 "$srcdir"/$pkgname.logrotate \
		${pkgdir}/etc/logrotate.d/$pkgname
	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
	chown -R ejabberd.ejabberd "$pkgdir"/var/log/ejabberd
	chown -R ejabberd.ejabberd "$pkgdir"/var/spool/ejabberd
	chown -R ejabberd.ejabberd "$pkgdir"/var/lib/ejabberd
	chgrp ejabberd "$pkgdir"/etc/ejabberd/ejabberd.yml \
		"$pkgdir"/etc/ejabberd/ejabberdctl.cfg "$pkgdir"/etc/ejabberd
}

sha512sums="47e61239d3ee6f04c381c2000ff4dca52fb728488f8c060eeb5a0253de3d42fe6c9ab730cca63aab6a02d32dfe2bdec2e202272fd1e8e386eb334c1e82ccb9ff  ejabberd-18.03.tar.gz
306b22860ac61f88cc71e7d63a725628a3dad2bd4b6bfc93a02411a5b833e900e81530d8c7d065677b8aa1a917ba773182300fc49957ed9199213c280f8f868d  lager-3.4.2.tar.gz
a61ffa68c6ded3f3ff2c1c580553d853016935d937e4c30f2523cc99dd8bc814e0d9afa86d20c3a70c03a81c2bf10f3834464be589f1f5c3638a353b80a8a872  p1_utils-1.0.11.tar.gz
16526d8332a4f7df9e231001f4c93cf55e791a6f4a0ec6dfac7ca828f384c1289c7699cb7db30b296d6640f3b0264e2ae144d6c194e2c271cb58ef9cd5288b2c  cache_tab-1.0.13.tar.gz
aea0cd9af3ecce710383242c18b239131f732e211230ad19462c3b305318d7a4559e4df4e201fba012c9c1a6a7de1a6463f917a7b3917ac9e4d606b32564b93a  fast_tls-1.0.21.tar.gz
1b7c9ce7454c9f3ace7c36b353f1f002cd54c6ccb09b2c1041a3c0f66199b1c56997b5bd3ac861d4c5a75f19280231b455e020f6f42b8526eaae01c133b7f787  stringprep-1.0.11.tar.gz
1b4cf746f72eaec78fd47905798b0e4e9431c8cf8d742dce509051b0ec9d3c5c5d82b14eae1d0783a1f6645cec2972675b7bbbd025fc253c5ff0819ceba76573  fast_xml-1.1.29.tar.gz
ab414d42069a993824d79cd5ddbf984a348b613e03d67ab5f647b80ba1ca69ffbc11de1fdfea940bdb94499fa43017dd304e0a7fad3b3858474ce056f26e923b  xmpp-1.1.20.tar.gz
2515df24361a43995adbc647c3fc102d28335f3e02db899d2201f871be333e45b01a10bd8252bdc96ffda24b8c053221331a543080c27dfda98256469673ae0c  fast_yaml-1.0.13.tar.gz
c91f39ba877daf845ac80d611fee88310e1e3368c36da722c22af841285dcc0b7fd7712b0107dcb1a60155ac58dd7cc0faa4e4295e4aa9c33d79292c5b2cf045  jiffy-0.14.8.tar.gz
09e7c2bcc2038e315a94f1087cab2b7a42a0d0545df95ef0f3c1cd9f9bb717039fa84c05d59f04ea6110495da4a68c88ed052e9a721dfaa4b2dd2e114c905941  p1_oauth2-0.6.2.tar.gz
47171b4e5f6b61735a15365b4130c110c14de1f4b157cdbf97b448550d48de4ab27a30537e9d9f613d87862d592b3bd95638daacee60f3f5b9877d80a3de773b  erlang-jose-1.8.4.tar.gz
bfaaa90a68c725c74b577fdb0b5ea42999a2192a758b19d22c15b78cc05e69f81dd92e32a9ba2ec2aa3dbf948704f927bea5c9cfd3ef9a53e92e3747f383fe8b  eimp-1.0.3.tar.gz
16495a6756cd60ad921695d87136e399446850ce1160d92b825673fa1e0e7d3cd4a6b49f274debbfe7dfe4285370362ece64db8843afd564ffaffe9eeba0dc7a  ezlib-1.0.4.tar.gz
681f5ebb7d3ee033633a8429530847fe1108b3f21406eb3952b0e8e62f62986f984096151d58b10a24e18c59951ba0021382e1530dcfd3cce1ef30d58a57e8f4  iconv-1.0.7.tar.gz
3e1efcfd1ed26641dc054f4f0b4b6a8c40959c8462f6fac9d1bde4818d46700d64bf727c39e27e3428a5717d2ef917b9e35b5982e32546482451a403f0b206d3  goldrush-0.1.9.tar.gz
f9f5062d8a45c5d0fbfb7179359137e88a1af10e29c1329506446d2142331176f6be2aa30387e4c98855440c1da943ea16a655ed2ad5168d4f5f8a2cd1c47c5f  base64url-1.0.tar.gz
c76e5bc55dbd43568777ddbea756f58feb9419b0cc1c68b560e6ed4c0397c1dd61e42b2e7ac143188308683e6ee0ce44a8540da26c0e897012285b6587c7a566  ejabberd.initd
47fd2cfd9177c4e978a9799a153ba74392a9891822221af8194686a40f6bf01f38644833e1e1f5416c6357e0bfb7ca3dae96f55a4fcd7cd629ec798d85a72807  ejabberd.logrotate
96a571c0ab2be366e931bda423a61ef920cbaba2107e61ddbc501472ce3efe2804418cc6579c99310b902a9a99aaecb9284cf2420c071dbca2f670efb4034135  ejabberd.confd"
