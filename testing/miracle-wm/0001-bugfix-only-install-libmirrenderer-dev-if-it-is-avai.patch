From f77061147d19c39034c0fd83fd4cf50858f9babb Mon Sep 17 00:00:00 2001
From: Matthew Kosarek <matthew@matthewkosarek.xyz>
Date: Tue, 9 Dec 2025 10:41:43 -0500
Subject: [PATCH 1/2] bugfix: only install libmirrenderer-dev if it is
 available (#734)

(cherry picked from commit aaae6e64261d8a00c2a1df47e2eab99400382d69)
---
 .github/workflows/build-ubuntu.yml | 4 +++-
 CMakeLists.txt                     | 2 +-
 snap/snapcraft.yaml                | 6 +++++-
 3 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/.github/workflows/build-ubuntu.yml b/.github/workflows/build-ubuntu.yml
index dee9611..99cbbaf 100644
--- a/.github/workflows/build-ubuntu.yml
+++ b/.github/workflows/build-ubuntu.yml
@@ -40,8 +40,10 @@ jobs:
         sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100 --slave /usr/bin/g++ g++ /usr/bin/g++-13
         sudo apt install libmiral-dev libmircommon-internal-dev libmircommon-dev libmirserver-internal-dev \
           libgtest-dev libyaml-cpp-dev libglib2.0-dev libevdev-dev nlohmann-json3-dev libnotify-dev pcre2-utils \
-          libmiroil-dev libmirrenderer-dev libgles2-mesa-dev libmirwayland-dev libjson-c-dev libgtest-dev libgmock-dev \
+          libmiroil-dev libmirplatform-dev libgles2-mesa-dev libmirwayland-dev libjson-c-dev libgtest-dev libgmock-dev \
           mirtest-dev mirtest-internal-dev mir-wlcs-integration libxkbcommon-dev libboost-filesystem-dev libboost-system-dev
+
+        sudo apt install -y libmirrenderer-dev || true
           
         sudo apt install mir-platform-graphics-virtual xwayland \
           mir-platform-graphics-gbm-kms mir-platform-rendering-egl-generic gedit gnome-chess
diff --git a/CMakeLists.txt b/CMakeLists.txt
index ef0891a..a4975f6 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -82,7 +82,7 @@ find_package(PkgConfig)
 
 set(MIR_MINIMUM_VERSION 2.18)
 pkg_check_modules(MIRAL REQUIRED miral>=5.1)
-pkg_check_modules(MIRRENDERER REQUIRED mirrenderer>=${MIR_MINIMUM_VERSION})
+pkg_check_modules(MIRRENDERER mirrenderer>=${MIR_MINIMUM_VERSION})
 pkg_check_modules(MIRPLATFORM REQUIRED mirplatform>=${MIR_MINIMUM_VERSION})
 pkg_check_modules(MIRCOMMON REQUIRED mircommon>=${MIR_MINIMUM_VERSION})
 pkg_check_modules(MIRCOMMON_INTERNAL REQUIRED mircommon-internal>=${MIR_MINIMUM_VERSION})
diff --git a/snap/snapcraft.yaml b/snap/snapcraft.yaml
index 6aef60d..28177a4 100644
--- a/snap/snapcraft.yaml
+++ b/snap/snapcraft.yaml
@@ -58,6 +58,10 @@ parts:
       - -DCMAKE_BUILD_TYPE=Release
       - -DCMAKE_INSTALL_PREFIX=/usr
     source: .
+    override-build: |
+      apt-get install -y libmirrenderer-dev || true
+      apt-get install -y mir-renderer-gl-dev || true
+      snapcraftctl build
     build-packages:
       - pkg-config
       - libmiral-dev
@@ -66,6 +70,7 @@ parts:
       - libmirserver-internal-dev
       - mirtest-dev
       - mirtest-internal-dev
+      - libmirplatform-dev
       - libfreetype6-dev
       - libwayland-dev
       - libxkbcommon-dev
@@ -81,7 +86,6 @@ parts:
       - libevdev2
       - nlohmann-json3-dev
       - libgles2-mesa-dev
-      - libmirrenderer-dev
       - libmirwayland-dev
       - libjson-c-dev
       - libgtest-dev
-- 
2.52.0

