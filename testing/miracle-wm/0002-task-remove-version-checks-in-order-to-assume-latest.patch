From 5b161cfad702f83f45ba2b5126590c049d54a8c5 Mon Sep 17 00:00:00 2001
From: Matthew Kosarek <matthew@matthewkosarek.xyz>
Date: Tue, 25 Nov 2025 09:05:22 -0500
Subject: [PATCH 2/2] task: remove version checks in order to assume latest
 (#720)

(cherry picked from commit 3f3389bf49ad780d258d34109f87e73ef7c02344)
---
 src/display_config.cpp     |   7 +--
 src/display_config.h       |   4 --
 src/forwarding_surface.cpp |  18 ------
 src/forwarding_surface.h   |  15 +----
 src/mir_version_manager.h  |  20 ------
 src/output.cpp             |  43 -------------
 src/renderer.h             |   2 -
 tests/CMakeLists.txt       |   1 -
 tests/mock_session.h       |  17 +++--
 tests/mock_surface.h       |  13 +---
 tests/stub_session.h       | 123 -------------------------------------
 tests/stub_surface.h       |  22 ++-----
 tests/test_workspace.cpp   |   6 +-
 13 files changed, 23 insertions(+), 268 deletions(-)
 delete mode 100644 tests/stub_session.h

diff --git a/src/display_config.cpp b/src/display_config.cpp
index 99e4b76..9107a8c 100644
--- a/src/display_config.cpp
+++ b/src/display_config.cpp
@@ -210,12 +210,7 @@ public:
                 output.custom_attribute.contains("primary")
                     ? output.custom_attribute.at("primary") == "true"
                     : false,
-#ifdef MIR_VERSION_2_22_OR_GREATER
-                output.display_info
-#else
-                output.edid
-#endif
-            });
+                output.display_info });
         });
 
         auto copy = conf.clone();
diff --git a/src/display_config.h b/src/display_config.h
index 68301f2..42132cb 100644
--- a/src/display_config.h
+++ b/src/display_config.h
@@ -53,11 +53,7 @@ struct OutputConfigDetails
     MirPowerMode power_mode;
     MirPixelFormat current_format;
     bool is_primary;
-#ifdef MIR_VERSION_2_22_OR_GREATER
     mir::graphics::DisplayInfo display_info;
-#else
-    std::vector<uint8_t> edid;
-#endif
 };
 
 typedef std::vector<OutputConfigDetails> OutputConfigDetailList;
diff --git a/src/forwarding_surface.cpp b/src/forwarding_surface.cpp
index 7e60945..e37953a 100644
--- a/src/forwarding_surface.cpp
+++ b/src/forwarding_surface.cpp
@@ -77,13 +77,11 @@ public:
         return animating_surface.get();
     }
 
-#if (MIR_SERVER_MAJOR_VERSION > 2) || (MIR_SERVER_MAJOR_VERSION == 2 && MIR_SERVER_MINOR_VERSION >= 22)
     MirOrientation orientation() const override { return mir_orientation_normal; }
     auto mirror_mode() const -> MirMirrorMode override
     {
         return renderable ? renderable->mirror_mode() : mir_mirror_mode_none;
     }
-#endif
 
 #ifdef MIR_VERSION_2_24_OR_GREATER
     auto opaque_region() const -> std::optional<mir::geometry::Rectangles> override
@@ -131,18 +129,6 @@ mir::geometry::Displacement ForwardingSurface::content_offset() const
     return surface_->content_offset();
 }
 
-#if (MIR_SERVER_MAJOR_VERSION > 2) || (MIR_SERVER_MAJOR_VERSION == 2 && MIR_SERVER_MINOR_VERSION <= 20)
-std::shared_ptr<mir::frontend::BufferStream> ForwardingSurface::primary_buffer_stream() const
-{
-    return surface_->primary_buffer_stream();
-}
-#endif
-
-const mir::wayland::Weak<mir::frontend::WlSurface>& ForwardingSurface::wayland_surface()
-{
-    return surface_->wayland_surface();
-}
-
 void ForwardingSurface::register_interest(const std::weak_ptr<mir::scene::SurfaceObserver>& observer)
 {
     surface_->register_interest(observer);
@@ -163,12 +149,10 @@ void ForwardingSurface::unregister_interest(const mir::scene::SurfaceObserver& o
     surface_->unregister_interest(observer);
 }
 
-#if (MIR_SERVER_MAJOR_VERSION > 2) || (MIR_SERVER_MAJOR_VERSION == 2 && MIR_SERVER_MINOR_VERSION >= 19)
 void ForwardingSurface::initial_placement_done()
 {
     surface_->initial_placement_done();
 }
-#endif
 
 std::string ForwardingSurface::name() const
 {
@@ -315,12 +299,10 @@ void ForwardingSurface::set_streams(const std::list<mir::scene::StreamInfo>& str
     surface_->set_streams(streams);
 }
 
-#ifdef MIR_VERSION_2_21_OR_GREATER
 std::list<mir::scene::StreamInfo> ForwardingSurface::get_streams() const
 {
     return surface_->get_streams();
 }
-#endif
 
 void ForwardingSurface::set_confine_pointer_state(MirPointerConfinementState state)
 {
diff --git a/src/forwarding_surface.h b/src/forwarding_surface.h
index 92e8c1e..c434435 100644
--- a/src/forwarding_surface.h
+++ b/src/forwarding_surface.h
@@ -42,17 +42,11 @@ public:
     void consume(const std::shared_ptr<MirEvent const>& event) override;
     auto visible_on_lock_screen() const -> bool override;
     auto content_offset() const -> mir::geometry::Displacement override;
-#ifdef MIR_VERSION_2_20_OR_LESSER
-    auto primary_buffer_stream() const -> std::shared_ptr<mir::frontend::BufferStream> override;
-#endif
-    auto wayland_surface() -> const mir::wayland::Weak<mir::frontend::WlSurface>& override;
     void register_interest(const std::weak_ptr<mir::scene::SurfaceObserver>& observer) override;
     void register_interest(const std::weak_ptr<mir::scene::SurfaceObserver>& observer, mir::Executor& executor) override;
     void register_early_observer(const std::weak_ptr<mir::scene::SurfaceObserver>& observer, mir::Executor& executor) override;
     void unregister_interest(const mir::scene::SurfaceObserver& observer) override;
-#ifdef MIR_VERSION_2_19_OR_GREATER
     void initial_placement_done() override;
-#endif
     std::string name() const override;
     mir::geometry::Size content_size() const override;
     mir::geometry::Rectangle input_bounds() const override;
@@ -81,9 +75,7 @@ public:
     int query(MirWindowAttrib attrib) const override;
     void rename(const std::string& title) override;
     void set_streams(const std::list<mir::scene::StreamInfo>& streams) override;
-#ifdef MIR_VERSION_2_21_OR_GREATER
     std::list<mir::scene::StreamInfo> get_streams() const override;
-#endif
     void set_confine_pointer_state(MirPointerConfinementState state) override;
     MirPointerConfinementState confine_pointer_state() const override;
     void placed_relative(const mir::geometry::Rectangle& placement) override;
@@ -100,11 +92,8 @@ public:
     void set_window_margins(mir::geometry::DeltaY top, mir::geometry::DeltaX left, mir::geometry::DeltaY bottom, mir::geometry::DeltaX right) override;
     auto focus_mode() const -> MirFocusMode override;
     void set_focus_mode(MirFocusMode focus_mode) override;
-#ifdef MIR_VERSION_2_21_OR_GREATER
     auto tiled_edges() const -> mir::Flags<MirTiledEdge> override { return mir::Flags { mir_tiled_edge_none }; }
     void set_tiled_edges(mir::Flags<MirTiledEdge> flags) override { surface_->set_tiled_edges(flags); }
-#endif
-#ifdef MIR_VERSION_2_22_OR_GREATER
     void set_mirror_mode(MirMirrorMode mirror_mode) override { surface_->set_mirror_mode(mirror_mode); }
     auto min_width() const -> mir::geometry::Width override { return surface_->min_width(); }
     auto max_width() const -> mir::geometry::Width override { return surface_->max_width(); }
@@ -114,10 +103,12 @@ public:
     void set_max_width(mir::geometry::Width width) override { surface_->set_max_width(width); }
     void set_min_height(mir::geometry::Height height) override { surface_->set_min_height(height); }
     void set_max_height(mir::geometry::Height height) override { surface_->set_max_height(height); }
-#endif
 
 #ifdef MIR_VERSION_2_24_OR_GREATER
     void set_opaque_region(mir::geometry::Rectangles const& region) override { surface_->set_opaque_region(region); }
+    auto wayland_surface() -> const mir::wayland::Weak<mir::frontend::WlSurface>& { }
+#else
+    auto wayland_surface() -> const mir::wayland::Weak<mir::frontend::WlSurface>& override { return surface_->wayland_surface(); }
 #endif
 
 private:
diff --git a/src/mir_version_manager.h b/src/mir_version_manager.h
index 2c2400a..1928489 100644
--- a/src/mir_version_manager.h
+++ b/src/mir_version_manager.h
@@ -20,26 +20,6 @@ along with this program.  If not, see <http://www.gnu.org/licenses/>.
 
 #include <mir/version.h>
 
-#if (MIR_SERVER_MAJOR_VERSION > 2) || (MIR_SERVER_MAJOR_VERSION == 2 && MIR_SERVER_MINOR_VERSION >= 19)
-#define MIR_VERSION_2_19_OR_GREATER
-#endif
-
-#if (MIR_SERVER_MAJOR_VERSION > 2) || (MIR_SERVER_MAJOR_VERSION == 2 && MIR_SERVER_MINOR_VERSION >= 20)
-#define MIR_VERSION_2_20_OR_GREATER
-#endif
-
-#if (MIR_SERVER_MAJOR_VERSION > 2) || (MIR_SERVER_MAJOR_VERSION == 2 && MIR_SERVER_MINOR_VERSION <= 20)
-#define MIR_VERSION_2_20_OR_LESSER
-#endif
-
-#if (MIR_SERVER_MAJOR_VERSION > 2) || (MIR_SERVER_MAJOR_VERSION == 2 && MIR_SERVER_MINOR_VERSION >= 21)
-#define MIR_VERSION_2_21_OR_GREATER
-#endif
-
-#if (MIR_SERVER_MAJOR_VERSION > 2) || (MIR_SERVER_MAJOR_VERSION == 2 && MIR_SERVER_MINOR_VERSION >= 22)
-#define MIR_VERSION_2_22_OR_GREATER
-#endif
-
 #if ((MIR_SERVER_MAJOR_VERSION > 2) || (MIR_SERVER_MAJOR_VERSION == 2 && MIR_SERVER_MINOR_VERSION >= 24)) || COMPILING_AGAINST_DEV
 #define MIR_VERSION_2_24_OR_GREATER
 #endif
diff --git a/src/output.cpp b/src/output.cpp
index a56f339..2963719 100644
--- a/src/output.cpp
+++ b/src/output.cpp
@@ -32,9 +32,6 @@ along with this program.  If not, see <http://www.gnu.org/licenses/>.
 #include <mir/log.h>
 #include <miral/window_info.h>
 #include <miral/zone.h>
-#ifndef MIR_VERSION_2_22_OR_GREATER
-#include <mir/graphics/edid.h>
-#endif
 
 using namespace miracle;
 namespace mg = mir::graphics;
@@ -429,29 +426,9 @@ nlohmann::json Output::to_json(bool is_focused) const
         break;
     }
 
-#ifdef MIR_VERSION_2_22_OR_GREATER
     auto const make = output_config.display_info.vendor.value_or("Unknown");
     auto const model = output_config.display_info.model.value_or("Unknown");
     auto const serial = output_config.display_info.serial.value_or("0x00000000");
-#else
-    std::string make = "Unknown";
-    std::string model = "Unknown";
-    std::string serial = "0x00000000";
-    if (output_config.edid.size() >= mg::Edid::minimum_size)
-    {
-        auto const edid = reinterpret_cast<mg::Edid const*>(output_config.edid.data());
-        mg::Edid::Manufacturer man;
-        edid->get_manufacturer(man);
-        mg::Edid::MonitorName name;
-        edid->get_monitor_name(name);
-
-        make = man;
-        model = name;
-#ifdef MIR_VERSION_2_21_OR_GREATER
-        serial = edid->serial_number();
-#endif
-    }
-#endif
 
     return {
         { "id",                   reinterpret_cast<std::uintptr_t>(this)        },
@@ -552,29 +529,9 @@ nlohmann::json Output::get_outputs_json(bool) const
         break;
     }
 
-#ifdef MIR_VERSION_2_22_OR_GREATER
     auto const make = output_config.display_info.vendor.value_or("Unknown");
     auto const model = output_config.display_info.model.value_or("Unknown");
     auto const serial = output_config.display_info.serial.value_or("0x00000000");
-#else
-    std::string make = "Unknown";
-    std::string model = "Unknown";
-    std::string serial = "0x00000000";
-    if (output_config.edid.size() >= mg::Edid::minimum_size)
-    {
-        auto const edid = reinterpret_cast<mg::Edid const*>(output_config.edid.data());
-        mg::Edid::Manufacturer man;
-        edid->get_manufacturer(man);
-        mg::Edid::MonitorName name;
-        edid->get_monitor_name(name);
-
-        make = man;
-        model = name;
-#ifdef MIR_VERSION_2_21_OR_GREATER
-        serial = edid->serial_number();
-#endif
-    }
-#endif
 
     return {
         { "name",             name_                                         },
diff --git a/src/renderer.h b/src/renderer.h
index 4fabd14..9389f69 100644
--- a/src/renderer.h
+++ b/src/renderer.h
@@ -62,9 +62,7 @@ public:
     void set_viewport(mir::geometry::Rectangle const& rect) override;
     void set_output_transform(glm::mat2 const&) override;
     auto render(mir::graphics::RenderableList const&) const -> std::unique_ptr<mir::graphics::Framebuffer> override;
-#ifdef MIR_VERSION_2_21_OR_GREATER
     void set_output_filter(MirOutputFilter filter) override;
-#endif
 
     // This is called _without_ a GL context:
     void suspend() override;
diff --git a/tests/CMakeLists.txt b/tests/CMakeLists.txt
index fc9a0bc..b8551bf 100644
--- a/tests/CMakeLists.txt
+++ b/tests/CMakeLists.txt
@@ -45,7 +45,6 @@ set(SOURCES
     test_ipc_message_handler.cpp
     test_ipc_command_executor.cpp
     stub_configuration.h
-    stub_session.h
     stub_surface.h
     stub_window_controller.h
     stub_container.h
diff --git a/tests/mock_session.h b/tests/mock_session.h
index 9b59830..4d1daa8 100644
--- a/tests/mock_session.h
+++ b/tests/mock_session.h
@@ -17,10 +17,10 @@
 #ifndef MOCK_SESSION_H
 #define MOCK_SESSION_H
 
+#include "mir_version_manager.h"
 #include <gmock/gmock.h>
 #include <mir/scene/session.h>
 #include <mir/shell/surface_specification.h>
-#include <mir/version.h>
 
 namespace miracle
 {
@@ -32,18 +32,21 @@ namespace test
         MOCK_METHOD(pid_t, process_id, (), (const, override));
         MOCK_METHOD(mir::Fd, socket_fd, (), (const, override));
         MOCK_METHOD(std::string, name, (), (const, override));
-        MOCK_METHOD(void, send_error, (mir::ClientVisibleError const& error), (override));
         MOCK_METHOD(std::shared_ptr<mir::scene::Surface>, default_surface, (), (const, override));
-#if (MIR_SERVER_MAJOR_VERSION > 2) || (MIR_SERVER_MAJOR_VERSION == 2 && MIR_SERVER_MINOR_VERSION < 22)
-        MOCK_METHOD(void, send_input_config, (MirInputConfig const& config), (override));
-        MOCK_METHOD(void, set_lifecycle_state, (MirLifecycleState state), (override));
-#endif
         MOCK_METHOD(void, hide, (), (override));
         MOCK_METHOD(void, show, (), (override));
         MOCK_METHOD(void, start_prompt_session, (), (override));
         MOCK_METHOD(void, stop_prompt_session, (), (override));
         MOCK_METHOD(void, suspend_prompt_session, (), (override));
         MOCK_METHOD(void, resume_prompt_session, (), (override));
+#ifdef MIR_VERSION_2_24_OR_GREATER
+        MOCK_METHOD(std::shared_ptr<mir::scene::Surface>, create_surface,
+            (std::shared_ptr<Session> const& session,
+                mir::shell::SurfaceSpecification const& params,
+                std::shared_ptr<mir::scene::SurfaceObserver> const& observer,
+                mir::Executor* observer_executor),
+            (override));
+#else
         MOCK_METHOD(std::shared_ptr<mir::scene::Surface>, create_surface,
             (std::shared_ptr<Session> const& session,
                 mir::wayland::Weak<mir::frontend::WlSurface> const& wayland_surface,
@@ -51,6 +54,8 @@ namespace test
                 std::shared_ptr<mir::scene::SurfaceObserver> const& observer,
                 mir::Executor* observer_executor),
             (override));
+        MOCK_METHOD(void, send_error, (mir::ClientVisibleError const& error), (override));
+#endif
         MOCK_METHOD(void, destroy_surface, (std::shared_ptr<mir::scene::Surface> const& surface), (override));
         MOCK_METHOD(std::shared_ptr<mir::scene::Surface>, surface_after,
             (std::shared_ptr<mir::scene::Surface> const& surface),
diff --git a/tests/mock_surface.h b/tests/mock_surface.h
index 6fc557b..28d6ce1 100644
--- a/tests/mock_surface.h
+++ b/tests/mock_surface.h
@@ -28,14 +28,8 @@ namespace test
     class MockSurface : public mir::scene::Surface
     {
     public:
-#if (MIR_SERVER_MAJOR_VERSION > 2) || (MIR_SERVER_MAJOR_VERSION == 2 && MIR_SERVER_MINOR_VERSION >= 19)
         MOCK_METHOD(void, initial_placement_done, (), (override));
-#endif
         MOCK_METHOD(mir::geometry::Displacement, content_offset, (), (const, override));
-#if (MIR_SERVER_MAJOR_VERSION > 2) || (MIR_SERVER_MAJOR_VERSION == 2 && MIR_SERVER_MINOR_VERSION <= 20)
-        MOCK_METHOD(std::shared_ptr<mir::frontend::BufferStream>, primary_buffer_stream, (), (const, override));
-#endif
-        MOCK_METHOD((mir::wayland::Weak<mir::frontend::WlSurface> const&), wayland_surface, (), (override));
         MOCK_METHOD(bool, input_area_contains, (mir::geometry::Point const&), (const, override));
         MOCK_METHOD(mir::input::InputReceptionMode, reception_mode, (), (const, override));
         MOCK_METHOD(void, consume, (std::shared_ptr<MirEvent const> const&), (override));
@@ -88,12 +82,9 @@ namespace test
         MOCK_METHOD(void, set_window_margins, (mir::geometry::DeltaY, mir::geometry::DeltaX, mir::geometry::DeltaY, mir::geometry::DeltaX), (override));
         MOCK_METHOD(MirFocusMode, focus_mode, (), (const, override));
         MOCK_METHOD(void, set_focus_mode, (MirFocusMode), (override));
-#ifdef MIR_VERSION_2_21_OR_GREATER
         MOCK_METHOD(mir::Flags<MirTiledEdge>, tiled_edges, (), (const, override));
         MOCK_METHOD(void, set_tiled_edges, (mir::Flags<MirTiledEdge>), (override));
         MOCK_METHOD(std::list<mir::scene::StreamInfo>, get_streams, (), (const, override));
-#endif
-#ifdef MIR_VERSION_2_22_OR_GREATER
         MOCK_METHOD(void, set_mirror_mode, (MirMirrorMode), (override));
         MOCK_METHOD(mir::geometry::Width, min_width, (), (const, override));
         MOCK_METHOD(mir::geometry::Width, max_width, (), (const, override));
@@ -103,10 +94,10 @@ namespace test
         MOCK_METHOD(void, set_max_width, (mir::geometry::Width), (override));
         MOCK_METHOD(void, set_min_height, (mir::geometry::Height), (override));
         MOCK_METHOD(void, set_max_height, (mir::geometry::Height), (override));
-#endif
-
 #ifdef MIR_VERSION_2_24_OR_GREATER
         MOCK_METHOD(void, set_opaque_region, (mir::geometry::Rectangles const&), (override));
+#else
+        MOCK_METHOD((mir::wayland::Weak<mir::frontend::WlSurface> const&), wayland_surface, (), (override));
 #endif
     };
 
diff --git a/tests/stub_session.h b/tests/stub_session.h
deleted file mode 100644
index ad3433f..0000000
--- a/tests/stub_session.h
+++ /dev/null
@@ -1,123 +0,0 @@
-/*
- * Copyright Â© Canonical Ltd.
- *
- * This program is free software: you can redistribute it and/or modify it
- * under the terms of the GNU General Public License version 2 or 3 as
- * published by the Free Software Foundation.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- */
-
-#ifndef MIRACLE_WM_STUB_SESSION_H
-#define MIRACLE_WM_STUB_SESSION_H
-
-#include <mir/scene/session.h>
-#include <mir/version.h>
-
-namespace miracle::test
-{
-class StubSession : public mir::scene::Session
-{
-public:
-    [[nodiscard]] auto process_id() const -> pid_t override
-    {
-        return 0;
-    }
-
-    [[nodiscard]] auto socket_fd() const -> mir::Fd override
-    {
-        return mir::Fd();
-    }
-
-    [[nodiscard]] auto name() const -> std::string override
-    {
-        return std::string();
-    }
-
-    void send_error(mir::ClientVisibleError const& error) override
-    {
-    }
-
-    [[nodiscard]] auto default_surface() const -> std::shared_ptr<mir::scene::Surface> override
-    {
-        return std::shared_ptr<mir::scene::Surface>();
-    }
-
-#if (MIR_SERVER_MAJOR_VERSION > 2) || (MIR_SERVER_MAJOR_VERSION == 2 && MIR_SERVER_MINOR_VERSION < 22)
-    void set_lifecycle_state(MirLifecycleState state) override
-    {
-    }
-
-    void send_input_config(MirInputConfig const& config) override
-    {
-    }
-
-#endif
-
-    void hide() override
-    {
-    }
-
-    void show() override
-    {
-    }
-
-    void start_prompt_session() override
-    {
-    }
-
-    void stop_prompt_session() override
-    {
-    }
-
-    void suspend_prompt_session() override
-    {
-    }
-
-    void resume_prompt_session() override
-    {
-    }
-
-    auto create_surface(std::shared_ptr<Session> const& session,
-        mir::wayland::Weak<mir::frontend::WlSurface> const& wayland_surface,
-        mir::shell::SurfaceSpecification const& params,
-        std::shared_ptr<mir::scene::SurfaceObserver> const& observer,
-        mir::Executor* observer_executor) -> std::shared_ptr<mir::scene::Surface> override
-    {
-        return std::shared_ptr<mir::scene::Surface>();
-    }
-
-    void destroy_surface(std::shared_ptr<mir::scene::Surface> const& surface) override
-    {
-    }
-
-    [[nodiscard]] auto surface_after(std::shared_ptr<mir::scene::Surface> const& surface) const -> std::shared_ptr<mir::scene::Surface> override
-    {
-        return std::shared_ptr<mir::scene::Surface>();
-    }
-
-    auto create_buffer_stream(
-        mir::graphics::BufferProperties const& props) -> std::shared_ptr<mir::compositor::BufferStream> override
-    {
-        return std::shared_ptr<mir::compositor::BufferStream>();
-    }
-
-    void destroy_buffer_stream(std::shared_ptr<mir::frontend::BufferStream> const& stream) override
-    {
-    }
-
-    void configure_streams(mir::scene::Surface& surface, std::vector<mir::shell::StreamSpecification> const& config) override
-    {
-    }
-
-public:
-};
-}
-
-#endif // MIRACLE_WM_STUB_SESSION_H
diff --git a/tests/stub_surface.h b/tests/stub_surface.h
index 67de546..8cc1ae3 100644
--- a/tests/stub_surface.h
+++ b/tests/stub_surface.h
@@ -25,25 +25,12 @@ namespace miracle::test
 class StubSurface : public mir::scene::Surface
 {
 public:
-#ifdef MIR_VERSION_2_19_OR_GREATER
     void initial_placement_done() override { }
-#endif
 
     auto content_offset() const -> mir::geometry::Displacement override
     {
         return mir::geometry::Displacement();
     }
-#ifdef MIR_VERSION_2_20_OR_LESSER
-    auto primary_buffer_stream() const -> std::shared_ptr<mir::frontend::BufferStream> override
-    {
-        return std::shared_ptr<mir::frontend::BufferStream>();
-    }
-#endif
-
-    auto wayland_surface() -> mir::wayland::Weak<mir::frontend::WlSurface> const& override
-    {
-        throw std::logic_error("Unimplemented");
-    }
 
     bool input_area_contains(mir::geometry::Point const& point) const override
     {
@@ -280,16 +267,13 @@ public:
     {
     }
 
-#ifdef MIR_VERSION_2_21_OR_GREATER
     auto tiled_edges() const -> mir::Flags<MirTiledEdge> override { return mir::Flags { mir_tiled_edge_none }; }
     void set_tiled_edges(mir::Flags<MirTiledEdge>) override { }
     std::list<mir::scene::StreamInfo> get_streams() const override
     {
         return std::list<mir::scene::StreamInfo>();
     }
-#endif
 
-#ifdef MIR_VERSION_2_22_OR_GREATER
     void set_mirror_mode(MirMirrorMode) override
     {
     }
@@ -302,10 +286,14 @@ public:
     void set_max_width(mir::geometry::Width width) override { }
     void set_min_height(mir::geometry::Height height) override { }
     void set_max_height(mir::geometry::Height height) override { }
-#endif
 
 #ifdef MIR_VERSION_2_24_OR_GREATER
     void set_opaque_region(mir::geometry::Rectangles const& region) override { }
+#else
+    auto wayland_surface() -> mir::wayland::Weak<mir::frontend::WlSurface> const& override
+    {
+        throw std::logic_error("Unimplemented");
+    }
 #endif
 };
 }
diff --git a/tests/test_workspace.cpp b/tests/test_workspace.cpp
index 3c7ef14..efb3a3c 100644
--- a/tests/test_workspace.cpp
+++ b/tests/test_workspace.cpp
@@ -23,7 +23,6 @@ along with this program.  If not, see <http://www.gnu.org/licenses/>.
 #include "parent_container.h"
 #include "passthrough_server_action_queue.h"
 #include "stub_configuration.h"
-#include "stub_session.h"
 #include "stub_surface.h"
 #include "stub_window_controller.h"
 #include "window_controller.h"
@@ -95,12 +94,10 @@ public:
         miral::ApplicationInfo app_info;
         auto const hint = target_workspace->allocate_position(app_info, spec, { ContainerType::leaf, parent });
 
-        auto const session = std::make_shared<test::StubSession>();
-        sessions.push_back(session);
         auto const surface = std::make_shared<test::StubSurface>();
         surfaces.push_back(surface);
 
-        miral::Window const window(session, surface);
+        miral::Window const window(nullptr, surface);
         miral::WindowInfo const info(window, spec);
         auto leaf = target_workspace->create_container(info, hint);
         pairs.push_back({ window, leaf, geom::Rectangle(), mir_window_state_restored, std::nullopt });
@@ -112,7 +109,6 @@ public:
     }
 
     std::shared_ptr<CompositorState> state;
-    std::vector<std::shared_ptr<test::StubSession>> sessions;
     std::vector<std::shared_ptr<test::StubSurface>> surfaces;
     std::vector<StubWindowData> pairs;
     std::shared_ptr<test::MockOutput> output;
-- 
2.52.0

