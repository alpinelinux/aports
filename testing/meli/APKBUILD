# Contributor: Thomas BÃ¶hler <witcher@wiredspace.de>
# Maintainer: omni <omni+alpine@hack.org>
maintainer="omni <omni+alpine@hack.org>"
pkgname=meli
pkgver=0.8.12
pkgrel=0
pkgdesc="terminal e-mail client"
arch="all"
url="https://meli-email.org/"
license="GPL-3.0-or-later"
makedepends="cargo
	cargo-auditable
	curl-dev
	openssl-dev
	zlib-dev
	"
checkdepends="m4"
subpackages="$pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://git.meli-email.org/meli/meli/archive/v$pkgver.tar.gz
	0001-don-t-statically-link-libz-sys.patch
	0002-allow-tests-without-cli-docs-feature.patch
	0003-hide-man-related-subcommands-if-disabled.patch
	0004-fix-test_jmap_refresh.patch
	"
builddir="$srcdir/$pkgname"
options="net" # cargo fetch

_features=sqlite3,notmuch,smtp,gpgme,jmap

export OPENSSL_NO_VENDOR=1

prepare() {
	default_prepare
	cargo fetch --target="$CTARGET" --locked
}

build() {
	cargo auditable build --release --frozen \
		--no-default-features --features "$_features"
}

check() {
	cargo test --frozen \
		--no-default-features --features "$_features"
}

package() {
	install -Dm0755 -t "$pkgdir"/usr/bin/ target/release/"$pkgname"

	install -Dm0644 -t "$pkgdir"/usr/share/man/man1/ meli/docs/*.1
	install -Dm0644 -t "$pkgdir"/usr/share/man/man5/ meli/docs/*.5
	install -Dm0644 -t "$pkgdir"/usr/share/man/man7/ meli/docs/*.7
	install -Dm0644 -t "$pkgdir"/usr/share/doc/"$pkgname"/ \
		meli/docs/samples/sample-config.toml
	install -Dm0644 -t "$pkgdir"/usr/share/doc/"$pkgname"/themes/ \
		meli/docs/samples/themes/*
}

sha512sums="
d8ae27eae7581898a1f7b1ff785795da3338460417caa01be42497c76de979c47498edcf32d3147ca3cb4127398b9093ce17f2e8a7c9ea576912e5bed9d8790e  meli-0.8.12.tar.gz
d8d9a5a6c8c4b131ab20a152293228282b0927570e9b7716fe7fa5305ee23014d703da6b2a2b96cdc1e891c8255df1f9f38108ebf8ef4075330af387634af964  0001-don-t-statically-link-libz-sys.patch
92b35f4ee8ca419da89245c4278026409657daf581b42a6f54810e05320d7e7ac708dd586496a5ccf939a4c718e25abaf7702ea66c09b7bc6df6f05af4e39e23  0002-allow-tests-without-cli-docs-feature.patch
a6bee439a53836bccdfc5db826b11a75deb1ad30e1f0e2a5efbdce74736518ca3cf2ea7e4237c7188cb5bfcb23524f0180949aa32903b725398b4367d3ce7905  0003-hide-man-related-subcommands-if-disabled.patch
33c4418e7ca5ca69998edcb9c76168027a96e0c1321252b2d3dab3946fc0d2ee0883df8c6ccba212adec35dca76e0018adfef11e57e262f1204ccc7935057b66  0004-fix-test_jmap_refresh.patch
"
