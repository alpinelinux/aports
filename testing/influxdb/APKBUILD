# Contributor: Stefan Wagner <stw@bit-strickerei.de>
# Maintainer: Stefan Wagner <stw@bit-strickerei.de>
pkgname=influxdb
pkgver=1.4.2
pkgrel=0
pkgdesc="Scalable datastore for metrics, events, and real-time analytics"
url="https://www.influxdata.com/time-series-platform/influxdb/"
arch="all !aarch64"
license="MIT"
makedepends="go go-gdm python2 asciidoc xmlto"
pkgusers="influxdb"
pkggroups="influxdb"
install="$pkgname.pre-install"
options="!check"
subpackages="$pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/influxdata/$pkgname/archive/v$pkgver.tar.gz
	influxdb.initd
	influxdb.logrotate
	"
builddir="$srcdir/src/github.com/influxdata/$pkgname"

prepare() {
	mkdir -p ${builddir%/*}
	mv "$srcdir"/$pkgname-$pkgver "$builddir"/ || return 1
	default_prepare
}

build() {
	export GOPATH="$srcdir"
	cd "$builddir"
	gdm restore
	go install -ldflags="-X main.version=$pkgver" ./...
	make -C man
}

package() {
	cd "$srcdir"
	install -d "$pkgdir/usr/sbin/"
	install -Dm755 "bin/influxd" "$pkgdir/usr/sbin/"

	install -d "$pkgdir/usr/bin/"
	install -Dm755 "bin/influx" "$pkgdir/usr/bin/"
	install -Dm755 "bin/influx_tsm" "$pkgdir/usr/bin/"
	install -Dm755 "bin/influx_stress" "$pkgdir/usr/bin/"
	install -Dm755 "bin/influx_inspect" "$pkgdir/usr/bin/"

	cd "$builddir"
	install -d "$pkgdir/usr/share/man/man1/"
	install -Dm644 man/*.1 "$pkgdir/usr/share/man/man1/"

	install -Dm644 "etc/config.sample.toml" "$pkgdir/etc/influxdb/influxdb.conf"

	install -Dm755 "$srcdir/$pkgname.initd" "$pkgdir/etc/init.d/$pkgname"
	install -Dm644 "$srcdir/$pkgname.logrotate" "$pkgdir/etc/logrotate.d/$pkgname"
}

sha512sums="89be803d545ab932500993d0d7b69fd1690359b902579afcd359ea42cbb439ade0d7997f2f687df317e67af591d39bf0684c459ef2c779fb59b76f7c7e575afb  influxdb-1.4.2.tar.gz
55d5776fde330001f254fed4b01163d576d1995c23b08ef64c3c33b7a53fa49c71092867a17149d3148af7a8e17dc4779481afe9dd54a86eeee16168dbb964e0  influxdb.initd
5d754e3aeec912bae8f5bf2f84153d4ccc82918d9c728631e8b9ad6737fab3352af0ab63f46ac80aab6384d779bae5d321da0465f26fd8798a9694f7d79f879d  influxdb.logrotate"
