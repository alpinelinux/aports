# Contributor: Joe Holden <jwh@zorins.us>
# Maintainer: Joe Holden <jwh@zorins.us>
pkgname=cloudflared
pkgver=2019.3.0
pkgrel=0
pkgdesc="Argo Tunnel agent"
url="https://github.com/cloudflare/cloudflared"
arch="all"
license="custom"
makedepends="go"
install="$pkgname.pre-install"
pkgusers="$pkgname"
pkggroups="$pkgname"
subpackages="$pkgname-openrc $pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/cloudflare/cloudflared/archive/$pkgver.tar.gz
	cloudflared.initd
	cloudflared.confd"

builddir="$srcdir/src/github.com/cloudflare/$pkgname"

prepare() {
	default_prepare
	mkdir -p "$srcdir/src/github.com/cloudflare"
	mv "$srcdir"/$pkgname-$pkgver "$builddir"/
}

build() {
	cd "$builddir"
	GOPATH="$srcdir" go build -v -o bin/$pkgname ./cmd/$pkgname
}

check() {
	# Unit tests
	cd "$builddir"
	GOPATH="$srcdir" go test ./...
}

package() {
	cd "$builddir"

	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname

	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname

	install -m750 -o $pkgname -g $pkgname \
		-D bin/$pkgname \
		"$pkgdir"/usr/sbin/$pkgname

	setcap cap_net_bind_service=+ep \
		"$pkgdir"/usr/sbin/$pkgname

	install -Dm644 LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}
sha512sums="99d22c78d84b96e8f5602460af0d3d71514737416695b733742ce4515278f188c7adbaedd1fb9725bf92de5bbbdee43f8907a8d25ae5efcd9a1f0d389b070b82  cloudflared-2019.3.0.tar.gz
b41236006d383b01bd7b36769ae09a579dae138b41da50553a793f22f965acaf45e7b186da0de9d4e9db732c9576dd1a476401e6bffdb33be9c73180fb905a8c  cloudflared.initd
f9e46a7feced21fcdcd334069bf179ed049f77fff8fe3c35f341a88df43c9ecf3c655048ac21fd185af4133e6c3787d7d7a25852a13be4592d9199246a929fcb  cloudflared.confd"
