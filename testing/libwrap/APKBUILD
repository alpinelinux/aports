# Contributor: Stuart Cardall <developer@it-offshore.co.uk>
# Maintainer: Stuart Cardall <developer@it-offshore.co.uk>
pkgname=libwrap
_pkgname=tcp_wrappers
pkgver=7.6.26
pkgrel=0
pkgdesc="Monitors and Controls incoming TCP connections [ipv4 + ipv6]"
url="ftp://ftp.porcupine.org/pub/security/index.html"
arch="all"
license="BSD"
options="!check"
makedepends="libnsl-dev bsd-compat-headers"
subpackages="$pkgname-dev $pkgname-doc ${_pkgname/_/-} ${_pkgname/_/-}-doc"
source="ftp://ftp.porcupine.org/pub/security/${_pkgname}_${pkgver%.*}-ipv6.4.tar.gz
	00-tcpw7.2-config.patch
	01-tcpw7.2-setenv.patch
	02-tcpw7.6-netgroup.patch
	03-tcp_wrappers-7.6-bug11881.patch
	04-tcp_wrappers-7.6-bug17795.patch
	05-tcp_wrappers-7.6-bug17847.patch
	06-tcp_wrappers-7.6-fixgethostbyname.patch
	07-tcp_wrappers-7.6-docu.patch
	08-tcp_wrappers-7.6-man.patch
	09-tcp_wrappers.usagi-ipv6.patch
	11-tcp_wrappers-7.6-shared.patch
	12-tcp_wrappers-7.6-sig.patch
	14-tcp_wrappers-7.6-ldflags.patch
	15-tcp_wrappers-7.6-fix_sig-bug141110.patch
	16-tcp_wrappers-7.6-162412.patch
	17-tcp_wrappers-7.6-220015.patch
	19-tcp_wrappers-7.6-siglongjmp.patch
	20-tcp_wrappers-7.6-sigchld.patch
	21-tcp_wrappers-7.6-196326.patch
	22-tcp_wrappers_7.6-249430.patch
	23-tcp_wrappers-7.6-inetdconf.patch
	24-tcp_wrappers-7.6-bug698464.patch
	25-tcp_wrappers-7.6-relro.patch
	26-tcp_wrappers-7.6-xgets.patch
	27-tcp_wrappers-7.6-initgroups.patch
	28-tcp_wrappers-7.6-warnings.patch
	29-tcp_wrappers-7.6-uchart_fix.patch
	30-tcp_wrappers-7.6-altformat.patch
	31-tcp_wrappers-7.6-aclexec.patch
	40-remove-glibc.patch
	41-innetgr-stub.patch
	42-fix-implicit-malloc.patch
	43-disable-netgroup.patch
	hosts.allow
	hosts.deny
	"

builddir="$srcdir/"${_pkgname}_${pkgver%.*}-ipv6.4

prepare() {
	chmod 600 $builddir/*
	default_prepare || return 1
}

build() {
	cd "$builddir"
	make \
		COPTS="$CFLAGS" \
		LDFLAGS="$LDFLAGS -pie -z relro -z now" \
		REAL_DAEMON_DIR='/usr/sbin' \
		STYLE='-DPROCESS_OPTIONS' \
		MAJOR=0 \
		MINOR=7 \
		REL=6 \
		linux || return 1
}

wrappers() {
	cd "$builddir"

	depends="libwrap"
	pkgdesc="Wietse Venema's network logger, also known as TCPD or LOG_TCP."

	# bin #
	mkdir -p "$subpkgdir"/usr/sbin "$subpkgdir"/etc

	install -Dm 755 safe_finger tcpd tcpdchk tcpdmatch try-from -t "$subpkgdir"/usr/sbin || return 1
	install -Dm 644 "$srcdir"/hosts.allow -t "$subpkgdir"/etc || return 1
	install -Dm 644 "$srcdir"/hosts.deny -t "$subpkgdir"/etc || return 1

	# docs #
	mkdir -p "$subpkgdir-doc"/usr/share/man/man3 "$subpkgdir-doc"/usr/share/man/man5 "$subpkgdir-doc"/usr/share/man/man8
	mkdir -p "$subpkgdir-doc"/usr/share/licenses "$subpkgdir-doc"/usr/share/doc/tcp-wrappers

	install -Dm 644 *.3 -t "$subpkgdir-doc"/usr/share/man/man3 || return 1
	install -Dm 644 *.5 -t "$subpkgdir-doc"/usr/share/man/man5 || return 1
	install -Dm 644 *.8 -t "$subpkgdir-doc"/usr/share/man/man8 || return 1
	install -Dm 644 README -t "$subpkgdir-doc"/usr/share/doc/tcp-wrappers || return 1

	ln -sf hosts_access.5 "$subpkgdir-doc"/usr/share/man/man5/hosts.allow.5
	ln -sf hosts_access.5 "$subpkgdir-doc"/usr/share/man/man5/hosts.deny.5
	ln -s libwrap "$subpkgdir-doc"/usr/share/licenses/tcp-wrappers
}

package() {
	cd "$builddir"

	mkdir -p "$pkgdir"/usr/include "$pkgdir"/usr/lib "$pkgdir"/usr/share/licenses/libwrap

	cp -a libwrap.so* "$pkgdir"/usr/lib
	install -Dm 644 tcpd.h -t "$pkgdir"/usr/include || return 1
	install -Dm 644 DISCLAIMER -t "$pkgdir"/usr/share/licenses/libwrap || return 1
}

sha512sums="b753b2e54fe243fbcb403470b19fa1b08a912a6a65981dc1bf20288379b903701d4b5a477350cb3470cb6d908cf51ef653f44dc17daff17f34e59b6aa1b41c95  tcp_wrappers_7.6-ipv6.4.tar.gz
45a7e2258d6d8d77d941098ef35899e4bdec6a4b209e460d5082dc6ed257f4fd0a464e424747b4cc77a09931d96978bb3bf44ed62e5e40598327561068fd5073  00-tcpw7.2-config.patch
432252edda67bb31d40fb64a55efcc7200a3232482bf2943ef7ee1c1942eabf445558f7216f056afe3e6575a4fe1aa07e3b29d82e0e7a070e474dea7035efb2f  01-tcpw7.2-setenv.patch
bd71dfc9ee9cef89a6dda920d273658fc754bd434606b91beb08f11cb01a2def7361b23e879e636235e00108eb82e279fd9c69a2b144248f8a5ee2b4c043cfd0  02-tcpw7.6-netgroup.patch
8e354549d7cee514eabb20776450498e81d4e12ee460cabc58a5e4ca835400674391a5df1c116d3dcf1bd961a62cbe99f2722e7aaa7d9c03e2fed69712e3645c  03-tcp_wrappers-7.6-bug11881.patch
119cb6dbc0c5c548a8fb6a1a62fd0e5e39ffa67a0340aaa4aaddf9b33f5ea5b7f37379a69d5dbdd00cfbb8ba796b67d9240cc79197cdafdc0fe95146526d3400  04-tcp_wrappers-7.6-bug17795.patch
b2c3d10319d5255c509fe5c6e05818764346ba8c5794b802ae3b340a8ead21b26fbab18c0eaed2a3b44ee75e261d9ad5d26890a9e928039676de6813b85362dd  05-tcp_wrappers-7.6-bug17847.patch
1ad58fa17d793f7c3f13402a0ec562aa35ac068dc3d043a5f44e9df3bd2463d01c42b14ea204e06474500c98a2c59f262eded7c7b0525db9123c790e7381e650  06-tcp_wrappers-7.6-fixgethostbyname.patch
82ec0124c4a780f0bf15029a4865f0569e749563796396f96eab9315850c7fdcdee8c3caac49697abc407af358ef669b937054070cd75c53d0e9e96d96149958  07-tcp_wrappers-7.6-docu.patch
3606994ddea614f4e469295e7e162c2a3798ce939f62a8ca0b530da52d6a37fb6da9687a3ebfe18c301952a399b519b0b84dc7fd6ebb9b76db2b038512e8deb1  08-tcp_wrappers-7.6-man.patch
c2f25e751b5e54cb0e4c0467c7256dfcb43f132e4e1e51a9ed2b978110ed4732713548046ca9820c924f811b7486b32a9d476f2f0cc5a83a9971023ccb9dfd48  09-tcp_wrappers.usagi-ipv6.patch
ced7d926929ff2491359e1502349373e52b0d1c8d1ef3ed167f926095d7e5f91d4d1b2ac36bfd855ef9f9a332a63472835e819df8f196106f71b64863d7b5d8e  11-tcp_wrappers-7.6-shared.patch
65f7c7a18eb36ccae93a14e41966f9a4223568c31594b410dc97524047a1b367a9ecd65fd4f68d7cba022569459ed7da3fef692ecad28e3009eca9b708d86dd4  12-tcp_wrappers-7.6-sig.patch
16a4157f41a250d5a9c9cad40686cf2359757fd81a816d72868b9dd71a1f1bea9599f84f46b790f3be82ca76a0efed374920e0c4e26870e4528fcfee41fcf3b9  14-tcp_wrappers-7.6-ldflags.patch
8b0988d7a376521376a7953f431c4c12382bde86c9391a9ad538fd5694bc340cc619e957dd0ea5a03b118c3ab055a56f7992f6581e7fe98a472ada2182bd2c9c  15-tcp_wrappers-7.6-fix_sig-bug141110.patch
ee5fd83a18b9fb8a26c3b99dfb2caadb349b09f71f21ad29b9cd1c51a2b938240c60d0373da4685085878da2e56ade47b2513e99d1b1a65bbefeb44c260a6b07  16-tcp_wrappers-7.6-162412.patch
61602bd585412da5f34e816546df624aae38a4112ad247b9bad86993db433e2748250a439b4aed5ab19a97445152ff5290bf94c5b17502efa5f396431635d62a  17-tcp_wrappers-7.6-220015.patch
7ebe75b579bda344dc4e994c4752678c8d6696fff21bdde26d3730b778c311d306bed5ecf0fb19c5115b9b507b966638ef7b2ac9e9498a471c5f3bc4b9f73419  19-tcp_wrappers-7.6-siglongjmp.patch
69f94bcb53e143c3fbbf085dd75123e99c0539125e7683db897bab9f44ad3432652ed05b1d704519e08a0175ae93bc917f5a57d1bbe7b850651dadfea5dc5f72  20-tcp_wrappers-7.6-sigchld.patch
8581b6ef5a37371a60b1709d0e219e6d1b6e1b5cbdec0528bdf5987ce5add1f7252bddcc8283943e8ed7a562b799e0fd4cac2ba62dc61f7e17df90ee03b0ed2d  21-tcp_wrappers-7.6-196326.patch
fe8ad0aa1a528f84c52975c1dad83ba6758b2236dda072df8beab641d42e47684f2ad72afeb1ff9a988c6f24cb2a5144ac5cd15ef1e9f6773c3786a5fe8dc7c8  22-tcp_wrappers_7.6-249430.patch
a629845874508a7362d761f9406373732a1c0e960196caa9a3001fe40f990f0c707fb3c7d03e2635e8b2135cec4d5866e0e265e7aa150fc50c66fa86ceddd3f7  23-tcp_wrappers-7.6-inetdconf.patch
043a7394b57fb3f55c6abf1ff12dea9040f0f78513aa28f65195cb64655dd64465d7784c283110aa0455209b1872dd6a9f31ffcec1b903523ba788544ad987de  24-tcp_wrappers-7.6-bug698464.patch
faeea18e604f9111b118c8ae7520fafc6a53f0ca2b02f8c433c1f52373f3972347e31d993c1609294d77da121a98fb255a3fdd5883469bde0106a887b1c5ddbf  25-tcp_wrappers-7.6-relro.patch
1a28928bb5a5eac4350e63decdca313f701cf8cab5e55f5f58825bbec95ebb4c556308c17ec4f0bdc9e255791cdff5374b686c9b6bbd4e5a9dafbdeae1d13a13  26-tcp_wrappers-7.6-xgets.patch
d1e6a84960215fdb1e5c6c530c43cd4faa18d5aed3838314d914477a655a810cf6ca28669b7082139a7e723eed9845801f86f4b7cece7e17e239faaec0e28c68  27-tcp_wrappers-7.6-initgroups.patch
c7cdb6b8311568931412b23d92fb6e711a2ee338908eb6157ba38c34f8295c0961407141407749a80ccd47e0c1977e28d3f0241b608f2aacdd482e5ab6f93c61  28-tcp_wrappers-7.6-warnings.patch
d87675146360b7743441702bcd649adee2f1090b2e7abf0bc4e1109ea0356dab25ab4d0e36c97aec2d51eedd14c1090d0b47412c2df413cd8023e225900f2aa4  29-tcp_wrappers-7.6-uchart_fix.patch
f005ff45c190aa8f2a4972b37898ed8ad83ac502abc2351c87d2f28242a2eee70cdfdd620edbbacc1987d2ab53c2d35ef6dcad420eafa5f66b0c9b66fa018745  30-tcp_wrappers-7.6-altformat.patch
aa7c82cee6f60b709ced8f757e4c0124081e6753d63aebd77317fa86dcc58aba922a2202debb542e51427fa3e12385112ff3790dfe987d2b6a6f27b7faf4b816  31-tcp_wrappers-7.6-aclexec.patch
cd49ba0ae344c53d616cf91506bef2cb5f881d95c7d89b6f26ad0a0bf4a336067bb12cfa765c017ddd5d28b49110ddbf0d20de403eae00e8c5cf182df6e769d1  40-remove-glibc.patch
df69d78fe2e6fd138f0cd7dff3493abf98a78b3842b9ff4dd2cc65706c1a827b927c89c8d2f32c83543c1d7e797890801e0ec8d7de4bf50a8beb114035028b32  41-innetgr-stub.patch
3d8ebebf87eb50294c3777630153af0e3aa918e55e36b5fe8cac96ede803bd0b5538b08cb1c9d700d7059fc72cb74558399930ad8712e2e4de728f09c81356a1  42-fix-implicit-malloc.patch
165ca939e606b0ec745e0a7070c8829e6b5b0ecf04a8a8e3181276fe2892072bbfad7180a3954b198905f559b98858b710e6068574bc664786f351bfcb3bf24a  43-disable-netgroup.patch
43f0707078078d473c9cba9aa5a7a4e1f9b23387b3c6e544aca75c76285fbdebb62d0a57a9093dbd6d8329f5cc05b27634eb85025716a8722d8d76629dd1a1df  hosts.allow
b5fdad37ea2e14d4f481cf8eede95db3e8052974d535d2db93c231913d0b95e6e66e0866edd5414a22d5b036545fef4b9dce2e9f4aa49538456847b2647eec39  hosts.deny"
