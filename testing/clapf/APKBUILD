# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer:
pkgname=clapf
pkgver=0.4.7.4
pkgrel=4
pkgdesc="clapf is an open source email content filter application"
url="http://clapf.org"
arch="all"
license="AS-IS"
depends="clamav-db"
depends_dev="gsl-dev mysql-dev clamav-dev zlib-dev bzip2-dev"
makedepends="$depends_dev autoconf automake"
install="$pkgname.pre-install"
options="suid"
CLAPF_USER="clapf"
CLAPF_GROUP="clapf"
pkgusers="$CLAPF_USER"
pkggroups="$CLAPF_GROUP"
subpackages="$pkgname-dev"
# * 31d2ce87967e released 0.4.7.4
COMMIT=31d2ce87967e
source="$pkgname-$pkgver-g$COMMIT.tar.gz::https://bitbucket.org/jsuto/$pkgname/get/$COMMIT.tar.gz
	gsl-libs.patch
	def__user.patch
	ldflags.patch
	clapf.confd
	clapf.initd"

builddir="$srcdir/jsuto-$pkgname-$COMMIT"

prepare() {
	default_prepare
	aclocal && autoconf
}

build() {
	cd "$builddir"
	./configure --prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var \
		--enable-libclamav \
		--with-tokendb=mysql \
		--enable-lmtp \
		--with-store=fs \
		--enable-blackhole \
		--enable-rbl \
		--enable-policy \
		--enable-whitelist \
		--enable-blackhole \
		--with-clapf-user=$CLAPF_USER \
		--enable-language-detection \
		--enable-memcached \
		--enable-spamsum

	make
}

package() {
	cd "$builddir"
	make -j1 DESTDIR="$pkgdir" install
	install -D -m 755 \
	        "$srcdir"/clapf.initd \
	        "$pkgdir"/etc/init.d/clapf
	install -D -m 644 \
	        "$srcdir"/clapf.confd \
	        "$pkgdir"/etc/conf.d/clapf
	install -d -o $CLAPF_USER -g $CLAPF_GROUP \
	        "$pkgdir"/var/run/$pkgname
	mkdir -p \
	      "$pkgdir"/var/spool/clapf/tmp
	chown -R $CLAPF_USER:$CLAPF_GROUP \
	      "$pkgdir"/var/lib/clapf \
	      "$pkgdir"/var/spool/clapf
}

sha512sums="f13428be93cd170e24c70e608d15ef7d6054fa1d57dc9dae4efc4b78c464a1ab3102d99114ddfa3fe011e0a6b6ae2076ee46d5d64561604d0b758fae947d22da  clapf-0.4.7.4-g31d2ce87967e.tar.gz
096ed4afe1b0fad569a172d6af952f1590d230dd38f6f0c4c0b1e7f29a1515fd887f1c099267aa926ce698864b75cb50626a9b7f49914549748d22ba7058a31d  gsl-libs.patch
18b8bf55f20e86e05958f2b4a8bdea8bedeb712bc91bb9a6a67faa2928b545707d3391671ab843415fe11703fef4683594571136cf9b2ec87aa41b0875d34588  def__user.patch
f391663c74ce55b33446bbca9cde61201147d8704f514a266ea1371a43231e34800a8dc6e9f3843849ac000aa49ec2cffc023795696b6127bb404df83493f10f  ldflags.patch
f9d931f59710ca5ffae2d08d95d12d090dbbd932f8aa0ebb15e925704563834249e475e7ae8e845fb0f57396cdc11492b54efa0f5c228222f04a0e0c0e92caa5  clapf.confd
c4dff1a3627f9de640dbe6c9a7c69f0e8357f9c63a3fb41f3c6c1e7ee6caec431be6f473002847f1fd2c6c41f7d2730ae134a5b04c9df77502b0905657f524e8  clapf.initd"
