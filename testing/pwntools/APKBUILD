# Maintainer: omni <omni+alpine@hack.org>
maintainer="omni <omni+alpine@hack.org>"
pkgname=pwntools
pkgver=4.15.0
pkgrel=0
pkgdesc="CTF framework and exploit development library"
url="https://github.com/Gallopsled/pwntools#readme"
arch="all !riscv64 !s390x" # limited by unicorn
license="MIT"
depends="python3 python3-dev
	py3-paramiko
	py3-mako
	py3-elftools
	py3-capstone
	py3-pyserial
	py3-requests
	py3-pygments
	py3-pysocks
	py3-dateutil
	py3-intervaltree
	py3-sortedcontainers
	py3-unicorn
	py3-rpyc
	py3-zstd
	ropgadget
	"
makedepends="py3-gpep517 py3-setuptools py3-wheel"
checkdepends="py3-coverage py3-pytest"
subpackages="$pkgname-doc $pkgname-pyc"
source="$pkgname-$pkgver.tar.gz::https://github.com/Gallopsled/pwntools/archive/refs/tags/$pkgver.tar.gz"
options="!check" # TODO: enable tests (?)

build() {
	gpep517 build-wheel --wheel-dir .dist --output-fd 3 3>&1 >&2

	# remove architecture specific binary files, these will otherwise end up in
	# the -doc subpackage that wants to be noarch
	cd examples/fmtstr && make clean
}

check() {
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer .dist/*.whl
	.testenv/bin/python3 -m pytest
}

package() {
	python3 -m installer -d "$pkgdir" .dist/*.whl

	install -dm0755 "$pkgdir"/usr/share/doc/
	mv "$pkgdir"/usr/pwntools-doc "$pkgdir"/usr/share/doc/"$pkgname"
	mv examples "$pkgdir"/usr/share/doc/"$pkgname"/
}

sha512sums="
ef7e41193fecbaf6f435ad6df6459895238fcf9670b87f8389f4bd15b0eded9999d8fe82d60ea84ec1bc6d15207434514f17b13891a0cc2e32710fc25fec5df5  pwntools-4.15.0.tar.gz
"
