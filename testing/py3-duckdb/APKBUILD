maintainer="Leon White <badfunkstripe@gmail.com>"
pkgname=py3-duckdb
_pkgname=duckdb-python
_duckdb_pkgname=duckdb
pkgver=1.4.4
pkgrel=0
_pkghash=6ddac802ff
pkgdesc="High-performance analytical database system (Python3 module)"
url="https://duckdb.org"
arch="x86_64 aarch64" # same as duckdb
license="MIT"
depends="python3"
makedepends="
	py3-build
	py3-gpep517
	py3-installer
	py3-pybind11-dev
	py3-scikit-build-core
	py3-setuptools_scm
	python3-dev
	samurai
"
checkdepends="
	py3-mypy
	py3-otp
	py3-pandas
	py3-pyarrow
	py3-pytest
	py3-pytest-reraise
	py3-requests
	py3-typing-extensions
"
subpackages="$pkgname-pyc"
source="
	$_pkgname-$pkgver.tar.gz::https://github.com/duckdb/duckdb-python/archive/refs/tags/v$pkgver.tar.gz
	$_duckdb_pkgname-$pkgver.tar.gz::https://github.com/duckdb/duckdb/archive/refs/tags/v$pkgver.tar.gz
	ninja-version.patch
	test_query_progress-increase-timeout.patch
	"
builddir="$srcdir/$_pkgname-$pkgver"

export OVERRIDE_GIT_DESCRIBE="v$pkgver"

prepare() {
	default_prepare

	# Make this look like a PyPI sdist build
	touch PKG-INFO
	echo "v$pkgver-0-g$_pkghash" > duckdb_packaging/duckdb_version.txt

	mv $srcdir/$_duckdb_pkgname-$pkgver/* $srcdir/$_pkgname-$pkgver/external/duckdb
}

build() {
	gpep517 build-wheel \
		--wheel-dir .dist \
		--output-fd 3 3>&1 >&2
}

check() {
	# tests/fast/adbc/*: No module named 'adbc_driver_manager' (missing aport)
	_skip_tests="
		--ignore=tests/fast/adbc/test_adbc.py \
		--ignore=tests/fast/adbc/test_statement_bind.py \
		--ignore=tests/fast/adbc/test_connection_get_info.py"
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer .dist/*.whl
	.testenv/bin/python3 -m pytest tests $_skip_tests
}

package() {
	python3 -m installer -d "$pkgdir" \
		.dist/*.whl
}

sha512sums="
c9fdacf2932c756e6aa16124dde288fe4a7ffcd005c3a366ed05e7d7fc1fe690ec16254ab7e338b0cee67f49be2b6281ecac9f1b0100738da7006d0f205715fa  duckdb-python-1.4.4.tar.gz
2287ff1af67808e495ca4da527bd54e9c9f2044ed1bb4749cdaeee7993a7b0edca73cccd476a607442a4bf313b43e2358bf6ca28035e2dbe52b16847f6e5b30a  duckdb-1.4.4.tar.gz
d6c80130603ea0b6c1d41d58ab72d39336755e45a4d5a5ea64c9d725dcbd4e4563e469aaedc8b4c140c65ed18a3b54c9ae33e1db2499dd7a5112ddcd194fc49f  ninja-version.patch
87b40206e078714e769945bac3c814b3292577fa372eaa4ef42c5e22e74b59ab5055cf1abcfa519293328176b51de722827791ef69f59ad9b3193272d4fe00d3  test_query_progress-increase-timeout.patch
"
