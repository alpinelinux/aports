maintainer="Leon White <badfunkstripe@gmail.com>"
pkgname=py3-duckdb
_pkgname=duckdb-python
_duckdb_pkgname=duckdb
pkgver=1.4.3
pkgrel=0
_pkghash=d1dc88f950
pkgdesc="High-performance analytical database system (Python3 module)"
url="https://duckdb.org"
arch="x86_64 aarch64" # same as duckdb
license="MIT"
depends="python3"
makedepends="
	py3-build
	py3-gpep517
	py3-installer
	py3-pybind11-dev
	py3-scikit-build-core
	py3-setuptools_scm
	python3-dev
	samurai
"
checkdepends="
	py3-mypy
	py3-otp
	py3-pandas
	py3-pyarrow
	py3-pytest
	py3-pytest-reraise
	py3-requests
	py3-typing-extensions
"
subpackages="$pkgname-pyc"
source="
	$_pkgname-$pkgver.tar.gz::https://github.com/duckdb/duckdb-python/archive/refs/tags/v$pkgver.tar.gz
	$_duckdb_pkgname-$pkgver.tar.gz::https://github.com/duckdb/duckdb/archive/refs/tags/v$pkgver.tar.gz
	ninja-version.patch
	"
builddir="$srcdir/$_pkgname-$pkgver"

export OVERRIDE_GIT_DESCRIBE="v$pkgver"

prepare() {
	default_prepare

	# Make this look like a PyPI sdist build
	touch PKG-INFO
	echo "v$pkgver-0-g$_pkghash" > duckdb_packaging/duckdb_version.txt

	mv $srcdir/$_duckdb_pkgname-$pkgver/* $srcdir/$_pkgname-$pkgver/external/duckdb
}

build() {
	gpep517 build-wheel \
		--wheel-dir .dist \
		--output-fd 3 3>&1 >&2
}

check() {
	# tests/fast/adbc/*: No module named 'adbc_driver_manager' (missing aport)
	_skip_tests="
		--ignore=tests/fast/adbc/test_adbc.py \
		--ignore=tests/fast/adbc/test_statement_bind.py \
		--ignore=tests/fast/adbc/test_connection_get_info.py"
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer .dist/*.whl
	.testenv/bin/python3 -m pytest tests $_skip_tests
}

package() {
	python3 -m installer -d "$pkgdir" \
		.dist/*.whl
}

sha512sums="
825629f918624c5dd5855bd1b0c0f3971e4172199d2798828c37068818909f57c654189784246026e61edef2284cad3ecc2b96d6072bdce5d3d9c1eb48af7603  duckdb-python-1.4.3.tar.gz
058218e4551867dc231cae682e835fb76b2d02b655f889753fde6745b9895b81a7161c7eb3104c9f9e8a7a33fed460fc0028d0b94a1e36834100aa597b97a877  duckdb-1.4.3.tar.gz
d6c80130603ea0b6c1d41d58ab72d39336755e45a4d5a5ea64c9d725dcbd4e4563e469aaedc8b4c140c65ed18a3b54c9ae33e1db2499dd7a5112ddcd194fc49f  ninja-version.patch
"
