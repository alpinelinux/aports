# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=qemu
pkgver=0.11.1
pkgrel=1
pkgdesc="QEMU is a generic machine emulator and virtualizer"
url="http://www.nongnu.org/qemu/"
license="GPL-2 LGPL-2"
makedepends="zlib-dev sdl-dev alsa-lib-dev gnutls-dev ncurses-dev"
depends=
install="qemu.pre-install"
source="http://savannah.nongnu.org/download/$pkgname/$pkgname-$pkgver.tar.gz
	kqemu.patch
	"

prepare() {
	cd "$srcdir"/$pkgname-$pkgver
	# avoid fdt till an updated release appears
	sed -i -e 's:fdt="yes":fdt="no":' configure
	# prevent docs to get automatically installed
	sed -i '/$(DESTDIR)$(docdir)/d' Makefile
	# Alter target makefiles to accept CFLAGS
	sed -i 's/^\(C\|OP_C\|HELPER_C\)FLAGS=/\1FLAGS+=/' \
		Makefile Makefile.target tests/Makefile
	sed -i 's/^VL_LDFLAGS=$/VL_LDFLAGS=-Wl,-z,execheap/' \
		Makefile.target
	patch -p1 -i ../kqemu.patch || return 1
}

build() {
	cd "$srcdir"/$pkgname-$pkgver
	./configure --prefix=/usr \
		--audio-drv-list=oss,alsa,sdl \
		--audio-card-list=ac97,sb16,es1370,adlib \
		--disable-darwin-user \
		--disable-bsd-user \
		--disable-nptl \
		--cc="$CC"

	make || return 1
}

package() {
	cd "$srcdir"/$pkgname-$pkgver
	make DESTDIR="$pkgdir" install || return 1
}

md5sums="193285b0bcf655a7f7577d05ffcb82b1  qemu-0.11.1.tar.gz
f63f7412f016d8ccddabfd02ea28e748  kqemu.patch"
