# Maintainer: Mitch Tishmack <mitch.tishmack@gmail.com>
pkgname=idris
pkgver=1.0
pkgrel=0
pkgdesc="A Language with Dependent Types"
url="http://www.idris-lang.org"
arch="x86_64 armhf"
license="BSD3"
depends="gmp-dev gcc"
makedepends="ghc cabal libffi-dev ncurses-dev zlib-dev"
subpackages="$pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/idris-lang/Idris-dev/archive/v$pkgver.tar.gz"
builddir="$srcdir/Idris-dev-$pkgver"

_home="$builddir/deps"
_tmp="$builddir/tmp"

prepare() {
	default_prepare

	cd "$builddir"
	mkdir -p "$_tmp" "$_home"
	(
		export HOME="$_home"
		export TMPDIR="$_tmp"
		cabal update
		cabal install libffi -v
		cabal install --dependencies-only -v
	)
}

build() {
	cd "$builddir"
	(
		export HOME="$_home"
		export TMPDIR="$_tmp"
		# Note, ordering of prefixes is important!
		cabal configure --prefix='/usr' \
			--docdir='$prefix/share/doc' \
			--datadir='$prefix/share' \
			--htmldir='$docdir/html' \
			--libdir='$prefix/lib' \
			--libsubdir="$pkgname" \
			--datasubdir="$pkgname" \
			--dynlibdir="$pkgname" \
			--disable-shared \
			--flags='GMP FFI standalone'
		cabal build
	)
}

# TODO: Run upstream tests and/or figure out how to set paths to be able
# to compile hello_world for check.
check() {
	cd "$builddir"

	./dist/build/idris/idris --version
}

package() {
	cd "$builddir"

	cabal copy --destdir="$pkgdir"

	cd "$pkgdir"

	# We don't need the haskell shared libraries or interface files.
	rm -r usr/lib/idris

	mkdir -p usr/share/doc/idris/ \
		usr/share/licenses/$pkgname/
	mv usr/share/idris/docs usr/share/doc/idris
	mv usr/share/doc/LICENSE usr/share/licenses/$pkgname/
}

sha512sums="a350004a8510f01d1cc8f965a9a4e2dab219f003980b98354ebb5ae42f73b32c90c98dce193943e9709d994cb92ad35814a46b79412a1afc85d42e1018c6ba10  idris-1.0.tar.gz"
