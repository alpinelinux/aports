# Contributor: Alexander Couzens <lynxis@fe80.eu>
# Maintainer: Alexander Couzens <lynxis@fe80.eu>
pkgname=py3-statemachine
_pyname=python-statemachine
pkgver=2.5.0
pkgrel=0
pkgdesc="A library for Finite State Machines"
url="https://github.com/fgmacedo/python-statemachine"
arch="noarch"
license="MIT"
makedepends="
	py3-gpep517
	py3-hatchling
	py3-hatch-vcs
	py3-installer
	py3-pydot
	py3-pytest-asyncio
	py3-pytest-benchmark
	py3-pytest-cov
	py3-pytest-mock
	graphviz
	"
checkdepends="py3-pytest"
# no tests in artifact on PyPI
subpackages="$pkgname-pyc"
source="$pkgname-$pkgver.tar.gz::https://github.com/fgmacedo/python-statemachine/archive/refs/tags/v$pkgver.tar.gz
	0001-Fix-conftest-with-pytest-9.0.patch"
builddir="$srcdir/$_pyname-$pkgver"

build() {
	gpep517 build-wheel \
		--wheel-dir .dist \
		--output-fd 3 3>&1 >&2
}

check() {
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer .dist/*.whl
	.testenv/bin/python3 -m pytest \
		-k "not test_should_call_write_svg" \
		--ignore "tests/django_project"
	# test_should_call_write_svg: must be run from the srcdir
	# django is a huge dependency for the tests
}

package() {
	python3 -m installer -d "$pkgdir" .dist/*.whl
}

sha512sums="
79331758fe305525fd7f97e3e1a9eecc22f79e96047080a31ad8df8d033b506d39c79fa5fe9e20cc2cb63db271517842ffcdab3f1fdb9785d135d3f65dffce6d  py3-statemachine-2.5.0.tar.gz
d026591743714ebed423b255473730c5cd3ad94d7dfa1575b324f3a054e4c552d8e9c44586465b0744d6733a5d996326f5574b24f6c0e635688f0fb0bd9d7fbd  0001-Fix-conftest-with-pytest-9.0.patch
"
