# Maintainer: G.J.R. Timmer <gjr.timmer@gmail.com>
pkgname=postgresql-xl
_pkgname=${pkgname/ql/}
pkgver=9.5r1.4
pkgrel=0
pkgdesc="Scalable Open Source PostgreSQL-based Database Cluster"
url="http://www.postgres-xl.org/"
arch="all"
license="BSD"
# Depends are deliberate, reason: avoid conflict with normal PostgreSQL
depends="postgresql-xl-client postgresql-xl-libpq"
install=""
pkgusers="postgres"
pkggroups="postgres"
depends_dev="libressl-dev"
makedepends="$depends_dev libedit-dev zlib-dev libxml2-dev util-linux-dev
	openldap-dev bison flex perl readline-dev vim bash tcl-dev perl-dev 
	python2-dev python3-dev"
subpackages="$pkgname-contrib $pkgname-dev $pkgname-doc $pkgname-libpq $pkgname-libs
	$pkgname-gtm
	$pkgname-client $pkgname-pltcl
	$pkgname-plperl $pkgname-plperl-contrib:plperl_contrib
	$pkgname-plpython2 $pkgname-plpython2-contrib:plpython2_contrib
	$pkgname-plpython3 $pkgname-plpython3-contrib:plpython3_contrib"
patches="initdb.patch perl-rpath.patch"
source="http://files.postgres-xl.org/${_pkgname}-${pkgver}.tar.gz
	$patches
	pltcl_create_table_template.psql"
builddir="$srcdir/${_pkgname}-${pkgver}"

prepare() {
	default_prepare || return 1
	cp -al "$builddir" "$builddir"~py3
}

# NOTE: plpython requires separate configure/build runs to build against
# python 2 versus python 3. Note that the installed Makefile.global will
# reflect the python 2 build, which seems appropriate since that's still
# considered the default plpython version.
build() {
	msg "Building plpython3"

	cd "$builddir"~py3
	export PYTHON=/usr/bin/python3
	
	_configure || return 1
	make -C src/backend submake-errcodes || return 1
	make -C src/pl/plpython all || return 1
	
	msg "Building all"

	cd "$builddir"
	export PYTHON=/usr/bin/python2

	_configure && make world || return 1

	unset PYTHON
}

_configure() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--mandir=/usr/share/man \
		--with-ldap \
		--with-libedit-preferred \
		--with-libxml \
		--with-openssl \
		--with-uuid=e2fs \
		--disable-rpath \
		--with-perl \
		--with-python \
		--with-tcl
}


package() {
	cd "$builddir"

	make DESTDIR="$pkgdir" install install-docs || return 1

	install -d -m755 -o postgres -g postgres \
		"$pkgdir"/var/lib/postgresql || return 1
}

dev() {
	default_dev || return 1

	mkdir -p "$subpkgdir"/usr/bin "$subpkgdir"/usr/lib/postgresql
	mv "$pkgdir"/usr/bin/pg_config \
		"$pkgdir"/usr/bin/ecpg \
		"$subpkgdir"/usr/bin/ || return 1
	mv "$pkgdir"/usr/lib/postgresql/pgxs \
		"$subpkgdir"/usr/lib/postgresql/ || return 1
}

libpq() {
	pkgdesc="PostgreSQL libraries"
	depends=""

	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libpq.so.* "$subpkgdir"/usr/lib/
}

libs() {
	depends=""
	default_libs
}

client() {
	pkgdesc="PostgreSQL client"

	# Avoid conflict with PostgreSQL
	depends="postgresql-xl-libpq"

	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/psql "$subpkgdir"/usr/bin/
}

contrib() {
	# Hardcoded dependency; bash is required for contrib, but not autodetected
	# because of the contrib scripts
	depends="bash"
	pkgdesc="Extension modules distributed with PostgreSQL-XL"

	cd "$builddir"

	# Avoid installing plperl and plpython extensions, these will be
	# installed into separate subpackages.
	sed -Ei -e 's/(.*_plperl)/#\1/' \
		-e 's/(.*_plpython)/#\1/' \
		contrib/Makefile || return 1

	make -C contrib DESTDIR="$subpkgdir" install || return 1

	mv "$subpkgdir"/usr/share/doc/postgresql/extension \
		"$pkgdir"/usr/share/doc/postgresql/ || return 1
	rmdir -p "$subpkgdir"/usr/share/doc/postgresql || true
}

gtm() {
	depends=""
	pkgname="Global Transaction Manager for PostgreSQL-XL"

	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/gtm* "$subpkgdir"/usr/bin/
	mv "$pkgdir"/usr/bin/initgtm "$subpkgdir"/usr/bin

	mkdir -p "$subpkgdir"/usr/share/postgresql
	mv "$pkgdir"/usr/share/postgresql/gtm* "$subpkgdir"/usr/share/postgresql/
}

pltcl() {
	pkgdesc="PL/Tcl procedural language for PostgreSQL"
	depends="pgtcl"

	cd "$pkgdir"
	_submv usr/bin/pltcl* \
		usr/lib/postgresql/pltcl.so \
		usr/share/postgresql/unknown.pltcl \
		usr/share/postgresql/extension/pltcl*

	install -D -m644 "$srcdir"/pltcl_create_table_template.psql \
		"$subpkgdir"/usr/share/postgresql || return 1
}

plperl() {
	pkgdesc="PL/Perl procedural language for PostgreSQL"
	depends=""

	cd "$pkgdir"
	_submv usr/lib/postgresql/plperl.so \
		usr/share/postgresql/extension/plperl*
}

plperl_contrib() {
	_plcontrib plperl "PL/Perl"

	cd "$builddir"
	make -C contrib/hstore_plperl DESTDIR="$subpkgdir" install
}

plpython2() {
	pkgdesc="PL/Python2 procedural language for PostgreSQL"
	depends=""

	cd "$pkgdir"
	_submv usr/lib/postgresql/plpython2.so \
		usr/share/postgresql/extension/plpython*
}

plpython2_contrib() {
	_plcontrib plpython2 "PL/Python 2"

	cd "$builddir"
	make -C contrib/hstore_plpython DESTDIR="$subpkgdir" install || return 1
	make -C contrib/ltree_plpython DESTDIR="$subpkgdir" install || return 1

	rm "$subpkgdir"/usr/share/postgresql/extension/*plpython3*
}

plpython3() {
	pkgdesc="PL/Python3 procedural language for PostgreSQL"
	depends=""

	cd "$builddir"~py3
	make -C src/pl/plpython DESTDIR="$subpkgdir" install || return 1
	rm -R "$subpkgdir"/usr/include
}

plpython3_contrib() {
	_plcontrib plpython3 "PL/Python 3"

	cd "$builddir"~py3
	make -C contrib/hstore_plpython DESTDIR="$subpkgdir" install || return 1
	make -C contrib/ltree_plpython DESTDIR="$subpkgdir" install || return 1

	cd "$subpkgdir"/usr/share/postgresql/extension/
	rm *plpython2* *plpythonu*
}

_plcontrib() {
	local subname="$1"
	pkgdesc="$2 extension modules distributed with PostgreSQL"
	depends="$pkgname-$subname"
	install_if="$pkgname-$subname=$pkgver-r$pkgrel $pkgname-contrib=$pkgver-r$pkgrel"
}

_submv() {
	local path; for path in "$@"; do
		mkdir -p "$subpkgdir/${path%/*}"
		mv "$path" "$subpkgdir/$path" || return 1
	done
}

md5sums="9a197fc9694f10f3bdb632d923c2dda0  postgres-xl-9.5r1.4.tar.gz
179e830d0abcc13d738204de7434002d  initdb.patch
643a56ee96d8de682ada8aba52a9fb53  perl-rpath.patch
76a69c57150e3e4d2c0e78f7c5d73d0c  pltcl_create_table_template.psql"
sha256sums="00d3dcc516894b8c137b3d2a7ea503db89563a4b33a905b85b827095fb3b1cde  postgres-xl-9.5r1.4.tar.gz
81341204dd994b32ef9043ba5a0d216311fe30fc556967e16975e3d7c79692b2  initdb.patch
83e79ccc98b12d68a9620ae528d6ac37012841a7c120477e05e327fb52eadb38  perl-rpath.patch
7273ec29e5b8a174c13070e1034f25e1f541ed928e337da1ed2dbbbcc0208ce0  pltcl_create_table_template.psql"
sha512sums="1c26ae6d31bc3488ebdabbe3e47db25d0a5a5e4ca96f0d0366fafd763079266ca6f4bec7d0d3fcc01c362f9a78754cc313d9317c0906673e0ddd254c6a0fd52b  postgres-xl-9.5r1.4.tar.gz
6152aa10447c649742da4401631e545b160410fdf19e88d80139650860ca56ae3955ec26d96432fc320a571d141b24966b87fc212f0f77a71845ad2c68b2677a  initdb.patch
5f9d8bb4957194069d01af8ab3abc6d4d83a7e7f8bd7ebe1caae5361d621a3e58f91b14b952958138a794e0a80bc154fbb7e3e78d211e2a95b9b7901335de854  perl-rpath.patch
b4a2c5873efd73e35799981dc95734598cd28db4b4d06f10e2e2861bd5fcc5a899e7bd77ccec0b65ee0df21e7cb6c14b7a2a2ef455738452c432a460b2f67f80  pltcl_create_table_template.psql"
