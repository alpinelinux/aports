# Contributor: Pietro Zambelli <peter.zamb@gmail.com>
# Maintainer: Pietro Zambelli <peter.zamb@gmail.com>
pkgname=grass
pkgver=7.8.0
_pkgver="`echo ${pkgver::-2} | tr -d .`"
pkgrel=0
pkgdesc="GRASS GIS is a suite used for geospatial analysis, image processing and spatial modeling."
url="https://grass.osgeo.org/"
arch="all"
license="GPL-2.0-or-later"
depends="
	attr
	bash
	bison
	bzip2
	cairo
	fftw
	flex
	freetype
	gdal
	gettext
	geos
	gnutls
	libbz2
	libjpeg-turbo
	libpng
	musl
	musl-utils
	ncurses
	openjpeg
	openblas
	py3-numpy
	py3-pillow
	py3-six
	postgresql
	proj
	sqlite
	sqlite-libs
	tiff
	wxgtk-base
	wxgtk
	zstd
	zstd-libs
	"
makedepends="
	build-base
	bzip2-dev
	cairo-dev
	fftw-dev
	freetype-dev
	gcc
	gdal-dev
	geos-dev
	gnutls-dev
	libc6-compat
	libjpeg-turbo-dev
	libpng-dev
	make
	openjpeg-dev
	openblas-dev
	patchutils
	postgresql-dev
	python3-dev
	py3-numpy-dev
	proj-dev
	sqlite-dev
	tar
	tiff-dev
	unzip
	wxgtk-base-dev
	wxgtk-dev
	zip
	zstd-dev
	"
subpackages="
	$pkgname-dev:dev
	$pkgname-doc:doc
	$pkgname-gui:gui:noarch
	$pkgname-fonts:fonts:noarch
	$pkgname-demolocation:demo:noarch
	"
source="
	$pkgname-$pkgver.tar.gz::https://grass.osgeo.org/grass${_pkgver}/source/$pkgname-$pkgver.tar.gz
	fix-make-install.patch
	"

build() {
	./configure --prefix=/usr \
		--enable-largefile \
		--with-cxx \
		--with-proj --with-proj-share=/usr/share/proj \
		--with-gdal \
		--with-python=/usr/bin/python3 \
		--with-geos \
		--with-sqlite \
		--with-bzlib \
		--with-zstd \
		--with-cairo --with-cairo-ldflags='-lfontconfig' \
		--with-fftw \
		--with-wxwidgets \
		--with-postgres --with-postgres-includes='/usr/include/postgresql' \
		--without-freetype \
		--without-openmp \
		--without-opengl \
		--without-nls \
		--without-mysql \
		--without-odbc \
		--without-openmp \
		--without-ffmpeg
	make
}

package() {
	make DESTDIR="$pkgdir" install

	grassbin="${pkgname}${_pkgver}"

	rm -R "$pkgdir"/usr/$grassbin/include/Make
	chmod -x -R "$pkgdir"/usr/$grassbin/include/

	ln -s "$pkgdir"/"grass/usr/bin/$grassbin" "$pkgdir"/usr/bin/grass
}

dev() {
	pkgdesc="$pkgname (C headers)"

	install -d "$subpkgdir"/usr/include
}

doc() {
	pkgdesc="$pkgname (Documentation)"

	install -d "$subpkgdir"/doc
}

gui() {
	pkgdesc="$pkgname (Graphical User Interface)"

	install -d "$subpkgdir"/gui
}

fonts() {
	pkgdesc="$pkgname (Fonts)"

	install -d "$subpkgdir"/fonts
}

demo() {
	pkgdesc="$pkgname (Demo location)"

	install -d "$subpkgdir"/demolocation
}

check() {
	# grass --version | grep "$pkgver"
	# grass --config version | grep "$pkgver."
	echo "Check DONE!"
}

sha512sums="2add6a2f5af2931419a9103b46769c11a727ef4ce10f2977171b80bab038371fb5157294d045ccb57ce4d232a47c15b305912486fd3f7ab4a12eded224c06800  grass-7.8.0.tar.gz
b0d7fa2b59f2c7fb3986185f96656f821c7c0b4d8c7fe19329d9b29480c00e8c27f297f1b0d6cdece4c71dec9d3ff6b4e6ac8a5f9ec350de7a32e85500a461b1  fix-make-install.patch"
