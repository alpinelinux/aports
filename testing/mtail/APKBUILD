# Contributor: Guy Godfroy <guy.godfroy@gugod.fr>
# Maintainer: Guy Godfroy <guy.godfroy@gugod.fr>
pkgname=mtail
pkgver=3.2.26
pkgrel=1
pkgdesc="Extract internal monitoring data from application logs for collection in a timeseries database"
url="https://google.github.io/mtail/"
arch="all"
license="Apache-2.0"
depends="tzdata"
makedepends="go go-tools"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc"
options="net" # go deps
source="$pkgname-$pkgver.tar.gz::https://github.com/jaqx0r/mtail/archive/refs/tags/v$pkgver.tar.gz
	mtail.initd
	mtail.confd
	"

build() {
	go generate -x ./internal/runtime/compiler/parser
	local ldflags="-X main.Branch=main -X main.Version=$pkgver"
	go build -v -ldflags "$ldflags" -o . ./...
}

check() {
	go test ./... -skip="TestExecMtail" # Didn't manage to make the bazel thing to work
}

package() {
	install -m755 -D mdot "$pkgdir"/usr/bin/mdot
	install -m755 -D mfmt "$pkgdir"/usr/bin/mfmt
	install -m755 -D mgen "$pkgdir"/usr/bin/mgen
	install -m755 -D mtail "$pkgdir"/usr/bin/mtail
	install -m755 -d "$pkgdir"/usr/share/mtail/example
	install -m644 examples/*.mtail "$pkgdir"/usr/share/mtail/example
	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname
}

sha512sums="
81173bfa634cfe3b765c5c38c69e14a12228785cb7f50b994ed41974fdb0e31017c33c46ef542d90e4285373fff8c37e1ac6031afd12963ed98ce31027957f43  mtail-3.2.26.tar.gz
4d63ee6d26de5b38a3bd5649652c15145cd0c2b5810649d6f250b59794a22f263f11923dbc23561b11048f9c0d0cbfb7dace6b52778605af4414bacf91372fcf  mtail.initd
c2e9c0e50b9e32b3c3305e05b68789a5cc6263ccd7072af613ee81c5992a31655b8dffccb6fb01051b42651cfd5c7c4bb4d2720d41e3a35a566d1e25ec448c29  mtail.confd
"
