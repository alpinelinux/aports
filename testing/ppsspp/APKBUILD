# Contributor: Díaz Urbaneja Diego <sodomon2@gmail.com>
# Maintainer: Díaz Urbaneja Diego <sodomon2@gmail.com>
pkgname=ppsspp
pkgver=1.8.0
pkgrel=0
pkgdesc="PPSSPP - a fast and portable PSP emulator"
url="https://www.ppsspp.org/"
arch="x86_64"
license="GPL-2.0-only"
depends="cmake make"
makedepends="glew-dev libzip-dev snappy-dev mesa-dev qt5-qtbase-dev zlib-dev sdl2-dev"
options="!check" # make check not implemented
source="$pkgname-$pkgver.tar.gz::https://github.com/hrydgard/$pkgname/archive/v$pkgver.tar.gz
  $pkgname-$pkgver-armips.zip::https://github.com/Kingcom/armips/archive/7885552b208493a6a0f21663770c446c3ba65576.zip
  $pkgname-$pkgver-discord-rpc.zip::https://github.com/discordapp/discord-rpc/archive/3d3ae7129d17643bc706da0a2eea85aafd10ab3a.zip
  $pkgname-$pkgver-glslang.zip::https://github.com/hrydgard/glslang/archive/f9d08a25fbe17e0677a89d398f4d7f232339c3f9.zip
  $pkgname-$pkgver-SPIRV-Cross.zip::https://github.com/KhronosGroup/SPIRV-Cross/archive/be7425ef70231ab82930331959ab487d605d0482.zip
  $pkgname-$pkgver-rapidjson.zip::https://github.com/Tencent/rapidjson/archive/73063f5002612c6bf64fe24f851cd5cc0d83eef9.zip
  $pkgname-$pkgver-lang.zip::https://github.com/hrydgard/$pkgname-lang/archive/03707d64bffc594d5707780a34ada77e8f43cdc0.zip
  $pkgname-$pkgver-ffmpeg.zip::https://github.com/hrydgard/$pkgname-ffmpeg/archive/7472c903ec771c00af9925097e8d37075e9a379f.zip
  ppsspp.desktop
  ppsspp
  ppsspp-version.patch
  ppsspp-headless"

prepare(){
  default_prepare
  #adding submodules needed by ppsspp
  
  mv "$srcdir/"armips-7885552b208493a6a0f21663770c446c3ba65576/* "$builddir"/ext/armips/
  mv "$srcdir/"discord-rpc-3d3ae7129d17643bc706da0a2eea85aafd10ab3a/* "$builddir"/ext/discord-rpc/
  mv "$srcdir/"glslang-f9d08a25fbe17e0677a89d398f4d7f232339c3f9/* "$builddir"/ext/glslang/
  mv "$srcdir/"rapidjson-73063f5002612c6bf64fe24f851cd5cc0d83eef9/* "$builddir"/ext/rapidjson/
  mv "$srcdir/"SPIRV-Cross-be7425ef70231ab82930331959ab487d605d0482/* "$builddir"/ext/SPIRV-Cross/
  mv "$srcdir/"$pkgname-lang-03707d64bffc594d5707780a34ada77e8f43cdc0/* "$builddir"/assets/lang/
  mv "$srcdir/"$pkgname-ffmpeg-master/* "$builddir"/ffmpeg
  cd "$builddir"/ffmpeg
  ./linux_x86-64.sh
}

build() {
  mkdir build-qt
  cd build-qt
  cmake .. \
  -DUSING_QT_UI=ON \
  -DHEADLESS=ON \
    
  make
}

package() {
  mkdir -p "$pkgdir"/usr/bin
    mv $srcdir/ppsspp "$pkgdir"/usr/bin/ppsspp
    mv $srcdir/ppsspp-headless "$pkgdir"/usr/bin/ppsspp-headless
    chmod 777 $pkgdir/usr/bin/ppsspp
    chmod 777 $pkgdir/usr/bin/ppsspp-headless

  mkdir -p "$pkgdir"/usr/share/ppsspp
    mv build-qt/assets "$pkgdir"/usr/share/ppsspp
    cp -Rp build-qt/PPSSPPQt "$pkgdir"/usr/share/ppsspp
    cp -Rp build-qt/PPSSPPHeadless "$pkgdir"/usr/share/ppsspp
  
  mkdir -p "$pkgdir"/usr/share/applications
    install -m 644 $srcdir/ppsspp.desktop "$pkgdir"/usr/share/applications/ppsspp.desktop
  
  mkdir -p "$pkgdir"/usr/share/pixmaps
    install -m 644 icons/icon-512.svg "$pkgdir"/usr/share/pixmaps/ppsspp.svg
}

sha512sums="c49cd9978e115ae0d76c34d125cfd8fe65556aa25f3dabcc0d9f8891d0853fe72e69b20f8540cf2d7be8dbfef9d1baa213147ed965e3e1bc37f230a3919a5384  ppsspp-1.8.0.tar.gz
2d29a110bd2b556ce6f65db561a4bc140fb0efb3eb9048a3b4ae872a2882a720a10657657767c2e2fb514ac1475e45a1f3eda937da497ab6a11ebaa3acbe2408  ppsspp-1.8.0-armips.zip
65997487350942d4c0d3663d1fac729c2a7b8c9eb8c6efb7e736250596be69b2a6c5ead55517b05371548f015828d02578f0cae14a978159128259a26644b6fc  ppsspp-1.8.0-discord-rpc.zip
52684dcce29b66dd07622898f356fc70ed163f9b4e7e7b073fa312a84c9345f2cbc2ace8cd7e18db1f7f165a9454326870c53ce890dc46c595a1e4e1434af5bb  ppsspp-1.8.0-glslang.zip
0c5059b3fd16d67bd30f881dc0a901a238c45f8a689f2a03e578eacd85ff69a514d493c2ca2646173210630742f69ccb16e9506a541daa0916df5aad3317effa  ppsspp-1.8.0-SPIRV-Cross.zip
052c48dbb98e1498c3f35bcf2f4fd87a11529636c38d68223e8ae004b46591b40f1c777e37331700d5e2e413e279c6720a5f2ad39bc19fd6ac94ede35c490b2d  ppsspp-1.8.0-rapidjson.zip
e84fa40b564e320d1a9ae43326008202e9fda1b06ae0690f395061d8ced99bcac90d1e182ab1edf1aaa04fa3c3b1f2e2d4b217d01855e404f8d515a8d7f1663f  ppsspp-1.8.0-lang.zip
d626573c592c7fde90296f425e12d63543934f646d124152fd4aa2e871f84084d77dadabbd82a16ed76e1f5fc980ea08aabb96f71b8a387756fe49b34ed8c557  ppsspp-1.8.0-ffmpeg.zip
fb8c6c4a48003dac866b094f4d9d750bf7d1def14c9d3bf7a70f584ba187dacd5e57b29313e302740f5a0ec4bf27b6fea3d5cf27ae12bf6fac06f5a8ab23195b  ppsspp.desktop
13452b26b2ebb31f15340394425fa3e6abba56f72007becd7e8b9cfbbced1ad38767e3b0d8210559b4890ec8e111a015230746632bc431e7c7d95b5093b34067  ppsspp
5ae0fcd8f96d1c4d4396e830367a3e2de49dfe8bd5b3da075759e2d835cb4d951e4f150782f45e57e1a0937aa834765da910e331145faf6dfc8da864c019f20a  ppsspp-version.patch
1034c7ebaf827c693bc44220e5af5bebfa253c852595130dff34d389ea16740bcfc8e375140fd795130d8d72789f9539db89b230f37941e8e0570889dcc07752  ppsspp-headless"
