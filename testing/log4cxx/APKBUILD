# Contributor: Russ Webber <russ@rw.id.au>
# Maintainer: Russ Webber <russ@rw.id.au>
pkgname=log4cxx
pkgver=1.5.0
pkgrel=0
pkgdesc="C++ port of the Log4j logging framework"
url="http://logging.apache.org/log4cxx"
license="Apache-2.0"
options="!check"  # testsuite in 1.1.0 does not work on alpine
subpackages="$pkgname-dev"
arch="all"
makedepends="cmake zip libxml2-dev apr-util-dev samurai"
source="https://archive.apache.org/dist/logging/log4cxx/$pkgver/apache-log4cxx-$pkgver.tar.gz"
builddir="$srcdir/apache-$pkgname-$pkgver"

# secfixes:
#   1.1.0-r0:
#     - CVE-2023-31038

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		CMAKE_CROSSOPTS="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi

	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DBUILD_SHARED_LIBS=ON \
		-DCMAKE_INSTALL_SYSCONFDIR=/etc \
		$CMAKE_CROSSOPTS
	cmake --build build
}

check() {
	ctest --test-dir build -E sizebasedrollingtest
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
60cedb41511cca6646682d0041a4dfac1d9e50f29fac7c7d31ef2f6c5c200dba84c010c79aed8a5f453795408a8905669d1a6b2002af6728d5734808369af075  apache-log4cxx-1.5.0.tar.gz
"
