# Contributor: Maxim Karasev <mxkrsv@disroot.org>
# Maintainer: Patrycja Rosa <alpine@ptrcnull.me>
pkgname=r2ghidra
pkgver=6.0.8
_ghidra_native=0.6.4 # see subprojects/ghidra-native.wrap
pkgrel=0
pkgdesc="native ghidra decompiler for radare2"
url="https://github.com/radareorg/r2ghidra"
# this is massive, and nobody is going to use a decompiler on other
# architectures
arch="x86_64 aarch64 ppc64le"
license="LGPL-3.0-only AND Apache-2.0"
depends="radare2"
makedepends="
	libzip-dev
	meson
	openssl-dev
	pugixml-dev
	radare2-dev
	"
source="https://github.com/radareorg/r2ghidra/archive/refs/tags/$pkgver/r2ghidra-$pkgver.tar.gz
	https://github.com/radareorg/ghidra-native/archive/refs/tags/$_ghidra_native/ghidra-native-$_ghidra_native.tar.gz
	use-system-pugixml.patch"
options="!check" # no tests

prepare() {
	default_prepare

	mv "$srcdir"/ghidra-native-"$_ghidra_native" \
		"$builddir"/subprojects/ghidra-native
	make -C "$builddir"/subprojects/ghidra-native patch
	cp "$builddir"/subprojects/packagefiles/ghidra-native/meson.build \
		"$builddir"/subprojects/ghidra-native/
}

build() {
	abuild-meson \
		-Db_lto=true \
		. output
	meson compile -C output

	# not implemented for meson yet
	cd ghidra
	make sleigh-build
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output

	# not implemented for meson yet
	cd "$builddir"/ghidra
	make D="$pkgdir"/usr/lib/radare2/$pkgver/r2ghidra_sleigh sleigh-install
}

sha512sums="
d3e98da6f79fb2a3f96335fada480b0480f34772df1cf04b946c5b33371837d15f42747e6d6f8398af5693c785e823d4e5d897c2e497d35c589ba64ebbbfe60d  r2ghidra-6.0.8.tar.gz
6570b30f1c9ed9c1697bbb4018686ec59ff8c816dae03fdb3e2bdcebdb28e33445e69b57abfd4475df26c63bcd0b29eaad7036b4adcb37ec4885577d9844889e  ghidra-native-0.6.4.tar.gz
755957db70ac6629c3792606028d93f4edc3e36c0ffb4b567b107d95ef24f560ab563ad036bf55f53c3034034b705c50d4c4ebc14b41c3ad2b0199cc1d692677  use-system-pugixml.patch
"
