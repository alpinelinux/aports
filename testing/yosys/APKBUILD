# Contributor: Dominika Liberda <ja@sdomi.pl>
# Maintainer: Dominika Liberda <ja@sdomi.pl>
pkgname=yosys
pkgver=0.62
pkgrel=0
pkgdesc="Yosys Open SYnthesis Suite"
url="https://yosyshq.net"
# s390x: https://github.com/YosysHQ/yosys/issues/2645
arch="all !s390x"
license="ISC"
depends="
	abc
	"
makedepends="
	bash
	bison
	boost-dev
	flex-dev
	gawk
	graphviz-dev
	libffi-dev
	lld
	protobuf-dev
	py3-cxxheaderparser
	py3-pybind11-dev
	python3
	readline-dev
	tcl-dev
	zlib-dev
	"
checkdepends="
	gtkwave
	iverilog
	"
subpackages="$pkgname-dev py3-$pkgname:py3:noarch"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/YosysHQ/yosys/releases/download/v$pkgver/yosys.tar.gz
	fix-32-bit-oom.patch
	skip-xaiger2-5169-test.patch
	"
builddir="$srcdir"

prepare() {
	default_prepare

	local pyver="$(python3 -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')"

	cat > Makefile.conf <<- EOF
	CONFIG:=gcc
	PREFIX:=/usr
	ABCEXTERNAL:=/usr/bin/abc
	BOOST_PYTHON_LIB:=-lpython$pyver -lboost_python${pyver/./}
	ENABLE_ABC:=1
	ENABLE_LIBYOSYS:=1
	ENABLE_NDEBUG:=1
	ENABLE_PROTOBUF:=1
	ENABLE_PYOSYS:=1
	PYOSYS_USE_UV:=0
	EOF
}

build() {
	# Not using LTO, as test segfault with LTO enabled. Not unique to Alpine:
	# https://gitlab.archlinux.org/archlinux/packaging/packages/yosys/-/blob/main/PKGBUILD?ref_type=heads#L20
	make CXX=g++
}

check() {
	make CXX=g++ test
}

package() {
	make CXX=g++ DESTDIR="$pkgdir" install

	# link python to the global yosys
	ln -sfv /usr/lib/yosys/libyosys.so "$pkgdir"/usr/lib/python3*/site-packages/pyosys/libyosys.so
}

py3() {
	pkgdesc="$pkgdesc (python module)"
	depends="python3 $pkgname=$pkgver-r$pkgrel"

	amove usr/lib/python3*
}

sha512sums="
8fd53947ac79f770445d3eed500095d496b0eccdd8ba9a5275dc67a15767bfbb6a2c4b6be8fa8b0110af57f1c485033aeecc6d8a5a29a65b6722417cab85eda5  yosys-0.62.tar.gz
b2f222d52dec65a2817b46c9b38732a8909530347d5912b7dd53c8fe3b8fd2120621342d88a6552372b7269c5a74f6506141e70584223a266cb1438ee343228b  fix-32-bit-oom.patch
f82c23e97c5eff8fe094b67e6052b7a36f38088c7ec7f80b22c2055c33ce755caaa9712d8001de56290960485238fba595ae9c80af1723745067a14cd83caaca  skip-xaiger2-5169-test.patch
"
