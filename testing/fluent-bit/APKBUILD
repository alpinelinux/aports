# Contributor: Stuart Cardall <developer@it-offshore.co.uk>
# Maintainer: Stuart Cardall <developer@it-offshore.co.uk>
pkgname=fluent-bit
pkgver=0.13.2
pkgrel=0
pkgdesc="Fast and Lightweight Log/Data Forwarder [fluent-bit]"
url="http://fluentbit.io"
arch="all !aarch64 !s390x"
license="Apache-2.0"
options="!check" # tests require systemd:  https://github.com/fluent/fluent-bit/issues/552
checkdepends="gtest-dev valgrind-dev perl-dev"
makedepends="cmake linux-headers zlib-dev mbedtls-dev"
subpackages="$pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/fluent/$pkgname/archive/v$pkgver.tar.gz
	$pkgname.confd
	$pkgname.initd
	disable-jemalloc.patch
	"
builddir="$srcdir/"$pkgname-$pkgver

build() {
	cd "$builddir"/build
	cmake \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_SYSCONFDIR=/etc \
		-DCMAKE_INSTALL_LIBDIR:PATH=lib \
		-DFLB_ALL=ON \
		-DFLB_TD=ON ..
	make
}

check() {
	cd "$builddir"/build
	cmake -DFLB_TESTS_RUNTIME=ON -DFLB_TESTS_INTERNAL=ON ..
	make
	make test
}

package() {
	cd "$builddir"/build
	make DESTDIR="$pkgdir" install

	install -m644 -D ../README.md \
		"$pkgdir"/usr/share/doc/$pkgname/README.md
	install -m644 -D ../LICENSE \
		"$pkgdir"/usr/share/licenses/$pkgname/LICENSE

	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname
	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
}

sha512sums="787e1d8f1c50e39642f7b637938c5e5d4dd8400bd89c9ed929830bf19e4617baf0bd25503ab5be5711ea85c0030061872447203bbd20255bb87649615ab350e0  fluent-bit-0.13.2.tar.gz
6c1c67ac965fb9f54e362a7de8864afbffb9a22bffb5b5ca3a68f3950b9a27ccaee29d4bfb223035ccf5276e3fe09d0873685c58c47e055ad4bea57ccf80d90e  fluent-bit.confd
5103ab108bf0bafec2ca34db6e3a629977cd0a6ffb3f213b3885af5e2c08218ede4784d64310d6acdc7a09a9bc1e29330eaf692dbebdc6619de5a69cb1f80948  fluent-bit.initd
bf41aa1eef5ae0239acb2f54356d090d71611eb021de5b0d92be10079ef3bc5c7cc1dade1de98fd60354b883e53652a6f3f54a7a03acd00471e1f65d654aac32  disable-jemalloc.patch"
