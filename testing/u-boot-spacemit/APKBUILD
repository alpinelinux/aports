# Contributor: Milan P. Stanić <mps@arvanta.net>
# Maintainer: Milan P. Stanić <mps@arvanta.net>
pkgname=u-boot-spacemit
_basever=2022.10
_realver=2.2.9
pkgver=${_basever}.${_realver}
pkgrel=0
pkgdesc="u-boot bootloader for spacemit"
url="https://gitee.com/bianbu-linux/uboot-2022.10"
arch="riscv64"
license="GPL-2.0-or-later OFL-1.1 BSD-2-Clause BSD-3-Clause eCos-2.0 IBM-pibs
	ISC LGPL-2.0-only LGPL-2.1-only X11"
options="!check" # no tests

makedepends="
	bash
	bc
	bison
	coreutils
	dtc
	flex
	gnutls-dev
	linux-headers
	opensbi-spacemit
	openssl-dev
	py3-elftools
	py3-setuptools
	python3-dev
	swig
	util-linux-dev
	"
source="$pkgname-v$_realver.tar.gz::$url/repository/archive/k1-bl-v$_realver-release.tar.gz
	002-SpacemiT-K1X-Fixups.patch
	003-SpacemiT-K1X-Defconfig-Fixups.patch
	004-efi_loader-suppress-error-print-message.patch
	005-Orange-Pi-RV2-u-boot-support-for-XM25QU128C-flash.patch
	006-orangepi-rv2-r2s-fit.patch
	k1-x.env
	"
builddir=$srcdir/uboot-$_basever-k1-bl-v$_realver-release

prepare() {
	default_prepare
	cp -f $srcdir/k1-x.env board/spacemit/k1-x/k1-x.env
	make k1_defconfig
	scripts/config --file .config --disable PRINT_TIMESTAMP
	scripts/config --file .config --set-val BOOTDELAY 2
	scripts/config --file .config --disable AUTOBOOT_KEYED
	scripts/config --file .config --disable AUTOBOOT_USE_MENUKEY
	scripts/config --file .config --disable LOCALVERSION_AUTO
	scripts/config --file .config --disable AUTOBOOT_DELAY_STR
	scripts/config --file .config --disable AUTOBOOT_STOP_STR
	scripts/config --file .config --enable VIDEO_MIPI_DSI
	scripts/config --file .config --enable USE_PREBOOT
	scripts/config --file .config --set-str PREBOOT "usb start"
	scripts/config --file .config --set-str LOCALVERSION " $_realver"
}

build() {
	export OPENSBI="/usr/share/opensbi-spacemit/fw_dynamic.itb"
	make
}

package() {
	mkdir -p "$pkgdir"/usr/share/$pkgname
	install -m644 "$builddir"/u-boot.itb "$pkgdir"/usr/share/$pkgname/
	install -m644 "$builddir"/FSBL.bin "$pkgdir"/usr/share/$pkgname/
	install -m644 "$builddir"/u-boot-env-default.bin "$pkgdir"/usr/share/$pkgname/
	install -m644 "$builddir"/bootinfo_emmc.bin "$pkgdir"/usr/share/$pkgname/
	install -m644 "$builddir"/bootinfo_sd.bin "$pkgdir"/usr/share/$pkgname/
	install -m644 "$builddir"/bootinfo_spinand.bin "$pkgdir"/usr/share/$pkgname/
	install -m644 "$builddir"/bootinfo_spinor.bin "$pkgdir"/usr/share/$pkgname/
}

sha512sums="
4b1ee5ac4068601fa049bb07736c1a335185f6d9e3bfd205953fd23149c2690b4ee6541f3596e5a593caf46a31bb42dc95e95176a2918a3899c5f5d5c57c2beb  u-boot-spacemit-v2.2.9.tar.gz
0445f28db59821af8c076c323ea675e16e99581d25c914342da7a78200740b88ee9abcd136cc98aaa5e62c866e145e38bdc8d3242a3437e355718c2c8f5ed179  002-SpacemiT-K1X-Fixups.patch
aaf92d757d9f808d3441595c2f680a217946be2042a3191456bc7fd84c04815c081dc65bfb3b8b08f6f02158cd201210dc4e76c57b75ae2e82203874a0952071  003-SpacemiT-K1X-Defconfig-Fixups.patch
d5b1b16e68e0ca8c070440b742ee16293174e26bd2d4202244ef089414c2ab15c92656919110561476cace53b362217b0f91c426641df422cc3813d71c198361  004-efi_loader-suppress-error-print-message.patch
f7569e0a673818a19f164f907f9ace3b7a09df5d2cbbe7d234dd0ec907e3ee4ab49546dc9433064d680f910631c072f250e46d4da673d7753c0983add6ff50b2  005-Orange-Pi-RV2-u-boot-support-for-XM25QU128C-flash.patch
98d572bdd1c0dfded33e0de8497e32712969e72435ac6b878177e650769b2b99007fbb551c19c3d6bd223e994a0fa80ca4809902d11cbb500fa27f38fda49f1b  006-orangepi-rv2-r2s-fit.patch
9c26e76bde12043903cd674e3a8da96a18ee772e54ccb2ded26153c50a5d08d233269c663ae5444dc29ce94d809193574c437a4db27566dc1ad14db345bbe6a9  k1-x.env
"
