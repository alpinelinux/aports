# Contributor: Stefan Wagner <stw@bit-strickerei.de>
# Maintainer: Stefan Wagner <stw@bit-strickerei.de>
pkgname=grafana
pkgver=4.0.1
pkgrel=0
pkgdesc="Gorgeous metric viz, dashboards & editors for Graphite, InfluxDB & Prometheus"
url="http://grafana.org/"
arch="all !aarch64"
license="ASL 2.0"
makedepends="go nodejs python2"
pkgusers="grafana"
pkggroups="grafana"
install="$pkgname.pre-install"
source="grafana-server.initd"
builddir="$srcdir/src/github.com/grafana/$pkgname"
_git_repo="https://github.com/grafana/grafana.git"

unpack() {
	git clone --branch v${pkgver} $_git_repo $builddir || return 1
	default_unpack || return 1
}

build() {
	cd "$builddir"

	export GOPATH="$srcdir"
	go run build.go build || return 1

	npm install || return 1
	npm run build
}

package() {
	cd "$builddir"

	install -Dm755 bin/grafana-server \
		"$pkgdir/usr/bin/grafana-server" || return 1
	install -Dm755 bin/grafana-cli \
		"$pkgdir/usr/bin/grafana-cli" || return 1
	install -Dm644 conf/sample.ini \
		"$pkgdir/etc/$pkgname/$pkgname.ini" || return 1
	install -Dm644 conf/defaults.ini \
		"$pkgdir/usr/share/$pkgname/conf/defaults.ini" || return 1

	install -dm755 "$pkgdir/usr/share/grafana/" || return 1
	cp -r public_gen "$pkgdir/usr/share/grafana/public" || return 1
	ln -s /var/lib/grafana "$pkgdir/usr/share/grafana/data" || return 1

	install -dm755 "$pkgdir/var/log" || return 1
	ln -s /usr/share/grafana/data/log "$pkgdir/var/log/grafana" || return 1

	install -Dm755 "$srcdir/grafana-server.initd" \
		 "$pkgdir/etc/init.d/grafana-server" || return 1
}

md5sums="b86cbd9b48cf171c730e73049a594581  grafana-server.initd"
sha256sums="4c0a43729f024a4680a58fe671189b69858587f854a7f91b03ddb68eb671d059  grafana-server.initd"
sha512sums="b4d843f272d8f9ef44974d63f525daae68f6ca85ba5e71843643b868e03249ddd81f0f0c5882359abc836431cd51590f923d8e82a0286bfdcd3697ffe1cb0872  grafana-server.initd"
