maintainer="Leon White <badfunkstripe@gmail.com>"
pkgname=protoc-gen-grpc-gateway
pkgver=2.28.0
pkgrel=0
pkgdesc="gRPC to JSON proxy generator following the gRPC HTTP spec"
url="https://github.com/grpc-ecosystem/grpc-gateway"
arch="all"
license="BSD-3-Clause"
depends="protoc"
makedepends="go"
source="$pkgname-$pkgver.tar.gz::https://github.com/grpc-ecosystem/grpc-gateway/archive/refs/tags/v$pkgver.tar.gz"
builddir="$srcdir/grpc-gateway-$pkgver"
options="net" # download Go modules
subpackages="protoc-gen-openapiv2:openapiv2"

build() {
	local ldflags="
		-X main.version=$pkgver
		-X main.commit=AlpineLinux
		-X main.date=$(date -u "+%Y-%m-%dT%TZ" ${SOURCE_DATE_EPOCH:+-d @$SOURCE_DATE_EPOCH})
		"

	cd "$builddir/protoc-gen-grpc-gateway"
	go build -v -ldflags "$ldflags" .

	cd "$builddir/protoc-gen-openapiv2"
	go build -v -ldflags "$ldflags" .
}

check() {
	cd "$builddir/protoc-gen-grpc-gateway"
	go test ./...

	cd "$builddir/protoc-gen-openapiv2"
	go test ./...
}

package() {
	install -Dm755 "$builddir/protoc-gen-grpc-gateway/protoc-gen-grpc-gateway" \
		-t "$pkgdir"/usr/bin/
}

openapiv2() {
	pkgdesc="Generates an OpenAPI spec for a gRPC API spec"
	depends="protoc"

	install -Dm755 "$builddir/protoc-gen-openapiv2/protoc-gen-openapiv2" \
		-t "$subpkgdir"/usr/bin/
}

sha512sums="
20d8279df9ba9516cde0b825a6e9ab130f5be644335691fd12634709a871ca6b864dfaa3f88b5ffd4016526287c7d6bb69657e703efca28d6505a137a22731dd  protoc-gen-grpc-gateway-2.28.0.tar.gz
"
