maintainer="Leon White <badfunkstripe@gmail.com>"
pkgname=protoc-gen-grpc-gateway
pkgver=2.27.5
pkgrel=0
pkgdesc="gRPC to JSON proxy generator following the gRPC HTTP spec"
url="https://github.com/grpc-ecosystem/grpc-gateway"
arch="all"
license="BSD-3-Clause"
depends="protoc"
makedepends="go"
source="$pkgname-$pkgver.tar.gz::https://github.com/grpc-ecosystem/grpc-gateway/archive/refs/tags/v$pkgver.tar.gz"
builddir="$srcdir/grpc-gateway-$pkgver"
options="net" # download Go modules
subpackages="protoc-gen-openapiv2:openapiv2"

build() {
	local ldflags="
		-X main.version=$pkgver
		-X main.commit=AlpineLinux
		-X main.date=$(date -u "+%Y-%m-%dT%TZ" ${SOURCE_DATE_EPOCH:+-d @$SOURCE_DATE_EPOCH})
		"

	cd "$builddir/protoc-gen-grpc-gateway"
	go build -v -ldflags "$ldflags" .

	cd "$builddir/protoc-gen-openapiv2"
	go build -v -ldflags "$ldflags" .
}

check() {
	cd "$builddir/protoc-gen-grpc-gateway"
	go test ./...

	cd "$builddir/protoc-gen-openapiv2"
	go test ./...
}

package() {
	install -Dm755 "$builddir/protoc-gen-grpc-gateway/protoc-gen-grpc-gateway" \
		-t "$pkgdir"/usr/bin/
}

openapiv2() {
	pkgdesc="Generates an OpenAPI spec for a gRPC API spec"
	depends="protoc"

	install -Dm755 "$builddir/protoc-gen-openapiv2/protoc-gen-openapiv2" \
		-t "$subpkgdir"/usr/bin/
}

sha512sums="
c313901cea923d6931ab448b2be0a2ae811736c1d6ea06774e0d799ba78f8b1dd4882ff7594b7e028a9ec4f69b74eb89f2698caddf3c8ce16b7633db44eacbd3  protoc-gen-grpc-gateway-2.27.5.tar.gz
"
