# Contributor: Bernhard J. M. Gruen <bernhard.gruen@googlemail.com>
# Maintainer: Wen Heping <wenhepingalpine@sohu.com>
pkgname=burp
pkgver=3.2.0
pkgrel=0
pkgdesc="A network backup and restore program"
url="https://burp.grke.org"
arch="all"
license="AGPL-3.0-only"
makedepends="
	bsd-compat-headers
	librsync-dev
	linux-headers
	uthash-dev
	openssl-dev>3
	zlib-dev
	"
checkdepends="check-dev"
subpackages="
	$pkgname-doc
	$pkgname-server
	"
source="https://github.com/grke/burp/releases/download/$pkgver/burp-$pkgver.tar.bz2
	burp.init

	fix-time-for-32bit.patch
	"
# Check is deactivated as it needs --enable-forks in check/check-dev
options="!check"

build() {
	./configure \
		--prefix=/usr \
		--sbindir=/usr/bin \
		--sysconfdir=/etc/burp \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--disable-acl \
		--disable-xattr
	make
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install-all

	cd "$pkgdir"
	rm -rf var \
		etc/burp/autoupgrade \
		etc/burp/clientconfdir
	chmod -R go-rwx etc/burp
}

server() {
	pkgdesc="$pkgdesc (server configuration and helper scripts)"
	# bash is needed on the server to run burp_ca, timer and notify scripts
	# I am working on a version that does not need bash anymore
	depends="bash openssl"

	cd "$builddir"

	mkdir -p "$subpkgdir"/var/spool/burp
	chmod 0755 "$subpkgdir"/var/spool
	chmod 0700 "$subpkgdir"/var/spool/burp

	mkdir -p "$subpkgdir"/usr/share/burp/scripts
	mv "$pkgdir"/usr/share/burp/scripts "$subpkgdir"/usr/share/burp
	# shellcheck disable=2115
	rm -rf "$pkgdir"/usr/share

	mkdir -p "$subpkgdir"/etc/burp
	mv "$pkgdir"/etc/burp/CA.cnf "$subpkgdir"/etc/burp/CA.cnf
	mv "$pkgdir"/etc/burp/burp-server.conf \
		"$subpkgdir"/etc/burp/burp-server.conf

	install -Dm755 "$srcdir"/burp.init "$subpkgdir"/etc/init.d/burp

	mkdir -p "$subpkgdir"/usr/bin
	local name; for name in bedup bsigs bsparse burp_ca vss_strip; do
		mv "$pkgdir"/usr/bin/$name "$subpkgdir"/usr/bin/$name
	done
}

sha512sums="
48b2cc5e334b82b10ffb9d5406e2ddd265ae299e7997831cdb5bb681d7de89b2642671737070af572797c6cace40aa3f21421b2d87f04bd43f5a1842a2db782e  burp-3.2.0.tar.bz2
ef98c1fb938063fee35cc5ae5ff9179a759b89b3c2629320ff4dffb4c42395cac1ad6b4615c6c1f34cc4be3ce54397b00f583ba5f3cd2fe8498902d4d9445e8f  burp.init
e9b035d7bbb5b27a2e39a0f126accb3e87da30102141bccedee3bae9f2d0149fd8a49b18650fd3152a9083db6d56f9c41f981b25301e29655ab3a5a7929040ee  fix-time-for-32bit.patch
"
