# Maintainer: Adam Jensen <acjensen@gmail.com>
pkgname=bcc
pkgver=0.10.0
_libbpf_commit='59a641543e181aadaedd400abc090f5b0db13edb'
pkgrel=0
pkgdesc="A toolkit for creating efficient kernel tracing and manipulation programs"
url="https://github.com/iovisor/bcc/"
arch="aarch64 x86_64"
license="Apache-2.0"
# bcc's test suite requires privileged access to run BPF programs
options="!check"
depends="python"
makedepends="tar git llvm7-dev llvm7-static clang-dev clang-static cmake flex-dev
	bison luajit-dev build-base iperf linux-headers elfutils-dev zlib-dev"
source="$pkgname-$pkgver.tar.gz::https://github.com/iovisor/$pkgname/archive/v$pkgver.tar.gz
	libbpf-$_libbpf_commit.tar.gz::https://github.com/libbpf/libbpf/archive/$_libbpf_commit.tar.gz
	10-linux-stddef.patch"

prepare() {
	mv $srcdir/libbpf-$_libbpf_commit/* $srcdir/$pkgname-$pkgver/src/cc/libbpf

	default_prepare
}

build() {
	mkdir -p "$builddir/build"
	cd "$builddir/build"
	cmake -DCMAKE_INSTALL_PREFIX:PATH=/usr -DCMAKE_INSTALL_LIBDIR=/usr/lib ..
	make
}

package() {
	cd "$builddir/build"
	make install DESTDIR="$pkgdir"
}

sha512sums="92ba0f57d22af610ac81661526fed8bec80d502bcbc8aa5048ba7c50911247c020832db23afdcf9b555b142cd387c228cf7baa0ddc94067165403e362227f235  bcc-0.10.0.tar.gz
9a1f15a3b459bd7528456756d2a6d0165ea26e2e66c03f9625627efc4cde187e2a28b7fcbc52a8649b7f8003be9ba99ba3b8f73d4f0ff1276d57e8e46c039e34  libbpf-59a641543e181aadaedd400abc090f5b0db13edb.tar.gz
d7ef6a96d7051f314529e1a81dacc651f688ad128bb4d4632a93912ef97ea4994cc2fd473b856722030f2cb5a28e73081678ff38fdd68335571f87ec5873efca  10-linux-stddef.patch"
