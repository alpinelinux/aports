# Contributor: Stuart Cardall <developer@it-offshore.co.uk>
# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>
pkgname=ovn
pkgver=24.03.7
pkgrel=0
pkgdesc="Open Virtual Network"
url="https://www.ovn.org"
arch="all"
license="Apache-2.0"
depends="openvswitch"
makedepends="automake
	autoconf
	libtool
	libcap-ng-dev
	linux-headers
	openssl-dev>3
	python3
	unbound-dev
	"
subpackages="$pkgname-dev $pkgname-doc $pkgname-dbg $pkgname-openrc"
_gitrev="f1bc9af9627e97b8361dd32834068a8b7f2e0d17"
options="!check" # most of the tests are failing
install="$pkgname.post-install"
source="$pkgname-$pkgver.tar.gz::https://github.com/ovn-org/ovn/archive/refs/tags/v$pkgver.tar.gz
	openvswitch-$_gitrev.tar.gz::https://github.com/openvswitch/ovs/archive/$_gitrev/ovs-$_gitrev.tar.gz
	ovn-ctl.confd
	ovn-northd.initd
	ovn-ovsdb-server-nb.initd
	ovn-ovsdb-server-sb.initd
	ovn-controller.initd
	"

prepare() {
	default_prepare

	cd "$srcdir"/ovs-$_gitrev
	autoreconf -fiv

	cd "$builddir"
	autoreconf -fiv
}

build() {
	export CFLAGS="$CFLAGS -fPIC"
	# First OpenVSwitch must be built
	# Taking the same configure options from openvswitch APKBUILD,
	# expect building static libraries here
	cd "$srcdir"/ovs-$_gitrev
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var \
		--enable-ndebug \
		--enable-libcap-ng
	make

	msg "Built OVS. Now building OVN"
	cd "$builddir"
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--enable-shared \
		--enable-ndebug \
		--with-ovs-source=../ovs-$_gitrev \
		--with-ovs-build=../ovs-$_gitrev
	make
}

check() {
	make check
}

package() {
	# parallel install issue
	make -j1 DESTDIR="$pkgdir" install

	install -Dm644 ../ovn-ctl.confd "$pkgdir"/etc/conf.d/ovn-ctl
	local f
	for f in ovn-northd \
		ovn-ovsdb-server-nb \
		ovn-ovsdb-server-sb \
	; do
		install -Dm755 ../"$f".initd "$pkgdir/etc/init.d/$f"
		ln -s ovn-ctl "$pkgdir/etc/conf.d/$f"
	done

	install -Dm755 ../ovn-controller.initd "$pkgdir/etc/init.d/ovn-controller"
}

sha512sums="
c53821a804673ef18954efdb94636bd5bca369bac929ff76b5cdd708b589aeca6c2c5c25d1c5fa6f547d48e2bd609824fe9dcd0a40ef95a035b9161efd0c7dd4  ovn-24.03.7.tar.gz
f6f3d13ebab2b6de8873a19a0eed984f24005b053766dc3f491b26e79b27ef8a2d6c6ab93869b5350f0a0530536297df6325c380bd2b9399b96911593f54ffa3  openvswitch-f1bc9af9627e97b8361dd32834068a8b7f2e0d17.tar.gz
b98fd4acefcc03714cebe18dd78839ec1e6777ed6b1b035873b7a05c24ce5c91b62d890543e58529ed47413c4ab926468a9915bf15675475712ac039f9d1cda5  ovn-ctl.confd
436f3bc162675b5baa9e301d58fe30d7d0dfb7a196f73012cd8dd3ee7b3e9016c8db81092629da08ee08fc572a697c4c1463c819254c26eaf1f69150f522c503  ovn-northd.initd
e2dc52c9328514d5ebe1b6b9e63a6b6055ff9fe1d9b4eb1cec429631f65d24b2144d5f328c7943b501eef40f1aafdf5bd247d5e7d58b028d25a8a361b9ebdcb0  ovn-ovsdb-server-nb.initd
393e8ae14280e8495b92063556c40273a8dc04572e2a78f03cbf61fd37fe509d9deacf30f50831f23664c1c3dd566122c5e683e928aa5e5c8a035f3183d84a78  ovn-ovsdb-server-sb.initd
9d54d84d1e70b0cc13c2c19b327f1441208ebcf3c1248c6625afa32cd47f8207ea80006fa82c9de6aa4d3fe03b2ab3bd3c887fb85dd6cb9bb7e5c3925afa38af  ovn-controller.initd
"
