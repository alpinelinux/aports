# Contributor: Oleg Titov <oleg.titov@gmail.com>
# Maintainer: Oleg Titov <oleg.titov@gmail.com>
pkgname=bazel
pkgver=1.2.0
pkgrel=0
pkgdesc="A fast, scalable, multi-language and extensible build system"
url="https://bazel.build"
arch="x86_64"
license="Apache-2.0"
depends="libarchive zip unzip"
# openjdk8 is a must, python3 is a must, 
# python2 is a trick to make things work as /usr/bin/python requiered
makedepends="bash openjdk8 python3 python2 linux-headers protobuf"
subpackages="
	$pkgname-doc
	$pkgname-zsh-completion:zshcomp:noarch
	$pkgname-examples::noarch
	"
#	$pkgname-bash-completion:bashcomp:noarch
source="https://github.com/bazelbuild/bazel/releases/download/$pkgver/bazel-$pkgver-dist.zip"

build() {
	export JAVA_HOME=/usr/lib/jvm/java-1.8-openjdk

	export PYTHON_BIN_PATH=/usr/bin/python3

	msg2 "Building bazel..."

	env EXTRA_BAZEL_ARGS="--host_javabase=@local_jdk//:jdk" \
		bash ./compile.sh

#	msg2 "Building bash completion..."

# Approach 1
#	./output/bazel build scripts:bazel-complete.bash

# Approach 1 with verbose output
#	./output/bazel build --sandbox_debug --verbose_failures scripts:bazel-complete.bash

# Approach 2
#	bash ./scripts/generate_bash_completion.sh \
#		--bazel=output/bazel \
#		--output=bazel-complete.bash \
#		--prepend=scripts/bazel-complete-header.bash \
#		--prepend=scripts/bazel-complete-template.bash

	msg2 "Shutting down bazel..."
	./output/bazel shutdown
}

check() {
	msg2 "Running bazel test..."
	./output/bazel test \
		--verbose_failures \
		--spawn_strategy=standalone \
		--genrule_strategy=standalone \
		--verbose_test_summary \
		--test_verbose_timeout_warnings \
		examples/cpp:hello-success_test || die

	./output/bazel shutdown
}

package() {
	install -Dm755 ./scripts/packages/bazel.sh "$pkgdir"/usr/bin/bazel
	install -Dm755 ./output/bazel "$pkgdir"/usr/bin/bazel-real

	install -m644 -D -t "$pkgdir"/usr/share/doc/$pkgname README.md
}

bashcomp() {
	depends=""
	pkgdesc="Bash completion for $pkgname"
	install_if="$pkgname=$pkgver-r$pkgrel bash-completion"

	mkdir -p "$subpkgdir"/usr/share/bash-completion/completions
	mv "$builddir"/scripts/bazel-complete.bash \
		"$subpkgdir"/usr/share/bash-completion/completions/bazel
}

zshcomp() {
	depends=""
	pkgdesc="Zsh completion for $pkgname"
	install_if="$pkgname=$pkgver-r$pkgrel zsh"

	mkdir -p "$subpkgdir"/usr/share/zsh/site-functions
	mv "$builddir"/scripts/zsh_completion/_bazel \
		"$subpkgdir"/usr/share/zsh/site-functions/_bazel
}

examples() {
	mkdir -p "$subpkgdir"/usr/share/doc/"$pkgname"
	for d in examples third_party tools; do
		mv "$builddir/$d" "$subpkgdir/usr/share/doc/$pkgname"
	done
}

unpack() {
	msg "$builddir is... "
	echo $builddir
	mkdir -p "$builddir"
	unzip "$srcdir"/bazel-$pkgver-dist.zip -d "$builddir" > /dev/null
}

sha512sums="eaa3e27d0ddd6102fea4fcdf5f4379355954ba25cd2f4b3530071d077411f8a501041d8fda9ac90325244296f31072faaebd91cf6338893752b25212822a6be9  bazel-1.2.0-dist.zip"
