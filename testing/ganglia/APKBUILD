# Contributor: Zach McGrew <zmcgrew@gmail.com>
# Maintainer:
pkgname="ganglia"
pkgver="3.7.2"
pkgrel=0
pkgdesc="Ganglia is a scalable distributed monitoring system for high-performance computing systems"
pkggroups="ganglia"
pkgusers="ganglia"
url="http://ganglia.info/"
arch="all"
license="BSD-3-Clause"
depends="python2
	rrdtool"
depends_dev="
	autoconf
	automake
	libtool
	libtirpc-dev
	rrdtool-dev
	apr-dev
	confuse-dev
	protobuf-c-dev
	expat-dev
	pcre-dev
	zlib-dev
	rpcgen
	linux-headers"
makedepends="$depends_dev"
install="$pkgname.pre-install"
subpackages="$pkgname-dev $pkgname-doc $pkgname-openrc"
source="$pkgname-$pkgver.tar.gz::https://github.com/ganglia/monitor-core/archive/$pkgver.tar.gz
	gmond.initd
	gmetad.initd
	riemann.proto::https://raw.githubusercontent.com/aphyr/riemann-java-client/2.5.0/src/main/proto/riemann/proto.proto
	uid.patch
	runstatedir.patch
	"
builddir="$srcdir/monitor-core-$pkgver"

prepare() {
	./bootstrap
	default_prepare

	cd "$srcdir"
	protoc-c --c_out="$builddir/gmetad" riemann.proto
}

build() {
	# Required to work around Sun RPC (ONC/RPC) library errors
	LDFLAGS=-ltirpc \
	CFLAGS=-I/usr/include/tirpc \
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--libdir=/usr/lib \
		--sysconfdir=/etc/ganglia \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--enable-gexec \
		--enable-status \
		--with-gmetad \
		--with-riemann \
		--with-python=/usr/bin/python2
	make
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install

	install -m755 -D "$srcdir"/gmond.initd \
		"$pkgdir"/etc/init.d/gmond

	install -m755 -D "$srcdir"/gmetad.initd \
		"$pkgdir"/etc/init.d/gmetad

	# Install Python modules
	mkdir -p "$pkgdir/usr/lib/$pkgname/python_modules"
	find "gmond/python_modules" -name *.py \
		-exec cp \{\} "$pkgdir/usr/lib/$pkgname/python_modules/" \;
	cp -R "gmond/python_modules/conf.d" "$pkgdir/etc/$pkgname/"

	msg2 "Generating default gmond.conf"
	./gmond/gmond --default_config > "$pkgdir/etc/$pkgname/gmond.conf"

	install -dm755 -o ganglia -g ganglia "$pkgdir/var/lib/ganglia/"
	install -dm755 -o ganglia -g ganglia "$pkgdir/var/lib/ganglia/rrds"
	install -Dm644 COPYING "$pkgdir/usr/share/licenses/${pkgname}/COPYING"
}

sha512sums="7e7988e8c24340937afb4400e537fb097b5600ffd36e2505c10d230f92776f8b8ece055afb2dbc1d7d08a44f1107590996eca6474321615dfa39e0597159df42  ganglia-3.7.2.tar.gz
b6cd6384037ee54727eeec8fbc71f17455e84b652ece86bf0ec4f96854fd63ef65b26b90c0147b2a1dc739a102e5f625c63567e8700856246ebabbc116639429  gmond.initd
76000ce18f9ab2f3202d0ca0695737ee2e5479da24071dd20e442e340fd36c0a29c2578e7e3cabe54648cd0b82ed15e969f31c9d578ba1d05100116f813ab520  gmetad.initd
c76a2b53bf306787a25f529e4d72db6bf9b0b1ea54486bb841150bd138f6d188aaf6481ac287fbc8d3ff15c0f33d755d30fbc863aa4c26d7a87551bc7f200a85  riemann.proto
e9e78bbb45ebeeb7617499cd92a9173051b7949b625e4aca543a46d073919dcd1b5b1921fe92b6253b868ef345ce49e186dd44a8a12e77117b84678d7d538c82  uid.patch
101f053d90e4a47c0792ae83d678338e9cd3cfcf8f40c882235e55a6f994ebfe78b00a211b52ba73b3f9f23a1bd53274476fe9901c7f04c88000ffe207f71810  runstatedir.patch"
