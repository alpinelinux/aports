maintainer="Achill Gilgenast <achill@achill.org>"
pkgname=ntpd-rs
pkgver=1.7.1
pkgrel=0
pkgdesc="Full-featured implementation of the Network Time Protocol, including NTS support"
url="https://docs.ntpd-rs.pendulum-project.org/"
arch="all"
license="Apache-2.0 OR MIT"
makedepends="
	cargo-auditable
	clang-libclang
	cmake
	samurai
	"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc $pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/pendulum-project/ntpd-rs/archive/refs/tags/v$pkgver.tar.gz
	ntpd-rs.initd
	ntpd-rs-metrics-exporter.initd
	"
options="!check net" # fails, downloading rust crates

prepare() {
	default_prepare
	cargo fetch --target="$CTARGET" --locked
}

build() {
	cargo auditable build --frozen --release
}

check() {
	cargo test --frozen --release
}

package() {
	for i in ntp-daemon ntp-ctl ntp-metrics-exporter; do
		install -Dm755 target/release/$i \
			-t "$pkgdir"/usr/bin/
	done

	# default config
	install -Dm644 docs/examples/conf/ntp.toml.default \
		"$pkgdir"/etc/ntpd-rs/ntp.toml

	# openrc
	install -Dm755 "$srcdir"/ntpd-rs.initd \
		"$pkgdir"/etc/init.d/ntpd-rs
	install -Dm755 "$srcdir"/ntpd-rs-metrics-exporter.initd \
		"$pkgdir"/etc/init.d/ntpd-rs-metrics-exporter

	# man pages
	for i in ntp-daemon.8 ntp-ctl.8 ntp-metrics-exporter.8; do
		install -Dm644 docs/precompiled/man/$i \
			-t "$pkgdir"/usr/share/man/man8
	done

	install -Dm644 docs/precompiled/man/ntp.toml.5 \
		-t "$pkgdir"/usr/share/man/man5

	install -Dm644 README.md -t "$pkgdir"/usr/share/doc/$pkgname/
	install -Dm644 CHANGELOG.md -t "$pkgdir"/usr/share/doc/$pkgname/
	install -Dm644 SECURITY.md -t "$pkgdir"/usr/share/doc/$pkgname/
	install -Dm644 LICENSE-MIT -t "$pkgdir"/usr/share/doc/$pkgname/
	install -Dm644 LICENSE-APACHE -t "$pkgdir"/usr/share/doc/$pkgname/
}

sha512sums="
ebe970d98dea6d1b2bea6165909a0286fd7763806e4feb671cac2c32f53419d641a2f60e0ce4e06e5c79c9efe8858b4eef4caa1daf54e88d4181cbf68da6b77f  ntpd-rs-1.7.1.tar.gz
0073d186837898a42e4adde5b6a06be12732ae3ca43e5d726b594ea774377b3ace61010965d821301d4773ae4ba0e79b2e52fb8258e4b1e9075a77bdeb6a51bd  ntpd-rs.initd
0a75a0d2ac77e0754f180df880dc7b0ef2c525cde5c575ffccfafef4ba06a59cbcd7bd0a1a313649a0674def8353f3333be692054b7416f4b9302124f5be3aeb  ntpd-rs-metrics-exporter.initd
"
