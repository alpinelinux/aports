# Contributor: The one with the braid <info@braid.business>
# Maintainer: The one with the braid <info@braid.business>
pkgname=polycule
pkgver=0.3.4
pkgrel=0
pkgdesc="A geeky and efficient [matrix] client for power users."
url="https://gitlab.com/polycule_client/polycule"
arch="aarch64 x86_64"	# flutter
license="EUPL-1.2"
# libsecret: pub/flutter_secure_storage
# xdg-user-dirs: pub/path_provider
# olm: pub/matrix
# mimalloc2: pub/media_kit
# libnotify: pub/flutter_local_notifications
# dbus: pub/flutter_local_notifications
# openssl-dev: pub/sqlcipher_flutter_libs
# mpv-dev: pub/media_kit
depends="
	jsoncpp
	libsecret
	xdg-user-dirs
	olm
	mimalloc2
	libnotify
	dbus
	"
_llvmver=21
makedepends="
	ca-certificates
	cargo
	cargo-auditable
	flutter-desktop
	libsecret-dev
	llvm$_llvmver
	patchelf
	openssl-dev
	mpv-dev
	"
sonameprefix="$pkgname:"
source="
	https://gitlab.com/polycule_client/polycule/-/archive/${_rev:-"v$pkgver"}/polycule-${_rev:-v"$pkgver"}.tar.gz
	system-flutter.patch
	flutter-3.38.patch
	media-kit-broken-by-design.patch.pubdev
	vodozemac-alpine-target.patch.pubdev
	"
builddir="$srcdir/polycule-${_rev:-"v$pkgver"}"
# net: pub dependencies
# !check: no tests
options="net !check"

export _pkgorg="business.braid.polycule"
export _pkgexec="polycule"

case "$CARCH" in
	aarch64) _flutter_arch="arm64" ;;
	x86_64) _flutter_arch="x64" ;;
esac

export PUB_CACHE="$srcdir/pub_cache"

export CFLAGS="$CFLAGS -O2 -Wno-error -Wno-unknown-warning-option -Wno-unused-command-line-argument"
export CXXFLAGS="$CXXFLAGS -O2 -Wno-error -Wno-unknown-warning-option -Wno-unused-command-line-argument"

export CC=clang-$_llvmver
export CXX=clang++-$_llvmver
export AR=llvm$_llvmver-ar
export NM=llvm$_llvmver-nm
export LD=clang++-$_llvmver

export CTARGET

prepare() {
	default_prepare

	flutter pub get --enforce-lockfile
	flutter gen-l10n

	# if there is a binary in the pub_cache, we sure did not build it.
	for elf in $(scanelf -RA -F "%F" "$PUB_CACHE"); do
		rm -f "$elf"
	done

	# credits to jane400 <alpine@j4ne.de>
	cd "$srcdir"
	patch -p1 -i "$srcdir/media-kit-broken-by-design.patch.pubdev"
	patch -p1 -i "$srcdir/vodozemac-alpine-target.patch.pubdev"
}

build() {
	flutter build linux -v --release \
		--dart-define=POLYCULE_IS_STABLE=true \
		--dart-define=POLYCULE_VERSION=v$pkgver

	local rpath="/usr/lib/$pkgname"

	patchelf --set-rpath "$rpath/lib" build/linux/"$_flutter_arch"/release/bundle/$_pkgexec
	for _elf in build/linux/"$_flutter_arch"/release/bundle/lib/lib*.so; do
		# running patchelf on libapp (the AOT snapshot of the whole Dart codebase)
		# breaks it with "[FATAL:flutter/runtime/dart_vm_initializer.cc(89)]
		# Error while initializing the Dart VM: Invalid vm isolate snapshot seen".
		#
		# it has no rpath and only links to libc soname anyway. ü§∑‚Äç‚ôÄÔ∏è
		[ "$(basename "$_elf")" != "libapp.so" ] || continue

		patchelf --set-rpath "$rpath" "$_elf"
	done
}

package() {
	local bundle="$builddir"/build/linux/$_flutter_arch/release/bundle

	install -Dm755 "$bundle"/$_pkgexec "$pkgdir"/usr/lib/$pkgname/$_pkgexec
	cp -rv "$bundle"/lib "$pkgdir"/usr/lib/$pkgname/lib
	cp -rv "$bundle"/data "$pkgdir"/usr/lib/$pkgname/data

	mkdir -p "$pkgdir"/usr/bin
	ln -sv /usr/lib/$pkgname/$_pkgexec "$pkgdir"/usr/bin/$_pkgexec

	install -Dm644 "$bundle"/data/flutter_assets/NOTICES.Z "$pkgdir"/usr/share/licenses/$pkgname/NOTICES.Z
	install -Dm644 "$builddir"/LICENSE "$pkgdir"/usr/share/licenses/$pkgname/COPYING
	for font in "$builddir"/assets/fonts/* ; do
		install -Dm644 "$font"/LICENSE.txt "$pkgdir"/usr/share/licenses/$pkgname/"$(basename "$font")".txt
	done
	install -Dm644 linux/$_pkgorg.desktop "$pkgdir"/usr/share/applications/$_pkgorg.desktop
	install -Dm644 linux/$_pkgorg-daemon.desktop "$pkgdir"/etc/xdg/autostart/$_pkgorg-daemon.desktop
	install -Dm644 linux/$_pkgorg.service "$pkgdir"/usr/share/dbus-1/services/$_pkgorg.service
	install -Dm644 linux/$_pkgorg.metainfo.xml "$pkgdir"/usr/share/metainfo/$_pkgorg.metainfo.xml
	install -Dm644 assets/logo/logo-circle.svg "$pkgdir"/usr/share/icons/hicolor/scalable/apps/$_pkgorg.svg
}

sha512sums="
705098803d5f8eb1f389f0197f80b96c1724fb6a4e4be2ab7a2b96242b0c429e3a060f368c36253f3eec2bae0b98886708c7432cfd27820ea4b797c81371d3f0  polycule-v0.3.4.tar.gz
00108c868dbb776ca4ce41861b31dd3e833b691d26f25a23c9b7a619be262f433ec655158c3e2e8dcb7c16ff900baf9e6eb51f7edadb945821df841e5e6b8bc2  system-flutter.patch
1710253a36c56babbd686fac039c3bea8ee38ea60349d38f314c9af042a5111e58adfe6627f66a63d5f6460b8ba6be075629c14deccefb1ce04a1c755aa2eeb0  flutter-3.38.patch
be8b90853aad9768d58a501d8e85e205a0b770b3d2cdc23a4b5b8878923d3368cc2463869ed6537b3220126c083360503305b65a671ca3f9e5c073ad18547e9d  media-kit-broken-by-design.patch.pubdev
3a8c646cd1528d243150d1cbaccb7863cc029be0449953cca6d68d9152f4cac62ae27744d2776555962900f402e50a9723350a04d39e43903440c9a1c1558da8  vodozemac-alpine-target.patch.pubdev
"
