# Contributor: Peter Szalatnay <theotherland@gmail.com>
# Maintainer: Peter Szalatnay <theotherland@gmail.com>
pkgname=percona-xtradb-cluster-galera
pkgver=5.7.16
_pkgver="$pkgver-27.19"
pkgrel=0
pkgdesc="Codership Galera library for Percona XtraDB Cluster"
url="https://www.percona.com/software/mysql-database/percona-xtradb-cluster"
arch="all"
license="GPL2"
depends=""
depends_dev=""
makedepends="scons asio-dev check-dev"
source="https://github.com/percona/galera/archive/pxc_$_pkgver.tar.gz
        fix-gu_arch.patch
        fix-gu_alloc.patch
        "

builddir="$srcdir/galera-pxc_$_pkgver"

build() {
        cd "$builddir"

        local GALERA_REVISION="$(test -r GALERA-REVISION && cat GALERA-REVISION)"
 
        CFLAGS="$CFLAGS -DSIGEV_THREAD_ID=4 -U_FORTIFY_SOURCE"
        CXXFLAGS="$CXXFLAGS -U_FORTIFY_SOURCE -Wno-error=cpp -Wno-error=missing-field-initializers"

        scons psi=1 --config=force revno="$GALERA_REVISION" libgalera_smm.so || return 1
        scons --config=force revno="$GALERA_REVISION" garb/garbd || return 1
}

package() {
        cd "$builddir"

        install -Dm 755 "$builddir"/libgalera_smm.so \
            "$pkgdir"/usr/lib/galera3/libgalera_smm.so || return 1

        install -Dm 755 "$builddir"/garb/garbd \
            "$pkgdir"/usr/bin/garbd || return 1
}

md5sums="a9f774cefeecec27271c7f5dfd30eeeb  pxc_5.7.16-27.19.tar.gz
43a717bf490f0a2782d2ade4b7bbc300  fix-gu_arch.patch
c84b8405a1efbafd97da777bd9821d04  fix-gu_alloc.patch"
sha256sums="be05f8efee7a3e3f556259c34954c2ffa8f2932d204f8ffdf68f98dd17445e58  pxc_5.7.16-27.19.tar.gz
9f22846bb1e9bfc8eeb6debab5918dfad69bf475c46203419748717100495af8  fix-gu_arch.patch
26a00b04c12baac590f3c5b28c4ff2ec1007750da197b58982b23473503473a4  fix-gu_alloc.patch"
sha512sums="b861a941deaf7732b0fc057ea30791415b6ecab8da4925da0bdcddc8aa97268002dd738604065e96ea68eccf13b303c72587c60826c063e517bb9c0b575cbbc6  pxc_5.7.16-27.19.tar.gz
fe4ab54d0a6f018dbe2ea5698141061ccce3ea47ca6f0bdc2cd613881d50f89e41d3c0932cfded49673ad14708cac95930efeea63d8f486d89da4e3332e23e65  fix-gu_arch.patch
868d2444ab8cb72a98bc7030396cc291c357c47701ea554bd450c3b44aaa936315b92b873ebd0be5af43afca1f510bada2e66c5da9579e8abfe99cca849c46b7  fix-gu_alloc.patch"
