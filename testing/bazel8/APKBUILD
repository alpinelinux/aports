# Maintainer: Leon White <badfunkstripe@gmail.com>
pkgname=bazel8
pkgver=8.6.0
pkgrel=0
pkgdesc="Bazel is an open-source build and test tool"
url="https://bazel.build/"
arch="x86_64 aarch64"
license="Apache-2.0"
depends="bash openjdk21-jdk"
makedepends="linux-headers python3 unzip zip"
# Bazel binary is thin C++ client with zip file embedded into the binary,
# stripping breaks that: https://github.com/bazelbuild/bazel/issues/11842
options="!strip"
provides="bazel=$pkgver-r$pkgrel"
subpackages="$pkgname-bash-completion"
source="
	https://github.com/bazelbuild/bazel/releases/download/$pkgver/bazel-$pkgver-dist.zip
	bazel-$pkgver-archive.tar.gz::https://github.com/bazelbuild/bazel/archive/refs/tags/$pkgver.tar.gz
	0000-local-jdk.patch
	0001-off64t-fix.patch
	0002-bash-completion-busybox.patch
"
builddir="$srcdir/"

build() {
	EMBED_LABEL=$pkgver-$pkgrel \
	EXTRA_BAZEL_ARGS=--tool_java_runtime_version=local_jdk \
		./compile.sh

	./output/bazel --batch build //scripts:bazel-complete.bash
	cp bazel-bin/scripts/bazel-complete.bash output/

	./output/bazel --batch clean --expunge
}

check() {
	ln -s bazel-$pkgver/examples examples
	# shellcheck disable=SC2046
	./output/bazel --batch build $(\
		./output/bazel --batch query --noshow_progress '//examples/...' \
			| grep -vF \
				-e /android/ \
				-e /windows/ \
				-e :hello-error-prone \
	)
	./output/bazel --batch test \
		//examples/cpp:hello-success_test \
		//examples/java-native/src/test/java/com/example/myproject:custom \
		//examples/java-native/src/test/java/com/example/myproject:hello \
		//examples/java-starlark/src/test/java/com/example/myproject:pass \
		//examples/shell:test

	./output/bazel --batch clean --expunge
}

package() {
	install -Dm 755 -t "$pkgdir/usr/bin" output/bazel
	install -Dm 644 output/bazel-complete.bash \
		"$pkgdir/usr/share/bash-completion/completions/bazel"
}

sha512sums="
7b6b61403e65aaa48bf7fb04f1be7307f82766b0d0b835703aa18e974a126cf0882187d0a4c4efaaecb14cbf7a22db9e5a229254ee68b5c225cf2751764847ea  bazel-8.6.0-dist.zip
e438d8b12ce534ba5832441befb0eafbf3fb4aba8392d1ead6360325b81e32f96619dbcf4720e3aa1878d9d613a90916f7a6318ce3e893d1bb514b10ae6f262c  bazel-8.6.0-archive.tar.gz
d3e8ded7373220702cf534d855a06ec6131a868ec2232d1489fc88e57962a0897095093c4a7a668d1676bcc3c3e2d956aad63f29aea3bfd616435d4a97c5a430  0000-local-jdk.patch
41db437d17422d84e2e9696c45f587657b3810c69139d1610dea4dab59f19ceb48c09bcb077e11627f44652dc3bb90b61b4afb21769397b4a1cf67ab5f303e2f  0001-off64t-fix.patch
b0bae27087f8d1da6a455500fc9fb4758ffdeaa27f0b11de720a0607aa3a4d682adfc1286b6385fe53e67296e7af1f61570b6b3093def1e8cee8531c7f4f5f82  0002-bash-completion-busybox.patch
"
