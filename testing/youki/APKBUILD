# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=youki
pkgver=0.5.7
pkgrel=0
pkgdesc="Container runtime written in Rust"
url="https://github.com/containers/youki"
# loongarch64: https://github.com/XuShaohua/nc/issues/44
# s390x: https://github.com/nix-rust/nix/issues/2641
arch="all !loongarch64 !s390x"
license="Apache-2.0"
makedepends="
	cargo
	cargo-auditable
	dbus-dev
	libseccomp-dev
	zlib-dev
	"
subpackages="$pkgname-dbg"
source="https://github.com/containers/youki/archive/v$pkgver/youki-$pkgver.tar.gz
	bump-nc-crate.patch
	"
options="!check" # FIXME: some tests fail or take forever

# prioritize crun and runc
provides="oci-runtime"
provider_priority=80

# secfixes:
#   0.4.1-r0:
#     - CVE-2024-21626
#   0.5.7-r0:
#     - CVE-2025-27561
#     - CVE-2025-27612
#     - CVE-2025-62161
#     - CVE-2025-62596

# Disable systemd_cgroups
_cargo_opts='--frozen --no-default-features --features=libcgroups/v1,libcgroups/v2'

prepare() {
	default_prepare

	cargo fetch --target="$CTARGET" --locked
}

build() {
	cargo auditable build $_cargo_opts --release
}

check() {
	cargo test $_cargo_opts
}

package() {
	install -D -m755 target/release/youki -t "$pkgdir"/usr/bin/
}

sha512sums="
64dda36b23b00f6a51abf9891f4b4d6e8785afbf42010b2ed1c5f613bf1549be8402db784e300faccbfc5d6f8280da8a918818226a8a91d88d27140bba40ce36  youki-0.5.7.tar.gz
222a85779405585c73de78e9c198c6c235e788d93bb2b53049c50bed356145dffd50f02676d3f0a44a074207b0bda9fbbced3973d81403922a60ed9d5fd2bab5  bump-nc-crate.patch
"
