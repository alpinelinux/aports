# Contributor: Patrycja Rosa <alpine@ptrcnull.me>
# Maintainer: Patrycja Rosa <alpine@ptrcnull.me>
pkgname=wasmtime
pkgver=39.0.1
pkgrel=0
pkgdesc="Fast and secure runtime for WebAssembly"
url="https://wasmtime.dev/"
arch="all !armv7 !armhf" # arm*: runs out of memory during build
license="Apache-2.0"
depends_dev="libwasmtime=$pkgver-r$pkgrel"
makedepends="
	cargo
	cargo-auditable
	chrpath
	cmake
	rust-wasm
	samurai
	zstd-dev
	"
subpackages="libwasmtime-static libwasmtime $pkgname-dev"
source="https://github.com/bytecodealliance/wasmtime/releases/download/v$pkgver/wasmtime-v$pkgver-src.tar.gz
	cargo-auditable.patch
	loongarch64-rustix.patch
	s390x-musl.patch
	system-zstd.patch
	"
builddir="$srcdir/wasmtime-v$pkgver-src"
# net: fetch dependencies
# check: thread 'main' panicked at src/cargo/ops/cargo_compile/mod.rs:933:14: packages downloaded: failed to download `windows-sys v0.52.0`
# (attempting to make an HTTP request, but --frozen was specified)
options="!check net"


prepare() {
	default_prepare

	git init -q
	# can't patch deps with vendor dir
	rm -fv .cargo/config.toml
	rm -rf vendor

	# Rust target triple.
	local target=$(rustc -vV | sed -n 's/host: //p')

	# Build against system-provided libs
	mkdir -p .cargo
	cat >> .cargo/config.toml <<-EOF
		[target.$target]
		zstd = { rustc-link-lib = ["zstd"] }
	EOF

	cargo fetch --target="$CTARGET" --locked

	# Work around type mismatch bug expected `u32`, found `u64` on s390x in rustix-linux-procfs
	sed -i 's/if f_type != FsWord::from(PROC_SUPER_MAGIC)/if FsWord::from(f_type) != FsWord::from(PROC_SUPER_MAGIC)/' \
		"$CARGO_HOME"/registry/src/*/rustix-linux-procfs-*/src/lib.rs
}

build() {
	cargo auditable build --frozen --release
	cargo auditable build --frozen --release -p wasmtime-c-api
	cmake -G Ninja -B build-capi -S crates/c-api \
		-DCMAKE_INSTALL_PREFIX=/usr
	cmake --build build-capi
}

check() {
	cargo test --frozen
}

package() {
	install -Dm755 target/release/wasmtime -t "$pkgdir"/usr/bin/
	# remove gigantic useless rpath to /usr/lib
	chrpath -d target/release/libwasmtime.so
	install -Dm644 target/release/libwasmtime.so -t "$pkgdir"/usr/lib/
	cmake --install build-capi --prefix="$pkgdir"/usr
}

libwasmtime() {
	amove usr/lib
}

sha512sums="
80eb42570fa3da387835d932dca515efd4a88e71142e7903234d3b68a0d90e2abf41865271a217b89d65c1070fbe09f712862225f5794271ec3a32b06e4e2278  wasmtime-v39.0.1-src.tar.gz
cd0f190af23b7b0ed057dd5ee70e3b113608f7d7b94f2b922b746515a59e4e3bcb24742fda98b19db27bffa379694bbaad7cc0847823d09b8ffb8802ead05752  cargo-auditable.patch
8cd42033c1aded637100eb8a6997b0df8cb24a0531d2bdd1391fb6b7e7c33c9aae9d1e71692cf122cb3f801864bc13beb80d3addeb003636f65c4ad011890786  loongarch64-rustix.patch
cf7a213474c14fcc9554e2ed2f06f4029f7541d7dc8cce6f937f998c4bd4872c7bd38aecb75c60b31fb95daa2780a71cf25041928ee197fd9363246ff121d556  s390x-musl.patch
d672f924b66aba57da4237bc1e7f50890c5e3e25803056be9a7d040c751219d760c746216a6ef0f90629832631a59b43158d215f529e37d1efa1cdd7cd04fefb  system-zstd.patch
"
