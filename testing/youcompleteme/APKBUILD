# Contributor: Orson Teodoro <orsonteodoro@hotmail.com>
# Maintainer: Orson Teodoro <orsonteodoro@hotmail.com>

pkgname=youcompleteme
_pkgname="YouCompleteMe"
pkgver=0_git20180121
pkgrel=0
pkgdesc="A code-completion engine for Vim"
url="https://github.com/Valloric/YouCompleteMe"
arch="noarch"
license="GPL-3.0-or-later Apache-2.0 BSD-2-Clause"
depends="python3 vim>=8.0 py-ycmd"
checkdepends="py3-flake8 py3-pycodestyle py3-coverage \
		py3-codecov py3-pyhamcrest py3-nose py3-future py3-mock"
_gitrev="d183f11fa72471ed6c4df595b4047dfff98abf75"
_requestsfuturespkgname="requests-futures"
_requestsfutures_gitrev="98712e7d0f6be2a090b6fda2a925f85e63656b58"
source="$pkgname-$pkgver.zip::https://github.com/Valloric/${_pkgname}/archive/${_gitrev}.zip
	$pkgname-$pkgver-requests-futures.zip::https://github.com/ross/${_requestsfuturespkgname}/archive/${_requestsfutures_gitrev}.zip
	ycmd-path-for-testing.patch
	README.Alpine"
builddir="$srcdir/"$_pkgname-$_gitrev
subpackages="$pkgname-doc"

_getpythonver(){
        echo $($1 -c 'import sys; print("%i.%i" % '\
		'(sys.version_info.major, sys.version_info.minor))')
}

unpack() {
	default_unpack
	cd "$srcdir"
	mv ${_requestsfuturespkgname}-${_requestsfutures_gitrev}/* \
		"$builddir"/third_party/requests-futures/
	cd "$builddir"
	rm -rf third_party/ycmd
	ln -s /usr/lib/python$(_getpythonver python3)/site-packages/ycmd \
		third_party/ycmd
}

package() {
	cd "$builddir"
	local vimpath="usr/share/vim/vimfiles"
	find "$srcdir" -type d -print0 | xargs -0 chmod 755
	install -d "$pkgdir"/$vimpath/third_party \
		"$pkgdir"/usr/share/doc/$pkgname/
	cp -a autoload plugin python "$pkgdir"/$vimpath/
	cp -a third_party/pythonfutures third_party/$_requestsfuturespkgname \
		"$pkgdir"/$vimpath/third_party/
	ln -s /usr/lib/ycmd "$pkgdir"/$vimpath/third_party/ 
	install -t "$pkgdir"/usr/share/doc/$pkgname/ README.md README.Alpine \
		doc/*
}

check() {
	cd "$builddir"
	python3 ./run_tests.py --no-flake8 --skip-build
}

sha512sums="89f44a24d8d7b70091bdf54e6a0f5c8da1f3342245e7000d1f7ead65fd89562e1d6d1d48071cd53cff5a6730473cdd1e95d9bd490c1b0fc7ddfdab2576644a26  youcompleteme-0_git20180121.zip
d931fa5382ba4506a764a07c32fa3412aebb834c05158b59459cfccfa541fcdae16a838b016a012690b2633d3f41fa8c3be9bc1b1225a573e427de571d689465  youcompleteme-0_git20180121-requests-futures.zip
811fd783db81f1284955b30fbd573026898cb3f1c04966ff70bfa99936c7b02807ab48d9eb99db95f3204a4ef505a6885f733394f3576b39b5233a84ca663c22  ycmd-path-for-testing.patch
3e46cf5730d9cbfb8aa22771826c7f9e15e8b12f6c8e0d58b2e285ba9995aba8edad44e18625b3387ccf8faed1011e25925fc842be5a607ed3d2eb6342366a04  README.Alpine"
