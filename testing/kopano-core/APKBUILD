# Maintainer: Noel Kuntze <noel.kuntze@contauro.com>
pkgname=kopano-core
subpackages="$pkgname-dbg $pkgname-openrc $pkgname-doc $pkgname-bash-completion"
pkgver=10.1.0
pkgrel=0
pkgdesc="Open Source Groupware Solution"
# ppc64le, mips64: blocked by py3-libmdbx
# riscv64: nginx missing
arch="all !ppc64le !mips64 !riscv64"
url="https://www.kopano.com/"
license="AGPL-3.0-or-later"
options="!check" # No test suite
makedepends="
	autoconf
	automake
	curl-dev
	db-dev
	docbook-xsl
	e2fsprogs
	gnu-libiconv-dev
	gsoap
	gsoap-dev
	icu-dev
	jsoncpp-dev
	libhx-dev
	libical-dev
	libtool
	libvmime-dev
	libxml2-dev
	mariadb-dev
	php7
	php7-dev
	py3-setuptools
	python3-dev
	sed
	swig3
	xapian-core-dev
	xmlto
	xorgproto
"
pkgusers="kopano-core kopano-gateway kopano-ical postfix"
pkggroups="kopano http kopano-diraccess"
depends="
	bash-completion
	bison
	boost
	boost-libs
	catdoc
	cyrus-sasl
	gnu-libiconv
	krb5
	libxslt
	mariadb
	nginx
	openldap
	openrc
	php7
	php7-fpm
	poppler
	postfix
	py3-daemon
	py3-dateutil
	py3-dnspython
	py3-flask
	py3-lockfile
	py3-magic
	py3-libmdbx
	py3-minimock
	py3-nose
	py3-openssl
	py3-sleekxmpp
	py3-soappy
	py3-tlslite-ng
	py3-tzlocal
	w3m
	xapian-bindings-php7
	xapian-bindings-python3
	xorgproto
"

install="$pkgname.pre-install"

source="
	https://github.com/Kopano-dev/kopano-core/archive/kopanocore-$pkgver.tar.gz
	kopano-ical.initd
	kopano-search.initd
	kopano-spooler.initd
	kopano-dagent.initd
	kopano-monitor.initd
	kopano-server.initd
	kopano-gateway.initd
	kopano-spamd.initd
	kopano-server.conf
	0001-python-Use-libmdbx-instead-of-bsddb.patch
	0002-provider.patch
	0003-spamd-Correct-owner-and-group-of-spamd-ham_dir-spam_.patch
"

builddir="$srcdir/kopano-core-kopanocore-$pkgver/"

prepare() {
	default_prepare
	sed -i 's/0.9.2k1/0.9.2/g' configure.ac

	./bootstrap.sh
}

build() {
	PYTHON=/usr/bin/python3 ./configure \
	--prefix=/usr \
	--localstatedir=/var \
	--sysconfdir=/etc \
	--exec-prefix=/usr \
	--sbindir=/usr/bin \
	--datarootdir=/usr/share \
	--includedir=/usr/include \
	--enable-release \
	--enable-epoll \
	--enable-python \
	--disable-static \
	--with-quotatemplate-prefix=/etc/kopano/quotamails \
	--with-searchscripts-prefix=/etc/kopano/searchscripts \
	--with-php=7

	make
}

_cfg_set() {
	local config_attribute="$1"
	local config_attribute_prefix=$(echo -n "$config_attribute" | sed "s|\(_\).*|\1|")
	local config_value="$2"
	local config_file="$3"

	# Uncomment And Set Attribute
	if grep -q "$config_attribute" $config_file ;
	then
	# Uncomment (Replaces Optional Comments And Spaces)
	sed -i "s|^#*\s*\($config_attribute.*\)|\1|" $config_file

	# Set ("name = value" => "name = newvalue")
	sed -i "s|^\($config_attribute\)\s*\=.*|\1 = $config_value|" $config_file

	# Add Attribute At Right Position
	elif [ -n "$config_attribute_prefix" ] \
	&& grep -q "$config_attribute_prefix" $config_file ;
	then
	# Find Last Attribut From Prefix-Group
	local config_attribute_last_from_group=$(tac $config_file | grep -m 1 "^#*\s*$config_attribute_prefix" | grep -o "${config_attribute_prefix}[^ =]*")
	sed -i "s|\($config_attribute_last_from_group.*$\)|\1\n$config_attribute = $config_value|" $config_file

	# Add Attribute At The End of File
	else
	echo $config_attribute = $config_value >> $config_file

	fi
}

package() {
	mkdir -p "$pkgdir"
	make install -j1 DESTDIR="$(realpath $pkgdir)"
	mkdir -p $pkgdir/usr/share/bash-completion/completions
	mv $pkgdir/usr/share/bash-completion/completions/kopano-bash-completion.sh $pkgdir/usr/share/bash-completion/completions/kopano

	rm -Rf "$pkgdir/etc/kopano/license" "$pkgdir/usr/lib/sysusers.d/" "$pkgdir/usr/lib/tmpfiles.d/"

	mkdir -p "$pkgdir/usr/share/licenses/$pkgname"
	cp AGPL-3 "$pkgdir/usr/share/licenses/$pkgname"
	mkdir -p "$pkgdir/usr/share/doc/$pkgname"
	cp -R RELNOTES.txt CONTRIBUTING.md  "$pkgdir/usr/share/doc/$pkgname"

	# General
	share_path="$pkgdir/usr/share/doc/kopano/example-config"
	#cfg_path="$pkgdir/etc/kopano"
	cfg_path="$share_path/"
	run_as_user="kopano-core"
	run_as_group="kopano"
	server_socket="/run/kopano/server.sock"
	server_lo_port="tcp://127.0.0.1:236"
	server_socket_prio="/run/kopano/prio.sock"
	search_socket="/run/kopano/search.sock"
	server_tls_min_proto="TLSv1 TLSv1\.1 TLSv1\.2"
	ssl_ciphers="AES256\+EECDH:AES256\+EDH:\!aNULL"
	server_tls_min_proto="tls1\.2"
	gateway_tls_min_proto="tls1\.2"
	ical_tls_min_proto="tls1\.2"
	ssl_privatekey="/etc/ssl/private/kopano.key"
	ssl_certificate="/etc/ssl/private/kopano.crt"

	# admin.cfg
	cfg="$cfg_path/admin.cfg"
	_cfg_set "server_socket" "file://$server_socket" $cfg

	# server.cfg
	cfg="$cfg_path/server.cfg"
	_cfg_set "attachment_compression" "0" $cfg
	_cfg_set "disabled_features" "" $cfg
	_cfg_set "hide_everyone" "yes" $cfg
	_cfg_set "search_enabled" "yes" "$cfg"
	_cfg_set "search_socket" "file://$search_socket" "$cfg"
	_cfg_set "mysql_socket" "/run/mysqld/mysqld.sock" $cfg
	_cfg_set "mysql_user" "kopano" $cfg
	_cfg_set "mysql_password" "kopano" $cfg
	#=> service
	_cfg_set "run_as_user" "$run_as_user" $cfg
	_cfg_set "run_as_group" "$run_as_group" $cfg
	_cfg_set "log_method" "file" $cfg
	_cfg_set "log_file" "/var/log/kopano/server.log" $cfg
	_cfg_set "log_level" "3" $cfg
	#=> server-connection (socket only)
	_cfg_set "server_pipe_name" "$server_socket" $cfg
	_cfg_set "server_pipe_priority" "$server_socket_prio" $cfg
	_cfg_set "server_listen" "" $cfg
	_cfg_set "server_listen_tls" "" $cfg
	_cfg_set "server_ssl_prefer_server_ciphers" "yes" $cfg
	_cfg_set "server_tls_min_proto" "$server_tls_min_proto" $cfg
	_cfg_set "server_ssl_ciphers" "$ssl_ciphers" $cfg
	_cfg_set "server_ssl_key_file" "$ssl_privatekey" $cfg
	_cfg_set "server_ssl_key_pass" "" $cfg
	_cfg_set "server_ssl_ca_file" "$ssl_certificate" $cfg
	_cfg_set "server_ssl_ca_path" "/etc/ssl/certs" $cfg

	# archiver.cfg
	cfg="$cfg_path/archiver.cfg"
	#=> service
	_cfg_set "log_method" "file" $cfg
	_cfg_set "log_file" "/var/log/kopano/archiver.log" $cfg
	_cfg_set "log_level" "3" $cfg
	#=> server-connection
	_cfg_set "server_socket" "file://$server_socket" $cfg

	# backup.cfg
	cfg="$cfg_path/backup.cfg"
	#=> service
	_cfg_set "log_method" "file" $cfg
	_cfg_set "log_file" "/var/log/kopano/backup.log" $cfg
	_cfg_set "log_level" "3" $cfg
	#=> server-connection
	_cfg_set "server_socket" "file://$server_socket" $cfg

	# dagent.cfg
	cfg="$cfg_path/dagent.cfg"
	#=> service
	_cfg_set "run_as_user" "$run_as_user" $cfg
	_cfg_set "run_as_group" "$run_as_group" $cfg
	_cfg_set "log_method" "file" $cfg
	_cfg_set "log_file" "/var/log/kopano/dagent.log" $cfg
	_cfg_set "log_level" "3" $cfg
	#=> server-connection
	_cfg_set "server_bind" "127.0.0.1" $cfg
	_cfg_set "server_socket" "file://$server_socket" $cfg

	# gateway.cfg
	cfg="$cfg_path/gateway.cfg"
	_cfg_set "imap_public_folders" "yes" "$cfg"
	_cfg_set "process_model" "fork" $cfg
	#=> service (avoid requests to be upgraded to admin privileges)
	_cfg_set "run_as_user" "kopano-gateway" $cfg
	_cfg_set "run_as_group" "kopano" $cfg
	_cfg_set "log_method" "file" $cfg
	_cfg_set "log_file" "/var/log/kopano/gateway.log" $cfg
	_cfg_set "log_level" "3" $cfg
	#=> server-connection
	_cfg_set "server_socket" "server_lo_port" $cfg
	_cfg_set "ssl_prefer_server_ciphers" "yes" $cfg
	_cfg_set "tls_min_proto" "$gateway_tls_min_proto" $cfg
	_cfg_set "ssl_ciphers" "$ssl_ciphers" $cfg
	_cfg_set "ssl_private_key_file" "$ssl_privatekey" $cfg
	_cfg_set "ssl_certificate_file" "$ssl_certificate" $cfg

	# ical.cfg
	cfg="$cfg_path/ical.cfg"
	_cfg_set "process_model" "fork" $cfg
	#=> service (avoid requests to be upgraded to kopano-admin)
	_cfg_set "run_as_user" "kopano-ical" $cfg
	_cfg_set "run_as_group" "kopano" $cfg
	_cfg_set "log_method" "file" $cfg
	_cfg_set "log_file" "/var/log/kopano/ical.log" $cfg
	_cfg_set "log_level" "3" $cfg
	#=> server-connection
	_cfg_set "server_socket" "file://$server_socket" $cfg
	_cfg_set "ssl_prefer_server_ciphers" "yes" $cfg
	_cfg_set "tls_min_proto" "$ical_tls_min_proto" $cfg
	_cfg_set "ssl_ciphers" "$ssl_ciphers" $cfg
	_cfg_set "ssl_private_key_file" "$ssl_privatekey" $cfg
	_cfg_set "ssl_certificate_file" "$ssl_certificate" $cfg

	# monitor.cfg
	cfg="$cfg_path/monitor.cfg"
	#=> service
	_cfg_set "run_as_user" "$run_as_user" $cfg
	_cfg_set "run_as_group" "$run_as_group" $cfg
	_cfg_set "log_method" "file" $cfg
	_cfg_set "log_file" "/var/log/kopano/monitor.log" $cfg
	_cfg_set "log_level" "3" $cfg
	#=> server-connection
	_cfg_set "server_socket" "file://$server_socket" $cfg

	# search.cfg
	cfg="$cfg_path/search.cfg"
	_cfg_set "index_attachements" "yes" "$cfg"
	_cfg_set "server_bind_name" "file://$search_socket" "$cfg"
	_cfg_set "ssl_private_key_file" "$ssl_privatekey" $cfg
	_cfg_set "ssl_certificate_file" "$ssl_certificate" $cfg
	#=> service
	_cfg_set "run_as_user" "$run_as_user" $cfg
	_cfg_set "run_as_group" "$run_as_group" $cfg
	_cfg_set "log_method" "syslog" $cfg
	_cfg_set "log_file" "-" $cfg
	_cfg_set "log_level" "3" $cfg
	_cfg_set "pid_file" "/run/kopano/search.pid" $cfg
	#=> server-connection
	_cfg_set "server_socket" "file://$server_socket" $cfg

	# spooler.cfg
	cfg="$cfg_path/spooler.cfg"
	_cfg_set "allow_send_to_everyone" "no" "$cfg"
	#=> service
	_cfg_set "run_as_user" "$run_as_user" $cfg
	_cfg_set "run_as_group" "$run_as_group" $cfg
	_cfg_set "log_method" "syslog" $cfg
	_cfg_set "log_file" "-" $cfg
	_cfg_set "log_level" "3" $cfg
	#=> server-connection
	_cfg_set "server_socket" "file://$server_socket" $cfg

	# spamd.cfg
	cfg="$cfg_path/spamd.cfg"
	_cfg_set "run_as_user" "$run_as_user" $cfg
	_cfg_set "run_as_group" "$run_as_group" $cfg
	#=> server-connection
	_cfg_set "server_socket" "file://$server_socket" $cfg

	install -dm0770 -okopano-core -gkopano "$pkgdir/var/log/kopano"
	install -dm0770 -okopano-core -gkopano-diraccess "$pkgdir/var/lib/kopano"
	install -dm0550 -okopano-core -gkopano "$pkgdir/etc/kopano"

	rm -rf "$pkgdir/usr/lib/systemd"
	# copy init files
	for item in kopano-ical kopano-search kopano-spooler kopano-dagent \
		kopano-monitor kopano-server kopano-gateway kopano-spamd
	do
		install -Dm 755 "$srcdir/$item.initd" "$pkgdir/etc/init.d/$item"
	done
	# copy conf.d file
	install -Dm 644 "$srcdir/kopano-server.conf" "$pkgdir/etc/conf.d/kopano-server"
}

sha512sums="87b9b05b5e04c3c6c136c4ff1547cf38be9904964327fa7f7d7e48c4ce78e3f2d5359c25609584c2d7fbaecb1463a5c850ef7927cdcc9526b40011b7b20a63a1  kopanocore-10.1.0.tar.gz
0ca7c888b19cf9b33688373b22eb515b103a1d7ab4eb8b9302a4a5b005fa3eaa332f434db1efb372f0d3440567e542ac5ba85e4f8c2dc46597899e3472af506a  kopano-ical.initd
6458f64076bbc398a8cc10a75ed2a9a32851b0a689956b3cb26e7f24364df666f6b173245f90a259a9db0fad8b0436636732c92c2d7fc908e2870fc6cbfad6ef  kopano-search.initd
88b7af9b3e999526d326353b4637a8f64b2684987b22e771d5a3667993e4e715f6722a9ebf17e46fafcdb66520ac8c39dac3f0b16e287053ea05da9946ee6e43  kopano-spooler.initd
c226c4f172761380d38a4b2a0d864620a0a087061d91d41204d0062a5573ac7c1bcd4cc84e3b31683ba773fd4e81b59fea8bb5c96d4a2bbebd02510b9735e937  kopano-dagent.initd
3e5d19ff8df78177141bdb79370658e88841affbb5fd9f5f50e0ca5bb9119257c905ca58ac93525b0924a702d3610a5fa40e5f5f3c2e8378d9bcf48b23b31878  kopano-monitor.initd
9b804a5a45df2da2b5f3696c301cfc49c9f8154c471f8ec6d4ba9d0a9ec527a4c50b32172d1df914e76bddcea05efcab52deadcea5540b03d56b3f62b7726110  kopano-server.initd
b3581c3a93cdd09bae3fbd9070e8263bf61db52348da1c7f1a9ad4657c684af4b83607ea47d036887938ca6d9d609b2ea77d38da00d4173f4051df3eb640be66  kopano-gateway.initd
d19e37a561f192c9d975e0b81341fffccc60f72fabc197eeddbd8423deb93ee83ddadea59c056138c9c6c9ec13e9421cc226719c8e7ca31fa8657eb6ae213405  kopano-spamd.initd
626e40d0a544290aa32210ce15b34ab871edbb670046762004af82dd5db0b3d18cd2f1982af615c393020118133a6b156c3953e5afa85012407efadd4bc49928  kopano-server.conf
6de2840c5e4d193d5bc5f825202466979f0abdd15669a8199a822156c1f8663fd9965d856817591969ae006b7808155d074edcb46180fd794503e824113053f5  0001-python-Use-libmdbx-instead-of-bsddb.patch
603409480e56a557dc2031bb6790a72a2fb310937f06acbd637f7d5c4617344bb0e037d3730f8b6b03f25d12ff32f8ef33ab87c2611b33e4865c47529cc103ae  0002-provider.patch
ec72f40ccdb574efcb984ea0aded82668f787eef6d95fd0ca9f953a77d78cb4b3fe04ce233c6dabce72911462d7f11af8aacaa201a78cf125f84970978a5342e  0003-spamd-Correct-owner-and-group-of-spamd-ham_dir-spam_.patch"
