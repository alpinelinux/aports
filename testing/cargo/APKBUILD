# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=cargo
pkgver=0.14.0
pkgrel=0
pkgdesc="The Rust package manager"
url="https://crates.io"
arch="x86_64"
license="MIT ASL-2.0"
depends="rust"
makedepends="cmake curl-dev libgit2-dev libssh2-dev libressl-dev python2 zlib-dev"
subpackages="$pkgname-doc
	$pkgname-bash-completion:bashcomp:noarch
	$pkgname-zsh-completion:zshcomp:noarch"

# XXX: Cargo is self-hosted, so you need cargo to build cargo (ugh).
# The problem is that Rust doesn't provide prebuilt cargo for musl yet. Thus
# I bootstrapped cargo using cargo-bootstrap and uploaded the built tarball
# to my server. We're gonna replace it once Rust start providing prebuilt
# binary for musl.
# TODO: Implement some support for verifying crates fetched by cargo!
source="$pkgname-$pkgver.tar.gz::https://github.com/rust-lang/$pkgname/archive/$pkgver.tar.gz
	https://alpine.geeknet.cz/distfiles/cargo-0.11.0-nightly-x86_64-alpine-linux-musl.tar.gz
	fix-release-num.patch"
builddir="$srcdir/$pkgname-$pkgver"

_ctarget="$CARCH-unknown-linux-musl"

build() {
	export CARGO_HOME="$builddir/.cargo"
	# Convince libgit2-sys to use the distro libgit2.
	export LIBGIT2_SYS_USE_PKG_CONFIG=1

	cd "$builddir"
	./configure \
		--prefix=/usr \
		--local-cargo="$srcdir/cargo-nightly-$_ctarget/cargo/bin/cargo" \
		|| return 1
	make VERBOSE=1
}

package() {
	cd "$builddir"

	make prepare-image-$_ctarget IMGDIR_$_ctarget="$pkgdir/usr"
}

bashcomp() {
	pkgdesc="Bash completions for $pkgname"
	depends=""
	install_if="$pkgname=$pkgver-r$pkgrel bash"

	_mv "$pkgdir"/usr/etc/bash_completion.d/* \
		"$subpkgdir"/usr/share/bash-completion/completions/ || return 1

	# Clean directories which are supposed to be empty.
	rmdir "$pkgdir"/usr/etc/bash_completion.d && rmdir "$pkgdir"/usr/etc
}

zshcomp() {
	pkgdesc="ZSH completions for $pkgname"
	depends=""
	install_if="$pkgname=$pkgver-r$pkgrel zsh"

	_mv "$pkgdir"/usr/share/zsh "$subpkgdir"/usr/share/ || return 1
	rmdir "$pkgdir"/usr/share
}

_mv() {
	local dest; for dest; do true; done  # get last argument
	mkdir -p "$dest"
	mv $@
}

md5sums="d789a7785e37a1f299b24bc4b57f98ff  cargo-0.14.0.tar.gz
79f81ecfa861f4d97a3b9235e66ba594  cargo-0.11.0-nightly-x86_64-alpine-linux-musl.tar.gz
fe8c3891c23626882b2380e32450413d  fix-release-num.patch"
sha256sums="90ec0e644586959f62e6e34e649ba57db6f74aa37b89e90972f817c49b187531  cargo-0.14.0.tar.gz
587172026c0565e839d96b0c1d4c68c000927817398241f96682dca47fa8c3b9  cargo-0.11.0-nightly-x86_64-alpine-linux-musl.tar.gz
3fa15aa38a1d6c0a8f1b9a1361197faa6c7de79d9e38097b38017cb352098339  fix-release-num.patch"
sha512sums="dcd6857f256f1b4cd4d0dfedbb7fceedadcf3ecbe92014f58ff3e668870624d5a1cddda1c4b2653b6ec713c6aef4810760e112e589b6eba81bba9692356acb4f  cargo-0.14.0.tar.gz
17838355ff6d87165aa0f61bd01f48c58a426c069bba7c3852d016e1836666bfafe2609c323a0409fc8530ad27fb3ad5989d8cee033633e38b07fefa670597d5  cargo-0.11.0-nightly-x86_64-alpine-linux-musl.tar.gz
2db1c0870d20a6cfdff863a17180d960e2891e3cfd0ff565d1d1494eaeacfb553e2d1374cdc626f4ce5bc7c2a1c11ab99ae5462d8c3b44716a0f50f7b2b355fd  fix-release-num.patch"
