# Contributor: Andrew Madigan <amadigan@gmail.com>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=tomcat-native-openssl
pkgver=1.2.12
pkgrel=0
pkgdesc="Native resources optional component for Apache Tomcat, includes SSL support using OpenSSL"
url="http://tomcat.apache.org/native-doc/"
arch="all"
license="ASL-2.0"
depends="openjdk8-jre-base openssl !tomcat-native"
replaces="tomcat-native"
makedepends="apr-dev chrpath openjdk8 openssl-dev"
checkdepends="apache-ant"
subpackages="$pkgname-dev"
source="http://www-eu.apache.org/dist/tomcat/tomcat-connectors/native/$pkgver/source/tomcat-native-$pkgver-src.tar.gz
	enable-tests.patch"
builddir="$srcdir/tomcat-native-$pkgver-src"

prepare()	{
	default_prepare || return 1
}

build() {
	cd "$builddir/native"

	./configure --prefix=/usr \
		--with-apr=/usr/bin/apr-1-config \
		--with-java-home=/usr/lib/jvm/default-jvm || return 1
	make || return 1
}

package() {
	cd "$builddir/native"

	echo PKGDIR: $pkgdir
	rm -f "$pkgdir"/usr/lib/libtcnative-1.la
	make DESTDIR="$pkgdir" install || return 1

	# Remove redundant rpath.
	chrpath --delete "$pkgdir"/usr/lib/libtcnative-1.so || return 1

	rm -f "$pkgdir"/usr/lib/libtcnative-1.la
	rmdir "$pkgdir"/usr/bin
}

check()	{
	cd "$srcdir/tomcat-native-$pkgver-src"
	ant download test || return 1
}

dev()  {
	default_dev || return 1
	mv "$subpkgdir"/usr/lib/libtcnative-1.so "$pkgdir"/usr/lib/
}
sha512sums="87543ab353545563001ac339834ec5b230a139bbeb7382c0b5b269d0d00875bfc3f5a3212923ca941e0d31aa0f60c34f34310e89794a99f37aafdaf9ecca7a99  tomcat-native-1.2.12-src.tar.gz
0126ad82c292c26da82b4498bd21c99caa5080199dcf7faad46666109a11da0817ca9262e7df75770005ae03a413c47783112addd53f49ff011b4886702f363b  enable-tests.patch"
