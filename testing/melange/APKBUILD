maintainer="Achill Gilgenast <achill@achill.org>"
pkgname=melange
pkgver=0.34.0
pkgrel=0
pkgdesc="Build apk packages using declarative pipelines"
url="https://github.com/chainguard-dev/melange"
# 32-bit: /home/buildozer/go/pkg/mod/go.step.sm/crypto@v0.58.1/internal/utils/convert.go:33:18: cannot convert math.MaxUint32 (untyped int constant 4294967295) to type T
arch="all !armhf !armv7 !x86"
license="Apache-2.0"
makedepends="go"
subpackages="
	$pkgname-bash-completion
	$pkgname-fish-completion
	$pkgname-zsh-completion
	"
source="https://github.com/chainguard-dev/melange/archive/v$pkgver/melange-$pkgver.tar.gz"

build() {
	mkdir build
	go build -o build/ .

	for i in bash fish zsh; do
		./build/melange completion $i > melange.$i
	done
}

check() {
	(unset SOURCE_DATE_EPOCH; go test ./...)
}

package() {
	install -Dm755 build/melange -t "$pkgdir"/usr/bin/

	install -Dm644 melange.bash "$pkgdir"/usr/share/bash-completion/completions/melange
	install -Dm644 melange.fish "$pkgdir"/usr/share/fish/vendor_completions.d/melange.fish
	install -Dm644 melange.zsh "$pkgdir"/usr/share/zsh/site-functions/_melange
}

sha512sums="
c0b8d4b6c5f4d90e4afe8940bb793524b2b186ba358f8858ba1b26dd9a896989d693d7eda5eacceeefab45900c205e62e09cd944ce89061f0e3339c26138711f  melange-0.34.0.tar.gz
"
