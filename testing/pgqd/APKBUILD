# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=pgqd
pkgver=3.5
pkgrel=0
pkgdesc="PgQ maintenance daemon"
url="https://github.com/pgq/pgqd"
arch="all"
license="ISC"
makedepends="
	autoconf
	automake
	cmd:rst2man
	libevent-dev
	libpq-dev
	libtool
	"
subpackages="
	$pkgname-doc
	$pkgname-openrc
	"
_libusual_gitrev=46a78d2616ba2e8b5855a3914d5e9375935cf61b
source="https://github.com/pgq/pgqd/archive/v$pkgver/pgqd-$pkgver.tar.gz
	https://github.com/libusual/libusual/archive/$_libusual_gitrev/pgqd-$_libusual_gitrev.tar.gz
	pgqd.ini.dist.patch
	$pkgname.initd
	$pkgname.confd
	"
options="!check"  # requires running postgresql

prepare() {
	rm -r lib
	ln -s ../libusual-$_libusual_gitrev lib

	# pgqd.ini is embedded into the binary, so we copy it and customize
	# the copy which we install to /etc.
	cp pgqd.ini pgqd.ini.dist

	default_prepare

	./autogen.sh
}

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var
	make
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install

	install -D -m644 pgqd.ini.dist "$pkgdir"/etc/pgqd.ini
	install -D -m755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -D -m644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
}

sha512sums="
7620f2f5ee698e48e935ff1bca7dc46bc73dc6a0dba8c1dc6990d43ff5ead9abd84de547dd3eb452c529c4b909ad7e575ae9d2734fffe6c051e7e76d477e7866  pgqd-3.5.tar.gz
09ecefd3bf51b2cd435d69b2ba194b86bdce7c755bb44cef4e53f6c8ac47fea355a40955c6668fc01f762bc03fdf9f92ed74d683b1b922c9aa3cda36a258c097  pgqd-46a78d2616ba2e8b5855a3914d5e9375935cf61b.tar.gz
54cab746edf28114afedc48f85c728cc8d0c1231effc1af77c50c771a011fe9e6fdd9d648131175d0549b1ad072a88501d2664e21cfb5e5258fd1c7744c5e772  pgqd.ini.dist.patch
5a60f5742659dda2edf993b25f07981277198d173ad8988674346ee34ea6acc805f9b299f6ccba34f11f179dc41301a2147f06d4212b173066b4a7e5bea5dc3c  pgqd.initd
57ea6868e589a84a675cdcc38cb639862205d819cfe2900b1c1bfd77b3a0143673bdf53878d13c35ebdfce55c30291adb6384c859fe84dab5ff7a9b4f46764c1  pgqd.confd
"
