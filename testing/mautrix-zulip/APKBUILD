maintainer="Achill Gilgenast <achill@achill.org>"
pkgname=mautrix-zulip
pkgver=0.2511.0
pkgrel=1
pkgdesc="Matrix-Zulip puppeting bridge"
url="https://docs.mau.fi/bridges/go/zulip/"
arch="all"
license="AGPL-3.0-or-later"
makedepends="
	go
	olm-dev
	sqlite-dev
	"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc $pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/mautrix/zulip/archive/v$pkgver.tar.gz
	mautrix-zulip.initd
	mautrix-zulip.confd
	"
builddir="$srcdir/zulip-$pkgver"
options="net !check" # go, https://github.com/mautrix/zulip/issues/1

export GOFLAGS="$GOFLAGS -tags=libsqlite3"

build() {
	export CGO_CFLAGS="$CFLAGS"
	export CGO_LDFLAGS="$LDFLAGS"

	go build \
		-ldflags "-X main.Tag=$pkgver -X 'main.BuildTime=$(date -d @"$SOURCE_DATE_EPOCH" '+%b %_d %Y, %H:%M:%S')'" \
		./cmd/mautrix-zulip

	./mautrix-zulip -e
}

check() {
	go test -v ./...
}

package() {
	install -Dm755 mautrix-zulip \
		-t "$pkgdir"/usr/bin/
	install -Dm644 config.yaml \
		-t "$pkgdir"/etc/mautrix-zulip/

	install -Dm755 "$srcdir"/mautrix-zulip.initd \
		"$pkgdir"/etc/init.d/mautrix-zulip
	install -Dm644 "$srcdir"/mautrix-zulip.confd \
		"$pkgdir"/etc/conf.d/mautrix-zulip

	install -Dm644 LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}


sha512sums="
525e37f15a356c4caa24cbc623d4dbbed4637617d602c740de7e070d21d09b94d45e73fa7f2853e371bde9a5eaa5a391b39900efe8e2451728b2bdae087582d3  mautrix-zulip-0.2511.0.tar.gz
6e68c2150556d40d7d2c519c3ae6be27f809022988d5deb82d682ab4e21079844693d0148dfe8fb4283873455ce362b53f6fb90984d967a862d14dac9cc34049  mautrix-zulip.initd
0e0ba4387b30efecd0d4118964cb9cfd6280a68a9f2c59a856e8e27d1b70407bec5cd1d57e393e7599a6c414fc61ead0f13156364e28be9800c8ecdd553461f1  mautrix-zulip.confd
"
