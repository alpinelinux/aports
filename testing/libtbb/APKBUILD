# Contributor: David Huffman <storedbox@outlook.com>
# Maintainer: David Huffman <storedbox@outlook.com>

pkgname=libtbb
pkgver=4.4.4
_pkgverstr=tbb44_20160413oss
pkgrel=0
pkgdesc="IntelÂ® TBB, a widely used C++ template library for task parallelism"
url="https://threadingbuildingblocks.org"
arch="x86 x86_64"
license="GPL-2.0"
subpackages="$pkgname-debug $pkgname-dev $pkgname-doc"
source="https://www.threadingbuildingblocks.org/sites/default/files/software_releases/source/${_pkgverstr}_src.tgz"

builddir="$srcdir/$_pkgverstr"
prepare() {
	local i
	cd "$builddir"
	for i in "$startdir"/*; do
		case $i in
		*.patch) msg $i; patch --verbose -p1 -i $i;;
		esac
	done
}

build() {
	cd "$builddir"
	make
}

_install_libs() {
	local buildtype libsuffix lib builddir
	buildtype="_$1"
	libsuffix="$2"
	lib="${3:-$subpkgdir}/usr/lib"
	builddir=$(find "$builddir/build" -maxdepth 1 -name "*$buildtype" -type d)
	[ "$buildtype" != "_debug" ] && buildtype=''
	mkdir -p "$lib"
	mv "$builddir/libtbb${buildtype}.so$libsuffix" \
	   "$builddir/libtbbmalloc${buildtype}.so$libsuffix" \
	   "$builddir/libtbbmalloc_proxy${buildtype}.so$libsuffix" \
	   "$lib/"
}

package() {
	_install_libs release .2 "$pkgdir"
}

debug() {
	pkgdesc="$pkgdesc (debug symbols)"

	_install_libs debug .2
}

dev() {
	pkgdesc="$pkgdesc (development files)"

	local prefix
	prefix="$subpkgdir/usr"
	cd "$builddir"
	mkdir -p "$prefix"
	rm include/index.html && mv include "$prefix/"
	_install_libs release && _install_libs debug
}

doc() {
	arch="noarch"
	pkgdesc="$pkgdesc (documentation)"

	local share doc licenses
	share="$subpkgdir/usr/share"
	doc="$share/doc"
	licensesdir="$share/licenses/$pkgname"
	cd "$builddir"
	mkdir -p "$doc" "$licensesdir"
	mv doc/ "$doc/$pkgname-$pkgver"
	mv COPYING "$licensesdir/"
}

sha512sums="93424dbb42da10dc2ffdcc0c04738112bc0c96bc9c8563b3aa931b1f118fcec480957447673d85f8a6ea0e9f0b233460036204ad6e4dad815203375b45679943  tbb44_20160413oss_src.tgz"
