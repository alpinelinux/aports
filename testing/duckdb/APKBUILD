maintainer="Leon White <badfunkstripe@gmail.com>>"
pkgname=duckdb
pkgver=1.4.3
pkgrel=0
# Run `git describe --tags --long` from source repo checked out at the $pkgver tag to get this 10-character hash
_pkghash=d1dc88f950
pkgdesc="High-performance analytical database system"
url="https://duckdb.org"
# No support for 32-bit or big-endian architectures
# Other archs exit with Error: Unrecognized opcode: `pause'
arch="x86_64 aarch64"
license="MIT"
makedepends="
	cmake
	openssl-dev
	samurai
	unixodbc-dev
	"
depends_dev="$pkgname-libs=$pkgver-r$pkgrel"
subpackages="
	$pkgname-dev
	$pkgname-doc
	$pkgname-libs
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/duckdb/duckdb/archive/refs/tags/v$pkgver.tar.gz"

export OVERRIDE_GIT_DESCRIBE="v$pkgver-0-g$_pkghash"

build() {
	# TODO: unvendor thirdparty source files
	# shellcheck disable=2086
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCORE_EXTENSIONS='icu;parquet;json' \
		-DMUSL_ENABLED=ON \
		-DOVERRIDE_GIT_DESCRIBE="$OVERRIDE_GIT_DESCRIBE" \
		-DSET_DUCKDB_LIBRARY_VERSION=ON
	cmake --build build
}

check() {
	build/test/unittest "*"
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	install -Dm644 LICENSE -t "$pkgdir/usr/share/licenses/$pkgname/"

	# We don't need these source files
	rm -rf "$pkgdir"/usr/duckdb_build "$pkgdir"/usr/includes.list "$pkgdir"/usr/sources.list
}

sha512sums="
058218e4551867dc231cae682e835fb76b2d02b655f889753fde6745b9895b81a7161c7eb3104c9f9e8a7a33fed460fc0028d0b94a1e36834100aa597b97a877  duckdb-1.4.3.tar.gz
"
