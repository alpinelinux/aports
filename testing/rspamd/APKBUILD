# Maintainer: Valery Kartel <valery.kartel@gmail.com>
# Contributor: Valery Kartel <valery.kartel@gmail.com>
# Contributor: Nathan Angelacos <nangel@alpinelinux.org>
# Contributor: Andrew Lewis <nerf@judo.za.org>
pkgname=rspamd
pkgver=1.3.5
pkgrel=0
pkgdesc="Rapid spam filtering system"
url="https://rspamd.com"
arch="x86_64 x86 armhf"
license="BSD"
pkgusers="rspamd"
pkggroups="rspamd"
depends=""
depends_dev=""
makedepends="$depends_dev cmake libressl-dev libevent-dev glib-dev gmime-dev
	lua5.1-dev lua5.1 sqlite-dev perl file-dev pcre-dev ragel"
install="$pkgname.pre-install"
subpackages="$pkgname-doc $pkgname-web $pkgname-client"
source="https://rspamd.com/downloads/$pkgname-$pkgver.tar.xz
	$pkgname.logrotated
	$pkgname.initd
	$pkgname.confd
	$pkgname.conf
	$pkgname.worker_normal
	$pkgname.worker_controller
"

_builddir="$srcdir"/$pkgname-$pkgver
build() {
	cd "$_builddir"
	cmake CMakeLists.txt \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCONFDIR=/etc/$pkgname \
		-DRUNDIR=/run/$pkgname \
		-DRSPAMD_USER=$pkgusers \
		-DRSPAMD_GROUP=$pkggroups \
		-DENABLE_HIREDIS=ON \
		-DENABLE_LUAJIT=OFF \
		-DINSTALL_EXAMPLES=ON \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	find "$pkgdir"/usr/bin -type l -delete
	rm -fr "$pkgdir"/etc/$pkgname/rspamd* "$pkgdir"/etc/$pkgname/worker*

	install -Dm644 "$srcdir"/$pkgname.conf "$pkgdir"/etc/$pkgname/$pkgname.conf
	install -Dm644 "$srcdir"/$pkgname.worker_normal "$pkgdir"/etc/$pkgname/worker.d/normal.conf
	mkdir -p "$pkgdir"/etc/$pkgname/local.d "$pkgdir"/etc/$pkgname/override.d

	install -Dm644 "$srcdir"/$pkgname.logrotated "$pkgdir"/etc/logrotate.d/$pkgname
	install -Dm755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -Dm644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname

	install -dm750 -o $pkgusers -g $pkggroups "$pkgdir"/var/lib/$pkgname
	install -dm750 -g $pkggroups "$pkgdir"/var/log/$pkgname

	mkdir "$pkgdir"/usr/sbin
	mv "$pkgdir"/usr/bin/rspamd-$pkgver "$pkgdir"/usr/sbin/rspamd
	mv "$pkgdir"/usr/bin/rspamadm-$pkgver "$pkgdir"/usr/bin/rspamadm

	mv "$pkgdir"/usr/share/examples "$pkgdir"/usr/share/doc
	mv "$pkgdir"/usr/share/$pkgname/www/README.md \
		"$pkgdir"/usr/share/$pkgname/www/plugins.txt \
		"$pkgdir"/usr/share/doc/$pkgname
}

web() {
	arch="noarch"
	license="MIT"
	depends="$pkgname"
	pkgdesc="$pkgdesc (web control interface)"
	mkdir -p "$subpkgdir"/usr/share/$pkgname "$subpkgdir"/etc/$pkgname/worker.d
	mv "$pkgdir"/usr/share/$pkgname/www "$subpkgdir"/usr/share/$pkgname/
	install -Dm644 "$srcdir"/$pkgname.worker_controller "$subpkgdir"/etc/$pkgname/worker.d/controller.conf
}

client() {
	pkgdesc="$pkgdesc (console client)"
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/rspamc-$pkgver "$subpkgdir"/usr/bin/rspamc
}

md5sums="27746ff806dac22e4b92f38282fe6bd5  rspamd-1.3.5.tar.xz
c152c6a90f6ae9e5a7a1d137dfbc0305  rspamd.logrotated
3f32a16e76e1461ffba9231cfb1e3d17  rspamd.initd
ecfea2a25b95727ae91c04001fbd3e46  rspamd.confd
0ba1c9aea1820de74d831fd531cce51a  rspamd.conf
95a48d27f69f957e99ac5f443943f59c  rspamd.worker_normal
30639cb7040ec45f8a6806a93aef818b  rspamd.worker_controller"
sha256sums="d4413ccfc238c3023e2b8a9441b101a6437f521f333fc9db2dd924d473fee696  rspamd-1.3.5.tar.xz
6c5e79e9052d957f3d0d634b2ae7a56bbc0901a5d6946dc991c92f19a72fce97  rspamd.logrotated
6b531f95724b2a3990524ab09b7304ce4e811b6e082dfdbe633f201a6bc7eee3  rspamd.initd
82be6a663af2e2333b0dfbbbfd05a9ff3d02e05c7e506235b1b0dbd9d0b72972  rspamd.confd
8b51fbd06a46adceb8cc4b0dc06e7b98d263336acbff913c34ff8e451173aa23  rspamd.conf
308a0bb4e6e442309a6f4e22b6a8a86871b249c1ee834c01b53b3c3647e81c59  rspamd.worker_normal
7ce08f8e77e6db490c61eca9b4c4ebbd5e635ac8ea53f98c5a8877f11a8fc136  rspamd.worker_controller"
sha512sums="6d7223c6be6e49296a5228d3d05a5f8dfd4a4002df9d247740bce75f2f652a01d86c30456b8475d08d529d2787aa30191713961ffc82c380c00612cae371b61c  rspamd-1.3.5.tar.xz
2efe28575c40d1fba84b189bb872860e744400db80dce2f6330be6c6287fb3f46e6511284729b957488bf40bcb9b0952e26df9934f5f138334bd2766075c45cb  rspamd.logrotated
30b45812ef68f2b82d0d7f370b44bec52691296c7349c96c8273342eb4f9b5708c13ad97b13f63d81bee588b4e459c0da3092a62adff9e5b8938f44546df3dcd  rspamd.initd
0b73b159cec9a4a1d337fbb429814f78da23b55f72c9fb8a777ab5f06634206a4f9b25e587f8dbfa7c3242ac5501ebcc90b9a0e926adfd37e14a12ac4607fa62  rspamd.confd
856000ab9b76dd7acff95ab9a55a0eddfc66486a439fcba7fbb36ecdeaa9740f29301cf7248c982e2d5b745b1bad521abb0f4d5e240d442440a36103d3ee634d  rspamd.conf
48f655ae449d1b560a9cf610d770acc568c3220aed2fa5616bc52c8999b39df932019d8930f142753e0bdac2a7f7bbdca2a29e773a6a4e63dbcb4c11cf6647a4  rspamd.worker_normal
349737be95d0797d6e0091d268a7d5542b4aa64e4f38f73604247ee66eca9180d81ea4478ae54db9573c10bba1580823fc4422596a29cb5435f910dc6a3f2d33  rspamd.worker_controller"
