# Contributor: Sören Tempel <soeren+alpine@soeren-tempel.net>
# Maintainer: Sören Tempel <soeren+alpine@soeren-tempel.net>
pkgname=nldev
pkgver=0.3_git20160406
pkgrel=0
verbase=0.3
pkgdesc="A simple netlink device manager"
url="http://git.r-36.net/nldev/"
arch="all"
license="MIT"
depends=""
depends_dev=""
makedepends="linux-headers"
install=""
subpackages="$pkgname-doc"
source="https://dev.alpinelinux.org/archive/$pkgname/$pkgname-$pkgver.tar.gz
	${pkgname}.initd
	${pkgname}-trigger.initd

	0001-Revert-nldev-set-kernel-buffer-to-16kb.patch
	0002-Preserve-the-PATH-environment-variable.patch
	0003-Change-the-default-mdev-path-to-sbin-mdev.patch"

disturl="dev.alpinelinux.org:/archive/$pkgname"
reporev="d2974b64d4e8bab0e08c6395c2925c94e13a3ca5"
giturl="git://git.r-36.net/$pkgname"

builddir="$srcdir"/$pkgname-$pkgver
build() {
	make CFLAGS="$CFLAGS \${INCS} \${CPPFLAGS}" \
		LDFLAGS="$LDFLAGS \${LIBS}" CC="${CC:-gcc}" \
		-C "$builddir"
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir" PREFIX=/ \
		MANPREFIX=/usr/share/man install

	# Move nldev to /sbin
	mkdir -p "$pkgdir"/sbin/
	mv "$pkgdir"/bin/$pkgname "$pkgdir"/sbin/

	# We don't need run_nldev, use the init script instead
	rm -f "$pkgdir"/bin/run_$pkgname

	# Install OpenRC service files
	for service in ${pkgname} ${pkgname}-trigger; do
		install -Dm755 "$srcdir"/$service.initd \
			"$pkgdir"/etc/init.d/$service
	done

	# Install utility scripts
	mkdir -p "$pkgdir"/lib/$pkgname
	install -m755 mdev/lib/* "$pkgdir"/lib/$pkgname/

	# Install additional documentation
	mkdir -p "$pkgdir"/usr/share/doc/$pkgname/examples/
	install -m644 FIXES.md README.md \
		"$pkgdir"/usr/share/doc/$pkgname/
	install -m644 mdev/etc/* \
		"$pkgdir"/usr/share/doc/$pkgname/examples
	install -m755 mdev/lib/* \
		"$pkgdir"/usr/share/doc/$pkgname/examples
}

sha512sums="d0aadfbd29b22a7efe52c9e0976b7e24313a9827ac52ed726324f7a444ae89cca8a1ea55448694849ca6e636d6d8ec19614a9e58f1298c8f2d4c3c58f930b687  nldev-0.3_git20160406.tar.gz
1e2b4ca1f7b6c9a6d36ac659acf5ef8fb0aef49c7db69dc3f94ef54bfd024a34ce849092c23f67934ea36e19df3b76b01eb347daa423a8eaf63b556077d2af64  nldev.initd
0e34e2db640bcfe7ba8b8e2a07a681906e7e6a2fe267f255a216c36e93db5096b7ed4865935ef448aabc8c4c130a786e555113d8ba90bed58f4ae3450890a1ea  nldev-trigger.initd
7821f54b0eeab13355d0a534bafc7c07250b91dcd43e334ffe9bcd9ee601680489ade4aa97b45543d38be93279c3cb11357d58497a3fb7e66052bf743917088f  0001-Revert-nldev-set-kernel-buffer-to-16kb.patch
3d592c4f5a8ae1081aa3780d099b98e3c9869cecc1a3d06dff096e8ee1ea00059c8d5c702fdbb6c5829a429a813f37deab7de7164d38887834d62c0da6165173  0002-Preserve-the-PATH-environment-variable.patch
b9128249077981718d34477b5b81655f256f0a28a549099ed20a611d5aeb54e0d837debe623d6f65071a036fd31322454bb99906058e6309b18c0178c5ce3e5e  0003-Change-the-default-mdev-path-to-sbin-mdev.patch"
