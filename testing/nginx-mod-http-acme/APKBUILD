# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=nginx-mod-http-acme
_modname=http_acme
pkgver=0.3.0
pkgrel=0
pkgdesc="NGINX module implementing automatic certificate management (ACMEv2) protocol"
url="https://github.com/nginx/nginx-acme"
# ppc64le: ngx_slab_alloc() failed: no memory
arch="all !ppc64le"
license="Apache-2.0"
makedepends="
	cargo
	cargo-auditable
	clang-dev
	nginx
	nginx-mod-dev
	"
checkdepends="perl-net-ssleay"
source="https://github.com/nginx/nginx-acme/archive/v$pkgver/nginx-acme-$pkgver.tar.gz
	makefile.patch
	"
builddir="$srcdir/nginx-acme-$pkgver"

prepare() {
	default_prepare

	cargo fetch --target="$CHOST" --locked
}

build() {
	cp -r /usr/src/"nginx-$(_ngxver)" "$srcdir"/nginx

	export NGX_ACME_STATE_PREFIX="/var/lib/nginx/cache"
	make build \
		BUILD=release \
		NGX_CARGO="cargo auditable --frozen" \
		NGINX_SOURCE_DIR="$srcdir/nginx"
}

check() {
	# TODO: Run tests with /usr/sbin/nginx.
	make test NGINX_SOURCE_DIR="$srcdir/nginx"
}

package() {
	depends="nginx~$(_ngxver)"
	local soname="ngx_http_acme_module.so"

	install -D -m755 target/release/libnginx_acme.so "$pkgdir/usr/lib/nginx/modules/$soname"

	echo "load_module \"modules/$soname\";" \
		| install -D -m644 /dev/stdin "$pkgdir/etc/nginx/modules/10_${_modname}.conf"
}

_ngxver() {
	nginx -v 2>&1 | grep -Eo '(\d+\.\d+)+'
}

sha512sums="
b77e8fb97fc2f5047cb8929eca4f186b2445f4547de28b5fc729420c3c28247827aa68ea683e2bdd9d040913a88d92d1fc428fc0f3094766441c671aca2f217d  nginx-acme-0.3.0.tar.gz
0fc06a2c1e3bb0fa2aacfcc36480cf78de95fb2e21b7e6b764b4bd08d47a8b16d3ecb9da205004b9a623092bb080304a932cdd5e9344c0eb61728240e423006b  makefile.patch
"
