# Contributor: Eiffel Alpine <eiffel.alpine@gmail.com>
# Maintainer: Eiffel Alpine <eiffel.alpine@gmail.com>
pkgname=eiffelstudio
pkgver=18.11
pkgrel=10.2592
pkgdesc="Eiffle programming language compiler"
url="https://www.eiffel.org"
arch="x86_64"
license="GPL-2.0-only"
depends="binutils gcc gtk+2.0-dev libxtst"
makedepends="bash"
install=""
subpackages=""
options="!check" # no test suite
source="estudio.profile 
	musl-patch-for-sig-c.patch
	https://ftp.eiffel.com/pub/download/${pkgver}/${pkgname}-${pkgver}.${pkgrel}.tar"
builddir="$srcdir/PorterPackage"

prepare() {
	cd "$builddir"
	bunzip2 -c c.tar.bz2 | tar xf -
	patch -p1 -i "$srcdir"/musl-patch-for-sig-c.patch
	tar cf c.tar C/*
	rm c.tar.bz2
	bzip2 c.tar
}

build() {
	cd "$builddir"
	env -u CC -u CFLAGS -u LDFLAGS COMPILE_LOG=compile.log ./compile_exes linux-x86-64
	find "./Eiffel_${pkgver}" -name "msc*" -type d -exec rm -rf {} +
	find "./Eiffel_${pkgver}" -name "*.dll" -type f -exec rm -rf {} +
}

package() {
	cd "$builddir"
	install -dm755 "${pkgdir}/usr/share/eiffelstudio-${pkgver}"
	cp -a "${builddir}/Eiffel_${pkgver}/"* "${pkgdir}/usr/share/eiffelstudio-${pkgver}/"
	sed -i "s/@ARCH@/linux-x86-64/g" "${srcdir}/estudio.profile"
	sed -i "s/@PKGVER@/${pkgver}/g" "${srcdir}/estudio.profile"
	install -Dm755 "${srcdir}/estudio.profile" "${pkgdir}/etc/profile.d/estudio.sh"
}

sha512sums="1c2cb73815fda9c7dab4cb44ef69c6f09156c760d8b02d832cfe905ec89a536a6c158f0d67950025f6fafb66b1e103c29b4f3dcb33e7d50f535a6ab36a930c69  estudio.profile
ce32854dbde2fd2a3414e10ed4d6d9aaaae93e7742aa55ee5681229c733aa2f8b651c106a6dd7dcec876c4e367c26797416f1d6c43f1ff3ee55b9f3245ea1c67  musl-patch-for-sig-c.patch
e43d4d8ee7401f57fd7cdebdba267d54a18fd8cef4f9e9ab9d58b1369c1aef79c90bf581e40117147f9d5abe23734886f8de4f2e2a225cbffea14fcd51121f81  eiffelstudio-18.11.10.2592.tar"
