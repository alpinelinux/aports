From 63ce32a52a5d3156f30faeed9bac143746a6dcfc Mon Sep 17 00:00:00 2001
From: Michael Richardson <mcr@sandelman.ca>
Date: Fri, 18 Jan 2019 23:44:20 -0500
Subject: [PATCH 8/9] introduce USE_NOMANINSTALL to avoid installing man pages
 on embedded systems

---
 Makefile.inc              |  3 +++
 programs/Makefile.program | 27 ++++++++++++++++-----------
 2 files changed, 19 insertions(+), 11 deletions(-)

diff --git a/Makefile.inc b/Makefile.inc
index d48cb23ba..7cf45e370 100644
--- a/Makefile.inc
+++ b/Makefile.inc
@@ -455,6 +455,9 @@ HAVE_BROKEN_POPEN?=false
 # For systems with no fork (uclibc nommu)
 HAVE_NO_FORK?=false
 
+# Set to skip man pages on embedded systems
+USE_NOMANINSTALL?=false
+
 NONINTCONFIG=oldconfig
 
 # Should we build with object directories?
diff --git a/programs/Makefile.program b/programs/Makefile.program
index e0f2e1684..16ccba394 100644
--- a/programs/Makefile.program
+++ b/programs/Makefile.program
@@ -115,10 +115,12 @@ doinstall:: $(PROGRAM) $(CONFFILES) $(EXTRA8MAN) $(EXTRA5MAN) $(EXTRA5PROC) $(LI
 	@rm -f $(FINALLIBEXECDIR)/vendor
 	@mkdir -p $(PROGRAMDIR) $(MANDIR8) $(MANDIR5) $(LIBDIR) $(CONFDIR) $(CONFDDIR) $(CONFDDIR)/$(CONFDSUBDIR) $(EXAMPLECONFDIR)
 	@if [ -n "$(PROGRAM)" ]; then $(INSTALL) $(INSTBINFLAGS) $(PROGRAM) $(PROGRAMDIR); fi
+
 	@$(foreach f, $(addsuffix .8, $(PROGRAM)), \
 		g=`if [ -r $f ]; then echo $f; else echo ${srcdir}/$f; fi`; \
 		$(INSTALL) $(INSTMANFLAGS) $$g $(MANDIR8)/$(MANPROGPREFIX)$f || exit 1; \
 	)
+ifneq ($(USE_NOMANINSTALL),true)
 	@$(foreach f, $(EXTRA8MAN), \
 		g=`if [ -r $f ]; then echo $f; else echo ${srcdir}/$f; fi`; \
 		$(INSTALL) $(INSTMANFLAGS) $$g $(MANDIR8)/ipsec_$f || exit 1; \
@@ -131,6 +133,15 @@ doinstall:: $(PROGRAM) $(CONFFILES) $(EXTRA8MAN) $(EXTRA5MAN) $(EXTRA5PROC) $(LI
 		g=`if [ -r $f ]; then echo $f; else echo ${srcdir}/$f; fi`; \
 		$(INSTALL) $(INSTMANFLAGS) $$g $(MANDIR5)/ipsec_$f || exit 1 ;\
 	)
+	@$(foreach f, $(EXCONFFILES), \
+		g=`if [ -r $f ]; then echo $f; else echo ${srcdir}/$f; fi`; \
+		$(INSTALL) $(INSTCONFFLAGS) $$g $(EXAMPLECONFDIR)/$f-sample || exit 1; \
+	)
+	@$(foreach f, $(CONFDFILES), \
+		g=`if [ -r $f ]; then echo $f; else echo ${srcdir}/$f; fi`; \
+		if [ ! -f $(CONFDDIR)/$(CONFDSUBDIR)/$f ]; then $(INSTALL) $(INSTCONFFLAGS) $$g $(CONFDDIR)/$(CONFDSUBDIR)/$f || exit 1; fi;\
+	)
+endif
 	@$(foreach f, $(LIBFILES), \
 		g=`if [ -r $f ]; then echo $f; else echo ${srcdir}/$f; fi`; \
 		$(INSTALL) $(INSTCONFFLAGS) $$g $(LIBDIR)/$f || exit 1 ;\
@@ -140,20 +151,13 @@ doinstall:: $(PROGRAM) $(CONFFILES) $(EXTRA8MAN) $(EXTRA5MAN) $(EXTRA5PROC) $(LI
 		if [ ! -f $(CONFDIR)/$f ]; then $(INSTALL) $(INSTCONFFLAGS) $$g $(CONFDIR)/$f || exit 1; fi;\
 		$(INSTALL) $(INSTCONFFLAGS) $$g $(EXAMPLECONFDIR)/$f-sample || exit 1; \
 	)
-	@$(foreach f, $(EXCONFFILES), \
-		g=`if [ -r $f ]; then echo $f; else echo ${srcdir}/$f; fi`; \
-		$(INSTALL) $(INSTCONFFLAGS) $$g $(EXAMPLECONFDIR)/$f-sample || exit 1; \
-	)
-	@$(foreach f, $(CONFDFILES), \
-		g=`if [ -r $f ]; then echo $f; else echo ${srcdir}/$f; fi`; \
-		if [ ! -f $(CONFDDIR)/$(CONFDSUBDIR)/$f ]; then $(INSTALL) $(INSTCONFFLAGS) $$g $(CONFDDIR)/$(CONFDSUBDIR)/$f || exit 1; fi;\
-	)
 
 install_file_list::
 	@if [ -n "$(PROGRAM)" ]; then echo $(PROGRAMDIR)/$(PROGRAM); fi
 	@$(foreach f, $(addsuffix .8, $(PROGRAM)), \
 		echo $(MANDIR8)/${MANPROGPREFIX}$f; \
 	)
+ifneq ($(USE_NOMANINSTALL),true)
 	@$(foreach f, $(EXTRA8MAN), \
 		echo $(MANDIR8)/ipsec_$f; \
 	)
@@ -163,9 +167,6 @@ install_file_list::
 	@$(foreach f, $(EXTRA5PROC), \
 		echo $(MANDIR5)/ipsec_$f; \
 	)
-	@$(foreach f, $(LIBFILES), \
-		echo $(LIBDIR)/$f;\
-	)
 	@$(foreach f, $(CONFFILES), \
 		echo $(CONFDIR)/$f;\
 		echo $(EXAMPLECONFDIR)/$f-sample;\
@@ -173,6 +174,10 @@ install_file_list::
 	@$(foreach f, $(EXCONFFILES), \
 		echo $(EXAMPLECONFDIR)/$f-sample;\
 	)
+endif
+	@$(foreach f, $(LIBFILES), \
+		echo $(LIBDIR)/$f;\
+	)
 	@$(foreach f, $(CONFDFILES), \
 		echo $(CONFDDIR)/${CONFDSUBDIR}/$f;\
 	)
-- 
2.11.0

