# Contributor: Daniel YC Lin <dlin.tw@gmail.com>
# Maintainer: Daniel YC Lin <dlin.tw@gmail.com>
pkgname=synergy
pkgver=1.8.7
pkgrel=1
pkgdesc='Share a single mouse and keyboard between multiple computers'
url='https://symless.com/synergy/'
arch="all"
license="GPL2"
depends="libgcc libxtst libxinerama libxkbcommon avahi curl openssl gmock libxrandr"
makedepends="libxt-dev libxtst-dev libxinerama-dev libxkbcommon-dev avahi-dev curl-dev cmake qt5-qtbase-dev gtest-dev gmock-dev libxrandr-dev"
#install=""
subpackages="$pkgname-doc"
source="synergy-${pkgver}.tar.gz::https://github.com/symless/synergy/archive/v${pkgver}-stable.tar.gz
system-gtest.patch
missing_sentinel.patch
"
#builddir="$srcdir/"
builddir="$srcdir/synergy-${pkgver}-stable"

prepare() {
  cd "$builddir"
  mkdir -p build
  patch -p1 < "${srcdir}/system-gtest.patch"
  patch -p0 < "${srcdir}/missing_sentinel.patch"
}
build() {
  cd "$builddir"
  msg2 "Building core..."
  cd build
  cmake -DCMAKE_INSTALL_PREFIX=/usr .. || return 1
  # unittests don't pass with optimization (segfault on nullptr)
  sed 's|\-O2|\-O0|g' -i src/test/unittests/CMakeFiles/unittests.dir/flags.make
  sed 's|\-O2|\-O0|g' -i src/test/unittests/CMakeFiles/unittests.dir/link.txt
  make || return 1

  msg2 "Building GUI..."
  cd ..
  cd src/gui
  qmake-qt5 || return 1
  make || return 1
}
check() {
  cd "$builddir"
  pwd
  ./bin/unittests || return
}
package() {
  cd "$builddir"

  # install binary
  install -Dm 755 bin/synergy bin/synergyc bin/synergyd bin/synergys bin/syntool bin/usynergy -t "${pkgdir}/usr/bin" || return

  # install config
  install -Dm 644 doc/${pkgname}.conf* -t "${pkgdir}/etc" || return

  # install manfiles
  install -Dm 644 "doc/${pkgname}c.man" "${pkgdir}/usr/share/man/man1/${pkgname}c.1" || return
  install -Dm 644 "doc/${pkgname}s.man" "${pkgdir}/usr/share/man/man1/${pkgname}s.1" || return

  # install systemd service and socket
  #install -Dm 644 "${srcdir}"/synergys.service -t "${pkgdir}/usr/lib/systemd/user" || return
  #install -Dm 644 "${srcdir}"/synergys.socket -t "${pkgdir}/usr/lib/systemd/user" || return

  # install desktop/icon stuff
  install -Dm 644 "res/synergy.ico" -t "${pkgdir}/usr/share/icons" || return
  install -Dm 644 "res/synergy.desktop" -t "${pkgdir}/usr/share/applications" || return
}
sha512sums="2c86d2adb7424d2ea36d0c6b88500379d353c9d3086e2dd4aa1f0919d731d13e224c44e19eaf8c6ffcd7ac232fdfbd4f8b11f76f09e537dd4f0932359527db6d  synergy-1.8.7.tar.gz
4bef039f59b565d08079a8187df76f9773cfddeb81376ccc42f5570049389f114559721ed7b0464c4a4d1431ba72a736b11755573019583d0075d9da08c03ed2  system-gtest.patch
d17713c064c81032eae970e97fd87c680a7382af769488bed5138d13bec76c8110da4f10b1d45dd015e4c8300ecce7f54508abaa9a3497d0a1df4da9577da741  missing_sentinel.patch"
