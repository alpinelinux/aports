# Contributor: kpcyrd <git@rxv.cc>
# Maintainer: kpcyrd <git@rxv.cc>
pkgname=prometheus-node-exporter
pkgver=0.15.2
pkgrel=0
pkgdesc="Prometheus exporter for machine metrics"
url="https://github.com/prometheus/node_exporter"
arch="all"
license="Apache-2.0"
makedepends="go"
install="$pkgname.pre-install $pkgname.pre-upgrade"
subpackages="$pkgname-doc
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/prometheus/node_exporter/archive/v$pkgver.tar.gz
	prometheus-node-exporter.initd
	prometheus-node-exporter.confd
	"
builddir="$srcdir/src/github.com/prometheus/node_exporter"

prepare() {
	mkdir -p ${builddir%/*}
	mv "$srcdir/node_exporter-$pkgver" "$builddir"
	cd "$builddir"
	default_prepare
}

build() {
	cd "$builddir"
	export GOPATH="$srcdir"
	go build -v -ldflags "-s -w"
}

check() {
	cd "$builddir"
	./node_exporter --help 2> /dev/null
}

package() {
	cd "$builddir"
	install -Dm 755 node_exporter "$pkgdir/usr/bin/node_exporter"

	install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README"
	install -Dm644 docs/* -t "$pkgdir/usr/share/doc/$pkgname/"
	install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"

	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname
}

sha512sums="b39ce0801a5bf5a2a70c4034659d047d70b3763af3f18925b65c2b5f72832e261362aaeb9ce4c68cb7bf52e790d3fc710a6c8550ad7876e89fd9f5a055200a52  prometheus-node-exporter-0.15.2.tar.gz
4694adaff59d79bfaf461cbc6d8965782877198019a11e000a1349fc892a7969e2feca5e7e339d439c61fe634c1519af31f69e70a6ee196fe6ebb9bf6b67c880  prometheus-node-exporter.initd
4090df0efc4a6c0b62c29345231d2b01eba548428663ba87efd8a69f93330d9825db048f9f24ce0249f2709004d9f5fb3f4a160ecf587cc0f8d052b7c68abdbc  prometheus-node-exporter.confd"
