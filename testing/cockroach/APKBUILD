# Contributor: Nathan Johnson <nathan@nathanjohnson.info>
# Maintainer: Nathan Johnson <nathan@nathanjohnson.info>
pkgname=cockroach
pkgver=0.1_beta20161103
_pkgrealver=beta-${pkgver##*_beta}
pkgrel=0
pkgdesc="Distributed SQL database"
url="https://www.cockroachlabs.com"
arch="all"
license="ASL 2.0"
depends=""
depends_dev=""
makedepends="$depends_dev go go-tools autoconf bash linux-headers libseccomp libseccomp-dev"
install="$pkgname.pre-install"
subpackages="$pkgname-doc"
pkgusers="cockroach"
pkgroups="cockroach"
source="${pkgname}-${pkgver}.tar.gz::https://github.com/cockroachdb/cockroach/archive/$_pkgrealver.tar.gz
	$pkgname.initd
	$pkgname.confd
	$pkgname.logrotate
	add_pkgdir.patch
	10130_musl_strptime.patch
	force_autoreconf.patch
	disable_style_test.patch
	ldflags_fix.patch"
builddir="$srcdir/go/src/github.com/cockroachdb/cockroach"
options="!strip"

prepare() {
	mkdir -p $(dirname $builddir)
	mkdir "$srcdir/go/pkg"
	mkdir "$srcdir/go/bin"
	mkdir "$srcdir/go/localpkg"
	mv "$srcdir/$pkgname-$_pkgrealver" "$builddir"
	default_prepare
}

build() {
	export GOPATH="$srcdir/go"
	
	# GOPKGDIR is not a standard GO environment variable.  I've patched the
	# Makefile in order to pass this on to go install when it installs glock.
	# I'm doing this to get around the issue that pie builds of the system
	# packages aren't available in the default go install with alpine, and
	# by default it will try to install them to GOROOT which requires root
	# privileges.  See https://github.com/golang/go/issues/15433
	export GOPKGDIR=$GOPATH/localpkg
	cd $builddir
	make build || return 1
	make test || return 1
	
}

package() {
	cd "$builddir"
	mkdir -p "$pkgdir"/usr/bin "$pkgdir"/usr/share/doc/${pkgname} \
		  "$pkgdir"/var/lib/cockroach-data/data \
		  "$pkgdir"/var/log/cockroach
	cp -a docs/* "$pkgdir"/usr/share/doc/${pkgname}/ || return 1
	mv cockroach "$pkgdir"/usr/bin/ || return 1
	chown -R $pkgusers:$pkggroups "$pkgdir"/var/lib/cockroach-data
	chown -R $pkgusers:$pkggroups "$pkgdir"/var/log/cockroach
	install -p -m644 -D "$srcdir/"$pkgname.logrotate \
		"$pkgdir"/etc/logrotate.d/$pkgname || return 1
	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname || return 1
	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname || return 1

}

md5sums="38e837523e2b14b38f23302652103b9f  cockroach-0.1_beta20161103.tar.gz
d41f8f34b500fd75c1f0adfb0e9cd980  cockroach.initd
89bdd0280976461556178f7aef7af320  cockroach.confd
4c23dd200a54a5e5cd6f074fcb7b29a0  cockroach.logrotate
868b17bccbb813a610de36c84902a7aa  add_pkgdir.patch
a2bffce1f55fb052f08e7edc92be99e1  10130_musl_strptime.patch
5ac487041bea5742e449ea3351b23b44  force_autoreconf.patch
9cb9f24a031a2ebfd7cad3f759dc9c85  disable_style_test.patch
6b77f5e70aca15a67164f477640d6fe3  ldflags_fix.patch"
sha256sums="d31a82679fb50acb82ee3be25c67380940df6957224f5bc1ef94ba7cd8f5c4c8  cockroach-0.1_beta20161103.tar.gz
7ec3ab5f537cd9a73f0bb58edf02d74a91bccbd455c82885af1d68580fde850a  cockroach.initd
79b225e04417e2082a6de87208ac95cf3a0a20c0b897168d4ec3ccf45082c354  cockroach.confd
34f68252851544d68c3e8191ffc3709664f2e3fc194c7351cf06da2b9a724ba7  cockroach.logrotate
8a29ba044cc8bb48a3979e71e97bc15b8d5935cb4d4788ddb539f080aee3416a  add_pkgdir.patch
724e813b116632a2e5829fecbb9f3a8e7d2a55f6393a25a3bf544d64f87251e1  10130_musl_strptime.patch
dc9225aed0a5b6143ef47a9c06f970344afa90bf278d437b70311dc8afcc1b4e  force_autoreconf.patch
1e5b3402627235b9a3ff9b0b702220191b981c9031d3d7df3d91fb6620a873e9  disable_style_test.patch
0cd026c2dae639ddcefc3ec9df89864d48d6aecee8ccffa1126b314657abad68  ldflags_fix.patch"
sha512sums="e62592e636d4a394c7379c504b1911e87326b1f500b01fd8e8e0fc48d6a6bb0bc0af403d33db9edd0186ed87cd4b4b2c87bed123849227388932955374c55850  cockroach-0.1_beta20161103.tar.gz
7a81671fabe503d1eefef43eb965fa861eda5f5d563535fce5e2efb0fc7e5d6dbbc7a45bf16bb6395442e9cd2810d367173b5ff8ee9b6dcb8720e23e8409da1c  cockroach.initd
68aaae691f5afa4b51e89107def04534f394cc51bb0bb62df36a026e6505007c58e5e9d7034a5917ef91cbac2991da15596882eb490f4a012b5ad6c3b713ba2a  cockroach.confd
5e73e92b4ca2b1e1a28a003907f2093ddf8c72dc67439d20f1e7f4664b8cf4f2092af5825fc3a996c2b21408b343b7ac382494ad95bb2e4b1e0720b9c0340124  cockroach.logrotate
2444d4c9b81b73c32a98bcab40fd2a7f6093fa2b23dfdead244e765a232f2fd13e139a6933a13bb37d3d5f0d6e6e6591659db14d058745aae7fb112c3c4133e1  add_pkgdir.patch
01ef48ee1ceb1b1fd24b8564fab38ee931c04bd145f29103524d430071065f8ad8c5c20de83957f63764760b2c15a241c28afd8240b6658b75aa74ad388c762d  10130_musl_strptime.patch
240e555cb8c77e4e96909703b0c3633748590e3d5473efdbf38d7eb3a580b48273df2ecc70a530f6a5232e405b4faf34fa7187f12cd4ed8437aa950c0e67c13f  force_autoreconf.patch
c1193774ca80766bb62217b6c0303d5494f780cfc52c4009c300e7fd30de70fa56edae2d17156443dda76c982cb85cb82116e9a821b83bf98884d0f1d7eadc6e  disable_style_test.patch
e1e4e8f2f5f0715355a4734c2a916031801c4688edc3faa9056aef72fa7a589538ee8c9628a456a1e4cf040c78d2a76f6fdcecf45f2e1e13bc6c2bd9ab359d2c  ldflags_fix.patch"
