# Contributor: Nathan Johnson <nathan@nathanjohnson.info>
# Maintainer: Nathan Johnson <nathan@nathanjohnson.info>
pkgname=cockroach
pkgver=0.1_beta20161013
_pkgrealver=beta-${pkgver##*_beta}
pkgrel=0
pkgdesc="Distributed SQL database"
url="https://www.cockroachlabs.com"
arch="all"
license="ASL 2.0"
depends=""
depends_dev=""
_runcver=1.0.0-rc2
makedepends="$depends_dev go go-tools autoconf bash linux-headers libseccomp libseccomp-dev"
install="$pkgname.pre-install"
subpackages="$pkgname-doc"
pkgusers="cockroach"
pkgroups="cockroach"
source="${pkgname}-${pkgver}.tar.gz::https://github.com/cockroachdb/cockroach/archive/$_pkgrealver.tar.gz
	runc-${_runcver}.tar.gz::https://github.com/opencontainers/runc/archive/v$_runcver.tar.gz
	$pkgname.initd
	$pkgname.confd
	$pkgname.logrotate
	add_pkgdir.patch
	force_autoreconf.patch
	10130_musl_strptime.patch
	disable_style_test.patch
	ldflags_fix.patch"
builddir="$srcdir/go/src/github.com/cockroachdb/cockroach"
_runcdir="$srcdir/go/src/github.com/opencontainers/runc"
options="!strip"

prepare() {
	mkdir -p $(dirname $builddir)
	mkdir -p $(dirname $_runcdir)
	mkdir "$srcdir/go/pkg"
	mkdir "$srcdir/go/bin"
	mkdir "$srcdir/go/localpkg"
	mv "$srcdir/$pkgname-$_pkgrealver" "$builddir"
	mv "$srcdir/runc-$_runcver" "$_runcdir"
	default_prepare
}

build() {
	export GOPATH="$srcdir/go"
	
	# GOPKGDIR is not a standard GO environment variable.  I've patched the
	# Makefile in order to pass this on to go install when it installs glock.
	# I'm doing this to get around the issue that pie builds of the system
	# packages aren't available in the default go install with alpine, and
	# by default it will try to install them to GOROOT which requires root
	# privileges.  See https://github.com/golang/go/issues/15433
	export GOPKGDIR=$GOPATH/localpkg
	cd $builddir
	make build || return 1
	make test || return 1
	
}

package() {
	cd "$builddir"
	mkdir -p "$pkgdir"/usr/bin "$pkgdir"/usr/share/doc/${pkgname} \
		  "$pkgdir"/var/lib/cockroach-data/data \
		  "$pkgdir"/var/log/cockroach
	cp -a docs/* "$pkgdir"/usr/share/doc/${pkgname}/ || return 1
	mv cockroach "$pkgdir"/usr/bin/ || return 1
	chown -R $pkgusers:$pkggroups "$pkgdir"/var/lib/cockroach-data
	chown -R $pkgusers:$pkggroups "$pkgdir"/var/log/cockroach
	install -p -m644 -D "$srcdir/"$pkgname.logrotate \
		"$pkgdir"/etc/logrotate.d/$pkgname || return 1
	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname || return 1
	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname || return 1

}

md5sums="5e0ca93f6b60a1a8aa3e904607637ec0  cockroach-0.1_beta20161013.tar.gz
8921d6c148c48f6e143e9cec0faeb950  runc-1.0.0-rc2.tar.gz
d41f8f34b500fd75c1f0adfb0e9cd980  cockroach.initd
89bdd0280976461556178f7aef7af320  cockroach.confd
4c23dd200a54a5e5cd6f074fcb7b29a0  cockroach.logrotate
224c724eb4b530f5c0fb647379d5d534  add_pkgdir.patch
e94c7a487cf16d49998b1477c87bbed7  force_autoreconf.patch
b037257c39afe1931ddb81b46098ba34  10130_musl_strptime.patch
3b4aa2ebb2f959981c6e353a2e46f38a  disable_style_test.patch
6b77f5e70aca15a67164f477640d6fe3  ldflags_fix.patch"
sha256sums="c76e846694ad0fafa2d95119b86977116ca0d572f8af2e2c3d2816e5c40e6022  cockroach-0.1_beta20161013.tar.gz
638742c48426b9a3281aeb619e27513d972de228bdbd43b478baea99c186d491  runc-1.0.0-rc2.tar.gz
7ec3ab5f537cd9a73f0bb58edf02d74a91bccbd455c82885af1d68580fde850a  cockroach.initd
79b225e04417e2082a6de87208ac95cf3a0a20c0b897168d4ec3ccf45082c354  cockroach.confd
34f68252851544d68c3e8191ffc3709664f2e3fc194c7351cf06da2b9a724ba7  cockroach.logrotate
8327ffba7ddde8e6f1dd86ec9b94dfa4f6e9bf31af6d9bace608b69b67e6afad  add_pkgdir.patch
2bd8e0b582387d99c017459f46b196a5d41a36fae3901ec6e2dd1c2ae7de1a8a  force_autoreconf.patch
e95ce4f95ee7ccab3bffcb7c8cc9c1bd59ca0433ab8386209f0bd26aaf04efa1  10130_musl_strptime.patch
afacd4cbb72088bae0511a39860e022eeb06be7053b07d839b311145793e5b3d  disable_style_test.patch
0cd026c2dae639ddcefc3ec9df89864d48d6aecee8ccffa1126b314657abad68  ldflags_fix.patch"
sha512sums="60973e72c08299f657c4335fe9ab6835c5b894e1fe7afadbc8b6dce1d86017ec4d624c867d9b894f5ccd15f1f0f842bc1b02e8a61638cef44910304039080588  cockroach-0.1_beta20161013.tar.gz
83a3d45efbb86d3d583b96062202b9e60121d250af2c0dd37d07fda574b642aa6f05e29cac6644ad3d624647400db694082e280383e41ca9f31dc0a33b87ed76  runc-1.0.0-rc2.tar.gz
7a81671fabe503d1eefef43eb965fa861eda5f5d563535fce5e2efb0fc7e5d6dbbc7a45bf16bb6395442e9cd2810d367173b5ff8ee9b6dcb8720e23e8409da1c  cockroach.initd
68aaae691f5afa4b51e89107def04534f394cc51bb0bb62df36a026e6505007c58e5e9d7034a5917ef91cbac2991da15596882eb490f4a012b5ad6c3b713ba2a  cockroach.confd
5e73e92b4ca2b1e1a28a003907f2093ddf8c72dc67439d20f1e7f4664b8cf4f2092af5825fc3a996c2b21408b343b7ac382494ad95bb2e4b1e0720b9c0340124  cockroach.logrotate
7fe84e2a1a51d2fc7fb4b71f8b6211f62146b3f09b0ec0d6030365b6d688cd57678c6a32b09fd938bb68d41b16cb4f14bfa1a5d77d00a1055b713df393660ea1  add_pkgdir.patch
d4964303abdf9b4453bf21483e2fec20f7aace7036bb3dcce99a004823de6d40b3010b730853f5fb8b37320ffbf38ab8dd35296b849d43a342f516a5b5627cd8  force_autoreconf.patch
96f7dfd1d6a9b4899c7f312bf47089e8708ff684d8e5870d0b15b37295e91941619135f12485e725d864b9148ee2a7b13244e4adc26c74fadd2161ce21c0598f  10130_musl_strptime.patch
2a22fd47d8a4241dacc9c468db94d60b9ab25ee450a26ffe61dd359c04f0a7d404fa7acf219a1a6ff292e3fa3653093dd23902ddd2974265b870335ff6ad8511  disable_style_test.patch
e1e4e8f2f5f0715355a4734c2a916031801c4688edc3faa9056aef72fa7a589538ee8c9628a456a1e4cf040c78d2a76f6fdcecf45f2e1e13bc6c2bd9ab359d2c  ldflags_fix.patch"
