# Contributor: Nathan Johnson <nathan@nathanjohnson.info>
# Maintainer: Nathan Johnson <nathan@nathanjohnson.info>
pkgname=cockroach
pkgver=0.1_beta20161201
_pkgrealver=beta-${pkgver##*_beta}
pkgrel=0
pkgdesc="Distributed SQL database"
url="https://www.cockroachlabs.com"
arch="all"
license="ASL 2.0"
depends=""
depends_dev=""
makedepends="$depends_dev go go-tools autoconf bash linux-headers libseccomp libseccomp-dev glide"
install="$pkgname.pre-install"
subpackages="$pkgname-doc"
pkgusers="cockroach"
pkgroups="cockroach"
source="${pkgname}-${pkgver}.tar.gz::https://github.com/cockroachdb/cockroach/archive/$_pkgrealver.tar.gz
	$pkgname.initd
	$pkgname.confd
	$pkgname.logrotate
	setversion.patch
	10130_musl_strptime.patch
	disable_style_test.patch
	relax_timeout.patch
	ldflags_fix.patch"
builddir="$srcdir/go/src/github.com/cockroachdb/cockroach"
options="!strip"

prepare() {
	mkdir -p $(dirname $builddir)
	mkdir "$srcdir/go/pkg"
	mkdir "$srcdir/go/bin"
	mkdir "$srcdir/go/localpkg"
	mv "$srcdir/$pkgname-$_pkgrealver" "$builddir"
	default_prepare
}

build() {
	export GOPATH="$srcdir/go"
	cd $builddir
	glide install
	# force an auto reconf, since it seems this ships with some
	# artificats from an autoconf run for a glibc distro
	(cd vendor/github.com/cockroachdb/c-jemalloc/internal && ./autogen.sh)
	PKGVERSION=$_pkgrealver make build || return 1
	make test || return 1
	
}

package() {
	cd "$builddir"
	mkdir -p "$pkgdir"/usr/bin "$pkgdir"/usr/share/doc/${pkgname} \
		  "$pkgdir"/var/lib/cockroach-data/data \
		  "$pkgdir"/var/log/cockroach
	cp -a docs/* "$pkgdir"/usr/share/doc/${pkgname}/ || return 1
	mv cockroach "$pkgdir"/usr/bin/ || return 1
	chown -R $pkgusers:$pkggroups "$pkgdir"/var/lib/cockroach-data
	chown -R $pkgusers:$pkggroups "$pkgdir"/var/log/cockroach
	install -p -m644 -D "$srcdir/"$pkgname.logrotate \
		"$pkgdir"/etc/logrotate.d/$pkgname || return 1
	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname || return 1
	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname || return 1

}

md5sums="50e2e7a191707e37f1a9d7c9e5716b6c  cockroach-0.1_beta20161201.tar.gz
d41f8f34b500fd75c1f0adfb0e9cd980  cockroach.initd
89bdd0280976461556178f7aef7af320  cockroach.confd
4c23dd200a54a5e5cd6f074fcb7b29a0  cockroach.logrotate
0fad708d4562e9d686b32ca942bb99e9  setversion.patch
a2bffce1f55fb052f08e7edc92be99e1  10130_musl_strptime.patch
9cb9f24a031a2ebfd7cad3f759dc9c85  disable_style_test.patch
2a4fb641d9033c574fb90fb8f88fd94f  relax_timeout.patch
6b77f5e70aca15a67164f477640d6fe3  ldflags_fix.patch"
sha256sums="1fc330489bb452f813add3c62df09f9d1eca14c129bfaff8620f2d6a1977f5dc  cockroach-0.1_beta20161201.tar.gz
7ec3ab5f537cd9a73f0bb58edf02d74a91bccbd455c82885af1d68580fde850a  cockroach.initd
79b225e04417e2082a6de87208ac95cf3a0a20c0b897168d4ec3ccf45082c354  cockroach.confd
34f68252851544d68c3e8191ffc3709664f2e3fc194c7351cf06da2b9a724ba7  cockroach.logrotate
a4bcda458380e22d053f5953ef794bbe34d97cdeccae7cda2eae7ed65e85a374  setversion.patch
724e813b116632a2e5829fecbb9f3a8e7d2a55f6393a25a3bf544d64f87251e1  10130_musl_strptime.patch
1e5b3402627235b9a3ff9b0b702220191b981c9031d3d7df3d91fb6620a873e9  disable_style_test.patch
6ca67f38ae87b766c7da99c72d079387807b93cb1c1826014e6d0f45caf2700a  relax_timeout.patch
0cd026c2dae639ddcefc3ec9df89864d48d6aecee8ccffa1126b314657abad68  ldflags_fix.patch"
sha512sums="aa560a34983d0ec8e3044b002b059b948d85ad419c141f379a1deac2d1ae5afa8f474396e17910269af6a2fffeeeb33eb18ab1420e771295e937f900c3145f14  cockroach-0.1_beta20161201.tar.gz
7a81671fabe503d1eefef43eb965fa861eda5f5d563535fce5e2efb0fc7e5d6dbbc7a45bf16bb6395442e9cd2810d367173b5ff8ee9b6dcb8720e23e8409da1c  cockroach.initd
68aaae691f5afa4b51e89107def04534f394cc51bb0bb62df36a026e6505007c58e5e9d7034a5917ef91cbac2991da15596882eb490f4a012b5ad6c3b713ba2a  cockroach.confd
5e73e92b4ca2b1e1a28a003907f2093ddf8c72dc67439d20f1e7f4664b8cf4f2092af5825fc3a996c2b21408b343b7ac382494ad95bb2e4b1e0720b9c0340124  cockroach.logrotate
be89ec5d0e63b0b8e9282a98ff701f1d2cc112bc6cc1f9d84d28d329691b1ca4ab49820119950b1d46a6f4c45b81bf426dbfe408fefdd92882367210c35bf27d  setversion.patch
01ef48ee1ceb1b1fd24b8564fab38ee931c04bd145f29103524d430071065f8ad8c5c20de83957f63764760b2c15a241c28afd8240b6658b75aa74ad388c762d  10130_musl_strptime.patch
c1193774ca80766bb62217b6c0303d5494f780cfc52c4009c300e7fd30de70fa56edae2d17156443dda76c982cb85cb82116e9a821b83bf98884d0f1d7eadc6e  disable_style_test.patch
9157db8eb7a030135c504615729e5706bc363da4afc3e688f91091eab209b5e33f84ddcd9546dc73dd7b641f80db6457278bbb0f5059db2ba2407120851a9654  relax_timeout.patch
e1e4e8f2f5f0715355a4734c2a916031801c4688edc3faa9056aef72fa7a589538ee8c9628a456a1e4cf040c78d2a76f6fdcecf45f2e1e13bc6c2bd9ab359d2c  ldflags_fix.patch"
