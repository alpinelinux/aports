# Contributor: Nathan Johnson <nathan@nathanjohnson.info>
# Maintainer: Nathan Johnson <nathan@nathanjohnson.info>
pkgname=cockroach
pkgver=0.1_beta20161006
_pkgrealver=beta-${pkgver##*_beta}
pkgrel=0
pkgdesc="Distributed SQL database"
url="https://www.cockroachlabs.com"
arch="all"
license="ASL 2.0"
depends=""
depends_dev=""
makedepends="$depends_dev go go-tools autoconf bash linux-headers"
install="$pkgname.pre-install $pkgname.post-deinstall"
subpackages="$pkgname-doc"
pkgusers="cockroach"
pkgroups="cockroach"
source="${pkgname}-${pkgver}.tar.gz::https://github.com/cockroachdb/cockroach/archive/$_pkgrealver.tar.gz
	$pkgname.initd
	$pkgname.confd
	$pkgname.logrotate
	add_pkgdir.patch
	force_autoreconf.patch
	9775.patch
	ldflags_fix.patch"
builddir="$srcdir/go/src/github.com/cockroachdb/cockroach"
options="!strip"

prepare() {
	mkdir -p $(dirname $builddir)
	mkdir "$srcdir/go/pkg"
	mkdir "$srcdir/go/bin"
	mkdir "$srcdir/go/localpkg"
	mv "$srcdir/$pkgname-$_pkgrealver" "$builddir"
	default_prepare
}

build() {
	export GOPATH="$srcdir/go"
	
	# GOPKGDIR is not a standard GO environment variable.  I've patched the
	# Makefile in order to pass this on to go install when it installs glock.
	# I'm doing this to get around the issue that pie builds of the system
	# packages aren't available in the default go install with alpine, and
	# by default it will try to install them to GOROOT which requires root
	# privileges.  See https://github.com/golang/go/issues/15433
	export GOPKGDIR=$GOPATH/localpkg
	cd $builddir
	make build || return 1
	make test || return 1
	
}

package() {
	cd "$builddir"
	mkdir -p "$pkgdir"/usr/bin "$pkgdir"/usr/share/doc/${pkgname} \
		  "$pkgdir"/var/lib/cockroach-data/data \
		  "$pkgdir"/var/log/cockroach
	cp -a docs/* "$pkgdir"/usr/share/doc/${pkgname}/ || return 1
	mv cockroach "$pkgdir"/usr/bin/ || return 1
	chown -R $pkgusers:$pkggroups "$pkgdir"/var/lib/cockroach-data
	chown -R $pkgusers:$pkggroups "$pkgdir"/var/log/cockroach
	install -p -m644 -D "$srcdir/"$pkgname.logrotate \
		"$pkgdir"/etc/logrotate.d/$pkgname || return 1
	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname || return 1
	install -m644 -D "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname || return 1

}

md5sums="ee375f71a3a46965b2dd127babb401c0  cockroach-0.1_beta20161006.tar.gz
81ce20915fecc9dd434fd40960731576  cockroach.initd
89bdd0280976461556178f7aef7af320  cockroach.confd
4c23dd200a54a5e5cd6f074fcb7b29a0  cockroach.logrotate
03b16d4be36b2b77247fa53e1d6cc9d5  add_pkgdir.patch
bd7be125301ca3db86acb550a293e255  force_autoreconf.patch
1ff95ada356cbed6c633c997e012bf75  9775.patch
6ffab4f15e7d193df2625a4eb9e7e2da  ldflags_fix.patch"
sha256sums="39d917a8eba33d65a727333586f068666cce9b206ddc18b767f7dd1c42ce2fdb  cockroach-0.1_beta20161006.tar.gz
e0a21dff4c068b8df5840386ff6af798790a73b3f1bb3056654304bddb4ae511  cockroach.initd
79b225e04417e2082a6de87208ac95cf3a0a20c0b897168d4ec3ccf45082c354  cockroach.confd
34f68252851544d68c3e8191ffc3709664f2e3fc194c7351cf06da2b9a724ba7  cockroach.logrotate
465dcc687aec19e9e89ef893ee879a46ce69c5384190223d77d5432cb37fd320  add_pkgdir.patch
6d6e1b9285a721c6f7ef5e47dc96f47db11e25ac08c9fb59071f63af9bbf00f3  force_autoreconf.patch
7cd7e416ec199b9a6d29c7cd8f1354dd3f98fffe9f717cd9ccbeca4b4f512910  9775.patch
080a3f7af67647a58174cff8b9d3dffec8125b2c399d440fcd10353785aad10c  ldflags_fix.patch"
sha512sums="35b577894f634e1842c4c0812efdf17633daa84547f34446135379ab9dd1676bd61a15e5fd7f9537a6284054b5c357a98d2fbdb3205b07b3ef469d01f152490a  cockroach-0.1_beta20161006.tar.gz
f5f1f579995029b7ea347f0ecb4181849026ba69a83a0416fab0db21f37c9c826e7af73441d79eabb66d67d562c4ca7d67a1b00ba1852e42dc11063cab1666b8  cockroach.initd
68aaae691f5afa4b51e89107def04534f394cc51bb0bb62df36a026e6505007c58e5e9d7034a5917ef91cbac2991da15596882eb490f4a012b5ad6c3b713ba2a  cockroach.confd
5e73e92b4ca2b1e1a28a003907f2093ddf8c72dc67439d20f1e7f4664b8cf4f2092af5825fc3a996c2b21408b343b7ac382494ad95bb2e4b1e0720b9c0340124  cockroach.logrotate
ad2a34f5948586a37065bd5f95f1d71ede6ea08b4d2935f435e582a727a070781411c37b432979c8c7942cb099e101611d6d5bbf4e88fc2074347cc745e7f207  add_pkgdir.patch
19fa683e0efcee7e110028d3e24375ed51b9180da3fb51b8edc4978255ce7c9704b28b4f3c6452c48fad69da51358c0ec6128bcd2a7411ce34975fa2b8ae4ac1  force_autoreconf.patch
2243dc3ed4553217f3b5846d1e17f632102a6da5f521f92cb6e4a9e80cd6754994b8637ddbdc7c170e0bde5d084a149ae92784ffbe3cf96f627dd6aa0889149e  9775.patch
b543e44adc6a15e340bec3bca54a45843978224eedd3e1045f99f90c668ec572cfd02fe83ec8634c8fa72b7db869ede0bd75ccd376dfd72d9d6eb10b98d4962b  ldflags_fix.patch"
