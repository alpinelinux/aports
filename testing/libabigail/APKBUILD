# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=libabigail
pkgver=2.8
pkgrel=0
pkgdesc="The ABI Generic Analysis and Instrumentation Library"
url="https://sourceware.org/libabigail/"
arch="all"
license="Apache-2.0 WITH LLVM-exception"
makedepends="
	autoconf
	automake
	elfutils-dev
	libtool
	libxml2-dev
	musl-fts-dev
	py3-sphinx
	xxhash-dev
	"
checkdepends="
	bash
	python3
	"
subpackages="
	$pkgname-dev
	$pkgname-tools
	$pkgname-doc
	$pkgname-bash-completion
	"
source="https://mirrors.kernel.org/sourceware/libabigail/libabigail-$pkgver.tar.xz
	apk.patch
	"

prepare() {
	default_prepare

	autoreconf -fi
}

build() {
	# utilities use a bit more stack size than normal
	export LDFLAGS="$LDFLAGS -Wl,-z,stack-size=512000"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--enable-rpm=no \
		--enable-rpm415=no \
		--enable-debug-self-comparison=no \
		--enable-deb=no \
		--enable-tar=yes \
		--enable-apidoc=no \
		--enable-manual=yes \
		--enable-bash-completion=yes \
		--enable-fedabipkgdiff=no \
		--enable-python3=yes
	make
	make -C doc/manuals man
}

check() {
	make check check-self-compare || {
		cat tests/test-suite.log
		return 1
	}
}

package() {
	make DESTDIR="$pkgdir" install
	make -C doc/manuals DESTDIR="$pkgdir" install-man-and-info-doc

	cd bash-completion
	install -D -m644 -t "$pkgdir"/usr/share/bash-completion/completions/ \
		abicompat \
		abidiff \
		abidw \
		abilint \
		abipkgdiff

}

tools() {
	pkgdesc="$pkgdesc (CLI tools)"
	depends="$pkgname=$pkgver-r$pkgrel"

	amove usr/bin
}

sha512sums="
e919f12c914addb9c64d15d40c50e50ce1b08ac8f64f11adb9274cbdfc568b7e2eb99f669866b413a3e6c6246611b529be1f8d226cf58f7a5c6e2a7061d88e8c  libabigail-2.8.tar.xz
ab587a845701e46f85d4c0e867abff11b7213c8df29cf08a4a5c372f9328f45c1b767496cfd8d07413856dee9d28a9174beaf7c0019abefd37b145a536e3777d  apk.patch
"
