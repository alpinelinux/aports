# Maintainer: Antoine Martin (ayakael) <dev@ayakael.net>
pkgname=openterface-qt
pkgver=0.5.9
pkgrel=0
pkgdesc="Openterface Mini-KVM Host Application"
# armhf: missing qt6-qtmultimedia
# riscv64: missing libgtk-3
arch="all !armhf !riscv64"
url="https://openterface.com/"
license="AGPL-3.0-only"
depends="
	gst-plugins-good-qt
	hicolor-icon-theme
	qt6-qtmultimedia-ffmpeg
	"
makedepends="
	cmake
	ffmpeg-dev
	libgudev-dev
	libjpeg-turbo-dev
	libusb-dev
	libx11-dev
	libxv-dev
	patchelf
	qt6-qtbase-dev
	qt6-qtmultimedia-dev
	qt6-qtserialport-dev
	samurai
	v4l-utils-dev
"
install="$pkgname.post-install"
builddir="$srcdir"/Openterface_QT-$pkgver
options="!check" # No testsuite
source="
	$pkgname-$pkgver.tar.gz::https://github.com/TechxArtisanStudio/Openterface_QT/archive/$pkgver.tar.gz
	openterfaceQT.desktop
	51-openterface-permissions.rules
	348_address-use-of-deleted-function.patch
	423_deduplicate-logging-categories-and-remove-backslashes.patch
	use-system-libs.patch
	"

prepare() {
	default_prepare
	mkdir build && cd build
	# OPENTERFACE_BUILD_STATIC: do not build vendored dependencies
	cmake -DOPENTERFACE_BUILD_STATIC=OFF ..
}

build() {
	ninja -C build
}

package() {
	install -Dm755 "$builddir"/build/openterfaceQT "$pkgdir"/usr/bin/openterfaceQT
	install -Dm644 "$srcdir"/51-openterface-permissions.rules "$pkgdir"/etc/udev/rules.d/51-openterface-permissions.rules
	install -Dm644 "$srcdir"/openterfaceQT.desktop "$pkgdir"/usr/share/applications/openterfaceQT.desktop
	install -Dm644 "$builddir"/images/icon_32.png "$pkgdir"/usr/share/icons/hicolor/32x32/apps/openterfaceQT.png
	install -Dm644 "$builddir"/images/icon_64.png "$pkgdir"/usr/share/icons/hicolor/64x64/apps/openterfaceQT.png
	install -Dm644 "$builddir"/images/icon_128.png "$pkgdir"/usr/share/icons/hicolor/128x128/apps/openterfaceQT.png

	# vanilla build does not set rpath, since it usually wants to use vendored libs
	patchelf --set-rpath '/usr/lib' "$pkgdir"/usr/bin/openterfaceQT
}

sha512sums="
bd865fa3d6a6e27b4ce184c8e9871c21de1753bff299cc84c33ae4891c18581ef8c8f7bd34fbef21743ed866365be2a253fbd43d9d34f81347a664bd60beb605  openterface-qt-0.5.9.tar.gz
e39cfa04cbcb59e8ba54110a28eff41854f73fa7c4baeeed5433907c79781946f12bd3a731763caa1d591e664eab0650bdbd2a844954baa12bb96a76a17c6e4f  openterfaceQT.desktop
f50d721a6a2d1e0183c81e99230e91e127ee6c6f3243af1cff3e3cb78e2913ebab3346ec8b461a4710220d1ce2e12a7cc960ded6e0dc2def539375c6e737b647  51-openterface-permissions.rules
69b5556ec9e56792e848ea1ff9374e12e6901da821ecd9d6f2f521ea30f48e564c2cd0631fc1360acd6c8c6249cfa718d5baf7ed6929e1e92f63eeaea578bcb3  348_address-use-of-deleted-function.patch
47580d07a2d971ad2010e78373d1abbcbc05b3fbd3a7e466faed50dc9a0d632db30c0a7622e7324aeb0eb38d49e3241cb6cebc835f7adeed977b1dd7b48ea5f6  423_deduplicate-logging-categories-and-remove-backslashes.patch
22ecac74fe0923f39f538a5d587f8c100d9709631a1584bd20646e09dcf777cd3042670d08195626220f0494e5efa9549a299c5e1fd8c42f991ec5746b42cc86  use-system-libs.patch
"
