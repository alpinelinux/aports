# Maintainer: Steve Holweg <skytep@gmail.com>
# Contributor: Baptiste Jonglez <baptiste--aur@jonglez.org>

pkgname=kea
pkgver=1.5.0
pkgrel=4
pkgdesc="High-performance, extensible DHCP server engine from ISC, supporting both DHCPv4 and DHCPv6"
arch="all !armhf !armv7" # log4cplus is unavailable
url="http://kea.isc.org"
license="MPL2"
depends=""
depends_lfc=""
depends_libs=""
depends_openrc=""
depends_py3_kea="python3"
depends_shell="py3-$pkgname"
depends_static="$pkgname-dev"
checkdepends="bash procps"
makedepends="boost-dev botan-dev log4cplus-dev mariadb-dev openssl-dev perl postgresql-dev python3-dev"
subpackages="$pkgname-doc $pkgname-libs-static $pkgname-libs $pkgname-dev
	py3-$pkgname:py3_kea:noarch
	$pkgname-shell:shell:noarch
	$pkgname-admin:admin:noarch
	$pkgname-ctrl-agent:ctrl_agent
	$pkgname-ctrl-agent-openrc:ctrl_agent_openrc
	$pkgname-dhcp-ddns:dhcp_ddns
	$pkgname-dhcp-ddns-openrc:dhcp_ddns_openrc
	$pkgname-dhcp4
	$pkgname-dhcp4-openrc:dhcp4_openrc
	$pkgname-dhcp6
	$pkgname-dhcp6-openrc:dhcp6_openrc
	$pkgname-keactrl:keactrl:noarch
	$pkgname-lfc
	$pkgname-utils
	"

source="https://ftp.isc.org/isc/${pkgname}/${pkgver}/${pkgname}-${pkgver}.tar.gz
	fix-scripts-include-path.patch
	issue-10480-log4cplus.patch
	kea-ctrl-agent.initd
	kea-dhcp-ddns.initd
	kea-dhcp4.initd
	kea-dhcp6.initd
	"

_cql_package="cassandra-cpp-driver-dev"
case "$CARCH" in
	ppc64le|x86*) makedepends="${makedepends} ${_cql_package}" ;;
esac

build() {
	local cql

	cql=""
	if makedepends_has "${_cql_package}"; then
		cql="--with-cql"
	fi

	# Complete build for dev and doc

	./configure \
		--host="$CHOST" \
		--build="$CBUILD" \
		--prefix=/usr \
		--libexecdir=/usr/lib \
		--localstatedir=/var \
		--sysconfdir=/etc \
		$cql \
		--with-mysql \
		--with-pgsql \
		--enable-logger-checks \
		--enable-shell

	make
}

check() {
	# Disabled, databases are required for the test to pass
	sed -i -e '/^cql_.*_test$/s/^/#/' src/bin/admin/tests/cql_tests.sh
	sed -i -e '/^mysql_.*_test$/s/^/#/' src/bin/admin/tests/mysql_tests.sh
	sed -i -e '/^pgsql_.*_test$/s/^/#/' src/bin/admin/tests/pgsql_tests.sh

	make SHELL=/bin/bash check

	printf -- '%s: ' 'Version output'
	./src/bin/dhcp4/kea-dhcp4 -V
}

package() {
	make DESTDIR="${pkgdir}" install
}

_common_sub() {

	depends="${pkgname}"

}

admin() {
	_common_sub

	pkgdesc="$pkgdesc (Databases administration tools)"

	mkdir -p "${subpkgdir}/usr/sbin"
	mv "${pkgdir}/usr/sbin/kea-admin" "${subpkgdir}/usr/sbin/"

	mkdir -p "${subpkgdir}/usr/share"
	mv "${pkgdir}/usr/share/kea" "${subpkgdir}/usr/share/"
}

ctrl_agent() {
	_common_sub
	pkgdesc="$pkgdesc (Control agent)"

	mkdir -p "${subpkgdir}/usr/sbin"
	mv "${pkgdir}/usr/sbin/kea-ctrl-agent" "${subpkgdir}/usr/sbin/"

	mkdir -p "${subpkgdir}/etc/kea"
	mv "${pkgdir}/etc/kea/kea-ctrl-agent.conf" "${subpkgdir}/etc/kea/"
}

ctrl_agent_openrc() {
	_common_sub
	depends="$depends_openrc"
	pkgdesc="$pkgdesc (Control agent) (OpenRC init scripts)"
	install_if="openrc ${subpkgname%-openrc}=$pkgver-r$pkgrel"

	install -m755 -D "${srcdir}/kea-ctrl-agent.initd" \
		"${subpkgdir}/etc/init.d/kea-ctrl-agent"
}

dhcp_ddns() {
	_common_sub

	pkgdesc="$pkgdesc (DDNS server)"

	mkdir -p "${subpkgdir}/usr/sbin"
	mv "${pkgdir}/usr/sbin/kea-dhcp-ddns" "${subpkgdir}/usr/sbin/"

	mkdir -p "${subpkgdir}/etc/kea"
	mv "${pkgdir}/etc/kea/kea-dhcp-ddns.conf" "${subpkgdir}/etc/kea/"
}

dhcp_ddns_openrc() {
	_common_sub
	depends="$depends_openrc"
	pkgdesc="$pkgdesc (DDNS server) (OpenRC init scripts)"
	install_if="openrc ${subpkgname%-openrc}=$pkgver-r$pkgrel"

	install -m755 -D "${srcdir}/kea-dhcp-ddns.initd" \
		"${subpkgdir}/etc/init.d/kea-dhcp-ddns"
}

dhcp4() {
	_common_sub

	pkgdesc="$pkgdesc (DHCP4 server)"

	mkdir -p "${subpkgdir}/usr/sbin"
	mv "${pkgdir}/usr/sbin/kea-dhcp4" "${subpkgdir}/usr/sbin/"

	mkdir -p "${subpkgdir}/etc/kea"
	mv "${pkgdir}/etc/kea/kea-dhcp4.conf" "${subpkgdir}/etc/kea/"
}

dhcp4_openrc() {
	_common_sub
	depends="$depends_openrc"
	pkgdesc="$pkgdesc (DHCP4 server) (OpenRC init scripts)"
	install_if="openrc ${subpkgname%-openrc}=$pkgver-r$pkgrel"

	install -m755 -D "${srcdir}/kea-dhcp4.initd" \
		"${subpkgdir}/etc/init.d/kea-dhcp4"
}

dhcp6() {
	_common_sub

	pkgdesc="$pkgdesc (DHCP6 server)"

	mkdir -p "${subpkgdir}/usr/sbin"
	mv "${pkgdir}/usr/sbin/kea-dhcp6" "${subpkgdir}/usr/sbin/"

	mkdir -p "${subpkgdir}/etc/kea"
	mv "${pkgdir}/etc/kea/kea-dhcp6.conf" "${subpkgdir}/etc/kea/"
}

dhcp6_openrc() {
	_common_sub
	depends="$depends_openrc"
	pkgdesc="$pkgdesc (DHCP6 server) (OpenRC init scripts)"
	install_if="openrc ${subpkgname%-openrc}=$pkgver-r$pkgrel"

	install -m755 -D "${srcdir}/kea-dhcp6.initd" \
		"${subpkgdir}/etc/init.d/kea-dhcp6"
}

keactrl() {
	_common_sub

	pkgdesc="$pkgdesc (Kea process manager)"

	mkdir -p "${subpkgdir}/usr/sbin"
	mv "${pkgdir}/usr/sbin/keactrl" "${subpkgdir}/usr/sbin/"

	mkdir -p "${subpkgdir}/etc/kea"
	mv "${pkgdir}/etc/kea/keactrl.conf" "${subpkgdir}/etc/kea/"
}

lfc() {
	pkgdesc="$pkgdesc (Lease file cleanup)"
	depends="$depends_lfc"

	mkdir -p "${subpkgdir}/usr/sbin"
	mv "${pkgdir}/usr/sbin/kea-lfc" "${subpkgdir}/usr/sbin/"
}

py3_kea() {
	pkgdesc="$pkgdesc (python3 module)"
	depends="$depends_py3_kea"

	mkdir -p "${subpkgdir}/usr/lib"
	mv "${pkgdir}"/usr/lib/python3* "${subpkgdir}/usr/lib/"
}

shell() {
	pkgdesc="$pkgdesc (shell)"
	depends="$depends_shell"

	mkdir -p "${subpkgdir}/usr/sbin"
	mv "${pkgdir}/usr/sbin/kea-shell" "${subpkgdir}/usr/sbin/"
}

utils() {
	_common_sub

	pkgdesc="$pkgdesc (Optional Utils)"

	mkdir -p "${subpkgdir}/usr/sbin"
	mv "${pkgdir}/usr/sbin/perfdhcp" "${subpkgdir}/usr/sbin/"

	mkdir -p "${subpkgdir}/usr/bin"
	mv "${pkgdir}/usr/bin/kea-msg-compiler" "${subpkgdir}/usr/bin/"
}

gpg_signature_extensions="sha512.asc"
gpgfingerprints="
	BE0E 9748 B718 253A 28BB  89FF F1B1 1BF0 5CF0 2E57
	good:AE3F AC79 6711 EC59 FC00  7AA4 74BB 6B9A 4CBB 3D38
	"

sha512sums="6d6b7407831311ebe37abce382ce77c664015ddbe3e73ec78153a00b301f98af5be52e26ad4febf5ca1e478d2c1844db4c988b241d2700d758e90b077f176ad8  kea-1.5.0.tar.gz
293d523b59de8531ae0ecc1be863d9c47b940eb32017f769b212150250c86672bc0473b096eaa07ad6b682259b754a2f387a6ff2abec14a2fb8968f34585b0d5  fix-scripts-include-path.patch
63fb82b865870f5e6aafee2e38efa9431252c141352f00dac170621b5a32af1227858136f2691aaf295c2dc10e5f35804f6f3d1277324c0064384402c0c5f9ea  issue-10480-log4cplus.patch
d6b0e14b055abd3aae7f74ea4d32ebb74ffcf87c35f1d3a52407e37574b45262bb0084b1b20f2f08c5bf7388ba23a503689eae6fc90d9096f7f1f6656999bf41  kea-ctrl-agent.initd
31705accecc50a50c7a01ba700acdc68fb10f776bb583e1c1ae78fb33f8ba9cc66f7e12686f057d9d534a26ca09cbe7879399ee31463b46a78d9f203524357af  kea-dhcp-ddns.initd
9165141380f723c641411d1394cdeeeac8cf72321012ba0aafa36b64ec171eba996ed6bd1f5460523f7c4b32cb37b368331984bcd19ca82d9c63211fdbb0a36e  kea-dhcp4.initd
6e7608d2133758bfc80828ef6a072127f25ac9d47cf16c1ca91eca1e5ee8c96a5a7d0e515725a8d9556205e6e70113177b6f7e5c4306385de6266aa5c09ea2d7  kea-dhcp6.initd"
